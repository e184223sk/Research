UnityでiOS端末のミュージックライブラリの曲が必要になったのですが、参考になるサイトの情報が不足してエラーまみれになったり、記事自体が古かったので備忘録としてまとめます。Objective-Cは、触って4日間の超初心者クオリティなので無駄なところがあるかもしれません。AppleMusicの曲やDRMで保護がかかった曲は再生できないのでご了承ください。
(iTunesで購入した曲やCDからインポートした曲の再生は確認済み)今回はミュージックライブラリから1曲だけランダムで取得して再生するまでやっていきたいと思います。まずは、Unityのプロジェクトを作成して、「Asset」フォルダの中に「Plugins」フォルダを作成し、その中に「iOS」フォルダを作成、そしてその中に今回は「MusicLibraryMediaPicker.mm」と言う名前のファイルを作成します。
(.mmファイルは直接作成できないと思うので一旦外部のテキストエディタでファイルを作成してドラッグ＆ドロップしてインポートする方がいいと思います。)
そのままでは直接Objective-Cのファイルは操作できないので今回は操作する用のC#スクリプトを「Asset」フォルダ直下に「MediaController.cs」と言う名前で作成します。AudioSourceとTextを作成します。
次はミュージックライブラリからアプリのDocumentsフォルダにエクスポートする処理を先ほど作成したObjective-Cのファイル(MusicLibraryMediaPicker.mm)に下記のソースをコピペしましょう。こちらのサイトを参考にして私がエラー＆バグを修正+加筆したソースを載せます。記事が8年前とかなり古めですがとても参考になりました。
（そのままではエラーが出るかもしれないですが今は放置で大丈夫です）このままではUnityから呼び出す事ができないので次はC#にObjective-Cと連携させる処理を作成します。ここでは、Objective-Cのコードを実行させたいので先ほど作成したC#のファイル(MediaController.cs)に下記のソースをコピペして実行できるようにしましょう。これでソースコードの準備は完了です！！先ほどObjective-Cを動かす為のC#ソースコードを作成しましたが、そのままでは動いてくれないのでUnityのオブジェクトにアタッチしてアプリ起動時に実行されるようにします。
なので今回は「Main Camera」のゲームオブジェクトにC#のスクリプトをアタッチしましょう！

Main CameraにMediaController.csをアタッチこれでもうUnityでの準備は完了なので、「PlayerSettings」を各自の環境に設定してビルドしましょう！！
(PlatformがiOSになってない方は先にiOSにSwitch Platformで切り替えてからビルドしてください)
そのままでは実行できないので、いくつか設定する必要があります。これで、アプリ起動時に端末のミュージックライブラリへアクセス許可を選択させるポップアップを表示させる事ができます。
Info.plistに設定を追加する次は設定がちょっと厄介で画像のように、左の「Unity-iPhone」を押し真ん中上部付近の「Build Phases」を押して「Compile Sources」のボタンを押しましょう。
下にスクロールすると先ほど作成した「MusicLibraryMediaPicker.mm」があるのでダブルクリックして画像のように「-fno-objc-arc」と入力しましょう。
これで、準備は完了であとは自分の開発者アカウントでSigningして実行しましょう！！作成したソースコードとプロジェクトは、GitHubにアップので良かったらどうぞ。


