More than 1 year has passed since last update.C#の文字列補間という機能をしっていますか？
以下のように文字列の中に変数を埋め込める機能です。C#に限らずほとんどの言語で使用できる機能です。
C#独自の要素として文字列補間を使用した場合、FormattableStringとして変数に代入できるというものがあります。参考:文字列補間を使用してカルチャ固有の結果文字列を作成する方法この仕様自体はカルチャ関連のために存在しているみたいですがほとんど使用したことがないのでよくわかりません。
今回はこの機能を使用して遊んでみます。
実用性は多分ないです。FormattableStringは文字列補間に使用されるフォーマット、渡された引数を持ったオブジェクトです。ポイントはフォーマット文字列と渡された引数が分けて取得できることです。
つまり以下ようなメソッドを書くことができます。何に使えるかわからない非常に面白い機能だと思います。
何とかして有効活用できる方法を探します。長い文字列を生成する際に以下のようなメソッドを作るかもしれません。この文字列をそのまま使用するなら大した問題はありませんが例えばこの文字列をパースする場合を考えます。
つまりこういうことです。上記のCreateDictionaryはあんまり効率が良くないので書き直すことを考えます。
理想は以下の形ですがこれではあまり柔軟性がありません。ある程度汎用的にするなら目指すのは以下のような形でしょうか。これを文字列補間を使用して何とかできないか考えてみましたが最終的に以下のような書き方ができるようになりました。
実装は長いので省きます。
興味がある方はこちらを参照してください。なんかそれっぽい形になったと思います。1バイトもアロケーションしたくない人にとっては素の文字列補間は使用できません。
ゼロアロケーションを目指す場合はフォーマット文字列と引数を別々に渡し、フォーマット文字列をパースしつつ事前に確保しておいたバッファに文字をためていくという実装になります。
例えばUnityのTextMeshProは以下の形でゼロアロケーションを実現しています。文字列補間を使用したゼロアロケーションは以下のような書き方ができるようになりました。
実装はこちらです。今回の記事はjavascriptのタグ付けされたTemplate literalがうらやましかったので作成しました。
タグ付けされたTemplate literalの使用用途について探してもstyled-componentsかgraphql-tagくらいしか見つけられなかったのでC#ではあまり使えない予感がします。
実用的に使えそうなものがあればぜひ教えてください。実装したコードは以下に置いています。
yaegaki/StringInterpolationUtil


