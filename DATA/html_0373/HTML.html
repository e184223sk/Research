<!DOCTYPE html><html><head><meta charset="utf-8" /><title>C#のネイティブ関数呼び出し（P/Invoke）時に行われていることを調べてみた - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/Gaku_Ishii/items/8920f2ce1b880d161345" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="TYYMwSKOcAw+F+zZlguLweidudvoZpgd5Zt2QpbX8f35wsZ+cJvz/XzT3jup0wX9VX+o3Mcp9fqikHv19dNqTg==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="C#のネイティブ関数呼び出し（P/Invoke）時に行われていることを調べてみた - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReVBqZ2E3amc0M2pncVRqZzRiamdxUGpnNWJwbHFMbWxiRGxrYnpqZ2JQbGg3cmpnWmZ2dkloUUwwbHVkbTlyWmUtOGllYVpndU9CcS1paGpPT0NqLU9Dak9PQnB1T0JoT09DaS1PQmstT0JxT09Da3VpcXYtT0J1ZU9CcHVPQnYtT0JudyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1jNTgwYTllNDhkN2VlMDIyMjRmZDhlZDg0MmE3ZGEzYg&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRWRoYTNWZlNYTm9hV2smdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz02MDJiNWFmMDJjZWU5Y2IzNGU3MGZkZDAxNmIzMzU4NQ&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=89c807a19bbbc9832ce4ea8aab6fb0c3"><meta property="og:description" content="本記事はサムザップ #1 AdventCalendar 2020の12/2の記事です。
12/1の記事は@ohbashunsukeさんの【Unity】新規ゲームのUI開発で気をつけた39のTips前編 - Qiitaでした。


モチ..."><meta content="https://qiita.com/Gaku_Ishii/items/8920f2ce1b880d161345" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,.NET,.NETCore" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-64829926-e4ea-42ef-9a54-5b60061d7cb1"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FGaku_Ishii%2Fitems%2F8920f2ce1b880d161345">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FGaku_Ishii%2Fitems%2F8920f2ce1b880d161345">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-64829926-e4ea-42ef-9a54-5b60061d7cb1">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-11-30T12:27:06.000+09:00","dateModified":"2020-12-04T09:59:39.000+09:00","headline":"C#のネイティブ関数呼び出し（P/Invoke）時に行われていることを調べてみた","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReVBqZ2E3amc0M2pncVRqZzRiamdxUGpnNWJwbHFMbWxiRGxrYnpqZ2JQbGg3cmpnWmZ2dkloUUwwbHVkbTlyWmUtOGllYVpndU9CcS1paGpPT0NqLU9Dak9PQnB1T0JoT09DaS1PQmstT0JxT09Da3VpcXYtT0J1ZU9CcHVPQnYtT0JudyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1jNTgwYTllNDhkN2VlMDIyMjRmZDhlZDg0MmE3ZGEzYg\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRWRoYTNWZlNYTm9hV2smdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz02MDJiNWFmMDJjZWU5Y2IzNGU3MGZkZDAxNmIzMzU4NQ\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=89c807a19bbbc9832ce4ea8aab6fb0c3","mainEntityOfPage":"https://qiita.com/Gaku_Ishii/items/8920f2ce1b880d161345","author":{"@type":"Person","address":null,"email":null,"identifier":"Gaku_Ishii","name":"Gaku_Ishii","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F201332%2Fprofile-images%2F1504877398?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=c171f459b9fcc37e13228f09ed2d1ad3","url":"https://qiita.com/Gaku_Ishii","description":null,"memberOf":[{"@type":"Organization","address":"東京都渋谷区宇田川町40番1号Abema Towers","legalName":"サムザップ","image":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/d3aa92800b726b95568ae82e84555b37b2e786d2/original.jpg?1575867579","logo":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/89762330cd3ad4c570e295c58d31ae81c9acc456/original.jpg?1575859802","identifier":"sumzap","description":"スマートフォンゲームの企画・運営・配信事業をしています。"}]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Gaku_Ishii","type":"items","id":"8920f2ce1b880d161345"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Gaku_Ishii","type":"items","id":"8920f2ce1b880d161345"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Gaku_Ishii","type":"items","id":"8920f2ce1b880d161345"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/Gaku_Ishii/items/8920f2ce1b880d161345","location":"/Gaku_Ishii/items/8920f2ce1b880d161345","scheme":"https","host":"qiita.com","port":null,"pathname":"/Gaku_Ishii/items/8920f2ce1b880d161345","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"m+CNRWguf95DktHoKYPkgK0IxTlWx29okyxHMwZmnUsvpEf6Ojv8LwFW4woWW2q8EOrUPnmIAo/UJ0qEZWIG+A==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-bb6eafaa-739a-44c2-898f-82e7cbf610b9"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Gaku_Ishii/items/8920f2ce1b880d161345/likers" class="css-1iupg5d">17</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">2</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/8920f2ce1b880d161345/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Gaku_Ishii/items/8920f2ce1b880d161345/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Gaku_Ishii/items/8920f2ce1b880d161345/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Gaku_Ishii/items/8920f2ce1b880d161345/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Gaku_Ishii/items/8920f2ce1b880d161345.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><a href="/organizations/sumzap"><img src="https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/89762330cd3ad4c570e295c58d31ae81c9acc456/original.jpg?1575859802" class="it-AdcalRibbon_orgImage"/></a><span><a href="/advent-calendar/2020/sumzap1" class="it-AdcalRibbon_title">サムザップ #1<!-- --> Advent Calendar<!-- --> <!-- -->2020</a>Day 2</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/Gaku_Ishii"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/201332/profile-images/1504877398" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/Gaku_Ishii" class="css-10ougpm">@<!-- -->Gaku_Ishii</a><div class="css-1ay9vb9"><span><meta content="2020-11-30T03:27:06Z"/><time dateTime="2020-12-04T00:59:39Z" class="css-m19uds">updated at 2020-12-04</time></span></div></div></div></div></div><h1 class="css-cgzq40">C#のネイティブ関数呼び出し（P/Invoke）時に行われていることを調べてみた</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/.net" class="css-4czcte">.NET</a><a href="/tags/.netcore" class="css-4czcte">.NETCore</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>本記事は<a href="https://qiita.com/advent-calendar/2020/sumzap1">サムザップ #1 AdventCalendar 2020</a>の12/2の記事です。<br>
12/1の記事は<a href="/ohbashunsuke" class="user-mention js-hovercard" title="ohbashunsuke" data-hovercard-target-type="user" data-hovercard-target-name="ohbashunsuke">@ohbashunsuke</a>さんの<a href="https://qiita.com/ohbashunsuke/items/0570234362e2e45c0011" id="reference-1dd3a36b44d743dce6d6">【Unity】新規ゲームのUI開発で気をつけた39のTips前編 - Qiita</a>でした。</p>

<h2>
<span id="モチベーション" class="fragment"></span><a href="#%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>モチベーション</h2>

<p><a href="https://qiita.com/KageShiron/items/8093a68e824e1f6c8300" id="reference-9fe6db7b6a5c85c4cd94">P/Invokeと各種String作成ベンチマーク - Qiita</a>の記事で紹介されているベンチマークでは、<br>
StringBuilderは他の手法に比べて頭一つ遅くなっていました。</p>

<p>他と比べて遅いのはマネージド・ネイティブ間のデータの受け渡し（マーシャリング）コストが上乗せされた結果のような感じがしますが、<br>
実際に何が行われているのか、気になったので調べてみました。</p>

<h2>
<span id="準備" class="fragment"></span><a href="#%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>準備</h2>

<p>まずはネイティブ関数呼び出しを行う、ミニマムなコンソールアプリケーションを作成します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><code>$ dotnet new console
</code></pre></div></div>

<p><details><summary>ネイティブ関数呼び出しの実装(<code>Program.cs</code>)</summary><div>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">Program.cs</span></div>
<div class="highlight"><pre><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">pinvoke</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"Kernel32"</span><span class="p">,</span> <span class="n">CharSet</span> <span class="p">=</span> <span class="n">CharSet</span><span class="p">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">EntryPoint</span> <span class="p">=</span> <span class="s">"GetTempPathW"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">GetTempPath</span><span class="p">(</span><span class="kt">uint</span> <span class="n">nBufferLength</span><span class="p">,</span> <span class="n">StringBuilder</span> <span class="n">sb</span><span class="p">);</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span> <span class="m">260</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>
            <span class="nf">GetTempPath</span><span class="p">(</span><span class="m">260</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">sb</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p></p>
</div></details></p>

<p>動作確認のためにコードをビルドして実行します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><code>$ dotnet build
$ dotnet run
C:\Users\user\AppData\Local\Temp\
</code></pre></div></div>

<p>想定通りに一時ディレクトリのパスが出力されました、ネイティブ関数呼び出しの実装は問題なさそうです。</p>

<h2>
<span id="調査" class="fragment"></span><a href="#%E8%AA%BF%E6%9F%BB"><i class="fa fa-link"></i></a>調査</h2>

<p>C#ではMashalAs属性を使って、ネイティブ関数呼び出し時のデータの受け渡し方法をコントロールすることができます。<br>
設定によって文字コードの変換（ANSI → UTF-16など）もかかる、これらのマーシャリングを行うコードはいつ作られるのでしょうか。</p>

<p>まずコンパイル時の可能性を考えますが、これはビルドしたDLLをIL DASMで見てみてもC#のコードとほぼ変わらないため、違うことが分かります。</p>

<p><details><summary>IL DASM 出力結果</summary><div>

<p>Mainメソッドからの<code>GetTempPath</code>関数呼び出しは、普通の関数呼び出しと変わらない</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><code>  IL_0006:  newobj     instance void [System.Runtime]System.Text.StringBuilder::.ctor(int32)
  IL_000b:  stloc.0
  IL_000c:  ldc.i4     0x104
  IL_0011:  ldloc.0
  IL_0012:  call       int32 pinvoke.Program::GetTempPath(uint32,
                                                          class [System.Runtime]System.Text.StringBuilder)
</code></pre></div></div>

<p><code>GetTempPath</code>のメソッド本体は空になっている</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><code>.method public hidebysig static pinvokeimpl("Kernel32" as "GetTempPathW" unicode winapi) 
        int32  GetTempPath(uint32 nBufferLength,
                           class [System.Runtime]System.Text.StringBuilder sb) cil managed preservesig
{
}
</code></pre></div></div>

<p></p>
</div></details></p>

<p>ではコンパイル時ではないとすると、コードが生成されるのは実行時になるのでしょうか。<br>
結論から言うとそうなります。</p>

<p>こちらの記事<sup id="fnref1"><a href="#fn1" title="Improvements to Interop Marshaling in V4: IL Stubs Everywhere | .NET Blog">1</a></sup>によるとランタイム（CLR）によって実行時にマーシャリングのコードが生成されること、<br>
また、その生成されるコードの詳細をETWイベント経由で確認できるツールが紹介されています。</p>

<p>このIL Stub Diagnosticsというツール <sup id="fnref2"><a href="#fn2" title="IL Stub Diagnostic Tool | .NET Blog">2</a></sup> ですが、残念ながら私のPCでは動作しなかったので、<br>
直接実行時のETWイベントから詳細を取得してみることにします。</p>

<p>ドキュメント<sup id="fnref3"><a href="#fn3" title="Interop runtime events - .NET | Microsoft Docs">3</a></sup>を参照すると<code>dotnet-trace</code>コマンドでプロバイダーを<code>Microsoft-Windows-DotNETRuntime</code>に、<br>
フラグを<code>0x2000</code>、レベルを<code>4</code>にすると、スタブ生成のETWイベントが捕捉できそうです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><code>$ dotnet-trace collect --providers Microsoft-Windows-DotNETRuntime:0x2000:4 -- ./bin/Debug/net5.0/pinvoke.exe
Provider Name                           Keywords            Level               Enabled By
Microsoft-Windows-DotNETRuntime         0x0000000000002000  Informational(4)    --providers

Process        : C:\Users\user\...\pinvoke\bin\Debug\net5.0\pinvoke.exe
Output File    : C:\Users\user\...\pinvoke\trace.nettrace

[00:00:00:00]   Recording trace 0.00     (B)
Press &lt;Enter&gt; or &lt;Ctrl+C&gt; to exit...

Trace completed.
</code></pre></div></div>

<p>トレースが完了したら <code>trace.nettrace</code> というファイルが出力されますので、これをPerfViewで開いてみます。</p>

<p><a href="https://camo.qiitausercontent.com/dc477e442e93be2c554d120222add06c15e9a4ab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230313333322f33613366356238392d396665652d663863332d396630372d6539343361643339623131362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F3a3f5b89-9fee-f8c3-9f07-e943ad39b116.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=cc5e75b7d16337e765b3c8c282066768" alt="perfview-trace_nettrace.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/201332/3a3f5b89-9fee-f8c3-9f07-e943ad39b116.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F3a3f5b89-9fee-f8c3-9f07-e943ad39b116.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b2ae3cac2ef6e475720f2902e18b81c2 1x" loading="lazy"></a></p>

<p><code>trace.nettrace</code>のEventsをダブルクリックすると、新しいウィンドウでETWイベントの一覧が表示されます。</p>

<p><a href="https://camo.qiitausercontent.com/bfc47971ca3b9f13524f00d1f0522c748245e3ef/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230313333322f30393361356432322d653465382d656665622d383531622d6634383037386530613166612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F093a5d22-e4e8-efeb-851b-f48078e0a1fa.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=31d02c57436de6c69fa61af19e6789ec" alt="perfview-events.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/201332/093a5d22-e4e8-efeb-851b-f48078e0a1fa.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F093a5d22-e4e8-efeb-851b-f48078e0a1fa.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=99dcb550ec1946e7fee1dabe512bc871 1x" loading="lazy"></a></p>

<p>今回の実装に使った<code>GetTempPath</code>でフィルタリングすると、確かにILコードがありました。</p>

<p><a href="https://camo.qiitausercontent.com/257d87053313f2f1792aad5969065def27464297/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230313333322f32376635326130382d326538362d373862322d343766302d6637353161666166316639302e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F27f52a08-2e86-78b2-47f0-f751afaf1f90.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ffebd2c5b2faf98851cdf269e64578b2" alt="perfview-stubmethod-detail.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/201332/27f52a08-2e86-78b2-47f0-f751afaf1f90.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F27f52a08-2e86-78b2-47f0-f751afaf1f90.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f6482d083e1ff53c00a6a0c783b3af14 1x" loading="lazy"></a></p>

<p>ILにはあまり詳しくないので雰囲気で読み解いていくと、<br>
スタブコードのネイティブ関数呼び出し前後で呼ばれてそうなメソッドは下記でした。</p>

<p>コードには<em>条件分岐</em>も含まれていましたので正確ではありませんが、</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre><code><span class="n">Marshal</span><span class="p">.</span><span class="n">AllocCoTaskMem</span>
<span class="n">StringBuilder</span><span class="p">.</span><span class="n">InternalCopy</span>
<span class="c1">// ネイティブ関数呼び出し</span>
<span class="n">StringBuilder</span><span class="p">.</span><span class="n">ReplaceBufferInternal</span>
<span class="n">Marshal</span><span class="p">.</span><span class="n">FreeCoTaskMem</span>
</code></pre></div></div>

<p>メソッド名から察するに、一時バッファを用意しそこにStringBuilderの内容をコピーし、<br>
ネイティブ関数呼び出し後書き戻して割り当てたバッファを解放する、みたいな挙動でしょうか。</p>

<p>なるほど他の手法に比べて遅くなりそうな雰囲気がします。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<ul>
<li>.NET Coreではネイテイブ関数呼び出し時に、マネージドとネイティブの橋渡し(マーシャリング)をするスタブコードを生成している</li>
<li>スタブコードは生成のETWイベントにより、その詳細を知ることができる</li>
</ul>

<p>以上になります。<br>
明日は<a href="/phasmatodean" class="user-mention js-hovercard" title="phasmatodean" data-hovercard-target-type="user" data-hovercard-target-name="phasmatodean">@phasmatodean</a>さんの記事です。</p>

<h2>
<span id="環境" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>環境</h2>

<p>Windows 10 Pro 20H2</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><code>$ dotnet --version
5.0.100

$ dotnet-trace --version
5.0.152202+4d281c71a14e6226ab0bf0c98687db4a5c4217e3
</code></pre></div></div>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<ul>
<li><a href="https://www.devops.lol/pinvoke-beyond-the-magic/" rel="nofollow noopener" target="_blank">PInvoke: beyond the magic | devops.lol</a></li>
<li><a href="https://docs.microsoft.com/ja-jp/dotnet/core/diagnostics/dotnet-trace" rel="nofollow noopener" target="_blank">dotnet-trace 診断ツール - .NET CLI | Microsoft Docs</a></li>
</ul>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p><a href="https://devblogs.microsoft.com/dotnet/improvements-to-interop-marshaling-in-v4-il-stubs-everywhere/" rel="nofollow noopener" target="_blank">Improvements to Interop Marshaling in V4: IL Stubs Everywhere | .NET Blog</a> <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p><a href="https://devblogs.microsoft.com/dotnet/il-stub-diagnostic-tool/" rel="nofollow noopener" target="_blank">IL Stub Diagnostic Tool | .NET Blog</a> <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p><a href="https://docs.microsoft.com/en-us/dotnet/fundamentals/diagnostics/runtime-interop-events" rel="nofollow noopener" target="_blank">Interop runtime events - .NET | Microsoft Docs</a> <a href="#fnref3">↩</a></p>
</li>

</ol>
</div>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FGaku_Ishii%2Fitems%2F8920f2ce1b880d161345&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FGaku_Ishii%2Fitems%2F8920f2ce1b880d161345&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Gaku_Ishii/items/8920f2ce1b880d161345/likers" class="css-1iupg5d">17</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">2</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/8920f2ce1b880d161345/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Gaku_Ishii/items/8920f2ce1b880d161345/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Gaku_Ishii/items/8920f2ce1b880d161345/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Gaku_Ishii/items/8920f2ce1b880d161345/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Gaku_Ishii/items/8920f2ce1b880d161345.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-bb6eafaa-739a-44c2-898f-82e7cbf610b9">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-c8a130ab-da3d-4999-a03e-e2eec9319f77"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-c8a130ab-da3d-4999-a03e-e2eec9319f77">{}</script>
      
<div id="LoginModal-react-component-391b1ee7-5c65-4b98-bcdc-cfb172a3e343"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-391b1ee7-5c65-4b98-bcdc-cfb172a3e343">{}</script>
      
<div id="StockModal-react-component-a9d223e5-5fe8-4b75-9654-91278cf7ee5e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-a9d223e5-5fe8-4b75-9654-91278cf7ee5e">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;v70mZiOmbcvIsThrWkuRQgfqqrsI1+1/D56DZrk/MaYL+ezZcbPuOop1Collkx9+ugi7vCeYgJhIlY7R2juqFQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e本記事は\u003ca href=\"https://qiita.com/advent-calendar/2020/sumzap1\"\u003eサムザップ #1 AdventCalendar 2020\u003c/a\u003eの12/2の記事です。\u003cbr\u003e\n12/1の記事は\u003ca href=\"/ohbashunsuke\" class=\"user-mention js-hovercard\" title=\"ohbashunsuke\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"ohbashunsuke\"\u003e@ohbashunsuke\u003c/a\u003eさんの\u003ca href=\"https://qiita.com/ohbashunsuke/items/0570234362e2e45c0011\" id=\"reference-1dd3a36b44d743dce6d6\"\u003e【Unity】新規ゲームのUI開発で気をつけた39のTips前編 - Qiita\u003c/a\u003eでした。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"モチベーション\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eモチベーション\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/KageShiron/items/8093a68e824e1f6c8300\" id=\"reference-9fe6db7b6a5c85c4cd94\"\u003eP/Invokeと各種String作成ベンチマーク - Qiita\u003c/a\u003eの記事で紹介されているベンチマークでは、\u003cbr\u003e\nStringBuilderは他の手法に比べて頭一つ遅くなっていました。\u003c/p\u003e\n\n\u003cp\u003e他と比べて遅いのはマネージド・ネイティブ間のデータの受け渡し（マーシャリング）コストが上乗せされた結果のような感じがしますが、\u003cbr\u003e\n実際に何が行われているのか、気になったので調べてみました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"準備\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%BA%96%E5%82%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e準備\u003c/h2\u003e\n\n\u003cp\u003eまずはネイティブ関数呼び出しを行う、ミニマムなコンソールアプリケーションを作成します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e$ dotnet new console\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003eネイティブ関数呼び出しの実装(\u003ccode\u003eProgram.cs\u003c/code\u003e)\u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eProgram.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Runtime.InteropServices\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Text\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003epinvoke\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Kernel32\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCharSet\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCharSet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnicode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEntryPoint\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GetTempPathW\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetTempPath\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003enBufferLength\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStringBuilder\u003c/span\u003e \u003cspan class=\"n\"\u003esb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e260\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eGetTempPath\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e260\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003e動作確認のためにコードをビルドして実行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e$ dotnet build\n$ dotnet run\nC:\\Users\\user\\AppData\\Local\\Temp\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e想定通りに一時ディレクトリのパスが出力されました、ネイティブ関数呼び出しの実装は問題なさそうです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"調査\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%BF%E6%9F%BB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e調査\u003c/h2\u003e\n\n\u003cp\u003eC#ではMashalAs属性を使って、ネイティブ関数呼び出し時のデータの受け渡し方法をコントロールすることができます。\u003cbr\u003e\n設定によって文字コードの変換（ANSI → UTF-16など）もかかる、これらのマーシャリングを行うコードはいつ作られるのでしょうか。\u003c/p\u003e\n\n\u003cp\u003eまずコンパイル時の可能性を考えますが、これはビルドしたDLLをIL DASMで見てみてもC#のコードとほぼ変わらないため、違うことが分かります。\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003eIL DASM 出力結果\u003c/summary\u003e\u003cdiv\u003e\n\n\u003cp\u003eMainメソッドからの\u003ccode\u003eGetTempPath\u003c/code\u003e関数呼び出しは、普通の関数呼び出しと変わらない\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e  IL_0006:  newobj     instance void [System.Runtime]System.Text.StringBuilder::.ctor(int32)\n  IL_000b:  stloc.0\n  IL_000c:  ldc.i4     0x104\n  IL_0011:  ldloc.0\n  IL_0012:  call       int32 pinvoke.Program::GetTempPath(uint32,\n                                                          class [System.Runtime]System.Text.StringBuilder)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eGetTempPath\u003c/code\u003eのメソッド本体は空になっている\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e.method public hidebysig static pinvokeimpl(\"Kernel32\" as \"GetTempPathW\" unicode winapi) \n        int32  GetTempPath(uint32 nBufferLength,\n                           class [System.Runtime]System.Text.StringBuilder sb) cil managed preservesig\n{\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003eではコンパイル時ではないとすると、コードが生成されるのは実行時になるのでしょうか。\u003cbr\u003e\n結論から言うとそうなります。\u003c/p\u003e\n\n\u003cp\u003eこちらの記事\u003csup id=\"fnref1\"\u003e\u003ca href=\"#fn1\" title=\"Improvements to Interop Marshaling in V4: IL Stubs Everywhere | .NET Blog\"\u003e1\u003c/a\u003e\u003c/sup\u003eによるとランタイム（CLR）によって実行時にマーシャリングのコードが生成されること、\u003cbr\u003e\nまた、その生成されるコードの詳細をETWイベント経由で確認できるツールが紹介されています。\u003c/p\u003e\n\n\u003cp\u003eこのIL Stub Diagnosticsというツール \u003csup id=\"fnref2\"\u003e\u003ca href=\"#fn2\" title=\"IL Stub Diagnostic Tool | .NET Blog\"\u003e2\u003c/a\u003e\u003c/sup\u003e ですが、残念ながら私のPCでは動作しなかったので、\u003cbr\u003e\n直接実行時のETWイベントから詳細を取得してみることにします。\u003c/p\u003e\n\n\u003cp\u003eドキュメント\u003csup id=\"fnref3\"\u003e\u003ca href=\"#fn3\" title=\"Interop runtime events - .NET | Microsoft Docs\"\u003e3\u003c/a\u003e\u003c/sup\u003eを参照すると\u003ccode\u003edotnet-trace\u003c/code\u003eコマンドでプロバイダーを\u003ccode\u003eMicrosoft-Windows-DotNETRuntime\u003c/code\u003eに、\u003cbr\u003e\nフラグを\u003ccode\u003e0x2000\u003c/code\u003e、レベルを\u003ccode\u003e4\u003c/code\u003eにすると、スタブ生成のETWイベントが捕捉できそうです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e$ dotnet-trace collect --providers Microsoft-Windows-DotNETRuntime:0x2000:4 -- ./bin/Debug/net5.0/pinvoke.exe\nProvider Name                           Keywords            Level               Enabled By\nMicrosoft-Windows-DotNETRuntime         0x0000000000002000  Informational(4)    --providers\n\nProcess        : C:\\Users\\user\\...\\pinvoke\\bin\\Debug\\net5.0\\pinvoke.exe\nOutput File    : C:\\Users\\user\\...\\pinvoke\\trace.nettrace\n\n[00:00:00:00]   Recording trace 0.00     (B)\nPress \u0026lt;Enter\u0026gt; or \u0026lt;Ctrl+C\u0026gt; to exit...\n\nTrace completed.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eトレースが完了したら \u003ccode\u003etrace.nettrace\u003c/code\u003e というファイルが出力されますので、これをPerfViewで開いてみます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/dc477e442e93be2c554d120222add06c15e9a4ab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230313333322f33613366356238392d396665652d663863332d396630372d6539343361643339623131362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F3a3f5b89-9fee-f8c3-9f07-e943ad39b116.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=cc5e75b7d16337e765b3c8c282066768\" alt=\"perfview-trace_nettrace.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/201332/3a3f5b89-9fee-f8c3-9f07-e943ad39b116.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F3a3f5b89-9fee-f8c3-9f07-e943ad39b116.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b2ae3cac2ef6e475720f2902e18b81c2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003etrace.nettrace\u003c/code\u003eのEventsをダブルクリックすると、新しいウィンドウでETWイベントの一覧が表示されます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/bfc47971ca3b9f13524f00d1f0522c748245e3ef/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230313333322f30393361356432322d653465382d656665622d383531622d6634383037386530613166612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F093a5d22-e4e8-efeb-851b-f48078e0a1fa.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=31d02c57436de6c69fa61af19e6789ec\" alt=\"perfview-events.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/201332/093a5d22-e4e8-efeb-851b-f48078e0a1fa.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F093a5d22-e4e8-efeb-851b-f48078e0a1fa.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=99dcb550ec1946e7fee1dabe512bc871 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e今回の実装に使った\u003ccode\u003eGetTempPath\u003c/code\u003eでフィルタリングすると、確かにILコードがありました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/257d87053313f2f1792aad5969065def27464297/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230313333322f32376635326130382d326538362d373862322d343766302d6637353161666166316639302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F27f52a08-2e86-78b2-47f0-f751afaf1f90.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ffebd2c5b2faf98851cdf269e64578b2\" alt=\"perfview-stubmethod-detail.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/201332/27f52a08-2e86-78b2-47f0-f751afaf1f90.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F201332%2F27f52a08-2e86-78b2-47f0-f751afaf1f90.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f6482d083e1ff53c00a6a0c783b3af14 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eILにはあまり詳しくないので雰囲気で読み解いていくと、\u003cbr\u003e\nスタブコードのネイティブ関数呼び出し前後で呼ばれてそうなメソッドは下記でした。\u003c/p\u003e\n\n\u003cp\u003eコードには\u003cem\u003e条件分岐\u003c/em\u003eも含まれていましたので正確ではありませんが、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocCoTaskMem\u003c/span\u003e\n\u003cspan class=\"n\"\u003eStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInternalCopy\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ネイティブ関数呼び出し\u003c/span\u003e\n\u003cspan class=\"n\"\u003eStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReplaceBufferInternal\u003c/span\u003e\n\u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFreeCoTaskMem\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eメソッド名から察するに、一時バッファを用意しそこにStringBuilderの内容をコピーし、\u003cbr\u003e\nネイティブ関数呼び出し後書き戻して割り当てたバッファを解放する、みたいな挙動でしょうか。\u003c/p\u003e\n\n\u003cp\u003eなるほど他の手法に比べて遅くなりそうな雰囲気がします。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e.NET Coreではネイテイブ関数呼び出し時に、マネージドとネイティブの橋渡し(マーシャリング)をするスタブコードを生成している\u003c/li\u003e\n\u003cli\u003eスタブコードは生成のETWイベントにより、その詳細を知ることができる\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e以上になります。\u003cbr\u003e\n明日は\u003ca href=\"/phasmatodean\" class=\"user-mention js-hovercard\" title=\"phasmatodean\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"phasmatodean\"\u003e@phasmatodean\u003c/a\u003eさんの記事です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"環境\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%92%B0%E5%A2%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e環境\u003c/h2\u003e\n\n\u003cp\u003eWindows 10 Pro 20H2\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e$ dotnet --version\n5.0.100\n\n$ dotnet-trace --version\n5.0.152202+4d281c71a14e6226ab0bf0c98687db4a5c4217e3\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"参考\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.devops.lol/pinvoke-beyond-the-magic/\" rel=\"nofollow noopener\" target=\"_blank\"\u003ePInvoke: beyond the magic | devops.lol\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/core/diagnostics/dotnet-trace\" rel=\"nofollow noopener\" target=\"_blank\"\u003edotnet-trace 診断ツール - .NET CLI | Microsoft Docs\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\n\u003cli id=\"fn1\"\u003e\n\u003cp\u003e\u003ca href=\"https://devblogs.microsoft.com/dotnet/improvements-to-interop-marshaling-in-v4-il-stubs-everywhere/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eImprovements to Interop Marshaling in V4: IL Stubs Everywhere | .NET Blog\u003c/a\u003e \u003ca href=\"#fnref1\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn2\"\u003e\n\u003cp\u003e\u003ca href=\"https://devblogs.microsoft.com/dotnet/il-stub-diagnostic-tool/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eIL Stub Diagnostic Tool | .NET Blog\u003c/a\u003e \u003ca href=\"#fnref2\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn3\"\u003e\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/en-us/dotnet/fundamentals/diagnostics/runtime-interop-events\" rel=\"nofollow noopener\" target=\"_blank\"\u003eInterop runtime events - .NET | Microsoft Docs\u003c/a\u003e \u003ca href=\"#fnref3\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003c/ol\u003e\n\u003c/div\u003e\n","createdAt":"2020-11-30T03:27:06Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"eRjLugsfXTL/Tw+q6o4kxGBAbqE8lmp3AA==--PPmv/L9fZo0DJZNU--VjLQ2jyISJG3oN0NWPCxqw==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-12-04T00:59:39Z","likesCount":17,"linkUrl":"https://qiita.com/Gaku_Ishii/items/8920f2ce1b880d161345","organization":null,"originalId":1346241,"stockedCount":2,"title":"C#のネイティブ関数呼び出し（P/Invoke）時に行われていることを調べてみた","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\"\u003eモチベーション\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%BA%96%E5%82%99\"\u003e準備\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%BF%E6%9F%BB\"\u003e調査\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%92%B0%E5%A2%83\"\u003e環境\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83\"\u003e参考\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":828,"uuid":"8920f2ce1b880d161345","banReason":null,"adventCalendarItem":{"day":2,"calendar":{"name":"サムザップ #1","urlName":"sumzap1","year":2020,"organization":{"logoUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/89762330cd3ad4c570e295c58d31ae81c9acc456/original.jpg?1575859802","urlName":"sumzap"}}},"author":{"encryptedId":"Fn9sQIQlYexRk9uSnd9cIv0QtxW9--0nAisC28oK5/EDl4--7i8oxPVaGT2mPyyGnPv6HQ==","originalId":201332,"description":"","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/201332/profile-images/1504877398","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F201332%2Fprofile-images%2F1504877398?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=ad5707981cb2b97724265649e047384f","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F201332%2Fprofile-images%2F1504877398?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=c171f459b9fcc37e13228f09ed2d1ad3","urlName":"Gaku_Ishii","websiteUrl":null,"twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[{"node":{"encryptedId":"6YRyGFGdPLwNUCtRGSN8ON02rCQSljeSaVLa--ZYhu9e2PzjVa6+gU--KjegmaeIUcm5CmPTTTGRSA==","isBetaReleaseEnabled":false,"isFollowableByViewer":false,"isFollowedByViewer":false,"name":"サムザップ","logoUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/89762330cd3ad4c570e295c58d31ae81c9acc456/original.jpg?1575859802","urlName":"sumzap","description":"スマートフォンゲームの企画・運営・配信事業をしています。","url":"https://tech.sumzap.co.jp/"}}]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":".NET","urlName":".net"},{"name":".NETCore","urlName":".netcore"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
