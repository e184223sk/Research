using System;
using CoreTweet;
using Newtonsoft.Json;

namespace ConsoleApp1
{
    #region JsonClass
    public class Target
    {
        public long recipient_id { get; set; }
    }

    public class Media
    {
        public long id { get; set; }
    }

    public class Attachment
    {
        public string type { get; set; }
        public Media media { get; set; }
    }

    public class MessageData
    {
        public string text { get; set; }
        public Attachment attachment { get; set; }
    }

    public class MessageCreate
    {
        public Target target { get; set; }
        public MessageData message_data { get; set; }
    }

    public class Event
    {
        public string type { get; set; }
        public MessageCreate message_create { get; set; }
    }

    public class Root
    {
        public Event @event { get; set; }
    }
    #endregion

    class Program
    {
        static void Main(string[] args)
        {
            //ä»Šæ—¥ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’å–å¾—
            string yyyyMMdd = DateTime.Now.ToString("yyyyMMdd");

            //ãƒ¦ãƒ¼ã‚¶IDï¼ˆDMã‚’é€ä¿¡ã™ã‚‹user_idï¼‰
            Int64 useID = ï¼œãƒ¦ãƒ¼ã‚¶IDï¼;
            //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            string dmMessage = @"ä»Šæ—¥ã®ä¸€æšğŸ˜˜";
            //ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
            string imgFilePath = @"C:\Users\ï¼œç”»åƒãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ï¼\img_" + yyyyMMdd + ".jpg";

            //API key
            string apiKey = "ï¼œAPIã‚­ãƒ¼ï¼";
            //API secret key
            string apiSecretKey = "ï¼œAPIã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ï¼";
            //Access token
            string accessToken = "ï¼œã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼";
            //Access token secret
            string accessTokenSecret = "ï¼œã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼";

            //èªè¨¼æƒ…å ±
            var tokens = CoreTweet.Tokens.Create(apiKey, apiSecretKey, accessToken, accessTokenSecret);

            //ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            System.IO.FileInfo imgFileInfo = new System.IO.FileInfo(imgFilePath);
            //ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦media_idã‚’å–å¾—
            var mediaId = tokens.Media.Upload(imgFileInfo);

            //JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
            Media jsonMedia = new Media();
            jsonMedia.id = Int64.Parse(mediaId.ToString());
            Attachment jsonAttachment = new Attachment();
            jsonAttachment.type = "media";
            jsonAttachment.media = jsonMedia;
            Target jsonTarget = new Target();
            jsonTarget.recipient_id = useID;
            MessageData jsonMessageData = new MessageData();
            jsonMessageData.text = dmMessage;
            jsonMessageData.attachment = jsonAttachment;
            MessageCreate jsonMessageCreate = new MessageCreate();
            jsonMessageCreate.target = jsonTarget;
            jsonMessageCreate.message_data = jsonMessageData;
            Event jsonEvent = new Event();
            jsonEvent.type = "message_create";
            jsonEvent.message_create = jsonMessageCreate;
            Root jsonRoot = new Root();
            jsonRoot.@event = jsonEvent;

            //JSONã‚’æ–‡å­—åˆ—å¤‰æ›
            var jsonStr = JsonConvert.SerializeObject(jsonRoot);
            //ãƒã‚¤ãƒˆé…åˆ—ã«å¤‰æ›
            byte[] jsonData = System.Text.Encoding.UTF8.GetBytes(jsonStr);

            //DMé€ä¿¡
            tokens.PostContent("https://api.twitter.com/1.1/direct_messages/events/new.json", "application/json", jsonData);
        }
    }
}

