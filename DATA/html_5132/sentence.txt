More than 3 years have passed since last update.Azureに精通している方は、もはや何を言ってるか分からないと思いますが、Log Analyticsのグラフじゃ満足しない方や、諸事情によりLog Analyticsにしかデータを突っ込めない方が、Time Series Insightsを使いたい、という要件にお答えするエントリーです。実際に私が構築した環境では、Functionsを利用して10分ごとにデータを突っ込んでいますが、そこは割愛します。
というのも、Functionsのコンセプト上（1つの関数で完結するのが望ましい）、Functionsに記述するソースコードが汚くなってしまうからです。
まぁ書こうと思えば書けるんでしょうけど・・・。本エントリーはプログラムに特化しています。
Azureの各サービスの内容や構築方法、各パラメータの抽出方法等は記載いたしません。
というのも、公式HPを見ながらやってみて、特別不足しているような情報は無かったからです。
＃若干情報が古いなー、とは思いましたが。Azureに関する情報は公式HPやMVPな方々のブログ等を見てください。
以下公式HPです。Azure Time Series Insights
Azure Event Hubs
Azure Log Analytics兎にも角にもまずはデータを持ってこないと始まりません。
Log AnalyticsにはREST APIが用意されており、かつ.Netライブラリも提供されているので、有効活用します。NuGetから以下のライブラリをインストールしましょう。
依存関係で他のライブラリもインストールするけどいい？と聞かれるのでインストールしましょう。
エントリー投稿時点で利用したバージョンも記載しておきます。認証が必要なのでログインします。
プログラム的な表現をすると、Log Analytics Clientを用意します。事前にAzure ADにService Principalを登録しておく必要があります。
詳細はこちらクライアントが用意できたらデータを引っこ抜くだけです。
引っこ抜く方法は、Log Analyticsを利用している方なら良くご存知のアレです。
Log Analytics Queryです。詳細は省きますが、SQL文のようなQueryでいろんなことができます。ここで注意点。
引っこ抜いたデータは、Event Hubsに渡し、最終的にTime Series Insightsに流れます。
つまり、Time Series Insightsがサポートする形式でないと、期待したグラフに描画されません。Microsoftさんはちゃんと公式ドキュメントでサポートしている形式を公表しています。
イベント ハブを使用して Time Series Insights 環境にイベントを送信する - サポートされている JSON 構造というわけで、このサポートされているJSON構造になるようにQueryを書きましょう。
ベストプラクティス、という程のものではありませんが、私はEvent Hubsに流すソースを書く前に、JSON変換して中身を確認しました。以降のコードは、下記JSON構造のデータを取り扱う前提です。
（公式ドキュメントの「サンプル2」）C#的には以下の型になります。
ただ動かすということであればinterfaceでもclassでもどちらでもいいです。さて、本題。
データを引っこ抜くメソッドを用意しましょう。＃これだけなのでメソッド化しなくても良いですが、拡張性を考慮して。そして、JSON化しましょう。これで晴れてLog Analyticsからデータを引っこ抜けました。
ここまで来ればあとは簡単です。次はEvent Hubsです。
ログインして投げ込みます。エラーが出なければOKです。Time Series Insightsコンソールに入ると、イベントの数でグラフが描画されます。
適宜直して、期待したとおりのグラフが描画されるか確認しましょう。どうでしょうか。
意外と簡単かも？と思われた方が多いかと思います。Log Analytics SDKが思いのほかしっかりしていて、JSON化しやすい型で返してくれるのが大きいですね。結局のところ一番大変なのは、サポートされているJSON構造にすること、だと思います。
私も実際コレが大変だと感じました。複数のLog Analytics Queryを1つのJSONにまとめる、ということをやってものすごく苦労しました。
Time Series InsightsはTimestampフィールドがキモなので、階層が深くなった場合に、Timestampフィールドをどのレベルの階層に置くか、が重要なのです。例として2つのQueryから得られるデータを、以下の様なJSON構造にまとめると、Time Series Insightsでは期待したグラフは描画されません。理由は、Timestampフィールドが2種類になってしまうためです。解決策はいくつかありますが、本エントリーの主旨から外れるので記載しません。長くなりましたが、参考にしていただけると幸いです。
良きAzureライフを。


