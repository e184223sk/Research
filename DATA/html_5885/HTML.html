<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Azure Functions とパフォーマンスチューニングその１ - Queue-Based Load Leveling pattern - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="Crn0bdgWCdlAYUaH/i3K3+zuB0Kf/V5ydgbR9BtPQFDi+h3f3dP0omdPGIrQoZhKScZzloK9FbZVzzYEND5m4A==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="Azure Functions とパフォーマンスチューニングその１ - Queue-Based Load Leveling pattern - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RWHAxY21VZ1JuVnVZM1JwYjI1eklPT0JxT09Ea2VPRGxlT0NxZU9Edk9PRG51T0RzLU9DdWVPRGdlT0RwZU9Edk9PRGktT0RzLU9Dc09PQm5lT0JydS04a1NBdElGRjFaWFZsTFVKaGMyVmtJRXh2WVdRZ1RHVjJaV3hwYm1jZ2NHRjBkR1Z5YmcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YzA4NGFhMGQ4ZDgxYTFkMjAzN2E1ZGI1NGM2Njg3MDA&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=4bc3b45734b57db8a035aa2c8a372a4a"><meta property="og:description" content="Cloud のデザインパターンで、Queue-Based Load Leveling pattern というのがある。Serverless をやっているとアーキテクチャをもっと勉強しとくほうがいいなと思って、少しづつパターンを検証して..."><meta content="https://qiita.com/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,AzureFunctions" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-10731734-7cee-4f80-ae03-0758578e4d48"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2Ffbb1d1d06ef2eb932faf">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2Ffbb1d1d06ef2eb932faf">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-10731734-7cee-4f80-ae03-0758578e4d48">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2017-11-15T02:18:25.000+09:00","dateModified":"2017-11-15T02:18:25.000+09:00","headline":"Azure Functions とパフォーマンスチューニングその１ - Queue-Based Load Leveling pattern","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RWHAxY21VZ1JuVnVZM1JwYjI1eklPT0JxT09Ea2VPRGxlT0NxZU9Edk9PRG51T0RzLU9DdWVPRGdlT0RwZU9Edk9PRGktT0RzLU9Dc09PQm5lT0JydS04a1NBdElGRjFaWFZsTFVKaGMyVmtJRXh2WVdRZ1RHVjJaV3hwYm1jZ2NHRjBkR1Z5YmcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YzA4NGFhMGQ4ZDgxYTFkMjAzN2E1ZGI1NGM2Njg3MDA\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=4bc3b45734b57db8a035aa2c8a372a4a","mainEntityOfPage":"https://qiita.com/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf","author":{"@type":"Person","address":"Kanagwa, Japan","email":null,"identifier":"TsuyoshiUshio@github","name":"TsuyoshiUshio@github","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","url":"https://qiita.com/TsuyoshiUshio@github","description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"fbb1d1d06ef2eb932faf"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"fbb1d1d06ef2eb932faf"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"fbb1d1d06ef2eb932faf"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf","location":"/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf","scheme":"https","host":"qiita.com","port":null,"pathname":"/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"22dmbhWikvO098RQOL+SNvEkT91wngyoQcX/cxie3p0zJI/cEGdviJPZml0WM8CjVAw7CW3eR2xiDBiDN+/4LQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-8d1d03e8-04b9-42c9-8bf1-bdfd2055ecc8"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf/likers" class="css-1iupg5d">14</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">7</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/fbb1d1d06ef2eb932faf/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/TsuyoshiUshio@github"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/TsuyoshiUshio@github" class="css-10ougpm">@<!-- -->TsuyoshiUshio@github</a><div class="css-1ay9vb9"><time dateTime="2017-11-14T17:18:25Z" class="css-m19uds">posted at 2017-11-14</time></div></div></div></div></div><h1 class="css-cgzq40">Azure Functions とパフォーマンスチューニングその１ - Queue-Based Load Leveling pattern</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/azurefunctions" class="css-4czcte">AzureFunctions</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>Cloud のデザインパターンで、<a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling" rel="nofollow noopener" target="_blank">Queue-Based Load Leveling pattern</a> というのがある。Serverless をやっているとアーキテクチャをもっと勉強しとくほうがいいなと思って、少しづつパターンを検証してみようと思っている。ふと思い立って、このパターンを Azure Functions で本当にそうなのか試してみることにした。</p>

<p><a href="https://camo.qiitausercontent.com/20ece77cb998d7dcad696e5c901c9ffb580fc7fd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35366163353863352d623662652d636330632d633739382d6434646363303365616331362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F56ac58c5-b6be-cc0c-c798-d4dcc03eac16.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=49d4ea50ced9506c40f9569e206eaba9" alt="queue-based-load-leveling-pattern.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/56ac58c5-b6be-cc0c-c798-d4dcc03eac16.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F56ac58c5-b6be-cc0c-c798-d4dcc03eac16.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8792a07becd7b669b6138ed41da03f77 1x" loading="lazy"></a></p>

<p>このパターンは、高負荷の時にパフォーマンス問題を引き起こすケースに使える。例えば、アプリケーションがスケールして、それが一気にデータベースに書き込むようなケースはどう解決するか？という話だ。そこで、Queue を挟むといいですよ。という話になる。じゃあ、実際に、Azure Functions で試してみよう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>HttpTrigger -&gt; AzureFunctions -&gt; CosmosDB
</code></pre></div></div>

<p>という構成と、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>HttpTrigger -&gt; AzureFunctions -&gt; StorageQueue -&gt; QueueTriggger -&gt; Azure Functions -&gt; CosmosDB
</code></pre></div></div>

<p>つまりこんな感じのシンプルなテスト。</p>

<p><a href="https://camo.qiitausercontent.com/e5c2d24a52c062367f262e8e66332581073049f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34336163626562382d333762612d653836362d663932342d3666393364643762333131382e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F43acbeb8-37ba-e866-f924-6f93dd7b3118.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6f7a7485802ff3cc147b772d2ef21cfb" alt="compare.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/43acbeb8-37ba-e866-f924-6f93dd7b3118.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F43acbeb8-37ba-e866-f924-6f93dd7b3118.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a1d6e385a72a3e40fa58bb0c0aa8c2eb 1x" loading="lazy"></a></p>

<p>という構成で、どちらがパフォーマンスが良いかを検証してみよう。このぱたーんにしたがうと当然後者！になりそうである。最初は Consumption プランで試してみた。</p>

<h1>
<span id="前者のほうが何故かパフォーマンスが良いという初回の結果" class="fragment"></span><a href="#%E5%89%8D%E8%80%85%E3%81%AE%E3%81%BB%E3%81%86%E3%81%8C%E4%BD%95%E6%95%85%E3%81%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%8C%E8%89%AF%E3%81%84%E3%81%A8%E3%81%84%E3%81%86%E5%88%9D%E5%9B%9E%E3%81%AE%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>前者のほうが何故かパフォーマンスが良いという初回の結果</h1>

<p>とりあえず 2000　ユーザぐらいの負荷をかけてみる。</p>

<h2>
<span id="ダイレクト" class="fragment"></span><a href="#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>ダイレクト</h2>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="nf">Run</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">req</span><span class="p">,</span> <span class="n">IAsyncCollector</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">outputDocument</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">"DirectWrite Trigged!"</span><span class="p">);</span>
    <span class="c1">// Get request body</span>
    <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="k">await</span> <span class="n">req</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>
    <span class="k">await</span> <span class="n">outputDocument</span><span class="p">.</span><span class="nf">AddAsync</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">req</span><span class="p">.</span><span class="nf">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="s">"Thank your for the message"</span><span class="p">);</span>

<span class="p">}</span>

</code></pre></div></div>

<p><a href="https://camo.qiitausercontent.com/ff1fda23eb65935a78b04442a9dd25894ce429c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66343230383535662d393837322d313332352d666434652d3437376436353031653362352e706e67" target="_blank" rel="nofollow noopener"><img width="628" alt="DirectConsumptionPlan01.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Ff420855f-9872-1325-fd4e-477d6501e3b5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=131a52f718ac740f0cf28ac2a8babfba" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/f420855f-9872-1325-fd4e-477d6501e3b5.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Ff420855f-9872-1325-fd4e-477d6501e3b5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8852138cd67221e3164328475de22217 1x" loading="lazy"></a></p>

<h2>
<span id="queue-を介した結果" class="fragment"></span><a href="#queue-%E3%82%92%E4%BB%8B%E3%81%97%E3%81%9F%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>Queue を介した結果</h2>

<p><a href="https://camo.qiitausercontent.com/c07edea71ed93cad2d17cc6ece723e3f122cb44d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34653032363765342d356465312d363633622d613431382d3064653339393962393436632e706e67" target="_blank" rel="nofollow noopener"><img width="656" alt="InDirectConsumptionPlan01.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4e0267e4-5de1-663b-a418-0de3999b946c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=17e99d90ff6ba7d4151e540eca0a6527" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4e0267e4-5de1-663b-a418-0de3999b946c.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4e0267e4-5de1-663b-a418-0de3999b946c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=995ac0329dc9f705d10a0f5a84096359 1x" loading="lazy"></a></p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="nf">Run</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">req</span><span class="p">,</span> <span class="n">IAsyncCollector</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">outputQueueItem</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">"C# HTTP trigger function processed a request."</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="k">await</span> <span class="n">req</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>
    <span class="n">outputQueueItem</span><span class="p">.</span><span class="nf">AddAsync</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">req</span><span class="p">.</span><span class="nf">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="s">"Thank you for sending messages"</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">string</span> <span class="n">myQueueItem</span><span class="p">,</span><span class="n">IAsyncCollector</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">outputDocument</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"C# Queue trigger function processed: </span><span class="p">{</span><span class="n">myQueueItem</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">outputDocument</span><span class="p">.</span><span class="nf">AddAsync</span><span class="p">(</span><span class="n">myQueueItem</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h2>
<span id="ななんでやねん" class="fragment"></span><a href="#%E3%81%AA%E3%81%AA%E3%82%93%E3%81%A7%E3%82%84%E3%81%AD%E3%82%93"><i class="fa fa-link"></i></a>な、なんでやねん</h2>

<p>というわけで結果をみると、なんでやねんとしか言いようのない結果になった。想定と逆だ。ちなみに、何回か繰り返すと、これは、Queue がとか、ダイレクトがとかではなくて、ダイレクトでもエラー三昧になったり、出力が安定しない。一体何なんだろうと思ったのだが、原因は簡単だった。Consumptionプランは、マイクロビリングと言われるつかっただけの課金でオートスケールする。オートスケールはリクエストのカウントでスケールするようだ。</p>

<ul>
<li><a href="https://docs.microsoft.com/en-gb/azure/azure-functions/functions-scale" rel="nofollow noopener" target="_blank">Azure Functions hosting plans comparison</a></li>
</ul>

<p>つまり、HttpTrigger が大量のデータをさばくためには、スケールアウトしていないといけないが、この負荷テストの設定だと、一気に2000ユーザのアクセスが来るようになっているので、スケールするまえに、リクエストが来すぎてやられている、もしくは、負荷をかけた後だと、スケールアウトがなされた状態だと、それでも負荷に耐えれている（たぶんデータベースのデータ量とかも関係している）という推測を立てた。</p>

<p>説明を読むと、スケールコントローラーがその役割を果たしている様子。</p>

<p><a href="https://camo.qiitausercontent.com/c690f7b7eea2deaecbc7a4e40f0d7e7fdc83b20b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37636636626162362d333739302d383733332d613834332d3935363934356131373436632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F7cf6bab6-3790-8733-a843-956945a1746c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b2656e87d5be1521246b5bfc411391af" alt="central-listener.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7cf6bab6-3790-8733-a843-956945a1746c.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F7cf6bab6-3790-8733-a843-956945a1746c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ecb364203af9237d2bc0cadacc1d88ed 1x" loading="lazy"></a></p>

<p>エラーを見てみるとこんな感じのだったりする。明らかに</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>Host Error: Microsoft.Azure.WebJobs.Script: Host thresholds exceeded: [Connections]. 
Session Id: 2ade43e7040548e49a6d620323e9a863
Timestamp: 2017-11-13T13:55:31.367Z
</code></pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>503 - Service Unavailable
</code></pre></div></div>

<p>だから、たまたまスケールした時にあたっているかということになる。元々、Httpで大量のデータを受け付けるというより、Event Hub や、IoTHub で受け付けるようにするといいのかもしれない。</p>

<ul>
<li><a href="https://blogs.msdn.microsoft.com/appserviceteam/2017/09/19/processing-100000-events-per-second-on-azure-functions/" rel="nofollow noopener" target="_blank">Processing 100,000 Events Per Second on Azure Functions</a></li>
</ul>

<p>上記の方法だとなんと100,000 Event / Sec でもさばけている様子だ。だからきっとHttpTrigger の制約で、それは、Web サイトのアクセスと同じような感じでかんがえるとよいかもしれない。</p>

<p>だから、負荷試験をするときに、この設定では、一気に2000ユーザ同時だが、段階を追ってあげていくと、よいのかもしれない。</p>

<p><a href="https://camo.qiitausercontent.com/4b40fb08c8ceba8b9b7086904d883b230507f537/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65303665653335332d306536642d353061662d343432352d6166663339636333343161612e706e67" target="_blank" rel="nofollow noopener"><img width="361" alt="Step01.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fe06ee353-0e6d-50af-4425-aff39cc341aa.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=74f8a9b91ddceb03b0961a77f76e3ac1" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/e06ee353-0e6d-50af-4425-aff39cc341aa.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fe06ee353-0e6d-50af-4425-aff39cc341aa.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=badde2c76cd1ecc8ea6386459e7814cc 1x" loading="lazy"></a></p>

<p>すると、少しエラーがでているが、Queue を介するほうではしっかりと、大体対応できているのがわかる。やっぱりスケールの原因っぽい。</p>

<p><a href="https://camo.qiitausercontent.com/9808c9ed748efb44bdeee62048413eed599c2b16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30623532643134312d323961342d353334652d663664622d6165636338373834346434632e706e67" target="_blank" rel="nofollow noopener"><img width="617" alt="step02.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F0b52d141-29a4-534e-f6db-aecc87844d4c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b7d40811099e9141664c5a29a06126de" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/0b52d141-29a4-534e-f6db-aecc87844d4c.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F0b52d141-29a4-534e-f6db-aecc87844d4c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=10e0a06610f3d7b67ccc5b1e26b6ec8d 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/97cad082aa01776a998345715e1b31079741603e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34666330383634652d376638642d366133642d343532352d3636616362366432343865352e706e67" target="_blank" rel="nofollow noopener"><img width="889" alt="step03.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4fc0864e-7f8d-6a3d-4525-66acb6d248e5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0c937e0fc1e9bd3229686a9725851a7d" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4fc0864e-7f8d-6a3d-4525-66acb6d248e5.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4fc0864e-7f8d-6a3d-4525-66acb6d248e5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0a777a18c183c382d5c23541da17abef 1x" loading="lazy"></a></p>

<p>Consumption Plan では、オートスケールなので、大量のリクエストをさばきたいときは、EventHub 経由で非同期にするか、ある程度スケールするように温めるかということになる。ただ、このグラフを見ていると、ある程度のところで、サーバーがスケールしているっぽいのがわかる。今度は、8000 ユーザをステップ実行で流してみる。</p>

<p><a href="https://camo.qiitausercontent.com/cbd86da85ddd966d90f96cda1b97e90f77e36a8b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33643734616335372d363931392d356335612d393935332d3037383266323837653161652e706e67" target="_blank" rel="nofollow noopener"><img width="618" alt="800001.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F3d74ac57-6919-5c5a-9953-0782f287e1ae.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a173c20d716a5068a6639bc4ff94fa3d" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/3d74ac57-6919-5c5a-9953-0782f287e1ae.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F3d74ac57-6919-5c5a-9953-0782f287e1ae.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=180944b95346f45c472cceb0ff964a77 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/d62a869b7d0a330d8ec0c99b95cf1dc7409afcd5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61333337626637622d323462312d373635662d656637342d6265383639653263353761352e706e67" target="_blank" rel="nofollow noopener"><img width="896" alt="800002.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fa337bf7b-24b1-765f-ef74-be869e2c57a5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=afce11278a49ea3e66f9674ce28d8f61" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/a337bf7b-24b1-765f-ef74-be869e2c57a5.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fa337bf7b-24b1-765f-ef74-be869e2c57a5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=9286014d442fd87aa83f3c0bf6e64e5b 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/48bf1952175c3830a7cea79f1425482145be6a1c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35303363663764392d303863322d663765332d643061662d3830623163383539386630362e706e67" target="_blank" rel="nofollow noopener"><img width="710" alt="800003.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F503cf7d9-08c2-f7e3-d0af-80b1c8598f06.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5c89531399a061fb54be7f5a38df4e52" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/503cf7d9-08c2-f7e3-d0af-80b1c8598f06.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F503cf7d9-08c2-f7e3-d0af-80b1c8598f06.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b72b5774b000da7b8aaa3cddecebfdad 1x" loading="lazy"></a></p>

<p>途中でスケールしている感じがわかる。スケールが間に合っていない。ただ、耐えき照れていないところは、Consumption plan のサーバーの限界かもしれない。しかし、どんどんスケールしている雰囲気なのは興味深い。やっぱりHttpで高い負荷を受けるときは、AppService Plan を選択するか、もしくは、EventHub/IoTHub で受ける（可能なら）というのが良さげだ。おそらく、Azure Functions の限界ではなく、Consumption Plan の HttpTrigger の限界というべきかもしれない。</p>

<h1>
<span id="app-service-plan-を試す" class="fragment"></span><a href="#app-service-plan-%E3%82%92%E8%A9%A6%E3%81%99"><i class="fa fa-link"></i></a>App Service Plan を試す</h1>

<p>そうすると、このパターンを試すためには、App Service Plan で試すほうがいいかもしれない。そっちのほうが比較がちかくなるだろう。最初から10台のサーバーを並べることにしてみた。1 Core 1.75 GB RAM のプランなので一番しょぼい奴だ。</p>

<h2>
<span id="ダイレクト-1" class="fragment"></span><a href="#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88-1"><i class="fa fa-link"></i></a>ダイレクト</h2>

<p><a href="https://camo.qiitausercontent.com/b0d54ed22e7f731afbb08b526fe71a3b2224e4a3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63346237376532342d643933312d393038332d626132372d3431383362306638323263352e706e67" target="_blank" rel="nofollow noopener"><img width="615" alt="AppDirect01.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fc4b77e24-d931-9083-ba27-4183b0f822c5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=de8d9a1bcb8f50853f1ff95b4508cb9c" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/c4b77e24-d931-9083-ba27-4183b0f822c5.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fc4b77e24-d931-9083-ba27-4183b0f822c5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=2bb122a89d9dcebeeca96fc0dcfc081a 1x" loading="lazy"></a></p>

<p>Internal Server Error 500 で落ちている。</p>

<h2>
<span id="queue-経由" class="fragment"></span><a href="#queue-%E7%B5%8C%E7%94%B1"><i class="fa fa-link"></i></a>Queue 経由</h2>

<p><a href="https://camo.qiitausercontent.com/ead0f72931a0868a9fc217d11eced3df28e9362e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61326232653161362d666162622d343365392d616264642d3739316461613039363835312e706e67" target="_blank" rel="nofollow noopener"><img width="606" alt="AppInDirect01.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fa2b2e1a6-fabb-43e9-abdd-791daa096851.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e0f9d67f57a77d8dc0ddd862e6252a24" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/a2b2e1a6-fabb-43e9-abdd-791daa096851.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fa2b2e1a6-fabb-43e9-abdd-791daa096851.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8f22b5d009df4026c8ed8cb1a821dc0a 1x" loading="lazy"></a></p>

<p>こちらは、1 は、Bad Gateway になっている。</p>

<p>Queue 経由だとほぼエラーが出なくなっている。ダイレクトだと、１０並列で、Cosmosに叩き込むことになるので、エラーになっていると思われる。</p>

<p>ただ気になるのは、リクエスト数の違いだ。なぜ違うんだろう。私がうまく負荷テストをやれていない可能性がある。ただ、サーバーのログを見てもエラーにはなっていないので、Queue 経由のほうが高い負荷に耐えられそうだ。</p>

<p>基本的に高い負荷に耐えてもらおうと思うと、</p>

<ul>
<li>Consumption Plan で事前に負荷をかけて、温める</li>
<li>App Service Plan で、スケールをすでにさせておく</li>
</ul>

<p>後者が特に安定するだろう。App Service Plan はマイクロビリングの意味では意味をなさないかもしれないが、サーバーレスの生産性に注目して、マイクロビリングにこだわらないならいい感じかもしれない。</p>

<h1>
<span id="app-service-plan-で高級サーバーでぶん殴ってみる" class="fragment"></span><a href="#app-service-plan-%E3%81%A7%E9%AB%98%E7%B4%9A%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%A7%E3%81%B6%E3%82%93%E6%AE%B4%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>App Service Plan で高級サーバーでぶん殴ってみる</h1>

<p>折角なのでためしに、高級サーバーで、14 サーバー並列にしてみよう。</p>

<p><a href="https://camo.qiitausercontent.com/14c60db480d2c3a210965a0a1185ebb8f7af8e24/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37336130633439612d313033652d336131342d313238382d3636373433363834383935352e706e67" target="_blank" rel="nofollow noopener"><img width="296" alt="expensiveapp.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F73a0c49a-103e-3a14-1288-667436848955.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3088020446e7d310246f304f97c7e40b" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/73a0c49a-103e-3a14-1288-667436848955.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F73a0c49a-103e-3a14-1288-667436848955.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=68d5125464be10c660e38494df297041 1x" loading="lazy"></a></p>

<h2>
<span id="だめだった" class="fragment"></span><a href="#%E3%81%A0%E3%82%81%E3%81%A0%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>だめだった</h2>

<p>2000 user -&gt; 8000 user まで、段階的に上げてみたがうまくいかず。ネックは違うところにあるかもしれない。</p>

<p><a href="https://camo.qiitausercontent.com/8d4a1cf218e3d0419a0677e2b35c1fb617c1fc25/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34653066653630652d613437382d646434352d366264362d3832356562346535396230382e706e67" target="_blank" rel="nofollow noopener"><img width="681" alt="expensiveapp01.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4e0fe60e-a478-dd45-6bd6-825eb4e59b08.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=09525ed370820508bcf84ea1ad8d3048" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4e0fe60e-a478-dd45-6bd6-825eb4e59b08.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4e0fe60e-a478-dd45-6bd6-825eb4e59b08.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8133e1b63e9cfc517d37998e34a8cefb 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/f1d182c67aa958e9fc4718b4108cbfa207e20f77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65396264343739632d663863662d346130662d313937322d6333613365643562633064332e706e67" target="_blank" rel="nofollow noopener"><img width="892" alt="expensiveapp02.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fe9bd479c-f8cf-4a0f-1972-c3a3ed5bc0d3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9e24d1c6019932667e538b738a214c93" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/e9bd479c-f8cf-4a0f-1972-c3a3ed5bc0d3.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fe9bd479c-f8cf-4a0f-1972-c3a3ed5bc0d3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=86eb7eecddfd1769560d4ddde37f1848 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/1eff2dc01d788f6a4406eac6b967f8a8ca155889/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37386165663231642d313465382d613662352d623233612d3266393032323461306631372e706e67" target="_blank" rel="nofollow noopener"><img width="665" alt="expensiveapp03.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F78aef21d-14e8-a6b5-b23a-2f90224a0f17.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4712866f3308295259404ea25099aabe" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/78aef21d-14e8-a6b5-b23a-2f90224a0f17.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F78aef21d-14e8-a6b5-b23a-2f90224a0f17.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=69077dbe17a3e921ecd7d8bec3ebe275 1x" loading="lazy"></a></p>

<p>残念ながら、Application Insight をセットしていなかったので、Internal Error の内容はわからず。<br>
<a href="https://camo.qiitausercontent.com/e26182371f77f2acf66ca21afa90f7ef1cf7476c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35323862373639362d626536342d663263322d366538642d3737333530346430323865622e706e67" target="_blank" rel="nofollow noopener"><img width="580" alt="expensiveapp04.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F528b7696-be64-f2c2-6e8d-773504d028eb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=aa83e2359379dbb0f3837bf46a525795" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/528b7696-be64-f2c2-6e8d-773504d028eb.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F528b7696-be64-f2c2-6e8d-773504d028eb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6094284e6787c94330f00ce5c6e29b92 1x" loading="lazy"></a></p>

<p>Azure Functions の件数を見ても、エラーはないので、何かサーバーレベルの問題と思われる（ちなみに、件数は、Queue トリガーのほうが少ないので Lost している）<br>
<a href="https://camo.qiitausercontent.com/c3a9fe874f9d2f145e3fc39cf307a1c48ce55e7d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63323164303537662d666663652d333435642d323161382d3034633231353861363334322e706e67" target="_blank" rel="nofollow noopener"><img width="874" alt="expensiveapp05.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fc21d057f-ffce-345d-21a8-04c2158a6342.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ccedb435782cb010f870d0eab3013721" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/c21d057f-ffce-345d-21a8-04c2158a6342.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fc21d057f-ffce-345d-21a8-04c2158a6342.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=c2b70730e40e9ff45d6740908fb80170 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/c161bd5ad8f9b75caa19cabf88dd9b0c0ed11f09/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37373730336438342d393765662d616436382d393537312d6630626437336465373537632e706e67" target="_blank" rel="nofollow noopener"><img width="894" alt="expensiveapp06.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F77703d84-97ef-ad68-9571-f0bd73de757c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=66b0aa8175a0ca98ca517a1cd41a2f12" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/77703d84-97ef-ad68-9571-f0bd73de757c.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F77703d84-97ef-ad68-9571-f0bd73de757c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=60f9fe12aa30f5421d727bf21808867f 1x" loading="lazy"></a></p>

<p>Cosmos 側がねっくなのでは？とも思ったがそうではないようす。400RU のチープなやつだが、一時的に超えても、問題ないようす。</p>

<p><a href="https://camo.qiitausercontent.com/4557dcaad842127361cfead1dba610925811fa99/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f31373230353034632d613334322d636434352d313639352d3262373731613930373266312e706e67" target="_blank" rel="nofollow noopener"><img width="769" alt="expensive07.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F1720504c-a342-cd45-1695-2b771a9072f1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0badeaad9c64593a88f0ed48d5ad42be" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/1720504c-a342-cd45-1695-2b771a9072f1.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F1720504c-a342-cd45-1695-2b771a9072f1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0a07c7ee6b6e848c9290ea72438c79a2 1x" loading="lazy"></a></p>

<h1>
<span id="次回" class="fragment"></span><a href="#%E6%AC%A1%E5%9B%9E"><i class="fa fa-link"></i></a>次回</h1>

<p>まずは、私の Azure Functions と、WebApps のチューニング、負荷試験の知識が足りないとおもわれるので、自分でうんうんうなってないで、人の助けを借りることにしよう。この結果は適切ではない可能性がある。まずは原因調査から。</p>

<p>次は、C#, Node, Durable Functions の比較、App Service Plan でもっといいサーバーを使ってみるとどうなるかとかを試してみよう。</p>

<p>負荷試験ツール（今回はVSTS) もちゃんと調べたほうがよさそう。あまり設定項目無いからこんなもんと思ってたけど一応目を通しておこう。</p>

<h1>
<span id="resource" class="fragment"></span><a href="#resource"><i class="fa fa-link"></i></a>Resource</h1>

<ul>
<li>
<a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling" rel="nofollow noopener" target="_blank">Queue-Based Load Leveling pattern</a> </li>
<li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2Ffbb1d1d06ef2eb932faf&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2Ffbb1d1d06ef2eb932faf&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf/likers" class="css-1iupg5d">14</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">7</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/fbb1d1d06ef2eb932faf/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-8d1d03e8-04b9-42c9-8bf1-bdfd2055ecc8">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-70182362-03f8-4fec-8ebc-6c312cdca99c"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-70182362-03f8-4fec-8ebc-6c312cdca99c">{}</script>
      
<div id="LoginModal-react-component-bfab6792-e278-4939-b001-80883760641f"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-bfab6792-e278-4939-b001-80883760641f">{}</script>
      
<div id="StockModal-react-component-0fbc52f6-e407-4854-81a1-622f614bf302"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-0fbc52f6-e407-4854-81a1-622f614bf302">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;iLUMd/hG4/dmyBcvUpI0OsyPIP1YPU4GXLOW1XQXU19g9uXF/YMejEHmSSJ8HmavaadUKUV9BcJ/enElW2Z17w==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003eCloud のデザインパターンで、\u003ca href=\"https://docs.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling\" rel=\"nofollow noopener\" target=\"_blank\"\u003eQueue-Based Load Leveling pattern\u003c/a\u003e というのがある。Serverless をやっているとアーキテクチャをもっと勉強しとくほうがいいなと思って、少しづつパターンを検証してみようと思っている。ふと思い立って、このパターンを Azure Functions で本当にそうなのか試してみることにした。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/20ece77cb998d7dcad696e5c901c9ffb580fc7fd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35366163353863352d623662652d636330632d633739382d6434646363303365616331362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F56ac58c5-b6be-cc0c-c798-d4dcc03eac16.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=49d4ea50ced9506c40f9569e206eaba9\" alt=\"queue-based-load-leveling-pattern.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/56ac58c5-b6be-cc0c-c798-d4dcc03eac16.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F56ac58c5-b6be-cc0c-c798-d4dcc03eac16.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8792a07becd7b669b6138ed41da03f77 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこのパターンは、高負荷の時にパフォーマンス問題を引き起こすケースに使える。例えば、アプリケーションがスケールして、それが一気にデータベースに書き込むようなケースはどう解決するか？という話だ。そこで、Queue を挟むといいですよ。という話になる。じゃあ、実際に、Azure Functions で試してみよう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eHttpTrigger -\u0026gt; AzureFunctions -\u0026gt; CosmosDB\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eという構成と、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eHttpTrigger -\u0026gt; AzureFunctions -\u0026gt; StorageQueue -\u0026gt; QueueTriggger -\u0026gt; Azure Functions -\u0026gt; CosmosDB\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eつまりこんな感じのシンプルなテスト。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/e5c2d24a52c062367f262e8e66332581073049f4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34336163626562382d333762612d653836362d663932342d3666393364643762333131382e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F43acbeb8-37ba-e866-f924-6f93dd7b3118.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=6f7a7485802ff3cc147b772d2ef21cfb\" alt=\"compare.jpg\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/43acbeb8-37ba-e866-f924-6f93dd7b3118.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F43acbeb8-37ba-e866-f924-6f93dd7b3118.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a1d6e385a72a3e40fa58bb0c0aa8c2eb 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eという構成で、どちらがパフォーマンスが良いかを検証してみよう。このぱたーんにしたがうと当然後者！になりそうである。最初は Consumption プランで試してみた。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"前者のほうが何故かパフォーマンスが良いという初回の結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%89%8D%E8%80%85%E3%81%AE%E3%81%BB%E3%81%86%E3%81%8C%E4%BD%95%E6%95%85%E3%81%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%8C%E8%89%AF%E3%81%84%E3%81%A8%E3%81%84%E3%81%86%E5%88%9D%E5%9B%9E%E3%81%AE%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e前者のほうが何故かパフォーマンスが良いという初回の結果\u003c/h1\u003e\n\n\u003cp\u003eとりあえず 2000　ユーザぐらいの負荷をかけてみる。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ダイレクト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eダイレクト\u003c/h2\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Net\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpResponseMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpRequestMessage\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIAsyncCollector\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputDocument\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTraceWriter\u003c/span\u003e \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"DirectWrite Trigged!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Get request body\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebody\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAsStringAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputDocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebody\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpStatusCode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOK\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Thank your for the message\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ff1fda23eb65935a78b04442a9dd25894ce429c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f66343230383535662d393837322d313332352d666434652d3437376436353031653362352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"628\" alt=\"DirectConsumptionPlan01.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Ff420855f-9872-1325-fd4e-477d6501e3b5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=131a52f718ac740f0cf28ac2a8babfba\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/f420855f-9872-1325-fd4e-477d6501e3b5.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Ff420855f-9872-1325-fd4e-477d6501e3b5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8852138cd67221e3164328475de22217 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"queue-を介した結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#queue-%E3%82%92%E4%BB%8B%E3%81%97%E3%81%9F%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eQueue を介した結果\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/c07edea71ed93cad2d17cc6ece723e3f122cb44d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34653032363765342d356465312d363633622d613431382d3064653339393962393436632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"656\" alt=\"InDirectConsumptionPlan01.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4e0267e4-5de1-663b-a418-0de3999b946c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=17e99d90ff6ba7d4151e540eca0a6527\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/4e0267e4-5de1-663b-a418-0de3999b946c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4e0267e4-5de1-663b-a418-0de3999b946c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=995ac0329dc9f705d10a0f5a84096359 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Net\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpResponseMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpRequestMessage\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIAsyncCollector\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputQueueItem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTraceWriter\u003c/span\u003e \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"C# HTTP trigger function processed a request.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebody\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAsStringAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eoutputQueueItem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebody\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpStatusCode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOK\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Thank you for sending messages\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003emyQueueItem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eIAsyncCollector\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputDocument\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTraceWriter\u003c/span\u003e \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"C# Queue trigger function processed: \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003emyQueueItem\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputDocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emyQueueItem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ななんでやねん\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AA%E3%81%AA%E3%82%93%E3%81%A7%E3%82%84%E3%81%AD%E3%82%93\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eな、なんでやねん\u003c/h2\u003e\n\n\u003cp\u003eというわけで結果をみると、なんでやねんとしか言いようのない結果になった。想定と逆だ。ちなみに、何回か繰り返すと、これは、Queue がとか、ダイレクトがとかではなくて、ダイレクトでもエラー三昧になったり、出力が安定しない。一体何なんだろうと思ったのだが、原因は簡単だった。Consumptionプランは、マイクロビリングと言われるつかっただけの課金でオートスケールする。オートスケールはリクエストのカウントでスケールするようだ。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/en-gb/azure/azure-functions/functions-scale\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAzure Functions hosting plans comparison\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eつまり、HttpTrigger が大量のデータをさばくためには、スケールアウトしていないといけないが、この負荷テストの設定だと、一気に2000ユーザのアクセスが来るようになっているので、スケールするまえに、リクエストが来すぎてやられている、もしくは、負荷をかけた後だと、スケールアウトがなされた状態だと、それでも負荷に耐えれている（たぶんデータベースのデータ量とかも関係している）という推測を立てた。\u003c/p\u003e\n\n\u003cp\u003e説明を読むと、スケールコントローラーがその役割を果たしている様子。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/c690f7b7eea2deaecbc7a4e40f0d7e7fdc83b20b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37636636626162362d333739302d383733332d613834332d3935363934356131373436632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F7cf6bab6-3790-8733-a843-956945a1746c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b2656e87d5be1521246b5bfc411391af\" alt=\"central-listener.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/7cf6bab6-3790-8733-a843-956945a1746c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F7cf6bab6-3790-8733-a843-956945a1746c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=ecb364203af9237d2bc0cadacc1d88ed 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eエラーを見てみるとこんな感じのだったりする。明らかに\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eHost Error: Microsoft.Azure.WebJobs.Script: Host thresholds exceeded: [Connections]. \nSession Id: 2ade43e7040548e49a6d620323e9a863\nTimestamp: 2017-11-13T13:55:31.367Z\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e503 - Service Unavailable\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eだから、たまたまスケールした時にあたっているかということになる。元々、Httpで大量のデータを受け付けるというより、Event Hub や、IoTHub で受け付けるようにするといいのかもしれない。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://blogs.msdn.microsoft.com/appserviceteam/2017/09/19/processing-100000-events-per-second-on-azure-functions/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eProcessing 100,000 Events Per Second on Azure Functions\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e上記の方法だとなんと100,000 Event / Sec でもさばけている様子だ。だからきっとHttpTrigger の制約で、それは、Web サイトのアクセスと同じような感じでかんがえるとよいかもしれない。\u003c/p\u003e\n\n\u003cp\u003eだから、負荷試験をするときに、この設定では、一気に2000ユーザ同時だが、段階を追ってあげていくと、よいのかもしれない。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/4b40fb08c8ceba8b9b7086904d883b230507f537/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65303665653335332d306536642d353061662d343432352d6166663339636333343161612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"361\" alt=\"Step01.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fe06ee353-0e6d-50af-4425-aff39cc341aa.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=74f8a9b91ddceb03b0961a77f76e3ac1\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/e06ee353-0e6d-50af-4425-aff39cc341aa.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fe06ee353-0e6d-50af-4425-aff39cc341aa.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=badde2c76cd1ecc8ea6386459e7814cc 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eすると、少しエラーがでているが、Queue を介するほうではしっかりと、大体対応できているのがわかる。やっぱりスケールの原因っぽい。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/9808c9ed748efb44bdeee62048413eed599c2b16/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f30623532643134312d323961342d353334652d663664622d6165636338373834346434632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"617\" alt=\"step02.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F0b52d141-29a4-534e-f6db-aecc87844d4c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b7d40811099e9141664c5a29a06126de\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/0b52d141-29a4-534e-f6db-aecc87844d4c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F0b52d141-29a4-534e-f6db-aecc87844d4c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=10e0a06610f3d7b67ccc5b1e26b6ec8d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/97cad082aa01776a998345715e1b31079741603e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34666330383634652d376638642d366133642d343532352d3636616362366432343865352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"889\" alt=\"step03.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4fc0864e-7f8d-6a3d-4525-66acb6d248e5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=0c937e0fc1e9bd3229686a9725851a7d\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/4fc0864e-7f8d-6a3d-4525-66acb6d248e5.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4fc0864e-7f8d-6a3d-4525-66acb6d248e5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0a777a18c183c382d5c23541da17abef 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eConsumption Plan では、オートスケールなので、大量のリクエストをさばきたいときは、EventHub 経由で非同期にするか、ある程度スケールするように温めるかということになる。ただ、このグラフを見ていると、ある程度のところで、サーバーがスケールしているっぽいのがわかる。今度は、8000 ユーザをステップ実行で流してみる。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/cbd86da85ddd966d90f96cda1b97e90f77e36a8b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33643734616335372d363931392d356335612d393935332d3037383266323837653161652e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"618\" alt=\"800001.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F3d74ac57-6919-5c5a-9953-0782f287e1ae.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a173c20d716a5068a6639bc4ff94fa3d\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/3d74ac57-6919-5c5a-9953-0782f287e1ae.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F3d74ac57-6919-5c5a-9953-0782f287e1ae.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=180944b95346f45c472cceb0ff964a77 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/d62a869b7d0a330d8ec0c99b95cf1dc7409afcd5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61333337626637622d323462312d373635662d656637342d6265383639653263353761352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"896\" alt=\"800002.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fa337bf7b-24b1-765f-ef74-be869e2c57a5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=afce11278a49ea3e66f9674ce28d8f61\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/a337bf7b-24b1-765f-ef74-be869e2c57a5.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fa337bf7b-24b1-765f-ef74-be869e2c57a5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=9286014d442fd87aa83f3c0bf6e64e5b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/48bf1952175c3830a7cea79f1425482145be6a1c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35303363663764392d303863322d663765332d643061662d3830623163383539386630362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"710\" alt=\"800003.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F503cf7d9-08c2-f7e3-d0af-80b1c8598f06.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5c89531399a061fb54be7f5a38df4e52\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/503cf7d9-08c2-f7e3-d0af-80b1c8598f06.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F503cf7d9-08c2-f7e3-d0af-80b1c8598f06.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b72b5774b000da7b8aaa3cddecebfdad 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e途中でスケールしている感じがわかる。スケールが間に合っていない。ただ、耐えき照れていないところは、Consumption plan のサーバーの限界かもしれない。しかし、どんどんスケールしている雰囲気なのは興味深い。やっぱりHttpで高い負荷を受けるときは、AppService Plan を選択するか、もしくは、EventHub/IoTHub で受ける（可能なら）というのが良さげだ。おそらく、Azure Functions の限界ではなく、Consumption Plan の HttpTrigger の限界というべきかもしれない。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"app-service-plan-を試す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#app-service-plan-%E3%82%92%E8%A9%A6%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eApp Service Plan を試す\u003c/h1\u003e\n\n\u003cp\u003eそうすると、このパターンを試すためには、App Service Plan で試すほうがいいかもしれない。そっちのほうが比較がちかくなるだろう。最初から10台のサーバーを並べることにしてみた。1 Core 1.75 GB RAM のプランなので一番しょぼい奴だ。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ダイレクト-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eダイレクト\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/b0d54ed22e7f731afbb08b526fe71a3b2224e4a3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63346237376532342d643933312d393038332d626132372d3431383362306638323263352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"615\" alt=\"AppDirect01.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fc4b77e24-d931-9083-ba27-4183b0f822c5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=de8d9a1bcb8f50853f1ff95b4508cb9c\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/c4b77e24-d931-9083-ba27-4183b0f822c5.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fc4b77e24-d931-9083-ba27-4183b0f822c5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=2bb122a89d9dcebeeca96fc0dcfc081a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eInternal Server Error 500 で落ちている。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"queue-経由\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#queue-%E7%B5%8C%E7%94%B1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eQueue 経由\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ead0f72931a0868a9fc217d11eced3df28e9362e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f61326232653161362d666162622d343365392d616264642d3739316461613039363835312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"606\" alt=\"AppInDirect01.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fa2b2e1a6-fabb-43e9-abdd-791daa096851.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e0f9d67f57a77d8dc0ddd862e6252a24\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/a2b2e1a6-fabb-43e9-abdd-791daa096851.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fa2b2e1a6-fabb-43e9-abdd-791daa096851.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8f22b5d009df4026c8ed8cb1a821dc0a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこちらは、1 は、Bad Gateway になっている。\u003c/p\u003e\n\n\u003cp\u003eQueue 経由だとほぼエラーが出なくなっている。ダイレクトだと、１０並列で、Cosmosに叩き込むことになるので、エラーになっていると思われる。\u003c/p\u003e\n\n\u003cp\u003eただ気になるのは、リクエスト数の違いだ。なぜ違うんだろう。私がうまく負荷テストをやれていない可能性がある。ただ、サーバーのログを見てもエラーにはなっていないので、Queue 経由のほうが高い負荷に耐えられそうだ。\u003c/p\u003e\n\n\u003cp\u003e基本的に高い負荷に耐えてもらおうと思うと、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eConsumption Plan で事前に負荷をかけて、温める\u003c/li\u003e\n\u003cli\u003eApp Service Plan で、スケールをすでにさせておく\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e後者が特に安定するだろう。App Service Plan はマイクロビリングの意味では意味をなさないかもしれないが、サーバーレスの生産性に注目して、マイクロビリングにこだわらないならいい感じかもしれない。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"app-service-plan-で高級サーバーでぶん殴ってみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#app-service-plan-%E3%81%A7%E9%AB%98%E7%B4%9A%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%A7%E3%81%B6%E3%82%93%E6%AE%B4%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eApp Service Plan で高級サーバーでぶん殴ってみる\u003c/h1\u003e\n\n\u003cp\u003e折角なのでためしに、高級サーバーで、14 サーバー並列にしてみよう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/14c60db480d2c3a210965a0a1185ebb8f7af8e24/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37336130633439612d313033652d336131342d313238382d3636373433363834383935352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"296\" alt=\"expensiveapp.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F73a0c49a-103e-3a14-1288-667436848955.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3088020446e7d310246f304f97c7e40b\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/73a0c49a-103e-3a14-1288-667436848955.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F73a0c49a-103e-3a14-1288-667436848955.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=68d5125464be10c660e38494df297041 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"だめだった\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%A0%E3%82%81%E3%81%A0%E3%81%A3%E3%81%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eだめだった\u003c/h2\u003e\n\n\u003cp\u003e2000 user -\u0026gt; 8000 user まで、段階的に上げてみたがうまくいかず。ネックは違うところにあるかもしれない。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/8d4a1cf218e3d0419a0677e2b35c1fb617c1fc25/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34653066653630652d613437382d646434352d366264362d3832356562346535396230382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"681\" alt=\"expensiveapp01.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4e0fe60e-a478-dd45-6bd6-825eb4e59b08.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=09525ed370820508bcf84ea1ad8d3048\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/4e0fe60e-a478-dd45-6bd6-825eb4e59b08.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4e0fe60e-a478-dd45-6bd6-825eb4e59b08.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8133e1b63e9cfc517d37998e34a8cefb 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f1d182c67aa958e9fc4718b4108cbfa207e20f77/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65396264343739632d663863662d346130662d313937322d6333613365643562633064332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"892\" alt=\"expensiveapp02.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fe9bd479c-f8cf-4a0f-1972-c3a3ed5bc0d3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=9e24d1c6019932667e538b738a214c93\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/e9bd479c-f8cf-4a0f-1972-c3a3ed5bc0d3.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fe9bd479c-f8cf-4a0f-1972-c3a3ed5bc0d3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=86eb7eecddfd1769560d4ddde37f1848 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/1eff2dc01d788f6a4406eac6b967f8a8ca155889/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37386165663231642d313465382d613662352d623233612d3266393032323461306631372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"665\" alt=\"expensiveapp03.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F78aef21d-14e8-a6b5-b23a-2f90224a0f17.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=4712866f3308295259404ea25099aabe\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/78aef21d-14e8-a6b5-b23a-2f90224a0f17.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F78aef21d-14e8-a6b5-b23a-2f90224a0f17.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=69077dbe17a3e921ecd7d8bec3ebe275 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e残念ながら、Application Insight をセットしていなかったので、Internal Error の内容はわからず。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/e26182371f77f2acf66ca21afa90f7ef1cf7476c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35323862373639362d626536342d663263322d366538642d3737333530346430323865622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"580\" alt=\"expensiveapp04.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F528b7696-be64-f2c2-6e8d-773504d028eb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=aa83e2359379dbb0f3837bf46a525795\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/528b7696-be64-f2c2-6e8d-773504d028eb.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F528b7696-be64-f2c2-6e8d-773504d028eb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6094284e6787c94330f00ce5c6e29b92 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eAzure Functions の件数を見ても、エラーはないので、何かサーバーレベルの問題と思われる（ちなみに、件数は、Queue トリガーのほうが少ないので Lost している）\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c3a9fe874f9d2f145e3fc39cf307a1c48ce55e7d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63323164303537662d666663652d333435642d323161382d3034633231353861363334322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"874\" alt=\"expensiveapp05.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fc21d057f-ffce-345d-21a8-04c2158a6342.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ccedb435782cb010f870d0eab3013721\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/c21d057f-ffce-345d-21a8-04c2158a6342.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fc21d057f-ffce-345d-21a8-04c2158a6342.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=c2b70730e40e9ff45d6740908fb80170 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c161bd5ad8f9b75caa19cabf88dd9b0c0ed11f09/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37373730336438342d393765662d616436382d393537312d6630626437336465373537632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"894\" alt=\"expensiveapp06.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F77703d84-97ef-ad68-9571-f0bd73de757c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=66b0aa8175a0ca98ca517a1cd41a2f12\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/77703d84-97ef-ad68-9571-f0bd73de757c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F77703d84-97ef-ad68-9571-f0bd73de757c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=60f9fe12aa30f5421d727bf21808867f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eCosmos 側がねっくなのでは？とも思ったがそうではないようす。400RU のチープなやつだが、一時的に超えても、問題ないようす。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/4557dcaad842127361cfead1dba610925811fa99/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f31373230353034632d613334322d636434352d313639352d3262373731613930373266312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"769\" alt=\"expensive07.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F1720504c-a342-cd45-1695-2b771a9072f1.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=0badeaad9c64593a88f0ed48d5ad42be\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/1720504c-a342-cd45-1695-2b771a9072f1.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F1720504c-a342-cd45-1695-2b771a9072f1.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0a07c7ee6b6e848c9290ea72438c79a2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"次回\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%AC%A1%E5%9B%9E\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e次回\u003c/h1\u003e\n\n\u003cp\u003eまずは、私の Azure Functions と、WebApps のチューニング、負荷試験の知識が足りないとおもわれるので、自分でうんうんうなってないで、人の助けを借りることにしよう。この結果は適切ではない可能性がある。まずは原因調査から。\u003c/p\u003e\n\n\u003cp\u003e次は、C#, Node, Durable Functions の比較、App Service Plan でもっといいサーバーを使ってみるとどうなるかとかを試してみよう。\u003c/p\u003e\n\n\u003cp\u003e負荷試験ツール（今回はVSTS) もちゃんと調べたほうがよさそう。あまり設定項目無いからこんなもんと思ってたけど一応目を通しておこう。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"resource\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#resource\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eResource\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://docs.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling\" rel=\"nofollow noopener\" target=\"_blank\"\u003eQueue-Based Load Leveling pattern\u003c/a\u003e \u003c/li\u003e\n\u003cli\u003e\n\u003c/ul\u003e\n","createdAt":"2017-11-14T17:18:25Z","elapsedYearsFromLastModifiedAt":3,"encryptedId":"cLLBVWfyU+iraHs86hCvc3cl5uJL46AY--zostBEE+pJK3eUFq--wLKlAgJZ2U3/FVG9RHvXKQ==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2017-11-14T17:18:25Z","likesCount":14,"linkUrl":"https://qiita.com/TsuyoshiUshio@github/items/fbb1d1d06ef2eb932faf","organization":null,"originalId":540844,"stockedCount":7,"title":"Azure Functions とパフォーマンスチューニングその１ - Queue-Based Load Leveling pattern","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%89%8D%E8%80%85%E3%81%AE%E3%81%BB%E3%81%86%E3%81%8C%E4%BD%95%E6%95%85%E3%81%8B%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%8C%E8%89%AF%E3%81%84%E3%81%A8%E3%81%84%E3%81%86%E5%88%9D%E5%9B%9E%E3%81%AE%E7%B5%90%E6%9E%9C\"\u003e前者のほうが何故かパフォーマンスが良いという初回の結果\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88\"\u003eダイレクト\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#queue-%E3%82%92%E4%BB%8B%E3%81%97%E3%81%9F%E7%B5%90%E6%9E%9C\"\u003eQueue を介した結果\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AA%E3%81%AA%E3%82%93%E3%81%A7%E3%82%84%E3%81%AD%E3%82%93\"\u003eな、なんでやねん\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#app-service-plan-%E3%82%92%E8%A9%A6%E3%81%99\"\u003eApp Service Plan を試す\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88-1\"\u003eダイレクト\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#queue-%E7%B5%8C%E7%94%B1\"\u003eQueue 経由\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#app-service-plan-%E3%81%A7%E9%AB%98%E7%B4%9A%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%A7%E3%81%B6%E3%82%93%E6%AE%B4%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\"\u003eApp Service Plan で高級サーバーでぶん殴ってみる\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%A0%E3%82%81%E3%81%A0%E3%81%A3%E3%81%9F\"\u003eだめだった\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%AC%A1%E5%9B%9E\"\u003e次回\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#resource\"\u003eResource\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":3258,"uuid":"fbb1d1d06ef2eb932faf","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"gETDwWMqNpKxF4x08cfDdNWJTg==--jlhFg8vbTjWIQJmO--b0saHRsv51iMhHLa9fsN2w==","originalId":3470,"description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","facebookUrl":null,"githubUrl":"https://github.com/TsuyoshiUshio","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"Ushio Tsuyoshi","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=f09fda0ad182a04e6357e901c2c45fb7","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","urlName":"TsuyoshiUshio@github","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"AzureFunctions","urlName":"azurefunctions"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
