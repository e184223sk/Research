Azureメディアサービス v3ではStreamingPathsというエンティティからストリーミングURLのパスが取得できます。この戻り値の仕様が2020年6月に突然変更になり、問題が起きたのでその概要を記載しておきます。6月に問題が起きてすぐ書こうと思っていたのですが、気付いた年末になってしまいました。Azureメディアサービスで配信プロトコルやDRM、あるいはフィルタを指定するときは下記のように指定します。これ以上は記事の本題から外れるため省きます。AMS v2についての記載ですが、下記などが参考になると思います。顧客へのコンテンツ配信 &gt; ストリーミング URL の形式
https://docs.microsoft.com/ja-jp/azure/media-services/previous/media-services-deliver-content-overview#streaming-url-formatsv3についてはあまりいい記事が見つからず、この辺りがストリーミングURLの形式について触れられているところでしょうか・・・Media Services v3 のダイナミック パッケージ &gt; ソース ファイルをデリバリー用に準備するには 
https://docs.microsoft.com/ja-jp/azure/media-services/latest/dynamic-packaging-overview#to-prepare-your-source-files-for-deliveryCENC(CTR)のMPEG-DASHのURLを取得する場合CENC(CTR)のMPEG-DASHのURLを取得する場合PathsはIList&lt;string&gt;なので当然、複数のパスが返ってくる可能性があります。
ただ、この戻り値の仕様が東日本リージョンでいうと2020年6月25日以降、予告なく変わったため大きな問題が起きました。1PathsはIList&lt;string&gt;なので当然、複数のパスが返ってくる可能性があります。従来の仕様ではという状況でした。たとえば、アセット内のファイル構成が上記のような値だった場合、以下1件が返ってきますもし、この例のように2つのismファイルを置いてあった場合は、以下の様に2件のパスが返ってきます。ismファイルを複数置くということはあまり推奨方法ではなく、アセットフィルタを利用してほしいようですが、こういうパターンがあり得るから、PathsはIList型なのかなくらいの認識でした。先ほどと同様にアセット内のファイル構成が上記のような値だった場合、今まで1件だったPathsが2件返ってくるようになりました。同じことがHLSでも発生しています。
このformat=mpd-time-cmafというのはCMAF(Common Media Application Format)対応を意味しています。私もCMAFについての理解が足りないところがありますが、下記の記事など参考になるかもしれません。CMAF と CMAFを使用した低遅延 LIVE 配信の実現
https://blogs.akamai.com/jp/2018/04/cmaf-cmaf-low-lalatency-live.htmlCMAFとは何かというのは置いておいて、これはCMAF対応のHLS, DASHはその形式の再生に対応したプレイヤーでないと再生エラーを起こす場合がありますので、本来は違う配信プロトコルとして明確分けられるべきものです。
また、前述のAMS v3のサンプルコードだと、Pathsプロパティに1つ要素がない前提でSingle()をしていますので、要素が2つになれば前述のサンプルコードはエラーとなってしまいます。SDKやその裏のRES APIの仕様としては、StreamingPolicyStreamingProtocolにDashCmafなど新しい形式として追加するか、StreamingPathクラスに新しいプロパティを追加してCMAFかどうかを判定できるようにするのが良い設計と私は思います。事実、ストリーミングURLのformatの値は違うんですから！これはAzureのサポートに問い合わせて要望は出しましたが、結局のところ実装の改善は行われませんでした。せめて、このレベルの仕様変更は事前に告知されるべきと思いますが、そのアナウンスもなし。
うーん、残念仕様・・・SaaSなので仕様が変わらないとなるとこちらで対応するしかありません。
今の仕様が改善されないとなると、今後もPathsに未知のformatが追加される危険を考慮する必要があります。もしかしてencryptionもサイレントに追加されて複数パターンまとめて返ってきちゃうかもしれないと
しれないと疑心暗鬼にもなります。
結果として、安全を考慮すると、こんなコードになってしまいます。うーん・・・改善求む。Azureでは東日本リージョンと西日本リージョンのアップデートは数日空けて行われるのが通常です。 ↩


