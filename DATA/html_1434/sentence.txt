More than 1 year has passed since last update.テストや環境を汚さないために In-Memory データベースを使用する際に初期データを投入する方法を調べました。データベースコンテキストのOnModelCreatingメソッドにフックすることで初期化します。
OnModelCreatingはデータベースコンテキストが初期化される際に１度だけ呼ばれます。HasDataメソッドの初期化は、Entity Framework CoreによるIDの自動設定 が行われません。
そのため、自分でIDを取得する必要があります。In-Memory データベースを使う設定をします。
いつも通りAddDbContextする際にオプションからUseInMemoryDatabaseメソッドを呼びます。
UseInMemoryDatabaseメソッドの引数のデータベース名は必須みたいです。In-Memory データベースを構築し初期データを投入します。Program.csではまだ DI コンテナが設定前であるため、データベースコンテキストを DI できません。
サービスプロバイダーからインスタンスを取得しEnsureCreatedAsyncメソッドを呼んで DB を作成します。In-Memory データベース内の書籍を全件返すエンドポイント/api/booksを作ってみます。実行しlocalhost:{ポート番号}/api/booksにアクセスします。
In-Memory データベースに初期データが投入され、そのデータを全件取得できることが確認できました。
実行環境は以下の通りです。


