<!DOCTYPE html><html><head><meta charset="utf-8" /><title>UniTask 2.x を使った堅牢な非同期処理への移行ガイド - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/mhama/items/0f2cba4a4a762589fc53" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="gwFJl2e/HISUnoxSecYFnQ3zpiFCCRc49BlFgWy9n7pPKCdrOva35H86eVuEZFY8TWC1Q3A4FbQAeaTIVv67/A==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="UniTask 2.x を使った堅牢な非同期処理への移行ガイド - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WVzVwVkdGemF5QXlMbmdnNDRLUzVMMl80NEdqNDRHZjVhQ0Y1NG1pNDRHcTZaMmU1WkNNNXB5ZjVZZW01NUNHNDRHNDQ0R3U1NmU3NktHTTQ0S3M0NEtrNDRPSiZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1hMDJmZGQyMmQ1MWY3MmY1ZWI3ZTU2ZTE4YTQ1Yzk4YQ&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzFvWVcxaCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTIwNGU2NTUwN2Q4OWJlYWVhMzFiZTQzZjY0YzNmZmMy&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=880bd05bbc7f85176865119dd71cdf28"><meta property="og:description" content="

はじめに

会社でプロジェクトにUniTaskを導入しはじめて数か月ほど経過して、利用した感触や、いろいろなケースの使い方がおぼろげながらまとまってきたのでこちらで紹介することとします。既存のコードはコルーチンやコールバック方式で..."><meta content="https://qiita.com/mhama/items/0f2cba4a4a762589fc53" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity,UniTask" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-4b5182fc-f324-4b71-9182-4edad7581cf0"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fmhama%2Fitems%2F0f2cba4a4a762589fc53">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fmhama%2Fitems%2F0f2cba4a4a762589fc53">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-4b5182fc-f324-4b71-9182-4edad7581cf0">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2021-05-27T21:30:55.000+09:00","dateModified":"2021-07-14T22:19:05.000+09:00","headline":"UniTask 2.x を使った堅牢な非同期処理への移行ガイド","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WVzVwVkdGemF5QXlMbmdnNDRLUzVMMl80NEdqNDRHZjVhQ0Y1NG1pNDRHcTZaMmU1WkNNNXB5ZjVZZW01NUNHNDRHNDQ0R3U1NmU3NktHTTQ0S3M0NEtrNDRPSiZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1hMDJmZGQyMmQ1MWY3MmY1ZWI3ZTU2ZTE4YTQ1Yzk4YQ\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzFvWVcxaCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTIwNGU2NTUwN2Q4OWJlYWVhMzFiZTQzZjY0YzNmZmMy\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=880bd05bbc7f85176865119dd71cdf28","mainEntityOfPage":"https://qiita.com/mhama/items/0f2cba4a4a762589fc53","author":{"@type":"Person","address":null,"email":null,"identifier":"mhama","name":"mhama","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2Fprofile-images%2F1577419526?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1ba291cff910479915e9129a5564612b","url":"https://qiita.com/mhama","description":null,"memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mhama","type":"items","id":"0f2cba4a4a762589fc53"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mhama","type":"items","id":"0f2cba4a4a762589fc53"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mhama","type":"items","id":"0f2cba4a4a762589fc53"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/mhama/items/0f2cba4a4a762589fc53","location":"/mhama/items/0f2cba4a4a762589fc53","scheme":"https","host":"qiita.com","port":null,"pathname":"/mhama/items/0f2cba4a4a762589fc53","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"PK3pNcbG7DuNjQPzPViK5hndESAx2x5Y6MJ/Qdhf6zzwhIfJm49HW2Yp9vrA+tlHWU4CQgPqHNQcop4I4hzPeg==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-991efbe9-0933-4629-9108-08620341994d"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mhama/items/0f2cba4a4a762589fc53/likers" class="css-1iupg5d">34</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">28</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/0f2cba4a4a762589fc53/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mhama/items/0f2cba4a4a762589fc53/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mhama/items/0f2cba4a4a762589fc53/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mhama/items/0f2cba4a4a762589fc53/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mhama/items/0f2cba4a4a762589fc53.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/mhama"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/71421/profile-images/1577419526" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/mhama" class="css-10ougpm">@<!-- -->mhama</a><div class="css-1ay9vb9"><span><meta content="2021-05-27T12:30:55Z"/><time dateTime="2021-07-14T13:19:05Z" class="css-m19uds">updated at 2021-07-14</time></span></div></div></div></div></div><h1 class="css-cgzq40">UniTask 2.x を使った堅牢な非同期処理への移行ガイド</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/unitask" class="css-4czcte">UniTask</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>会社でプロジェクトに<code>UniTask</code>を導入しはじめて数か月ほど経過して、利用した感触や、いろいろなケースの使い方がおぼろげながらまとまってきたのでこちらで紹介することとします。既存のコードはコルーチンやコールバック方式で書かれていたため、そういったコードからの切り替え・相互呼び出しなどが必要になりましたので、そういった点についても紹介します。</p>

<p>常に意識するべき基本的な機能や、既存コードの移行に必要なことを書きますが、応用的な使い方や細かい機能については今回はカバーしません。また、生の<code>Task</code> の利用についても記述しません。</p>

<h2>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h2>

<p>Unityで堅牢な非同期コードを書きたい場合は、UniTaskを使うのが良いです。<br>
導入には一定の知識が必要ですが、この記事でそういった点について紹介します。</p>

<h2>
<span id="用語" class="fragment"></span><a href="#%E7%94%A8%E8%AA%9E"><i class="fa fa-link"></i></a>用語</h2>

<ul>
<li>
<p>コルーチン</p>

<ul>
<li>Unityの機能としてのコルーチン、およびIEnumeratorを返却するメソッドを指します。</li>
</ul>
</li>
<li>
<p>UniTaskメソッド</p>

<ul>
<li>この記事では、<code>async UniTask Abcde() { ... }</code> のような形式の、async指定があり、UniTask または UniTaskVoid を返却するメソッドのことを<code>UniTaskメソッド</code>と呼びます。</li>
<li>UniTaskメソッドを実行するとUniTaskインスタンスを返却しますが、この時点ではメソッド内に記述されている内容を実行していません。UniTaskインスタンスに対して await を実行したり、.Forget() を実行することでメソッド内の処理が非同期的に実行されます。（UniTaskVoidは除く）</li>
</ul>
</li>
<li>
<p>UniTask</p>

<ul>
<li>紛らわしくてすみませんが、複数のケースがあります。

<ul>
<li>UniTaskインスタンス

<ul>
<li>上記のようなUniTaskメソッドが返す非同期処理オブジェクト</li>
</ul>
</li>
<li>UniTaskクラス

<ul>
<li>
<code>class UniTask</code> のこと<br>
</li>
</ul>
</li>
<li>UniTaskライブラリ

<ul>
<li>UniTask機能を提供するライブラリの名前</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<h2>
<span id="unitaskの使いはじめ方" class="fragment"></span><a href="#unitask%E3%81%AE%E4%BD%BF%E3%81%84%E3%81%AF%E3%81%98%E3%82%81%E6%96%B9"><i class="fa fa-link"></i></a>UniTaskの使いはじめ方</h2>

<p>簡単に触れておきます。</p>

<ul>
<li>最低限のUnityバージョン:

<ul>
<li>2018.4.13f1 (Unity2017では利用できません)</li>
</ul>
</li>
<li>インストール方法

<ul>
<li>Unity Package Managerから左上の <code>+</code> のところの <code>Add package from git URL...</code> をクリックし、<code>https://github.com/Cysharp/UniTask.git?path=src/UniTask/Assets/Plugins/UniTask</code> を入力する。</li>
<li><a href="https://camo.qiitausercontent.com/edd556225a2eccc56e0528e826cbba123c67cf4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37313432312f37346162326639362d303861382d633533642d653064342d3463636134636332626462612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2F74ab2f96-08a8-c53d-e0d4-4cca4cc2bdba.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5aff6803de7ba8979880f8665cfe4dd4" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/71421/74ab2f96-08a8-c53d-e0d4-4cca4cc2bdba.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2F74ab2f96-08a8-c53d-e0d4-4cca4cc2bdba.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d3c5456ce5579da3bc757df1fe702e50 1x" loading="lazy"></a></li>
</ul>
</li>
<li>UniTaskを利用するには、各 .cs ファイルの先頭に以下のusingが必要です。（通常はIDEが補完で追加してくれます）System.Threading は、CancellationTokenのために必要です。</li>
</ul>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>  <span class="k">using</span> <span class="nn">Cysharp.Threading.Tasks</span><span class="p">;</span>
  <span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</code></pre></div></div>

<h2>
<span id="主な情報源" class="fragment"></span><a href="#%E4%B8%BB%E3%81%AA%E6%83%85%E5%A0%B1%E6%BA%90"><i class="fa fa-link"></i></a>主な情報源</h2>

<ul>
<li>UniTask公式サイト

<ul>
<li><a href="https://github.com/Cysharp/UniTask" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Cysharp/UniTask</a></li>
<li>簡潔ではありますが、ここのREADMEに大概のことは書いてあり、また情報も新しいので一番先にあたるべきです。</li>
</ul>
</li>
<li>スライド 「UniTaskの使い方2020」（とりすーぷさん） 

<ul>
<li><a href="https://speakerdeck.com/torisoup/unitask2020" class="autolink" rel="nofollow noopener" target="_blank">https://speakerdeck.com/torisoup/unitask2020</a></li>
<li>機能を把握するのに良いです</li>
</ul>
</li>
<li>書籍「UniRx/UniTask完全理解」 （打田恭平著）

<ul>
<li>リファレンスに良いです。</li>
</ul>
</li>
<li>
<p>スライド「Deep Dive async/await in Unity with UniTask(UniRx.Async)」（neueccさん） </p>

<ul>
<li><a href="https://www.slideshare.net/neuecc/deep-dive-asyncawait-in-unity-with-unitaskunirxasync" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/neuecc/deep-dive-asyncawait-in-unity-with-unitaskunirxasync</a></li>
<li>UniTask作者によるUniTask完成前の資料で仕様はやや変化していますが、経緯や仕組みの解説などがあり、参考になります。</li>
</ul>
</li>
<li>
<p>注意点</p>

<ul>
<li>Google検索した場合、2.0より前のUniTaskの記事が表示されがちなので注意されましょう。</li>
</ul>
</li>
</ul>

<h2>
<span id="unitaskとは" class="fragment"></span><a href="#unitask%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>UniTaskとは</h2>

<p>簡単にだけ書きますが、基本的な仕組みとしては、書き方の違いを除けば、UniTask/Task は、コルーチンと極めて似たものです。非同期処理を直列的、手続き的に書くことができます。しかしいくつかの点で仕様が異なっているため、適用できる用途が違ってきます。このあとそのような違いについて書きます。<br>
なお、TaskとUniTaskの違いなどは「Deep Dive async/await in Unity with UniTask(UniRx.Async)」に詳しいです。</p>

<h2>
<span id="unitaskの良いところコルーチンと比較して" class="fragment"></span><a href="#unitask%E3%81%AE%E8%89%AF%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%A8%E6%AF%94%E8%BC%83%E3%81%97%E3%81%A6"><i class="fa fa-link"></i></a>UniTaskの良いところ（コルーチンと比較して）</h2>

<h3>
<span id="値を返せるのが便利" class="fragment"></span><a href="#%E5%80%A4%E3%82%92%E8%BF%94%E3%81%9B%E3%82%8B%E3%81%AE%E3%81%8C%E4%BE%BF%E5%88%A9"><i class="fa fa-link"></i></a>値を返せるのが便利</h3>

<p>コルーチンでは、実行終了後に値を返す良い手法がなく、コールバックが利用されていたと思います。あるいは、IEnumerator.Current を利用して <code>yield return 値;</code> としてからコルーチン終了することで、Currentから値を取り出すような手法もありますが、記述量が多い手法で、見た目にも複雑で、さらに型を制約できないなど問題がありました。UniTaskでは <code>return 値</code> のように、通常のメソッドと同様の記法で値を返すことができ、返り値の型も通常のように制約されます。</p>

<h3>
<span id="例外を伝播できるのが便利" class="fragment"></span><a href="#%E4%BE%8B%E5%A4%96%E3%82%92%E4%BC%9D%E6%92%AD%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%AE%E3%81%8C%E4%BE%BF%E5%88%A9"><i class="fa fa-link"></i></a>例外を伝播できるのが便利</h3>

<p>コルーチンの場合、ネストして実行時に例外を起こすとそのコルーチン内で終了してしまい、呼び出し元のコルーチンには伝播しません（※）。例外を利用したい場合、コルーチンごとにtry~catchを書いたうえで、コールバックによって呼び出し元に伝えるといった手法が通常かと思います。IEnumerator.Currentを利用して呼び出し元に返す手法もありますが、かなり記述量が多くおすすめできません。UniTaskでは、通常のメソッドと同様に呼び出し元に伝播しますので通常のメソッドのように書けます。ただし、注意点があり、キャンセル時に投げられる OperationCanceledException をむやみにキャッチしてしまわないための配慮は必要です。（「例外処理の注意点」の項目参照）</p>

<p>※一度もyieldする前に発生した例外については呼び出し元に伝播するケースがありますが、特殊な条件なので、この挙動に頼ることはできないでしょう。</p>

<h3>
<span id="finally-や-idisposable-による終了処理が正確に実行できる" class="fragment"></span><a href="#finally-%E3%82%84-idisposable-%E3%81%AB%E3%82%88%E3%82%8B%E7%B5%82%E4%BA%86%E5%87%A6%E7%90%86%E3%81%8C%E6%AD%A3%E7%A2%BA%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>finally や IDisposable による終了処理が正確に実行できる</h3>

<p>終了処理が必要なコードがあった場合、コルーチンの場合は、ネスト実行時、前項で書いたように例外が伝播しないためfinallyブロックが動作しませんでした。また、MonoBehaviourが破壊された場合などもその場で停止してしまうために、finallyブロックが呼ばれません。UniTaskではfinallyブロックが必ず呼ばれるので、リソースの開放が必須な場合などに、より安全なプログラムを書くことができます。</p>

<p>また、IDisposable と using ステートメントを利用した場合でも、UniTaskであれば必ずDispose()が呼ばれます。</p>

<p>finally 利用時の例</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">try</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">res</span> <span class="p">=</span> <span class="nf">AllocateSomeResource</span><span class="p">();</span> <span class="c1">// 何らかのリソースを取得</span>
    <span class="k">await</span> <span class="nf">BarTask</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span> <span class="c1">// BarTask内で例外が起こるケースを考える</span>
  <span class="p">}</span>
  <span class="k">finally</span>
  <span class="p">{</span>
    <span class="nf">ReleaseSomeResource</span><span class="p">(</span><span class="n">res</span><span class="p">);</span> <span class="c1">// UniTaskでは、例外時にもここを必ず通るので確実にリソースを開放できる</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>IDisposable 利用時の例</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">res</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FooDisposable</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// FooDisposableはIDisposableを継承しているとする</span>
    <span class="k">await</span> <span class="nf">BarTask</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span> <span class="c1">// BarTask内で例外が起こるケースを考える</span>
  <span class="p">}</span>
  <span class="c1">// 例外発生時、res.Dispose() がUniTaskでは確実に呼ばれる。</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="別スレッドも使えるのが便利" class="fragment"></span><a href="#%E5%88%A5%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%82%E4%BD%BF%E3%81%88%E3%82%8B%E3%81%AE%E3%81%8C%E4%BE%BF%E5%88%A9"><i class="fa fa-link"></i></a>別スレッドも使えるのが便利</h3>

<p>UniTaskは（C#標準のTaskと違って）通常はメインスレッドで動作しますが、await時の指定で実行スレッドを切り替えることができます。<br>
 <code>await UniTask.SwitchToThreadPool()</code> のようにするとそこから別スレッドで動かすことができ、さらに <code>await UniTask.SwitchToMainThread()</code> とすればそこから再度メインスレッドに戻ることができます。非常に簡潔な形で別スレッドを利用できるのが便利です。※ただし、UnityのAPIはほとんどが別スレッドでの動作に対応していないのでご注意ください。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>
<span class="k">public</span> <span class="k">class</span> <span class="nc">FooBehaviour</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
        <span class="n">UniTask</span><span class="p">.</span><span class="nf">Action</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">HogeWorkerAsync</span><span class="p">(</span><span class="m">10000</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"result:"</span> <span class="p">+</span> <span class="n">result</span><span class="p">);</span>
        <span class="p">})();</span>
    <span class="p">}</span>

    <span class="c1">// 別スレッドに仕事をさせる非同期メソッド</span>
    <span class="k">async</span> <span class="n">UniTask</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">HogeWorkerAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// スレッドを切り替える</span>
        <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">SwitchToThreadPool</span><span class="p">();</span>

        <span class="c1">// ここに書いた内容は別スレッドで実行される（Unity APIはほとんど利用できないことに注意）</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">result</span> <span class="p">+=</span> <span class="n">i</span> <span class="p">+</span> <span class="s">"|"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"This is not main thread. thread: </span><span class="p">{</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span> <span class="c1">// Debug.Logは例外的に別スレッドでも実行可能</span>

        <span class="c1">// メインスレッドに戻る</span>
        <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">SwitchToMainThread</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="unitaskのそうでもないところ" class="fragment"></span><a href="#unitask%E3%81%AE%E3%81%9D%E3%81%86%E3%81%A7%E3%82%82%E3%81%AA%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>UniTaskのそうでもないところ</h2>

<h3>
<span id="シンプルで返り値もないケースでのタイプ量がやや多い主にcancellationtokenのため" class="fragment"></span><a href="#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%A7%E8%BF%94%E3%82%8A%E5%80%A4%E3%82%82%E3%81%AA%E3%81%84%E3%82%B1%E3%83%BC%E3%82%B9%E3%81%A7%E3%81%AE%E3%82%BF%E3%82%A4%E3%83%97%E9%87%8F%E3%81%8C%E3%82%84%E3%82%84%E5%A4%9A%E3%81%84%E4%B8%BB%E3%81%ABcancellationtoken%E3%81%AE%E3%81%9F%E3%82%81"><i class="fa fa-link"></i></a>シンプルで返り値もないケースでのタイプ量がやや多い（主にCancellationTokenのため)</h3>

<p>コルーチンではMonoBehaviourが破壊された場合に動作が止まりますが、これをUniTaskで実現するにはCancellationTokenの実装が必要で、このために引数リストが長くなってタイプ量が増えます。コルーチンをUniTaskですべて置き換えることも可能ではありますが、GameObjectがらみのウエイトやアニメーションのようなケースでは、コルーチンで十分なことも比較的多いと思いました。</p>

<p>シンプルなケース（コルーチン）</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="c1">// ちょっと待ってからなにかする (コルーチン）</span>
<span class="n">IEnumerator</span> <span class="nf">FooCoroutine</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitForSeconds</span><span class="p">(</span><span class="m">1.0f</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// 呼び出し時</span>
<span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">FooCoroutine</span><span class="p">());</span>
</code></pre></div></div>

<p>シンプルなケース（UniTask）</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="c1">// ちょっと待ってから何かする (UniTask)</span>
<span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// 呼び出し時</span>
<span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
<span class="nf">FooTask</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
</code></pre></div></div>

<h3>
<span id="コールスタック情報がわかりにくい" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%AB%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E6%83%85%E5%A0%B1%E3%81%8C%E3%82%8F%E3%81%8B%E3%82%8A%E3%81%AB%E3%81%8F%E3%81%84"><i class="fa fa-link"></i></a>コールスタック情報がわかりにくい</h3>

<p>Unityのコンソールのコールスタックを見ても、どこから呼ばれたUniTaskかなどはわかりにくいです。これはコルーチンでも同様のはずですが、UniTaskのほうがコールスタックの数が多くがややこしい感じはします。（本質的ではないですが）</p>

<p>なお、Unity Editor上であれば、Windowメニューから起動できる UniTask Tracker で <code>Enable StackTrace</code> をONにして実行することで、今実行中のUniTaskについて、呼び出し関係のスタックトレースを表示できるようです。</p>

<p><a href="https://camo.qiitausercontent.com/51b0ec2b929f630ce0fdfdbcd46a581a30f3869f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37313432312f36636232666637322d336530612d343661662d363836622d6332353037333230343062322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2F6cb2ff72-3e0a-46af-686b-c250732040b2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2fc97c146e91fdd7196b94d6fb0f46a8" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/71421/6cb2ff72-3e0a-46af-686b-c250732040b2.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2F6cb2ff72-3e0a-46af-686b-c250732040b2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e50d0c4798e90e5291b60c394ca39ff9 1x" loading="lazy"></a></p>

<h2>
<span id="いつunitaskを使うべきか" class="fragment"></span><a href="#%E3%81%84%E3%81%A4unitask%E3%82%92%E4%BD%BF%E3%81%86%E3%81%B9%E3%81%8D%E3%81%8B"><i class="fa fa-link"></i></a>いつUniTaskを使うべきか</h2>

<h3>
<span id="堅牢な非同期実行コードを書きたいとき" class="fragment"></span><a href="#%E5%A0%85%E7%89%A2%E3%81%AA%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%AE%9F%E8%A1%8C%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8D%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>堅牢な非同期実行コードを書きたいとき</h3>

<p>例外が伝播せず、finally や usingステートメント が有効に利用できないコルーチンに比べて、UniTaskを使うと堅牢なコードが書きやすいといえます。コールバック方式と比べても、例外処理などを利用してより簡潔に書けるように思います。</p>

<h3>
<span id="非同期処理の終了時に値を返すようなケース" class="fragment"></span><a href="#%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86%E3%81%AE%E7%B5%82%E4%BA%86%E6%99%82%E3%81%AB%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99%E3%82%88%E3%81%86%E3%81%AA%E3%82%B1%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>非同期処理の終了時に値を返すようなケース</h3>

<p>コルーチンでは書きづらいので、コールバックなどを利用していたと思いますが、そういったケースで直列的に書くことができ、よりシンプルに記述することができます。</p>

<h3>
<span id="monobehaviourが破壊されても処理を続けたいケース" class="fragment"></span><a href="#monobehaviour%E3%81%8C%E7%A0%B4%E5%A3%8A%E3%81%95%E3%82%8C%E3%81%A6%E3%82%82%E5%87%A6%E7%90%86%E3%82%92%E7%B6%9A%E3%81%91%E3%81%9F%E3%81%84%E3%82%B1%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>MonoBehaviourが破壊されても処理を続けたいケース</h3>

<p>コルーチンの場合、StartCoroutineを実行したMonoBehaviourが破壊されたり、GameObjectが非Activeになるとコルーチンの実行が止まります。UniTaskでは、何もしなければMonoBehaviourやGameObjectとかかわりなく動き続けることができ、停止タイミングはCancellationTokenの指定によってコントロールすることができます。</p>

<p>コルーチンでも、ずっと生き続けるGameObjectを利用することで長い寿命は実現できますが、そのようなGameObjectを作成せずに実現することができます。</p>

<h2>
<span id="破壊タイミングの違い" class="fragment"></span><a href="#%E7%A0%B4%E5%A3%8A%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AE%E9%81%95%E3%81%84"><i class="fa fa-link"></i></a>破壊タイミングの違い</h2>

<h3>
<span id="コルーチンの場合" class="fragment"></span><a href="#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>コルーチンの場合</h3>

<p>コルーチンはMonoBehaviour.StartCoroutine() を呼ぶことで起動しますが、このMonoBehaviorの寿命がコルーチンの寿命と直結しています。以下のケースでコルーチンは自動的に停止します。<br>
  * コルーチンを起動したMonoBehaviourが破壊された場合<br>
  * コルーチンを起動したMonoBehaviourのあるGameObjectが非Activeになるか、破壊された場合</p>

<p>ちなみに、MonoBehaviourがdisabledになった場合は、コルーチンは止まらないようです</p>

<p>コルーチンの側からみると、上記の条件が成立すると、yieldしたっきり処理が再開しない、という挙動になります。このため、終了処理の機会はありません。なにかのリソースを使いはじめた後、確実に後処理をしないといけないケースなどでは、使いにくいといえます。</p>

<h3>
<span id="unitaskの場合" class="fragment"></span><a href="#unitask%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>UniTaskの場合</h3>

<p>UniTask は、MonoBeheviour.StartCoroutine() で実行されているわけではないので、MonoBehaviour の寿命とは関係がありません。何もしなければ、途中で停止することはなく、動きつづけるというのがUniTaskの性質になります。</p>

<p>しかし、UIを扱う場合など、MonoBehaviour が破壊された場合は、そのまま動いてほしくないケースが多いと思います。たとえばウエイトした後Textコンポーネントの文字列を書き換えるタスクだった場合、この GameObject が破壊されていれば、実行する意味はないことになりますし、NullReferenceException の発生にもつながります。<br>
このような場合に <code>CancellationToken</code> を利用することで、コルーチンと同様のタイミングでキャンセルしたり、任意のタイミングでキャンセルを行うことができます。</p>

<h2>
<span id="cancellationtokenについて" class="fragment"></span><a href="#cancellationtoken%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>CancellationTokenについて</h2>

<p>CancellationTokenとは何かということですが、「キャンセルしたかどうか」を伝えることができるオブジェクト(実際はstruct)ぐらいに思ってもらえると問題ないと思います。</p>

<p>CancellationTokenを利用して、おおよそコルーチンの場合と同様の破壊タイミングにするには、以下のようなコードにします。ちょっと長くなって書くのが面倒になった、と思うかもしれませんが、これがUniTaskの基本形と考えてもらったほうが良いと思います。</p>

<p>※同等と書きましたが、実際には、GetCancellationTokenOnDestroy() で返されるトークンは、GameObjectが非Active化したときには影響を受けないので、コルーチンの場合とは少し異なります。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">async</span> <span class="n">UniTask</span> <span class="nf">SomeTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 任意の処理。</span>
  <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span> <span class="c1">// await時にはCancellationTokenを渡す</span>
<span class="p">}</span>

<span class="c1">// UniTask呼び出し時</span>
<span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
<span class="nf">SomeTask</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
</code></pre></div></div>

<p>UniTaskの呼び出しがネストする場合は、以下の例のように、引数で得られたtokenを必ず渡していくことが重要です。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">async</span> <span class="n">UniTask</span> <span class="nf">SomeTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 任意の処理。</span>
  <span class="k">await</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">token</span><span class="p">);</span> <span class="c1">// UniTaskからUniTaskのネスト呼び出し。CancellationTokenを渡す。</span>
<span class="p">}</span>

<span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 任意の処理。</span>
  <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span> <span class="c1">// await時にはCancellationTokenを渡す</span>
<span class="p">}</span>

<span class="c1">// UniTask呼び出し時</span>
<span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
<span class="nf">SomeTask</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
</code></pre></div></div>

<h3>
<span id="cancellationtokenでの手動でのキャンセル方法" class="fragment"></span><a href="#cancellationtoken%E3%81%A7%E3%81%AE%E6%89%8B%E5%8B%95%E3%81%A7%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>CancellationTokenでの、手動でのキャンセル方法</h3>

<p>手動でのキャンセル方法は以下のように、CancellationTokenSourceを利用します。<br>
基本的にはUniTaskの呼び出しごとにCancellationTokenSourceごと作りなおすのが良いと思われます。<br>
GetCancellationTokenOnDestroy() と同様の挙動を実現するには、OnDestroy() で Cancel() を呼びます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>
<span class="k">public</span> <span class="k">class</span> <span class="nc">HogeBehaviour</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
  <span class="n">CancellationTokenSource</span> <span class="n">cts</span><span class="p">;</span>

  <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// UniTask呼び出し時</span>
    <span class="kt">var</span> <span class="n">cts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
    <span class="nf">SomeTask</span><span class="p">(</span><span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">SomeTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// 任意の処理。</span>
    <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span> <span class="c1">// await時にはCancellationTokenを渡す</span>
  <span class="p">}</span>

  <span class="k">void</span> <span class="nf">Cancel</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// キャンセル時</span>
    <span class="n">cts</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// 通常は、コルーチンと同様の破壊タイミングを実現するために OnDestroy() でキャンセルを呼んでおく</span>
  <span class="c1">// （GetCancellationTokenOnDestroy()で取得したトークンの場合は不要）</span>
  <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">cts</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
    <span class="n">cts</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span> <span class="c1">// CancellationTokenSourceの後始末が必要</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="キャンセルしないcancellationtokenの渡し方" class="fragment"></span><a href="#%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%81%97%E3%81%AA%E3%81%84cancellationtoken%E3%81%AE%E6%B8%A1%E3%81%97%E6%96%B9"><i class="fa fa-link"></i></a>キャンセルしないCancellationTokenの渡し方</h3>

<p>以下のように、CancellationToken の実体ののかわりに<code>default</code>を渡すと良いです。これは、<code>struct CancellationToken</code> のデフォルト値、つまり <code>new CancellationToken()</code> の値が渡されます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>  <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">SomeTask</span><span class="p">(</span><span class="k">default</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span> <span class="c1">// default を渡す</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">SomeTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>以下でも同じです。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>  <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">SomeTask</span><span class="p">(</span><span class="k">new</span> <span class="nf">CancellationToken</span><span class="p">()).</span><span class="nf">Forget</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">SomeTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>また、CancellationTokenを利用しないケースが考慮されたメソッドを書く場合は、 <code>CancellationToken token = default</code> と、デフォルト値を設定しておけば、トークンを指定せずに実行することができます。もちろんこの場合（トークンの引数を省略した場合）、実行を途中でキャンセルされることがなくなります。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>  <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nf">SomeTask</span><span class="p">().</span><span class="nf">Forget</span><span class="p">();</span> <span class="c1">// CancellationTokenを渡さない。（デフォルト値を利用）</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">SomeTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span> <span class="c1">// 引数のデフォルトを指定しておく</span>
  <span class="p">{</span>
    <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="全部のunitaskメソッドの引数にcancellationtokenをつけるべきか" class="fragment"></span><a href="#%E5%85%A8%E9%83%A8%E3%81%AEunitask%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%BC%95%E6%95%B0%E3%81%ABcancellationtoken%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%8B"><i class="fa fa-link"></i></a>全部のUniTaskメソッドの引数にCancellationTokenをつけるべきか？</h2>

<p>上記で書いたように、CancellationToken は、ネストして呼び出すUniTaskメソッドの呼び出しにも同じトークンをつけることで伝播していくものです。伝播させることで、ネストが深くても、キャンセル時に実行を中止することができます。</p>

<p>一方で、CancellationToken を受け取らない非同期メソッドもありえます。このような非同期メソッドをawaitしたとき、await中にキャンセルのフラグがONになっていても、それに気が付くことはできません。キャンセルしないことで、単に実行時間を消費するだけならさほど大きな問題がないケースもありますが、キャンセル後に実行してはいけない処理があった場合、問題が出ますので、以下のように自前でのキャンセルチェックが必要になります。</p>

<p>自前でのキャンセルチェック</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 任意の処理。</span>
  <span class="k">await</span> <span class="nf">BarTask</span><span class="p">();</span> <span class="c1">// CancellationTokenを受け取らないUniTask</span>

  <span class="c1">// 自前でのキャンセルチェック。キャンセルフラグがONになっていれば例外 (OperationCanceledException) を投げてくれる。</span>
  <span class="n">token</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>

  <span class="c1">// そのほかの処理</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>このように手間が増えるため、<b>UniTaskメソッドでは、通常はできるだけ引数で CancellationToken を受け取れるようにしておき、ほかのUniTaskメソッドからの呼び出しに備える、というのが基本戦略と考えられます。</b></p>

<p>また、キャンセルへの応答が難しいケースで CancellationToken を受け取るべきかは悩ましいところです。しかし、上記のように自前のキャンセル判定をしないですむようにするには CancellationToken に対応しているほうが望ましいので、ほかのUniTaskメソッドから呼び出されることが想定される場合は、やはり CancellationToken を受け取れるようにしておくほうが便利と考えられます。</p>

<h2>
<span id="例外処理の注意点" class="fragment"></span><a href="#%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>例外処理の注意点</h2>

<p>UniTaskでは、通常のメソッドのように try ~ catch で例外処理ができるのが利点、と書きましたが、実は常に考慮すべき点があります。これもキャンセルがらみです。<br>
というのは、キャンセルの処理が <code>OperationCanceledException</code> という例外によって行われることから、適当に Exception 型を指定して try ~ catch などしてしまうと、キャンセルがそこで止まって、呼び出し元に伝播しません。これは通常は望まない挙動ですので、<b>UniTaskメソッド内での try~catch は OperationCanceledException をスルーする必要があり、ほぼ常に以下のようにするのが良い、というか、このようにする必要があります。</b><br>
もちろん、 OperationCanceledException が呼び出し元にきちんと伝播する書き方であれば問題ありません。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">try</span>
  <span class="p">{</span>
    <span class="k">await</span> <span class="nf">BarTask</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="nf">when</span> <span class="p">(!(</span><span class="n">e</span> <span class="k">is</span> <span class="n">OperationCanceledException</span><span class="p">))</span> <span class="c1">// キャンセル時に発行される例外は上位のUniTaskにそのまま伝播させる</span>
  <span class="p">{</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"error: "</span> <span class="p">+</span> <span class="n">e</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="例外はどこへ行くのか" class="fragment"></span><a href="#%E4%BE%8B%E5%A4%96%E3%81%AF%E3%81%A9%E3%81%93%E3%81%B8%E8%A1%8C%E3%81%8F%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>例外はどこへ行くのか</h2>

<p>書いたコードにtry~catch がない場合、UniTask内で発生した例外って結局どこまで遡るのでしょうか？UniTaskメソッドは最初は非asyncのメソッドから呼ばれているので、非asyncのメソッドからさらに上位に伝播するのでしょうか・・・？<br>
実は、<b>Forget()のところで例外をキャッチして、ログに出力するようになっています。</b><br>
ですので、Warningを無視してForget() を書かないと、例外はログに出ずに消えてしまう・・・と考えていましたが、そうでもないケースがあるようなので、恐縮ですが、<b>要調査です。</b></p>

<h2>
<span id="逆引き" class="fragment"></span><a href="#%E9%80%86%E5%BC%95%E3%81%8D"><i class="fa fa-link"></i></a>逆引き</h2>

<h3>
<span id="そもそもunitaskの呼び出し方" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82unitask%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E6%96%B9"><i class="fa fa-link"></i></a>そもそもUniTaskの呼び出し方</h3>

<p>まず最初にUniTaskじゃないところからUniTaskをどう呼び出すか、ということです。</p>

<h4>
<span id="非asyncメソッドから値を返さないunitaskを呼び出す方法" class="fragment"></span><a href="#%E9%9D%9Easync%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8B%E3%82%89%E5%80%A4%E3%82%92%E8%BF%94%E3%81%95%E3%81%AA%E3%81%84unitask%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>非asyncメソッドから値を返さないUniTaskを呼び出す方法</h4>

<p><code>＜UniTaskメソッド名＞().Forget();</code> のように書くことで値を返さないUniTask、あるいは値を返すUniTaskであっても返却値を無視する形で呼び出すことができます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">class</span> <span class="nc">HogeBehaviour</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
  <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
    <span class="nf">FooTask</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">....</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4>
<span id="非asyncメソッドから値を返すunitaskを呼び出す方法" class="fragment"></span><a href="#%E9%9D%9Easync%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8B%E3%82%89%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99unitask%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>非asyncメソッドから値を返すUniTaskを呼び出す方法</h4>

<p>これが実はちょっとややこしいです。なぜなら、普通のメソッドは非同期的に値を受け取らないからです。ですので、値を受けとりたければ以下のように、まず別のUniTaskで結果を受け取ってそこで値をハンドリングする必要があります。</p>

<p>※ 「値を返すUniTask」を変更できない場合について書いています。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">class</span> <span class="nc">HogeBehaviour</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
  <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
    <span class="nf">ReceiveTask</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// 値を受け取るためのUniTask</span>
  <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">ReceiveTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="n">result</span> <span class="p">=</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 値を返すUniTask</span>
  <span class="k">async</span> <span class="n">UniTask</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">....</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>多少簡潔に書く方法もあります。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">class</span> <span class="nc">HogeBehaviour</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
  <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
    <span class="n">UniTask</span><span class="p">.</span><span class="nf">Action</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
    <span class="p">})();</span>
  <span class="p">}</span>

  <span class="c1">// 値を返すUniTask</span>
  <span class="k">async</span> <span class="n">UniTask</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">....</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="返り値がないunitaskの書き方" class="fragment"></span><a href="#%E8%BF%94%E3%82%8A%E5%80%A4%E3%81%8C%E3%81%AA%E3%81%84unitask%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9"><i class="fa fa-link"></i></a>返り値がないUniTaskの書き方</h3>

<p>普通に &lt;&gt; のないUniTaskを書けばよいです。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>  <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">....</span>
  <span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="unitaskvoidとは何か" class="fragment"></span><a href="#unitaskvoid%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B"><i class="fa fa-link"></i></a>UniTaskVoidとは何か</h3>

<p>上記、返り値がないUniTaskと混同しがちなのがUniTaskVoidです。<br>
<b>UniTaskVoidとは、終了を待つ「ことができない」UniTaskです。</b><br>
UniTaskVoidを返すメソッドに対してawaitを書くとシンタックスエラーです。ですので、終了を待つ可能性がほぼ考えられないケースに利用しましょう。<br>
後から処理の終了を待ちたくなることは結構あるので、UniTaskVoidを使いたいケースはそう多くないはずです。処理の終了を待ちたいことがありそうであれば、&lt;&gt; のない <code>UniTask</code> を利用しましょう。<br>
UniTaskVoidの場合、Forget() は実際には何もしないメソッドになっていますが、現状では書かないとWarningが出ます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>  <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">BarTask</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
    <span class="c1">// await FooTask(); とはかけない！！</span>
    <span class="nf">FooTask</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="n">UniTaskVoid</span> <span class="nf">FooTask</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">....</span>
  <span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="start-をunitaskにする方法-unitaskvoid" class="fragment"></span><a href="#start-%E3%82%92unitask%E3%81%AB%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95-unitaskvoid"><i class="fa fa-link"></i></a>Start() をUniTaskにする方法 (UniTaskVoid)</h3>

<p>UniTaskVoidは、.Forget() を呼ばなくても、.Forget() を呼んだのと同じ処理になります。これを利用して、MonoBehaviourの Start() メソッドを非同期メソッドとして書くことが可能です。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>  <span class="k">public</span> <span class="k">class</span> <span class="nc">HogeBehaviour</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
  <span class="p">{</span>
    <span class="k">async</span> <span class="n">UniTaskVoid</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nf">FooAsync</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooAsync</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>※ Start()を <code>async UniTask Start()</code> のように書いた場合に問題があることを予想しましたが、実際にやってみると同様の挙動となったので、違いは不明です。<a href="https://github.com/Cysharp/UniTask" rel="nofollow noopener" target="_blank">公式サイト</a> では Start() には UniTaskVoid の利用が推奨されています。</p>

<h2>
<span id="別の手法とのブリッジについて" class="fragment"></span><a href="#%E5%88%A5%E3%81%AE%E6%89%8B%E6%B3%95%E3%81%A8%E3%81%AE%E3%83%96%E3%83%AA%E3%83%83%E3%82%B8%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>別の手法とのブリッジについて</h2>

<h3>
<span id="unitaskからコルーチンを呼んで待つには" class="fragment"></span><a href="#unitask%E3%81%8B%E3%82%89%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF"><i class="fa fa-link"></i></a>UniTaskからコルーチンを呼んで待つには</h3>

<p>UniTask内のawaitでコルーチンを待つことができます。<code>WithCancellation</code> メソッドを併用することで、CancellationTokenを利用してキャンセル時の処理を行うことができます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>
<span class="k">public</span> <span class="k">class</span> <span class="nc">HogeBehaviour</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
  <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
    <span class="nf">FooAsync</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="n">UniTask</span> <span class="nf">FooAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// UniTask内のawaitでCoroutineを待てる</span>
    <span class="k">await</span> <span class="nf">BarCoroutine</span><span class="p">().</span><span class="nf">WithCancellation</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
    <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">IEnumerator</span> <span class="nf">BarCoroutine</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitForSeconds</span><span class="p">(</span><span class="m">2.0f</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4>
<span id="unitaskからコルーチンを起動した場合のコルーチンの寿命は普通とは異なることに注意" class="fragment"></span><a href="#unitask%E3%81%8B%E3%82%89%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E5%AF%BF%E5%91%BD%E3%81%AF%E6%99%AE%E9%80%9A%E3%81%A8%E3%81%AF%E7%95%B0%E3%81%AA%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AB%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>UniTaskからコルーチンを起動した場合のコルーチンの寿命は、普通とは異なることに注意</h4>

<p>UniTaskから呼ばれたコルーチンは、通常のUnityの処理と異なり、UniTaskが駆動しているため、GameObjectがDestroyされたときに自動的に止まるということはありません。そのような挙動にしたい場合は、GetCancellationTokenOnDestroy() で取得したトークンを渡すなど、CancellationTokenの適切な利用が必要になります。<br>
WithCancellation() を利用してCancellationTokenを渡している場合、キャンセル時には、通常コルーチンと同様に、コルーチン内の <code>yield</code> のところでCoroutineの実行が止まります。</p>

<h3>
<span id="コルーチンからunitaskを呼んで待つには" class="fragment"></span><a href="#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF"><i class="fa fa-link"></i></a>コルーチンからUniTaskを呼んで待つには</h3>

<p>UniTaskには <code>ToCoroutune()</code> というメソッドがあり、これを利用することができます。</p>

<h4>
<span id="コルーチンからunitaskを呼んで待つには-キャッチしたい例外がない場合" class="fragment"></span><a href="#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF-%E3%82%AD%E3%83%A3%E3%83%83%E3%83%81%E3%81%97%E3%81%9F%E3%81%84%E4%BE%8B%E5%A4%96%E3%81%8C%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>コルーチンからUniTaskを呼んで待つには: キャッチしたい例外がない場合</h4>

<p>特にキャッチするべき例外がない場合は、以下のような簡潔な記法も利用できます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">yield</span> <span class="k">return</span> <span class="nf">HogeAsync</span><span class="p">(</span><span class="k">default</span><span class="p">).</span><span class="nf">ToCoroutine</span><span class="p">();</span>
</code></pre></div></div>

<p>ただし、CancellationToken利用時のキャンセル時にはエラーログが出てしまう問題があるようです。ログが出る以外の実害はないですが、キャンセルしないケースで利用するのが良いと思われます。</p>

<h4>
<span id="コルーチンからunitaskを呼んで待つには-例外をキャッチしたい場合" class="fragment"></span><a href="#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF-%E4%BE%8B%E5%A4%96%E3%82%92%E3%82%AD%E3%83%A3%E3%83%83%E3%83%81%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>コルーチンからUniTaskを呼んで待つには: 例外をキャッチしたい場合</h4>

<p>コルーチンには例外を伝播させる方法がありませんので、例外についてはUniTask内で処理する必要があります。このため、現実的には、以下のような形で例外処理するのが良いと思われます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>    <span class="n">IEnumerator</span> <span class="nf">FooCoroutine</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">ToCoroutine</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">HogeAsync</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// キャンセル時の例外対応。Coroutine側で対応が必要ならばここで書く</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// キャンセル以外の例外対応</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"Exception: </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="n">UniTask</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">HogeAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">2000</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
        <span class="k">return</span> <span class="m">5</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="コールバック方式のメソッドからunitaskを呼ぶ方法" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E6%96%B9%E5%BC%8F%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%81%B6%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>コールバック方式のメソッドからUniTaskを呼ぶ方法</h3>

<p>UniTask.Action を利用することで、コールバック方式のメソッドからUniTaskを呼び出すことができます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">UniTaskCallbackSample</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">LoadCB</span><span class="p">(</span><span class="s">"sample"</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"result:"</span> <span class="p">+</span> <span class="n">result</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">// コールバック方式のメソッド</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">LoadCB</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">onResult</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">UniTask</span><span class="p">.</span><span class="nf">Action</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">HogeAsync</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="k">default</span><span class="p">);</span>
            <span class="n">onResult</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
        <span class="p">})();</span>
    <span class="p">}</span>

    <span class="c1">// 呼びたいUniTaskメソッド</span>
    <span class="k">async</span> <span class="n">UniTask</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">HogeAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">2000</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>※この例ではキャンセルしないケースになっています。コールバック側にキャンセル機構がある場合は、<code>CancellationTokenSource</code> を利用しましょう。また、例外が発生する可能性がある場合は例外処理も必要です。</p>

<h3>
<span id="unitaskからコールバック方式のメソッドを呼ぶ方法" class="fragment"></span><a href="#unitask%E3%81%8B%E3%82%89%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E6%96%B9%E5%BC%8F%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%91%BC%E3%81%B6%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>UniTaskからコールバック方式のメソッドを呼ぶ方法</h3>

<p>AutoResetUniTaskCompletionSource を利用することで、コールバック方式のメソッドをUniTaskに変換することができます。成功時に TrySetResult を呼ぶことで結果を返し、待ちを終了させることができます。失敗時には TrySetException で例外を渡すことができます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">UniTaskCallbackSample</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">token</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetCancellationTokenOnDestroy</span><span class="p">();</span>
        <span class="nf">SendGetSceneAsync</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// AutoResetUniTaskCompletionSource を利用する。</span>
    <span class="c1">// これはasync指定がなく、UniTaskを返す「普通のメソッド」。</span>
    <span class="c1">// 直接UniTaskのインスタンスを返しているので、awaitで待つことができる。</span>
    <span class="k">public</span> <span class="n">UniTask</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">SendGetSceneAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">utcs</span> <span class="p">=</span> <span class="n">AutoResetUniTaskCompletionSource</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;.</span><span class="nf">Create</span><span class="p">();</span>
        <span class="nf">HogeCB</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">r</span> <span class="p">=&gt;</span> <span class="n">utcs</span><span class="p">.</span><span class="nf">TrySetResult</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
        <span class="n">token</span><span class="p">.</span><span class="nf">Register</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">utcs</span><span class="p">.</span><span class="nf">TrySetCanceled</span><span class="p">());</span> <span class="c1">// CancellationToken対応</span>
        <span class="k">return</span> <span class="n">utcs</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Action</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">callback</span><span class="p">;</span>

    <span class="c1">// コールバック方式の非同期メソッドの例</span>
    <span class="k">void</span> <span class="nf">HogeCB</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">onResult</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">callback</span> <span class="p">=</span> <span class="n">onResult</span><span class="p">;</span>
        <span class="nf">Invoke</span><span class="p">(</span><span class="s">"AfterWait"</span><span class="p">,</span> <span class="m">3.0f</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">AfterWait</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nf">callback</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>※ <code>AutoResetUniTaskCompletionSource.Create()</code> のかわりに <code>new UniTaskCompletionSource()</code> とする方法でも動作はほぼ変わりませんが、 <code>AutoResetUniTaskCompletionSource.Create()</code> のほうがアロケーションが少ないのでこちらを利用すると良いです。</p>

<h2>
<span id="宣伝" class="fragment"></span><a href="#%E5%AE%A3%E4%BC%9D"><i class="fa fa-link"></i></a>宣伝</h2>

<p>Psychic VR Lab ではUnityエンジニアを募集しています！<br>
<a href="https://www.wantedly.com/projects/603605" class="autolink" rel="nofollow noopener" target="_blank">https://www.wantedly.com/projects/603605</a></p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fmhama%2Fitems%2F0f2cba4a4a762589fc53&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fmhama%2Fitems%2F0f2cba4a4a762589fc53&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mhama/items/0f2cba4a4a762589fc53/likers" class="css-1iupg5d">34</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">28</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/0f2cba4a4a762589fc53/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mhama/items/0f2cba4a4a762589fc53/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mhama/items/0f2cba4a4a762589fc53/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mhama/items/0f2cba4a4a762589fc53/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mhama/items/0f2cba4a4a762589fc53.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-991efbe9-0933-4629-9108-08620341994d">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-a5e2670b-0af0-4813-8798-d082a8c8e74e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-a5e2670b-0af0-4813-8798-d082a8c8e74e">{}</script>
      
<div id="LoginModal-react-component-c520306b-6910-471a-ab9f-74d09fa6ed2a"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-c520306b-6910-471a-ab9f-74d09fa6ed2a">{}</script>
      
<div id="StockModal-react-component-53d3fdd5-85e3-448d-9fa2-c5d119a02035"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-53d3fdd5-85e3-448d-9fa2-c5d119a02035">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;wZaJqc94MCWu/aclgzYN3dh/wn0JI/KuYb1hF5hVybcNv+dVkjGbRUVZUix+lF58mOzRHzsS8CKV3YBeohbt8Q==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch2\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h2\u003e\n\n\u003cp\u003e会社でプロジェクトに\u003ccode\u003eUniTask\u003c/code\u003eを導入しはじめて数か月ほど経過して、利用した感触や、いろいろなケースの使い方がおぼろげながらまとまってきたのでこちらで紹介することとします。既存のコードはコルーチンやコールバック方式で書かれていたため、そういったコードからの切り替え・相互呼び出しなどが必要になりましたので、そういった点についても紹介します。\u003c/p\u003e\n\n\u003cp\u003e常に意識するべき基本的な機能や、既存コードの移行に必要なことを書きますが、応用的な使い方や細かい機能については今回はカバーしません。また、生の\u003ccode\u003eTask\u003c/code\u003e の利用についても記述しません。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"結論\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E8%AB%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結論\u003c/h2\u003e\n\n\u003cp\u003eUnityで堅牢な非同期コードを書きたい場合は、UniTaskを使うのが良いです。\u003cbr\u003e\n導入には一定の知識が必要ですが、この記事でそういった点について紹介します。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"用語\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%94%A8%E8%AA%9E\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e用語\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eコルーチン\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eUnityの機能としてのコルーチン、およびIEnumeratorを返却するメソッドを指します。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUniTaskメソッド\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eこの記事では、\u003ccode\u003easync UniTask Abcde() { ... }\u003c/code\u003e のような形式の、async指定があり、UniTask または UniTaskVoid を返却するメソッドのことを\u003ccode\u003eUniTaskメソッド\u003c/code\u003eと呼びます。\u003c/li\u003e\n\u003cli\u003eUniTaskメソッドを実行するとUniTaskインスタンスを返却しますが、この時点ではメソッド内に記述されている内容を実行していません。UniTaskインスタンスに対して await を実行したり、.Forget() を実行することでメソッド内の処理が非同期的に実行されます。（UniTaskVoidは除く）\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUniTask\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e紛らわしくてすみませんが、複数のケースがあります。\n\n\u003cul\u003e\n\u003cli\u003eUniTaskインスタンス\n\n\u003cul\u003e\n\u003cli\u003e上記のようなUniTaskメソッドが返す非同期処理オブジェクト\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eUniTaskクラス\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eclass UniTask\u003c/code\u003e のこと\u003cbr\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eUniTaskライブラリ\n\n\u003cul\u003e\n\u003cli\u003eUniTask機能を提供するライブラリの名前\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"unitaskの使いはじめ方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unitask%E3%81%AE%E4%BD%BF%E3%81%84%E3%81%AF%E3%81%98%E3%82%81%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUniTaskの使いはじめ方\u003c/h2\u003e\n\n\u003cp\u003e簡単に触れておきます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e最低限のUnityバージョン:\n\n\u003cul\u003e\n\u003cli\u003e2018.4.13f1 (Unity2017では利用できません)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eインストール方法\n\n\u003cul\u003e\n\u003cli\u003eUnity Package Managerから左上の \u003ccode\u003e+\u003c/code\u003e のところの \u003ccode\u003eAdd package from git URL...\u003c/code\u003e をクリックし、\u003ccode\u003ehttps://github.com/Cysharp/UniTask.git?path=src/UniTask/Assets/Plugins/UniTask\u003c/code\u003e を入力する。\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://camo.qiitausercontent.com/edd556225a2eccc56e0528e826cbba123c67cf4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37313432312f37346162326639362d303861382d633533642d653064342d3463636134636332626462612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2F74ab2f96-08a8-c53d-e0d4-4cca4cc2bdba.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5aff6803de7ba8979880f8665cfe4dd4\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/71421/74ab2f96-08a8-c53d-e0d4-4cca4cc2bdba.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2F74ab2f96-08a8-c53d-e0d4-4cca4cc2bdba.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d3c5456ce5579da3bc757df1fe702e50 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eUniTaskを利用するには、各 .cs ファイルの先頭に以下のusingが必要です。（通常はIDEが補完で追加してくれます）System.Threading は、CancellationTokenのために必要です。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eCysharp.Threading.Tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"主な情報源\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%BB%E3%81%AA%E6%83%85%E5%A0%B1%E6%BA%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e主な情報源\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eUniTask公式サイト\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/Cysharp/UniTask\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/Cysharp/UniTask\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e簡潔ではありますが、ここのREADMEに大概のことは書いてあり、また情報も新しいので一番先にあたるべきです。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eスライド 「UniTaskの使い方2020」（とりすーぷさん） \n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://speakerdeck.com/torisoup/unitask2020\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://speakerdeck.com/torisoup/unitask2020\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e機能を把握するのに良いです\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e書籍「UniRx/UniTask完全理解」 （打田恭平著）\n\n\u003cul\u003e\n\u003cli\u003eリファレンスに良いです。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eスライド「Deep Dive async/await in Unity with UniTask(UniRx.Async)」（neueccさん） \u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.slideshare.net/neuecc/deep-dive-asyncawait-in-unity-with-unitaskunirxasync\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.slideshare.net/neuecc/deep-dive-asyncawait-in-unity-with-unitaskunirxasync\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eUniTask作者によるUniTask完成前の資料で仕様はやや変化していますが、経緯や仕組みの解説などがあり、参考になります。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e注意点\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eGoogle検索した場合、2.0より前のUniTaskの記事が表示されがちなので注意されましょう。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"unitaskとは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unitask%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUniTaskとは\u003c/h2\u003e\n\n\u003cp\u003e簡単にだけ書きますが、基本的な仕組みとしては、書き方の違いを除けば、UniTask/Task は、コルーチンと極めて似たものです。非同期処理を直列的、手続き的に書くことができます。しかしいくつかの点で仕様が異なっているため、適用できる用途が違ってきます。このあとそのような違いについて書きます。\u003cbr\u003e\nなお、TaskとUniTaskの違いなどは「Deep Dive async/await in Unity with UniTask(UniRx.Async)」に詳しいです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"unitaskの良いところコルーチンと比較して\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unitask%E3%81%AE%E8%89%AF%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%A8%E6%AF%94%E8%BC%83%E3%81%97%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUniTaskの良いところ（コルーチンと比較して）\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"値を返せるのが便利\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%80%A4%E3%82%92%E8%BF%94%E3%81%9B%E3%82%8B%E3%81%AE%E3%81%8C%E4%BE%BF%E5%88%A9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e値を返せるのが便利\u003c/h3\u003e\n\n\u003cp\u003eコルーチンでは、実行終了後に値を返す良い手法がなく、コールバックが利用されていたと思います。あるいは、IEnumerator.Current を利用して \u003ccode\u003eyield return 値;\u003c/code\u003e としてからコルーチン終了することで、Currentから値を取り出すような手法もありますが、記述量が多い手法で、見た目にも複雑で、さらに型を制約できないなど問題がありました。UniTaskでは \u003ccode\u003ereturn 値\u003c/code\u003e のように、通常のメソッドと同様の記法で値を返すことができ、返り値の型も通常のように制約されます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"例外を伝播できるのが便利\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BE%8B%E5%A4%96%E3%82%92%E4%BC%9D%E6%92%AD%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%AE%E3%81%8C%E4%BE%BF%E5%88%A9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e例外を伝播できるのが便利\u003c/h3\u003e\n\n\u003cp\u003eコルーチンの場合、ネストして実行時に例外を起こすとそのコルーチン内で終了してしまい、呼び出し元のコルーチンには伝播しません（※）。例外を利用したい場合、コルーチンごとにtry~catchを書いたうえで、コールバックによって呼び出し元に伝えるといった手法が通常かと思います。IEnumerator.Currentを利用して呼び出し元に返す手法もありますが、かなり記述量が多くおすすめできません。UniTaskでは、通常のメソッドと同様に呼び出し元に伝播しますので通常のメソッドのように書けます。ただし、注意点があり、キャンセル時に投げられる OperationCanceledException をむやみにキャッチしてしまわないための配慮は必要です。（「例外処理の注意点」の項目参照）\u003c/p\u003e\n\n\u003cp\u003e※一度もyieldする前に発生した例外については呼び出し元に伝播するケースがありますが、特殊な条件なので、この挙動に頼ることはできないでしょう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"finally-や-idisposable-による終了処理が正確に実行できる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#finally-%E3%82%84-idisposable-%E3%81%AB%E3%82%88%E3%82%8B%E7%B5%82%E4%BA%86%E5%87%A6%E7%90%86%E3%81%8C%E6%AD%A3%E7%A2%BA%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%A7%E3%81%8D%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003efinally や IDisposable による終了処理が正確に実行できる\u003c/h3\u003e\n\n\u003cp\u003e終了処理が必要なコードがあった場合、コルーチンの場合は、ネスト実行時、前項で書いたように例外が伝播しないためfinallyブロックが動作しませんでした。また、MonoBehaviourが破壊された場合などもその場で停止してしまうために、finallyブロックが呼ばれません。UniTaskではfinallyブロックが必ず呼ばれるので、リソースの開放が必須な場合などに、より安全なプログラムを書くことができます。\u003c/p\u003e\n\n\u003cp\u003eまた、IDisposable と using ステートメントを利用した場合でも、UniTaskであれば必ずDispose()が呼ばれます。\u003c/p\u003e\n\n\u003cp\u003efinally 利用時の例\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eAllocateSomeResource\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 何らかのリソースを取得\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eBarTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// BarTask内で例外が起こるケースを考える\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efinally\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eReleaseSomeResource\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// UniTaskでは、例外時にもここを必ず通るので確実にリソースを開放できる\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIDisposable 利用時の例\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eusing\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooDisposable\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c1\"\u003e// FooDisposableはIDisposableを継承しているとする\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eBarTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// BarTask内で例外が起こるケースを考える\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 例外発生時、res.Dispose() がUniTaskでは確実に呼ばれる。\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"別スレッドも使えるのが便利\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%A5%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%82%E4%BD%BF%E3%81%88%E3%82%8B%E3%81%AE%E3%81%8C%E4%BE%BF%E5%88%A9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e別スレッドも使えるのが便利\u003c/h3\u003e\n\n\u003cp\u003eUniTaskは（C#標準のTaskと違って）通常はメインスレッドで動作しますが、await時の指定で実行スレッドを切り替えることができます。\u003cbr\u003e\n \u003ccode\u003eawait UniTask.SwitchToThreadPool()\u003c/code\u003e のようにするとそこから別スレッドで動かすことができ、さらに \u003ccode\u003eawait UniTask.SwitchToMainThread()\u003c/code\u003e とすればそこから再度メインスレッドに戻ることができます。非常に簡潔な形で別スレッドを利用できるのが便利です。※ただし、UnityのAPIはほとんどが別スレッドでの動作に対応していないのでご注意ください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFooBehaviour\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eHogeWorkerAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e10000\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"result:\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e})();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 別スレッドに仕事をさせる非同期メソッド\u003c/span\u003e\n    \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eHogeWorkerAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// スレッドを切り替える\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSwitchToThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// ここに書いた内容は別スレッドで実行される（Unity APIはほとんど利用できないことに注意）\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\"|\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"This is not main thread. thread: \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// Debug.Logは例外的に別スレッドでも実行可能\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// メインスレッドに戻る\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSwitchToMainThread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"unitaskのそうでもないところ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unitask%E3%81%AE%E3%81%9D%E3%81%86%E3%81%A7%E3%82%82%E3%81%AA%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUniTaskのそうでもないところ\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"シンプルで返り値もないケースでのタイプ量がやや多い主にcancellationtokenのため\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%A7%E8%BF%94%E3%82%8A%E5%80%A4%E3%82%82%E3%81%AA%E3%81%84%E3%82%B1%E3%83%BC%E3%82%B9%E3%81%A7%E3%81%AE%E3%82%BF%E3%82%A4%E3%83%97%E9%87%8F%E3%81%8C%E3%82%84%E3%82%84%E5%A4%9A%E3%81%84%E4%B8%BB%E3%81%ABcancellationtoken%E3%81%AE%E3%81%9F%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eシンプルで返り値もないケースでのタイプ量がやや多い（主にCancellationTokenのため)\u003c/h3\u003e\n\n\u003cp\u003eコルーチンではMonoBehaviourが破壊された場合に動作が止まりますが、これをUniTaskで実現するにはCancellationTokenの実装が必要で、このために引数リストが長くなってタイプ量が増えます。コルーチンをUniTaskですべて置き換えることも可能ではありますが、GameObjectがらみのウエイトやアニメーションのようなケースでは、コルーチンで十分なことも比較的多いと思いました。\u003c/p\u003e\n\n\u003cp\u003eシンプルなケース（コルーチン）\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// ちょっと待ってからなにかする (コルーチン）\u003c/span\u003e\n\u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eWaitForSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 呼び出し時\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eStartCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eFooCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eシンプルなケース（UniTask）\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// ちょっと待ってから何かする (UniTask)\u003c/span\u003e\n\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 呼び出し時\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"コールスタック情報がわかりにくい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%AB%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E6%83%85%E5%A0%B1%E3%81%8C%E3%82%8F%E3%81%8B%E3%82%8A%E3%81%AB%E3%81%8F%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコールスタック情報がわかりにくい\u003c/h3\u003e\n\n\u003cp\u003eUnityのコンソールのコールスタックを見ても、どこから呼ばれたUniTaskかなどはわかりにくいです。これはコルーチンでも同様のはずですが、UniTaskのほうがコールスタックの数が多くがややこしい感じはします。（本質的ではないですが）\u003c/p\u003e\n\n\u003cp\u003eなお、Unity Editor上であれば、Windowメニューから起動できる UniTask Tracker で \u003ccode\u003eEnable StackTrace\u003c/code\u003e をONにして実行することで、今実行中のUniTaskについて、呼び出し関係のスタックトレースを表示できるようです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/51b0ec2b929f630ce0fdfdbcd46a581a30f3869f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37313432312f36636232666637322d336530612d343661662d363836622d6332353037333230343062322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2F6cb2ff72-3e0a-46af-686b-c250732040b2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2fc97c146e91fdd7196b94d6fb0f46a8\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/71421/6cb2ff72-3e0a-46af-686b-c250732040b2.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2F6cb2ff72-3e0a-46af-686b-c250732040b2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e50d0c4798e90e5291b60c394ca39ff9 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"いつunitaskを使うべきか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%84%E3%81%A4unitask%E3%82%92%E4%BD%BF%E3%81%86%E3%81%B9%E3%81%8D%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eいつUniTaskを使うべきか\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"堅牢な非同期実行コードを書きたいとき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A0%85%E7%89%A2%E3%81%AA%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%AE%9F%E8%A1%8C%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8D%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e堅牢な非同期実行コードを書きたいとき\u003c/h3\u003e\n\n\u003cp\u003e例外が伝播せず、finally や usingステートメント が有効に利用できないコルーチンに比べて、UniTaskを使うと堅牢なコードが書きやすいといえます。コールバック方式と比べても、例外処理などを利用してより簡潔に書けるように思います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"非同期処理の終了時に値を返すようなケース\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86%E3%81%AE%E7%B5%82%E4%BA%86%E6%99%82%E3%81%AB%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99%E3%82%88%E3%81%86%E3%81%AA%E3%82%B1%E3%83%BC%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e非同期処理の終了時に値を返すようなケース\u003c/h3\u003e\n\n\u003cp\u003eコルーチンでは書きづらいので、コールバックなどを利用していたと思いますが、そういったケースで直列的に書くことができ、よりシンプルに記述することができます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"monobehaviourが破壊されても処理を続けたいケース\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#monobehaviour%E3%81%8C%E7%A0%B4%E5%A3%8A%E3%81%95%E3%82%8C%E3%81%A6%E3%82%82%E5%87%A6%E7%90%86%E3%82%92%E7%B6%9A%E3%81%91%E3%81%9F%E3%81%84%E3%82%B1%E3%83%BC%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eMonoBehaviourが破壊されても処理を続けたいケース\u003c/h3\u003e\n\n\u003cp\u003eコルーチンの場合、StartCoroutineを実行したMonoBehaviourが破壊されたり、GameObjectが非Activeになるとコルーチンの実行が止まります。UniTaskでは、何もしなければMonoBehaviourやGameObjectとかかわりなく動き続けることができ、停止タイミングはCancellationTokenの指定によってコントロールすることができます。\u003c/p\u003e\n\n\u003cp\u003eコルーチンでも、ずっと生き続けるGameObjectを利用することで長い寿命は実現できますが、そのようなGameObjectを作成せずに実現することができます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"破壊タイミングの違い\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%A0%B4%E5%A3%8A%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AE%E9%81%95%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e破壊タイミングの違い\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"コルーチンの場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコルーチンの場合\u003c/h3\u003e\n\n\u003cp\u003eコルーチンはMonoBehaviour.StartCoroutine() を呼ぶことで起動しますが、このMonoBehaviorの寿命がコルーチンの寿命と直結しています。以下のケースでコルーチンは自動的に停止します。\u003cbr\u003e\n  * コルーチンを起動したMonoBehaviourが破壊された場合\u003cbr\u003e\n  * コルーチンを起動したMonoBehaviourのあるGameObjectが非Activeになるか、破壊された場合\u003c/p\u003e\n\n\u003cp\u003eちなみに、MonoBehaviourがdisabledになった場合は、コルーチンは止まらないようです\u003c/p\u003e\n\n\u003cp\u003eコルーチンの側からみると、上記の条件が成立すると、yieldしたっきり処理が再開しない、という挙動になります。このため、終了処理の機会はありません。なにかのリソースを使いはじめた後、確実に後処理をしないといけないケースなどでは、使いにくいといえます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"unitaskの場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unitask%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUniTaskの場合\u003c/h3\u003e\n\n\u003cp\u003eUniTask は、MonoBeheviour.StartCoroutine() で実行されているわけではないので、MonoBehaviour の寿命とは関係がありません。何もしなければ、途中で停止することはなく、動きつづけるというのがUniTaskの性質になります。\u003c/p\u003e\n\n\u003cp\u003eしかし、UIを扱う場合など、MonoBehaviour が破壊された場合は、そのまま動いてほしくないケースが多いと思います。たとえばウエイトした後Textコンポーネントの文字列を書き換えるタスクだった場合、この GameObject が破壊されていれば、実行する意味はないことになりますし、NullReferenceException の発生にもつながります。\u003cbr\u003e\nこのような場合に \u003ccode\u003eCancellationToken\u003c/code\u003e を利用することで、コルーチンと同様のタイミングでキャンセルしたり、任意のタイミングでキャンセルを行うことができます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"cancellationtokenについて\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#cancellationtoken%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCancellationTokenについて\u003c/h2\u003e\n\n\u003cp\u003eCancellationTokenとは何かということですが、「キャンセルしたかどうか」を伝えることができるオブジェクト(実際はstruct)ぐらいに思ってもらえると問題ないと思います。\u003c/p\u003e\n\n\u003cp\u003eCancellationTokenを利用して、おおよそコルーチンの場合と同様の破壊タイミングにするには、以下のようなコードにします。ちょっと長くなって書くのが面倒になった、と思うかもしれませんが、これがUniTaskの基本形と考えてもらったほうが良いと思います。\u003c/p\u003e\n\n\u003cp\u003e※同等と書きましたが、実際には、GetCancellationTokenOnDestroy() で返されるトークンは、GameObjectが非Active化したときには影響を受けないので、コルーチンの場合とは少し異なります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 任意の処理。\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// await時にはCancellationTokenを渡す\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// UniTask呼び出し時\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eUniTaskの呼び出しがネストする場合は、以下の例のように、引数で得られたtokenを必ず渡していくことが重要です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 任意の処理。\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// UniTaskからUniTaskのネスト呼び出し。CancellationTokenを渡す。\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 任意の処理。\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// await時にはCancellationTokenを渡す\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// UniTask呼び出し時\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"cancellationtokenでの手動でのキャンセル方法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#cancellationtoken%E3%81%A7%E3%81%AE%E6%89%8B%E5%8B%95%E3%81%A7%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E6%96%B9%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCancellationTokenでの、手動でのキャンセル方法\u003c/h3\u003e\n\n\u003cp\u003e手動でのキャンセル方法は以下のように、CancellationTokenSourceを利用します。\u003cbr\u003e\n基本的にはUniTaskの呼び出しごとにCancellationTokenSourceごと作りなおすのが良いと思われます。\u003cbr\u003e\nGetCancellationTokenOnDestroy() と同様の挙動を実現するには、OnDestroy() で Cancel() を呼びます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHogeBehaviour\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eCancellationTokenSource\u003c/span\u003e \u003cspan class=\"n\"\u003ects\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// UniTask呼び出し時\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ects\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ects\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 任意の処理。\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// await時にはCancellationTokenを渡す\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eCancel\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// キャンセル時\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ects\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCancel\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// 通常は、コルーチンと同様の破壊タイミングを実現するために OnDestroy() でキャンセルを呼んでおく\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// （GetCancellationTokenOnDestroy()で取得したトークンの場合は不要）\u003c/span\u003e\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ects\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCancel\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ects\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// CancellationTokenSourceの後始末が必要\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"キャンセルしないcancellationtokenの渡し方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%81%97%E3%81%AA%E3%81%84cancellationtoken%E3%81%AE%E6%B8%A1%E3%81%97%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eキャンセルしないCancellationTokenの渡し方\u003c/h3\u003e\n\n\u003cp\u003e以下のように、CancellationToken の実体ののかわりに\u003ccode\u003edefault\u003c/code\u003eを渡すと良いです。これは、\u003ccode\u003estruct CancellationToken\u003c/code\u003e のデフォルト値、つまり \u003ccode\u003enew CancellationToken()\u003c/code\u003e の値が渡されます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// default を渡す\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e以下でも同じです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e()).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまた、CancellationTokenを利用しないケースが考慮されたメソッドを書く場合は、 \u003ccode\u003eCancellationToken token = default\u003c/code\u003e と、デフォルト値を設定しておけば、トークンを指定せずに実行することができます。もちろんこの場合（トークンの引数を省略した場合）、実行を途中でキャンセルされることがなくなります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// CancellationTokenを渡さない。（デフォルト値を利用）\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eSomeTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 引数のデフォルトを指定しておく\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"全部のunitaskメソッドの引数にcancellationtokenをつけるべきか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%85%A8%E9%83%A8%E3%81%AEunitask%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%BC%95%E6%95%B0%E3%81%ABcancellationtoken%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e全部のUniTaskメソッドの引数にCancellationTokenをつけるべきか？\u003c/h2\u003e\n\n\u003cp\u003e上記で書いたように、CancellationToken は、ネストして呼び出すUniTaskメソッドの呼び出しにも同じトークンをつけることで伝播していくものです。伝播させることで、ネストが深くても、キャンセル時に実行を中止することができます。\u003c/p\u003e\n\n\u003cp\u003e一方で、CancellationToken を受け取らない非同期メソッドもありえます。このような非同期メソッドをawaitしたとき、await中にキャンセルのフラグがONになっていても、それに気が付くことはできません。キャンセルしないことで、単に実行時間を消費するだけならさほど大きな問題がないケースもありますが、キャンセル後に実行してはいけない処理があった場合、問題が出ますので、以下のように自前でのキャンセルチェックが必要になります。\u003c/p\u003e\n\n\u003cp\u003e自前でのキャンセルチェック\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 任意の処理。\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eBarTask\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// CancellationTokenを受け取らないUniTask\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// 自前でのキャンセルチェック。キャンセルフラグがONになっていれば例外 (OperationCanceledException) を投げてくれる。\u003c/span\u003e\n  \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eThrowIfCancellationRequested\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// そのほかの処理\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのように手間が増えるため、\u003cb\u003eUniTaskメソッドでは、通常はできるだけ引数で CancellationToken を受け取れるようにしておき、ほかのUniTaskメソッドからの呼び出しに備える、というのが基本戦略と考えられます。\u003c/b\u003e\u003c/p\u003e\n\n\u003cp\u003eまた、キャンセルへの応答が難しいケースで CancellationToken を受け取るべきかは悩ましいところです。しかし、上記のように自前のキャンセル判定をしないですむようにするには CancellationToken に対応しているほうが望ましいので、ほかのUniTaskメソッドから呼び出されることが想定される場合は、やはり CancellationToken を受け取れるようにしておくほうが便利と考えられます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"例外処理の注意点\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e例外処理の注意点\u003c/h2\u003e\n\n\u003cp\u003eUniTaskでは、通常のメソッドのように try ~ catch で例外処理ができるのが利点、と書きましたが、実は常に考慮すべき点があります。これもキャンセルがらみです。\u003cbr\u003e\nというのは、キャンセルの処理が \u003ccode\u003eOperationCanceledException\u003c/code\u003e という例外によって行われることから、適当に Exception 型を指定して try ~ catch などしてしまうと、キャンセルがそこで止まって、呼び出し元に伝播しません。これは通常は望まない挙動ですので、\u003cb\u003eUniTaskメソッド内での try~catch は OperationCanceledException をスルーする必要があり、ほぼ常に以下のようにするのが良い、というか、このようにする必要があります。\u003c/b\u003e\u003cbr\u003e\nもちろん、 OperationCanceledException が呼び出し元にきちんと伝播する書き方であれば問題ありません。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eBarTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(!(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eOperationCanceledException\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"c1\"\u003e// キャンセル時に発行される例外は上位のUniTaskにそのまま伝播させる\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"error: \"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"例外はどこへ行くのか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BE%8B%E5%A4%96%E3%81%AF%E3%81%A9%E3%81%93%E3%81%B8%E8%A1%8C%E3%81%8F%E3%81%AE%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e例外はどこへ行くのか\u003c/h2\u003e\n\n\u003cp\u003e書いたコードにtry~catch がない場合、UniTask内で発生した例外って結局どこまで遡るのでしょうか？UniTaskメソッドは最初は非asyncのメソッドから呼ばれているので、非asyncのメソッドからさらに上位に伝播するのでしょうか・・・？\u003cbr\u003e\n実は、\u003cb\u003eForget()のところで例外をキャッチして、ログに出力するようになっています。\u003c/b\u003e\u003cbr\u003e\nですので、Warningを無視してForget() を書かないと、例外はログに出ずに消えてしまう・・・と考えていましたが、そうでもないケースがあるようなので、恐縮ですが、\u003cb\u003e要調査です。\u003c/b\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"逆引き\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%80%86%E5%BC%95%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e逆引き\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"そもそもunitaskの呼び出し方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82unitask%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eそもそもUniTaskの呼び出し方\u003c/h3\u003e\n\n\u003cp\u003eまず最初にUniTaskじゃないところからUniTaskをどう呼び出すか、ということです。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"非asyncメソッドから値を返さないunitaskを呼び出す方法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9D%9Easync%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8B%E3%82%89%E5%80%A4%E3%82%92%E8%BF%94%E3%81%95%E3%81%AA%E3%81%84unitask%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E6%96%B9%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e非asyncメソッドから値を返さないUniTaskを呼び出す方法\u003c/h4\u003e\n\n\u003cp\u003e\u003ccode\u003e＜UniTaskメソッド名＞().Forget();\u003c/code\u003e のように書くことで値を返さないUniTask、あるいは値を返すUniTaskであっても返却値を無視する形で呼び出すことができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHogeBehaviour\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e....\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"非asyncメソッドから値を返すunitaskを呼び出す方法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9D%9Easync%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8B%E3%82%89%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99unitask%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E6%96%B9%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e非asyncメソッドから値を返すUniTaskを呼び出す方法\u003c/h4\u003e\n\n\u003cp\u003eこれが実はちょっとややこしいです。なぜなら、普通のメソッドは非同期的に値を受け取らないからです。ですので、値を受けとりたければ以下のように、まず別のUniTaskで結果を受け取ってそこで値をハンドリングする必要があります。\u003c/p\u003e\n\n\u003cp\u003e※ 「値を返すUniTask」を変更できない場合について書いています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHogeBehaviour\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eReceiveTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// 値を受け取るためのUniTask\u003c/span\u003e\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eReceiveTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// 値を返すUniTask\u003c/span\u003e\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e....\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e多少簡潔に書く方法もあります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHogeBehaviour\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e})();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// 値を返すUniTask\u003c/span\u003e\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e....\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"返り値がないunitaskの書き方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%BF%94%E3%82%8A%E5%80%A4%E3%81%8C%E3%81%AA%E3%81%84unitask%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e返り値がないUniTaskの書き方\u003c/h3\u003e\n\n\u003cp\u003e普通に \u0026lt;\u0026gt; のないUniTaskを書けばよいです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e....\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"unitaskvoidとは何か\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unitaskvoid%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUniTaskVoidとは何か\u003c/h3\u003e\n\n\u003cp\u003e上記、返り値がないUniTaskと混同しがちなのがUniTaskVoidです。\u003cbr\u003e\n\u003cb\u003eUniTaskVoidとは、終了を待つ「ことができない」UniTaskです。\u003c/b\u003e\u003cbr\u003e\nUniTaskVoidを返すメソッドに対してawaitを書くとシンタックスエラーです。ですので、終了を待つ可能性がほぼ考えられないケースに利用しましょう。\u003cbr\u003e\n後から処理の終了を待ちたくなることは結構あるので、UniTaskVoidを使いたいケースはそう多くないはずです。処理の終了を待ちたいことがありそうであれば、\u0026lt;\u0026gt; のない \u003ccode\u003eUniTask\u003c/code\u003e を利用しましょう。\u003cbr\u003e\nUniTaskVoidの場合、Forget() は実際には何もしないメソッドになっていますが、現状では書かないとWarningが出ます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eBarTask\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// await FooTask(); とはかけない！！\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTaskVoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e....\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"start-をunitaskにする方法-unitaskvoid\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#start-%E3%82%92unitask%E3%81%AB%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95-unitaskvoid\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStart() をUniTaskにする方法 (UniTaskVoid)\u003c/h3\u003e\n\n\u003cp\u003eUniTaskVoidは、.Forget() を呼ばなくても、.Forget() を呼んだのと同じ処理になります。これを利用して、MonoBehaviourの Start() メソッドを非同期メソッドとして書くことが可能です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHogeBehaviour\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTaskVoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e※ Start()を \u003ccode\u003easync UniTask Start()\u003c/code\u003e のように書いた場合に問題があることを予想しましたが、実際にやってみると同様の挙動となったので、違いは不明です。\u003ca href=\"https://github.com/Cysharp/UniTask\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式サイト\u003c/a\u003e では Start() には UniTaskVoid の利用が推奨されています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"別の手法とのブリッジについて\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%A5%E3%81%AE%E6%89%8B%E6%B3%95%E3%81%A8%E3%81%AE%E3%83%96%E3%83%AA%E3%83%83%E3%82%B8%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e別の手法とのブリッジについて\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"unitaskからコルーチンを呼んで待つには\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unitask%E3%81%8B%E3%82%89%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUniTaskからコルーチンを呼んで待つには\u003c/h3\u003e\n\n\u003cp\u003eUniTask内のawaitでコルーチンを待つことができます。\u003ccode\u003eWithCancellation\u003c/code\u003e メソッドを併用することで、CancellationTokenを利用してキャンセル時の処理を行うことができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHogeBehaviour\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eFooAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// UniTask内のawaitでCoroutineを待てる\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eBarCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eWithCancellation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eBarCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eWaitForSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"unitaskからコルーチンを起動した場合のコルーチンの寿命は普通とは異なることに注意\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unitask%E3%81%8B%E3%82%89%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E5%AF%BF%E5%91%BD%E3%81%AF%E6%99%AE%E9%80%9A%E3%81%A8%E3%81%AF%E7%95%B0%E3%81%AA%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AB%E6%B3%A8%E6%84%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUniTaskからコルーチンを起動した場合のコルーチンの寿命は、普通とは異なることに注意\u003c/h4\u003e\n\n\u003cp\u003eUniTaskから呼ばれたコルーチンは、通常のUnityの処理と異なり、UniTaskが駆動しているため、GameObjectがDestroyされたときに自動的に止まるということはありません。そのような挙動にしたい場合は、GetCancellationTokenOnDestroy() で取得したトークンを渡すなど、CancellationTokenの適切な利用が必要になります。\u003cbr\u003e\nWithCancellation() を利用してCancellationTokenを渡している場合、キャンセル時には、通常コルーチンと同様に、コルーチン内の \u003ccode\u003eyield\u003c/code\u003e のところでCoroutineの実行が止まります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"コルーチンからunitaskを呼んで待つには\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコルーチンからUniTaskを呼んで待つには\u003c/h3\u003e\n\n\u003cp\u003eUniTaskには \u003ccode\u003eToCoroutune()\u003c/code\u003e というメソッドがあり、これを利用することができます。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"コルーチンからunitaskを呼んで待つには-キャッチしたい例外がない場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF-%E3%82%AD%E3%83%A3%E3%83%83%E3%83%81%E3%81%97%E3%81%9F%E3%81%84%E4%BE%8B%E5%A4%96%E3%81%8C%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコルーチンからUniTaskを呼んで待つには: キャッチしたい例外がない場合\u003c/h4\u003e\n\n\u003cp\u003e特にキャッチするべき例外がない場合は、以下のような簡潔な記法も利用できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eHogeAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eただし、CancellationToken利用時のキャンセル時にはエラーログが出てしまう問題があるようです。ログが出る以外の実害はないですが、キャンセルしないケースで利用するのが良いと思われます。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"コルーチンからunitaskを呼んで待つには-例外をキャッチしたい場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF-%E4%BE%8B%E5%A4%96%E3%82%92%E3%82%AD%E3%83%A3%E3%83%83%E3%83%81%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコルーチンからUniTaskを呼んで待つには: 例外をキャッチしたい場合\u003c/h4\u003e\n\n\u003cp\u003eコルーチンには例外を伝播させる方法がありませんので、例外についてはUniTask内で処理する必要があります。このため、現実的には、以下のような形で例外処理するのが良いと思われます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e    \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eHogeAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOperationCanceledException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// キャンセル時の例外対応。Coroutine側で対応が必要ならばここで書く\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// キャンセル以外の例外対応\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Exception: \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eHogeAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2000\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"コールバック方式のメソッドからunitaskを呼ぶ方法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E6%96%B9%E5%BC%8F%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%81%B6%E6%96%B9%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコールバック方式のメソッドからUniTaskを呼ぶ方法\u003c/h3\u003e\n\n\u003cp\u003eUniTask.Action を利用することで、コールバック方式のメソッドからUniTaskを呼び出すことができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUniTaskCallbackSample\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eLoadCB\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"sample\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"result:\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// コールバック方式のメソッド\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eLoadCB\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eAction\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eonResult\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eHogeAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eonResult\u003c/span\u003e\u003cspan class=\"p\"\u003e?.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e})();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 呼びたいUniTaskメソッド\u003c/span\u003e\n    \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eHogeAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2000\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e※この例ではキャンセルしないケースになっています。コールバック側にキャンセル機構がある場合は、\u003ccode\u003eCancellationTokenSource\u003c/code\u003e を利用しましょう。また、例外が発生する可能性がある場合は例外処理も必要です。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"unitaskからコールバック方式のメソッドを呼ぶ方法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unitask%E3%81%8B%E3%82%89%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E6%96%B9%E5%BC%8F%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%91%BC%E3%81%B6%E6%96%B9%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUniTaskからコールバック方式のメソッドを呼ぶ方法\u003c/h3\u003e\n\n\u003cp\u003eAutoResetUniTaskCompletionSource を利用することで、コールバック方式のメソッドをUniTaskに変換することができます。成功時に TrySetResult を呼ぶことで結果を返し、待ちを終了させることができます。失敗時には TrySetException で例外を渡すことができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eUniTaskCallbackSample\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCancellationTokenOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eSendGetSceneAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// AutoResetUniTaskCompletionSource を利用する。\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// これはasync指定がなく、UniTaskを返す「普通のメソッド」。\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 直接UniTaskのインスタンスを返しているので、awaitで待つことができる。\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendGetSceneAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eutcs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eAutoResetUniTaskCompletionSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eHogeCB\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eutcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTrySetResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegister\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eutcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTrySetCanceled\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e \u003cspan class=\"c1\"\u003e// CancellationToken対応\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eutcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eAction\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// コールバック方式の非同期メソッドの例\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eHogeCB\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eAction\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eonResult\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecallback\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eonResult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"AfterWait\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e3.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAfterWait\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003ecallback\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e※ \u003ccode\u003eAutoResetUniTaskCompletionSource.Create()\u003c/code\u003e のかわりに \u003ccode\u003enew UniTaskCompletionSource()\u003c/code\u003e とする方法でも動作はほぼ変わりませんが、 \u003ccode\u003eAutoResetUniTaskCompletionSource.Create()\u003c/code\u003e のほうがアロケーションが少ないのでこちらを利用すると良いです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"宣伝\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%A3%E4%BC%9D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e宣伝\u003c/h2\u003e\n\n\u003cp\u003ePsychic VR Lab ではUnityエンジニアを募集しています！\u003cbr\u003e\n\u003ca href=\"https://www.wantedly.com/projects/603605\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.wantedly.com/projects/603605\u003c/a\u003e\u003c/p\u003e\n","createdAt":"2021-05-27T12:30:55Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"Rznqt/wFMAnGeKKjysfPCmmdCPEYS1zyZA==--0teOO59mvsHVPBi+--R1JE00LTfg7wHsM7Zny+AA==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-07-14T13:19:05Z","likesCount":34,"linkUrl":"https://qiita.com/mhama/items/0f2cba4a4a762589fc53","organization":null,"originalId":1440699,"stockedCount":28,"title":"UniTask 2.x を使った堅牢な非同期処理への移行ガイド","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E8%AB%96\"\u003e結論\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%94%A8%E8%AA%9E\"\u003e用語\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unitask%E3%81%AE%E4%BD%BF%E3%81%84%E3%81%AF%E3%81%98%E3%82%81%E6%96%B9\"\u003eUniTaskの使いはじめ方\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%BB%E3%81%AA%E6%83%85%E5%A0%B1%E6%BA%90\"\u003e主な情報源\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unitask%E3%81%A8%E3%81%AF\"\u003eUniTaskとは\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unitask%E3%81%AE%E8%89%AF%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%A8%E6%AF%94%E8%BC%83%E3%81%97%E3%81%A6\"\u003eUniTaskの良いところ（コルーチンと比較して）\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%80%A4%E3%82%92%E8%BF%94%E3%81%9B%E3%82%8B%E3%81%AE%E3%81%8C%E4%BE%BF%E5%88%A9\"\u003e値を返せるのが便利\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BE%8B%E5%A4%96%E3%82%92%E4%BC%9D%E6%92%AD%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%AE%E3%81%8C%E4%BE%BF%E5%88%A9\"\u003e例外を伝播できるのが便利\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#finally-%E3%82%84-idisposable-%E3%81%AB%E3%82%88%E3%82%8B%E7%B5%82%E4%BA%86%E5%87%A6%E7%90%86%E3%81%8C%E6%AD%A3%E7%A2%BA%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%A7%E3%81%8D%E3%82%8B\"\u003efinally や IDisposable による終了処理が正確に実行できる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%A5%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%82%82%E4%BD%BF%E3%81%88%E3%82%8B%E3%81%AE%E3%81%8C%E4%BE%BF%E5%88%A9\"\u003e別スレッドも使えるのが便利\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unitask%E3%81%AE%E3%81%9D%E3%81%86%E3%81%A7%E3%82%82%E3%81%AA%E3%81%84%E3%81%A8%E3%81%93%E3%82%8D\"\u003eUniTaskのそうでもないところ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%A7%E8%BF%94%E3%82%8A%E5%80%A4%E3%82%82%E3%81%AA%E3%81%84%E3%82%B1%E3%83%BC%E3%82%B9%E3%81%A7%E3%81%AE%E3%82%BF%E3%82%A4%E3%83%97%E9%87%8F%E3%81%8C%E3%82%84%E3%82%84%E5%A4%9A%E3%81%84%E4%B8%BB%E3%81%ABcancellationtoken%E3%81%AE%E3%81%9F%E3%82%81\"\u003eシンプルで返り値もないケースでのタイプ量がやや多い（主にCancellationTokenのため)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%AB%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E6%83%85%E5%A0%B1%E3%81%8C%E3%82%8F%E3%81%8B%E3%82%8A%E3%81%AB%E3%81%8F%E3%81%84\"\u003eコールスタック情報がわかりにくい\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%84%E3%81%A4unitask%E3%82%92%E4%BD%BF%E3%81%86%E3%81%B9%E3%81%8D%E3%81%8B\"\u003eいつUniTaskを使うべきか\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A0%85%E7%89%A2%E3%81%AA%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%AE%9F%E8%A1%8C%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8D%E3%81%9F%E3%81%84%E3%81%A8%E3%81%8D\"\u003e堅牢な非同期実行コードを書きたいとき\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86%E3%81%AE%E7%B5%82%E4%BA%86%E6%99%82%E3%81%AB%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99%E3%82%88%E3%81%86%E3%81%AA%E3%82%B1%E3%83%BC%E3%82%B9\"\u003e非同期処理の終了時に値を返すようなケース\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#monobehaviour%E3%81%8C%E7%A0%B4%E5%A3%8A%E3%81%95%E3%82%8C%E3%81%A6%E3%82%82%E5%87%A6%E7%90%86%E3%82%92%E7%B6%9A%E3%81%91%E3%81%9F%E3%81%84%E3%82%B1%E3%83%BC%E3%82%B9\"\u003eMonoBehaviourが破壊されても処理を続けたいケース\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%A0%B4%E5%A3%8A%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AE%E9%81%95%E3%81%84\"\u003e破壊タイミングの違い\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E5%A0%B4%E5%90%88\"\u003eコルーチンの場合\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unitask%E3%81%AE%E5%A0%B4%E5%90%88\"\u003eUniTaskの場合\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#cancellationtoken%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eCancellationTokenについて\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#cancellationtoken%E3%81%A7%E3%81%AE%E6%89%8B%E5%8B%95%E3%81%A7%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E6%96%B9%E6%B3%95\"\u003eCancellationTokenでの、手動でのキャンセル方法\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%81%97%E3%81%AA%E3%81%84cancellationtoken%E3%81%AE%E6%B8%A1%E3%81%97%E6%96%B9\"\u003eキャンセルしないCancellationTokenの渡し方\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%85%A8%E9%83%A8%E3%81%AEunitask%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%BC%95%E6%95%B0%E3%81%ABcancellationtoken%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%8B\"\u003e全部のUniTaskメソッドの引数にCancellationTokenをつけるべきか？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003e例外処理の注意点\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BE%8B%E5%A4%96%E3%81%AF%E3%81%A9%E3%81%93%E3%81%B8%E8%A1%8C%E3%81%8F%E3%81%AE%E3%81%8B\"\u003e例外はどこへ行くのか\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%80%86%E5%BC%95%E3%81%8D\"\u003e逆引き\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82unitask%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E6%96%B9\"\u003eそもそもUniTaskの呼び出し方\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9D%9Easync%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8B%E3%82%89%E5%80%A4%E3%82%92%E8%BF%94%E3%81%95%E3%81%AA%E3%81%84unitask%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E6%96%B9%E6%B3%95\"\u003e非asyncメソッドから値を返さないUniTaskを呼び出す方法\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9D%9Easync%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8B%E3%82%89%E5%80%A4%E3%82%92%E8%BF%94%E3%81%99unitask%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E6%96%B9%E6%B3%95\"\u003e非asyncメソッドから値を返すUniTaskを呼び出す方法\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%BF%94%E3%82%8A%E5%80%A4%E3%81%8C%E3%81%AA%E3%81%84unitask%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9\"\u003e返り値がないUniTaskの書き方\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unitaskvoid%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B\"\u003eUniTaskVoidとは何か\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#start-%E3%82%92unitask%E3%81%AB%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95-unitaskvoid\"\u003eStart() をUniTaskにする方法 (UniTaskVoid)\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%A5%E3%81%AE%E6%89%8B%E6%B3%95%E3%81%A8%E3%81%AE%E3%83%96%E3%83%AA%E3%83%83%E3%82%B8%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e別の手法とのブリッジについて\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#unitask%E3%81%8B%E3%82%89%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF\"\u003eUniTaskからコルーチンを呼んで待つには\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#unitask%E3%81%8B%E3%82%89%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E5%AF%BF%E5%91%BD%E3%81%AF%E6%99%AE%E9%80%9A%E3%81%A8%E3%81%AF%E7%95%B0%E3%81%AA%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AB%E6%B3%A8%E6%84%8F\"\u003eUniTaskからコルーチンを起動した場合のコルーチンの寿命は、普通とは異なることに注意\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF\"\u003eコルーチンからUniTaskを呼んで待つには\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF-%E3%82%AD%E3%83%A3%E3%83%83%E3%83%81%E3%81%97%E3%81%9F%E3%81%84%E4%BE%8B%E5%A4%96%E3%81%8C%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88\"\u003eコルーチンからUniTaskを呼んで待つには: キャッチしたい例外がない場合\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%82%93%E3%81%A7%E5%BE%85%E3%81%A4%E3%81%AB%E3%81%AF-%E4%BE%8B%E5%A4%96%E3%82%92%E3%82%AD%E3%83%A3%E3%83%83%E3%83%81%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88\"\u003eコルーチンからUniTaskを呼んで待つには: 例外をキャッチしたい場合\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E6%96%B9%E5%BC%8F%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%8B%E3%82%89unitask%E3%82%92%E5%91%BC%E3%81%B6%E6%96%B9%E6%B3%95\"\u003eコールバック方式のメソッドからUniTaskを呼ぶ方法\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unitask%E3%81%8B%E3%82%89%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E6%96%B9%E5%BC%8F%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E5%91%BC%E3%81%B6%E6%96%B9%E6%B3%95\"\u003eUniTaskからコールバック方式のメソッドを呼ぶ方法\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%A3%E4%BC%9D\"\u003e宣伝\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":5286,"uuid":"0f2cba4a4a762589fc53","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"PglcMzlhXilvjOKZZXkWC/Z2IW4=--iN3sz4P9fJSjbQVu--xLz/RYrUVevcaeu5UMjjmg==","originalId":71421,"description":"","facebookUrl":null,"githubUrl":"https://github.com/mhama","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/71421/profile-images/1577419526","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2Fprofile-images%2F1577419526?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=e208cf39cfa68128a1c371476a8a2e60","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F71421%2Fprofile-images%2F1577419526?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1ba291cff910479915e9129a5564612b","urlName":"mhama","websiteUrl":null,"twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"},{"name":"UniTask","urlName":"unitask"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
