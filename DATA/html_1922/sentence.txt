More than 1 year has passed since last update.コードだけ手っ取り早く見たい方はここを参照。
https://github.com/anareta/TextWrapper/blob/master/TextWrapper/TextUtility.cs【C#】会社への反骨精神からツールを完成させた話
https://qiita.com/yukibacho/items/0265926f607ccf5489b8このフォーマットではまず書く意味があるのかと疑問を抱きます。
また最初のうちはOJT指導者などが週報を閲覧している形跡がありましたが入社して1年が過ぎたころには誰も閲覧しなくなりました。週報を書きたくないと理由をつけて説明しても「OJT期間はやろう」の一点張りで、要求を受け入れてくれませんでした。これが会社か。。。
と思いながらもOJT期間中は渋々週報を書くことにしました。あるあるｗｗｗと思いながら読んでました。自分もだいたい同じような状況で、実際の効果はともかくとして、とにかく儀式として毎週「週報」を提出することを求められています。ちなみにわたしのところはOJT期間限定じゃないです。つらみ。この記事の方の場合はという形で運用されていました。
ところが、自分のところの週報の運用には他にも要件があって、というのがあります。なんでサーバーに配置した上でメールまで送らないといけないのか理解に苦しみますが。
で、別に週報のテキストをペッと貼り付けて送信するだけなら楽でいいのですが、もうひとつ、というのがあります。
…いや文字の折返しなんかお使いのツールでなんとかしろよと思わなくもないですが、過去に改行を入れないテキストデータを提出したところ「このような読みにくい週報を出してくるとは、この無礼者が！」と詰られたのでこれは動かせない要件なのです。わたしのような下っ端無礼者エンジニアは上司（いわゆるゴッド）の言うことには逆らえないのです。長く書きましたが最終的には以下のようなテキストを作る必要があります（中身はダミーテキスト）。手作業で週報を作る場合、エディタに週報の中身を書いてから、このテキストの折り返し位置に改行を入れていく作業をひたすらやっていくわけです。ちなみに改行を入れたあとで誤字脱字に気づいて修正すると、周囲の行の折り返しが全部ずれるので改行を入れ直して調整しないといけません。これが地獄か。さすがにやっていられないので自動化を考えた、というのがこの記事の趣旨になります。折り返しの要件を整理します。ちょっと考えてみると最初の要件はそもそも実現不可能であるということがわかります。なぜなら文字（グリフ）の幅はフォントによって違うからです。提出はテキストデータなので、そのデータを開くツールがどんなフォントでそれを表示するかはコントロールできません。…とはいえ、弊社の上司がエディタやメーラーのフォント設定をデフォルトのMSゴシックから変えているとは思えないので、もう割り切って「ASCII範囲の文字は幅１」「ASCII範囲外の文字は幅２」として考えます。半角カナ？　知らんなあ。ちゃんとやるならMSゴシックのグリフ幅を取得して幅計算すべきですが、まあ大丈夫でしょう多分。
ちなみに弊社にmacOSを使っている上司はいないのでツールのデフォルトフォントはたいていMSゴシックです。そもそも業務にmacOS使わせてもらえないし。ところで実際に折り返しをやってみて気づいたのですが、文章に英単語が入っていたときにその途中で折り返されるのは見栄えがかなり悪いです。英単語以外にもURLとかが含まれる行もあるのでその場合は折り返してほしくない。いわゆるwordwrapと呼ばれるやつです。もうひとつ、文章に含まれる句読点（"。、"）が折り返しの結果行頭に来てしまうのも気になります。あと逆に行末に"「"や"（"が来てしまうパターンもあります。いわゆる禁則文字への対応も必要になります。というわけで、頑張って作りました。TextWrapper
https://github.com/anareta/TextWrapper長い。構造化されてなくてごめん。基本的な処理としては与えられたテキストを折り返しまでの幅だけとってきてStringBuilderに追加していきます。文字列を操作する機能はstringクラスに備わっていますが、サロゲートペア等の複数のUTF-16文字で構成される文字に対しては無力です。英語圏の文字しか使わないのであればあまり考慮する必要はないと思いますが、日本語の文章だとたまにそういう文字が含まれる場合があって考慮しておくほうがいいです。これで絵文字も使える。文字の幅は以下で計算しています。中身は、ASCII範囲だったら1、ASCII範囲外だったら2として、文字列の合計幅数を計算します。文字コードの判別ロジックってけっこう難しかったので、諦めて「UTF-8にして何バイトの領域か」を取得して判定しています。厳密じゃないです。これ書いてるときに「そういえば半角カナってどうなるんだ？」って気づきました。半角カナはUTF-8だと3バイト。
前述しましたが真面目にやるならMSゴシックのグリフ幅を取得して計算するのが確実です。禁則文字の判定はクールな方法が見つからなかったので力技です。IsStart行頭禁則文字というメソッド名がわたしの投げやりな気持ちを表現している…。どういう動きを想定しているかは、プロジェクトに単体テストも含まれてるのでそっちを見てください。英語力がpoorなので単体テストでは日本語を使う派。週報書くのがつらいので、週報書かなくてもいい会社を探しています。


