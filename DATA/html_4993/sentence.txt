Figmaでデザインを作…ろうと思ったけど記事にならないので、
一覧画面をカスタマイズして、
・日付フィルタの導入
・項目の表示/非表示の切り替え
を実装します。
※BIが使えないけどどうしてもグラフで見える化したく、Google Chart APIを使おうとしているため、
　画面にグラフの元データを持たせたい。日付のフィルタは範囲指定ができるようにします。
単純にカレンダーで選択する形式にして、FROM-TOの大小関係だけチェックします。
MS公式を参考に実装してみます。
チュートリアル: 並べ替え、フィルター処理、ページングを追加する - ASP.NET MVC と EF CoreIndexメソッドに引数2つとクエリロジックを追加します。
引数2つはnullを許容しておきます。（nullの場合は無制限にする）次に日付入力のフォームを作ります。
下記のようなフォームを追加しました。下記のようになりました。
Fromで絞り込むことは出来ましたが、日付入力フォームが「年/月/日」になっていて、どういう値で絞り込んだのかわからなくなってしまいました。
さらにToで絞り込むと、Toだけの絞り込みになったので、
Fromがリセットされてしまっているとわかりました。
チュートリアルをよく見て、無視していた行がありました…。
IndexメソッドとIndex.cshtmlを修正します。
ViewDataを使って初期値を画面に設定します。Fromで絞ると下記のようにFromの入力値が保持されました。
さらにToで絞り込むこともできます。
で、こうなるとクリアボタンが欲しくなるので、それも実装します。
クリアボタンは別のフォームを作ってsubmitボタンを用意するだけです。絞り込んで…
クリア。（画面だけだとわからないけど、URLでパラメータがないのがわかりますね。）
モーダルウィンドウで項目の一覧を表示し、チェックを外すと非表示にしましょう。
bootstrapとjavascriptでいけそうです。
Index.cshtmlを全体的に修正します。まずはモーダルウィンドウを表示するボタンを用意します。
data-toggle="modal" data-target="#modal1"はモーダルに必要なパラメータです。モーダルウィンドウの定義を作ります。
div#idの"modal1"はボタンのdata-targetです。
div#classにfadeを指定するとフェードインするようになります。
見た目がわかりやすいのでcustom-switchを使います。各スイッチ部分はデフォルトオンにしています（checked）
onclickで呼び出す関数(changeVisible())は後で実装しますが、テーブルの列を非表示にする関数です。テーブルの各項目にidを振っておく必要があるので振ります。
※上記のchangeVisible関数の第2引数で列を指定する。上記を全部反映すると下記のようになります。site.jsにchangeVisible関数を実装します。
site.jsはデフォルトで読み込まれる設定が入っているので、cshtml側で読み込む処理を新たに書く必要はありません。上記で実装完了です。
動かしてみます。
項目の表示/非表示ボタンを押します。
スイッチを押すとグレーになり、その項目が背景の一覧画面で表示されなくなります。
右上の×か閉じるボタンで閉じます。
スイッチをクリックした時点で表示を切り替えているので、モーダルを閉じるだけです。
ただ、これには欠点があり、日付フィルタを使用したり、詳細画面に遷移して一覧に戻ってしまうとすべての項目が表示されてしまいます。
また、利用者目線で考えると、全て表示/非表示くらいは1ボタンでやりたくなります。
前者は日付フィルタも同じなので一旦置いておき…
後者を実装します。HTML+javascriptだけでいきます。
まずモーダルのフッターにボタンを用意します。toAllVisibleを実装します。
各スイッチのvalueに基づいて、下記のように処理します。
①すべて表示したいとき(引数がtrue)は、checked==falseのスイッチをすべてクリックする
②すべて非表示したいとき(引数がfalse)は、checked==trueのスイッチをすべてクリックする
つまり、checked!=引数のスイッチをすべてクリックします。出来ました。
詳細画面や編集画面に遷移した後、一覧画面に戻るとフィルタが解除されてしまうので、それを解消します。
フィルタ情報をTempDataで持つようにして、詳細画面 or 編集画面のどちらかからの遷移の場合、
TempDataから取り出したフィルタ条件で絞り込みます。
もっといい方法がある気がしますがごり押しです…Index.cshtmlのほうもTempDataに変えます。何がダメってMVCしてないのがダメな気がしてきたのでMVC（というよりMVVCかな？）にしたい。


