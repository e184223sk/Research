More than 3 years have passed since last update.気象庁が公開している最高気温を扱ってみる。
最新の気象データ - 最高気温 （気象庁）Functions の詳細については割愛。Azure Portal でコード書けるけど Intellisence 効かないし、SyntaxErrorとかも出てこないから、やっぱりIDEで書きたいところ。Azure Function Tools を入れるために VS2017 のプレビュー版をインストール。
現時点ではプレビュー版でないとこやつをインストールできないので注意。
(2018/04/11 UPDATE) v15.3くらいからリリース版でもちゃんと動くので、プレビュー版の表記を消しました。(2018/04/11 UPDATE) テンプレートリテラルをstring.Format()から$""の形式に変更しました。短く書けるようになりました！あんまり特別なことをしているわけではないかと。Azure Portal では下記のとおり。
もろもろ既定で using されてる。メインである Run メソッドの中身は同じ。
インデントが少ない分見やすい・・・。利用しているデータが厄介なことに SJIS なので、 new StreamReader() でちゃんと文字エンコードを指定しましょう。CSV データを List&lt;List&lt;string&gt;&gt; 形式に変換している部分。
1. StreamReader で一気に全部読みこんで、改行コードの処理。Split('\n') で String 配列に。1要素に行が丸ごと入ってる。
2. Where() でデータがある行に絞り込む。最終行の空データを排除する目的。
3. Select() で各行をカンマで Split 。
4. ToList() で List&lt;List&lt;string&gt;&gt; の完成。CSV ヘッダは1行目なので、それだけ取り出しておく。
このあと KVP 配列にする際の Key となる大事な部分。return 句に書いている肝心な部分。
もうちょっとスマートな書き方がありそうな気がする。コメントにて改善案募集中。JS だともっと簡単に書けるのだが断念した。
その理由が "文字化け" 。ローカル開発環境の Node.js ではうまいこといったのに、なぜか Functions では謎な結果となった。ソースは残していないが、以下のような感じだったかと。
これを Function 風に変えたはず。何がどうおかしかったのか、というと、上述の実行結果でいう、
「観測所番号」とか「都道府県」とか、つまり Key が謎な文字コードでエンコードされてしまった。
「北海道宗谷地方」とか「宗谷岬」とか、つまり Value は正しく日本語で出力されていた。Key 側だけ文字化けする、という謎の状況。個人的な意見だが、おそらく Azure Functions 側の問題ではないかな、と。
原因不明。結論：SJISデータはめんどくちゃい。


