More than 1 year has passed since last update.従来Excelで管理していたデータをデータベース管理に移行したいと思い、いろいろと調べていたのですが、WindowsアプリケーションからWeb系へアクセスするような事をされている方が少ないのか、なかなか情報が見つかりませんでした。
Excelから直接MySQLへのアクセスも検討したのですが、Excelからだと使用者のPCにODBCドライバのインストールが必要になり、PC毎にインストールをしてもらうのは大変なので、ODBCに頼らないデータ転送手法を模索しました。元々Excelの帳票とそれをVBAのマクロでかき集めたシートで構成していたものを、Excelの帳票を読み込み、Web経由でデータベースへ流し込むという構成を検討しました。
Excelに限らず様々なデータを転送できるようにするため、帳票の読み込みはC#のアプリケーションによって作成することにしました。
また、登録するデータは複数のレコードを一括登録するために、構造体渡しのような形をとりたく、流行りのJSONフォーマットを使用。
データの受け渡しイメージは次の通りです。
C#アプリケーション &gt; PHPページ &gt; SQLデータベース一括送信に使いたいデータ内容は次の通り。
元々はPOSTにてデータを渡す予定であったため、rootという頭のデータを作り、その中に実際に使用するデータを入れていますが、後述のPHP側の呼び出しでは平のデータでも大丈夫なのかもしれません。JSONデータを生成し、送信するためのコードです。
予めJSONで渡したいデータと同じ構造を定義し、構造体のようにセットすることでやりとりが簡単になります。
下記サンプルでは前述のように一旦rootという親を設けている関係で、データのセットはDataクラスで直接作成し、後でDataContainerにセットする形をとっています。
送信について、WebRequestで指定するデータの送り先は、受信処理を記述した自作のページregist.php（後述）となります。
URLについてはphpコードの設置先の環境に合わせて変更してください。通常POSTによって渡されたデータは$_POSTによって受信しますが、JSON形式についてはうまく受信できないため、file_get_contentsを使用します。
受信後のデータをjson_decodeによって連想配列に格納し利用します。何かのお役に立てば幸いです。C#からRedmineのAPIを呼び出すのに便利なDLLモジュールを作りました。【PHP】JSONでPOSTされた値の取り出し方。file_get_contents("php://input") するようだ。


