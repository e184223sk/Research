More than 3 years have passed since last update.【C#】Where(it =&gt; it is Xxx).Select(it =&gt; it as Xxx)って書かず、OfType使おう！【LINQ】 - Qiitaを見て、Swiftとの対比記事を書いてみようと思いました。元記事では、C#でコレクションから特定の型のオブジェクトだけ取り出したい場合は、Where・Selectの組み合わせでも出来るものの、OfTypeを使うと簡潔に書けて良い、ということでした。元記事のコード例から、Unity依存排除してシンプル化するなどして、コード例を書き直してみました。
(Visual Studio for MacがあるとParallelsでWindows仮想マシン起動せずに済んで便利でした(　´･‿･｀))(元記事では、Where → Select でis・asという型比較系の処理が2回行われていたのが冗長に感じたので、Select → Whereの順に書き換えています)いくつかコード例書いていきます。上のC#の例のSelect → Whereに相当する処理であるmap → filterに単純に置き換えてみました。結果は、[Optional(A)]となり、求めていた[A]ではなくNGです。以下のように、filter(isでフィルター) → map(フィルター済みなので一応as!でもOK…)すると、結果は求めていた[A]になりますが、イマイチなやり方ですよね。reduceでいわゆるflattenぽいことをしたコードが以下です。とりあえず結果は求めていた[A]となりましたが、ちょっと処理が煩雑ですね。そこで、本命のflatMapを使うと、こんなに簡単に書けてしまいます👏flatMapは、mapしてflatten(平坦化)の意味なので、まさしくやりたかったことに沿ったメソッドですね。
flatMapでは、Optional(A)のArrayにして(map)、さらにアンラップ(nilは除去)する処理(flatten)が一度になされています。flatMapでシンプルに書けるのであまり意味が無いですが、SwiftにもofTypeを定義してみます。すると、次のように、SwiftでもC#のofTypeが使えるようになりました。
ただ、flatMapをベタに書いた場合と記述量も読みやすさも変わらないので、基本的にはflatMapをそのまま使えば良いと思います。つまり、flatMapという汎用メソッドがあるだけで、ofTypeや類似の処理が簡潔に書ける、というキレイな世界になっています👏(SwiftでofType書くとしたら、上記のようにflatMapラップではなくベタに書いてflatMapより高パフォーマンスなメソッドにしておくと存在価値ありそう)少し記述が混み合いますが、SelectManyで可能です。上の例ではSelectManyのラムダ式が複雑になりましたが、以下のように[[1, 2], 3] → [1, 2, 3]と変換するような単純なシーケンスの平坦化処理であれば、swiftとあまり差が無くなります。
(配列の初期化部分は少し面倒な記述になっていますが、SelectManyの中身はシンプル)C#:Swift:Swiftではオプショナルが言語仕様に組み込まれていて、さらにflatMapが、ArrayもOptionalも同じ「入れ物」として抽象化しているので、「平坦化」処理の際、入れ子の配列を合体させるような感覚で、Optionalのアンラップが行われます。@neuecc さんからTweetいただきました。flatMapの実装にそういうのがあるからって感じで言語仕様的に一緒だからってわけではない感。(しかしC#はnullableの考慮を足すのが面倒) https://t.co/cweyEGg5Y2 / “C#のOfTypeメソッド…” https://t.co/V6rrs1zCoW元の文中には「言語仕様的に一緒」とは書かれてない（同じ「入れ物」として抽象化している、というのが正しい）ので、コメントはちょっと読み違え含むです、すみません。 https://t.co/ASzeq8TrKsRxがTaskと融合するってのもIObservable.SelectManyにTaskのオーバーロード足しただけっていう話で、こういうのは見せ方が大事というのがある。全体的にそういう見せ方で統一されているから、そういうものだと扱える。そもそもLINQがそういうものですからね。SelectManayでシンプル(SwiftのflatMapと同等)に書けるようになって、ついでに拡張メソッドの実装もラムダ式では無くなるのでyield使えて http://qiita.com/mono0926/items/b8ff59938a60ddf93c6e#selectmanyで可能swiftのflatmapとまったく同じでは無い のコードより少しシンプルになっています。この拡張メソッド足すと、C#でもOfTypeいらないのでは🤔と思えてきちゃいます(　´･‿･｀) (※1)まったく同じ結果:(※1: ただしパフォーマンス的に違いがあったりはしそう。)関連として、以下の @koher さんの記事などがとても参考にあります。
1年ほど前の記事ですが、このあたりはSwift 2からほぼ変わっていないはずです(1→2の間は色々改良あった)。


