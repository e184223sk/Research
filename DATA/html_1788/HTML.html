<!DOCTYPE html><html><head><meta charset="utf-8" /><title>【C#】 DllExportでWindowスタイルなAPIをC#風に扱う - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/up-hash/items/1c5717657c6e2aa38698" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="V3kXZkv0lSOqRq0aBbKBF0vgmWjDAGH2idvXPagWcVs89Ntb2uU+ZVJYIpzYjVe3u6ogPaINhd4tmaYf40Zdig==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@yukawallstudio" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="【C#】 DllExportでWindowスタイルなAPIをC#風に扱う - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRUXlQamdKRWdSR3hzUlhod2IzSjA0NEduVjJsdVpHOTM0NEs1NDRLXzQ0S2s0NE9yNDRHcVFWQko0NEtTUXlQcG9xampnYXZtaWJIamdZWSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1lNjI5NmY1YzE1ZmFhMzhiNTAyMWMwNjZlMTgxNjdiNg&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSFZ3TFdoaGMyZyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWY4ZGEyNGM1YzAwOWVmYjE1ZWZhYzg1NDVkMDQwZGI3&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=7e09e863954e50b0cb77f6cb19a2601f"><meta property="og:description" content="

TL;DR;



HRESULTと例外の互換（DllImportにPreserveSig=falseをつける）

出力引数を戻り値に移動（PreserveSig=false）

refやoutをポインタと互換

文字列ポインタと..."><meta content="https://qiita.com/up-hash/items/1c5717657c6e2aa38698" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C++,C#,window" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-049fa145-ace7-4252-b227-29da2a13cca9"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fup-hash%2Fitems%2F1c5717657c6e2aa38698">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fup-hash%2Fitems%2F1c5717657c6e2aa38698">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-049fa145-ace7-4252-b227-29da2a13cca9">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/cpp","name":"C++"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-03-11T04:04:53.000+09:00","dateModified":"2020-04-05T00:47:42.000+09:00","headline":"【C#】 DllExportでWindowスタイルなAPIをC#風に扱う","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRUXlQamdKRWdSR3hzUlhod2IzSjA0NEduVjJsdVpHOTM0NEs1NDRLXzQ0S2s0NE9yNDRHcVFWQko0NEtTUXlQcG9xampnYXZtaWJIamdZWSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1lNjI5NmY1YzE1ZmFhMzhiNTAyMWMwNjZlMTgxNjdiNg\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSFZ3TFdoaGMyZyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWY4ZGEyNGM1YzAwOWVmYjE1ZWZhYzg1NDVkMDQwZGI3\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=7e09e863954e50b0cb77f6cb19a2601f","mainEntityOfPage":"https://qiita.com/up-hash/items/1c5717657c6e2aa38698","author":{"@type":"Person","address":"","email":null,"identifier":"up-hash","name":"up-hash","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars3.githubusercontent.com%2Fu%2F22035855%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=6f6ae227612f84d2d931140a621050cd","url":"https://qiita.com/up-hash","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita&amp;utm_medium=header-banner">クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"up-hash","type":"items","id":"1c5717657c6e2aa38698"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい","url":"https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"up-hash","type":"items","id":"1c5717657c6e2aa38698"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい","url":"https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"up-hash","type":"items","id":"1c5717657c6e2aa38698"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい","url":"https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/up-hash/items/1c5717657c6e2aa38698","location":"/up-hash/items/1c5717657c6e2aa38698","scheme":"https","host":"qiita.com","port":null,"pathname":"/up-hash/items/1c5717657c6e2aa38698","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"4U3G+jUVH63hsVI5Z8Dmzrugv1mmJeLedp427vw5GJGKwArHpAS06xmv3b+6/zBuS+oGDMcoBvbS3EfMt2k0QA==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-aba2e13b-4291-4fa0-91d4-0d30b030f9b5"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/up-hash/items/1c5717657c6e2aa38698/likers" class="css-1iupg5d">8</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">11</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/1c5717657c6e2aa38698/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/up-hash/items/1c5717657c6e2aa38698/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/up-hash/items/1c5717657c6e2aa38698/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/up-hash/items/1c5717657c6e2aa38698/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/up-hash/items/1c5717657c6e2aa38698.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/up-hash"><img class="css-100alwu eyfquo10" src="https://avatars3.githubusercontent.com/u/22035855?v=4" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/up-hash" class="css-10ougpm">@<!-- -->up-hash</a><div class="css-1ay9vb9"><span><meta content="2020-03-10T19:04:53Z"/><time dateTime="2020-04-04T15:47:42Z" class="css-m19uds">updated at 2020-04-04</time></span></div></div></div></div></div><h1 class="css-cgzq40">【C#】 DllExportでWindowスタイルなAPIをC#風に扱う</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/cpp" class="css-4czcte">C++</a><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/window" class="css-4czcte">window</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="tldr" class="fragment"></span><a href="#tldr"><i class="fa fa-link"></i></a>TL;DR;</h1>

<ul>
<li>
<strong>HRESULT</strong>と<strong>例外</strong>の互換（DllImportに<code>PreserveSig=false</code>をつける）</li>
<li>
<strong>出力引数</strong>を<strong>戻り値</strong>に移動（<code>PreserveSig=false</code>）</li>
<li>
<strong>refやout</strong>を<strong>ポインタ</strong>と互換</li>
<li>
<strong>文字列ポインタ</strong>と<strong>string</strong>を互換（MarshalAs）</li>
</ul>

<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p>C#とC/C++の相互運用といえば、C++/CLI、C++/CX、COM、IPCなどが考えられます。<br>
その中でも、<code>System.Runtime.InteropServices.DllImport</code>（P/Invoke）という機能があります。<br>
DllImportは基本的には、C++でExportした関数と同じ関数名で（互換性のある）引数、戻り値のメソッドをC#に宣言し、属性でマークすることで使用できます。<br>
しかし、引数や戻り値に関しては<strong>intなどの型互換だけでなく、参照&lt;-&gt;ポインタ、HRESULT&lt;-&gt;例外など</strong>の互換も可能です。<br>
また、C言語ではよく見かける出力引数を、一定条件下で戻り値として扱うこともできます。</p>

<h1>
<span id="サンプル" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>サンプル</h1>

<p>次のようなC++のDLLがあるとします。<br>
C言語（Windows）ではよく、戻り値を成否通知に使い、引数に二重ポインタを渡し、ポインタ先に返したいオブジェクトのポインタを書き込みます。</p>

<div class="code-frame" data-lang="c++"><div class="highlight"><pre class="with-code"><code><span class="c1">// 二重ポインタ（本体の確保は呼び出され側）</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">HRESULT</span> <span class="n">WINAPI</span> <span class="nf">GetBestCouple</span><span class="p">(</span><span class="n">TCHAR</span><span class="o">**</span> <span class="n">ppAnswer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// *ppAnswer = TEXT("YukaMaki"); // NG</span>
    <span class="c1">// *ppAnswer = new TCHAR[32]; // NG</span>

    <span class="c1">// C#に返すメモリはCoTaskMemAllocで確保しないといけない</span>
    <span class="o">*</span><span class="n">ppAnswer</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span><span class="p">)</span><span class="n">CoTaskMemAlloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
    <span class="n">lstrcpy</span><span class="p">(</span><span class="o">*</span><span class="n">ppAnswer</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"YukaMaki"</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">S_OK</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// 一重ポインタ（本体の確保は呼び出し側）</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">HRESULT</span> <span class="n">WINAPI</span> <span class="nf">GetBestCouple2</span><span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span> <span class="n">pAnswer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">lstrcpy</span><span class="p">(</span><span class="n">pAnswer</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"YukaMaki"</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">S_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ちなみに、これは以下のようなメモリ配置になっています。（<code>sizeof(void*)==4</code>の場合）<br>
<a href="https://camo.qiitausercontent.com/c11344c5f6481b724116d15c052b610ab3b67b30/68747470733a2f2f646f63732e676f6f676c652e636f6d2f64726177696e67732f642f652f32504143582d317654496c6b5843374732633465444837522d7367792d474a70687337493550546c443639446c7143354d305031356248433774542d427338534777304256474a69593867324f74666f745a6e4742312f7075623f773d37353426683d31383826" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fdocs.google.com%2Fdrawings%2Fd%2Fe%2F2PACX-1vTIlkXC7G2c4eDH7R-sgy-GJphs7I5PTlD69DlqC5M0P15bHC7tT-Bs8SGw0BVGJiY8g2OtfotZnGB1%2Fpub%3Fw%3D754%26h%3D188%26?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=33843e223c13a6540147f5e081579a47" alt="" data-canonical-src="https://docs.google.com/drawings/d/e/2PACX-1vTIlkXC7G2c4eDH7R-sgy-GJphs7I5PTlD69DlqC5M0P15bHC7tT-Bs8SGw0BVGJiY8g2OtfotZnGB1/pub?w=754&amp;h=188&amp;" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fdocs.google.com%2Fdrawings%2Fd%2Fe%2F2PACX-1vTIlkXC7G2c4eDH7R-sgy-GJphs7I5PTlD69DlqC5M0P15bHC7tT-Bs8SGw0BVGJiY8g2OtfotZnGB1%2Fpub%3Fw%3D754%26h%3D188%26?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3c3f648bce6e686d00c4fe48eae81635 1x" loading="lazy"></a></p>

<p>これを、色々な条件でDLLImportしてみましょう。</p>

<h2>
<span id="case-1" class="fragment"></span><a href="#case-1"><i class="fa fa-link"></i></a>Case 1</h2>

<p>普通に二重ポインタ（<code>TCHAR**</code>）を渡し、実態へのポインタを格納しているメモリ領域を、C++側が確保した領域へのポインタに書き換えてもらいます。<br>
C#側では二重ポインタ（<code>TCHAR**</code>）から<code>TCHAR*</code>を取り出して、マーシャラでデコード。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// HRESULT GetBestCouple(TCHAR** ppAnswer)</span>
<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"D3DVisualization.dll"</span><span class="p">,</span> <span class="n">EntryPoint</span> <span class="p">=</span> <span class="s">"GetBestCouple"</span><span class="p">)]</span>
<span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">GetBestCouple_H_PP_</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">ppAnswer</span><span class="p">);</span>

<span class="c1">// 本体A(TCHAR[])へのポインタB(TCHAR*)へ</span>
<span class="c1">// のポインタC(TCHAR**)のBの部分のメモリを確保してCにアドレスを記録</span>
<span class="c1">// TCHAR* pAnswer; // 確保</span>
<span class="c1">// TCHAR** ppAnswer = &amp;pAnswer;</span>
<span class="c1">// の操作に相当</span>
<span class="n">IntPtr</span> <span class="n">ppAnswer</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">AllocHGlobal</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Size</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hResult</span> <span class="p">=</span> <span class="nf">GetBestCouple_H_PP_</span><span class="p">(</span><span class="n">ppAnswer</span><span class="p">);</span>
<span class="c1">// TCHAR* pAnswer = *ppAnswer;</span>
<span class="c1">// の操作に相当</span>
<span class="n">IntPtr</span> <span class="n">pAnswer</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">ReadIntPtr</span><span class="p">(</span><span class="n">ppAnswer</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">answer</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAuto</span><span class="p">(</span><span class="n">pAnswer</span><span class="p">);</span>
</code></pre></div></div>

<h2>
<span id="case-2" class="fragment"></span><a href="#case-2"><i class="fa fa-link"></i></a>Case 2</h2>

<p>Case 1と同様の関数を呼び出しているが、C#側がout参照を渡しています。（これはref/in参照でもOK）<br>
C#の参照もポインタと同じようなものなので、ポインタの参照、つまり二重ポインタと同様に働きます。<br>
そのため、二重ポインタから本体の領域へのポインタを取り出す操作がなくなっています。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// HRESULT GetBestCouple(TCHAR** ppAnswer)</span>
<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"D3DVisualization.dll"</span><span class="p">,</span> <span class="n">EntryPoint</span> <span class="p">=</span> <span class="s">"GetBestCouple"</span><span class="p">)]</span>
<span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">GetBestCouple_H_RP_</span><span class="p">(</span><span class="k">out</span> <span class="n">IntPtr</span> <span class="n">pAnswer</span><span class="p">);</span>

<span class="n">IntPtr</span> <span class="n">pAnswer</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">hResult</span> <span class="p">=</span> <span class="nf">GetBestCouple_H_RP_</span><span class="p">(</span><span class="k">out</span> <span class="n">pAnswer</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">answer</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAuto</span><span class="p">(</span><span class="n">pAnswer</span><span class="p">);</span>
</code></pre></div></div>

<h2>
<span id="case-3" class="fragment"></span><a href="#case-3"><i class="fa fa-link"></i></a>Case 3</h2>

<p>Case 2では戻り値を受け取っていましたが、捨てることも可能。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// HRESULT GetBestCouple(TCHAR** ppAnswer)</span>
<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"D3DVisualization.dll"</span><span class="p">,</span> <span class="n">EntryPoint</span> <span class="p">=</span> <span class="s">"GetBestCouple"</span><span class="p">)]</span>
<span class="k">static</span> <span class="k">extern</span> <span class="k">void</span> <span class="nf">GetBestCouple_V_P_E</span><span class="p">(</span><span class="k">out</span> <span class="n">IntPtr</span> <span class="n">pAnswer</span><span class="p">);</span>

<span class="n">IntPtr</span> <span class="n">pAnswer</span><span class="p">;</span>
<span class="nf">GetBestCouple_V_P_E</span><span class="p">(</span><span class="k">out</span> <span class="n">pAnswer</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">answer</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAuto</span><span class="p">(</span><span class="n">pAnswer</span><span class="p">);</span>
</code></pre></div></div>

<h2>
<span id="case-4" class="fragment"></span><a href="#case-4"><i class="fa fa-link"></i></a>Case 4</h2>

<p><code>PreserveSig=false</code>を付けることで、HRESULTをC#の例外に変換してくれます。<br>
戻り値はなくなりvoidになりますが、代わりに出力引数を戻り値にできます。<br>
（Case 3のようにout参照にできるものを変えさせられます。）</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// HRESULT GetBestCouple(TCHAR** ppAnswer)</span>
<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"D3DVisualization.dll"</span><span class="p">,</span> <span class="n">EntryPoint</span> <span class="p">=</span> <span class="s">"GetBestCouple"</span><span class="p">,</span> <span class="n">PreserveSig</span> <span class="p">=</span> <span class="k">false</span><span class="p">)]</span>
<span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">GetBestCouple_P__E</span><span class="p">();</span>

<span class="n">IntPtr</span> <span class="n">pAnswer</span> <span class="p">=</span> <span class="nf">GetBestCouple_P__E</span><span class="p">();</span>
<span class="kt">string</span> <span class="n">answer</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">PtrToStringAuto</span><span class="p">(</span><span class="n">pAnswer</span><span class="p">);</span>
</code></pre></div></div>

<h2>
<span id="case-5" class="fragment"></span><a href="#case-5"><i class="fa fa-link"></i></a>Case 5</h2>

<p>ここまでは、文字列をポインタを受け取って、マニュアルでstringにデコードしていました。<br>
<code>MarshalAs</code>を利用することで、直接<strong>string（またはStringBuilder）で受け取る</strong>ことができます。</p>

<p>C#の<code>char</code>はWide文字なので<code>WCHR</code>、<code>string</code>は<code>WCHAR*</code>と互換になります。<br>
（アルファベットを含むほとんどの文字を2byteで表現します、つまり基本的にUTF-16）<br>
<del>そして、C++側のTCHARがWCHARであれば、変換の必要が無いためコピーを回避してポインタだけを受け取れます。（Case 4までより効率的）</del><br>
→ <a href="https://qiita.com/up-hashi/items/1c5717657c6e2aa38698#cotaskmemalloc%E3%81%A8gc">CoTaskMemAllocとGC</a></p>

<blockquote>
<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="n">HRESULT</span> <span class="nf">PassStringRef4</span><span class="p">([</span><span class="k">in</span><span class="p">,</span> <span class="k">out</span><span class="p">]</span> <span class="n">LPWStr</span> <span class="p">*</span><span class="n">s</span><span class="p">);</span> <span class="c1">// C++</span>
<span class="k">void</span> <span class="nf">PassStringRef4</span><span class="p">([</span><span class="nf">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="p">.</span><span class="n">LPWStr</span><span class="p">)]</span> <span class="k">ref</span> <span class="kt">string</span> <span class="n">s</span><span class="p">);</span> <span class="c1">// C#</span>
</code></pre></div></div>

<p><a href="https://docs.microsoft.com/ja-jp/dotnet/framework/interop/default-marshaling-for-strings" rel="nofollow noopener" target="_blank">文字列に対する既定のマーシャリング(MSDN)</a></p>
</blockquote>

<p>上記のようにMSDNで紹介されているように、直接stringで受け取ってみます。<br>
refで書いてありますが、outでも大丈夫です。outにする（＆<code>InAttribute</code>を消す）と、C++側にはnullになって渡ります。<br>
ちなみに<code>LPWStr</code>は「Wide-String(=<code>WCHR*</code>)のlongポインタ」という意味で、TCHARはWCHARになります。（ここでは）<br>
なので<code>TCHAR**</code>=<code>LPWStr*</code>です。</p>

<p>この後に<code>p0</code>と<code>p1</code>の指すメモリを見てみると、<code>p0</code>は元のアドレスで「GynGyn」がそのまま残っています。<br>
一方で、<code>p1</code>はp0とは別のアドレスになっており、「YukaMaki」が書き込まれています。<br>
このことからも、<strong><code>answer</code>が指し示す<code>TCHAR*</code>が変わった</strong>ことがわかります。<br>
（<code>GCHandle.Alloc</code>は、Managedオブジェクトのメモリ位置を固定してポインタを取得します。本当は、<code>GCHandle.Alloc</code>の後は<code>GCHandle.Free</code>する必要があります）</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// HRESULT GetBestCouple(TCHAR** ppAnswer)</span>
<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"D3DVisualization.dll"</span><span class="p">,</span> <span class="n">EntryPoint</span> <span class="p">=</span> <span class="s">"GetBestCouple"</span><span class="p">)]</span>
<span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">GetBestCouple_V_RS_</span><span class="p">([</span><span class="nf">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="p">.</span><span class="n">LPTStr</span><span class="p">),</span> <span class="n">In</span><span class="p">,</span> <span class="n">Out</span><span class="p">]</span> <span class="k">ref</span> <span class="kt">string</span> <span class="n">answer</span><span class="p">);</span>

<span class="kt">string</span> <span class="n">asnwer</span> <span class="p">=</span> <span class="s">"GyunGyun"</span><span class="p">;</span> <span class="c1">// stringの実体はTCHAR*</span>
<span class="n">IntPtr</span> <span class="n">p0</span> <span class="p">=</span> <span class="n">GCHandle</span><span class="p">.</span><span class="nf">Alloc</span><span class="p">(</span><span class="n">asnwer</span><span class="p">,</span> <span class="n">GCHandleType</span><span class="p">.</span><span class="n">Pinned</span><span class="p">).</span><span class="nf">AddrOfPinnedObject</span><span class="p">();</span>
<span class="nf">GetBestCouple_V_RS_</span><span class="p">(</span><span class="k">ref</span> <span class="n">answer</span><span class="p">);</span> <span class="c1">// ref stringは実質TCHAR**</span>
<span class="n">IntPtr</span> <span class="n">p1</span> <span class="p">=</span> <span class="n">GCHandle</span><span class="p">.</span><span class="nf">Alloc</span><span class="p">(</span><span class="n">asnwer</span><span class="p">,</span> <span class="n">GCHandleType</span><span class="p">.</span><span class="n">Pinned</span><span class="p">).</span><span class="nf">AddrOfPinnedObject</span><span class="p">();</span>
<span class="c1">// p0: 0x10B4 "GyunGyun\0\0\0\0\0\0\0\0\0" （上書きされず残っている）</span>
<span class="c1">// p1: 0x2A40 "YukaMaki\0\0\0\0\0\0\0\0\0"</span>
</code></pre></div></div>

<h2>
<span id="case-7" class="fragment"></span><a href="#case-7"><i class="fa fa-link"></i></a>Case 7</h2>

<p>二重でないポインタ版。<br>
一重ポインタを出力引数に取る場合、一般的には<strong>呼び出し側が書き込み先の領域を確保する</strong>ことが期待されます。</p>

<p>もちろん、<code>asnwerBuffer</code>が十分な大きさが無いと、Overflowします。<br>
超巨大な文字列を扱う場合などはこちらの方がいいかもしれません。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// HRESULT GetBestCouple2(TCHAR* pAnswer)</span>
<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"D3DVisualization.dll"</span><span class="p">,</span> <span class="n">EntryPoint</span> <span class="p">=</span> <span class="s">"GetBestCouple2"</span><span class="p">)]</span>
<span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">GetBestCouple_V_S_</span><span class="p">([</span><span class="nf">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="p">.</span><span class="n">LPWStr</span><span class="p">)]</span> <span class="kt">string</span> <span class="n">asnwerBuffer</span><span class="p">);</span>

<span class="kt">string</span> <span class="n">asnwerBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">(</span><span class="sc">'_'</span><span class="p">,</span> <span class="m">16</span><span class="p">);</span> <span class="c1">// 16+1文字分を確保して'_'で埋める</span>
<span class="c1">// answerBuffer: "________________\0"</span>
<span class="nf">GetBestCouple_V_S_</span><span class="p">(</span><span class="n">asnwerBuffer</span><span class="p">);</span> <span class="c1">// answerBufferが確保した領域に上書きする</span>
<span class="c1">// answerBuffer: "YukaMaki\0______\0"</span>
</code></pre></div></div>

<h1>
<span id="cotaskmemallocとgc" class="fragment"></span><a href="#cotaskmemalloc%E3%81%A8gc"><i class="fa fa-link"></i></a><code>CoTaskMemAlloc</code>とGC</h1>

<p><code>CoTaskMemAlloc</code>で確保したメモリは、返却時にシステムによって解放されます。<br>
わかりやすいように、C++側で512M文字（1GB）を確保します。<br>
その後、C#側に制御が戻り、<code>GC.Collect</code>を読んで強制GCを走らせた後、使用メモリ量が急激に減少していることが確認できました。</p>

<p>また、グラフをよくみると、C++で確保した瞬間に1GB、C#に返るときに追加で1GB確保しています。コピーが発生しているように見えます。<code>UnmanagedType</code>を<code>LPSTR</code>や<code>LPWSTR</code>にしたり、<code>PreserveSig=true</code>にしても同じ結果になります。</p>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre class="with-code"><code><span class="n">DLLEXPORT</span> <span class="n">HRESULT</span> <span class="n">WINAPI</span> <span class="nf">Get512MString</span><span class="p">(</span><span class="n">TCHAR</span><span class="o">*&amp;</span> <span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span> <span class="c1">// 512 MB 確保</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCHAR</span><span class="o">*</span><span class="p">)</span><span class="n">CoTaskMemAlloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"YukaMaki"</span><span class="p">),</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">));</span>
    <span class="n">dst</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TEXT</span><span class="p">(</span><span class="sc">'\0'</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">S_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"D3DVisualization.dll"</span><span class="p">,</span> <span class="n">PreserveSig</span> <span class="p">=</span> <span class="k">false</span><span class="p">)]</span>
<span class="p">[</span><span class="k">return</span><span class="p">:</span> <span class="nf">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="p">.</span><span class="n">LPTStr</span><span class="p">)]</span>
<span class="k">static</span> <span class="k">extern</span> <span class="kt">string</span> <span class="nf">Get512MString</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">getCount</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">Test</span><span class="p">().</span><span class="n">Length</span><span class="p">;</span> <span class="c1">// スコープが抜けるように別関数化</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="nf">getCount</span><span class="p">());</span> <span class="c1">// 536870911</span>
<span class="n">GC</span><span class="p">.</span><span class="nf">Collect</span><span class="p">();</span> <span class="n">GC</span><span class="p">.</span><span class="nf">Collect</span><span class="p">();</span>
</code></pre></div></div>

<p>コピーは発生しているけど、最終的にどちらも解放されます。<br>
<a href="https://camo.qiitausercontent.com/fe6366805f154b6d635e6d52ecd780a5cd40d949/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3238303937352f35303532396231392d666134312d666566662d626632392d3261366233366230366439612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F280975%2F50529b19-fa41-feff-bf29-2a6b36b06d9a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=57aec487ba7584a3d0d6c38e1cb024d3" alt="コメント 2020-03-13 030258.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280975/50529b19-fa41-feff-bf29-2a6b36b06d9a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F280975%2F50529b19-fa41-feff-bf29-2a6b36b06d9a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=55e91938c18315b95d2d34adca5aee1f 1x" loading="lazy"></a><br>
<code>Test()</code>の戻り値をメンバにキープしてGCされないようにすると、C++で確保した分だけが解放されます。このことから、コピーされているのは間違いないですね。<br>
<a href="https://camo.qiitausercontent.com/8a5a2f79ef67aac9660a2a5bdbd9ab72c1bdea7c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3238303937352f33373930343564362d623731662d656261362d383763322d3336396132643862626336362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F280975%2F379045d6-b71f-eba6-87c2-369a2d8bbc66.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7ca81d6b81559605233e979960dd4267" alt="コメント 2020-03-13 034752.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280975/379045d6-b71f-eba6-87c2-369a2d8bbc66.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F280975%2F379045d6-b71f-eba6-87c2-369a2d8bbc66.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=61f4afb51cb9a89c48a320365ac62889 1x" loading="lazy"></a></p>

<p>ちなみに、<code>CoTaskMemAlloc</code>のメモリはC#にリターンした時に問答無用で解放されるので、C++側の静的な領域にポインタを確保しておいて、もう一度使おうとすると、アクセス違反でクラッシュします。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>DllImportのために宣言するメソッドは意外と柔軟であることがわかりました。<br>
そもそも、DLLのリンクは<code>extern C</code>なので、関数名しか見ていませんが…（故にオーバーロードとか無理）<br>
型互換以外（ポインタも型ですが）についてまとめましたが、型も結構自由が利き、ユーザ定義のclass/structなんがが使えたりします。<br>
<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.runtime.interopservices.structlayoutattribute?view=netframework-4.8" rel="nofollow noopener" target="_blank">StructLayoutAttribute クラス(MSDN)</a></p>

<p>…とはいえ、DllImportしたメソッドはラップして利用することが推奨されていますし、ここまでの紹介は全てラッパーで解決できることだったりします。</p>

<p>一番ハマったのは、C++でメモリ確保をする部分でした。<br>
<strong><code>CoTaskMemAlloc</code>を使わないと互換化できない</strong>…ということでした。<br>
MarshalAsのMSDNページに書いといてくださいよ…<img alt=":rolling_eyes:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f644.png" title=":rolling_eyes:" width="20" loading="lazy"><br>
ただ、逆に開放はGCでやってくれます。</p>

<p>結論として、余分なコピーは発生しますが、<strong>IntPtrで受け取って<code>Marshal.PtrToStringAuto</code>でデコードするのが一番安定</strong>するような気がします。</p>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<p><a href="http://bbs.wankuma.com/index.cgi?mode=al2&amp;namber=90644&amp;KLOG=156" rel="nofollow noopener" target="_blank">WinAPIからの値の受け取り方について(C# と VB.NET の質問掲示板)</a><br>
<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.runtime.interopservices.preservesigattribute?view=netframework-4.8" rel="nofollow noopener" target="_blank">PreserveSigAttribute クラス(MSDN)</a><br>
<a href="https://docs.microsoft.com/ja-jp/dotnet/framework/interop/default-marshaling-for-strings" rel="nofollow noopener" target="_blank">文字列に対する既定のマーシャリング(MSDN)</a><br>
<a href="https://qiita.com/mitsu_at3/items/94807ee0b3bf34ffb6b2#%E6%96%87%E5%AD%97%E5%88%97%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B" id="reference-c3388c758955eb0124c0">【Windows/C#】なるべく丁寧にDllImportを使う(Qiita)</a><br>
<a href="https://www.atmarkit.co.jp/bbs/phpBB/viewtopic.php?topic=32071&amp;forum=7&amp;start=24" rel="nofollow noopener" target="_blank">DLLから文字列を取得する方法(@IT)</a><br>
<a href="https://www.valuestar.work/news/archives/72" rel="nofollow noopener" target="_blank">C#とCとのやり取りでCから配列変数を渡す例</a><br>
<a href="https://ja.wikipedia.org/wiki/%E3%83%AF%E3%82%A4%E3%83%89%E6%96%87%E5%AD%97" rel="nofollow noopener" target="_blank">ワイド文字(Wikipedia)</a><br>
<a href="https://docs.microsoft.com/ja-jp/dotnet/framework/interop/default-marshaling-behavior#unmanaged-signature" rel="nofollow noopener" target="_blank">既定のマーシャリングの動作 -&gt; アンマネージ シグネチャ（MSDN）</a><br>
<a href="https://krdlab.hatenablog.com/entry/20061211/1165768253" rel="nofollow noopener" target="_blank">P/Invoke時におけるマーシャラの動作（マーシャリング）(KrdLab's blog)</a><br>
<a href="https://www.slideshare.net/UnityTechnologiesJapan/unite-2017-tokyo-75841792" rel="nofollow noopener" target="_blank">【Unite 2017 Tokyo】パフォーマンス向上のためのスクリプトのベストプラクティス (slideshare)</a><br>
<a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-335.pdf" rel="nofollow noopener" target="_blank">Standard ECMA-335 Common Language Infrastructure (CLI) (ECMA)</a></p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fup-hash%2Fitems%2F1c5717657c6e2aa38698&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fup-hash%2Fitems%2F1c5717657c6e2aa38698&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/up-hash/items/1c5717657c6e2aa38698/likers" class="css-1iupg5d">8</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">11</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/1c5717657c6e2aa38698/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/up-hash/items/1c5717657c6e2aa38698/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/up-hash/items/1c5717657c6e2aa38698/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/up-hash/items/1c5717657c6e2aa38698/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/up-hash/items/1c5717657c6e2aa38698.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-aba2e13b-4291-4fa0-91d4-0d30b030f9b5">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-f580a8e4-7256-4f9e-bdf0-429f095549f0"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-f580a8e4-7256-4f9e-bdf0-429f095549f0">{}</script>
      
<div id="LoginModal-react-component-717a59e2-7098-4370-a070-f82d44fdfa5d"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-717a59e2-7098-4370-a070-f82d44fdfa5d">{}</script>
      
<div id="StockModal-react-component-5bb47b2e-da37-4dd9-892d-3a6989f8ae95"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-5bb47b2e-da37-4dd9-892d-3a6989f8ae95">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;AFk4nmhsNDq0Gi2PMPvUy9ZpXsaLAarI0E4JEUaQ2Idr1PSj+X2ffEwEogntxAJrJiPnk+oMTuB0DHgzDcD0Vg==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"tldr\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#tldr\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTL;DR;\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eHRESULT\u003c/strong\u003eと\u003cstrong\u003e例外\u003c/strong\u003eの互換（DllImportに\u003ccode\u003ePreserveSig=false\u003c/code\u003eをつける）\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e出力引数\u003c/strong\u003eを\u003cstrong\u003e戻り値\u003c/strong\u003eに移動（\u003ccode\u003ePreserveSig=false\u003c/code\u003e）\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003erefやout\u003c/strong\u003eを\u003cstrong\u003eポインタ\u003c/strong\u003eと互換\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e文字列ポインタ\u003c/strong\u003eと\u003cstrong\u003estring\u003c/strong\u003eを互換（MarshalAs）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"概要\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e概要\u003c/h1\u003e\n\n\u003cp\u003eC#とC/C++の相互運用といえば、C++/CLI、C++/CX、COM、IPCなどが考えられます。\u003cbr\u003e\nその中でも、\u003ccode\u003eSystem.Runtime.InteropServices.DllImport\u003c/code\u003e（P/Invoke）という機能があります。\u003cbr\u003e\nDllImportは基本的には、C++でExportした関数と同じ関数名で（互換性のある）引数、戻り値のメソッドをC#に宣言し、属性でマークすることで使用できます。\u003cbr\u003e\nしかし、引数や戻り値に関しては\u003cstrong\u003eintなどの型互換だけでなく、参照\u0026lt;-\u0026gt;ポインタ、HRESULT\u0026lt;-\u0026gt;例外など\u003c/strong\u003eの互換も可能です。\u003cbr\u003e\nまた、C言語ではよく見かける出力引数を、一定条件下で戻り値として扱うこともできます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"サンプル\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eサンプル\u003c/h1\u003e\n\n\u003cp\u003e次のようなC++のDLLがあるとします。\u003cbr\u003e\nC言語（Windows）ではよく、戻り値を成否通知に使い、引数に二重ポインタを渡し、ポインタ先に返したいオブジェクトのポインタを書き込みます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 二重ポインタ（本体の確保は呼び出され側）\u003c/span\u003e\n\u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"s\"\u003e\"C\"\u003c/span\u003e \u003cspan class=\"kr\"\u003e__declspec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edllexport\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eHRESULT\u003c/span\u003e \u003cspan class=\"n\"\u003eWINAPI\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTCHAR\u003c/span\u003e\u003cspan class=\"o\"\u003e**\u003c/span\u003e \u003cspan class=\"n\"\u003eppAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// *ppAnswer = TEXT(\"YukaMaki\"); // NG\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// *ppAnswer = new TCHAR[32]; // NG\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// C#に返すメモリはCoTaskMemAllocで確保しないといけない\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eppAnswer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTCHAR\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eCoTaskMemAlloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elstrcpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eppAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTEXT\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"YukaMaki\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eS_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 一重ポインタ（本体の確保は呼び出し側）\u003c/span\u003e\n\u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"s\"\u003e\"C\"\u003c/span\u003e \u003cspan class=\"kr\"\u003e__declspec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edllexport\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eHRESULT\u003c/span\u003e \u003cspan class=\"n\"\u003eWINAPI\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTCHAR\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elstrcpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTEXT\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"YukaMaki\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eS_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eちなみに、これは以下のようなメモリ配置になっています。（\u003ccode\u003esizeof(void*)==4\u003c/code\u003eの場合）\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c11344c5f6481b724116d15c052b610ab3b67b30/68747470733a2f2f646f63732e676f6f676c652e636f6d2f64726177696e67732f642f652f32504143582d317654496c6b5843374732633465444837522d7367792d474a70687337493550546c443639446c7143354d305031356248433774542d427338534777304256474a69593867324f74666f745a6e4742312f7075623f773d37353426683d31383826\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fdocs.google.com%2Fdrawings%2Fd%2Fe%2F2PACX-1vTIlkXC7G2c4eDH7R-sgy-GJphs7I5PTlD69DlqC5M0P15bHC7tT-Bs8SGw0BVGJiY8g2OtfotZnGB1%2Fpub%3Fw%3D754%26h%3D188%26?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=33843e223c13a6540147f5e081579a47\" alt=\"\" data-canonical-src=\"https://docs.google.com/drawings/d/e/2PACX-1vTIlkXC7G2c4eDH7R-sgy-GJphs7I5PTlD69DlqC5M0P15bHC7tT-Bs8SGw0BVGJiY8g2OtfotZnGB1/pub?w=754\u0026amp;h=188\u0026amp;\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fdocs.google.com%2Fdrawings%2Fd%2Fe%2F2PACX-1vTIlkXC7G2c4eDH7R-sgy-GJphs7I5PTlD69DlqC5M0P15bHC7tT-Bs8SGw0BVGJiY8g2OtfotZnGB1%2Fpub%3Fw%3D754%26h%3D188%26?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=3c3f648bce6e686d00c4fe48eae81635 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれを、色々な条件でDLLImportしてみましょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"case-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#case-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCase 1\u003c/h2\u003e\n\n\u003cp\u003e普通に二重ポインタ（\u003ccode\u003eTCHAR**\u003c/code\u003e）を渡し、実態へのポインタを格納しているメモリ領域を、C++側が確保した領域へのポインタに書き換えてもらいます。\u003cbr\u003e\nC#側では二重ポインタ（\u003ccode\u003eTCHAR**\u003c/code\u003e）から\u003ccode\u003eTCHAR*\u003c/code\u003eを取り出して、マーシャラでデコード。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// HRESULT GetBestCouple(TCHAR** ppAnswer)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"D3DVisualization.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEntryPoint\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GetBestCouple\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple_H_PP_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003eppAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 本体A(TCHAR[])へのポインタB(TCHAR*)へ\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// のポインタC(TCHAR**)のBの部分のメモリを確保してCにアドレスを記録\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// TCHAR* pAnswer; // 確保\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// TCHAR** ppAnswer = \u0026amp;pAnswer;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// の操作に相当\u003c/span\u003e\n\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003eppAnswer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAllocHGlobal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ehResult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple_H_PP_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eppAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// TCHAR* pAnswer = *ppAnswer;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// の操作に相当\u003c/span\u003e\n\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eppAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eanswer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePtrToStringAuto\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"case-2\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#case-2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCase 2\u003c/h2\u003e\n\n\u003cp\u003eCase 1と同様の関数を呼び出しているが、C#側がout参照を渡しています。（これはref/in参照でもOK）\u003cbr\u003e\nC#の参照もポインタと同じようなものなので、ポインタの参照、つまり二重ポインタと同様に働きます。\u003cbr\u003e\nそのため、二重ポインタから本体の領域へのポインタを取り出す操作がなくなっています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// HRESULT GetBestCouple(TCHAR** ppAnswer)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"D3DVisualization.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEntryPoint\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GetBestCouple\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple_H_RP_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ehResult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple_H_RP_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eanswer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePtrToStringAuto\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"case-3\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#case-3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCase 3\u003c/h2\u003e\n\n\u003cp\u003eCase 2では戻り値を受け取っていましたが、捨てることも可能。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// HRESULT GetBestCouple(TCHAR** ppAnswer)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"D3DVisualization.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEntryPoint\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GetBestCouple\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple_V_P_E\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eGetBestCouple_V_P_E\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eanswer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePtrToStringAuto\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"case-4\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#case-4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCase 4\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003ePreserveSig=false\u003c/code\u003eを付けることで、HRESULTをC#の例外に変換してくれます。\u003cbr\u003e\n戻り値はなくなりvoidになりますが、代わりに出力引数を戻り値にできます。\u003cbr\u003e\n（Case 3のようにout参照にできるものを変えさせられます。）\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// HRESULT GetBestCouple(TCHAR** ppAnswer)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"D3DVisualization.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEntryPoint\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GetBestCouple\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePreserveSig\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple_P__E\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple_P__E\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eanswer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePtrToStringAuto\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epAnswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"case-5\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#case-5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCase 5\u003c/h2\u003e\n\n\u003cp\u003eここまでは、文字列をポインタを受け取って、マニュアルでstringにデコードしていました。\u003cbr\u003e\n\u003ccode\u003eMarshalAs\u003c/code\u003eを利用することで、直接\u003cstrong\u003estring（またはStringBuilder）で受け取る\u003c/strong\u003eことができます。\u003c/p\u003e\n\n\u003cp\u003eC#の\u003ccode\u003echar\u003c/code\u003eはWide文字なので\u003ccode\u003eWCHR\u003c/code\u003e、\u003ccode\u003estring\u003c/code\u003eは\u003ccode\u003eWCHAR*\u003c/code\u003eと互換になります。\u003cbr\u003e\n（アルファベットを含むほとんどの文字を2byteで表現します、つまり基本的にUTF-16）\u003cbr\u003e\n\u003cdel\u003eそして、C++側のTCHARがWCHARであれば、変換の必要が無いためコピーを回避してポインタだけを受け取れます。（Case 4までより効率的）\u003c/del\u003e\u003cbr\u003e\n→ \u003ca href=\"https://qiita.com/up-hashi/items/1c5717657c6e2aa38698#cotaskmemalloc%E3%81%A8gc\"\u003eCoTaskMemAllocとGC\u003c/a\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eHRESULT\u003c/span\u003e \u003cspan class=\"nf\"\u003ePassStringRef4\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"k\"\u003ein\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLPWStr\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// C++\u003c/span\u003e\n\u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003ePassStringRef4\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"nf\"\u003eMarshalAs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUnmanagedType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLPWStr\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// C#\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/framework/interop/default-marshaling-for-strings\" rel=\"nofollow noopener\" target=\"_blank\"\u003e文字列に対する既定のマーシャリング(MSDN)\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e上記のようにMSDNで紹介されているように、直接stringで受け取ってみます。\u003cbr\u003e\nrefで書いてありますが、outでも大丈夫です。outにする（＆\u003ccode\u003eInAttribute\u003c/code\u003eを消す）と、C++側にはnullになって渡ります。\u003cbr\u003e\nちなみに\u003ccode\u003eLPWStr\u003c/code\u003eは「Wide-String(=\u003ccode\u003eWCHR*\u003c/code\u003e)のlongポインタ」という意味で、TCHARはWCHARになります。（ここでは）\u003cbr\u003e\nなので\u003ccode\u003eTCHAR**\u003c/code\u003e=\u003ccode\u003eLPWStr*\u003c/code\u003eです。\u003c/p\u003e\n\n\u003cp\u003eこの後に\u003ccode\u003ep0\u003c/code\u003eと\u003ccode\u003ep1\u003c/code\u003eの指すメモリを見てみると、\u003ccode\u003ep0\u003c/code\u003eは元のアドレスで「GynGyn」がそのまま残っています。\u003cbr\u003e\n一方で、\u003ccode\u003ep1\u003c/code\u003eはp0とは別のアドレスになっており、「YukaMaki」が書き込まれています。\u003cbr\u003e\nこのことからも、\u003cstrong\u003e\u003ccode\u003eanswer\u003c/code\u003eが指し示す\u003ccode\u003eTCHAR*\u003c/code\u003eが変わった\u003c/strong\u003eことがわかります。\u003cbr\u003e\n（\u003ccode\u003eGCHandle.Alloc\u003c/code\u003eは、Managedオブジェクトのメモリ位置を固定してポインタを取得します。本当は、\u003ccode\u003eGCHandle.Alloc\u003c/code\u003eの後は\u003ccode\u003eGCHandle.Free\u003c/code\u003eする必要があります）\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// HRESULT GetBestCouple(TCHAR** ppAnswer)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"D3DVisualization.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEntryPoint\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GetBestCouple\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple_V_RS_\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"nf\"\u003eMarshalAs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUnmanagedType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLPTStr\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eIn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eOut\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eanswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003easnwer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GyunGyun\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// stringの実体はTCHAR*\u003c/span\u003e\n\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003ep0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGCHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAlloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003easnwer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eGCHandleType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePinned\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddrOfPinnedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eGetBestCouple_V_RS_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003eanswer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ref stringは実質TCHAR**\u003c/span\u003e\n\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003ep1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGCHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAlloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003easnwer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eGCHandleType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePinned\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddrOfPinnedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// p0: 0x10B4 \"GyunGyun\\0\\0\\0\\0\\0\\0\\0\\0\\0\" （上書きされず残っている）\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// p1: 0x2A40 \"YukaMaki\\0\\0\\0\\0\\0\\0\\0\\0\\0\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"case-7\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#case-7\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCase 7\u003c/h2\u003e\n\n\u003cp\u003e二重でないポインタ版。\u003cbr\u003e\n一重ポインタを出力引数に取る場合、一般的には\u003cstrong\u003e呼び出し側が書き込み先の領域を確保する\u003c/strong\u003eことが期待されます。\u003c/p\u003e\n\n\u003cp\u003eもちろん、\u003ccode\u003easnwerBuffer\u003c/code\u003eが十分な大きさが無いと、Overflowします。\u003cbr\u003e\n超巨大な文字列を扱う場合などはこちらの方がいいかもしれません。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// HRESULT GetBestCouple2(TCHAR* pAnswer)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"D3DVisualization.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEntryPoint\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GetBestCouple2\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBestCouple_V_S_\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"nf\"\u003eMarshalAs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUnmanagedType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLPWStr\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003easnwerBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003easnwerBuffer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'_'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e16\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 16+1文字分を確保して'_'で埋める\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// answerBuffer: \"________________\\0\"\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eGetBestCouple_V_S_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003easnwerBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// answerBufferが確保した領域に上書きする\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// answerBuffer: \"YukaMaki\\0______\\0\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"cotaskmemallocとgc\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#cotaskmemalloc%E3%81%A8gc\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eCoTaskMemAlloc\u003c/code\u003eとGC\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode\u003eCoTaskMemAlloc\u003c/code\u003eで確保したメモリは、返却時にシステムによって解放されます。\u003cbr\u003e\nわかりやすいように、C++側で512M文字（1GB）を確保します。\u003cbr\u003e\nその後、C#側に制御が戻り、\u003ccode\u003eGC.Collect\u003c/code\u003eを読んで強制GCを走らせた後、使用メモリ量が急激に減少していることが確認できました。\u003c/p\u003e\n\n\u003cp\u003eまた、グラフをよくみると、C++で確保した瞬間に1GB、C#に返るときに追加で1GB確保しています。コピーが発生しているように見えます。\u003ccode\u003eUnmanagedType\u003c/code\u003eを\u003ccode\u003eLPSTR\u003c/code\u003eや\u003ccode\u003eLPWSTR\u003c/code\u003eにしたり、\u003ccode\u003ePreserveSig=true\u003c/code\u003eにしても同じ結果になります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cpp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eDLLEXPORT\u003c/span\u003e \u003cspan class=\"n\"\u003eHRESULT\u003c/span\u003e \u003cspan class=\"n\"\u003eWINAPI\u003c/span\u003e \u003cspan class=\"nf\"\u003eGet512MString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTCHAR\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003edst\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e512\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 512 MB 確保\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edst\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTCHAR\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eCoTaskMemAlloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTCHAR\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ememcpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edst\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTEXT\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"YukaMaki\"\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e8\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTCHAR\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edst\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTEXT\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'\\0'\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eS_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"D3DVisualization.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePreserveSig\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nf\"\u003eMarshalAs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUnmanagedType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLPTStr\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eGet512MString\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003egetCount\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eTest\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// スコープが抜けるように別関数化\u003c/span\u003e\n\u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003egetCount\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 536870911\u003c/span\u003e\n\u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCollect\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCollect\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eコピーは発生しているけど、最終的にどちらも解放されます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/fe6366805f154b6d635e6d52ecd780a5cd40d949/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3238303937352f35303532396231392d666134312d666566662d626632392d3261366233366230366439612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F280975%2F50529b19-fa41-feff-bf29-2a6b36b06d9a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=57aec487ba7584a3d0d6c38e1cb024d3\" alt=\"コメント 2020-03-13 030258.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280975/50529b19-fa41-feff-bf29-2a6b36b06d9a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F280975%2F50529b19-fa41-feff-bf29-2a6b36b06d9a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=55e91938c18315b95d2d34adca5aee1f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ccode\u003eTest()\u003c/code\u003eの戻り値をメンバにキープしてGCされないようにすると、C++で確保した分だけが解放されます。このことから、コピーされているのは間違いないですね。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/8a5a2f79ef67aac9660a2a5bdbd9ab72c1bdea7c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3238303937352f33373930343564362d623731662d656261362d383763322d3336396132643862626336362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F280975%2F379045d6-b71f-eba6-87c2-369a2d8bbc66.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7ca81d6b81559605233e979960dd4267\" alt=\"コメント 2020-03-13 034752.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280975/379045d6-b71f-eba6-87c2-369a2d8bbc66.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F280975%2F379045d6-b71f-eba6-87c2-369a2d8bbc66.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=61f4afb51cb9a89c48a320365ac62889 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eちなみに、\u003ccode\u003eCoTaskMemAlloc\u003c/code\u003eのメモリはC#にリターンした時に問答無用で解放されるので、C++側の静的な領域にポインタを確保しておいて、もう一度使おうとすると、アクセス違反でクラッシュします。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003eDllImportのために宣言するメソッドは意外と柔軟であることがわかりました。\u003cbr\u003e\nそもそも、DLLのリンクは\u003ccode\u003eextern C\u003c/code\u003eなので、関数名しか見ていませんが…（故にオーバーロードとか無理）\u003cbr\u003e\n型互換以外（ポインタも型ですが）についてまとめましたが、型も結構自由が利き、ユーザ定義のclass/structなんがが使えたりします。\u003cbr\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/api/system.runtime.interopservices.structlayoutattribute?view=netframework-4.8\" rel=\"nofollow noopener\" target=\"_blank\"\u003eStructLayoutAttribute クラス(MSDN)\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e…とはいえ、DllImportしたメソッドはラップして利用することが推奨されていますし、ここまでの紹介は全てラッパーで解決できることだったりします。\u003c/p\u003e\n\n\u003cp\u003e一番ハマったのは、C++でメモリ確保をする部分でした。\u003cbr\u003e\n\u003cstrong\u003e\u003ccode\u003eCoTaskMemAlloc\u003c/code\u003eを使わないと互換化できない\u003c/strong\u003e…ということでした。\u003cbr\u003e\nMarshalAsのMSDNページに書いといてくださいよ…\u003cimg alt=\":rolling_eyes:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/1f644.png\" title=\":rolling_eyes:\" width=\"20\" loading=\"lazy\"\u003e\u003cbr\u003e\nただ、逆に開放はGCでやってくれます。\u003c/p\u003e\n\n\u003cp\u003e結論として、余分なコピーは発生しますが、\u003cstrong\u003eIntPtrで受け取って\u003ccode\u003eMarshal.PtrToStringAuto\u003c/code\u003eでデコードするのが一番安定\u003c/strong\u003eするような気がします。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"参考\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"http://bbs.wankuma.com/index.cgi?mode=al2\u0026amp;namber=90644\u0026amp;KLOG=156\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWinAPIからの値の受け取り方について(C# と VB.NET の質問掲示板)\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/api/system.runtime.interopservices.preservesigattribute?view=netframework-4.8\" rel=\"nofollow noopener\" target=\"_blank\"\u003ePreserveSigAttribute クラス(MSDN)\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/framework/interop/default-marshaling-for-strings\" rel=\"nofollow noopener\" target=\"_blank\"\u003e文字列に対する既定のマーシャリング(MSDN)\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/mitsu_at3/items/94807ee0b3bf34ffb6b2#%E6%96%87%E5%AD%97%E5%88%97%E3%82%92%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B\" id=\"reference-c3388c758955eb0124c0\"\u003e【Windows/C#】なるべく丁寧にDllImportを使う(Qiita)\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://www.atmarkit.co.jp/bbs/phpBB/viewtopic.php?topic=32071\u0026amp;forum=7\u0026amp;start=24\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDLLから文字列を取得する方法(@IT)\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://www.valuestar.work/news/archives/72\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC#とCとのやり取りでCから配列変数を渡す例\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%83%AF%E3%82%A4%E3%83%89%E6%96%87%E5%AD%97\" rel=\"nofollow noopener\" target=\"_blank\"\u003eワイド文字(Wikipedia)\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/framework/interop/default-marshaling-behavior#unmanaged-signature\" rel=\"nofollow noopener\" target=\"_blank\"\u003e既定のマーシャリングの動作 -\u0026gt; アンマネージ シグネチャ（MSDN）\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://krdlab.hatenablog.com/entry/20061211/1165768253\" rel=\"nofollow noopener\" target=\"_blank\"\u003eP/Invoke時におけるマーシャラの動作（マーシャリング）(KrdLab's blog)\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://www.slideshare.net/UnityTechnologiesJapan/unite-2017-tokyo-75841792\" rel=\"nofollow noopener\" target=\"_blank\"\u003e【Unite 2017 Tokyo】パフォーマンス向上のためのスクリプトのベストプラクティス (slideshare)\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-335.pdf\" rel=\"nofollow noopener\" target=\"_blank\"\u003eStandard ECMA-335 Common Language Infrastructure (CLI) (ECMA)\u003c/a\u003e\u003c/p\u003e\n","createdAt":"2020-03-10T19:04:53Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"9LKQH67WP4TFDZWB/1WW24B0FFnhiUh+8A==--31pGLQ9lyTkgkDOn--bpmIAxZeQFXdihv2mvYFng==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-04-04T15:47:42Z","likesCount":8,"linkUrl":"https://qiita.com/up-hash/items/1c5717657c6e2aa38698","organization":null,"originalId":1183325,"stockedCount":11,"title":"【C#】 DllExportでWindowスタイルなAPIをC#風に扱う","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#tldr\"\u003eTL;DR;\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e概要\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB\"\u003eサンプル\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#case-1\"\u003eCase 1\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#case-2\"\u003eCase 2\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#case-3\"\u003eCase 3\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#case-4\"\u003eCase 4\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#case-5\"\u003eCase 5\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#case-7\"\u003eCase 7\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#cotaskmemalloc%E3%81%A8gc\"\u003eCoTaskMemAllocとGC\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83\"\u003e参考\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":2942,"uuid":"1c5717657c6e2aa38698","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"wgtsxSzCGzGhpD8e6Q4TavuxT0fK--bRl5CydRkeJ5/gkf--to9wHVumloNnmGfe9A4iHQ==","originalId":280975,"description":"","facebookUrl":null,"githubUrl":"https://github.com/wallstudio","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://avatars3.githubusercontent.com/u/22035855?v=4","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars3.githubusercontent.com%2Fu%2F22035855%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=6c646513902e31ff724001a013f1c7a3","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars3.githubusercontent.com%2Fu%2F22035855%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=6f6ae227612f84d2d931140a621050cd","urlName":"up-hash","websiteUrl":"https://wallstudio.hateblo.jp/","twitterUrl":"https://twitter.com/yukawallstudio","twitterUrlName":"yukawallstudio","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C++","urlName":"cpp"},{"name":"C#","urlName":"csharp"},{"name":"window","urlName":"window"}],"followingLikers":{"edges":[]},"comments":{"totalCount":9}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
