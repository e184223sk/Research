<!DOCTYPE html><html><head><meta charset="utf-8" /><title>C#からC++のインスタンスメソッドを呼び出す - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/tan-y/items/64711b244cf294d6bb9d" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="PMxJgDxR2N1EUqmUfLeN4Ey+cqL5yv2RCEEUhG6WNU0WV+8cSk1zVEbSAttBMObNOwfTidV+2GqQQmuly7P5RA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="C#からC++のインスタンスメソッドを呼び出す - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReVBqZ1l2amdvbERLeXZqZ2E3amdxVGpnN1BqZ3JuamdyX2pnN1BqZ3Juamc2SGpncjNqZzRQamc0bmpncExsa2J6amdiUGxoN3JqZ1prJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTdkZjNkMTE5MGFmYjZlMGI5ZmE1ZDU2YjBlYmU0NzJl&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSFJoYmkxNSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTkyNmQ5NDY4NzBmNTJkMTFmMjA4Njg5NmU3ZjY0Yzk2&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=27ce05b792f767a69092bbe38840464e"><meta property="og:description" content="

はじめに

これは C# Advent Calendar 2017 の 25 日目の記事です。

C++ で記述したクラスのインスタンスメソッド (インスタンスを生成し、そのインスタンスを指定して実行できるメソッド) を C# か..."><meta content="https://qiita.com/tan-y/items/64711b244cf294d6bb9d" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C++,C#" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-9a20ce16-5074-45c0-85f8-d1bf6df0957f"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Ftan-y%2Fitems%2F64711b244cf294d6bb9d">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Ftan-y%2Fitems%2F64711b244cf294d6bb9d">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-9a20ce16-5074-45c0-85f8-d1bf6df0957f">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/cpp","name":"C++"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2017-11-22T13:58:38.000+09:00","dateModified":"2017-12-25T07:01:14.000+09:00","headline":"C#からC++のインスタンスメソッドを呼び出す","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReVBqZ1l2amdvbERLeXZqZ2E3amdxVGpnN1BqZ3JuamdyX2pnN1BqZ3Juamc2SGpncjNqZzRQamc0bmpncExsa2J6amdiUGxoN3JqZ1prJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTdkZjNkMTE5MGFmYjZlMGI5ZmE1ZDU2YjBlYmU0NzJl\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSFJoYmkxNSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTkyNmQ5NDY4NzBmNTJkMTFmMjA4Njg5NmU3ZjY0Yzk2\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=27ce05b792f767a69092bbe38840464e","mainEntityOfPage":"https://qiita.com/tan-y/items/64711b244cf294d6bb9d","author":{"@type":"Person","address":"","email":null,"identifier":"tan-y","name":"tan-y","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F211064%2Fprofile-images%2F1509545659?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=4f9425460984301e69338c76dc76a942","url":"https://qiita.com/tan-y","description":"最新記事は Zenn / はてなブログで。\r\nhttps://zenn.dev/tan_y\r\nhttps://tan-y.hatenablog.com/","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita&amp;utm_medium=header-banner">常にメンバーが開発しやすい環境を作るNewsPicksの組織作りとは</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"tan-y","type":"items","id":"64711b244cf294d6bb9d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"常にメンバーが開発しやすい環境を作るNewsPicksの組織作りとは","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"tan-y","type":"items","id":"64711b244cf294d6bb9d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"常にメンバーが開発しやすい環境を作るNewsPicksの組織作りとは","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"tan-y","type":"items","id":"64711b244cf294d6bb9d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"常にメンバーが開発しやすい環境を作るNewsPicksの組織作りとは","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/tan-y/items/64711b244cf294d6bb9d","location":"/tan-y/items/64711b244cf294d6bb9d","scheme":"https","host":"qiita.com","port":null,"pathname":"/tan-y/items/64711b244cf294d6bb9d","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"qWXkz83uh46FP9JjkLe0iIBhrZWKgYJxNDRUSSy3oKqD/kJTu/IsB4e/eSytMN+l99gMvqY1p4qsNytoiZJsow==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-a969b7ce-8428-4bbb-a40b-1fb3063a2da3"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/tan-y/items/64711b244cf294d6bb9d/likers" class="css-1iupg5d">36</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">44</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/64711b244cf294d6bb9d/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/tan-y/items/64711b244cf294d6bb9d/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/tan-y/items/64711b244cf294d6bb9d/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/tan-y/items/64711b244cf294d6bb9d/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/tan-y/items/64711b244cf294d6bb9d.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2017/csharp" class="it-AdcalRibbon_title">C#<!-- --> Advent Calendar<!-- --> <!-- -->2017</a>Day 25</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/tan-y"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/211064/profile-images/1509545659" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/tan-y" class="css-10ougpm">@<!-- -->tan-y</a><div class="css-1ay9vb9"><span><meta content="2017-11-22T04:58:38Z"/><time dateTime="2017-12-24T22:01:14Z" class="css-m19uds">updated at 2017-12-24</time></span></div></div></div></div></div><h1 class="css-cgzq40">C#からC++のインスタンスメソッドを呼び出す</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/cpp" class="css-4czcte">C++</a><a href="/tags/csharp" class="css-4czcte">C#</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>これは <a href="https://qiita.com/advent-calendar/2017/csharp">C# Advent Calendar 2017</a> の 25 日目の記事です。</p>

<p>C++ で記述したクラスのインスタンスメソッド (インスタンスを生成し、そのインスタンスを指定して実行できるメソッド) を C# から P/Invoke で呼ぶ方法について書いていきます。  </p>

<p>元々は 1 年ほど前、私が Unity のネイティブプラグインを開発する際に、どうしてもネイティブ側の実装で C++ のクラスを定義し、そのインスタンスを直接 C# 側で管理する構造にしたかったのが発端になります。<br><br>
Unity は Mono であり C++/CLI が使えるわけではなく、かといっていちいち一つずつ関数を export してそれを DllImport で読み込ませるのも面倒。また、考え方としてネイティブ側のリソースを一つのクラスにとりまとめ、生存管理をまとまったインスタンス単位で行った方が自然と思いますが、これをなるべく簡潔に行いたい。</p>

<p>とりあえず調べはしたのですが、これが意外と情報がない。決め手にかけるというか。<br><br>
当時、すでに (大分前から) "CppSharp" というプロジェクトが Mono 管理下で進行していました。</p>

<p><a href="https://github.com/mono/CppSharp" rel="nofollow noopener" target="_blank">GitHub - mono/CppSharp: Tools and libraries to glue C/C++ APIs to high-level languages</a></p>

<p>ただ、いろいろ試す時間もなく、元々自前でやる方法のイメージがもやっとしてはいたもののあったので、自力でなんとかする方向で進めて最終的に解決しました。</p>

<p>Windows で .NET Framework のみ、であれば C++/CLI は現状ベストなのですが、昨今はそうも言っていられない雰囲気が結構していますので、 C++/CLI に頼らない方法を把握しておくことはよいことかと思います。</p>

<p>この記事を作成するにあたって、コンパイラの挙動ベースではなく標準化ドキュメントなどをちゃんと調べた上で作成したかったのですが調べきることができてなく、挙動ベースになってしまっているところも多々ありますがご了承ください。</p>

<p>サンプルプログラムは Visual Studio 2017 (C# + Visual C++) で実装しています。パターン 2 については C# 側は Mono でもそのままいけるはずです。 C++ 側は極力 VC++ 依存しないように配慮しましたが、 dllexport がらみで VC++ 固有命令を使ってしまっていますので適宜読み替えてください。</p>

<p>記事をなるべく短くするため、コードの引用は歯抜けになっています。 GitHub に完全版を上げていますのでそちらも合わせて読んでください。</p>

<p>サンプル: <a href="https://github.com/aosoft/CppInvokeSample" rel="nofollow noopener" target="_blank">aosoft/CppInvokeSample</a></p>

<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p>.NET のマネージドコードから一般的に言ういわゆるプラットフォームのネイティブコードを呼び出す場合、</p>

<ul>
<li>P/Invoke 機能を利用する。</li>
<li>C++/CLI で混在コードを記述し、 C++ のマネージドコードから呼び出す。 (C++ interop)</li>
<li>RCW (Runtime Callable Wrapper) で COM を呼び出す。</li>
</ul>

<p>のどれかになります。<br>
このうち P/Invoke が一番利用できる可能性が高い方法です。</p>

<p>P/Invoke はランタイムに実装されている言語非依存の機能であり、どの .NET 言語からも使用することができます。しかし、突き詰めるとこれは C 言語互換の関数を呼び出すだけの機能であり、 C 言語スタイルの Win32 API を呼び出すだけであれば十分ですが、本件の目的のように C++ のインスタンスメソッドを単純に呼ぶことはできません。</p>

<p>C++ のインスタンスメソッドを呼ぶとはどういうことか。これは実際には通常の C 言語の関数を実行するのと変わりません。違いは "暗黙の見えない第一引数に this ポインタが入っている" ということだけです。雰囲気で言えば下記のような感じ。</p>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">Calc</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">);</span>               <span class="c1">// (a)</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">Calc_Add</span><span class="p">(</span><span class="n">Calc</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">);</span>  <span class="c1">// (b)</span>

<span class="n">Sum</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Calc</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>      <span class="c1">// (a)</span>
<span class="kt">int</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">Calc_Add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// (b)</span>
</code></pre></div></div>

<p>ということは C++ のインスタンスメソッドは</p>

<ol>
<li>インスタンスのポインタ (this ポインタ) を取得</li>
<li>パラメーターにインスタンスポインタを追加して P/Invoke で呼び出す</li>
</ol>

<p>とすれば C# から P/Invoke でインスタンスメソッドの実行をすることが実現できます。</p>

<h1>
<span id="目標" class="fragment"></span><a href="#%E7%9B%AE%E6%A8%99"><i class="fa fa-link"></i></a>目標</h1>

<p>下記のネイティブクラスがあったとして</p>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">CppSample</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="kt">int32_t</span> <span class="n">m_value</span><span class="p">;</span>

<span class="nl">public:</span>
    <span class="n">CppSample</span><span class="p">();</span>
    <span class="kt">int32_t</span> <span class="n">GetCurrentValue</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">Add</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">Sub</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">int32_t</span> <span class="n">AppendChars</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chars</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">length</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">PrintChars</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div></div>

<p>C++/CLI では下記のようなラッパーの実装をしますが、これを C# で記述する事を目標とします。<br><br>
(null チェックがあまいですが、例のためです)</p>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre class="with-code"><code><span class="n">ref</span> <span class="k">class</span> <span class="nc">CppSampleWrapper</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="n">CppSample</span> <span class="o">*</span><span class="n">m_native</span><span class="p">;</span>

<span class="nl">public:</span>
    <span class="n">CppSampleWrapper</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">m_native</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CppSample</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="o">~</span><span class="n">CppSampleWrapper</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">delete</span> <span class="n">m_native</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">System</span><span class="o">::</span><span class="n">Int32</span> <span class="n">GetCurrentValue</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">m_native</span><span class="o">-&gt;</span><span class="n">GetCurrentValue</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">Add</span><span class="p">(</span><span class="n">System</span><span class="o">::</span><span class="n">Int32</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_native</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>

<span class="c1">//</span>
<span class="c1">//  以下略</span>
<span class="c1">//</span>
<span class="p">};</span>
</code></pre></div></div>

<h1>
<span id="実践" class="fragment"></span><a href="#%E5%AE%9F%E8%B7%B5"><i class="fa fa-link"></i></a>実践</h1>

<h2>
<span id="c-クラスを定義する" class="fragment"></span><a href="#c-%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>C++ クラスを定義する</h2>

<p>C# からの呼び出しパターンを 2 つ紹介します。どちらもネイティブ C++ 側の定義は共通です。</p>

<p>まずメソッド定義だけをした抽象クラスを定義します。</p>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">ICppSample</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Destroy</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="kt">int32_t</span> <span class="n">GetCurrentValue</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">//  以下略</span>
<span class="p">};</span>
</code></pre></div></div>

<p>ここでのポイントは "必ずインスタンスを破棄するメソッド (ここでは Destroy)" を定義すること。 C# 側に管理を全て任せる形にするので、任意のタイミングで破棄できるようにするために破棄メソッドは必ず定義します。<br><br>
ちなみにクラス名の先頭が I から始まっているのは "pure virtual のみの抽象クラスをインターフェースとする" というオレオレルールのためです。  </p>

<p>合わせて、これを実装する CppSample クラスを定義します。 Destroy は delete this; をするだけの実装をします。</p>

<h2>
<span id="パターン-1-windows-特定プラットフォーム-に決め打ちする" class="fragment"></span><a href="#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-1-windows-%E7%89%B9%E5%AE%9A%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0-%E3%81%AB%E6%B1%BA%E3%82%81%E6%89%93%E3%81%A1%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>パターン 1: Windows (特定プラットフォーム) に決め打ちする</h2>

<p>こちらは "C++ の都合に C# を合わせる" パターンになります。</p>

<p>結論から言えばインスタンスのポインターから vtable を引きずり出して、その関数ポインターから Marshal.GetDelegateForFunctionPointer で delegate を作る、ということになります。<br><br>
インスタンスに vtable が含まれている事が大前提になりますので、必ず仮想メソッドによる定義が必要になります。</p>

<p>まず C++ 側にインスタンス生成する C の関数を実装します。</p>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre class="with-code"><code><span class="k">extern</span> <span class="s">"C"</span> <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">ICppSample</span> <span class="o">*</span><span class="n">STDMETHODCALLTYPE</span> <span class="nf">CreateCppSampleInstance</span><span class="p">()</span> <span class="k">try</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">CppSample</span><span class="p">();</span>
<span class="err">}</span> <span class="k">catch</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>単純に new するだけです。 imoprt する C# 側の定義は</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"CppInvokeSampleDLL.dll"</span><span class="p">,</span> <span class="n">CallingConvention</span> <span class="p">=</span> <span class="n">CallingConvention</span><span class="p">.</span><span class="n">Winapi</span><span class="p">)]</span>
<span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">CreateCppSampleInstance</span><span class="p">();</span>
</code></pre></div></div>

<p>です。これを C# 側から呼び出すと IntPtr の戻り値に C++ のインスタンスポインターが入っています。</p>

<p>インスタンスポインターの示す先にそのインスタンスが保持している全ての情報が含まれているわけですが、ではどうやって vtable を引きずり出すか、になるのですが C++ ABI は規定がないらしく、コンパイラ (プラットフォーム) 依存になるようです。今回は VC++ でのレイアウトで取得してみます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="n">_self</span> <span class="p">=</span> <span class="nf">CreateCppSampleInstance</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">funcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">IntPtr</span><span class="p">[</span><span class="m">6</span><span class="p">];</span>
<span class="n">Marshal</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">Marshal</span><span class="p">.</span><span class="nf">ReadIntPtr</span><span class="p">(</span><span class="n">_self</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> <span class="n">funcs</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">funcs</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
</code></pre></div></div>

<p>まずマジックナンバー 6 ですが、これは 6 個メソッドがあると C++ 側の定義を知っているからです。<br><br>
そして Marshal.Copy を使ってポインターから関数テーブルの内容をコピーします。インスタンスポインターの先頭に関数テーブルへのポインターが入っているのでここからコピーします。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="nf">UnmanagedFunctionPointer</span><span class="p">(</span><span class="n">CallingConvention</span><span class="p">.</span><span class="n">ThisCall</span><span class="p">)]</span>
<span class="k">delegate</span> <span class="k">void</span> <span class="nf">FnAction</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">self</span><span class="p">);</span>

<span class="p">[</span><span class="nf">UnmanagedFunctionPointer</span><span class="p">(</span><span class="n">CallingConvention</span><span class="p">.</span><span class="n">ThisCall</span><span class="p">)]</span>
<span class="k">delegate</span> <span class="k">void</span> <span class="nf">FnCalc</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="k">value</span><span class="p">);</span>

<span class="n">_fnDestroy</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">&lt;</span><span class="n">FnAction</span><span class="p">&gt;(</span><span class="n">funcs</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
<span class="n">_fnAdd</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">&lt;</span><span class="n">FnCalc</span><span class="p">&gt;(</span><span class="n">funcs</span><span class="p">[</span><span class="m">2</span><span class="p">]);</span>
</code></pre></div></div>

<p>GetDelegateForFunctionPointer で delegate を生成します。 GetDelegateForFunctionPointer は generic delegate が指定できないので一つずつ delegate を定義します。この際、 CallingConvention で ThisCall を指定しておきます。インスタンスメソッドは VC++ では通常は thiscall という呼び出し規約になっているのでそれに合わせておきます。<br><br>
また、暗黙指定だった this ポインターをここでは明示的に指定する必要がありますので全ての定義の第一引数に IntPtr を付けます。他は通常の P/Invoke 指定と同じです。</p>

<p>ラッパーのメソッドは次のようになります。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">_fnDestroy</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">_self</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">_fnAdd</span><span class="p">(</span><span class="n">_self</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>破棄メソッドは .NET の一般的作法に則り、 IDisposable を実装するのがよいでしょう。</p>

<p>delegate の呼び出しには控えておいた this ポインタを合わせて指定します。</p>

<h2>
<span id="パターン-2-安全策" class="fragment"></span><a href="#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-2-%E5%AE%89%E5%85%A8%E7%AD%96"><i class="fa fa-link"></i></a>パターン 2: 安全策</h2>

<p>パターン 1 とは逆で "C# の都合に C++ を合わせる" パターンになります。</p>

<p>パターン 1 の問題は C++ ABI のレイアウトにアドレスベースで直接さわらなくてはいけないことです。C++ 側でメソッドを一つ追加した場合、関数テーブルのインデックスがずれるかもしれません。また、継承などでテーブル自体が変わってしまうことも考えられます。 C++ ABI の互換性問題により C# 側の実装をプラットフォーム毎に用意しなくてはいけなくなるかもしれません。</p>

<p>これらの問題を回避するため、コンパイラが自動で作る vtable を直接使うのではなく、自前で関数テーブルを用意するのがこのパターンになります。</p>

<p>今回の C++ 側に定義するインスタンス生成関数は次のようになります。</p>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre class="with-code"><code><span class="k">extern</span> <span class="s">"C"</span> <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">int32_t</span> <span class="n">STDMETHODCALLTYPE</span> <span class="nf">CreateCppSampleInstance2</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">bufferSize</span><span class="p">);</span>
</code></pre></div></div>

<p>引数経由でポインター配列を渡します。ポインター配列の 0 番に this ポインター、それ以降に関数ポインターを設定していきます。</p>

<p>次に関数ポインターのテーブルを作ります。ここで問題となるのが <strong>インスタンスメソッドのポインターは通常のポインター (void *) とキャストができない</strong> ということです。<br><br>
そこで void * にキャストができる C 言語スタイルの関数に変換します。つまり</p>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre class="with-code"><code><span class="kt">int32_t</span> <span class="nf">CppSample_Add</span><span class="p">(</span><span class="n">ICppSample</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>として CppSample_Add を関数ポインターとします。これを全てのメソッドでいちいち実装すると面倒くさいので C++ のテンプレートを利用します。</p>

<div class="code-frame" data-lang="cpp"><div class="highlight"><pre class="with-code"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">RetT</span><span class="p">,</span> <span class="k">typename</span> <span class="o">...</span> <span class="nc">Args</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">Proxy</span>
<span class="p">{</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">RetT</span><span class="p">(</span><span class="n">T</span><span class="o">::*</span><span class="n">func</span><span class="p">)(</span><span class="n">Args</span><span class="p">...)&gt;</span>
    <span class="k">static</span> <span class="n">RetT</span> <span class="n">STDMETHODCALLTYPE</span> <span class="n">Func</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;*</span><span class="n">func</span><span class="p">)(</span><span class="n">args</span><span class="p">...);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">funcs</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="n">Proxy</span><span class="o">&lt;</span><span class="n">ICppSample</span><span class="p">,</span> <span class="kt">void</span><span class="o">&gt;::</span><span class="n">Func</span><span class="o">&lt;&amp;</span><span class="n">ICppSample</span><span class="o">::</span><span class="n">Destroy</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Proxy</span><span class="o">&lt;</span><span class="n">ICppSample</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;::</span><span class="n">Func</span><span class="o">&lt;&amp;</span><span class="n">ICppSample</span><span class="o">::</span><span class="n">GetCurrentValue</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">Proxy</span><span class="o">&lt;</span><span class="n">ICppSample</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">&gt;::</span><span class="n">Func</span><span class="o">&lt;&amp;</span><span class="n">ICppSample</span><span class="o">::</span><span class="n">Add</span><span class="o">&gt;</span><span class="p">,</span>
<span class="c1">//  略</span>
<span class="p">};</span>
</code></pre></div></div>

<p>テンプレート内の Func メソッドが C# 側に直接公開するメソッドになるので呼び出し規約として STDMETHODCALLTYPE をつけておきます。これも C# の都合に合わせる一環です。</p>

<p>C# 側はパターン 1 と大体同じ。配列で取得したインスタンスポインターと関数ポインターから delegate を準備し、実行時はインスタンスポインターを付与して delegate を実行します。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">delegate</span> <span class="k">void</span> <span class="nf">FnAction</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">self</span><span class="p">);</span>
<span class="k">delegate</span> <span class="k">void</span> <span class="nf">FnCalc</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="k">value</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">bufferSize</span> <span class="p">=</span> <span class="nf">CreateCppSampleInstance2</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">IntPtr</span><span class="p">[</span><span class="n">bufferSize</span><span class="p">];</span>
<span class="nf">CreateCppSampleInstance2</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">);</span>

<span class="n">_self</span> <span class="p">=</span> <span class="n">buffer</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
<span class="n">_fnDestroy</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">&lt;</span><span class="n">FnAction</span><span class="p">&gt;(</span><span class="n">buffer</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
<span class="n">_fnAdd</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">&lt;</span><span class="n">FnCalc</span><span class="p">&gt;(</span><span class="n">buffer</span><span class="p">[</span><span class="m">3</span><span class="p">]);</span>
</code></pre></div></div>

<p>パターン 1 との比較ですが delegate 宣言で CallingConvention をつけていません。 C++ 側で STDMETHODCALLTYPE をつけたので省略できるようになりました。</p>

<p>CreateCppSampleInstance2 は引数にバッファを指定しますが、バッファを null 指定すると必要サイズを返す実装にしたのでこのような手続きでポインターリストを取得します。 0 番に this ポインターが入り、関数ポインターは 1 からになるのでパターン 1 と比較して 1 ずつずれます。</p>

<p>パターン 1 との違いはここまでで、実際の使い方は同じです。</p>

<h2>
<span id="呼び出してみる" class="fragment"></span><a href="#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>呼び出してみる</h2>

<p>呼び出す側からは普通の C# のクラスです。 IDisposable 実装になっているのだけ注意。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cpp1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CppSample1</span><span class="p">())</span>
<span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cpp2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CppSample2</span><span class="p">())</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">cpp1</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">cpp1</span><span class="p">.</span><span class="nf">GetCurrentValue</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Length = {0}"</span><span class="p">,</span> <span class="n">cpp1</span><span class="p">.</span><span class="nf">AppendChars</span><span class="p">(</span><span class="s">"Hello,"</span><span class="p">));</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Length = {0}"</span><span class="p">,</span> <span class="n">cpp1</span><span class="p">.</span><span class="nf">AppendChars</span><span class="p">(</span><span class="s">"CppSample1!"</span><span class="p">));</span>
    <span class="n">cpp1</span><span class="p">.</span><span class="nf">PrintChars</span><span class="p">();</span>

    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">cpp2</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">cpp2</span><span class="p">.</span><span class="nf">GetCurrentValue</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Length = {0}"</span><span class="p">,</span> <span class="n">cpp2</span><span class="p">.</span><span class="nf">AppendChars</span><span class="p">(</span><span class="s">"Hello,"</span><span class="p">));</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Length = {0}"</span><span class="p">,</span> <span class="n">cpp2</span><span class="p">.</span><span class="nf">AppendChars</span><span class="p">(</span><span class="s">"CppSample2!"</span><span class="p">));</span>
    <span class="n">cpp2</span><span class="p">.</span><span class="nf">PrintChars</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>結果:</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>CppSample::Create
CppSample::Create
10
20
30
40
50
Length = 6
Length = 17
[02C69728] Hello,CppSample1!

-5
-10
-15
-20
-25
Length = 6
Length = 17
[02C69778] Hello,CppSample2!
CppSample::Destroy [02C69778]
CppSample::Destroy [02C69728]
</code></pre></div></div>

<p>C++ の CppSample::PrintChars, Destroy では this ポインタの値をコンソールに出力するようにしています。<br><br>
CppSample1 と CppSample2 でそれぞれ内部的には違うインスタンスになっていることが確認できます。</p>

<h2>
<span id="比較" class="fragment"></span><a href="#%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>比較</h2>

<table>
<thead>
<tr>
<th style="text-align: center"></th>
<th style="text-align: center">パターン 1</th>
<th style="text-align: center">パターン 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">ABI</td>
<td style="text-align: center">C++ 言語</td>
<td style="text-align: center">C 言語相当</td>
</tr>
<tr>
<td style="text-align: center">パフォーマンス</td>
<td style="text-align: center">----</td>
<td style="text-align: center">若干遅い (誤差)</td>
</tr>
<tr>
<td style="text-align: center">記述量</td>
<td style="text-align: center">少ない</td>
<td style="text-align: center">若干多い (テーブルを自前で作るから)</td>
</tr>
<tr>
<td style="text-align: center">ミス発生率</td>
<td style="text-align: center">高い。危険。</td>
<td style="text-align: center">低い。エラーは事前にわかる可能性が高い</td>
</tr>
</tbody>
</table>

<ul>
<li>パターン 1

<ul>
<li>C++ のクラスに直接アクセスしているので、踏み台を入れているパターン 2 より実行時のステップ数が確実に少ないです。

<ul>
<li>しかし、そのメリットは実際は有意な差を生むとは考えにくい。 1 秒に何万回もコールするとかならともかくですが、高頻度に .NET - ネイティブ間の呼び出しをする事がそもそも間違ってると思います。</li>
</ul>
</li>
<li>C++ 側の定義変更によりテーブル時代の構造が意図せず変わってしまう可能性もあり危険度が高いです。</li>
</ul>
</li>
<li>パターン 2

<ul>
<li>踏み台が入る分、パフォーマンスは若干劣ります。</li>
<li>関数テーブルを手作業で作るのが面倒。

<ul>
<li>テンプレートを駆使することで手間を最小限に抑えています。</li>
</ul>
</li>
<li>関数テーブルによるメリットが大きい。

<ul>
<li>C++ ABI に直接触るわけではなく、シンプルな C 関数アクセスになります。 C++ の呼び出し規約もネイティブ側に隠蔽され配慮不要に。 </li>
<li>明示的に作成することで、メソッドの順番変更や追加でインデックスが変わっても影響がありません。</li>
<li>削除や引数の変更があってもコンパイルエラーになるので事前に確認ができ、アクセス違反等の問題が起きる可能性が低い。</li>
</ul>
</li>
<li>リスト生成に C++ の言語機能のみを使用しているのでポータビリティが高い。</li>
</ul>
</li>
</ul>

<p>パターン 2 は結局 C 言語の関数を定義しているので一つずつ DllImport でやるのと実質差異はないように思われるかもしれませんが、テンプレート＋関数テーブルにすることで C++ 側に踏み台関数とその dllexport の定義をいちいち書かなくてよいのは大きなメリットです。</p>

<p>パターン 1 は CppSharp のような自動生成であれば (生成処理な問題がなけれぱ) 安全ですのでよいと思いますが、手作業で行うにはあまりにリスクが大きいので CppSharp のようなツールを頼らないのであればパターン 2 の方がよいのではないかと思います。</p>

<h1>
<span id="余談-呼び出し規約について" class="fragment"></span><a href="#%E4%BD%99%E8%AB%87-%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E8%A6%8F%E7%B4%84%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>余談: 呼び出し規約について</h1>

<ul>
<li>.NET でネイティブコードを呼び出す際のデフォルトは CallingConvention.Winapi です。 Winapi となっていますが、これはプラットフォームの標準的な呼び出し規約に従う、の意味です。 Windows では StdCall ですがそれ以外は大体 Cdecl になっています。つまり CallingConvertion は通常は明示指定する必要はありません。 Windows で C ランタイムの関数を直接呼ぶ時とか？</li>
<li>VC++ の場合、 C++ のインスタンスメソッドの呼び出し規約はデフォルトで thiscall を使用しますが、明示的に指定する事も可能です。つまり STDMETHODCALLTYPE を指定すれば C++ メソッドでも stdcall になり、 CppSample1 で CallingConvertion.ThisCall の指定をする必要がなくなります (というかしてはダメ) 。 Windows の COM はまさにこのパターンですね。</li>
</ul>

<p>呼び出し規約はこちらも: <a href="https://qiita.com/tan-y/items/81b056e01a11515c4c22" id="reference-4bfe55b88ced7f28cc9c">C/C++ の呼び出し規約を再確認する</a></p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>本当は C++/CLI が進化していって、 Mono など他の .NET 向け、プラットフォーム向けのバイナリがビルドできるようになっていくのがよかったのですが、 VS2017 では C++/CLI はオプションになり、そもそも機能拡張が全くされてこなかった (振り返って考えてみると VS2010 で .NET 4 対応はしたもののそれで終わりで機能拡張はそれ以後も含めて何もなかったような・・・) 状況でこのままフェードアウト確定かなあと思われます。WinRT で追加された C++/CX も廃止してテンプレートライブラリによる C++/WinRT を代替にするようです。 C++ AMP もなあ・・・</p>

<p>マイクロソフトは C++ の言語仕様は標準準拠で独自拡張はやめ、拡張はクラスライブラリで行うという非常に真っ当な方針になったように見えます。これ自体は歓迎こそすれ非難をする要素など全くないのですが C++/CLI はマネージドとネイティブをシームレスに混在できる唯一の言語だったのでなくなってしまうと困るなあと思ってしまいます。</p>

<p>そういうわけで C++/CLI に頼らずに C++ interop (相当) を実現する方法は今後重要性が増していくと思います。<br><br>
CppSharp が安定して使えるようになればそれを使っていけばよいと思いますが、手作業でも可能であることを示せたと思います。参考にしていただければと思います。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Ftan-y%2Fitems%2F64711b244cf294d6bb9d&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Ftan-y%2Fitems%2F64711b244cf294d6bb9d&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/tan-y/items/64711b244cf294d6bb9d/likers" class="css-1iupg5d">36</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">44</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/64711b244cf294d6bb9d/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/tan-y/items/64711b244cf294d6bb9d/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/tan-y/items/64711b244cf294d6bb9d/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/tan-y/items/64711b244cf294d6bb9d/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/tan-y/items/64711b244cf294d6bb9d.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-a969b7ce-8428-4bbb-a40b-1fb3063a2da3">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-e7f5ca84-f6c2-46d0-868b-27560c7364b6"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-e7f5ca84-f6c2-46d0-868b-27560c7364b6">{}</script>
      
<div id="LoginModal-react-component-b640a188-7cad-41f0-9445-f815e778da96"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-b640a188-7cad-41f0-9445-f815e778da96">{}</script>
      
<div id="StockModal-react-component-426b0759-1f5f-4966-a122-156415fd6d1a"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-426b0759-1f5f-4966-a122-156415fd6d1a">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;1EcZocwqccJ4sbCCP6SZ/qR1k52D5PsakeDR6bjL7qL+3L89ujbaS3oxG80CI/LT08wytq9Q3uEJ467IHe4iqw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003eこれは \u003ca href=\"https://qiita.com/advent-calendar/2017/csharp\"\u003eC# Advent Calendar 2017\u003c/a\u003e の 25 日目の記事です。\u003c/p\u003e\n\n\u003cp\u003eC++ で記述したクラスのインスタンスメソッド (インスタンスを生成し、そのインスタンスを指定して実行できるメソッド) を C# から P/Invoke で呼ぶ方法について書いていきます。  \u003c/p\u003e\n\n\u003cp\u003e元々は 1 年ほど前、私が Unity のネイティブプラグインを開発する際に、どうしてもネイティブ側の実装で C++ のクラスを定義し、そのインスタンスを直接 C# 側で管理する構造にしたかったのが発端になります。\u003cbr\u003e\u003cbr\u003e\nUnity は Mono であり C++/CLI が使えるわけではなく、かといっていちいち一つずつ関数を export してそれを DllImport で読み込ませるのも面倒。また、考え方としてネイティブ側のリソースを一つのクラスにとりまとめ、生存管理をまとまったインスタンス単位で行った方が自然と思いますが、これをなるべく簡潔に行いたい。\u003c/p\u003e\n\n\u003cp\u003eとりあえず調べはしたのですが、これが意外と情報がない。決め手にかけるというか。\u003cbr\u003e\u003cbr\u003e\n当時、すでに (大分前から) \"CppSharp\" というプロジェクトが Mono 管理下で進行していました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/mono/CppSharp\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGitHub - mono/CppSharp: Tools and libraries to glue C/C++ APIs to high-level languages\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eただ、いろいろ試す時間もなく、元々自前でやる方法のイメージがもやっとしてはいたもののあったので、自力でなんとかする方向で進めて最終的に解決しました。\u003c/p\u003e\n\n\u003cp\u003eWindows で .NET Framework のみ、であれば C++/CLI は現状ベストなのですが、昨今はそうも言っていられない雰囲気が結構していますので、 C++/CLI に頼らない方法を把握しておくことはよいことかと思います。\u003c/p\u003e\n\n\u003cp\u003eこの記事を作成するにあたって、コンパイラの挙動ベースではなく標準化ドキュメントなどをちゃんと調べた上で作成したかったのですが調べきることができてなく、挙動ベースになってしまっているところも多々ありますがご了承ください。\u003c/p\u003e\n\n\u003cp\u003eサンプルプログラムは Visual Studio 2017 (C# + Visual C++) で実装しています。パターン 2 については C# 側は Mono でもそのままいけるはずです。 C++ 側は極力 VC++ 依存しないように配慮しましたが、 dllexport がらみで VC++ 固有命令を使ってしまっていますので適宜読み替えてください。\u003c/p\u003e\n\n\u003cp\u003e記事をなるべく短くするため、コードの引用は歯抜けになっています。 GitHub に完全版を上げていますのでそちらも合わせて読んでください。\u003c/p\u003e\n\n\u003cp\u003eサンプル: \u003ca href=\"https://github.com/aosoft/CppInvokeSample\" rel=\"nofollow noopener\" target=\"_blank\"\u003eaosoft/CppInvokeSample\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"概要\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e概要\u003c/h1\u003e\n\n\u003cp\u003e.NET のマネージドコードから一般的に言ういわゆるプラットフォームのネイティブコードを呼び出す場合、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eP/Invoke 機能を利用する。\u003c/li\u003e\n\u003cli\u003eC++/CLI で混在コードを記述し、 C++ のマネージドコードから呼び出す。 (C++ interop)\u003c/li\u003e\n\u003cli\u003eRCW (Runtime Callable Wrapper) で COM を呼び出す。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eのどれかになります。\u003cbr\u003e\nこのうち P/Invoke が一番利用できる可能性が高い方法です。\u003c/p\u003e\n\n\u003cp\u003eP/Invoke はランタイムに実装されている言語非依存の機能であり、どの .NET 言語からも使用することができます。しかし、突き詰めるとこれは C 言語互換の関数を呼び出すだけの機能であり、 C 言語スタイルの Win32 API を呼び出すだけであれば十分ですが、本件の目的のように C++ のインスタンスメソッドを単純に呼ぶことはできません。\u003c/p\u003e\n\n\u003cp\u003eC++ のインスタンスメソッドを呼ぶとはどういうことか。これは実際には通常の C 言語の関数を実行するのと変わりません。違いは \"暗黙の見えない第一引数に this ポインタが入っている\" ということだけです。雰囲気で言えば下記のような感じ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cpp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCalc\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e               \u003cspan class=\"c1\"\u003e// (a)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalc_Add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCalc\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// (b)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eSum\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalc\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ec1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// (a)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ec2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCalc_Add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// (b)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eということは C++ のインスタンスメソッドは\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eインスタンスのポインタ (this ポインタ) を取得\u003c/li\u003e\n\u003cli\u003eパラメーターにインスタンスポインタを追加して P/Invoke で呼び出す\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eとすれば C# から P/Invoke でインスタンスメソッドの実行をすることが実現できます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"目標\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%9B%AE%E6%A8%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e目標\u003c/h1\u003e\n\n\u003cp\u003e下記のネイティブクラスがあったとして\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cpp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCppSample\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"nl\"\u003eprivate:\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003em_value\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"nl\"\u003epublic:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCppSample\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003eGetCurrentValue\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eSub\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003eAppendChars\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003echars\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003ePrintChars\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eC++/CLI では下記のようなラッパーの実装をしますが、これを C# で記述する事を目標とします。\u003cbr\u003e\u003cbr\u003e\n(null チェックがあまいですが、例のためです)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cpp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eref\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCppSampleWrapper\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"nl\"\u003eprivate:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCppSample\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003em_native\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"nl\"\u003epublic:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCppSampleWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_native\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eCppSample\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"o\"\u003e~\u003c/span\u003e\u003cspan class=\"n\"\u003eCppSampleWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003edelete\u003c/span\u003e \u003cspan class=\"n\"\u003em_native\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInt32\u003c/span\u003e \u003cspan class=\"n\"\u003eGetCurrentValue\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003em_native\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGetCurrentValue\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInt32\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_native\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//  以下略\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実践\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%B7%B5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実践\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"c-クラスを定義する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#c-%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eC++ クラスを定義する\u003c/h2\u003e\n\n\u003cp\u003eC# からの呼び出しパターンを 2 つ紹介します。どちらもネイティブ C++ 側の定義は共通です。\u003c/p\u003e\n\n\u003cp\u003eまずメソッド定義だけをした抽象クラスを定義します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cpp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eICppSample\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"nl\"\u003epublic:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003eGetCurrentValue\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//  以下略\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここでのポイントは \"必ずインスタンスを破棄するメソッド (ここでは Destroy)\" を定義すること。 C# 側に管理を全て任せる形にするので、任意のタイミングで破棄できるようにするために破棄メソッドは必ず定義します。\u003cbr\u003e\u003cbr\u003e\nちなみにクラス名の先頭が I から始まっているのは \"pure virtual のみの抽象クラスをインターフェースとする\" というオレオレルールのためです。  \u003c/p\u003e\n\n\u003cp\u003e合わせて、これを実装する CppSample クラスを定義します。 Destroy は delete this; をするだけの実装をします。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"パターン-1-windows-特定プラットフォーム-に決め打ちする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-1-windows-%E7%89%B9%E5%AE%9A%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0-%E3%81%AB%E6%B1%BA%E3%82%81%E6%89%93%E3%81%A1%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eパターン 1: Windows (特定プラットフォーム) に決め打ちする\u003c/h2\u003e\n\n\u003cp\u003eこちらは \"C++ の都合に C# を合わせる\" パターンになります。\u003c/p\u003e\n\n\u003cp\u003e結論から言えばインスタンスのポインターから vtable を引きずり出して、その関数ポインターから Marshal.GetDelegateForFunctionPointer で delegate を作る、ということになります。\u003cbr\u003e\u003cbr\u003e\nインスタンスに vtable が含まれている事が大前提になりますので、必ず仮想メソッドによる定義が必要になります。\u003c/p\u003e\n\n\u003cp\u003eまず C++ 側にインスタンス生成する C の関数を実装します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cpp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"s\"\u003e\"C\"\u003c/span\u003e \u003cspan class=\"kr\"\u003e__declspec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edllexport\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eICppSample\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eSTDMETHODCALLTYPE\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCppSampleInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eCppSample\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"err\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eexception\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e単純に new するだけです。 imoprt する C# 側の定義は\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"CppInvokeSampleDLL.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCallingConvention\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCallingConvention\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWinapi\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCppSampleInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eです。これを C# 側から呼び出すと IntPtr の戻り値に C++ のインスタンスポインターが入っています。\u003c/p\u003e\n\n\u003cp\u003eインスタンスポインターの示す先にそのインスタンスが保持している全ての情報が含まれているわけですが、ではどうやって vtable を引きずり出すか、になるのですが C++ ABI は規定がないらしく、コンパイラ (プラットフォーム) 依存になるようです。今回は VC++ でのレイアウトで取得してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003e_self\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCppSampleInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efuncs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCopy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_self\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003efuncs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efuncs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまずマジックナンバー 6 ですが、これは 6 個メソッドがあると C++ 側の定義を知っているからです。\u003cbr\u003e\u003cbr\u003e\nそして Marshal.Copy を使ってポインターから関数テーブルの内容をコピーします。インスタンスポインターの先頭に関数テーブルへのポインターが入っているのでここからコピーします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnmanagedFunctionPointer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCallingConvention\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eThisCall\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003edelegate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFnAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnmanagedFunctionPointer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCallingConvention\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eThisCall\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003edelegate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFnCalc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003e_fnDestroy\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetDelegateForFunctionPointer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eFnAction\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003efuncs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003cspan class=\"n\"\u003e_fnAdd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetDelegateForFunctionPointer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eFnCalc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003efuncs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eGetDelegateForFunctionPointer で delegate を生成します。 GetDelegateForFunctionPointer は generic delegate が指定できないので一つずつ delegate を定義します。この際、 CallingConvention で ThisCall を指定しておきます。インスタンスメソッドは VC++ では通常は thiscall という呼び出し規約になっているのでそれに合わせておきます。\u003cbr\u003e\u003cbr\u003e\nまた、暗黙指定だった this ポインターをここでは明示的に指定する必要がありますので全ての定義の第一引数に IntPtr を付けます。他は通常の P/Invoke 指定と同じです。\u003c/p\u003e\n\n\u003cp\u003eラッパーのメソッドは次のようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_fnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e?.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_self\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003e_fnAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_self\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e破棄メソッドは .NET の一般的作法に則り、 IDisposable を実装するのがよいでしょう。\u003c/p\u003e\n\n\u003cp\u003edelegate の呼び出しには控えておいた this ポインタを合わせて指定します。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"パターン-2-安全策\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-2-%E5%AE%89%E5%85%A8%E7%AD%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eパターン 2: 安全策\u003c/h2\u003e\n\n\u003cp\u003eパターン 1 とは逆で \"C# の都合に C++ を合わせる\" パターンになります。\u003c/p\u003e\n\n\u003cp\u003eパターン 1 の問題は C++ ABI のレイアウトにアドレスベースで直接さわらなくてはいけないことです。C++ 側でメソッドを一つ追加した場合、関数テーブルのインデックスがずれるかもしれません。また、継承などでテーブル自体が変わってしまうことも考えられます。 C++ ABI の互換性問題により C# 側の実装をプラットフォーム毎に用意しなくてはいけなくなるかもしれません。\u003c/p\u003e\n\n\u003cp\u003eこれらの問題を回避するため、コンパイラが自動で作る vtable を直接使うのではなく、自前で関数テーブルを用意するのがこのパターンになります。\u003c/p\u003e\n\n\u003cp\u003e今回の C++ 側に定義するインスタンス生成関数は次のようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cpp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"s\"\u003e\"C\"\u003c/span\u003e \u003cspan class=\"kr\"\u003e__declspec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edllexport\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003eSTDMETHODCALLTYPE\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCppSampleInstance2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003ebufferSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e引数経由でポインター配列を渡します。ポインター配列の 0 番に this ポインター、それ以降に関数ポインターを設定していきます。\u003c/p\u003e\n\n\u003cp\u003e次に関数ポインターのテーブルを作ります。ここで問題となるのが \u003cstrong\u003eインスタンスメソッドのポインターは通常のポインター (void *) とキャストができない\u003c/strong\u003e ということです。\u003cbr\u003e\u003cbr\u003e\nそこで void * にキャストができる C 言語スタイルの関数に変換します。つまり\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cpp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"nf\"\u003eCppSample_Add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eICppSample\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとして CppSample_Add を関数ポインターとします。これを全てのメソッドでいちいち実装すると面倒くさいので C++ のテンプレートを利用します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cpp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003etemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003etypename\u003c/span\u003e \u003cspan class=\"nc\"\u003eRetT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003etypename\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e \u003cspan class=\"nc\"\u003eArgs\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eProxy\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003etypename\u003c/span\u003e \u003cspan class=\"nc\"\u003eRetT\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"o\"\u003e::*\u003c/span\u003e\u003cspan class=\"n\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003eArgs\u003c/span\u003e\u003cspan class=\"p\"\u003e...)\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eRetT\u003c/span\u003e \u003cspan class=\"n\"\u003eSTDMETHODCALLTYPE\u003c/span\u003e \u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eArgs\u003c/span\u003e\u003cspan class=\"p\"\u003e...\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;*\u003c/span\u003e\u003cspan class=\"n\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e...);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efuncs\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eProxy\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eICppSample\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;::\u003c/span\u003e\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eICppSample\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eDestroy\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eProxy\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eICppSample\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;::\u003c/span\u003e\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eICppSample\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGetCurrentValue\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eProxy\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eICppSample\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32_t\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;::\u003c/span\u003e\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eICppSample\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eAdd\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//  略\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eテンプレート内の Func メソッドが C# 側に直接公開するメソッドになるので呼び出し規約として STDMETHODCALLTYPE をつけておきます。これも C# の都合に合わせる一環です。\u003c/p\u003e\n\n\u003cp\u003eC# 側はパターン 1 と大体同じ。配列で取得したインスタンスポインターと関数ポインターから delegate を準備し、実行時はインスタンスポインターを付与して delegate を実行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003edelegate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFnAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"k\"\u003edelegate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFnCalc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebufferSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCppSampleInstance2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ebufferSize\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eCreateCppSampleInstance2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebufferSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003e_self\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"n\"\u003e_fnDestroy\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetDelegateForFunctionPointer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eFnAction\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003cspan class=\"n\"\u003e_fnAdd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetDelegateForFunctionPointer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eFnCalc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eパターン 1 との比較ですが delegate 宣言で CallingConvention をつけていません。 C++ 側で STDMETHODCALLTYPE をつけたので省略できるようになりました。\u003c/p\u003e\n\n\u003cp\u003eCreateCppSampleInstance2 は引数にバッファを指定しますが、バッファを null 指定すると必要サイズを返す実装にしたのでこのような手続きでポインターリストを取得します。 0 番に this ポインターが入り、関数ポインターは 1 からになるのでパターン 1 と比較して 1 ずつずれます。\u003c/p\u003e\n\n\u003cp\u003eパターン 1 との違いはここまでで、実際の使い方は同じです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"呼び出してみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e呼び出してみる\u003c/h2\u003e\n\n\u003cp\u003e呼び出す側からは普通の C# のクラスです。 IDisposable 実装になっているのだけ注意。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecpp1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCppSample1\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecpp2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCppSample2\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecpp1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecpp1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCurrentValue\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Length = {0}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecpp1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendChars\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Hello,\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Length = {0}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecpp1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendChars\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"CppSample1!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecpp1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintChars\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecpp2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSub\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecpp2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCurrentValue\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Length = {0}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecpp2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendChars\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Hello,\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Length = {0}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecpp2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendChars\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"CppSample2!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecpp2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintChars\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e結果:\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eCppSample::Create\nCppSample::Create\n10\n20\n30\n40\n50\nLength = 6\nLength = 17\n[02C69728] Hello,CppSample1!\n\n-5\n-10\n-15\n-20\n-25\nLength = 6\nLength = 17\n[02C69778] Hello,CppSample2!\nCppSample::Destroy [02C69778]\nCppSample::Destroy [02C69728]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eC++ の CppSample::PrintChars, Destroy では this ポインタの値をコンソールに出力するようにしています。\u003cbr\u003e\u003cbr\u003e\nCppSample1 と CppSample2 でそれぞれ内部的には違うインスタンスになっていることが確認できます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"比較\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%AF%94%E8%BC%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e比較\u003c/h2\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eパターン 1\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eパターン 2\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eABI\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eC++ 言語\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eC 言語相当\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eパフォーマンス\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e----\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e若干遅い (誤差)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e記述量\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e少ない\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e若干多い (テーブルを自前で作るから)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eミス発生率\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e高い。危険。\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e低い。エラーは事前にわかる可能性が高い\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cul\u003e\n\u003cli\u003eパターン 1\n\n\u003cul\u003e\n\u003cli\u003eC++ のクラスに直接アクセスしているので、踏み台を入れているパターン 2 より実行時のステップ数が確実に少ないです。\n\n\u003cul\u003e\n\u003cli\u003eしかし、そのメリットは実際は有意な差を生むとは考えにくい。 1 秒に何万回もコールするとかならともかくですが、高頻度に .NET - ネイティブ間の呼び出しをする事がそもそも間違ってると思います。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eC++ 側の定義変更によりテーブル時代の構造が意図せず変わってしまう可能性もあり危険度が高いです。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eパターン 2\n\n\u003cul\u003e\n\u003cli\u003e踏み台が入る分、パフォーマンスは若干劣ります。\u003c/li\u003e\n\u003cli\u003e関数テーブルを手作業で作るのが面倒。\n\n\u003cul\u003e\n\u003cli\u003eテンプレートを駆使することで手間を最小限に抑えています。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e関数テーブルによるメリットが大きい。\n\n\u003cul\u003e\n\u003cli\u003eC++ ABI に直接触るわけではなく、シンプルな C 関数アクセスになります。 C++ の呼び出し規約もネイティブ側に隠蔽され配慮不要に。 \u003c/li\u003e\n\u003cli\u003e明示的に作成することで、メソッドの順番変更や追加でインデックスが変わっても影響がありません。\u003c/li\u003e\n\u003cli\u003e削除や引数の変更があってもコンパイルエラーになるので事前に確認ができ、アクセス違反等の問題が起きる可能性が低い。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eリスト生成に C++ の言語機能のみを使用しているのでポータビリティが高い。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eパターン 2 は結局 C 言語の関数を定義しているので一つずつ DllImport でやるのと実質差異はないように思われるかもしれませんが、テンプレート＋関数テーブルにすることで C++ 側に踏み台関数とその dllexport の定義をいちいち書かなくてよいのは大きなメリットです。\u003c/p\u003e\n\n\u003cp\u003eパターン 1 は CppSharp のような自動生成であれば (生成処理な問題がなけれぱ) 安全ですのでよいと思いますが、手作業で行うにはあまりにリスクが大きいので CppSharp のようなツールを頼らないのであればパターン 2 の方がよいのではないかと思います。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"余談-呼び出し規約について\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%99%E8%AB%87-%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E8%A6%8F%E7%B4%84%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e余談: 呼び出し規約について\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e.NET でネイティブコードを呼び出す際のデフォルトは CallingConvention.Winapi です。 Winapi となっていますが、これはプラットフォームの標準的な呼び出し規約に従う、の意味です。 Windows では StdCall ですがそれ以外は大体 Cdecl になっています。つまり CallingConvertion は通常は明示指定する必要はありません。 Windows で C ランタイムの関数を直接呼ぶ時とか？\u003c/li\u003e\n\u003cli\u003eVC++ の場合、 C++ のインスタンスメソッドの呼び出し規約はデフォルトで thiscall を使用しますが、明示的に指定する事も可能です。つまり STDMETHODCALLTYPE を指定すれば C++ メソッドでも stdcall になり、 CppSample1 で CallingConvertion.ThisCall の指定をする必要がなくなります (というかしてはダメ) 。 Windows の COM はまさにこのパターンですね。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e呼び出し規約はこちらも: \u003ca href=\"https://qiita.com/tan-y/items/81b056e01a11515c4c22\" id=\"reference-4bfe55b88ced7f28cc9c\"\u003eC/C++ の呼び出し規約を再確認する\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おわりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおわりに\u003c/h1\u003e\n\n\u003cp\u003e本当は C++/CLI が進化していって、 Mono など他の .NET 向け、プラットフォーム向けのバイナリがビルドできるようになっていくのがよかったのですが、 VS2017 では C++/CLI はオプションになり、そもそも機能拡張が全くされてこなかった (振り返って考えてみると VS2010 で .NET 4 対応はしたもののそれで終わりで機能拡張はそれ以後も含めて何もなかったような・・・) 状況でこのままフェードアウト確定かなあと思われます。WinRT で追加された C++/CX も廃止してテンプレートライブラリによる C++/WinRT を代替にするようです。 C++ AMP もなあ・・・\u003c/p\u003e\n\n\u003cp\u003eマイクロソフトは C++ の言語仕様は標準準拠で独自拡張はやめ、拡張はクラスライブラリで行うという非常に真っ当な方針になったように見えます。これ自体は歓迎こそすれ非難をする要素など全くないのですが C++/CLI はマネージドとネイティブをシームレスに混在できる唯一の言語だったのでなくなってしまうと困るなあと思ってしまいます。\u003c/p\u003e\n\n\u003cp\u003eそういうわけで C++/CLI に頼らずに C++ interop (相当) を実現する方法は今後重要性が増していくと思います。\u003cbr\u003e\u003cbr\u003e\nCppSharp が安定して使えるようになればそれを使っていけばよいと思いますが、手作業でも可能であることを示せたと思います。参考にしていただければと思います。\u003c/p\u003e\n","createdAt":"2017-11-22T04:58:38Z","elapsedYearsFromLastModifiedAt":3,"encryptedId":"PiG16OTJiU3/I9nlBoqrOSpYvnLV/J9/--ctPdExr/QBffpEd/--E4b/wDA3Ysk7SmKqt71jVA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2017-12-24T22:01:14Z","likesCount":36,"linkUrl":"https://qiita.com/tan-y/items/64711b244cf294d6bb9d","organization":null,"originalId":543154,"stockedCount":44,"title":"C#からC++のインスタンスメソッドを呼び出す","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e概要\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%9B%AE%E6%A8%99\"\u003e目標\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%B7%B5\"\u003e実践\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#c-%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B\"\u003eC++ クラスを定義する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-1-windows-%E7%89%B9%E5%AE%9A%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0-%E3%81%AB%E6%B1%BA%E3%82%81%E6%89%93%E3%81%A1%E3%81%99%E3%82%8B\"\u003eパターン 1: Windows (特定プラットフォーム) に決め打ちする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-2-%E5%AE%89%E5%85%A8%E7%AD%96\"\u003eパターン 2: 安全策\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e呼び出してみる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%AF%94%E8%BC%83\"\u003e比較\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%99%E8%AB%87-%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E8%A6%8F%E7%B4%84%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e余談: 呼び出し規約について\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003eおわりに\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":27108,"uuid":"64711b244cf294d6bb9d","banReason":null,"adventCalendarItem":{"day":25,"calendar":{"name":"C#","urlName":"csharp","year":2017,"organization":null}},"author":{"encryptedId":"3H3WXWNt7Q/lmi1Pk6g3fJsJd+Kb--hYIkiANaArMA+ll6--pi5x4CowLrhAM3uAbXLjvg==","originalId":211064,"description":"最新記事は Zenn / はてなブログで。\r\nhttps://zenn.dev/tan_y\r\nhttps://tan-y.hatenablog.com/","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/211064/profile-images/1509545659","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F211064%2Fprofile-images%2F1509545659?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=2d0bc2b4d69e2d3ea18ab36e3d99bfb9","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F211064%2Fprofile-images%2F1509545659?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=4f9425460984301e69338c76dc76a942","urlName":"tan-y","websiteUrl":"https://zenn.dev/tan_y","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C++","urlName":"cpp"},{"name":"C#","urlName":"csharp"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
