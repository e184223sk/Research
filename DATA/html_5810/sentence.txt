More than 3 years have passed since last update.C#の文字列の扱いに関するよくある小ネタ。C#の文字列はクラスですが普通のクラスと振舞いが異なります。
不変型はまだいいですけれど「""って書く度にインスタンスが作成されてしまう」と言う人がたまにいるので、確認も兼ねてパターンを分けてどのような参照になっているか見てみました。(1)においてhoge1とhoge2は同じHogeClassですが違うインスタンスとして作成したので、異なる参照を持ちます。
(2)においてhoge1とhoge2が同じインスタンスを指すようになったので、同じ参照を持ちます。
(3)においてstr1とstr2はそれぞれインスタンスを作成したので、違う参照を持ちます。
(4)においてstr3は別にインスタンスを作成しましたが、文字列の内容が同じstr1と同じ参照を持ちます(4-1)。文字列の内容が違うstr2とは違う参照を持ちます(4-2)。
(5)においてstr3に文字列を追加したところ、同じ参照をだったはずのstr1と違う参照になりました。str1とstr3は違う文字列であり、違うインスタンスです。
(6)において""はstring.Emptyは同じ参照を持ちます。(1)、(2)については基本的なクラスの振舞いです。その延長で考えると(3)も自然な動きでしょう。(4)において(1)と同じように別個にインスタンスを作成したはずです。しかし文字列の内容が同じ場合は実は同じ場所を参照しています。つまり、同じ文字列の場合はインスタンスは逐一作成されずに使い回されるという仕組みになっています。(5)においてstr3に文字列を追加したところstr3は別のインスタンスになってしまいました。普通同じ参照を指しているならstr3を変更した場合str1も同じ値になるはずですが、そうはなりませんでした。string型は不変（イミュータブル）なので後から追加した処理に見えても実際は別のインスタンスが作成されます。この辺りは(4)より知っている人が多いことでしょう。(6)においてstring.Emptyとは空文字列であり""のことです。同じ文字列なのでこれも同じ参照になります。……実は実際に動かしてみるまで他の記事を読んで""とstring.Emptyは違う参照を持つと思っていたのですが同じになるんですね。後から同じ文字列にしても違うインスタンスですね。同じインスタンスにしてくれるのは宣言時だけでした。


