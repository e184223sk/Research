More than 1 year has passed since last update.Unityゆるふわサマーアドベントカレンダー 2019 #ゆるふわアドカレの枠が空いたそうなので
急遽代打で参加させていただきました！！Unity関連の記事ということで本記事はスレスレですが、ゆるふわなのでセーフセーフ！SteamVRやOculusIntegrationでのVR開発で独特なカメラの階層構造に行き詰まりました。ご覧の通り、CameraRigというゲームオブジェクトの子階層にカメラが存在しています。このような階層構造になっている理由は、
VRのカメラがHMDを追従して動くからです。(他にも理由があるかもしれませんが)つまり、直接カメラを動かすことはできず、親階層のCameraRigを動かすことで移動を再現します。しかし、親階層のCameraRigを動かすことで移動を再現した場合、問題が発生します。
それは、子階層のカメラの位置を考慮しなければ任意の位置には移動できないことです。カメラはユーザーの移動に伴って位置が変わるので、特定の位置に誘導が難しい場合は
強制ワープさせた先で壁にめり込んでしまうといった現象が引き起こされる恐れがあります。説明をわかりやすくするために図を用いて説明します。赤い点Aの場所にプレイヤーをワープさせたいとします。
薄緑の枠は部屋、青い四角はCameraRig、黄色い点はCameraRigの中心、黒く塗りつぶされた四角はカメラ(プレーヤー)です。カメラ(プレイヤー)のポジションを直接変更することはできないので、
CameraRigのポジションを赤い点Aに移動させることで
カメラ(プレイヤー)移動を再現するのですが、そのまま移動させるとこうなります↓赤い四角が移動後のCameraRigです。

ご覧の通り、カメラが部屋から はみ出してしまいました。
カメラの位置を考慮して移動させる必要がある理由は以上です。投げたキューブの位置にプレイヤーが移動するデモです。
少しわかりにくいですが、
キューブを持った状態で歩いてカメラの位置を初期位置からずらした後に投げてます。
キューブと同じ座標にプレイヤーが移動していることがわかるかと思います。今回のデモに利用したコードです。下記の箇所でカメラの座標を考慮したCameraRigの座標の計算を行っています。特定の向きを指定してなおかつ移動も行いたい場合はのように回転させてから移動することで実装可能です。実はもっと簡単な方法がありそうで怖いのですが、思いついたのでメモしときます。2019/11/14 追記回転も実装したのでメモします。引数として対象のオブジェクトを渡してあげると
プレイヤーがその位置に移動し、カメラの向きもオブジェクトの正面方向にピッタリ合います。2020/08/19 追記OculusQuestでは位置トラッキングが完了する前に
位置調整の処理が呼び出されてしまってうまくいきませんでした。ですので、下記のようにUniTask(あるいはコルーチン)を使用して
呼び出し側で位置トラッキングの完了を待つとうまくいきます。


