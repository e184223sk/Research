<!DOCTYPE html><html><head><meta charset="utf-8" /><title>[Unity] マウス位置のドット絵オブジェクトをピクセル単位で選択＆ハイライト表示 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/Shinoda_Naoki/items/677952e9ab675985f2b6" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="wKhJhlButAc32qPz1gWdp5+xK8fxyq08QTQi61CsSSWPxBJtG3ssoMlT6yfarYuaHbLzPYuUoJXiDWQGuet/ag==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="[Unity] マウス位置のドット絵オブジェクトをピクセル単位で選択＆ハイライト表示 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XMVZ1YVhSNVhTRGpnNTdqZ3Fiamdybmt2WTNudmE3amdhN2pnNG5qZzRQamc0am50YlhqZ3Fyamc1YmpncmpqZ3FmamdxX2pnNGpqZ3BMamc1VGpncV9qZ3J2amc2dmxqWmprdlkzamdhZnBnYmptaXA3dnZJYmpnNF9qZ3FUamc2bmpncVRqZzRqb29ham5wTG8mdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ODJjMDczZTQ4NmY1NGFlZTI5ZWJkZjEyZjEwYmYwNWE&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRk5vYVc1dlpHRmZUbUZ2YTJrJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9MDQ5NDUzMDBjM2MyOTY0NzU4NDdmYzk3MjEwNTIyOWM&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=8d7882844f024c3dcba9c8de74f627ea"><meta property="og:description" content="

経緯

複数のドット絵オブジェクトで構成されたゲームシーンで、マウスでクリックした指定座標位置にあるオブジェクトを、ピクセル単位で正確に判定したいと思いました。また判定で見つけたオブジェクトをハイライト表示（色フィルターや輪郭を付..."><meta content="https://qiita.com/Shinoda_Naoki/items/677952e9ab675985f2b6" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity,Shader,ゲーム制作,ShaderLab" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-7ab005fd-df7b-4918-a057-ac9970b2df18"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FShinoda_Naoki%2Fitems%2F677952e9ab675985f2b6">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FShinoda_Naoki%2Fitems%2F677952e9ab675985f2b6">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-7ab005fd-df7b-4918-a057-ac9970b2df18">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-12-20T13:27:45.000+09:00","dateModified":"2020-01-26T18:13:18.000+09:00","headline":"[Unity] マウス位置のドット絵オブジェクトをピクセル単位で選択＆ハイライト表示","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XMVZ1YVhSNVhTRGpnNTdqZ3Fiamdybmt2WTNudmE3amdhN2pnNG5qZzRQamc0am50YlhqZ3Fyamc1YmpncmpqZ3FmamdxX2pnNGpqZ3BMamc1VGpncV9qZ3J2amc2dmxqWmprdlkzamdhZnBnYmptaXA3dnZJYmpnNF9qZ3FUamc2bmpncVRqZzRqb29ham5wTG8mdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ODJjMDczZTQ4NmY1NGFlZTI5ZWJkZjEyZjEwYmYwNWE\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRk5vYVc1dlpHRmZUbUZ2YTJrJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9MDQ5NDUzMDBjM2MyOTY0NzU4NDdmYzk3MjEwNTIyOWM\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=8d7882844f024c3dcba9c8de74f627ea","mainEntityOfPage":"https://qiita.com/Shinoda_Naoki/items/677952e9ab675985f2b6","author":{"@type":"Person","address":null,"email":null,"identifier":"Shinoda_Naoki","name":"Shinoda_Naoki","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F75035%2Fprofile-images%2F1473700038?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1d027acc213195aa714453863473a257","url":"https://qiita.com/Shinoda_Naoki","description":null,"memberOf":[{"@type":"Organization","address":"京都市下京区大政所町685  京都四条烏丸ビル2F","legalName":"株式会社テクロス","image":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/62accf6f20b1556dd2ac37d6503eb0552457d25b/original.jpg?1569306622","logo":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/47bb6192a32d490348c8d00949b8b21bd852af31/original.jpg?1569306622","identifier":"techcross","description":"京都を拠点にソーシャルゲームの開発・運用、その他システム開発を行っています。"}]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita&amp;utm_medium=header-banner">社内改善＝業界革新。GA technologiesの一石三鳥な社内プロダクト開発とは</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Shinoda_Naoki","type":"items","id":"677952e9ab675985f2b6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"社内改善＝業界革新。GA technologiesの一石三鳥な社内プロダクト開発とは","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Shinoda_Naoki","type":"items","id":"677952e9ab675985f2b6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"社内改善＝業界革新。GA technologiesの一石三鳥な社内プロダクト開発とは","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Shinoda_Naoki","type":"items","id":"677952e9ab675985f2b6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"社内改善＝業界革新。GA technologiesの一石三鳥な社内プロダクト開発とは","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/Shinoda_Naoki/items/677952e9ab675985f2b6","location":"/Shinoda_Naoki/items/677952e9ab675985f2b6","scheme":"https","host":"qiita.com","port":null,"pathname":"/Shinoda_Naoki/items/677952e9ab675985f2b6","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"hf4DrWAqPNxhhk8j9OmKhQ4f7BxCjqewJKXWwsyZAHDKklhGKz+ke58PB/f4QZy4jBw05jjQqhmHnJAvJd42Pw==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-536bb83a-aa3c-4528-be31-4b40498885dd"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6/likers" class="css-1iupg5d">12</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">14</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/677952e9ab675985f2b6/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/Shinoda_Naoki"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/75035/profile-images/1473700038" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/Shinoda_Naoki" class="css-10ougpm">@<!-- -->Shinoda_Naoki</a><div class="css-1ay9vb9"><span><meta content="2019-12-20T04:27:45Z"/><time dateTime="2020-01-26T09:13:18Z" class="css-m19uds">updated at 2020-01-26</time></span></div></div></div></div></div><h1 class="css-cgzq40">[Unity] マウス位置のドット絵オブジェクトをピクセル単位で選択＆ハイライト表示</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/shader" class="css-4czcte">Shader</a><a href="/tags/%e3%82%b2%e3%83%bc%e3%83%a0%e5%88%b6%e4%bd%9c" class="css-4czcte">ゲーム制作</a><a href="/tags/shaderlab" class="css-4czcte">ShaderLab</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="経緯" class="fragment"></span><a href="#%E7%B5%8C%E7%B7%AF"><i class="fa fa-link"></i></a>経緯</h1>

<p>複数のドット絵オブジェクトで構成されたゲームシーンで、マウスでクリックした<strong>指定座標位置にあるオブジェクトを、ピクセル単位で正確に判定したい</strong>と思いました。また判定で見つけたオブジェクトを<strong>ハイライト表示（色フィルターや輪郭を付けたり）したい</strong>と思いました。</p>

<p><a href="https://camo.qiitausercontent.com/59fed1bb767da65cb093d302605ea92c875bd616/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f63386532356562372d353065302d613466632d653139392d3232393034356432643331652e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fc8e25eb7-50e0-a4fc-e199-229045d2d31e.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ec98856f88d19f28369ca0cb59b0ba7c" alt="selection-highlight.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/c8e25eb7-50e0-a4fc-e199-229045d2d31e.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fc8e25eb7-50e0-a4fc-e199-229045d2d31e.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0c0dd0688d01f9a31de5206a6ce598d5 1x" loading="lazy"></a></p>

<p>これまでの記事で、<strong><a href="https://qiita.com/Shinoda_Naoki/items/fccdc137747ea4301578" id="reference-7f91ebd040023636590c">ドット絵を深度バッファ付きで描画</a></strong>して、<strong><a href="https://qiita.com/Shinoda_Naoki/items/31bde73218b0295b8778" id="reference-23d6871e2afcab5b6505">Deferredをカスタマイズして昼夜画像をそれぞれ異なるRenderTargetに同時に書き出し</a></strong>、夕方アニメーションが出来るようになりました。<br>
この時ついでに、オブジェクトごとに<code>IDColor</code>なるものを割り当て、それを別のRenderTargetに書き出して、IDカラーマップ画像を作りました。このIDカラーマップ画像から指定座標の色を読みだして、<code>IDColor</code>が一致するオブジェクトを見つければ、<strong>ピクセル単位で正確な判定ができる</strong>はずです。<br>
<a href="https://camo.qiitausercontent.com/25b03f9239bfde2a173892dd86c2aeaa1be906b8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f32363432393031662d323031382d376335332d613062642d3530656133303637643735342e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F2642901f-2018-7c53-a0bd-50ea3067d754.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=069d11a351cc2152383fc7d2e26d4cdc" alt="gbuffer-rt1.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/2642901f-2018-7c53-a0bd-50ea3067d754.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F2642901f-2018-7c53-a0bd-50ea3067d754.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=31b8fc2aa523c5f81748e53ae42f1161 1x" loading="lazy"></a></p>

<h2>
<span id="なぜidカラーマップが必要か" class="fragment"></span><a href="#%E3%81%AA%E3%81%9Cid%E3%82%AB%E3%83%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%97%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%8B"><i class="fa fa-link"></i></a>なぜIDカラーマップが必要か？</h2>

<p>ご存知の方には今更ですが、Unityでマウスでオブジェクトを選択したい場合などには <a href="https://docs.unity3d.com/ja/2017.4/ScriptReference/Physics.Raycast.html" rel="nofollow noopener" target="_blank">Ray/Raycast</a> と<a href="https://docs.unity3d.com/jp/current/ScriptReference/Collider.html" rel="nofollow noopener" target="_blank">Collider</a>を使うのが一般的だと思います。<br>
参考：<a href="https://pengoya.net/unity/object-touch/" rel="nofollow noopener" target="_blank">【Unity】オブジェクトをタッチしたことを判定する方法【2D・3D】</a></p>

<p>しかし、この方法だとテクスチャの透過ピクセルを無視できないので、複数のオブジェクトが重なっている場合には正確な判定が出来ません。もしやるなら、Raycastで見つけたオブジェクトから<strong>テクスチャのUV座標を逆算して、その位置のテクスチャーが透過色かどうかを調べる</strong>必要があります。もし透過色だったらさらに奥のオブジェクトにRayを飛ばしていって、<strong>透過色でないテクスチャに当たるか、何も当たらなくなるまで繰り返す</strong>必要がありそうです。</p>

<p><a href="https://camo.qiitausercontent.com/57e20f895abe16c2ee38b601a36f3d9ca355e12d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f66383361663632622d643338612d613061622d303333342d6464373364666439383263662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Ff83af62b-d38a-a0ab-0334-dd73dfd982cf.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=607f2f50146eebe046e25a634388ba7e" alt="transpalency_hittest.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/f83af62b-d38a-a0ab-0334-dd73dfd982cf.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Ff83af62b-d38a-a0ab-0334-dd73dfd982cf.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=65c69288da51953a2f2ac4fcaf6dad81 1x" loading="lazy"></a></p>

<p>これはどう考えても面倒くさい実装になりそうだし、テクスチャのピクセルを読むためにはテクスチャを<a href="https://docs.unity3d.com/ja/2017.4/Manual/TextureTypes.html" rel="nofollow noopener" target="_blank">Rear/Write Enadable</a>に設定する必要があるし、パフォーマンスも悪そうだと思いました。</p>

<p>先に書いたように、描画オブジェクトごとに<code>IDColor</code>を割り当て、それをメインのフラグメントシェーダーで<strong>通常映像と同時に別のRenderTargetに書き出して、IDカラーマップ画像を作れば</strong>、そこから指定座標の色を読み込んで、スクリプト側で<code>IDColor</code>に一致するオブジェクトを探す方が、必ず一度で済むし、コードも単純で正確で速い（※計測してないので、憶測ですが）でしょう。</p>

<p>さらにIDカラーマップ画像は、<strong>特定のオブジェクトをハイライト表示</strong>（明るく色をつけたり、輪郭線を付けたり）するときにも使えて一石二鳥です。</p>

<h1>
<span id="座標位置のオブジェクト検索" class="fragment"></span><a href="#%E5%BA%A7%E6%A8%99%E4%BD%8D%E7%BD%AE%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%A4%9C%E7%B4%A2"><i class="fa fa-link"></i></a>座標位置のオブジェクト検索</h1>

<h2>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h2>

<p>IDカラーマップを描きだす部分は、冒頭にもリンクを張った<a href="https://qiita.com/Shinoda_Naoki/items/31bde73218b0295b8778">前回の記事</a>で詳しく説明してますので、よろしければご覧ください。 Deferred レンダリングをカスタマイズして昼夜画像をそれぞれ異なるRenderTargetに同時に書き出すついでにIDカラーマップも描きだしてます。</p>

<h3>
<span id="g-bufferの指定位置の色を取得する" class="fragment"></span><a href="#g-buffer%E3%81%AE%E6%8C%87%E5%AE%9A%E4%BD%8D%E7%BD%AE%E3%81%AE%E8%89%B2%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>G-Bufferの指定位置の色を取得する</h3>

<p>参考までに、<strong>カメラに表示されるシーンの色を取得する</strong>のは、下記リンク先の内容ほぼそのままで出来ました。<br>
<a href="https://teratail.com/questions/208439" rel="nofollow noopener" target="_blank">unity　マウスクリックした部分の色を抽出する｜teratail</a></p>

<p>問題は<strong>どうやって特定の G-Buffer の内容を取り出す</strong>か・・・<br>
ヒントは前回の記事でも引用したこちらの記事にありました。<br>
<a href="https://matcha-choco010.net/2018/09/16/unity%E3%81%AEdeferred%E3%81%A7commandbuffer%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6g-buffer%E3%82%92%E3%81%84%E3%81%98%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B/" rel="nofollow noopener" target="_blank">UnityのDeferredでCommandBufferを利用してGBufferをいじってみる</a></p>

<p><a href="https://docs.unity3d.com/ja/2017.4/ScriptReference/Rendering.CommandBuffer.html" rel="nofollow noopener" target="_blank">CommandBuffer</a> なるものを使えば、G-Buffer を RenderTarget に指定するのは容易そうです。しかも <strong><a href="https://docs.unity3d.com/ja/2017.4/ScriptReference/Rendering.CommandBuffer.CopyTexture.html" rel="nofollow noopener" target="_blank">CopyTexture</a></strong> などという、まさにうってつけのメソッドがありました。</p>

<p>二つの記事を参考にできたのがこちらです。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">CaptureGBuffer.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CaptureGBuffer</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">CommandBuffer</span> <span class="n">buf</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">Color32</span> <span class="n">color</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Texture2D</span> <span class="n">texture</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">RenderTexture</span> <span class="n">renderTexture</span><span class="p">;</span>

    <span class="c1">// Start is called before the first frame update</span>
    <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">texture</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Texture2D</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">TextureFormat</span><span class="p">.</span><span class="n">RGBAFloat</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
        <span class="n">renderTexture</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RenderTexture</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">RenderTextureFormat</span><span class="p">.</span><span class="n">ARGB32</span><span class="p">);</span>
        <span class="n">renderTexture</span><span class="p">.</span><span class="n">filterMode</span> <span class="p">=</span> <span class="n">FilterMode</span><span class="p">.</span><span class="n">Point</span><span class="p">;</span>

        <span class="n">buf</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CommandBuffer</span><span class="p">();</span>
        <span class="n">buf</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s">"GBuffer Test"</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cam</span> <span class="k">in</span> <span class="n">Camera</span><span class="p">.</span><span class="n">allCameras</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">cam</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">cam</span><span class="p">.</span><span class="nf">AddCommandBuffer</span><span class="p">(</span><span class="n">CameraEvent</span><span class="p">.</span><span class="n">AfterGBuffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="p">}</span>

<span class="cp">#if UNITY_EDITOR
</span>        <span class="kt">var</span> <span class="n">sceneViewCameras</span> <span class="p">=</span> <span class="n">SceneView</span><span class="p">.</span><span class="nf">GetAllSceneCameras</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cam</span> <span class="k">in</span> <span class="n">sceneViewCameras</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">cam</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">cam</span><span class="p">.</span><span class="nf">AddCommandBuffer</span><span class="p">(</span><span class="n">CameraEvent</span><span class="p">.</span><span class="n">AfterGBuffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif
</span>    <span class="p">}</span>

    <span class="n">Vector2Int</span> <span class="nf">getNormalizedMousePos</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Vector2</span> <span class="n">pos</span> <span class="p">=</span> <span class="n">Input</span><span class="p">.</span><span class="n">mousePosition</span><span class="p">;</span>        

        <span class="kt">float</span> <span class="n">x</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="m">0.0f</span><span class="p">,</span> <span class="n">Screen</span><span class="p">.</span><span class="n">width</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">y</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Clamp</span><span class="p">(</span><span class="n">pos</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="m">0.0f</span><span class="p">,</span> <span class="n">Screen</span><span class="p">.</span><span class="n">height</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Vector2Int</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Update is called once per frame</span>
    <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetMouseButtonDown</span><span class="p">(</span><span class="m">0</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">RenderTexture</span><span class="p">.</span><span class="n">active</span> <span class="p">=</span> <span class="n">renderTexture</span><span class="p">;</span>        
        <span class="n">texture</span><span class="p">.</span><span class="nf">ReadPixels</span><span class="p">(</span><span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="n">color</span> <span class="p">=</span> <span class="n">texture</span><span class="p">.</span><span class="nf">GetPixel</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"Color:</span><span class="p">{</span><span class="n">color</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">OnPostRender</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">buf</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>

        <span class="n">RenderTargetIdentifier</span> <span class="n">src</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RenderTargetIdentifier</span><span class="p">(</span><span class="n">BuiltinRenderTextureType</span><span class="p">.</span><span class="n">GBuffer1</span><span class="p">);</span>
        <span class="n">RenderTargetIdentifier</span> <span class="n">dst</span> <span class="p">=</span> <span class="n">renderTexture</span><span class="p">;</span>
        <span class="n">Vector2Int</span> <span class="n">pos</span> <span class="p">=</span> <span class="nf">getNormalizedMousePos</span><span class="p">();</span>
        <span class="n">buf</span><span class="p">.</span><span class="nf">CopyTexture</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">renderTexture</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
        <span class="n">buf</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="idcolorに合うオブジェクトを探す" class="fragment"></span><a href="#idcolor%E3%81%AB%E5%90%88%E3%81%86%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E6%8E%A2%E3%81%99"><i class="fa fa-link"></i></a>IDColorに合うオブジェクトを探す</h3>

<p>色が取得できたなら後は難しいところはありません。シーン中のゲームオブジェクトから同じIDカラーを持つShedオブジェクトを見つけます。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">CaptureGBuffer.cs</span></div>
<div class="highlight"><pre class="with-code"><code>    <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetMouseButtonDown</span><span class="p">(</span><span class="m">0</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">RenderTexture</span><span class="p">.</span><span class="n">active</span> <span class="p">=</span> <span class="n">renderTexture</span><span class="p">;</span>        
        <span class="n">texture</span><span class="p">.</span><span class="nf">ReadPixels</span><span class="p">(</span><span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="n">color</span> <span class="p">=</span> <span class="n">texture</span><span class="p">.</span><span class="nf">GetPixel</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">seleted</span> <span class="p">=</span> <span class="nf">FindObjectByIDColor</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$"Color:</span><span class="p">{</span><span class="n">color</span><span class="p">}</span><span class="s">, Selection:</span><span class="p">{(</span><span class="n">seleted</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="n">seleted</span><span class="p">.</span><span class="n">name</span><span class="p">:</span><span class="s">"N/A"</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">seleted</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="n">Shader</span><span class="p">.</span><span class="nf">SetGlobalVector</span><span class="p">(</span><span class="s">"HighlightID"</span><span class="p">,</span> <span class="p">(</span><span class="n">Color</span><span class="p">)</span><span class="n">color</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Shed4Sprite</span> <span class="nf">FindObjectByIDColor</span><span class="p">(</span><span class="n">Color32</span> <span class="n">idCol</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">structures</span> <span class="p">=</span> <span class="n">GameObject</span><span class="p">.</span><span class="n">FindObjectsOfType</span><span class="p">&lt;</span><span class="n">Shed4Sprite</span><span class="p">&gt;();</span>
        <span class="kt">var</span> <span class="n">found</span> <span class="p">=</span> <span class="n">Array</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">shed</span> <span class="p">=&gt;</span> <span class="n">idCol</span><span class="p">.</span><span class="nf">Equals</span><span class="p">((</span><span class="n">Color32</span><span class="p">)</span><span class="n">shed</span><span class="p">.</span><span class="n">material</span><span class="p">.</span><span class="nf">GetColor</span><span class="p">(</span><span class="s">"_IDColor"</span><span class="p">)));</span>
        <span class="k">return</span> <span class="n">found</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
</div>

<p>本格的に使うなら、毎回全検索せずにハッシュテーブルなどでIDカラーとオブジェクトの紐づけを管理する方がいいのでしょうが、今はとりあえず妥協してます。</p>

<p>ところが、<strong>これでは上手く同じIDカラーを見つけられない場合がある</strong>ことがわかりました。<br>
なぜ見つからないかと言えば、<strong>シェーダーに指定した色と、RenderTarget から取得した色が違う</strong>からで、どうやら<strong><a href="https://docs.unity3d.com/jp/460/Manual/LinearLighting.html" rel="nofollow noopener" target="_blank">ガンマ補正</a></strong>が影響してることがわかってきました。</p>

<p>そこで、ガンマ補正を元に戻す方法を検討してみました。</p>

<h3>
<span id="没案idcolor-のカラースペース変換を逆変換する" class="fragment"></span><a href="#%E6%B2%A1%E6%A1%88idcolor-%E3%81%AE%E3%82%AB%E3%83%A9%E3%83%BC%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E5%A4%89%E6%8F%9B%E3%82%92%E9%80%86%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>【没案】IDColor のカラースペース変換を逆変換する</h3>

<p>前述の公式ドキュメントを見るとリニアライティングに変更すればいいのかな？とも思いますが、設定が面倒で制約も多そうなので躊躇われます。<br>
そこで、ググって見つけた記事（<a href="https://github.com/EsotericSoftware/spine-runtimes/issues/1301%0Ahttps://teratail.com/questions/163790" rel="nofollow noopener" target="_blank">※１</a>、<a href="https://teratail.com/questions/163790" rel="nofollow noopener" target="_blank">※２</a>）を参考に試行錯誤した結果、以下のようにしたら（少なくとも今までうまく一致しなかったケースにおいては）色の違いがなくなりました。</p>

<div class="code-frame" data-lang="glsl">
<div class="code-lang"><span class="bold">DayNightPixelArtsGBuffer.shader</span></div>
<div class="highlight"><pre class="with-code"><code>      <span class="kr">inline</span> <span class="n">float3</span> <span class="nf">linearToSrgb</span><span class="p">(</span><span class="n">float3</span> <span class="n">c</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="k">return</span> <span class="n">lerp</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mi">12</span><span class="p">.</span><span class="mi">92</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mo">055</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">0</span><span class="p">.</span><span class="mo">055</span><span class="p">,</span> <span class="n">step</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mo">003130</span><span class="mi">8</span><span class="p">,</span> <span class="n">c</span><span class="p">));</span>
      <span class="p">}</span>

      <span class="kt">void</span> <span class="nf">frag</span> <span class="p">(</span><span class="k">in</span> <span class="n">v2f</span> <span class="n">i</span><span class="p">,</span> <span class="k">out</span> <span class="n">flagout</span> <span class="n">o</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="c1">//..中略..//</span>

        <span class="n">o</span><span class="p">.</span><span class="n">gBuffer1</span> <span class="o">=</span> <span class="n">float4</span><span class="p">(</span><span class="n">GammaToLinearSpace</span><span class="p">(</span><span class="n">linearToSrgb</span><span class="p">(</span><span class="n">_IDColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">)),</span><span class="n">_IDColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
      <span class="p">}</span>
</code></pre></div>
</div>

<p><a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/93a55986605ccc611b0bc39abe360430498ee779/Assets/Assets/Shader/DayNightPixelArtsGBuffer.shader" rel="nofollow noopener" target="_blank">ファイル全体</a></p>

<p>うーん、なんでガンマからリニアの変換だけじゃ足りないんですかね？<strong>sRGBってなんなの？</strong>なんか直感にそぐわない変換式で困惑しました。<br>
それでなくとも、<strong>IDとしての性質上、少数部を超える誤差は致命的</strong>なので、powとか使ったややこしい計算が<strong>本当にどんな色も誤差なく逆変換できるのか心配</strong>です。</p>

<h3>
<span id="idcolorをvectorにするカラースペース変換を完全無効化" class="fragment"></span><a href="#idcolor%E3%82%92vector%E3%81%AB%E3%81%99%E3%82%8B%E3%82%AB%E3%83%A9%E3%83%BC%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E5%A4%89%E6%8F%9B%E3%82%92%E5%AE%8C%E5%85%A8%E7%84%A1%E5%8A%B9%E5%8C%96"><i class="fa fa-link"></i></a>IDColorをVectorにする（カラースペース変換を完全無効化）</h3>

<p>・・・しばらく思い悩んでいたら、はたと気づきました。<br>
そういえば法線マップはVectorを画像化しています。別に<strong>Vectorを色として描きだしてもいい</strong>んじゃないの？そうすれば<strong>カラースペース変換から逃れられるんじゃないの？</strong></p>

<p>まず、シェーダーのプロパティを Color から Vector に変更しました。</p>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre class="with-code"><code><span class="gd">--- a/Assets/Assets/Shader/DayNightPixelArtsGBuffer.shader
</span><span class="gi">+++ b/Assets/Assets/Shader/DayNightPixelArtsGBuffer.shader
</span><span class="p">@@ -5,7 +5,7 @@</span>
     [NoScaleOffset] _DayTex ("Day Texture", 2D) = "white" {}
     [NoScaleOffset] _NightTex ("Night Texture", 2D) = "black" {}
     _Transpalent ("Transpalent Color", Color) = (1,0,1,1)
<span class="gd">-    _IDColor ("Color fo source object ID", Color) = (0,0,0,0)
</span><span class="gi">+    _IDColor ("Color fo source object ID", Vector) = (0,0,0,0)
</span>   }
   SubShader
   {

</code></pre></div></div>

<p><strong>視覚的に確認したり、16進数で指定するのに都合がいい</strong>のでゲームオブジェクトにつける Shed コンポーネントに <a href="https://docs.unity3d.com/ja/2017.4/ScriptReference/Color32.html" rel="nofollow noopener" target="_blank">Color32</a> 型の IDColor フィールドを追加して、 Start() でシェーダープロパティーを設定するようにしました。</p>

<div class="code-frame" data-lang="diff">
<div class="code-lang"><span class="bold">Shed4Sprite.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="gd">--- a/Assets/Assets/Scripts/Shed4Sprite.cs
</span><span class="gi">+++ b/Assets/Assets/Scripts/Shed4Sprite.cs
</span><span class="p">@@ -46,6 +46,8 @@</span> public class Shed4Sprite : MonoBehaviour //opposite -&gt; courtyard
     // ドット絵を保持するマテリアル
     public Material material;

+    public Color32 IDColor;
<span class="gi">+
</span>     // マテリアルのメインテクスチャサイズ
     private Vector2Int texSize;

@@ -118,6 +120,8 @@ public class Shed4Sprite : MonoBehaviour //opposite -&gt; courtyard
         newMaterial.SetTexture("_MainTex", sprite4Day.texture);
         newMaterial.SetTexture("_DayTex", sprite4Day.texture);
         newMaterial.SetTexture("_NightTex", sprite4Night.texture);
<span class="gi">+        Vector4 vect = (Color)IDColor;
+        newMaterial.SetVector("_IDColor", vect);
</span>         GetComponent&lt;MeshFilter&gt;().sharedMesh = mesh;
         GetComponent&lt;MeshRenderer&gt;().material = newMaterial;
     }
</code></pre></div>
</div>

<p>このクラスはエディタ拡張使ってるので、あわせてエディタクラスも修正（単にフィールド追加しただけ）。</p>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre class="with-code"><code><span class="gd">--- a/Assets/Assets/Scripts/Editor/Shed4SpriteEditor.cs
</span><span class="gi">+++ b/Assets/Assets/Scripts/Editor/Shed4SpriteEditor.cs
</span><span class="p">@@ -15,6 +15,7 @@</span> public class Shed4SpriteEditor : Editor
     SerializedProperty pivot;
     SerializedProperty size;
     SerializedProperty autoAdjust;
<span class="gi">+    SerializedProperty idColor;
</span>
     void OnEnable()
     {
<span class="p">@@ -25,6 +26,7 @@</span> public class Shed4SpriteEditor : Editor
         pivot = serializedObject.FindProperty("pivot");
         size = serializedObject.FindProperty("size");
         autoAdjust = serializedObject.FindProperty("autoSizeAdjust");
<span class="gi">+        idColor = serializedObject.FindProperty("IDColor");
</span>     }

     public override void OnInspectorGUI()
<span class="p">@@ -42,6 +44,7 @@</span> public class Shed4SpriteEditor : Editor
         EditorGUILayout.PropertyField(sprite4Day);
         EditorGUILayout.PropertyField(sprite4Night);
         EditorGUILayout.PropertyField(material);
<span class="gi">+        EditorGUILayout.PropertyField(idColor);
</span>
         EditorGUILayout.PropertyField(autoAdjust);
         if (autoAdjust.boolValue)
</code></pre></div></div>

<h2>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h2>

<p><code>#000001<span class="inline-code-color" style="background-color: #000001;"></span></code> とか <code>#FFFFFE<span class="inline-code-color" style="background-color: #FFFFFE;"></span></code> みたいな極端？な値も試してみましたが、うまく判定できてるようです。<br>
<a href="https://camo.qiitausercontent.com/4fd4a201350dda9e8315c050a7ba2648ab9740a1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f37313133323963352d393737342d383033392d343561632d3164323731393030353331642e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F711329c5-9774-8039-45ac-1d271900531d.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2aa16568c93ee2574b1fdeec2b1db680" alt="selection_console_log.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/711329c5-9774-8039-45ac-1d271900531d.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F711329c5-9774-8039-45ac-1d271900531d.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d0ff8be92da82400f0686c9bed4f8289 1x" loading="lazy"></a></p>

<h1>
<span id="選択したオブジェクトをハイライト表示" class="fragment"></span><a href="#%E9%81%B8%E6%8A%9E%E3%81%97%E3%81%9F%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88%E8%A1%A8%E7%A4%BA"><i class="fa fa-link"></i></a>選択したオブジェクトをハイライト表示</h1>

<p>次に、選択されたオブジェクトをゲーム画面上で<strong>色や輪郭を付けて、わかりやすく目立たせる</strong>ようにしたいと思います。IDカラーマップを参照して、指定した値に一致する場合にのみピクセルの色を加工したり、境界部分をハイライトカラーで塗りつぶしたりしてみます。</p>

<p>とりあえず、マウスクリックしたオブジェクトをハイライト表示させてみますが、仕組み的には目立たせたいIDカラーをシェーダー渡すだけなので、応用すればゲームイベントが発生してるオブジェクトは別の色でハイライト表示したり（しかも同時に複数選択も）、できるようになるはずです。</p>

<h2>
<span id="実装-1" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85-1"><i class="fa fa-link"></i></a>実装</h2>

<h3>
<span id="対象のidcolorをシェーダーに渡す" class="fragment"></span><a href="#%E5%AF%BE%E8%B1%A1%E3%81%AEidcolor%E3%82%92%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%AB%E6%B8%A1%E3%81%99"><i class="fa fa-link"></i></a>対象のIDColorをシェーダーに渡す</h3>

<p>ハイライト効果の描画はビルトインの Deferred Lighting を置き換えたシェーダーでやりますので、通常の方法ではプロパティー設定ができません（少なくとも私が調べた範囲では）。ですのでちょっとオーバヘッドが気になりますが、<a href="https://docs.unity3d.com/jp/460/ScriptReference/Shader.SetGlobalVector.html" rel="nofollow noopener" target="_blank">SetGlobalVector</a>で全シェーダーからアクセス可能な変数として登録します。</p>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre class="with-code"><code><span class="gd">--- a/Assets/Assets/Scripts/CaptureGBuffer.cs
</span><span class="gi">+++ b/Assets/Assets/Scripts/CaptureGBuffer.cs
</span><span class="p">@@ -19,6 +19,7 @@</span> public class CaptureGBuffer : MonoBehaviour
         texture = new Texture2D(1, 1, TextureFormat.RGBAFloat, false);
         renderTexture = new RenderTexture(1, 1, 0, RenderTextureFormat.ARGB32);
         renderTexture.filterMode = FilterMode.Point;
<span class="gi">+        Shader.SetGlobalVector("HighlightID", Color.black);
</span>
         buf = new CommandBuffer();
         buf.name = "GBuffer Test";
<span class="p">@@ -72,6 +73,7 @@</span> public class CaptureGBuffer : MonoBehaviour
         var seleted = FindObjectByIDColor(color);
         Debug.Log($"Color:{color}, Selection:{(seleted != null ? seleted.name:"N/A")}");
         if (seleted == null) return;
<span class="gi">+        Shader.SetGlobalVector("HighlightID", (Color)color);
</span>     }     
</code></pre></div></div>

<p><a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/a9894150794eb8826f5444aad5ce87e3e615b821/Assets/Assets/Scripts/CaptureGBuffer.cs" rel="nofollow noopener" target="_blank">ファイル全体</a></p>

<p>最初の行は、初期化時に無選択状態にリセットするものです。黒<code>#00000000</code>はIDカラーとして使わないという自分ルールを設けました。</p>

<h3>
<span id="シェーダーでハイライト表示" class="fragment"></span><a href="#%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%A7%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88%E8%A1%A8%E7%A4%BA"><i class="fa fa-link"></i></a>シェーダーでハイライト表示</h3>

<div class="code-frame" data-lang="diff">
<div class="code-lang"><span class="bold">DayNightPixelArtsLit.shader</span></div>
<div class="highlight"><pre class="with-code"><code> Shader "Hidden/DayNightPixelArtsLit"
 {
<span class="gi">+Properties
+{
+  HighlightColor ("Color fo source object ID", Color) = (0,1,1,1)
+}
</span> SubShader {
 // Pass 1: Lighting pass
 //  LDR case - Lighting encoded into a subtractive ARGB8 buffer
<span class="p">@@ -31,6 +35,9 @@</span> sampler2D _CameraGBufferTexture2;
 sampler2D _CameraGBufferTexture3;
 sampler2D _DepthTexture;
<span class="gi">+ 
+float4 HighlightID;
+half4 HighlightColor;
</span>
+
<span class="gi">+inline float _idMapEdge(float2 uv, float x, float y) {
+  float2 uv2 = float2(uv.x + x / _ScreenParams.x, uv.y + y / _ScreenParams.y);
+  half4 pix = tex2D (_CameraGBufferTexture1, uv2);
+  return step(length(pix - HighlightID),0.001);
+}
+
+float IsHighlightEdge (float2 uv)
+{
+    float e1 = max(_idMapEdge(uv, +1, 0), _idMapEdge(uv, -1, 0));
+    float e2 = max(_idMapEdge(uv, 0, +1), _idMapEdge(uv, 0, -1));
+    
+    return max(e1, e2);
+}
</span>
 half4 CalculateLight (unity_v2f_deferred i)
 {
     float2 uv = i.uv.xy / i.uv.w;
     half4 colDay = tex2D (_CameraGBufferTexture0, uv);
<span class="gd">-    half4 normal = tex2D (_CameraGBufferTexture1, uv);
-    half4 idCol = tex2D (_CameraGBufferTexture2, uv);
</span><span class="gi">+    half4 idCol = tex2D (_CameraGBufferTexture1, uv);
+    half4 normal = tex2D (_CameraGBufferTexture2, uv);
</span>     half3 colNight = tex2D (_CameraGBufferTexture3, uv);    
<span class="gd">-
-    float edge =  1 - CalcEdgeStrength (colDay.a, uv);   
</span><span class="gi">+    float edge =  1 - CalcEdgeStrength (colDay.a, uv);
</span>     // apply color burn effect to the day color.
     fixed3 colBurn = (1 - _LightColor .rgb) * _LightColor.a;
     colDay = fixed4(colDay.rgb - colBurn, 1) * edge;
<span class="gd">-    return half4(lerp(colNight, colDay.rgb, 1 - _LightColor.a), 1);
</span><span class="gi">+    half4 result = half4(lerp(colNight, colDay.rgb, 1 - _LightColor.a), 1);
+    float highlight =  length(idCol - HighlightID) &lt; 0.001 ? 0.25 : IsHighlightEdge (uv);
+    result = lerp(result, HighlightColor, highlight);
+    return result;
</span> }

 #ifdef UNITY_HDR_ON
</code></pre></div>
</div>

<p>idCol と normal の取得先のGBufferが変わってるのは、元々指定を間違ってただけです（まだ使ってないので気づかなかった）。それ以外の重要なところを以下に説明します。</p>

<p>まず、選択したIDカラーを受け取る <code>HighlightID</code> と、ハイライトカラーを設定する <code>HighlightColor</code> 変数の追加です。</p>

<div class="code-frame" data-lang="glsl">
<div class="code-lang"><span class="bold">DayNightPixelArtsLit.shader</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">Properties</span>
<span class="p">{</span>
  <span class="n">HighlightColor</span> <span class="p">(</span><span class="s">"Color fo source object ID"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">float4</span> <span class="n">HighlightID</span><span class="p">;</span>
<span class="n">half4</span> <span class="n">HighlightColor</span><span class="p">;</span>
</code></pre></div>
</div>

<p>ビルトインを置き換えたシェーダーのプロパティーをスクリプトから設定する方法はわかりませんが、初期値を入れておくことができるのでプロパティーにも記述してます。<br>
他方 <code>HighlightID</code> は SetGlobalVector から設定するので、プロパティーに宣言してはいけません。<strong>プロパティーに宣言した変数は SetGlobalXxx 系メソッドによって反映されませんので注意</strong>。</p>

<p>次にIDカラーマップの指定色との境界検知のメソッドです。 <code>IsHighlightEdge</code> は境界の外側1pixel 以内だったら1、それ以外だったら0を返します。</p>

<div class="code-frame" data-lang="glsl">
<div class="code-lang"><span class="bold">DayNightPixelArtsLit.shader</span></div>
<div class="highlight"><pre class="with-code"><code><span class="kr">inline</span> <span class="kt">float</span> <span class="nf">_idMapEdge</span><span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">float2</span> <span class="n">uv2</span> <span class="o">=</span> <span class="n">float2</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">_ScreenParams</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">y</span> <span class="o">/</span> <span class="n">_ScreenParams</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
  <span class="n">half4</span> <span class="n">pix</span> <span class="o">=</span> <span class="n">tex2D</span> <span class="p">(</span><span class="n">_CameraGBufferTexture1</span><span class="p">,</span> <span class="n">uv2</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">step</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">pix</span> <span class="o">-</span> <span class="n">HighlightID</span><span class="p">),</span><span class="mi">0</span><span class="p">.</span><span class="mo">001</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float</span> <span class="nf">IsHighlightEdge</span> <span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">_idMapEdge</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">_idMapEdge</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
    <span class="kt">float</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">_idMapEdge</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">_idMapEdge</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>そして上記メソッドを使って、出力カラーを調整する部分は以下のようになります。</p>

<div class="code-frame" data-lang="glsl">
<div class="code-lang"><span class="bold">DayNightPixelArtsLit.shader</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">half4</span> <span class="nf">CalculateLight</span> <span class="p">(</span><span class="n">unity_v2f_deferred</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ..前略..</span>

    <span class="n">half4</span> <span class="n">result</span> <span class="o">=</span> <span class="n">half4</span><span class="p">(</span><span class="n">lerp</span><span class="p">(</span><span class="n">colNight</span><span class="p">,</span> <span class="n">colDay</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">a</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">highlight</span> <span class="o">=</span>  <span class="n">length</span><span class="p">(</span><span class="n">idCol</span> <span class="o">-</span> <span class="n">HighlightID</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mo">001</span> <span class="o">?</span> <span class="mi">0</span><span class="p">.</span><span class="mi">25</span> <span class="o">:</span> <span class="n">IsHighlightEdge</span> <span class="p">(</span><span class="n">uv</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">HighlightColor</span><span class="p">,</span> <span class="n">highlight</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div>
</div>

<p><a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/day-night_deferred_redering/Assets/Assets/Resources/DayNightPixelArtsLit.shader" rel="nofollow noopener" target="_blank">ファイル全体</a></p>

<p><code>highlight</code> 変数は <code>idCol</code> と <code>HighlightID</code> がほぼ同じ（※float演算なので誤差を許容する）なら 0.25、それ以外なら <code>IsHighlightEdge()</code> の結果、境界ピクセルなら1、そうでなければ0が入ります。<br>
あとは、<code>result</code> にハイライト適用前の出力カラーが履いていますので、 lerp関数を使って<code>highlight</code> 変数の値に応じて <code>HighlightColor</code> と混ぜ合わせています。 </p>

<h2>
<span id="結果-1" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C-1"><i class="fa fa-link"></i></a>結果</h2>

<p>冒頭の画像のようになりました<br>
<a href="https://camo.qiitausercontent.com/59fed1bb767da65cb093d302605ea92c875bd616/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f63386532356562372d353065302d613466632d653139392d3232393034356432643331652e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fc8e25eb7-50e0-a4fc-e199-229045d2d31e.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ec98856f88d19f28369ca0cb59b0ba7c" alt="selection-highlight.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/c8e25eb7-50e0-a4fc-e199-229045d2d31e.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fc8e25eb7-50e0-a4fc-e199-229045d2d31e.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0c0dd0688d01f9a31de5206a6ce598d5 1x" loading="lazy"></a></p>

<p>本来ならテクスチャが透明なだけで、手前に mesh が存在するようなオブジェクト同士の境界付近でも正確に奥のオブジェクトを選択できていますね！</p>

<p><a href="https://camo.qiitausercontent.com/6355184e8398c5197c94071b2024ad187c85b362/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f33643838323835372d383265372d633437622d303434662d3265326639326139316363382e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F3d882857-82e7-c47b-044f-2e2f92a91cc8.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=012a8f024492acf2cbb10fca2a4398d5" alt="pixel_selection.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/3d882857-82e7-c47b-044f-2e2f92a91cc8.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F3d882857-82e7-c47b-044f-2e2f92a91cc8.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=c5375d02ec56bd0c32b1b8d176a9aea1 1x" loading="lazy"></a></p>

<h1>
<span id="おまけ-深度情報でアウトライン輪郭線を描く" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91-%E6%B7%B1%E5%BA%A6%E6%83%85%E5%A0%B1%E3%81%A7%E3%82%A2%E3%82%A6%E3%83%88%E3%83%A9%E3%82%A4%E3%83%B3%E8%BC%AA%E9%83%AD%E7%B7%9A%E3%82%92%E6%8F%8F%E3%81%8F"><i class="fa fa-link"></i></a>[おまけ] 深度情報でアウトライン(輪郭線)を描く</h1>

<p>さて、せっかく深度バッファが手近(?)にあるので、深度バッファを使ってオブジェクトの輪郭を強調してみたいと思います。<br>
以前書いた「<a href="https://qiita.com/Shinoda_Naoki/items/734fee861fe8abfca228" id="reference-49d6a37883a1d7ba8a3d">綺麗なアウトラインシェーダーを作る</a>」の超簡易版ですね。</p>

<h2>
<span id="深度情報を複製" class="fragment"></span><a href="#%E6%B7%B1%E5%BA%A6%E6%83%85%E5%A0%B1%E3%82%92%E8%A4%87%E8%A3%BD"><i class="fa fa-link"></i></a>深度情報を複製</h2>

<p><a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/day-night_deferred_redering/Assets/Assets/Shader/DayNightPixelArtsGBuffer.shader" rel="nofollow noopener" target="_blank">DayNightPixelArtsGBuffer.shader</a>でG-Bufferと一緒に深度バッファも書き出してるので、G-Bufferを読みだしてる<a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/day-night_deferred_redering/Assets/Assets/Resources/DayNightPixelArtsLit.shader" rel="nofollow noopener" target="_blank">DayNightPixelArtsLit.shader</a>で同じように深度バッファも読み出せる・・・と思ってましたが甘かったです。</p>

<p>DayNightPixelArtsLit.shader でも<strong>普通に深度バッファにアクセスできるのですが、中身は空っぽになってしまている</strong>（正確にはグレーの小さなテクスチャになってる）ようです。</p>

<p>以前 FrameDebugger で見た時、 CopyDepth っていうシェーダーが挟まってましたが、この前後で失われてしまうようです。<br>
<a href="https://camo.qiitausercontent.com/abd89252b6ac26244eb2054d527cecacc821b7f0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f64653033383238322d633334642d336161322d386230652d3730346630313134313639642e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fde038282-c34d-3aa2-8b0e-704f0114169d.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5931c9d2d93955d1580c48db0be10f54" alt="framedebugger_cpopydepth.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/de038282-c34d-3aa2-8b0e-704f0114169d.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fde038282-c34d-3aa2-8b0e-704f0114169d.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a8dc5a516cea51ca7a5824451f16e519 1x" loading="lazy"></a></p>

<p>CopyDepth シェーダーは置き換え可能なビルトインシェーダーではないし、そもそも何かしら技術的に制約があるからコピーしてるんだろうと思われますから、DayNightPixelArtsGBuffer.shader で書いた深度バッファそのものにアクセスするのは諦めたほうがよさそうです。</p>

<p>そこで、深度バッファは１チャネルあれば十分なので、昼画像用G-Bufferのアルファチャネルを使うことにしました。<br>
こちらは各ゲームオブジェクトのシェーダーです。</p>

<div class="code-frame" data-lang="diff">
<div class="code-lang"><span class="bold">DayNightPixelArtsGBuffer.shader</span></div>
<div class="highlight"><pre class="with-code"><code>      void frag (in v2f i, out flagout o)
      {
        // ..中略..


<span class="gd">-       o.gBuffer0 = colDay;
</span><span class="gi">+       o.gBuffer0 = fixed4(colDay.rgb, i.position.z);
</span>        o.gBuffer3 = colNight;
        o.gBuffer2 = float4(i.normal, 0) * 0.5 + float4(0.5, 0.5, 0.5, 0);
        o.gBuffer1 = _IDColor;
        o.depth = i.position.z;
      }
</code></pre></div>
</div>

<p>既存の深度バッファの書き出しに加えて、<code>gBuffer0</code> にも <code>position.z</code> を書き込んでいます。</p>

<h2>
<span id="最終合成deferred-lightingシェーダー修正" class="fragment"></span><a href="#%E6%9C%80%E7%B5%82%E5%90%88%E6%88%90deferred-lighting%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E4%BF%AE%E6%AD%A3"><i class="fa fa-link"></i></a>最終合成(deferred lighting)シェーダー修正</h2>

<p>そして、こちらが Deferred Lighting シェーダー側です。境界線を描くということで、上で紹介したハイライト表示の輪郭線の時とよく似たメソッドを追加してます。ただしこちらは 0/1 ではなく smoothstep 関数を利用して、<strong>ある程度深度差に応じた値</strong>を返しています。</p>

<div class="code-frame" data-lang="glsl">
<div class="code-lang"><span class="bold">DayNightPixelArtsLit.shader</span></div>
<div class="highlight"><pre class="with-code"><code><span class="kr">inline</span> <span class="kt">float</span> <span class="nf">_depthEdge</span><span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">float</span> <span class="n">base</span><span class="p">,</span> <span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">float2</span> <span class="n">uv2</span> <span class="o">=</span> <span class="n">float2</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">_ScreenParams</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">y</span> <span class="o">/</span> <span class="n">_ScreenParams</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
  <span class="n">half4</span> <span class="n">pix</span> <span class="o">=</span> <span class="n">tex2D</span> <span class="p">(</span><span class="n">_CameraGBufferTexture0</span><span class="p">,</span> <span class="n">uv2</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="n">pix</span><span class="p">.</span><span class="n">a</span> <span class="o">-</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">float</span> <span class="nf">CalcEdgeStrength</span> <span class="p">(</span><span class="kt">float</span> <span class="n">d</span><span class="p">,</span> <span class="n">float2</span> <span class="n">uv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">_depthEdge</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">_depthEdge</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
    <span class="kt">float</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">_depthEdge</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">_depthEdge</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">max</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">75</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">half4</span> <span class="nf">CalculateLight</span> <span class="p">(</span><span class="n">unity_v2f_deferred</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ..中略..</span>

    <span class="kt">float</span> <span class="n">edge</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">-</span> <span class="n">CalcEdgeStrength</span> <span class="p">(</span><span class="n">colDay</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
    <span class="c1">// apply color burn effect to the day color.</span>
    <span class="n">fixed3</span> <span class="n">colBurn</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_LightColor</span> <span class="p">.</span><span class="n">rgb</span><span class="p">)</span> <span class="o">*</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
    <span class="n">colDay</span> <span class="o">=</span> <span class="n">fixed4</span><span class="p">(</span><span class="n">colDay</span><span class="p">.</span><span class="n">rgb</span> <span class="o">-</span> <span class="n">colBurn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">edge</span><span class="p">;</span>
    <span class="n">half4</span> <span class="n">result</span> <span class="o">=</span> <span class="n">half4</span><span class="p">(</span><span class="n">lerp</span><span class="p">(</span><span class="n">colNight</span><span class="p">,</span> <span class="n">colDay</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_LightColor</span><span class="p">.</span><span class="n">a</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// ..中略..</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/day-night_deferred_redering/Assets/Assets/Resources/DayNightPixelArtsLit.shader" rel="nofollow noopener" target="_blank">ファイル全体</a></p>

<p><code>CalcEdgeStrength()</code> を使って現在のピクセルのエッジ強度を <code>edge</code> 変数に代入し、<code>colDay</code> の<a href="https://qiita.com/Shinoda_Naoki/items/36ad022200616c229936#%E3%83%AA%E3%83%8B%E3%82%A2%E7%84%BC%E3%81%8D%E3%81%93%E3%81%BFlinear-burn" id="reference-c7af3301b1d40a3a8c6c">リニア焼きこみ処理</a>時についでに <code>edge</code> をかけて、エッジ強度が強ければ暗くなるようにしてます。</p>

<h2>
<span id="結果-2" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C-2"><i class="fa fa-link"></i></a>結果</h2>

<p>ピクセル等倍だとわかり辛いので、ビフォーアフターを切り替えたgifアニメーションさせてみました。控えめながら、建物と建物の境界がより明瞭になったのではないでしょうか。<br>
<a href="https://camo.qiitausercontent.com/ff40f0a0f6ee5744d6cfae66c7a9f199d3b8b21e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f64656463653364302d656332642d396333622d663938332d3937666236363465316165342e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fdedce3d0-ec2d-9c3b-f983-97fb664e1ae4.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fad95d3dbe373e4ef959fee1a7f3cb36" alt="outline_blink.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/dedce3d0-ec2d-9c3b-f983-97fb664e1ae4.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fdedce3d0-ec2d-9c3b-f983-97fb664e1ae4.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=def7d38960c344980d6a9b0aedabb07e 1x" loading="lazy"></a></p>

<p><strong>深度差が大きいほどエッジ強度が強くなってる</strong>ということがわかりやすいように、昼画像の代わりに深度＋アウトラインを描きだしてみました。<br>
<a href="https://camo.qiitausercontent.com/892fec54ad3fd6111603e19b4a5a155aa875be08/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f62616562323761362d363933352d346336312d626239612d3332366165663362383234642e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fbaeb27a6-6935-4c61-bb9a-326aef3b824d.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=92f0b5caaeea0977c3f44d20eca714dd" alt="depth_edge.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/baeb27a6-6935-4c61-bb9a-326aef3b824d.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fbaeb27a6-6935-4c61-bb9a-326aef3b824d.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4ee73cd282404161e8bdb3a92739f73e 1x" loading="lazy"></a></p>

<p>ところで、カメラには <a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/5a4229fefb7ab563f03d07a7c202fe7b4de7108d/Assets/Assets/Scripts/QuaterView.cs" rel="nofollow noopener" target="_blank">Quater View</a> という自作コンポーネントが付いていて、<strong>１ピクセルを何倍で描画するか指定できる</strong>ようになってるんですが、拡大処理はG-Bufferへの書き出し時に行われるので、深度アウトラインは影響されません。</p>

<p>ですからピクセル倍率を上げても、アウトラインは常に1ピクセル幅で描画されます。<br>
（ちなみにハイライトの輪郭も同じ仕組みなので、常に1ピクセル幅です）</p>

<p><a href="https://camo.qiitausercontent.com/b385ff6c8c250ca82a62834e7b087511ebb6829c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f36623635383538612d353030642d333731622d333363342d3039316332346663613033322e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F6b65858a-500d-371b-33c4-091c24fca032.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c7d516838db1e29b8b3d37bb313b772d" alt="scale_and_edge_width.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/6b65858a-500d-371b-33c4-091c24fca032.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F6b65858a-500d-371b-33c4-091c24fca032.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=32561b05967035cd9e4052aae51d2150 1x" loading="lazy"></a><br>
ピクセル倍率:4 での描画結果はこんな感じです。<br>
<a href="https://camo.qiitausercontent.com/c74a0b457282b6573d824d218a5964abbf434a45/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f33353439383239622d643866632d623130662d306333332d3834383163396239663565652e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F3549829b-d8fc-b10f-0c33-8481c9b9f5ee.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=055428fc020f0bb326b4ebcd97e30bd2" alt="scale_and_edge_width_colored.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/3549829b-d8fc-b10f-0c33-8481c9b9f5ee.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F3549829b-d8fc-b10f-0c33-8481c9b9f5ee.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=fe721634da1eff9a757497ae762fd878 1x" loading="lazy"></a></p>

<p>アウトラインまで4倍になると画面がうるさくなりそうなので、これぐらいで良いかなと思ってます。</p>

<h2>
<span id="3dメッシュとの混成20200124-追記" class="fragment"></span><a href="#3d%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%A8%E3%81%AE%E6%B7%B7%E6%88%9020200124-%E8%BF%BD%E8%A8%98"><i class="fa fa-link"></i></a>3Dメッシュとの混成（2020/01/24 追記）</h2>

<p>元々この手法のメリットの一つとして <strong>ドット絵と通常の3Dオブジェクトの共存</strong> が挙げられたのですが、今回作成した機能を3Dオブジェクトにも適用できるように、追加拡張を行いました。</p>

<p>DayNightPixelArtsGBuffer.shader をベースに 3D メッシュ用のシェーダーを作ります。主なポイントは、1. 昼用・夜用テクスチャの区別がない事、2. フラグメントシェーダーで <strong>簡易ライティング処理</strong> をしてることです。</p>

<div class="code-frame" data-lang="glsl">
<div class="code-lang"><span class="bold">DayNight3DMeshGBuffer.shader</span></div>
<div class="highlight"><pre class="with-code"><code>  <span class="n">Properties</span>
  <span class="p">{</span>
    <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Day Texture"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="n">_IDColor</span> <span class="p">(</span><span class="s">"Color for source object ID"</span><span class="p">,</span> <span class="n">Vector</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// ...中略...</span>

      <span class="kt">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
      <span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
      <span class="n">float4</span> <span class="n">_IDColor</span><span class="p">;</span>

  <span class="c1">// ...中略...</span>

      <span class="kt">void</span> <span class="nf">frag</span> <span class="p">(</span><span class="k">in</span> <span class="n">v2f</span> <span class="n">i</span><span class="p">,</span> <span class="k">out</span> <span class="n">flagout</span> <span class="n">o</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="kr">half</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">_WorldSpaceLightPos0</span><span class="p">));</span>

        <span class="n">fixed4</span> <span class="n">colDay</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">)</span> <span class="o">*</span> <span class="n">lerp</span><span class="p">(</span><span class="n">NdotL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">75</span><span class="p">);</span>

        <span class="c1">// use 25% brightness of day texture, if night texture is disabled.</span>
        <span class="n">fixed4</span> <span class="n">colNight</span> <span class="o">=</span> <span class="n">colDay</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="p">;</span>

        <span class="n">o</span><span class="p">.</span><span class="n">gBuffer0</span> <span class="o">=</span> <span class="n">fixed4</span><span class="p">(</span><span class="n">colDay</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
        <span class="n">o</span><span class="p">.</span><span class="n">gBuffer3</span> <span class="o">=</span> <span class="n">fixed4</span><span class="p">(</span><span class="n">colNight</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">o</span><span class="p">.</span><span class="n">gBuffer2</span> <span class="o">=</span> <span class="n">float4</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">+</span> <span class="n">float4</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">o</span><span class="p">.</span><span class="n">gBuffer1</span> <span class="o">=</span> <span class="n">_IDColor</span><span class="p">;</span>
        <span class="n">o</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
      <span class="p">}</span>
</code></pre></div>
</div>

<p><a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/4d3e993dda80a2fdb6c68f6dc9069c70d982245a/Assets/Assets/Shader/DayNight3DMeshGBuffer.shader" rel="nofollow noopener" target="_blank">ファイル全体</a></p>

<p>Deferred レンダリングを独自にカスタマイズしてるので、<strong>本来の Deferred ライティングは適用できません</strong>。フラグメントシェーダー(frag) の冒頭で <code>NdotL</code> に照明と法線の内積を計算して、<code>colDay</code> に掛けることで、法線ベクトルに応じた簡単な陰影を付けています。<br>
ドット絵と共存させるような3Dオブジェクトに、そこまで高度なライティングは要求されないだろうし、夕焼けアニメーションにいい感じに調和させるためにも、必要な処理です。<br>
なお<strong>陰影は光源ベクトルに依存するので、ドット絵の仮想的な光源方向に合わせる</strong>必要があります。今回は下記のように設定してみました。</p>

<p><a href="https://camo.qiitausercontent.com/3ccc7acf5f90697406035a23a1db8621f55ba2c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f65626364616666342d666538632d386134622d646233302d3431336561313166346461342e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Febcdaff4-fe8c-8a4b-db30-413ea11f4da4.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a287081bd24262061bcb212599c5f62b" alt="ezgif.com-video-to-gif.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/ebcdaff4-fe8c-8a4b-db30-413ea11f4da4.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Febcdaff4-fe8c-8a4b-db30-413ea11f4da4.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=08d358be5dd48c9bfd888a93c8c08018 1x" loading="lazy"></a><a href="https://camo.qiitausercontent.com/96b362baba3de13889aa63c483d7db4a0863fb52/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f63653866303731362d323634642d653238652d663130392d6166393139366239376334662e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fce8f0716-264d-e28e-f109-af9196b97c4f.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=89972b3759d0f480326b1f14a4b04add" alt="lighting.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/ce8f0716-264d-e28e-f109-af9196b97c4f.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fce8f0716-264d-e28e-f109-af9196b97c4f.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0bbccaa34caba523de89385553329310 1x" loading="lazy"></a></p>

<p>一方C#スクリプト側ではIDカラーマップ対応のために、もともと <a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/4d3e993dda80a2fdb6c68f6dc9069c70d982245a/Assets/Assets/Scripts/Shed4Sprite.cs#L7" rel="nofollow noopener" target="_blank">Shade4Sprite</a> にだけあった IDColor を3Dメッシュにも関連付けるための基本クラスを用意します。Shade4Sprite はこのクラスを継承するようにします。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">HasIDColor.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">HasIDColor</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Color32</span> <span class="n">IDColor</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/c9617294aa1aa93b7dee9a7a4d855a3013f545a9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f32313930333731372d623564332d396636632d643666622d6536303437633535663061312e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F21903717-b5d3-9f6c-d6fb-e6047c55f0a1.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8a34be667664205eb61524974a78a271" alt="cube_inspector.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/21903717-b5d3-9f6c-d6fb-e6047c55f0a1.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F21903717-b5d3-9f6c-d6fb-e6047c55f0a1.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1a7977ffd8113d01b04b26313b35722f 1x" loading="lazy"></a><a href="https://camo.qiitausercontent.com/aa9a2e7bae1c774787038fc22a1c8eee157cf30d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f38643237643066662d396339612d363735632d313935362d3361316162303530653035342e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F8d27d0ff-9c9a-675c-1956-3a1ab050e054.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2a2b53b0f1df8b29ae26310596cf91ff" alt="material_inspector.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/8d27d0ff-9c9a-675c-1956-3a1ab050e054.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F8d27d0ff-9c9a-675c-1956-3a1ab050e054.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=72d8f28447e102577891e8fef8984e02 1x" loading="lazy"></a></p>

<p><a href="https://github.com/ShinodaNaoki/isometricPixelarts/blob/4d3e993dda80a2fdb6c68f6dc9069c70d982245a/Assets/Assets/Scripts/CaptureGBuffer.cs#L90-L96" rel="nofollow noopener" target="_blank">CaptureGBuffer クラスの FindObjectByIDColor() メソッド</a> では検索対象として Shade4Sprite ではなく HasIDColor クラスを取得するように変更します。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">CaptureGBuffer.cs</span></div>
<div class="highlight"><pre class="with-code"><code>    <span class="k">private</span> <span class="n">HasIDColor</span> <span class="nf">FindObjectByIDColor</span><span class="p">(</span><span class="n">Color32</span> <span class="n">idCol</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">structures</span> <span class="p">=</span> <span class="n">GameObject</span><span class="p">.</span><span class="n">FindObjectsOfType</span><span class="p">&lt;</span><span class="n">HasIDColor</span><span class="p">&gt;();</span>

        <span class="kt">var</span> <span class="n">found</span> <span class="p">=</span> <span class="n">Array</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">shed</span> <span class="p">=&gt;</span> <span class="n">idCol</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">shed</span><span class="p">.</span><span class="n">IDColor</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">found</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
</div>

<p>これで、3DオブジェクトにもIDカラーを割り当て、クリックで選択できるようになりました。<br>
<a href="https://camo.qiitausercontent.com/c67fd8c55419de8b630a996ce1604b164d3eeb53/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f38323166393133302d333233372d653463622d373038302d3462636531383032316334362e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F821f9130-3237-e4cb-7080-4bce18021c46.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6ec02ee363ff97f8eef3621838789614" alt="cube_selection.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/821f9130-3237-e4cb-7080-4bce18021c46.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F821f9130-3237-e4cb-7080-4bce18021c46.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f8f218ae34f09b81cca4e48a4cdf4b2f 1x" loading="lazy"></a></p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<ul>
<li>[前回]Deferred レンダリングのカスタマイズによって、描画時にIDカラーマップを作成した</li>
<li>IDカラーマップを使って、ピクセル単位で正確なオブジェクト選択ができた

<ul>
<li>ガンマ補正されたくないときはVector型でシェーダーに渡すとよい</li>
</ul>
</li>
<li>IDカラーマップを使って、特定のオブジェクトをハイライト表示することができた</li>
<li>ついでに深度エッジで輪郭線描画もできた

<ul>
<li>オリジナルの深度バッファにはアクセスできなかったが、代わりにGBuffer0のアルファチャネルを深度バッファの複製として使った</li>
</ul>
</li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FShinoda_Naoki%2Fitems%2F677952e9ab675985f2b6&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FShinoda_Naoki%2Fitems%2F677952e9ab675985f2b6&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6/likers" class="css-1iupg5d">12</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">14</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/677952e9ab675985f2b6/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Shinoda_Naoki/items/677952e9ab675985f2b6.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-536bb83a-aa3c-4528-be31-4b40498885dd">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-7c6628ae-472a-4cd7-9c6b-b961be01cdba"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-7c6628ae-472a-4cd7-9c6b-b961be01cdba">{}</script>
      
<div id="LoginModal-react-component-9d331ea9-7d4e-4294-9bd9-b0e4e3335b0a"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-9d331ea9-7d4e-4294-9bd9-b0e4e3335b0a">{}</script>
      
<div id="StockModal-react-component-6c7e6bf4-94d5-41c7-a547-62c63d7134ea"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-6c7e6bf4-94d5-41c7-a547-62c63d7134ea">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;UusDm7jhsYuSLgHd6rfggypnr75cOxEkZGKEmpC2KqAdh1hw8/QpLGynSQnmH/a+qGR3RCZlHI3HW8J3efEc7w==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"経緯\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%8C%E7%B7%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e経緯\u003c/h1\u003e\n\n\u003cp\u003e複数のドット絵オブジェクトで構成されたゲームシーンで、マウスでクリックした\u003cstrong\u003e指定座標位置にあるオブジェクトを、ピクセル単位で正確に判定したい\u003c/strong\u003eと思いました。また判定で見つけたオブジェクトを\u003cstrong\u003eハイライト表示（色フィルターや輪郭を付けたり）したい\u003c/strong\u003eと思いました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/59fed1bb767da65cb093d302605ea92c875bd616/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f63386532356562372d353065302d613466632d653139392d3232393034356432643331652e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fc8e25eb7-50e0-a4fc-e199-229045d2d31e.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ec98856f88d19f28369ca0cb59b0ba7c\" alt=\"selection-highlight.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/c8e25eb7-50e0-a4fc-e199-229045d2d31e.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fc8e25eb7-50e0-a4fc-e199-229045d2d31e.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0c0dd0688d01f9a31de5206a6ce598d5 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれまでの記事で、\u003cstrong\u003e\u003ca href=\"https://qiita.com/Shinoda_Naoki/items/fccdc137747ea4301578\" id=\"reference-7f91ebd040023636590c\"\u003eドット絵を深度バッファ付きで描画\u003c/a\u003e\u003c/strong\u003eして、\u003cstrong\u003e\u003ca href=\"https://qiita.com/Shinoda_Naoki/items/31bde73218b0295b8778\" id=\"reference-23d6871e2afcab5b6505\"\u003eDeferredをカスタマイズして昼夜画像をそれぞれ異なるRenderTargetに同時に書き出し\u003c/a\u003e\u003c/strong\u003e、夕方アニメーションが出来るようになりました。\u003cbr\u003e\nこの時ついでに、オブジェクトごとに\u003ccode\u003eIDColor\u003c/code\u003eなるものを割り当て、それを別のRenderTargetに書き出して、IDカラーマップ画像を作りました。このIDカラーマップ画像から指定座標の色を読みだして、\u003ccode\u003eIDColor\u003c/code\u003eが一致するオブジェクトを見つければ、\u003cstrong\u003eピクセル単位で正確な判定ができる\u003c/strong\u003eはずです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/25b03f9239bfde2a173892dd86c2aeaa1be906b8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f32363432393031662d323031382d376335332d613062642d3530656133303637643735342e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F2642901f-2018-7c53-a0bd-50ea3067d754.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=069d11a351cc2152383fc7d2e26d4cdc\" alt=\"gbuffer-rt1.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/2642901f-2018-7c53-a0bd-50ea3067d754.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F2642901f-2018-7c53-a0bd-50ea3067d754.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=31b8fc2aa523c5f81748e53ae42f1161 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"なぜidカラーマップが必要か\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AA%E3%81%9Cid%E3%82%AB%E3%83%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%97%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eなぜIDカラーマップが必要か？\u003c/h2\u003e\n\n\u003cp\u003eご存知の方には今更ですが、Unityでマウスでオブジェクトを選択したい場合などには \u003ca href=\"https://docs.unity3d.com/ja/2017.4/ScriptReference/Physics.Raycast.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eRay/Raycast\u003c/a\u003e と\u003ca href=\"https://docs.unity3d.com/jp/current/ScriptReference/Collider.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCollider\u003c/a\u003eを使うのが一般的だと思います。\u003cbr\u003e\n参考：\u003ca href=\"https://pengoya.net/unity/object-touch/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e【Unity】オブジェクトをタッチしたことを判定する方法【2D・3D】\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eしかし、この方法だとテクスチャの透過ピクセルを無視できないので、複数のオブジェクトが重なっている場合には正確な判定が出来ません。もしやるなら、Raycastで見つけたオブジェクトから\u003cstrong\u003eテクスチャのUV座標を逆算して、その位置のテクスチャーが透過色かどうかを調べる\u003c/strong\u003e必要があります。もし透過色だったらさらに奥のオブジェクトにRayを飛ばしていって、\u003cstrong\u003e透過色でないテクスチャに当たるか、何も当たらなくなるまで繰り返す\u003c/strong\u003e必要がありそうです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/57e20f895abe16c2ee38b601a36f3d9ca355e12d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f66383361663632622d643338612d613061622d303333342d6464373364666439383263662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Ff83af62b-d38a-a0ab-0334-dd73dfd982cf.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=607f2f50146eebe046e25a634388ba7e\" alt=\"transpalency_hittest.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/f83af62b-d38a-a0ab-0334-dd73dfd982cf.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Ff83af62b-d38a-a0ab-0334-dd73dfd982cf.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=65c69288da51953a2f2ac4fcaf6dad81 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれはどう考えても面倒くさい実装になりそうだし、テクスチャのピクセルを読むためにはテクスチャを\u003ca href=\"https://docs.unity3d.com/ja/2017.4/Manual/TextureTypes.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eRear/Write Enadable\u003c/a\u003eに設定する必要があるし、パフォーマンスも悪そうだと思いました。\u003c/p\u003e\n\n\u003cp\u003e先に書いたように、描画オブジェクトごとに\u003ccode\u003eIDColor\u003c/code\u003eを割り当て、それをメインのフラグメントシェーダーで\u003cstrong\u003e通常映像と同時に別のRenderTargetに書き出して、IDカラーマップ画像を作れば\u003c/strong\u003e、そこから指定座標の色を読み込んで、スクリプト側で\u003ccode\u003eIDColor\u003c/code\u003eに一致するオブジェクトを探す方が、必ず一度で済むし、コードも単純で正確で速い（※計測してないので、憶測ですが）でしょう。\u003c/p\u003e\n\n\u003cp\u003eさらにIDカラーマップ画像は、\u003cstrong\u003e特定のオブジェクトをハイライト表示\u003c/strong\u003e（明るく色をつけたり、輪郭線を付けたり）するときにも使えて一石二鳥です。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"座標位置のオブジェクト検索\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%BA%A7%E6%A8%99%E4%BD%8D%E7%BD%AE%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%A4%9C%E7%B4%A2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e座標位置のオブジェクト検索\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h2\u003e\n\n\u003cp\u003eIDカラーマップを描きだす部分は、冒頭にもリンクを張った\u003ca href=\"https://qiita.com/Shinoda_Naoki/items/31bde73218b0295b8778\"\u003e前回の記事\u003c/a\u003eで詳しく説明してますので、よろしければご覧ください。 Deferred レンダリングをカスタマイズして昼夜画像をそれぞれ異なるRenderTargetに同時に書き出すついでにIDカラーマップも描きだしてます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"g-bufferの指定位置の色を取得する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#g-buffer%E3%81%AE%E6%8C%87%E5%AE%9A%E4%BD%8D%E7%BD%AE%E3%81%AE%E8%89%B2%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eG-Bufferの指定位置の色を取得する\u003c/h3\u003e\n\n\u003cp\u003e参考までに、\u003cstrong\u003eカメラに表示されるシーンの色を取得する\u003c/strong\u003eのは、下記リンク先の内容ほぼそのままで出来ました。\u003cbr\u003e\n\u003ca href=\"https://teratail.com/questions/208439\" rel=\"nofollow noopener\" target=\"_blank\"\u003eunity　マウスクリックした部分の色を抽出する｜teratail\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e問題は\u003cstrong\u003eどうやって特定の G-Buffer の内容を取り出す\u003c/strong\u003eか・・・\u003cbr\u003e\nヒントは前回の記事でも引用したこちらの記事にありました。\u003cbr\u003e\n\u003ca href=\"https://matcha-choco010.net/2018/09/16/unity%E3%81%AEdeferred%E3%81%A7commandbuffer%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6g-buffer%E3%82%92%E3%81%84%E3%81%98%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnityのDeferredでCommandBufferを利用してGBufferをいじってみる\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.unity3d.com/ja/2017.4/ScriptReference/Rendering.CommandBuffer.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCommandBuffer\u003c/a\u003e なるものを使えば、G-Buffer を RenderTarget に指定するのは容易そうです。しかも \u003cstrong\u003e\u003ca href=\"https://docs.unity3d.com/ja/2017.4/ScriptReference/Rendering.CommandBuffer.CopyTexture.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCopyTexture\u003c/a\u003e\u003c/strong\u003e などという、まさにうってつけのメソッドがありました。\u003c/p\u003e\n\n\u003cp\u003e二つの記事を参考にできたのがこちらです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eCaptureGBuffer.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCaptureGBuffer\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eCommandBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eColor32\u003c/span\u003e \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eTexture2D\u003c/span\u003e \u003cspan class=\"n\"\u003etexture\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eRenderTexture\u003c/span\u003e \u003cspan class=\"n\"\u003erenderTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Start is called before the first frame update\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etexture\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eTexture2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTextureFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRGBAFloat\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderTexture\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRenderTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRenderTextureFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eARGB32\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efilterMode\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eFilterMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePoint\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCommandBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GBuffer Test\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecam\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eCamera\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eallCameras\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003ecam\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddCommandBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCameraEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAfterGBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#if UNITY_EDITOR\n\u003c/span\u003e        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esceneViewCameras\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSceneView\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAllSceneCameras\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecam\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003esceneViewCameras\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003ecam\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddCommandBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCameraEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAfterGBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eVector2Int\u003c/span\u003e \u003cspan class=\"nf\"\u003egetNormalizedMousePos\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e        \n\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClamp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eScreen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClamp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eScreen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2Int\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Update is called once per frame\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetMouseButtonDown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eRenderTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eactive\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erenderTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e        \n        \u003cspan class=\"n\"\u003etexture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadPixels\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etexture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetPixel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Color:\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnPostRender\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eRenderTargetIdentifier\u003c/span\u003e \u003cspan class=\"n\"\u003esrc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRenderTargetIdentifier\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBuiltinRenderTextureType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGBuffer1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRenderTargetIdentifier\u003c/span\u003e \u003cspan class=\"n\"\u003edst\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erenderTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2Int\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003egetNormalizedMousePos\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCopyTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRelease\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRelease\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"idcolorに合うオブジェクトを探す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#idcolor%E3%81%AB%E5%90%88%E3%81%86%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E6%8E%A2%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eIDColorに合うオブジェクトを探す\u003c/h3\u003e\n\n\u003cp\u003e色が取得できたなら後は難しいところはありません。シーン中のゲームオブジェクトから同じIDカラーを持つShedオブジェクトを見つけます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eCaptureGBuffer.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetMouseButtonDown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eRenderTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eactive\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erenderTexture\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e        \n        \u003cspan class=\"n\"\u003etexture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadPixels\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etexture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetPixel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eseleted\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eFindObjectByIDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Color:\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e, Selection:\u003c/span\u003e\u003cspan class=\"p\"\u003e{(\u003c/span\u003e\u003cspan class=\"n\"\u003eseleted\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003eseleted\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s\"\u003e\"N/A\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eseleted\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eShader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetGlobalVector\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"HighlightID\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eShed4Sprite\u003c/span\u003e \u003cspan class=\"nf\"\u003eFindObjectByIDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eColor32\u003c/span\u003e \u003cspan class=\"n\"\u003eidCol\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estructures\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGameObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFindObjectsOfType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eShed4Sprite\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efound\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estructures\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eshed\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eidCol\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eColor32\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eshed\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ematerial\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetColor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"_IDColor\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003efound\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e本格的に使うなら、毎回全検索せずにハッシュテーブルなどでIDカラーとオブジェクトの紐づけを管理する方がいいのでしょうが、今はとりあえず妥協してます。\u003c/p\u003e\n\n\u003cp\u003eところが、\u003cstrong\u003eこれでは上手く同じIDカラーを見つけられない場合がある\u003c/strong\u003eことがわかりました。\u003cbr\u003e\nなぜ見つからないかと言えば、\u003cstrong\u003eシェーダーに指定した色と、RenderTarget から取得した色が違う\u003c/strong\u003eからで、どうやら\u003cstrong\u003e\u003ca href=\"https://docs.unity3d.com/jp/460/Manual/LinearLighting.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eガンマ補正\u003c/a\u003e\u003c/strong\u003eが影響してることがわかってきました。\u003c/p\u003e\n\n\u003cp\u003eそこで、ガンマ補正を元に戻す方法を検討してみました。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"没案idcolor-のカラースペース変換を逆変換する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B2%A1%E6%A1%88idcolor-%E3%81%AE%E3%82%AB%E3%83%A9%E3%83%BC%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E5%A4%89%E6%8F%9B%E3%82%92%E9%80%86%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e【没案】IDColor のカラースペース変換を逆変換する\u003c/h3\u003e\n\n\u003cp\u003e前述の公式ドキュメントを見るとリニアライティングに変更すればいいのかな？とも思いますが、設定が面倒で制約も多そうなので躊躇われます。\u003cbr\u003e\nそこで、ググって見つけた記事（\u003ca href=\"https://github.com/EsotericSoftware/spine-runtimes/issues/1301%0Ahttps://teratail.com/questions/163790\" rel=\"nofollow noopener\" target=\"_blank\"\u003e※１\u003c/a\u003e、\u003ca href=\"https://teratail.com/questions/163790\" rel=\"nofollow noopener\" target=\"_blank\"\u003e※２\u003c/a\u003e）を参考に試行錯誤した結果、以下のようにしたら（少なくとも今までうまく一致しなかったケースにおいては）色の違いがなくなりました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"glsl\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDayNightPixelArtsGBuffer.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e      \u003cspan class=\"kr\"\u003einline\u003c/span\u003e \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"nf\"\u003elinearToSrgb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elerp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e12\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e92\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mo\"\u003e055\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003epow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mo\"\u003e055\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mo\"\u003e003130\u003c/span\u003e\u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n      \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003efrag\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003ev2f\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003eflagout\u003c/span\u003e \u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//..中略..//\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egBuffer1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eGammaToLinearSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elinearToSrgb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_IDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ergb\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e\u003cspan class=\"n\"\u003e_IDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/93a55986605ccc611b0bc39abe360430498ee779/Assets/Assets/Shader/DayNightPixelArtsGBuffer.shader\" rel=\"nofollow noopener\" target=\"_blank\"\u003eファイル全体\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eうーん、なんでガンマからリニアの変換だけじゃ足りないんですかね？\u003cstrong\u003esRGBってなんなの？\u003c/strong\u003eなんか直感にそぐわない変換式で困惑しました。\u003cbr\u003e\nそれでなくとも、\u003cstrong\u003eIDとしての性質上、少数部を超える誤差は致命的\u003c/strong\u003eなので、powとか使ったややこしい計算が\u003cstrong\u003e本当にどんな色も誤差なく逆変換できるのか心配\u003c/strong\u003eです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"idcolorをvectorにするカラースペース変換を完全無効化\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#idcolor%E3%82%92vector%E3%81%AB%E3%81%99%E3%82%8B%E3%82%AB%E3%83%A9%E3%83%BC%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E5%A4%89%E6%8F%9B%E3%82%92%E5%AE%8C%E5%85%A8%E7%84%A1%E5%8A%B9%E5%8C%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eIDColorをVectorにする（カラースペース変換を完全無効化）\u003c/h3\u003e\n\n\u003cp\u003e・・・しばらく思い悩んでいたら、はたと気づきました。\u003cbr\u003e\nそういえば法線マップはVectorを画像化しています。別に\u003cstrong\u003eVectorを色として描きだしてもいい\u003c/strong\u003eんじゃないの？そうすれば\u003cstrong\u003eカラースペース変換から逃れられるんじゃないの？\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eまず、シェーダーのプロパティを Color から Vector に変更しました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"diff\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gd\"\u003e--- a/Assets/Assets/Shader/DayNightPixelArtsGBuffer.shader\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/Assets/Assets/Shader/DayNightPixelArtsGBuffer.shader\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -5,7 +5,7 @@\u003c/span\u003e\n     [NoScaleOffset] _DayTex (\"Day Texture\", 2D) = \"white\" {}\n     [NoScaleOffset] _NightTex (\"Night Texture\", 2D) = \"black\" {}\n     _Transpalent (\"Transpalent Color\", Color) = (1,0,1,1)\n\u003cspan class=\"gd\"\u003e-    _IDColor (\"Color fo source object ID\", Color) = (0,0,0,0)\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+    _IDColor (\"Color fo source object ID\", Vector) = (0,0,0,0)\n\u003c/span\u003e   }\n   SubShader\n   {\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e視覚的に確認したり、16進数で指定するのに都合がいい\u003c/strong\u003eのでゲームオブジェクトにつける Shed コンポーネントに \u003ca href=\"https://docs.unity3d.com/ja/2017.4/ScriptReference/Color32.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eColor32\u003c/a\u003e 型の IDColor フィールドを追加して、 Start() でシェーダープロパティーを設定するようにしました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"diff\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eShed4Sprite.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gd\"\u003e--- a/Assets/Assets/Scripts/Shed4Sprite.cs\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/Assets/Assets/Scripts/Shed4Sprite.cs\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -46,6 +46,8 @@\u003c/span\u003e public class Shed4Sprite : MonoBehaviour //opposite -\u0026gt; courtyard\n     // ドット絵を保持するマテリアル\n     public Material material;\n\n+    public Color32 IDColor;\n\u003cspan class=\"gi\"\u003e+\n\u003c/span\u003e     // マテリアルのメインテクスチャサイズ\n     private Vector2Int texSize;\n\n@@ -118,6 +120,8 @@ public class Shed4Sprite : MonoBehaviour //opposite -\u0026gt; courtyard\n         newMaterial.SetTexture(\"_MainTex\", sprite4Day.texture);\n         newMaterial.SetTexture(\"_DayTex\", sprite4Day.texture);\n         newMaterial.SetTexture(\"_NightTex\", sprite4Night.texture);\n\u003cspan class=\"gi\"\u003e+        Vector4 vect = (Color)IDColor;\n+        newMaterial.SetVector(\"_IDColor\", vect);\n\u003c/span\u003e         GetComponent\u0026lt;MeshFilter\u0026gt;().sharedMesh = mesh;\n         GetComponent\u0026lt;MeshRenderer\u0026gt;().material = newMaterial;\n     }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこのクラスはエディタ拡張使ってるので、あわせてエディタクラスも修正（単にフィールド追加しただけ）。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"diff\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gd\"\u003e--- a/Assets/Assets/Scripts/Editor/Shed4SpriteEditor.cs\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/Assets/Assets/Scripts/Editor/Shed4SpriteEditor.cs\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -15,6 +15,7 @@\u003c/span\u003e public class Shed4SpriteEditor : Editor\n     SerializedProperty pivot;\n     SerializedProperty size;\n     SerializedProperty autoAdjust;\n\u003cspan class=\"gi\"\u003e+    SerializedProperty idColor;\n\u003c/span\u003e\n     void OnEnable()\n     {\n\u003cspan class=\"p\"\u003e@@ -25,6 +26,7 @@\u003c/span\u003e public class Shed4SpriteEditor : Editor\n         pivot = serializedObject.FindProperty(\"pivot\");\n         size = serializedObject.FindProperty(\"size\");\n         autoAdjust = serializedObject.FindProperty(\"autoSizeAdjust\");\n\u003cspan class=\"gi\"\u003e+        idColor = serializedObject.FindProperty(\"IDColor\");\n\u003c/span\u003e     }\n\n     public override void OnInspectorGUI()\n\u003cspan class=\"p\"\u003e@@ -42,6 +44,7 @@\u003c/span\u003e public class Shed4SpriteEditor : Editor\n         EditorGUILayout.PropertyField(sprite4Day);\n         EditorGUILayout.PropertyField(sprite4Night);\n         EditorGUILayout.PropertyField(material);\n\u003cspan class=\"gi\"\u003e+        EditorGUILayout.PropertyField(idColor);\n\u003c/span\u003e\n         EditorGUILayout.PropertyField(autoAdjust);\n         if (autoAdjust.boolValue)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結果\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003e#000001\u003cspan class=\"inline-code-color\" style=\"background-color: #000001;\"\u003e\u003c/span\u003e\u003c/code\u003e とか \u003ccode\u003e#FFFFFE\u003cspan class=\"inline-code-color\" style=\"background-color: #FFFFFE;\"\u003e\u003c/span\u003e\u003c/code\u003e みたいな極端？な値も試してみましたが、うまく判定できてるようです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/4fd4a201350dda9e8315c050a7ba2648ab9740a1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f37313133323963352d393737342d383033392d343561632d3164323731393030353331642e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F711329c5-9774-8039-45ac-1d271900531d.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2aa16568c93ee2574b1fdeec2b1db680\" alt=\"selection_console_log.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/711329c5-9774-8039-45ac-1d271900531d.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F711329c5-9774-8039-45ac-1d271900531d.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d0ff8be92da82400f0686c9bed4f8289 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"選択したオブジェクトをハイライト表示\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%81%B8%E6%8A%9E%E3%81%97%E3%81%9F%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88%E8%A1%A8%E7%A4%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e選択したオブジェクトをハイライト表示\u003c/h1\u003e\n\n\u003cp\u003e次に、選択されたオブジェクトをゲーム画面上で\u003cstrong\u003e色や輪郭を付けて、わかりやすく目立たせる\u003c/strong\u003eようにしたいと思います。IDカラーマップを参照して、指定した値に一致する場合にのみピクセルの色を加工したり、境界部分をハイライトカラーで塗りつぶしたりしてみます。\u003c/p\u003e\n\n\u003cp\u003eとりあえず、マウスクリックしたオブジェクトをハイライト表示させてみますが、仕組み的には目立たせたいIDカラーをシェーダー渡すだけなので、応用すればゲームイベントが発生してるオブジェクトは別の色でハイライト表示したり（しかも同時に複数選択も）、できるようになるはずです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実装-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"対象のidcolorをシェーダーに渡す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AF%BE%E8%B1%A1%E3%81%AEidcolor%E3%82%92%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%AB%E6%B8%A1%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e対象のIDColorをシェーダーに渡す\u003c/h3\u003e\n\n\u003cp\u003eハイライト効果の描画はビルトインの Deferred Lighting を置き換えたシェーダーでやりますので、通常の方法ではプロパティー設定ができません（少なくとも私が調べた範囲では）。ですのでちょっとオーバヘッドが気になりますが、\u003ca href=\"https://docs.unity3d.com/jp/460/ScriptReference/Shader.SetGlobalVector.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eSetGlobalVector\u003c/a\u003eで全シェーダーからアクセス可能な変数として登録します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"diff\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gd\"\u003e--- a/Assets/Assets/Scripts/CaptureGBuffer.cs\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/Assets/Assets/Scripts/CaptureGBuffer.cs\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -19,6 +19,7 @@\u003c/span\u003e public class CaptureGBuffer : MonoBehaviour\n         texture = new Texture2D(1, 1, TextureFormat.RGBAFloat, false);\n         renderTexture = new RenderTexture(1, 1, 0, RenderTextureFormat.ARGB32);\n         renderTexture.filterMode = FilterMode.Point;\n\u003cspan class=\"gi\"\u003e+        Shader.SetGlobalVector(\"HighlightID\", Color.black);\n\u003c/span\u003e\n         buf = new CommandBuffer();\n         buf.name = \"GBuffer Test\";\n\u003cspan class=\"p\"\u003e@@ -72,6 +73,7 @@\u003c/span\u003e public class CaptureGBuffer : MonoBehaviour\n         var seleted = FindObjectByIDColor(color);\n         Debug.Log($\"Color:{color}, Selection:{(seleted != null ? seleted.name:\"N/A\")}\");\n         if (seleted == null) return;\n\u003cspan class=\"gi\"\u003e+        Shader.SetGlobalVector(\"HighlightID\", (Color)color);\n\u003c/span\u003e     }     \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/a9894150794eb8826f5444aad5ce87e3e615b821/Assets/Assets/Scripts/CaptureGBuffer.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eファイル全体\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e最初の行は、初期化時に無選択状態にリセットするものです。黒\u003ccode\u003e#00000000\u003c/code\u003eはIDカラーとして使わないという自分ルールを設けました。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"シェーダーでハイライト表示\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%A7%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88%E8%A1%A8%E7%A4%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eシェーダーでハイライト表示\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"diff\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDayNightPixelArtsLit.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e Shader \"Hidden/DayNightPixelArtsLit\"\n {\n\u003cspan class=\"gi\"\u003e+Properties\n+{\n+  HighlightColor (\"Color fo source object ID\", Color) = (0,1,1,1)\n+}\n\u003c/span\u003e SubShader {\n // Pass 1: Lighting pass\n //  LDR case - Lighting encoded into a subtractive ARGB8 buffer\n\u003cspan class=\"p\"\u003e@@ -31,6 +35,9 @@\u003c/span\u003e sampler2D _CameraGBufferTexture2;\n sampler2D _CameraGBufferTexture3;\n sampler2D _DepthTexture;\n\u003cspan class=\"gi\"\u003e+ \n+float4 HighlightID;\n+half4 HighlightColor;\n\u003c/span\u003e\n+\n\u003cspan class=\"gi\"\u003e+inline float _idMapEdge(float2 uv, float x, float y) {\n+  float2 uv2 = float2(uv.x + x / _ScreenParams.x, uv.y + y / _ScreenParams.y);\n+  half4 pix = tex2D (_CameraGBufferTexture1, uv2);\n+  return step(length(pix - HighlightID),0.001);\n+}\n+\n+float IsHighlightEdge (float2 uv)\n+{\n+    float e1 = max(_idMapEdge(uv, +1, 0), _idMapEdge(uv, -1, 0));\n+    float e2 = max(_idMapEdge(uv, 0, +1), _idMapEdge(uv, 0, -1));\n+    \n+    return max(e1, e2);\n+}\n\u003c/span\u003e\n half4 CalculateLight (unity_v2f_deferred i)\n {\n     float2 uv = i.uv.xy / i.uv.w;\n     half4 colDay = tex2D (_CameraGBufferTexture0, uv);\n\u003cspan class=\"gd\"\u003e-    half4 normal = tex2D (_CameraGBufferTexture1, uv);\n-    half4 idCol = tex2D (_CameraGBufferTexture2, uv);\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+    half4 idCol = tex2D (_CameraGBufferTexture1, uv);\n+    half4 normal = tex2D (_CameraGBufferTexture2, uv);\n\u003c/span\u003e     half3 colNight = tex2D (_CameraGBufferTexture3, uv);    \n\u003cspan class=\"gd\"\u003e-\n-    float edge =  1 - CalcEdgeStrength (colDay.a, uv);   \n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+    float edge =  1 - CalcEdgeStrength (colDay.a, uv);\n\u003c/span\u003e     // apply color burn effect to the day color.\n     fixed3 colBurn = (1 - _LightColor .rgb) * _LightColor.a;\n     colDay = fixed4(colDay.rgb - colBurn, 1) * edge;\n\u003cspan class=\"gd\"\u003e-    return half4(lerp(colNight, colDay.rgb, 1 - _LightColor.a), 1);\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+    half4 result = half4(lerp(colNight, colDay.rgb, 1 - _LightColor.a), 1);\n+    float highlight =  length(idCol - HighlightID) \u0026lt; 0.001 ? 0.25 : IsHighlightEdge (uv);\n+    result = lerp(result, HighlightColor, highlight);\n+    return result;\n\u003c/span\u003e }\n\n #ifdef UNITY_HDR_ON\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eidCol と normal の取得先のGBufferが変わってるのは、元々指定を間違ってただけです（まだ使ってないので気づかなかった）。それ以外の重要なところを以下に説明します。\u003c/p\u003e\n\n\u003cp\u003eまず、選択したIDカラーを受け取る \u003ccode\u003eHighlightID\u003c/code\u003e と、ハイライトカラーを設定する \u003ccode\u003eHighlightColor\u003c/code\u003e 変数の追加です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"glsl\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDayNightPixelArtsLit.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eProperties\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eHighlightColor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Color fo source object ID\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003eHighlightID\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003ehalf4\u003c/span\u003e \u003cspan class=\"n\"\u003eHighlightColor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eビルトインを置き換えたシェーダーのプロパティーをスクリプトから設定する方法はわかりませんが、初期値を入れておくことができるのでプロパティーにも記述してます。\u003cbr\u003e\n他方 \u003ccode\u003eHighlightID\u003c/code\u003e は SetGlobalVector から設定するので、プロパティーに宣言してはいけません。\u003cstrong\u003eプロパティーに宣言した変数は SetGlobalXxx 系メソッドによって反映されませんので注意\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e次にIDカラーマップの指定色との境界検知のメソッドです。 \u003ccode\u003eIsHighlightEdge\u003c/code\u003e は境界の外側1pixel 以内だったら1、それ以外だったら0を返します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"glsl\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDayNightPixelArtsLit.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kr\"\u003einline\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"nf\"\u003e_idMapEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003euv2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003e_ScreenParams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003e_ScreenParams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ehalf4\u003c/span\u003e \u003cspan class=\"n\"\u003epix\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etex2D\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_CameraGBufferTexture1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euv2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003estep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epix\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eHighlightID\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mo\"\u003e001\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"nf\"\u003eIsHighlightEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_idMapEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003e_idMapEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_idMapEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003e_idMapEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eそして上記メソッドを使って、出力カラーを調整する部分は以下のようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"glsl\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDayNightPixelArtsLit.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003ehalf4\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalculateLight\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eunity_v2f_deferred\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ..前略..\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ehalf4\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehalf4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elerp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolNight\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecolDay\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ergb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003e_LightColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ehighlight\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e  \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eidCol\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eHighlightID\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mo\"\u003e001\u003c/span\u003e \u003cspan class=\"o\"\u003e?\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e25\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIsHighlightEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elerp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eHighlightColor\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ehighlight\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/day-night_deferred_redering/Assets/Assets/Resources/DayNightPixelArtsLit.shader\" rel=\"nofollow noopener\" target=\"_blank\"\u003eファイル全体\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ehighlight\u003c/code\u003e 変数は \u003ccode\u003eidCol\u003c/code\u003e と \u003ccode\u003eHighlightID\u003c/code\u003e がほぼ同じ（※float演算なので誤差を許容する）なら 0.25、それ以外なら \u003ccode\u003eIsHighlightEdge()\u003c/code\u003e の結果、境界ピクセルなら1、そうでなければ0が入ります。\u003cbr\u003e\nあとは、\u003ccode\u003eresult\u003c/code\u003e にハイライト適用前の出力カラーが履いていますので、 lerp関数を使って\u003ccode\u003ehighlight\u003c/code\u003e 変数の値に応じて \u003ccode\u003eHighlightColor\u003c/code\u003e と混ぜ合わせています。 \u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"結果-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E6%9E%9C-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結果\u003c/h2\u003e\n\n\u003cp\u003e冒頭の画像のようになりました\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/59fed1bb767da65cb093d302605ea92c875bd616/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f63386532356562372d353065302d613466632d653139392d3232393034356432643331652e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fc8e25eb7-50e0-a4fc-e199-229045d2d31e.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ec98856f88d19f28369ca0cb59b0ba7c\" alt=\"selection-highlight.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/c8e25eb7-50e0-a4fc-e199-229045d2d31e.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fc8e25eb7-50e0-a4fc-e199-229045d2d31e.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0c0dd0688d01f9a31de5206a6ce598d5 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e本来ならテクスチャが透明なだけで、手前に mesh が存在するようなオブジェクト同士の境界付近でも正確に奥のオブジェクトを選択できていますね！\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/6355184e8398c5197c94071b2024ad187c85b362/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f33643838323835372d383265372d633437622d303434662d3265326639326139316363382e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F3d882857-82e7-c47b-044f-2e2f92a91cc8.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=012a8f024492acf2cbb10fca2a4398d5\" alt=\"pixel_selection.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/3d882857-82e7-c47b-044f-2e2f92a91cc8.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F3d882857-82e7-c47b-044f-2e2f92a91cc8.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=c5375d02ec56bd0c32b1b8d176a9aea1 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おまけ-深度情報でアウトライン輪郭線を描く\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%81%BE%E3%81%91-%E6%B7%B1%E5%BA%A6%E6%83%85%E5%A0%B1%E3%81%A7%E3%82%A2%E3%82%A6%E3%83%88%E3%83%A9%E3%82%A4%E3%83%B3%E8%BC%AA%E9%83%AD%E7%B7%9A%E3%82%92%E6%8F%8F%E3%81%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e[おまけ] 深度情報でアウトライン(輪郭線)を描く\u003c/h1\u003e\n\n\u003cp\u003eさて、せっかく深度バッファが手近(?)にあるので、深度バッファを使ってオブジェクトの輪郭を強調してみたいと思います。\u003cbr\u003e\n以前書いた「\u003ca href=\"https://qiita.com/Shinoda_Naoki/items/734fee861fe8abfca228\" id=\"reference-49d6a37883a1d7ba8a3d\"\u003e綺麗なアウトラインシェーダーを作る\u003c/a\u003e」の超簡易版ですね。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"深度情報を複製\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B7%B1%E5%BA%A6%E6%83%85%E5%A0%B1%E3%82%92%E8%A4%87%E8%A3%BD\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e深度情報を複製\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/day-night_deferred_redering/Assets/Assets/Shader/DayNightPixelArtsGBuffer.shader\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDayNightPixelArtsGBuffer.shader\u003c/a\u003eでG-Bufferと一緒に深度バッファも書き出してるので、G-Bufferを読みだしてる\u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/day-night_deferred_redering/Assets/Assets/Resources/DayNightPixelArtsLit.shader\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDayNightPixelArtsLit.shader\u003c/a\u003eで同じように深度バッファも読み出せる・・・と思ってましたが甘かったです。\u003c/p\u003e\n\n\u003cp\u003eDayNightPixelArtsLit.shader でも\u003cstrong\u003e普通に深度バッファにアクセスできるのですが、中身は空っぽになってしまている\u003c/strong\u003e（正確にはグレーの小さなテクスチャになってる）ようです。\u003c/p\u003e\n\n\u003cp\u003e以前 FrameDebugger で見た時、 CopyDepth っていうシェーダーが挟まってましたが、この前後で失われてしまうようです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/abd89252b6ac26244eb2054d527cecacc821b7f0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f64653033383238322d633334642d336161322d386230652d3730346630313134313639642e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fde038282-c34d-3aa2-8b0e-704f0114169d.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5931c9d2d93955d1580c48db0be10f54\" alt=\"framedebugger_cpopydepth.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/de038282-c34d-3aa2-8b0e-704f0114169d.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fde038282-c34d-3aa2-8b0e-704f0114169d.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a8dc5a516cea51ca7a5824451f16e519 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eCopyDepth シェーダーは置き換え可能なビルトインシェーダーではないし、そもそも何かしら技術的に制約があるからコピーしてるんだろうと思われますから、DayNightPixelArtsGBuffer.shader で書いた深度バッファそのものにアクセスするのは諦めたほうがよさそうです。\u003c/p\u003e\n\n\u003cp\u003eそこで、深度バッファは１チャネルあれば十分なので、昼画像用G-Bufferのアルファチャネルを使うことにしました。\u003cbr\u003e\nこちらは各ゲームオブジェクトのシェーダーです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"diff\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDayNightPixelArtsGBuffer.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e      void frag (in v2f i, out flagout o)\n      {\n        // ..中略..\n\n\n\u003cspan class=\"gd\"\u003e-       o.gBuffer0 = colDay;\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+       o.gBuffer0 = fixed4(colDay.rgb, i.position.z);\n\u003c/span\u003e        o.gBuffer3 = colNight;\n        o.gBuffer2 = float4(i.normal, 0) * 0.5 + float4(0.5, 0.5, 0.5, 0);\n        o.gBuffer1 = _IDColor;\n        o.depth = i.position.z;\n      }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e既存の深度バッファの書き出しに加えて、\u003ccode\u003egBuffer0\u003c/code\u003e にも \u003ccode\u003eposition.z\u003c/code\u003e を書き込んでいます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"最終合成deferred-lightingシェーダー修正\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%80%E7%B5%82%E5%90%88%E6%88%90deferred-lighting%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E4%BF%AE%E6%AD%A3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e最終合成(deferred lighting)シェーダー修正\u003c/h2\u003e\n\n\u003cp\u003eそして、こちらが Deferred Lighting シェーダー側です。境界線を描くということで、上で紹介したハイライト表示の輪郭線の時とよく似たメソッドを追加してます。ただしこちらは 0/1 ではなく smoothstep 関数を利用して、\u003cstrong\u003eある程度深度差に応じた値\u003c/strong\u003eを返しています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"glsl\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDayNightPixelArtsLit.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kr\"\u003einline\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"nf\"\u003e_depthEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003euv2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003e_ScreenParams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003e_ScreenParams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ehalf4\u003c/span\u003e \u003cspan class=\"n\"\u003epix\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etex2D\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_CameraGBufferTexture0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euv2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esmoothstep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epix\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcEdgeStrength\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_depthEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003e_depthEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_depthEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003e_depthEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e75\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ehalf4\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalculateLight\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eunity_v2f_deferred\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ..中略..\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e  \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eCalcEdgeStrength\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolDay\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// apply color burn effect to the day color.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efixed3\u003c/span\u003e \u003cspan class=\"n\"\u003ecolBurn\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003e_LightColor\u003c/span\u003e \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ergb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e_LightColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecolDay\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efixed4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolDay\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ergb\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ecolBurn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehalf4\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehalf4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elerp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolNight\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecolDay\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ergb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003e_LightColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// ..中略..\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/day-night_deferred_redering/Assets/Assets/Resources/DayNightPixelArtsLit.shader\" rel=\"nofollow noopener\" target=\"_blank\"\u003eファイル全体\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eCalcEdgeStrength()\u003c/code\u003e を使って現在のピクセルのエッジ強度を \u003ccode\u003eedge\u003c/code\u003e 変数に代入し、\u003ccode\u003ecolDay\u003c/code\u003e の\u003ca href=\"https://qiita.com/Shinoda_Naoki/items/36ad022200616c229936#%E3%83%AA%E3%83%8B%E3%82%A2%E7%84%BC%E3%81%8D%E3%81%93%E3%81%BFlinear-burn\" id=\"reference-c7af3301b1d40a3a8c6c\"\u003eリニア焼きこみ処理\u003c/a\u003e時についでに \u003ccode\u003eedge\u003c/code\u003e をかけて、エッジ強度が強ければ暗くなるようにしてます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"結果-2\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E6%9E%9C-2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結果\u003c/h2\u003e\n\n\u003cp\u003eピクセル等倍だとわかり辛いので、ビフォーアフターを切り替えたgifアニメーションさせてみました。控えめながら、建物と建物の境界がより明瞭になったのではないでしょうか。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/ff40f0a0f6ee5744d6cfae66c7a9f199d3b8b21e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f64656463653364302d656332642d396333622d663938332d3937666236363465316165342e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fdedce3d0-ec2d-9c3b-f983-97fb664e1ae4.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=fad95d3dbe373e4ef959fee1a7f3cb36\" alt=\"outline_blink.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/dedce3d0-ec2d-9c3b-f983-97fb664e1ae4.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fdedce3d0-ec2d-9c3b-f983-97fb664e1ae4.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=def7d38960c344980d6a9b0aedabb07e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e深度差が大きいほどエッジ強度が強くなってる\u003c/strong\u003eということがわかりやすいように、昼画像の代わりに深度＋アウトラインを描きだしてみました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/892fec54ad3fd6111603e19b4a5a155aa875be08/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f62616562323761362d363933352d346336312d626239612d3332366165663362383234642e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fbaeb27a6-6935-4c61-bb9a-326aef3b824d.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=92f0b5caaeea0977c3f44d20eca714dd\" alt=\"depth_edge.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/baeb27a6-6935-4c61-bb9a-326aef3b824d.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fbaeb27a6-6935-4c61-bb9a-326aef3b824d.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=4ee73cd282404161e8bdb3a92739f73e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eところで、カメラには \u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/5a4229fefb7ab563f03d07a7c202fe7b4de7108d/Assets/Assets/Scripts/QuaterView.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eQuater View\u003c/a\u003e という自作コンポーネントが付いていて、\u003cstrong\u003e１ピクセルを何倍で描画するか指定できる\u003c/strong\u003eようになってるんですが、拡大処理はG-Bufferへの書き出し時に行われるので、深度アウトラインは影響されません。\u003c/p\u003e\n\n\u003cp\u003eですからピクセル倍率を上げても、アウトラインは常に1ピクセル幅で描画されます。\u003cbr\u003e\n（ちなみにハイライトの輪郭も同じ仕組みなので、常に1ピクセル幅です）\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/b385ff6c8c250ca82a62834e7b087511ebb6829c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f36623635383538612d353030642d333731622d333363342d3039316332346663613033322e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F6b65858a-500d-371b-33c4-091c24fca032.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c7d516838db1e29b8b3d37bb313b772d\" alt=\"scale_and_edge_width.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/6b65858a-500d-371b-33c4-091c24fca032.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F6b65858a-500d-371b-33c4-091c24fca032.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=32561b05967035cd9e4052aae51d2150 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nピクセル倍率:4 での描画結果はこんな感じです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c74a0b457282b6573d824d218a5964abbf434a45/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f33353439383239622d643866632d623130662d306333332d3834383163396239663565652e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F3549829b-d8fc-b10f-0c33-8481c9b9f5ee.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=055428fc020f0bb326b4ebcd97e30bd2\" alt=\"scale_and_edge_width_colored.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/3549829b-d8fc-b10f-0c33-8481c9b9f5ee.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F3549829b-d8fc-b10f-0c33-8481c9b9f5ee.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=fe721634da1eff9a757497ae762fd878 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eアウトラインまで4倍になると画面がうるさくなりそうなので、これぐらいで良いかなと思ってます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"3dメッシュとの混成20200124-追記\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3d%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%A8%E3%81%AE%E6%B7%B7%E6%88%9020200124-%E8%BF%BD%E8%A8%98\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3Dメッシュとの混成（2020/01/24 追記）\u003c/h2\u003e\n\n\u003cp\u003e元々この手法のメリットの一つとして \u003cstrong\u003eドット絵と通常の3Dオブジェクトの共存\u003c/strong\u003e が挙げられたのですが、今回作成した機能を3Dオブジェクトにも適用できるように、追加拡張を行いました。\u003c/p\u003e\n\n\u003cp\u003eDayNightPixelArtsGBuffer.shader をベースに 3D メッシュ用のシェーダーを作ります。主なポイントは、1. 昼用・夜用テクスチャの区別がない事、2. フラグメントシェーダーで \u003cstrong\u003e簡易ライティング処理\u003c/strong\u003e をしてることです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"glsl\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDayNight3DMeshGBuffer.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e  \u003cspan class=\"n\"\u003eProperties\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_MainTex\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Day Texture\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"n\"\u003eD\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"white\"\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_IDColor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Color for source object ID\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// ...中略...\u003c/span\u003e\n\n      \u003cspan class=\"kt\"\u003esampler2D\u003c/span\u003e \u003cspan class=\"n\"\u003e_MainTex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003e_MainTex_ST\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003e_IDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// ...中略...\u003c/span\u003e\n\n      \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003efrag\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003ev2f\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003eflagout\u003c/span\u003e \u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"kr\"\u003ehalf\u003c/span\u003e \u003cspan class=\"n\"\u003eNdotL\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edot\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enormal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_WorldSpaceLightPos0\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003efixed4\u003c/span\u003e \u003cspan class=\"n\"\u003ecolDay\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etex2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_MainTex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elerp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNdotL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e75\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// use 25% brightness of day texture, if night texture is disabled.\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efixed4\u003c/span\u003e \u003cspan class=\"n\"\u003ecolNight\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecolDay\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e25\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egBuffer0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efixed4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolDay\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ergb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ez\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egBuffer3\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efixed4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolNight\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ergb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egBuffer2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enormal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egBuffer1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_IDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edepth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ez\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/4d3e993dda80a2fdb6c68f6dc9069c70d982245a/Assets/Assets/Shader/DayNight3DMeshGBuffer.shader\" rel=\"nofollow noopener\" target=\"_blank\"\u003eファイル全体\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eDeferred レンダリングを独自にカスタマイズしてるので、\u003cstrong\u003e本来の Deferred ライティングは適用できません\u003c/strong\u003e。フラグメントシェーダー(frag) の冒頭で \u003ccode\u003eNdotL\u003c/code\u003e に照明と法線の内積を計算して、\u003ccode\u003ecolDay\u003c/code\u003e に掛けることで、法線ベクトルに応じた簡単な陰影を付けています。\u003cbr\u003e\nドット絵と共存させるような3Dオブジェクトに、そこまで高度なライティングは要求されないだろうし、夕焼けアニメーションにいい感じに調和させるためにも、必要な処理です。\u003cbr\u003e\nなお\u003cstrong\u003e陰影は光源ベクトルに依存するので、ドット絵の仮想的な光源方向に合わせる\u003c/strong\u003e必要があります。今回は下記のように設定してみました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/3ccc7acf5f90697406035a23a1db8621f55ba2c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f65626364616666342d666538632d386134622d646233302d3431336561313166346461342e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Febcdaff4-fe8c-8a4b-db30-413ea11f4da4.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a287081bd24262061bcb212599c5f62b\" alt=\"ezgif.com-video-to-gif.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/ebcdaff4-fe8c-8a4b-db30-413ea11f4da4.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Febcdaff4-fe8c-8a4b-db30-413ea11f4da4.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=08d358be5dd48c9bfd888a93c8c08018 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003ca href=\"https://camo.qiitausercontent.com/96b362baba3de13889aa63c483d7db4a0863fb52/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f63653866303731362d323634642d653238652d663130392d6166393139366239376334662e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fce8f0716-264d-e28e-f109-af9196b97c4f.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=89972b3759d0f480326b1f14a4b04add\" alt=\"lighting.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/ce8f0716-264d-e28e-f109-af9196b97c4f.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2Fce8f0716-264d-e28e-f109-af9196b97c4f.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0bbccaa34caba523de89385553329310 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e一方C#スクリプト側ではIDカラーマップ対応のために、もともと \u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/4d3e993dda80a2fdb6c68f6dc9069c70d982245a/Assets/Assets/Scripts/Shed4Sprite.cs#L7\" rel=\"nofollow noopener\" target=\"_blank\"\u003eShade4Sprite\u003c/a\u003e にだけあった IDColor を3Dメッシュにも関連付けるための基本クラスを用意します。Shade4Sprite はこのクラスを継承するようにします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eHasIDColor.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHasIDColor\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eColor32\u003c/span\u003e \u003cspan class=\"n\"\u003eIDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/c9617294aa1aa93b7dee9a7a4d855a3013f545a9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f32313930333731372d623564332d396636632d643666622d6536303437633535663061312e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F21903717-b5d3-9f6c-d6fb-e6047c55f0a1.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=8a34be667664205eb61524974a78a271\" alt=\"cube_inspector.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/21903717-b5d3-9f6c-d6fb-e6047c55f0a1.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F21903717-b5d3-9f6c-d6fb-e6047c55f0a1.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1a7977ffd8113d01b04b26313b35722f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003ca href=\"https://camo.qiitausercontent.com/aa9a2e7bae1c774787038fc22a1c8eee157cf30d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f38643237643066662d396339612d363735632d313935362d3361316162303530653035342e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F8d27d0ff-9c9a-675c-1956-3a1ab050e054.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2a2b53b0f1df8b29ae26310596cf91ff\" alt=\"material_inspector.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/8d27d0ff-9c9a-675c-1956-3a1ab050e054.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F8d27d0ff-9c9a-675c-1956-3a1ab050e054.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=72d8f28447e102577891e8fef8984e02 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ShinodaNaoki/isometricPixelarts/blob/4d3e993dda80a2fdb6c68f6dc9069c70d982245a/Assets/Assets/Scripts/CaptureGBuffer.cs#L90-L96\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCaptureGBuffer クラスの FindObjectByIDColor() メソッド\u003c/a\u003e では検索対象として Shade4Sprite ではなく HasIDColor クラスを取得するように変更します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eCaptureGBuffer.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eHasIDColor\u003c/span\u003e \u003cspan class=\"nf\"\u003eFindObjectByIDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eColor32\u003c/span\u003e \u003cspan class=\"n\"\u003eidCol\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estructures\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGameObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFindObjectsOfType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHasIDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efound\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estructures\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eshed\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eidCol\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eshed\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIDColor\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003efound\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこれで、3DオブジェクトにもIDカラーを割り当て、クリックで選択できるようになりました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c67fd8c55419de8b630a996ce1604b164d3eeb53/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f37353033352f38323166393133302d333233372d653463622d373038302d3462636531383032316334362e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F821f9130-3237-e4cb-7080-4bce18021c46.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=6ec02ee363ff97f8eef3621838789614\" alt=\"cube_selection.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/75035/821f9130-3237-e4cb-7080-4bce18021c46.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F75035%2F821f9130-3237-e4cb-7080-4bce18021c46.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f8f218ae34f09b81cca4e48a4cdf4b2f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e[前回]Deferred レンダリングのカスタマイズによって、描画時にIDカラーマップを作成した\u003c/li\u003e\n\u003cli\u003eIDカラーマップを使って、ピクセル単位で正確なオブジェクト選択ができた\n\n\u003cul\u003e\n\u003cli\u003eガンマ補正されたくないときはVector型でシェーダーに渡すとよい\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eIDカラーマップを使って、特定のオブジェクトをハイライト表示することができた\u003c/li\u003e\n\u003cli\u003eついでに深度エッジで輪郭線描画もできた\n\n\u003cul\u003e\n\u003cli\u003eオリジナルの深度バッファにはアクセスできなかったが、代わりにGBuffer0のアルファチャネルを深度バッファの複製として使った\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2019-12-20T04:27:45Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"X8A7YmJxAdUeNJCSgz9033cjQ/+oHpg2dA==--tbUXgd1SrcPfH/dN--xupttZY+NtDN2T2hFrunAQ==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-01-26T09:13:18Z","likesCount":12,"linkUrl":"https://qiita.com/Shinoda_Naoki/items/677952e9ab675985f2b6","organization":null,"originalId":1117874,"stockedCount":14,"title":"[Unity] マウス位置のドット絵オブジェクトをピクセル単位で選択＆ハイライト表示","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%8C%E7%B7%AF\"\u003e経緯\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AA%E3%81%9Cid%E3%82%AB%E3%83%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%97%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%8B\"\u003eなぜIDカラーマップが必要か？\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%BA%A7%E6%A8%99%E4%BD%8D%E7%BD%AE%E3%81%AE%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%A4%9C%E7%B4%A2\"\u003e座標位置のオブジェクト検索\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#g-buffer%E3%81%AE%E6%8C%87%E5%AE%9A%E4%BD%8D%E7%BD%AE%E3%81%AE%E8%89%B2%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\"\u003eG-Bufferの指定位置の色を取得する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#idcolor%E3%81%AB%E5%90%88%E3%81%86%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E6%8E%A2%E3%81%99\"\u003eIDColorに合うオブジェクトを探す\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B2%A1%E6%A1%88idcolor-%E3%81%AE%E3%82%AB%E3%83%A9%E3%83%BC%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E5%A4%89%E6%8F%9B%E3%82%92%E9%80%86%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B\"\u003e【没案】IDColor のカラースペース変換を逆変換する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#idcolor%E3%82%92vector%E3%81%AB%E3%81%99%E3%82%8B%E3%82%AB%E3%83%A9%E3%83%BC%E3%82%B9%E3%83%9A%E3%83%BC%E3%82%B9%E5%A4%89%E6%8F%9B%E3%82%92%E5%AE%8C%E5%85%A8%E7%84%A1%E5%8A%B9%E5%8C%96\"\u003eIDColorをVectorにする（カラースペース変換を完全無効化）\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E6%9E%9C\"\u003e結果\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%81%B8%E6%8A%9E%E3%81%97%E3%81%9F%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88%E8%A1%A8%E7%A4%BA\"\u003e選択したオブジェクトをハイライト表示\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85-1\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AF%BE%E8%B1%A1%E3%81%AEidcolor%E3%82%92%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%AB%E6%B8%A1%E3%81%99\"\u003e対象のIDColorをシェーダーに渡す\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%81%A7%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88%E8%A1%A8%E7%A4%BA\"\u003eシェーダーでハイライト表示\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E6%9E%9C-1\"\u003e結果\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%81%BE%E3%81%91-%E6%B7%B1%E5%BA%A6%E6%83%85%E5%A0%B1%E3%81%A7%E3%82%A2%E3%82%A6%E3%83%88%E3%83%A9%E3%82%A4%E3%83%B3%E8%BC%AA%E9%83%AD%E7%B7%9A%E3%82%92%E6%8F%8F%E3%81%8F\"\u003e[おまけ] 深度情報でアウトライン(輪郭線)を描く\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B7%B1%E5%BA%A6%E6%83%85%E5%A0%B1%E3%82%92%E8%A4%87%E8%A3%BD\"\u003e深度情報を複製\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%80%E7%B5%82%E5%90%88%E6%88%90deferred-lighting%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E4%BF%AE%E6%AD%A3\"\u003e最終合成(deferred lighting)シェーダー修正\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E6%9E%9C-2\"\u003e結果\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3d%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%81%A8%E3%81%AE%E6%B7%B7%E6%88%9020200124-%E8%BF%BD%E8%A8%98\"\u003e3Dメッシュとの混成（2020/01/24 追記）\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":3834,"uuid":"677952e9ab675985f2b6","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"lB2LeWZV5aTTg8MrJ6Hk4xdmolI=--mdOemAL+KY+DOLNe--AT5Jt1ZYhT1SGI61/Tz1jg==","originalId":75035,"description":"","facebookUrl":null,"githubUrl":"https://github.com/ShinodaNaoki","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/75035/profile-images/1473700038","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F75035%2Fprofile-images%2F1473700038?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=e221019e78da0571f26ab6e59668f387","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F75035%2Fprofile-images%2F1473700038?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1d027acc213195aa714453863473a257","urlName":"Shinoda_Naoki","websiteUrl":null,"twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[{"node":{"encryptedId":"KXr8/M0Hnyh+HmkC14VCrkAVUPk3eBOcZjo=--MfHzx/Aq9ahQn+jq--Iz1+bv3dyO/ZT4w00O/whQ==","isBetaReleaseEnabled":false,"isFollowableByViewer":false,"isFollowedByViewer":false,"name":"株式会社テクロス","logoUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/47bb6192a32d490348c8d00949b8b21bd852af31/original.jpg?1569306622","urlName":"techcross","description":"京都を拠点にソーシャルゲームの開発・運用、その他システム開発を行っています。","url":"https://www.techcross.co.jp/"}}]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"},{"name":"Shader","urlName":"shader"},{"name":"ゲーム制作","urlName":"%e3%82%b2%e3%83%bc%e3%83%a0%e5%88%b6%e4%bd%9c"},{"name":"ShaderLab","urlName":"shaderlab"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
