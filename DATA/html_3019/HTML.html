<!DOCTYPE html><html><head><meta charset="utf-8" /><title>[C#/C++/costura] UnmanagedのC++x64/x86のdllをexeに組み込んで、動作時の環境により自動で切り替えて使用する(Costura) - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/tera1707/items/522d96861486430c2800" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="76F/GD75e7y1ig7JXLkNlmE33nBHXWU9dn8rHrvTftGH8jLoQ0lWpDlraqvgUdWvG2ycKUcGBDWOWvNLsfFHKw==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="[C#/C++/costura] UnmanagedのC++x64/x86のdllをexeに組み込んで、動作時の環境により自動で切り替えて使用する(Costura) - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XME1qTDBNckt5OWpiM04wZFhKaFhTQlZibTFoYm1GblpXVGpnYTVES3l0NE5qUXZlRGcyNDRHdVpHeHM0NEtTWlhobDQ0R3I1N1dFNDRHXzZMNjg0NEtUNDRHbjQ0Q0I1WXVWNUwyYzVwbUM0NEd1NTVLdzVhS0Q0NEdyNDRLSTQ0S0s2SWVxNVl1VjQ0R241WWlINDRLSzVwdV80NEdJNDRHbTVMMl81NVNvNDRHWjQ0S0xLRU52YzNSMTRvQ20mdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9OGZiMzRjZDk4NGVjMzhmY2JhZjM1MGZlOTY3ZDMxYTE&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSFJsY21FeE56QTMmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz01OTFjMWUwZjM2MjIxODZiYTQzMTViMmZjOTU0MDFiYg&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=b2b155c9eb8ba323d1df5f9e7f3a3c5e"><meta property="og:description" content="

やりたいこと

UnmanagedなC++のdllで、x64用とx86用を作って。dllを使う側に「64ビット環境ならx64用を、32ビット環境ならx86用を使ってください」というのをやめて、1つのdllファイルで、使う環境に合わ..."><meta content="https://qiita.com/tera1707/items/522d96861486430c2800" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C++,C#,dll,costura" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-1398f286-3c73-421e-a9cb-c27f57caab4c"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Ftera1707%2Fitems%2F522d96861486430c2800">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Ftera1707%2Fitems%2F522d96861486430c2800">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-1398f286-3c73-421e-a9cb-c27f57caab4c">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/cpp","name":"C++"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-07-31T23:11:16.000+09:00","dateModified":"2019-11-29T14:02:14.000+09:00","headline":"[C#/C++/costura] UnmanagedのC++x64/x86のdllをexeに組み込んで、動作時の環境により自動で切り替えて使用する(Costura)","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XME1qTDBNckt5OWpiM04wZFhKaFhTQlZibTFoYm1GblpXVGpnYTVES3l0NE5qUXZlRGcyNDRHdVpHeHM0NEtTWlhobDQ0R3I1N1dFNDRHXzZMNjg0NEtUNDRHbjQ0Q0I1WXVWNUwyYzVwbUM0NEd1NTVLdzVhS0Q0NEdyNDRLSTQ0S0s2SWVxNVl1VjQ0R241WWlINDRLSzVwdV80NEdJNDRHbTVMMl81NVNvNDRHWjQ0S0xLRU52YzNSMTRvQ20mdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9OGZiMzRjZDk4NGVjMzhmY2JhZjM1MGZlOTY3ZDMxYTE\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSFJsY21FeE56QTMmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz01OTFjMWUwZjM2MjIxODZiYTQzMTViMmZjOTU0MDFiYg\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=b2b155c9eb8ba323d1df5f9e7f3a3c5e","mainEntityOfPage":"https://qiita.com/tera1707/items/522d96861486430c2800","author":{"@type":"Person","address":"大阪","email":"tera1707@gmail.com","identifier":"tera1707","name":"tera1707","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars0.githubusercontent.com%2Fu%2F19180456%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1ddd4d18cb0c4d9ee77ed7cff93f4ae1","url":"https://qiita.com/tera1707","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"tera1707","type":"items","id":"522d96861486430c2800"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"tera1707","type":"items","id":"522d96861486430c2800"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"tera1707","type":"items","id":"522d96861486430c2800"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/tera1707/items/522d96861486430c2800","location":"/tera1707/items/522d96861486430c2800","scheme":"https","host":"qiita.com","port":null,"pathname":"/tera1707/items/522d96861486430c2800","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"eQJlYdtYPKaiS/ZwOF8DdMzomvclw1Csxjd8mE3UgBwRUSiRpugRvi6qkhKEt9tNtrPYriWYMaQ+EqTNR/a55g==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-b88759bb-8372-491b-a229-74590485a68e"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/tera1707/items/522d96861486430c2800/likers" class="css-1iupg5d">8</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">5</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/522d96861486430c2800/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/tera1707/items/522d96861486430c2800/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/tera1707/items/522d96861486430c2800/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/tera1707/items/522d96861486430c2800/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/tera1707/items/522d96861486430c2800.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/tera1707"><img class="css-100alwu eyfquo10" src="https://avatars0.githubusercontent.com/u/19180456?v=4" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/tera1707" class="css-10ougpm">@<!-- -->tera1707</a><div class="css-1ay9vb9"><span><meta content="2019-07-31T14:11:16Z"/><time dateTime="2019-11-29T05:02:14Z" class="css-m19uds">updated at 2019-11-29</time></span></div></div></div></div></div><h1 class="css-cgzq40">[C#/C++/costura] UnmanagedのC++x64/x86のdllをexeに組み込んで、動作時の環境により自動で切り替えて使用する(Costura)</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/cpp" class="css-4czcte">C++</a><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/dll" class="css-4czcte">dll</a><a href="/tags/costura" class="css-4czcte">costura</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="やりたいこと" class="fragment"></span><a href="#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>やりたいこと</h1>

<p>UnmanagedなC++のdllで、x64用とx86用を作って。dllを使う側に「64ビット環境ならx64用を、32ビット環境ならx86用を使ってください」というのをやめて、1つのdllファイルで、使う環境に合わせて自動でx64/x86を切り替えてくれるようにしたい。</p>

<h1>
<span id="やり方" class="fragment"></span><a href="#%E3%82%84%E3%82%8A%E6%96%B9"><i class="fa fa-link"></i></a>やり方</h1>

<p>Costuraを使って、使う側にx64用、x86用のdll両方を組み込んで切り替えることで実現する。</p>

<h1>
<span id="前提" class="fragment"></span><a href="#%E5%89%8D%E6%8F%90"><i class="fa fa-link"></i></a>前提</h1>

<p>今回は、<code>Costura.Fody4.0.0</code>を使用して実験する。</p>

<h1>
<span id="サンプルコード" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>サンプルコード</h1>

<p><qiita-embed-ogp src="https://github.com/tera1707/WPF-/tree/master/029_CosturaTest"></qiita-embed-ogp></p>

<h1>
<span id="実験イメージ" class="fragment"></span><a href="#%E5%AE%9F%E9%A8%93%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8"><i class="fa fa-link"></i></a>実験イメージ</h1>

<p>通常は、dllを使う側のexeと同じ階層に、使うdllが置いてあるイメージ。<br>
(x64とx86があるdllがある場合は、必要な方のdllが置いてあるイメージ。)<br>
<a href="https://camo.qiitausercontent.com/a977218c8de612e23624d2bc26e97f84b5f0579e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f32383134356535622d356266352d303863382d626131642d3934656163626539653735352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F28145e5b-5bf5-08c8-ba1d-94eacbe9e755.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a2cb93ee1e74ffef8221aac33855fd6d" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/28145e5b-5bf5-08c8-ba1d-94eacbe9e755.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F28145e5b-5bf5-08c8-ba1d-94eacbe9e755.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4b39f440b56fe4d387535d9085122b22 1x" loading="lazy"></a></p>

<p>Costuraを使った場合は、全部のdllをexeに組み込んで、x64とx86があるものに関しては自動で切り替えてくれるイメージ。<br>
<a href="https://camo.qiitausercontent.com/fb410f1f079045eb1ba2a740f4869fb86204d6dc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f65346436333235322d376334382d396533662d626635392d3235656462386363613934332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fe4d63252-7c48-9e3f-bf59-25edb8cca943.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e611c160147512e9762c0bf9f16fccff" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/e4d63252-7c48-9e3f-bf59-25edb8cca943.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fe4d63252-7c48-9e3f-bf59-25edb8cca943.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b148a3680935e15e90dc7d9af392eee1 1x" loading="lazy"></a><br>
※各図のdllやexeの名前は、今回実験で作ったものを使用。</p>

<p>今回の実験では、一番下のDLL(C++ x64/x86)の足し算をする関数を、一つ上のC#のDLLが呼び、さらにそのC#のメソッドをアプリが呼ぶ、という構成にする。<br>
そのアプリが使う、C#とC++のDLLをexeにまるっと組み込んで、C++のDLLに関しては、x64とx86を両方組み込んで、自動で切り替える、ということをする。</p>

<h1>
<span id="実験でつくるソリューション概要" class="fragment"></span><a href="#%E5%AE%9F%E9%A8%93%E3%81%A7%E3%81%A4%E3%81%8F%E3%82%8B%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>実験でつくるソリューション概要</h1>

<p><a href="https://camo.qiitausercontent.com/4b072c98d6edb6bc8868ad9585358619edd022b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f61343335363837652d303537632d613932392d323961632d3434633262393937636638342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fa435687e-057c-a929-29ac-44c2b997cf84.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d77207b4260e678122aa4ca0c09869c0" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/a435687e-057c-a929-29ac-44c2b997cf84.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fa435687e-057c-a929-29ac-44c2b997cf84.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=dd25e3ec9949c1fc079da299be7ab74d 1x" loading="lazy"></a></p>

<h1>
<span id="実験手順" class="fragment"></span><a href="#%E5%AE%9F%E9%A8%93%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>実験手順</h1>

<p>上の実験イメージにある、下記3つを作って実験する。Costura自体は、アプリのところ(アプリ(C#))で使用する。<strong>Costura周りだけ知りたいときは、<a href="">そちら</a>参照</strong></p>

<ul>
<li>DLL(C++)(x64用/x86)</li>
<li>DLL(C#)</li>
<li>アプリ(C#)　<strong>←!!!ここにCosturaを入れる!!!</strong>
</li>
</ul>

<h2>
<span id="dllcx64用x86をつくる" class="fragment"></span><a href="#dllcx64%E7%94%A8x86%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B"><i class="fa fa-link"></i></a>DLL(C++)(x64用/x86)をつくる</h2>

<p>一つ上の層のC#のDLLで呼ばれる関数をつくる。<br>
(C++のDLLの作り方は、<a href="https://qiita.com/tera1707/items/81042abaa62dc97e26ae" id="reference-79f10bf07243765e7134">以前の記事</a>を参照)</p>

<p>中身は、単に引数を足し合わせるだけ。特殊なプロジェクトの設定等もとくに無し。</p>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">Dll1.cpp</span></div>
<div class="highlight"><pre class="with-code"><code><span class="cp">#include "pch.h"
#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="cp">#define VC_DLL_EXPORTS
#include "Dll1.h"
</span>
<span class="c1">// エクスポート関数の実装</span>
<span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">UnmanagedAdd</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>※.hファイルやその他のファイルは、<a href="https://github.com/tera1707/WPF-/tree/master/029_CosturaTest" rel="nofollow noopener" target="_blank">サンプルコード</a>を参照</p>

<h2>
<span id="dllcをつくる" class="fragment"></span><a href="#dllc%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B"><i class="fa fa-link"></i></a>DLL(C#)をつくる</h2>

<p>x64/x86のdllの計算関数を呼んで、結果を返すだけのメソッド。アプリから呼ばれるdll。このdllも、Costuraでexeに組み込まれる。</p>

<p>やっていることは、C++のdllの関数をC#でラップしているだけ。特殊なプロジェクトの設定等もとくに無し。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">Class1.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ClassLibrary1</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Class1</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">NativeMethod</span><span class="p">.</span><span class="nf">UnmanagedAdd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">NativeMethod</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"Dll1.dll"</span><span class="p">,</span> <span class="n">CallingConvention</span> <span class="p">=</span> <span class="n">CallingConvention</span><span class="p">.</span><span class="n">Cdecl</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">extern</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">UnmanagedAdd</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h2>
<span id="アプリcをつくるcosturaを使う" class="fragment"></span><a href="#%E3%82%A2%E3%83%97%E3%83%AAc%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8Bcostura%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>アプリ(C#)をつくる（Costuraを使う）</h2>

<p>C#のdllのメソッドを呼んで、足し算を行う。このプロジェクトで、Costuraを使ってC#のdllとC++のdllをexeに組み込むということをする。</p>

<h3>
<span id="nugetでcosturaを参照に加える" class="fragment"></span><a href="#nuget%E3%81%A7costura%E3%82%92%E5%8F%82%E7%85%A7%E3%81%AB%E5%8A%A0%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>NugetでCosturaを参照に加える</h3>

<p>Nugetで「Costura.Fody」と検索し、<code>Costura.Fody v4.0.0</code>をC#アプリのプロジェクトにインストールする。<br>
<a href="https://camo.qiitausercontent.com/d7e11374c53ba2d07257246979c9c3c6ea89b68d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f30343838623038332d383664632d663466612d613462612d3332326239306639616265662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F0488b083-86dc-f4fa-a4ba-322b90f9abef.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=adb5da580dd7ffd0d2b4973c0a774e97" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/0488b083-86dc-f4fa-a4ba-322b90f9abef.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F0488b083-86dc-f4fa-a4ba-322b90f9abef.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=64a9be3a803b505ca70325e092b760e1 1x" loading="lazy"></a></p>

<h3>
<span id="cアプリのプロジェクトにフォルダを追加する" class="fragment"></span><a href="#c%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>C#アプリのプロジェクトにフォルダを追加する</h3>

<ul>
<li>C#アプリのプロジェクト(ここではConsoleApp10)を右クリックして、[追加] &gt; [新しいフォルダ] を選択する。</li>
<li>新しいフォルダができるので、そのフォルダの名前を<strong>「costura32」</strong>に変更する。</li>
<li>同じようにして、<strong>「costura64」</strong>フォルダを作成する。</li>
</ul>

<p><strong>備考</strong><br>
ここでやっているのは、C#アプリのプロジェクトに、x64、x86のdllを配置するためのフォルダを作るという作業。<br>
Costuraが、そこに作成せよと指定している。詳細は<a href="https://github.com/Fody/Costura#native-libraries-and-preloadorder" rel="nofollow noopener" target="_blank">こちら</a>参照。<br>
→「ネイティブライブラリを含めるには、ライブラリのビット数に応じて、costura32またはcostura64というフォルダを作成して、埋め込みリソースとして各ビット数のライブラリをプロジェクトに含める必要があります。」とのこと。(訳に自信なし)</p>

<h3>
<span id="作成したフォルダにx64x86のdllへのリンクを追加する" class="fragment"></span><a href="#%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E3%81%ABx64x86%E3%81%AEdll%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>作成したフォルダに、x64,x86のdllへのリンクを追加する</h3>

<ul>
<li>costura32フォルダを右クリックし、[追加] &gt; [既存の項目] を選択する。</li>
<li>[既存項目の追加]ウインドウで、C++ライブラリの32ビット版の出力フォルダを開く。(ここでは<code>\&lt;Solutionフォルダ\&gt;\Dll1\bin\Win32\Debug</code>。事前にC++ライブラリをWin32でビルドしている必要アリ)</li>
<li>そこにある32ビット版のC++のdllを選択</li>
<li>[追加]ボタンの右の▼をクリックし、[リンクとして追加]を選択する<a href="https://camo.qiitausercontent.com/aa403d1b250e8bf0306e9adacaac355abbeced23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f65306338313032342d323136622d323332382d313235642d6331343532646264376433382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fe0c81024-216b-2328-125d-c1452dbd7d38.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=23544670665b3a81d10a375cfe3e4d8f" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/e0c81024-216b-2328-125d-c1452dbd7d38.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fe0c81024-216b-2328-125d-c1452dbd7d38.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=162bcf4119e54d0c279075961dabb9b7 1x" loading="lazy"></a>
</li>
<li>同じようにして、64ビット版も追加する。</li>
</ul>

<p>上記を行うと、このようになる。<br>
<a href="https://camo.qiitausercontent.com/274930018c784f985bd4e2fe5ea6aa03ae6d15e1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f33643135656364322d326430372d633665332d366630652d6338623933666634616666642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F3d15ecd2-2d07-c6e3-6f0e-c8b93ff4affd.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d830d0720a3cf4bc3def8f97ae373f58" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/3d15ecd2-2d07-c6e3-6f0e-c8b93ff4affd.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F3d15ecd2-2d07-c6e3-6f0e-c8b93ff4affd.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=09f7b200dee8b8d5e66b69d9956ee41f 1x" loading="lazy"></a></p>

<h3>
<span id="追加したリンクを埋め込みリソースにする" class="fragment"></span><a href="#%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%92%E5%9F%8B%E3%82%81%E8%BE%BC%E3%81%BF%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>追加したリンクを埋め込みリソースにする</h3>

<ul>
<li>追加したDLL(へのリンク)を右クリックし、[プロパティ]を選択する</li>
<li>プロパティの中の[ビルドアクション]を、<strong>[埋め込みリソース]</strong>に設定する</li>
<li>プロパティの中の[出力ディレクトリにコピー]を、<strong>[コピーしない]</strong>に設定する</li>
</ul>

<h3>
<span id="追加したリンクの名前をx86とx64で共通の名前にする" class="fragment"></span><a href="#%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E5%90%8D%E5%89%8D%E3%82%92x86%E3%81%A8x64%E3%81%A7%E5%85%B1%E9%80%9A%E3%81%AE%E5%90%8D%E5%89%8D%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>追加したリンクの名前を、x86とx64で共通の名前にする</h3>

<p>呼び出し側のアプリのコードは共通で、x64とx86を自動で呼び分けられるように、dllの参照の名前に手を加える。</p>

<ul>
<li>エクスプローラでC#アプリのフォルダを開く</li>
<li>C#アプリの.csprojファイル(ここでは<code>ConsoleApp10.csproj</code>)をエディタで開く</li>
<li>x64,x86のdllへのリンク部分を、下記のように直す。</li>
</ul>

<div class="code-frame" data-lang="xml"><div class="highlight"><pre class="with-code"><code>  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;EmbeddedResource</span> <span class="na">Include=</span><span class="s">"..\Dll1\bin\Win32\Debug\Dll1_Win32.dll"</span><span class="nt">&gt;</span> ★実物はx86の出力物
      <span class="nt">&lt;Link&gt;</span>costura32\Dll1.dll<span class="nt">&lt;/Link&gt;</span> ★ここが、x64とx86で共通の名前になる
    <span class="nt">&lt;/EmbeddedResource&gt;</span>
    <span class="nt">&lt;EmbeddedResource</span> <span class="na">Include=</span><span class="s">"..\Dll1\bin\x64\Debug\Dll1_x64.dll"</span><span class="nt">&gt;</span> ★実物はx64の出力物
      <span class="nt">&lt;Link&gt;</span>costura64\Dll1.dll<span class="nt">&lt;/Link&gt;</span> ★ここが、x64とx86で共通の名前になる
    <span class="nt">&lt;/EmbeddedResource&gt;</span>
    <span class="nt">&lt;Content</span> <span class="na">Include=</span><span class="s">"FodyWeavers.xml"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>
</code></pre></div></div>

<p>これで、C++のdllを呼ぶ側からは共通のコードでx64,x86のdllを使えるようになる。そのコードの該当部分は下記。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">Class1の一部.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">NativeMethod</span>
<span class="p">{</span>
    <span class="c1">// ★ここで、「Dll1＿Win32.dll」「Dll1_x64.dll」とか分けずにDll1を使える！！</span>
    <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"Dll1.dll"</span><span class="p">,</span> <span class="n">CallingConvention</span> <span class="p">=</span> <span class="n">CallingConvention</span><span class="p">.</span><span class="n">Cdecl</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">extern</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">UnmanagedAdd</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="fodyweaversxmlを修正する" class="fragment"></span><a href="#fodyweaversxml%E3%82%92%E4%BF%AE%E6%AD%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>FodyWeavers.xmlを修正する</h3>

<p>Costura.Fodyをインストールすると、自動的にソリューションフォルダに<code>FodyWeavers.xml</code>が作成される。<br>
デフォルトでは下記のようになっている。</p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">FodyWeavers.xml</span></div>
<div class="highlight"><pre class="with-code"><code><span class="nt">&lt;Weavers</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"FodyWeavers.xsd"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Costura</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Weavers&gt;</span>
</code></pre></div>
</div>

<p>これを、下記のように修正する。</p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">修正後FodyWeavers.xml</span></div>
<div class="highlight"><pre class="with-code"><code><span class="nt">&lt;Weavers</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"FodyWeavers.xsd"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Costura&gt;</span>
    <span class="nt">&lt;IncludeAssemblies</span> <span class="nt">&gt;</span>
      ClassLibrary1
    <span class="nt">&lt;/IncludeAssemblies &gt;</span>
    <span class="nt">&lt;Unmanaged32Assemblies&gt;</span>
      Dll1_Win32
    <span class="nt">&lt;/Unmanaged32Assemblies&gt;</span>
    <span class="nt">&lt;Unmanaged64Assemblies&gt;</span>
      Dll1_x64
    <span class="nt">&lt;/Unmanaged64Assemblies&gt;</span>
  <span class="nt">&lt;/Costura&gt;</span>
<span class="nt">&lt;/Weavers&gt;</span>
</code></pre></div>
</div>

<p>各部分の意味は、下記の通り。</p>

<table>
<thead>
<tr>
<th style="text-align: left">tag</th>
<th style="text-align: left">意味</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">&lt;IncludeAssemblies&gt;</td>
<td style="text-align: left">Costuraを使ってexeに埋め込みたいManagedのdllをここに書く。(「.dll」は書かずに名前だけ。)</td>
</tr>
<tr>
<td style="text-align: left">&lt;Unmanaged32Assemblies&gt;</td>
<td style="text-align: left">Costuraを使ってexeに埋め込みたいUnManagedの32ビットのdllをここに書く。</td>
</tr>
<tr>
<td style="text-align: left">&lt;Unmanaged64Assemblies&gt;</td>
<td style="text-align: left">Costuraを使ってexeに埋め込みたいUnManagedの64ビットのdllをここに書く。</td>
</tr>
</tbody>
</table>

<p>他にも、exeに組み込まないようにしたりもできる。<br>
FodyWeavers.xmlについての詳細は、<a href="https://github.com/Fody/Costura" rel="nofollow noopener" target="_blank">Costuraのページ</a>の、<a href="https://github.com/Fody/Costura#configuration-options" rel="nofollow noopener" target="_blank">Consiguration Options</a>の部分を参照。</p>

<h3>
<span id="fodyweaversxmlをcアプリのプロジェクトに加えておく" class="fragment"></span><a href="#fodyweaversxml%E3%82%92c%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E5%8A%A0%E3%81%88%E3%81%A6%E3%81%8A%E3%81%8F"><i class="fa fa-link"></i></a>FodyWeavers.xmlをC#アプリのプロジェクトに加えておく</h3>

<p>FodyWeavers.xmlはVisualStudio上でプロジェクトに加えなくても、そこにあるだけでCostura的に動いてくれるが、dllを増やしたときなどにはメンテしないといけないものなので、見えやすいようにプロジェクトに加えておく。(必須ではない)</p>

<h1>
<span id="その他必要事項やメモなど" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E5%BF%85%E8%A6%81%E4%BA%8B%E9%A0%85%E3%82%84%E3%83%A1%E3%83%A2%E3%81%AA%E3%81%A9"><i class="fa fa-link"></i></a>その他必要事項やメモなど</h1>

<ul>
<li>各アプリやdllは、それが使用するdllがないとビルドできなかったり動作しないので、下から順番にビルドするように依存関係を設定しておくこと。</li>
<li>C++のプロジェクト作成時、デフォルトではX64とx86(Win32)の出力先フォルダは同じところになっていたと思うが、わかりやすいようにx64とx86(Win32)で別のフォルダになるように変えている。Costuraも、その別にしたフォルダを参照させている。<a href="https://camo.qiitausercontent.com/ffe3553225d240e500389b7677966310c31947d8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f39396536666630632d383835352d626135352d303065312d3563653531396338303164652e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F99e6ff0c-8855-ba55-00e1-5ce519c801de.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=02bcb8cfc29e737eefe41067b4a936d0" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/99e6ff0c-8855-ba55-00e1-5ce519c801de.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F99e6ff0c-8855-ba55-00e1-5ce519c801de.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=386c1fd9b82f65237da65b834a65b2c7 1x" loading="lazy"></a>
</li>
<li>デバッグでstep実行などをするにはpdbファイルが必要になるので、ビルド後コマンドなどを使ってpdbがexeと同じフォルダにコピーされるようにする。</li>
</ul>

<h1>
<span id="実験完了" class="fragment"></span><a href="#%E5%AE%9F%E9%A8%93%E5%AE%8C%E4%BA%86"><i class="fa fa-link"></i></a>実験完了</h1>

<p>以上で、exeの中にx64とx86のdllを組み込んで、アプリが動作する。</p>

<p>とくに<strong>「FodyWeavers.xmlを修正する」</strong>あたりがややこしくて何をしているか最初の頃わからなくなっていたので、実施する際は今回のような仮のソリューションを作って練習した方がいいと思う。</p>

<h1>
<span id="別解190731追記むしろこちらの方がcsprojファイルを直接いじったりしないのでお勧め" class="fragment"></span><a href="#%E5%88%A5%E8%A7%A3190731%E8%BF%BD%E8%A8%98%E3%82%80%E3%81%97%E3%82%8D%E3%81%93%E3%81%A1%E3%82%89%E3%81%AE%E6%96%B9%E3%81%8Ccsproj%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%9B%B4%E6%8E%A5%E3%81%84%E3%81%98%E3%81%A3%E3%81%9F%E3%82%8A%E3%81%97%E3%81%AA%E3%81%84%E3%81%AE%E3%81%A7%E3%81%8A%E5%8B%A7%E3%82%81"><i class="fa fa-link"></i></a>★別解（19/07/31追記）（むしろこちらの方が、csprojファイルを直接いじったりしないのでお勧め）</h1>

<p>いろいろ調べているうちに、個人的によりよいと思えるやり方を見つけたので記載しておく。(<a href="https://blog.jonstodle.com/putting-dlls-into-a-single-wpf-exe/" rel="nofollow noopener" target="_blank">参考</a>)<br>
元のやり方で<strong>「とくに「FodyWeavers.xmlを修正する」あたりがややこしくて...」</strong>と思っていたリンクを作る当たりの作業を行わなくて済む。こちらは基本的に同じことをするが、下記の点が異なる。</p>

<ol>
<li>
<strong>DLL(C++)(x64用/x86)をつくる</strong>のところで、x63,86の出力ファイルの名前を別のもの(Dll1_Win32.dll/Dll1)
_x64.dllにしていたが、それをおなじ名前に戻す(どちらもDll1.dllにする)</li>
<li>
<strong>DLL(C++)(x64用/x86)をつくる</strong>のところで、「ビルド後イベント」にC++のdllをC#アプリのcostura32/64フォルダにコピーするコマンドを入れる</li>
<li>
<strong>作成したフォルダに、x64,x86のdllへのリンクを追加する</strong>のところで、リンクを追加ではなく、costura32/64フォルダにコピーされている実体のファイルを埋め込みリソースとして追加する</li>
<li>
<strong>FodyWeavers.xmlを修正する</strong>のところで、Dll1_Win32、Dll1_x64、と分けていた名前を、どちらも<strong>Dll1</strong>にする</li>
</ol>

<p>という風にすると、元のやり方の方で、C#アプリの.csprojファイルをエディタで選んで直接編集してたような、変なことをしなくてよいので、やり方としてはこちらの方がきれいな気がする。(実体のdllがソリューション内に複数できてしまうのはデメリットといえばデメリット)</p>

<p>一応、2.3.4を行ったときのバッチのサンプルやFodyWeavers.xmlの一部を上げておく。</p>

<h3>
<span id="2のビルド後イベントの中身" class="fragment"></span><a href="#2%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E5%BE%8C%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%AE%E4%B8%AD%E8%BA%AB"><i class="fa fa-link"></i></a>2.のビルド後イベントの中身</h3>

<div class="code-frame" data-lang="batchfile">
<div class="code-lang"><span class="bold">2ビルド後イベント.bat</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c">rem C++の出力ファイルのdllを、C#アプリのプロジェクトにあるcostura32/64フォルダにコピーする</span>
<span class="c">rem costura32/64にあるアンマネージドのC++dllが、exeに組み込まれる</span>
<span class="k">if</span> $<span class="o">(</span><span class="kd">Platform</span><span class="o">)</span> <span class="o">==</span> <span class="kd">Win32</span> <span class="o">(</span>
<span class="nb">xcopy</span> <span class="na">/Y /I </span>$<span class="o">(</span><span class="kd">SolutionDir</span><span class="o">)</span><span class="kd">Dll1</span>\bin\$<span class="o">(</span><span class="kd">Platform</span><span class="o">)</span>\$<span class="o">(</span><span class="kd">Configuration</span><span class="o">)</span>\<span class="o">*</span>.dll $<span class="o">(</span><span class="kd">SolutionDir</span><span class="o">)</span><span class="kd">ConsoleApp10</span>\costura32\
<span class="nb">xcopy</span> <span class="na">/Y /I </span>$<span class="o">(</span><span class="kd">SolutionDir</span><span class="o">)</span><span class="kd">Dll1</span>\bin\$<span class="o">(</span><span class="kd">Platform</span><span class="o">)</span>\$<span class="o">(</span><span class="kd">Configuration</span><span class="o">)</span>\<span class="o">*</span>.pdb $<span class="o">(</span><span class="kd">SolutionDir</span><span class="o">)</span><span class="kd">ConsoleApp10</span>\costura32\
<span class="o">)</span>
<span class="k">if</span> $<span class="o">(</span><span class="kd">Platform</span><span class="o">)</span> <span class="o">==</span> <span class="kd">x64</span> <span class="o">(</span>
<span class="nb">xcopy</span> <span class="na">/Y /I </span>$<span class="o">(</span><span class="kd">SolutionDir</span><span class="o">)</span><span class="kd">Dll1</span>\bin\$<span class="o">(</span><span class="kd">Platform</span><span class="o">)</span>\$<span class="o">(</span><span class="kd">Configuration</span><span class="o">)</span>\<span class="o">*</span>.dll $<span class="o">(</span><span class="kd">SolutionDir</span><span class="o">)</span><span class="kd">ConsoleApp10</span>\costura64\
<span class="nb">xcopy</span> <span class="na">/Y /I </span>$<span class="o">(</span><span class="kd">SolutionDir</span><span class="o">)</span><span class="kd">Dll1</span>\bin\$<span class="o">(</span><span class="kd">Platform</span><span class="o">)</span>\$<span class="o">(</span><span class="kd">Configuration</span><span class="o">)</span>\<span class="o">*</span>.pdb $<span class="o">(</span><span class="kd">SolutionDir</span><span class="o">)</span><span class="kd">ConsoleApp10</span>\costura64\
<span class="o">)</span>
</code></pre></div>
</div>

<h3>
<span id="3の設定をしたときのソリューションエクスプローラの表示とcsprojの中身の一部" class="fragment"></span><a href="#3%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%97%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E8%A1%A8%E7%A4%BA%E3%81%A8csproj%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%81%AE%E4%B8%80%E9%83%A8"><i class="fa fa-link"></i></a>3.の設定をしたときのソリューションエクスプローラの表示とcsprojの中身の一部</h3>

<p><a href="https://camo.qiitausercontent.com/e4309368a4585c52cd00685bddb92995e6d79d43/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f61343161323937342d663062622d356663342d616133382d3338396138383966383530332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fa41a2974-f0bb-5fc4-aa38-389a889f8503.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0e2beae2f075199332adda5ff2f3e03a" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/a41a2974-f0bb-5fc4-aa38-389a889f8503.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fa41a2974-f0bb-5fc4-aa38-389a889f8503.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=c7cdf9d03e67e6bbf997fdb2183f3603 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/250626123f8808e4fd79bb4338ea48b9ece27169/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f36643134323336662d353731362d623030382d393639372d6163373832356461616365332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F6d14236f-5716-b008-9697-ac7825daace3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a751eab2eeb1f00d3dac4ec2aec4abf4" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/6d14236f-5716-b008-9697-ac7825daace3.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F6d14236f-5716-b008-9697-ac7825daace3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b55ee280a450dd376923f665f402ed5f 1x" loading="lazy"></a></p>

<h3>
<span id="4で修正したfodyweaversxml" class="fragment"></span><a href="#4%E3%81%A7%E4%BF%AE%E6%AD%A3%E3%81%97%E3%81%9Ffodyweaversxml"><i class="fa fa-link"></i></a>4.で修正したFodyWeavers.xml</h3>

<p><a href="https://camo.qiitausercontent.com/46419c89d8acd627530e9f8f088ba6d5d2e19113/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f66363564666561662d393431632d343837342d656139662d6331623233343131333239352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Ff65dfeaf-941c-4874-ea9f-c1b234113295.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=594ad306b3d7a24d1042863871b0341b" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/f65dfeaf-941c-4874-ea9f-c1b234113295.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Ff65dfeaf-941c-4874-ea9f-c1b234113295.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3b059273612cf2ddfa64b808bf2e0c9b 1x" loading="lazy"></a><br>
※ただ、この<code>&lt;Unmanaged32Assemblies&gt;</code>と<code>&lt;Unmanaged64Assemblies&gt;</code>は、直さなくても、というか、何と書かれていても、もっと言うと、この2つがなくても、うまくexeにx64,86のdllは組み込まれてる気がする..(costura32/costura64フォルダにさえ入っていれば、組み込まれてくれる？？)</p>

<h1>
<span id="元のやり方と別解の保存場所" class="fragment"></span><a href="#%E5%85%83%E3%81%AE%E3%82%84%E3%82%8A%E6%96%B9%E3%81%A8%E5%88%A5%E8%A7%A3%E3%81%AE%E4%BF%9D%E5%AD%98%E5%A0%B4%E6%89%80"><i class="fa fa-link"></i></a>元のやり方と別解の保存場所</h1>

<p>ちょっと色々ごちゃごちゃ書いたので、コードを見た方がはやいかもしれない。下記を見て、別解を試すときは比較してやれば、何が変わったかわかりやすいと思う。</p>

<p>■元のやり方<br>
x64,86のdllをcostura32/64フォルダにリンクとして追加する方法<br>
<a href="https://github.com/tera1707/WPF-/commit/71d0938d6c74b7190a423e418fd041fcff6e45fb#diff-cce630225d448987223f968060114623" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/tera1707/WPF-/commit/71d0938d6c74b7190a423e418fd041fcff6e45fb#diff-cce630225d448987223f968060114623</a></p>

<p>■別解<br>
x64,86のdllをcostura32/64フォルダに実体コピーして使う方法<br>
<a href="https://github.com/tera1707/WPF-/commit/4459dc07eea73d7d76813eb7bf2b3b6de61bbf0d#diff-cce630225d448987223f968060114623" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/tera1707/WPF-/commit/4459dc07eea73d7d76813eb7bf2b3b6de61bbf0d#diff-cce630225d448987223f968060114623</a></p>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<p>Costura Github<br>
<a href="https://github.com/Fody/Costura" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Fody/Costura</a></p>

<p>【C++/C#】C++で作成したDLLをC#で呼ぶ<br>
<a href="https://qiita.com/tera1707/items/81042abaa62dc97e26ae" class="autolink">https://qiita.com/tera1707/items/81042abaa62dc97e26ae</a></p>

<p>Putting DLLs Into a Single WPF Exe<br>
<a href="https://blog.jonstodle.com/putting-dlls-into-a-single-wpf-exe/" class="autolink" rel="nofollow noopener" target="_blank">https://blog.jonstodle.com/putting-dlls-into-a-single-wpf-exe/</a></p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Ftera1707%2Fitems%2F522d96861486430c2800&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Ftera1707%2Fitems%2F522d96861486430c2800&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/tera1707/items/522d96861486430c2800/likers" class="css-1iupg5d">8</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">5</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/522d96861486430c2800/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/tera1707/items/522d96861486430c2800/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/tera1707/items/522d96861486430c2800/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/tera1707/items/522d96861486430c2800/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/tera1707/items/522d96861486430c2800.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-b88759bb-8372-491b-a229-74590485a68e">{"authorAnalyticsTrackingId":"UA-140152640-1","organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-0dde3a3b-8b81-4f59-a7cf-dbae6aff11f7"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-0dde3a3b-8b81-4f59-a7cf-dbae6aff11f7">{}</script>
      
<div id="LoginModal-react-component-16491cbf-8b1a-475d-92ec-cac0fcae5dea"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-16491cbf-8b1a-475d-92ec-cac0fcae5dea">{}</script>
      
<div id="StockModal-react-component-43367dda-4bf7-45b6-a830-f4a753ac357c"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-43367dda-4bf7-45b6-a830-f4a753ac357c">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;AsBmmVxKipCNQH2/0pl3WbJPAerwGQpKm3WTj6AZWLVqkytpIfqniAGhGd1uca9gyBRDs/BCa0JjUEvaqjthTw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"やりたいこと\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eやりたいこと\u003c/h1\u003e\n\n\u003cp\u003eUnmanagedなC++のdllで、x64用とx86用を作って。dllを使う側に「64ビット環境ならx64用を、32ビット環境ならx86用を使ってください」というのをやめて、1つのdllファイルで、使う環境に合わせて自動でx64/x86を切り替えてくれるようにしたい。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"やり方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%84%E3%82%8A%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eやり方\u003c/h1\u003e\n\n\u003cp\u003eCosturaを使って、使う側にx64用、x86用のdll両方を組み込んで切り替えることで実現する。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"前提\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%89%8D%E6%8F%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e前提\u003c/h1\u003e\n\n\u003cp\u003e今回は、\u003ccode\u003eCostura.Fody4.0.0\u003c/code\u003eを使用して実験する。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"サンプルコード\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eサンプルコード\u003c/h1\u003e\n\n\u003cp\u003e\u003cqiita-embed-ogp src=\"https://github.com/tera1707/WPF-/tree/master/029_CosturaTest\"\u003e\u003c/qiita-embed-ogp\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実験イメージ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E9%A8%93%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実験イメージ\u003c/h1\u003e\n\n\u003cp\u003e通常は、dllを使う側のexeと同じ階層に、使うdllが置いてあるイメージ。\u003cbr\u003e\n(x64とx86があるdllがある場合は、必要な方のdllが置いてあるイメージ。)\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/a977218c8de612e23624d2bc26e97f84b5f0579e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f32383134356535622d356266352d303863382d626131642d3934656163626539653735352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F28145e5b-5bf5-08c8-ba1d-94eacbe9e755.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a2cb93ee1e74ffef8221aac33855fd6d\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/28145e5b-5bf5-08c8-ba1d-94eacbe9e755.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F28145e5b-5bf5-08c8-ba1d-94eacbe9e755.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=4b39f440b56fe4d387535d9085122b22 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eCosturaを使った場合は、全部のdllをexeに組み込んで、x64とx86があるものに関しては自動で切り替えてくれるイメージ。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/fb410f1f079045eb1ba2a740f4869fb86204d6dc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f65346436333235322d376334382d396533662d626635392d3235656462386363613934332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fe4d63252-7c48-9e3f-bf59-25edb8cca943.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e611c160147512e9762c0bf9f16fccff\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/e4d63252-7c48-9e3f-bf59-25edb8cca943.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fe4d63252-7c48-9e3f-bf59-25edb8cca943.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b148a3680935e15e90dc7d9af392eee1 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n※各図のdllやexeの名前は、今回実験で作ったものを使用。\u003c/p\u003e\n\n\u003cp\u003e今回の実験では、一番下のDLL(C++ x64/x86)の足し算をする関数を、一つ上のC#のDLLが呼び、さらにそのC#のメソッドをアプリが呼ぶ、という構成にする。\u003cbr\u003e\nそのアプリが使う、C#とC++のDLLをexeにまるっと組み込んで、C++のDLLに関しては、x64とx86を両方組み込んで、自動で切り替える、ということをする。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実験でつくるソリューション概要\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E9%A8%93%E3%81%A7%E3%81%A4%E3%81%8F%E3%82%8B%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%A6%82%E8%A6%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実験でつくるソリューション概要\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/4b072c98d6edb6bc8868ad9585358619edd022b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f61343335363837652d303537632d613932392d323961632d3434633262393937636638342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fa435687e-057c-a929-29ac-44c2b997cf84.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d77207b4260e678122aa4ca0c09869c0\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/a435687e-057c-a929-29ac-44c2b997cf84.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fa435687e-057c-a929-29ac-44c2b997cf84.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=dd25e3ec9949c1fc079da299be7ab74d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実験手順\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E9%A8%93%E6%89%8B%E9%A0%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実験手順\u003c/h1\u003e\n\n\u003cp\u003e上の実験イメージにある、下記3つを作って実験する。Costura自体は、アプリのところ(アプリ(C#))で使用する。\u003cstrong\u003eCostura周りだけ知りたいときは、\u003ca href=\"\"\u003eそちら\u003c/a\u003e参照\u003c/strong\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eDLL(C++)(x64用/x86)\u003c/li\u003e\n\u003cli\u003eDLL(C#)\u003c/li\u003e\n\u003cli\u003eアプリ(C#)　\u003cstrong\u003e←!!!ここにCosturaを入れる!!!\u003c/strong\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"dllcx64用x86をつくる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dllcx64%E7%94%A8x86%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDLL(C++)(x64用/x86)をつくる\u003c/h2\u003e\n\n\u003cp\u003e一つ上の層のC#のDLLで呼ばれる関数をつくる。\u003cbr\u003e\n(C++のDLLの作り方は、\u003ca href=\"https://qiita.com/tera1707/items/81042abaa62dc97e26ae\" id=\"reference-79f10bf07243765e7134\"\u003e以前の記事\u003c/a\u003eを参照)\u003c/p\u003e\n\n\u003cp\u003e中身は、単に引数を足し合わせるだけ。特殊なプロジェクトの設定等もとくに無し。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c++\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDll1.cpp\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#include \"pch.h\"\n#include \u0026lt;windows.h\u0026gt;\n#include \u0026lt;stdio.h\u0026gt;\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#define VC_DLL_EXPORTS\n#include \"Dll1.h\"\n\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// エクスポート関数の実装\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"kr\"\u003e__cdecl\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnmanagedAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e※.hファイルやその他のファイルは、\u003ca href=\"https://github.com/tera1707/WPF-/tree/master/029_CosturaTest\" rel=\"nofollow noopener\" target=\"_blank\"\u003eサンプルコード\u003c/a\u003eを参照\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"dllcをつくる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dllc%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDLL(C#)をつくる\u003c/h2\u003e\n\n\u003cp\u003ex64/x86のdllの計算関数を呼んで、結果を返すだけのメソッド。アプリから呼ばれるdll。このdllも、Costuraでexeに組み込まれる。\u003c/p\u003e\n\n\u003cp\u003eやっていることは、C++のdllの関数をC#でラップしているだけ。特殊なプロジェクトの設定等もとくに無し。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eClass1.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Runtime.InteropServices\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eClassLibrary1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eClass1\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnmanagedAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eNativeMethod\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Dll1.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCallingConvention\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCallingConvention\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCdecl\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnmanagedAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"アプリcをつくるcosturaを使う\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A2%E3%83%97%E3%83%AAc%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8Bcostura%E3%82%92%E4%BD%BF%E3%81%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eアプリ(C#)をつくる（Costuraを使う）\u003c/h2\u003e\n\n\u003cp\u003eC#のdllのメソッドを呼んで、足し算を行う。このプロジェクトで、Costuraを使ってC#のdllとC++のdllをexeに組み込むということをする。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"nugetでcosturaを参照に加える\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#nuget%E3%81%A7costura%E3%82%92%E5%8F%82%E7%85%A7%E3%81%AB%E5%8A%A0%E3%81%88%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNugetでCosturaを参照に加える\u003c/h3\u003e\n\n\u003cp\u003eNugetで「Costura.Fody」と検索し、\u003ccode\u003eCostura.Fody v4.0.0\u003c/code\u003eをC#アプリのプロジェクトにインストールする。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/d7e11374c53ba2d07257246979c9c3c6ea89b68d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f30343838623038332d383664632d663466612d613462612d3332326239306639616265662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F0488b083-86dc-f4fa-a4ba-322b90f9abef.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=adb5da580dd7ffd0d2b4973c0a774e97\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/0488b083-86dc-f4fa-a4ba-322b90f9abef.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F0488b083-86dc-f4fa-a4ba-322b90f9abef.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=64a9be3a803b505ca70325e092b760e1 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"cアプリのプロジェクトにフォルダを追加する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#c%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eC#アプリのプロジェクトにフォルダを追加する\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eC#アプリのプロジェクト(ここではConsoleApp10)を右クリックして、[追加] \u0026gt; [新しいフォルダ] を選択する。\u003c/li\u003e\n\u003cli\u003e新しいフォルダができるので、そのフォルダの名前を\u003cstrong\u003e「costura32」\u003c/strong\u003eに変更する。\u003c/li\u003e\n\u003cli\u003e同じようにして、\u003cstrong\u003e「costura64」\u003c/strong\u003eフォルダを作成する。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003e備考\u003c/strong\u003e\u003cbr\u003e\nここでやっているのは、C#アプリのプロジェクトに、x64、x86のdllを配置するためのフォルダを作るという作業。\u003cbr\u003e\nCosturaが、そこに作成せよと指定している。詳細は\u003ca href=\"https://github.com/Fody/Costura#native-libraries-and-preloadorder\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこちら\u003c/a\u003e参照。\u003cbr\u003e\n→「ネイティブライブラリを含めるには、ライブラリのビット数に応じて、costura32またはcostura64というフォルダを作成して、埋め込みリソースとして各ビット数のライブラリをプロジェクトに含める必要があります。」とのこと。(訳に自信なし)\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"作成したフォルダにx64x86のdllへのリンクを追加する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E3%81%ABx64x86%E3%81%AEdll%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e作成したフォルダに、x64,x86のdllへのリンクを追加する\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003ecostura32フォルダを右クリックし、[追加] \u0026gt; [既存の項目] を選択する。\u003c/li\u003e\n\u003cli\u003e[既存項目の追加]ウインドウで、C++ライブラリの32ビット版の出力フォルダを開く。(ここでは\u003ccode\u003e\\\u0026lt;Solutionフォルダ\\\u0026gt;\\Dll1\\bin\\Win32\\Debug\u003c/code\u003e。事前にC++ライブラリをWin32でビルドしている必要アリ)\u003c/li\u003e\n\u003cli\u003eそこにある32ビット版のC++のdllを選択\u003c/li\u003e\n\u003cli\u003e[追加]ボタンの右の▼をクリックし、[リンクとして追加]を選択する\u003ca href=\"https://camo.qiitausercontent.com/aa403d1b250e8bf0306e9adacaac355abbeced23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f65306338313032342d323136622d323332382d313235642d6331343532646264376433382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fe0c81024-216b-2328-125d-c1452dbd7d38.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=23544670665b3a81d10a375cfe3e4d8f\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/e0c81024-216b-2328-125d-c1452dbd7d38.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fe0c81024-216b-2328-125d-c1452dbd7d38.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=162bcf4119e54d0c279075961dabb9b7 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e同じようにして、64ビット版も追加する。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e上記を行うと、このようになる。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/274930018c784f985bd4e2fe5ea6aa03ae6d15e1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f33643135656364322d326430372d633665332d366630652d6338623933666634616666642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F3d15ecd2-2d07-c6e3-6f0e-c8b93ff4affd.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d830d0720a3cf4bc3def8f97ae373f58\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/3d15ecd2-2d07-c6e3-6f0e-c8b93ff4affd.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F3d15ecd2-2d07-c6e3-6f0e-c8b93ff4affd.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=09f7b200dee8b8d5e66b69d9956ee41f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"追加したリンクを埋め込みリソースにする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%92%E5%9F%8B%E3%82%81%E8%BE%BC%E3%81%BF%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e追加したリンクを埋め込みリソースにする\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003e追加したDLL(へのリンク)を右クリックし、[プロパティ]を選択する\u003c/li\u003e\n\u003cli\u003eプロパティの中の[ビルドアクション]を、\u003cstrong\u003e[埋め込みリソース]\u003c/strong\u003eに設定する\u003c/li\u003e\n\u003cli\u003eプロパティの中の[出力ディレクトリにコピー]を、\u003cstrong\u003e[コピーしない]\u003c/strong\u003eに設定する\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"追加したリンクの名前をx86とx64で共通の名前にする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E5%90%8D%E5%89%8D%E3%82%92x86%E3%81%A8x64%E3%81%A7%E5%85%B1%E9%80%9A%E3%81%AE%E5%90%8D%E5%89%8D%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e追加したリンクの名前を、x86とx64で共通の名前にする\u003c/h3\u003e\n\n\u003cp\u003e呼び出し側のアプリのコードは共通で、x64とx86を自動で呼び分けられるように、dllの参照の名前に手を加える。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eエクスプローラでC#アプリのフォルダを開く\u003c/li\u003e\n\u003cli\u003eC#アプリの.csprojファイル(ここでは\u003ccode\u003eConsoleApp10.csproj\u003c/code\u003e)をエディタで開く\u003c/li\u003e\n\u003cli\u003ex64,x86のdllへのリンク部分を、下記のように直す。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;ItemGroup\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;EmbeddedResource\u003c/span\u003e \u003cspan class=\"na\"\u003eInclude=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"..\\Dll1\\bin\\Win32\\Debug\\Dll1_Win32.dll\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e ★実物はx86の出力物\n      \u003cspan class=\"nt\"\u003e\u0026lt;Link\u0026gt;\u003c/span\u003ecostura32\\Dll1.dll\u003cspan class=\"nt\"\u003e\u0026lt;/Link\u0026gt;\u003c/span\u003e ★ここが、x64とx86で共通の名前になる\n    \u003cspan class=\"nt\"\u003e\u0026lt;/EmbeddedResource\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;EmbeddedResource\u003c/span\u003e \u003cspan class=\"na\"\u003eInclude=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"..\\Dll1\\bin\\x64\\Debug\\Dll1_x64.dll\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e ★実物はx64の出力物\n      \u003cspan class=\"nt\"\u003e\u0026lt;Link\u0026gt;\u003c/span\u003ecostura64\\Dll1.dll\u003cspan class=\"nt\"\u003e\u0026lt;/Link\u0026gt;\u003c/span\u003e ★ここが、x64とx86で共通の名前になる\n    \u003cspan class=\"nt\"\u003e\u0026lt;/EmbeddedResource\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;Content\u003c/span\u003e \u003cspan class=\"na\"\u003eInclude=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"FodyWeavers.xml\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;/ItemGroup\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで、C++のdllを呼ぶ側からは共通のコードでx64,x86のdllを使えるようになる。そのコードの該当部分は下記。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eClass1の一部.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eNativeMethod\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ★ここで、「Dll1＿Win32.dll」「Dll1_x64.dll」とか分けずにDll1を使える！！\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Dll1.dll\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCallingConvention\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCallingConvention\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCdecl\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnmanagedAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"fodyweaversxmlを修正する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#fodyweaversxml%E3%82%92%E4%BF%AE%E6%AD%A3%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFodyWeavers.xmlを修正する\u003c/h3\u003e\n\n\u003cp\u003eCostura.Fodyをインストールすると、自動的にソリューションフォルダに\u003ccode\u003eFodyWeavers.xml\u003c/code\u003eが作成される。\u003cbr\u003e\nデフォルトでは下記のようになっている。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eFodyWeavers.xml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;Weavers\u003c/span\u003e \u003cspan class=\"na\"\u003exmlns:xsi=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://www.w3.org/2001/XMLSchema-instance\"\u003c/span\u003e \u003cspan class=\"na\"\u003exsi:noNamespaceSchemaLocation=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"FodyWeavers.xsd\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;Costura\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/Weavers\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこれを、下記のように修正する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e修正後FodyWeavers.xml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;Weavers\u003c/span\u003e \u003cspan class=\"na\"\u003exmlns:xsi=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://www.w3.org/2001/XMLSchema-instance\"\u003c/span\u003e \u003cspan class=\"na\"\u003exsi:noNamespaceSchemaLocation=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"FodyWeavers.xsd\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;Costura\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;IncludeAssemblies\u003c/span\u003e \u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n      ClassLibrary1\n    \u003cspan class=\"nt\"\u003e\u0026lt;/IncludeAssemblies \u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;Unmanaged32Assemblies\u0026gt;\u003c/span\u003e\n      Dll1_Win32\n    \u003cspan class=\"nt\"\u003e\u0026lt;/Unmanaged32Assemblies\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;Unmanaged64Assemblies\u0026gt;\u003c/span\u003e\n      Dll1_x64\n    \u003cspan class=\"nt\"\u003e\u0026lt;/Unmanaged64Assemblies\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;/Costura\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/Weavers\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e各部分の意味は、下記の通り。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003etag\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e意味\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e\u0026lt;IncludeAssemblies\u0026gt;\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eCosturaを使ってexeに埋め込みたいManagedのdllをここに書く。(「.dll」は書かずに名前だけ。)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e\u0026lt;Unmanaged32Assemblies\u0026gt;\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eCosturaを使ってexeに埋め込みたいUnManagedの32ビットのdllをここに書く。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e\u0026lt;Unmanaged64Assemblies\u0026gt;\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eCosturaを使ってexeに埋め込みたいUnManagedの64ビットのdllをここに書く。\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e他にも、exeに組み込まないようにしたりもできる。\u003cbr\u003e\nFodyWeavers.xmlについての詳細は、\u003ca href=\"https://github.com/Fody/Costura\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCosturaのページ\u003c/a\u003eの、\u003ca href=\"https://github.com/Fody/Costura#configuration-options\" rel=\"nofollow noopener\" target=\"_blank\"\u003eConsiguration Options\u003c/a\u003eの部分を参照。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"fodyweaversxmlをcアプリのプロジェクトに加えておく\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#fodyweaversxml%E3%82%92c%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E5%8A%A0%E3%81%88%E3%81%A6%E3%81%8A%E3%81%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFodyWeavers.xmlをC#アプリのプロジェクトに加えておく\u003c/h3\u003e\n\n\u003cp\u003eFodyWeavers.xmlはVisualStudio上でプロジェクトに加えなくても、そこにあるだけでCostura的に動いてくれるが、dllを増やしたときなどにはメンテしないといけないものなので、見えやすいようにプロジェクトに加えておく。(必須ではない)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"その他必要事項やメモなど\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E5%BF%85%E8%A6%81%E4%BA%8B%E9%A0%85%E3%82%84%E3%83%A1%E3%83%A2%E3%81%AA%E3%81%A9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eその他必要事項やメモなど\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e各アプリやdllは、それが使用するdllがないとビルドできなかったり動作しないので、下から順番にビルドするように依存関係を設定しておくこと。\u003c/li\u003e\n\u003cli\u003eC++のプロジェクト作成時、デフォルトではX64とx86(Win32)の出力先フォルダは同じところになっていたと思うが、わかりやすいようにx64とx86(Win32)で別のフォルダになるように変えている。Costuraも、その別にしたフォルダを参照させている。\u003ca href=\"https://camo.qiitausercontent.com/ffe3553225d240e500389b7677966310c31947d8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f39396536666630632d383835352d626135352d303065312d3563653531396338303164652e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F99e6ff0c-8855-ba55-00e1-5ce519c801de.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=02bcb8cfc29e737eefe41067b4a936d0\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/99e6ff0c-8855-ba55-00e1-5ce519c801de.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F99e6ff0c-8855-ba55-00e1-5ce519c801de.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=386c1fd9b82f65237da65b834a65b2c7 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003eデバッグでstep実行などをするにはpdbファイルが必要になるので、ビルド後コマンドなどを使ってpdbがexeと同じフォルダにコピーされるようにする。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実験完了\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E9%A8%93%E5%AE%8C%E4%BA%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実験完了\u003c/h1\u003e\n\n\u003cp\u003e以上で、exeの中にx64とx86のdllを組み込んで、アプリが動作する。\u003c/p\u003e\n\n\u003cp\u003eとくに\u003cstrong\u003e「FodyWeavers.xmlを修正する」\u003c/strong\u003eあたりがややこしくて何をしているか最初の頃わからなくなっていたので、実施する際は今回のような仮のソリューションを作って練習した方がいいと思う。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"別解190731追記むしろこちらの方がcsprojファイルを直接いじったりしないのでお勧め\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%A5%E8%A7%A3190731%E8%BF%BD%E8%A8%98%E3%82%80%E3%81%97%E3%82%8D%E3%81%93%E3%81%A1%E3%82%89%E3%81%AE%E6%96%B9%E3%81%8Ccsproj%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%9B%B4%E6%8E%A5%E3%81%84%E3%81%98%E3%81%A3%E3%81%9F%E3%82%8A%E3%81%97%E3%81%AA%E3%81%84%E3%81%AE%E3%81%A7%E3%81%8A%E5%8B%A7%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e★別解（19/07/31追記）（むしろこちらの方が、csprojファイルを直接いじったりしないのでお勧め）\u003c/h1\u003e\n\n\u003cp\u003eいろいろ調べているうちに、個人的によりよいと思えるやり方を見つけたので記載しておく。(\u003ca href=\"https://blog.jonstodle.com/putting-dlls-into-a-single-wpf-exe/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e参考\u003c/a\u003e)\u003cbr\u003e\n元のやり方で\u003cstrong\u003e「とくに「FodyWeavers.xmlを修正する」あたりがややこしくて...」\u003c/strong\u003eと思っていたリンクを作る当たりの作業を行わなくて済む。こちらは基本的に同じことをするが、下記の点が異なる。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\n\u003cstrong\u003eDLL(C++)(x64用/x86)をつくる\u003c/strong\u003eのところで、x63,86の出力ファイルの名前を別のもの(Dll1_Win32.dll/Dll1)\n_x64.dllにしていたが、それをおなじ名前に戻す(どちらもDll1.dllにする)\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eDLL(C++)(x64用/x86)をつくる\u003c/strong\u003eのところで、「ビルド後イベント」にC++のdllをC#アプリのcostura32/64フォルダにコピーするコマンドを入れる\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e作成したフォルダに、x64,x86のdllへのリンクを追加する\u003c/strong\u003eのところで、リンクを追加ではなく、costura32/64フォルダにコピーされている実体のファイルを埋め込みリソースとして追加する\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eFodyWeavers.xmlを修正する\u003c/strong\u003eのところで、Dll1_Win32、Dll1_x64、と分けていた名前を、どちらも\u003cstrong\u003eDll1\u003c/strong\u003eにする\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eという風にすると、元のやり方の方で、C#アプリの.csprojファイルをエディタで選んで直接編集してたような、変なことをしなくてよいので、やり方としてはこちらの方がきれいな気がする。(実体のdllがソリューション内に複数できてしまうのはデメリットといえばデメリット)\u003c/p\u003e\n\n\u003cp\u003e一応、2.3.4を行ったときのバッチのサンプルやFodyWeavers.xmlの一部を上げておく。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"2のビルド後イベントの中身\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E5%BE%8C%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%AE%E4%B8%AD%E8%BA%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2.のビルド後イベントの中身\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"batchfile\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e2ビルド後イベント.bat\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003erem C++の出力ファイルのdllを、C#アプリのプロジェクトにあるcostura32/64フォルダにコピーする\u003c/span\u003e\n\u003cspan class=\"c\"\u003erem costura32/64にあるアンマネージドのC++dllが、exeに組み込まれる\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e $\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003ePlatform\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kd\"\u003eWin32\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003cspan class=\"nb\"\u003excopy\u003c/span\u003e \u003cspan class=\"na\"\u003e/Y /I \u003c/span\u003e$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eSolutionDir\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"kd\"\u003eDll1\u003c/span\u003e\\bin\\$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003ePlatform\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\\$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eConfiguration\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\\\u003cspan class=\"o\"\u003e*\u003c/span\u003e.dll $\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eSolutionDir\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"kd\"\u003eConsoleApp10\u003c/span\u003e\\costura32\\\n\u003cspan class=\"nb\"\u003excopy\u003c/span\u003e \u003cspan class=\"na\"\u003e/Y /I \u003c/span\u003e$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eSolutionDir\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"kd\"\u003eDll1\u003c/span\u003e\\bin\\$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003ePlatform\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\\$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eConfiguration\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\\\u003cspan class=\"o\"\u003e*\u003c/span\u003e.pdb $\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eSolutionDir\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"kd\"\u003eConsoleApp10\u003c/span\u003e\\costura32\\\n\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e $\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003ePlatform\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kd\"\u003ex64\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\n\u003cspan class=\"nb\"\u003excopy\u003c/span\u003e \u003cspan class=\"na\"\u003e/Y /I \u003c/span\u003e$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eSolutionDir\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"kd\"\u003eDll1\u003c/span\u003e\\bin\\$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003ePlatform\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\\$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eConfiguration\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\\\u003cspan class=\"o\"\u003e*\u003c/span\u003e.dll $\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eSolutionDir\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"kd\"\u003eConsoleApp10\u003c/span\u003e\\costura64\\\n\u003cspan class=\"nb\"\u003excopy\u003c/span\u003e \u003cspan class=\"na\"\u003e/Y /I \u003c/span\u003e$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eSolutionDir\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"kd\"\u003eDll1\u003c/span\u003e\\bin\\$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003ePlatform\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\\$\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eConfiguration\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\\\u003cspan class=\"o\"\u003e*\u003c/span\u003e.pdb $\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003eSolutionDir\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"kd\"\u003eConsoleApp10\u003c/span\u003e\\costura64\\\n\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"3の設定をしたときのソリューションエクスプローラの表示とcsprojの中身の一部\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%97%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E8%A1%A8%E7%A4%BA%E3%81%A8csproj%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%81%AE%E4%B8%80%E9%83%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.の設定をしたときのソリューションエクスプローラの表示とcsprojの中身の一部\u003c/h3\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/e4309368a4585c52cd00685bddb92995e6d79d43/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f61343161323937342d663062622d356663342d616133382d3338396138383966383530332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fa41a2974-f0bb-5fc4-aa38-389a889f8503.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=0e2beae2f075199332adda5ff2f3e03a\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/a41a2974-f0bb-5fc4-aa38-389a889f8503.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Fa41a2974-f0bb-5fc4-aa38-389a889f8503.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=c7cdf9d03e67e6bbf997fdb2183f3603 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/250626123f8808e4fd79bb4338ea48b9ece27169/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f36643134323336662d353731362d623030382d393639372d6163373832356461616365332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F6d14236f-5716-b008-9697-ac7825daace3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a751eab2eeb1f00d3dac4ec2aec4abf4\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/6d14236f-5716-b008-9697-ac7825daace3.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2F6d14236f-5716-b008-9697-ac7825daace3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b55ee280a450dd376923f665f402ed5f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"4で修正したfodyweaversxml\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4%E3%81%A7%E4%BF%AE%E6%AD%A3%E3%81%97%E3%81%9Ffodyweaversxml\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.で修正したFodyWeavers.xml\u003c/h3\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/46419c89d8acd627530e9f8f088ba6d5d2e19113/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3335323630312f66363564666561662d393431632d343837342d656139662d6331623233343131333239352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Ff65dfeaf-941c-4874-ea9f-c1b234113295.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=594ad306b3d7a24d1042863871b0341b\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/352601/f65dfeaf-941c-4874-ea9f-c1b234113295.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F352601%2Ff65dfeaf-941c-4874-ea9f-c1b234113295.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=3b059273612cf2ddfa64b808bf2e0c9b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n※ただ、この\u003ccode\u003e\u0026lt;Unmanaged32Assemblies\u0026gt;\u003c/code\u003eと\u003ccode\u003e\u0026lt;Unmanaged64Assemblies\u0026gt;\u003c/code\u003eは、直さなくても、というか、何と書かれていても、もっと言うと、この2つがなくても、うまくexeにx64,86のdllは組み込まれてる気がする..(costura32/costura64フォルダにさえ入っていれば、組み込まれてくれる？？)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"元のやり方と別解の保存場所\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%85%83%E3%81%AE%E3%82%84%E3%82%8A%E6%96%B9%E3%81%A8%E5%88%A5%E8%A7%A3%E3%81%AE%E4%BF%9D%E5%AD%98%E5%A0%B4%E6%89%80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e元のやり方と別解の保存場所\u003c/h1\u003e\n\n\u003cp\u003eちょっと色々ごちゃごちゃ書いたので、コードを見た方がはやいかもしれない。下記を見て、別解を試すときは比較してやれば、何が変わったかわかりやすいと思う。\u003c/p\u003e\n\n\u003cp\u003e■元のやり方\u003cbr\u003e\nx64,86のdllをcostura32/64フォルダにリンクとして追加する方法\u003cbr\u003e\n\u003ca href=\"https://github.com/tera1707/WPF-/commit/71d0938d6c74b7190a423e418fd041fcff6e45fb#diff-cce630225d448987223f968060114623\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/tera1707/WPF-/commit/71d0938d6c74b7190a423e418fd041fcff6e45fb#diff-cce630225d448987223f968060114623\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e■別解\u003cbr\u003e\nx64,86のdllをcostura32/64フォルダに実体コピーして使う方法\u003cbr\u003e\n\u003ca href=\"https://github.com/tera1707/WPF-/commit/4459dc07eea73d7d76813eb7bf2b3b6de61bbf0d#diff-cce630225d448987223f968060114623\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/tera1707/WPF-/commit/4459dc07eea73d7d76813eb7bf2b3b6de61bbf0d#diff-cce630225d448987223f968060114623\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"参考\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考\u003c/h1\u003e\n\n\u003cp\u003eCostura Github\u003cbr\u003e\n\u003ca href=\"https://github.com/Fody/Costura\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/Fody/Costura\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e【C++/C#】C++で作成したDLLをC#で呼ぶ\u003cbr\u003e\n\u003ca href=\"https://qiita.com/tera1707/items/81042abaa62dc97e26ae\" class=\"autolink\"\u003ehttps://qiita.com/tera1707/items/81042abaa62dc97e26ae\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003ePutting DLLs Into a Single WPF Exe\u003cbr\u003e\n\u003ca href=\"https://blog.jonstodle.com/putting-dlls-into-a-single-wpf-exe/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://blog.jonstodle.com/putting-dlls-into-a-single-wpf-exe/\u003c/a\u003e\u003c/p\u003e\n","createdAt":"2019-07-31T14:11:16Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"Pdy7f+Mmwl/ZPvRg040xNTbGS0z/u5JD--/IrmNoNS3IkNjG7E--iTmkc0JEy73WNnbR5dm1mA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-11-29T05:02:14Z","likesCount":8,"linkUrl":"https://qiita.com/tera1707/items/522d96861486430c2800","organization":null,"originalId":986893,"stockedCount":5,"title":"[C#/C++/costura] UnmanagedのC++x64/x86のdllをexeに組み込んで、動作時の環境により自動で切り替えて使用する(Costura)","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8\"\u003eやりたいこと\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%84%E3%82%8A%E6%96%B9\"\u003eやり方\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%89%8D%E6%8F%90\"\u003e前提\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89\"\u003eサンプルコード\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E9%A8%93%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8\"\u003e実験イメージ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E9%A8%93%E3%81%A7%E3%81%A4%E3%81%8F%E3%82%8B%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%A6%82%E8%A6%81\"\u003e実験でつくるソリューション概要\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E9%A8%93%E6%89%8B%E9%A0%86\"\u003e実験手順\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#dllcx64%E7%94%A8x86%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B\"\u003eDLL(C++)(x64用/x86)をつくる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#dllc%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8B\"\u003eDLL(C#)をつくる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A2%E3%83%97%E3%83%AAc%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8Bcostura%E3%82%92%E4%BD%BF%E3%81%86\"\u003eアプリ(C#)をつくる（Costuraを使う）\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#nuget%E3%81%A7costura%E3%82%92%E5%8F%82%E7%85%A7%E3%81%AB%E5%8A%A0%E3%81%88%E3%82%8B\"\u003eNugetでCosturaを参照に加える\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#c%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003eC#アプリのプロジェクトにフォルダを追加する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E3%81%ABx64x86%E3%81%AEdll%E3%81%B8%E3%81%AE%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003e作成したフォルダに、x64,x86のdllへのリンクを追加する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%83%AA%E3%83%B3%E3%82%AF%E3%82%92%E5%9F%8B%E3%82%81%E8%BE%BC%E3%81%BF%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AB%E3%81%99%E3%82%8B\"\u003e追加したリンクを埋め込みリソースにする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%83%AA%E3%83%B3%E3%82%AF%E3%81%AE%E5%90%8D%E5%89%8D%E3%82%92x86%E3%81%A8x64%E3%81%A7%E5%85%B1%E9%80%9A%E3%81%AE%E5%90%8D%E5%89%8D%E3%81%AB%E3%81%99%E3%82%8B\"\u003e追加したリンクの名前を、x86とx64で共通の名前にする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#fodyweaversxml%E3%82%92%E4%BF%AE%E6%AD%A3%E3%81%99%E3%82%8B\"\u003eFodyWeavers.xmlを修正する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#fodyweaversxml%E3%82%92c%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E5%8A%A0%E3%81%88%E3%81%A6%E3%81%8A%E3%81%8F\"\u003eFodyWeavers.xmlをC#アプリのプロジェクトに加えておく\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E5%BF%85%E8%A6%81%E4%BA%8B%E9%A0%85%E3%82%84%E3%83%A1%E3%83%A2%E3%81%AA%E3%81%A9\"\u003eその他必要事項やメモなど\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E9%A8%93%E5%AE%8C%E4%BA%86\"\u003e実験完了\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%A5%E8%A7%A3190731%E8%BF%BD%E8%A8%98%E3%82%80%E3%81%97%E3%82%8D%E3%81%93%E3%81%A1%E3%82%89%E3%81%AE%E6%96%B9%E3%81%8Ccsproj%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%9B%B4%E6%8E%A5%E3%81%84%E3%81%98%E3%81%A3%E3%81%9F%E3%82%8A%E3%81%97%E3%81%AA%E3%81%84%E3%81%AE%E3%81%A7%E3%81%8A%E5%8B%A7%E3%82%81\"\u003e★別解（19/07/31追記）（むしろこちらの方が、csprojファイルを直接いじったりしないのでお勧め）\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#2%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E5%BE%8C%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%AE%E4%B8%AD%E8%BA%AB\"\u003e2.のビルド後イベントの中身\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E3%82%BD%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%97%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E8%A1%A8%E7%A4%BA%E3%81%A8csproj%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%81%AE%E4%B8%80%E9%83%A8\"\u003e3.の設定をしたときのソリューションエクスプローラの表示とcsprojの中身の一部\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4%E3%81%A7%E4%BF%AE%E6%AD%A3%E3%81%97%E3%81%9Ffodyweaversxml\"\u003e4.で修正したFodyWeavers.xml\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cli\u003e\n\u003ca href=\"#%E5%85%83%E3%81%AE%E3%82%84%E3%82%8A%E6%96%B9%E3%81%A8%E5%88%A5%E8%A7%A3%E3%81%AE%E4%BF%9D%E5%AD%98%E5%A0%B4%E6%89%80\"\u003e元のやり方と別解の保存場所\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83\"\u003e参考\u003c/a\u003e\n\u003c/li\u003e\n\n","totalPv":3019,"uuid":"522d96861486430c2800","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"jGGcVtKHvdk1b3fHY/MDp5Ip/CjR--nH7fXV5uqSFjGRDs--9fsgE11PHVIYaQ+cmesiQw==","originalId":352601,"description":"","facebookUrl":null,"githubUrl":"https://github.com/tera1707","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://avatars0.githubusercontent.com/u/19180456?v=4","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars0.githubusercontent.com%2Fu%2F19180456%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=d374ef2a13106c43b12251ae9f724ca0","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars0.githubusercontent.com%2Fu%2F19180456%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1ddd4d18cb0c4d9ee77ed7cff93f4ae1","urlName":"tera1707","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C++","urlName":"cpp"},{"name":"C#","urlName":"csharp"},{"name":"dll","urlName":"dll"},{"name":"costura","urlName":"costura"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
