<!DOCTYPE html><html><head><meta charset="utf-8" /><title>List&lt;T&gt;に対するforとforeachとForEachのアクセス速度のホントの所 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/Tokeiya/items/de46281e7cf071db3336" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="bdd1YNUVZHVjFnXgMQ0CzOuRSzCU4W7XY8DdJ0iNccpdbZFForoADdnTMOdQfcVY7aHUDsxBWft+EWlJX4aZEA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@NetSeed" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="List&lt;T&gt;に対するforとforeachとForEachのアクセス速度のホントの所 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1UR2x6ZER4VVB1T0JxLVd2dnVPQm1lT0NpMlp2Y3VPQnFHWnZjbVZoWTJqamdhaEdiM0pGWVdObzQ0R3U0NEtpNDRLdjQ0Szc0NEs1NllDZjVicW00NEd1NDRPYjQ0T3o0NE9JNDRHdTVvbUEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZTY0MjJkNzZlOGZiNTFlNzU0ZjUwN2JmMjZkOTNjMmM&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ2YTJWcGVXRSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWU4N2MzZjIyY2JkYjIzYzFkZDg2MjZiMjcyODhjNzAy&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=991a4e0f75cd548c4fd0fe5c6fd7b6ac"><meta property="og:description" content="

TL;DR

forとforeachのアクセス速度比較を見てて､完全に間違った結論に達していたからなんとなく､ホントの所を書いておこうかなって｡
最初コメントを書こうかと思ったのだけど､思いのほか書くことが増えたので別のエントリと..."><meta content="https://qiita.com/Tokeiya/items/de46281e7cf071db3336" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-4704b8e3-514d-4244-90f2-955912042a60"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FTokeiya%2Fitems%2Fde46281e7cf071db3336">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FTokeiya%2Fitems%2Fde46281e7cf071db3336">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-4704b8e3-514d-4244-90f2-955912042a60">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-02-19T22:00:06.000+09:00","dateModified":"2018-04-27T09:15:16.000+09:00","headline":"List\u003cT\u003eに対するforとforeachとForEachのアクセス速度のホントの所","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1UR2x6ZER4VVB1T0JxLVd2dnVPQm1lT0NpMlp2Y3VPQnFHWnZjbVZoWTJqamdhaEdiM0pGWVdObzQ0R3U0NEtpNDRLdjQ0Szc0NEs1NllDZjVicW00NEd1NDRPYjQ0T3o0NE9JNDRHdTVvbUEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZTY0MjJkNzZlOGZiNTFlNzU0ZjUwN2JmMjZkOTNjMmM\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ2YTJWcGVXRSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWU4N2MzZjIyY2JkYjIzYzFkZDg2MjZiMjcyODhjNzAy\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=991a4e0f75cd548c4fd0fe5c6fd7b6ac","mainEntityOfPage":"https://qiita.com/Tokeiya/items/de46281e7cf071db3336","author":{"@type":"Person","address":"Sakuranbo Pref,Japan","email":null,"identifier":"Tokeiya","name":"Tokeiya","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F9662%2Fprofile-images%2F1554356909?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=b571a856c59b74012dbee483be67170a","url":"https://qiita.com/Tokeiya","description":"C#ｽｺｼﾜｶﾙ","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Tokeiya","type":"items","id":"de46281e7cf071db3336"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Tokeiya","type":"items","id":"de46281e7cf071db3336"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Tokeiya","type":"items","id":"de46281e7cf071db3336"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/Tokeiya/items/de46281e7cf071db3336","location":"/Tokeiya/items/de46281e7cf071db3336","scheme":"https","host":"qiita.com","port":null,"pathname":"/Tokeiya/items/de46281e7cf071db3336","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"1dczIstW3Bn8FDoZVHZ14ZZ71PieyyJGxYp/MMBmkKrlbdcHvPm4YUbRfx41BrJ1kEtLxsZrFWrYW8te1214cA==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-c5d71cb8-ebc4-44ff-a99f-e9991cec87ef"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Tokeiya/items/de46281e7cf071db3336/likers" class="css-1iupg5d">32</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">31</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/de46281e7cf071db3336/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Tokeiya/items/de46281e7cf071db3336/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Tokeiya/items/de46281e7cf071db3336/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Tokeiya/items/de46281e7cf071db3336/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Tokeiya/items/de46281e7cf071db3336.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/Tokeiya"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/9662/profile-images/1554356909" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/Tokeiya" class="css-10ougpm">@<!-- -->Tokeiya</a><div class="css-1ay9vb9"><span><meta content="2018-02-19T13:00:06Z"/><time dateTime="2018-04-27T00:15:16Z" class="css-m19uds">updated at 2018-04-27</time></span></div></div></div></div></div><h1 class="css-cgzq40">List&lt;T&gt;に対するforとforeachとForEachのアクセス速度のホントの所</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="tldr" class="fragment"></span><a href="#tldr"><i class="fa fa-link"></i></a>TL;DR</h1>

<p><a href="https://qiita.com/130cmWolf/items/0a4ecaa92d0ef82d7c7a" id="reference-198c452acd09c7803a76">forとforeachのアクセス速度比較</a>を見てて､<strong>完全に間違った結論</strong>に達していたからなんとなく､ホントの所を書いておこうかなって｡<br>
最初コメントを書こうかと思ったのだけど､思いのほか書くことが増えたので別のエントリとさせて頂いた次第｡その辺ご了承の程｡<br>
また､ここでは処理効率だけを検証し､書き方としていずれかが望ましいのかという視点はこのエントリでは持っていないので､合わせてご理解頂ければこれ幸い。</p>

<p>で､先に結論だけ言うと､単純にアクセスコストだけ比較すれば<strong>forの方がforeach使うより190%程度速いよ!</strong></p>

<p>あと､蛇足だけど､<strong>ForEachメソッドは<del>CoreではOmitされる程度に使えないし</del><sup id="fnref1"><a href="#fn1" title="記載当時のCore2.1Previewは持ってなかったんだけど、復活してたw">1</a></sup>､<a href="https://qiita.com/chocolamint/items/d29d699ce27bcf685154" id="reference-7184e48b4ece07430f4e">使うとやう゛ぁいシナリオ</a>があるから使うべきじゃないよ!</strong></p>

<p>実行環境は<code>.Net Framework 4.7</code>の64bit､使ったライブラリは安心と信頼の<a href="https://qiita.com/NetSeed/items/30d8a76163622a4b5be1" id="reference-a6c4c4530d79912da56b">BenchMarkDotNet</a>を使った｡また､特に断りが無い限り､デバッガアタッチ無しのReleaseビルドで実行している｡<sup id="fnref2"><a href="#fn2" title="本当は､Coreの方使いたかったが､ListのForEachメソッドがOmitされていたので､Frameworkを使うこととした｡こー言うことがあるので､まーOmitされてしかるべきだと思う｡">2</a></sup></p>

<h1>
<span id="どこがマズいのか" class="fragment"></span><a href="#%E3%81%A9%E3%81%93%E3%81%8C%E3%83%9E%E3%82%BA%E3%81%84%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>どこがマズいのか</h1>

<h2>
<span id="画面バッファの状態と実行効率" class="fragment"></span><a href="#%E7%94%BB%E9%9D%A2%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%81%AE%E7%8A%B6%E6%85%8B%E3%81%A8%E5%AE%9F%E8%A1%8C%E5%8A%B9%E7%8E%87"><i class="fa fa-link"></i></a>画面バッファの状態と実行効率</h2>

<p>さて､先のテストではIterationの中身をコンソールへの書き出しとしていた｡<br>
これが実はとんでもなくマズくて､実はコンソールの状態によって書き込みに対する効率が大きく変わる｡<br>
実際に試したのが以下</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">IterationSurvey</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">iterationSize</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">first</span> <span class="p">=</span> <span class="nf">ConsoleWriteTest</span><span class="p">(</span><span class="n">iterationSize</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">second</span> <span class="p">=</span> <span class="nf">ConsoleWriteTest</span><span class="p">(</span><span class="n">iterationSize</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"first:</span><span class="p">{</span><span class="n">first</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"second:</span><span class="p">{</span><span class="n">second</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="n">TimeSpan</span> <span class="nf">ConsoleWriteTest</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">GC</span><span class="p">.</span><span class="nf">Collect</span><span class="p">();</span>
            <span class="n">GC</span><span class="p">.</span><span class="nf">WaitForPendingFinalizers</span><span class="p">();</span>
            <span class="n">GC</span><span class="p">.</span><span class="nf">Collect</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">chrono</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Stopwatch</span><span class="p">();</span>

            <span class="n">chrono</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

            <span class="n">chrono</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>

            <span class="k">return</span> <span class="n">chrono</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>上記テストコードの実行結果は</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>first:4928.8788
second:2797.899
</code></pre></div></div>

<p>となり､全く同様の処理をしているにも拘わらず､その完了までにかかった時間が2.1秒も違うという結果が出てくる｡</p>

<p>このような差異が出てくる理由を､コンソールの画面バッファが空で､新たにバッファに追記しながら出力が実行された場合と､すでに画面バッファが一杯であり､追記ではなく､古い行を消去しながら出力する場合では､大きな差が出ているのではと仮定した｡</p>

<p>この仮定の下に､以下のように書き換えてみた｡</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">iterationSize</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">first</span> <span class="p">=</span> <span class="nf">ConsoleWriteTest</span><span class="p">(</span><span class="n">iterationSize</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>    
    <span class="kt">var</span> <span class="n">second</span> <span class="p">=</span> <span class="nf">ConsoleWriteTest</span><span class="p">(</span><span class="n">iterationSize</span><span class="p">);</span>

    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"first:</span><span class="p">{</span><span class="n">first</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"second:</span><span class="p">{</span><span class="n">second</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>上記テストコードの実行結果は</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>first:5027.1656
second:4934.7282
</code></pre></div></div>

<p>となり､当初約2.1秒有った差が､93msと激減している｡</p>

<h2>
<span id="リストに参照型を使うと言うこと" class="fragment"></span><a href="#%E3%83%AA%E3%82%B9%E3%83%88%E3%81%AB%E5%8F%82%E7%85%A7%E5%9E%8B%E3%82%92%E4%BD%BF%E3%81%86%E3%81%A8%E8%A8%80%E3%81%86%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>リストに参照型を使うと言うこと</h2>

<p><code>List&lt;T&gt;</code>に対する､Primitiveなアクセス効率を計測しようとしたとき､文字列型を使うのは少々問題がある｡<br>
極めて素朴に考えた場合､C#におけるstringは参照型であり､Listの中身は参照情報､有り体に言ってしまえば文字列実体へのポインタが格納されていることになる｡<sup id="fnref3"><a href="#fn3" title='実際は""への参照なので､文字列はインターニングされるのと､恐らくインスタンスはCPUのキャッシュに乗っかるので､こんな単純な話にはならない｡'>3</a></sup></p>

<p>そして､文字列にアクセスすると言うことは､</p>

<ol>
<li>配列の参照へのアクセス</li>
<li>文字列実体へのデリファレンス</li>
</ol>

<p>という2ステップを取ることになる｡</p>

<p>これは､実際計測しようとしている部分に計測するには邪魔な処理が挟まってしまっていることになり､好ましくはないので､このような場合､<code>int</code>などのPrimitive型を使うべきだろう｡<sup id="fnref4"><a href="#fn4" title="あくまで今回の目的に限定した結論であると言うことで一つ｡">4</a></sup></p>

<h2>
<span id="ループ内方でconsolewritelineを行うと言うこと" class="fragment"></span><a href="#%E3%83%AB%E3%83%BC%E3%83%97%E5%86%85%E6%96%B9%E3%81%A7consolewriteline%E3%82%92%E8%A1%8C%E3%81%86%E3%81%A8%E8%A8%80%E3%81%86%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>ループ内方でConsole.WriteLineを行うと言うこと｡</h2>

<p>現在､比較しようとしていることは､リストに対する各々のIterationの実行効率に差異があるかないか､有るとすればどの程度なのかと言うことであり､<br>
ループ内の処理は素朴に考えれば必要ない｡</p>

<p>また､<code>Console.WriteLine</code>は結構重い処理かつ､先に述べたとおり､全く関係の無い場所で条件により実行効率が大きく変わるので､ループ内の処理としては適当ではないと言える｡<br>
で、重い処理というのは字義通り処理に時間もリソースも食う。結果それは先のように、外部に起因する処理効率の差異を生み出しやすく、また処理に時間がかかると言うことはそれだけばらつきも発生することから、本当に欲しかった結果をマスクしてしまう可能性が非常に高い。</p>

<p>それ故、ループ内にこのような処理を挟むのは極めて不適切である。</p>

<h2>
<span id="その他考慮すべきコト" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E8%80%83%E6%85%AE%E3%81%99%E3%81%B9%E3%81%8D%E3%82%B3%E3%83%88"><i class="fa fa-link"></i></a>その他考慮すべきコト</h2>

<p>実際､このほかにもJITにかかる時間をどのように除去するか､とかManagedHeapの容量がリサイズされて安定させるにはどうすれば良いのかなど､結構面倒な考慮事項は多い｡<br>
ただ､この辺は<code>BenchMarkDotNet</code>を使うことで､相当緩和可能なことから､割愛することにした｡</p>

<h1>
<span id="この辺考えて処理効率を改めて検証する" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%BE%BA%E8%80%83%E3%81%88%E3%81%A6%E5%87%A6%E7%90%86%E5%8A%B9%E7%8E%87%E3%82%92%E6%94%B9%E3%82%81%E3%81%A6%E6%A4%9C%E8%A8%BC%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>この辺考えて処理効率を改めて検証する</h1>

<p>以上のように､なぜマズいのかと言うことを検証してみた｡<br>
それでは実際に､これまでの検証を踏まえた上で処理効率を計ってみたい｡</p>

<p>実験用のコードは以下のようにした｡</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">BenchmarkDotNet.Attributes</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">BenchmarkDotNet.Running</span><span class="p">;</span>


<span class="k">namespace</span> <span class="nn">IterationSurvey</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">IterationBenchmark</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">TargetList</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">100000</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>

        <span class="p">[</span><span class="n">Benchmark</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="nf">UseFor</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">accum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">TargetList</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="n">accum</span> <span class="p">+=</span> <span class="n">TargetList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

            <span class="k">return</span> <span class="n">accum</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">Benchmark</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="nf">UseExtForEach</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">accum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="k">in</span> <span class="n">TargetList</span><span class="p">)</span> <span class="n">accum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">accum</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="p">[</span><span class="n">Benchmark</span><span class="p">]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="nf">UseIntForEach</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">accum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="n">TargetList</span><span class="p">.</span><span class="nf">ForEach</span><span class="p">(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="n">accum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">accum</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>



    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BenchmarkRunner</span><span class="p">.</span><span class="n">Run</span><span class="p">&lt;</span><span class="n">IterationBenchmark</span><span class="p">&gt;();</span>

        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>ループ内では､uncheckで加算している｡<br>
これは､検証する際に､同じコトをしているか否かの簡易的なチェックをするために行った｡<sup id="fnref5"><a href="#fn5" title="実際の所､foreachはともかくforはこーでもしないと最適化されてループが除去されるかと思ったけど､どーもそうでもないみたい｡この辺参照">5</a></sup></p>

<p>で､出てきた結果が以下</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>
BenchmarkDotNet=v0.10.12, OS=Windows 10 Redstone 3 [1709, Fall Creators Update] (10.0.16299.248)
Intel Core i7-3770K CPU 3.50GHz (Ivy Bridge), 1 CPU, 8 logical cores and 4 physical cores
Frequency=3410222 Hz, Resolution=293.2360 ns, Timer=TSC
  [Host]     : .NET Framework 4.7 (CLR 4.0.30319.42000), 64bit RyuJIT-v4.7.2633.0
  DefaultJob : .NET Framework 4.7 (CLR 4.0.30319.42000), 64bit RyuJIT-v4.7.2633.0


</code></pre></div></div>

<table>
<thead>
<tr>
<th>Method</th>
<th style="text-align: right">Mean</th>
<th style="text-align: right">Error</th>
<th style="text-align: right">StdDev</th>
</tr>
</thead>
<tbody>
<tr>
<td>UseFor</td>
<td style="text-align: right">117.7 us</td>
<td style="text-align: right">0.4220 us</td>
<td style="text-align: right">0.3948 us</td>
</tr>
<tr>
<td>UseExtForEach</td>
<td style="text-align: right">229.9 us</td>
<td style="text-align: right">0.7188 us</td>
<td style="text-align: right">0.6724 us</td>
</tr>
<tr>
<td>UseIntForEach</td>
<td style="text-align: right">378.8 us</td>
<td style="text-align: right">0.6833 us</td>
<td style="text-align: right">0.6392 us</td>
</tr>
</tbody>
</table>

<p>このように､全く違う結果が出てくる｡</p>

<h1>
<span id="なぜforeachが遅いのかまとめに変えて" class="fragment"></span><a href="#%E3%81%AA%E3%81%9Cforeach%E3%81%8C%E9%81%85%E3%81%84%E3%81%AE%E3%81%8B%E3%81%BE%E3%81%A8%E3%82%81%E3%81%AB%E5%A4%89%E3%81%88%E3%81%A6"><i class="fa fa-link"></i></a>なぜforeachが遅いのか?　~まとめに変えて~</h1>

<p>結論として､forが一番早く､ついforeach､最後にForEachと言う結果になった｡<br>
なぜforeachはforに勝てなかったかというと､foreachは内部で､<code>GetEnumerator</code>を呼び出し､<code>Enumerator</code>を取得している｡<br>
通常の場合､EnumeratorはIEnumeratorとなり､参照型なのだけど､Listの場合､マネージヒープを汚さないためとアロケーションコストを払わないようにするため､foreachを普通に使うのなら､<a href="https://referencesource.microsoft.com/#mscorlib/system/collections/generic/list.cs,9c3d580a8b7a8fe8,references" rel="nofollow noopener" target="_blank">List.Enumerator</a>構造体を使う｡<br>
このように､最適化は掛かってるのだけど､Enumeratorの内部では､Enumerator作成後に元のリストに変更がなかったかのチェック､Currentへの代入など､余計なコストがどうしても発生することになる｡</p>

<p>この辺がforループに勝てない理由じゃないかなと思う｡</p>

<p>また､ForEachによる内部イテレータは<code>action</code>がCount回呼ばれるのでその呼び出しオーバーヘッドが効いてるのだと思う｡</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>記載当時のCore2.1Previewは持ってなかったんだけど、復活してたw <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p>本当は､Coreの方使いたかったが､ListのForEachメソッドがOmitされていたので､Frameworkを使うこととした｡<a href="https://qiita.com/chocolamint/items/d29d699ce27bcf685154">こー言うこと</a>があるので､まーOmitされてしかるべきだと思う｡ <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p>実際は""への参照なので､文字列はインターニングされるのと､恐らくインスタンスはCPUのキャッシュに乗っかるので､こんな単純な話にはならない｡ <a href="#fnref3">↩</a></p>
</li>

<li id="fn4">
<p>あくまで今回の目的に限定した結論であると言うことで一つ｡ <a href="#fnref4">↩</a></p>
</li>

<li id="fn5">
<p>実際の所､foreachはともかくforはこーでもしないと最適化されてループが除去されるかと思ったけど､どーもそうでもないみたい｡<a href="https://sharplab.io/#v2:EYLgtghgzgLgpgJwDQxNMAfAAgBgARYCMA3ALABQuBhAdADICWAdgI5nkVYDMBATHgGE8AbwoBIMQAcEDAG4R41AGwEALNQAcACiI4A2gF08EBAHMoASnFjR5CWPkI8AGwaw8AXjwBRJgFcwRAhgZzgaACUIJlM4LRwkPEIcCxoAFQB7RlgtC3ZrMQAzdKctZhg8Bk88HGIKvAAeFzcYGgF0vyYYWoYAah6rOwlbewcTCsqvV1g9BgN2ewBfayWOQek5BThlNTwAZQgwSVCAQRzrYYlHJvcvXwCgkLDI6Nj4xOS0zOac+YkihDgEAAxgALPBaK6VZjXGAWPB5QYrBZAA" rel="nofollow noopener" target="_blank">この辺参照</a> <a href="#fnref5">↩</a></p>
</li>

</ol>
</div>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FTokeiya%2Fitems%2Fde46281e7cf071db3336&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FTokeiya%2Fitems%2Fde46281e7cf071db3336&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Tokeiya/items/de46281e7cf071db3336/likers" class="css-1iupg5d">32</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">31</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/de46281e7cf071db3336/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Tokeiya/items/de46281e7cf071db3336/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Tokeiya/items/de46281e7cf071db3336/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Tokeiya/items/de46281e7cf071db3336/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Tokeiya/items/de46281e7cf071db3336.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-c5d71cb8-ebc4-44ff-a99f-e9991cec87ef">{"authorAnalyticsTrackingId":"UA-43167593-1","organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-d14f882c-7510-4ff1-bd43-15f4d51eace7"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-d14f882c-7510-4ff1-bd43-15f4d51eace7">{}</script>
      
<div id="LoginModal-react-component-80e87408-2c75-4e3c-be9f-44239da08cb5"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-80e87408-2c75-4e3c-be9f-44239da08cb5">{}</script>
      
<div id="StockModal-react-component-e812fba4-4dc8-4fcb-9ac1-01fa7446c1d8"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-e812fba4-4dc8-4fcb-9ac1-01fa7446c1d8">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;0I4eIlvbbCs/BL++Ar6cvspp68m9npqrEhtDqIhix8XgNPoHLHQIU4XB+rljzlsqzFl09+U+rYcPyvfGn2kvHw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"tldr\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#tldr\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTL;DR\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/130cmWolf/items/0a4ecaa92d0ef82d7c7a\" id=\"reference-198c452acd09c7803a76\"\u003eforとforeachのアクセス速度比較\u003c/a\u003eを見てて､\u003cstrong\u003e完全に間違った結論\u003c/strong\u003eに達していたからなんとなく､ホントの所を書いておこうかなって｡\u003cbr\u003e\n最初コメントを書こうかと思ったのだけど､思いのほか書くことが増えたので別のエントリとさせて頂いた次第｡その辺ご了承の程｡\u003cbr\u003e\nまた､ここでは処理効率だけを検証し､書き方としていずれかが望ましいのかという視点はこのエントリでは持っていないので､合わせてご理解頂ければこれ幸い。\u003c/p\u003e\n\n\u003cp\u003eで､先に結論だけ言うと､単純にアクセスコストだけ比較すれば\u003cstrong\u003eforの方がforeach使うより190%程度速いよ!\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eあと､蛇足だけど､\u003cstrong\u003eForEachメソッドは\u003cdel\u003eCoreではOmitされる程度に使えないし\u003c/del\u003e\u003csup id=\"fnref1\"\u003e\u003ca href=\"#fn1\" title=\"記載当時のCore2.1Previewは持ってなかったんだけど、復活してたw\"\u003e1\u003c/a\u003e\u003c/sup\u003e､\u003ca href=\"https://qiita.com/chocolamint/items/d29d699ce27bcf685154\" id=\"reference-7184e48b4ece07430f4e\"\u003e使うとやう゛ぁいシナリオ\u003c/a\u003eがあるから使うべきじゃないよ!\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e実行環境は\u003ccode\u003e.Net Framework 4.7\u003c/code\u003eの64bit､使ったライブラリは安心と信頼の\u003ca href=\"https://qiita.com/NetSeed/items/30d8a76163622a4b5be1\" id=\"reference-a6c4c4530d79912da56b\"\u003eBenchMarkDotNet\u003c/a\u003eを使った｡また､特に断りが無い限り､デバッガアタッチ無しのReleaseビルドで実行している｡\u003csup id=\"fnref2\"\u003e\u003ca href=\"#fn2\" title=\"本当は､Coreの方使いたかったが､ListのForEachメソッドがOmitされていたので､Frameworkを使うこととした｡こー言うことがあるので､まーOmitされてしかるべきだと思う｡\"\u003e2\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"どこがマズいのか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%A9%E3%81%93%E3%81%8C%E3%83%9E%E3%82%BA%E3%81%84%E3%81%AE%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eどこがマズいのか\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"画面バッファの状態と実行効率\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%94%BB%E9%9D%A2%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%81%AE%E7%8A%B6%E6%85%8B%E3%81%A8%E5%AE%9F%E8%A1%8C%E5%8A%B9%E7%8E%87\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e画面バッファの状態と実行効率\u003c/h2\u003e\n\n\u003cp\u003eさて､先のテストではIterationの中身をコンソールへの書き出しとしていた｡\u003cbr\u003e\nこれが実はとんでもなくマズくて､実はコンソールの状態によって書き込みに対する効率が大きく変わる｡\u003cbr\u003e\n実際に試したのが以下\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Diagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eIterationSurvey\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eiterationSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e100000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efirst\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eConsoleWriteTest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiterationSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecond\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eConsoleWriteTest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiterationSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"first:\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003efirst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTotalMilliseconds\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"second:\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003esecond\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTotalMilliseconds\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e \u003cspan class=\"nf\"\u003eConsoleWriteTest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCollect\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitForPendingFinalizers\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCollect\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003echrono\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003echrono\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003echrono\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003echrono\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsed\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e上記テストコードの実行結果は\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003efirst:4928.8788\nsecond:2797.899\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとなり､全く同様の処理をしているにも拘わらず､その完了までにかかった時間が2.1秒も違うという結果が出てくる｡\u003c/p\u003e\n\n\u003cp\u003eこのような差異が出てくる理由を､コンソールの画面バッファが空で､新たにバッファに追記しながら出力が実行された場合と､すでに画面バッファが一杯であり､追記ではなく､古い行を消去しながら出力する場合では､大きな差が出ているのではと仮定した｡\u003c/p\u003e\n\n\u003cp\u003eこの仮定の下に､以下のように書き換えてみた｡\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eiterationSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e100000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efirst\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eConsoleWriteTest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiterationSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e    \n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecond\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eConsoleWriteTest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiterationSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"first:\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003efirst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTotalMilliseconds\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"second:\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003esecond\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTotalMilliseconds\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e上記テストコードの実行結果は\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003efirst:5027.1656\nsecond:4934.7282\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとなり､当初約2.1秒有った差が､93msと激減している｡\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"リストに参照型を使うと言うこと\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%AA%E3%82%B9%E3%83%88%E3%81%AB%E5%8F%82%E7%85%A7%E5%9E%8B%E3%82%92%E4%BD%BF%E3%81%86%E3%81%A8%E8%A8%80%E3%81%86%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eリストに参照型を使うと言うこと\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eList\u0026lt;T\u0026gt;\u003c/code\u003eに対する､Primitiveなアクセス効率を計測しようとしたとき､文字列型を使うのは少々問題がある｡\u003cbr\u003e\n極めて素朴に考えた場合､C#におけるstringは参照型であり､Listの中身は参照情報､有り体に言ってしまえば文字列実体へのポインタが格納されていることになる｡\u003csup id=\"fnref3\"\u003e\u003ca href=\"#fn3\" title='実際は\"\"への参照なので､文字列はインターニングされるのと､恐らくインスタンスはCPUのキャッシュに乗っかるので､こんな単純な話にはならない｡'\u003e3\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\n\u003cp\u003eそして､文字列にアクセスすると言うことは､\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e配列の参照へのアクセス\u003c/li\u003e\n\u003cli\u003e文字列実体へのデリファレンス\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eという2ステップを取ることになる｡\u003c/p\u003e\n\n\u003cp\u003eこれは､実際計測しようとしている部分に計測するには邪魔な処理が挟まってしまっていることになり､好ましくはないので､このような場合､\u003ccode\u003eint\u003c/code\u003eなどのPrimitive型を使うべきだろう｡\u003csup id=\"fnref4\"\u003e\u003ca href=\"#fn4\" title=\"あくまで今回の目的に限定した結論であると言うことで一つ｡\"\u003e4\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ループ内方でconsolewritelineを行うと言うこと\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%AB%E3%83%BC%E3%83%97%E5%86%85%E6%96%B9%E3%81%A7consolewriteline%E3%82%92%E8%A1%8C%E3%81%86%E3%81%A8%E8%A8%80%E3%81%86%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eループ内方でConsole.WriteLineを行うと言うこと｡\u003c/h2\u003e\n\n\u003cp\u003e現在､比較しようとしていることは､リストに対する各々のIterationの実行効率に差異があるかないか､有るとすればどの程度なのかと言うことであり､\u003cbr\u003e\nループ内の処理は素朴に考えれば必要ない｡\u003c/p\u003e\n\n\u003cp\u003eまた､\u003ccode\u003eConsole.WriteLine\u003c/code\u003eは結構重い処理かつ､先に述べたとおり､全く関係の無い場所で条件により実行効率が大きく変わるので､ループ内の処理としては適当ではないと言える｡\u003cbr\u003e\nで、重い処理というのは字義通り処理に時間もリソースも食う。結果それは先のように、外部に起因する処理効率の差異を生み出しやすく、また処理に時間がかかると言うことはそれだけばらつきも発生することから、本当に欲しかった結果をマスクしてしまう可能性が非常に高い。\u003c/p\u003e\n\n\u003cp\u003eそれ故、ループ内にこのような処理を挟むのは極めて不適切である。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"その他考慮すべきコト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E8%80%83%E6%85%AE%E3%81%99%E3%81%B9%E3%81%8D%E3%82%B3%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eその他考慮すべきコト\u003c/h2\u003e\n\n\u003cp\u003e実際､このほかにもJITにかかる時間をどのように除去するか､とかManagedHeapの容量がリサイズされて安定させるにはどうすれば良いのかなど､結構面倒な考慮事項は多い｡\u003cbr\u003e\nただ､この辺は\u003ccode\u003eBenchMarkDotNet\u003c/code\u003eを使うことで､相当緩和可能なことから､割愛することにした｡\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"この辺考えて処理効率を改めて検証する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%81%AE%E8%BE%BA%E8%80%83%E3%81%88%E3%81%A6%E5%87%A6%E7%90%86%E5%8A%B9%E7%8E%87%E3%82%92%E6%94%B9%E3%82%81%E3%81%A6%E6%A4%9C%E8%A8%BC%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこの辺考えて処理効率を改めて検証する\u003c/h1\u003e\n\n\u003cp\u003e以上のように､なぜマズいのかと言うことを検証してみた｡\u003cbr\u003e\nそれでは実際に､これまでの検証を踏まえた上で処理効率を計ってみたい｡\u003c/p\u003e\n\n\u003cp\u003e実験用のコードは以下のようにした｡\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Linq\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eBenchmarkDotNet.Attributes\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eBenchmarkDotNet.Running\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eIterationSurvey\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eIterationBenchmark\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eTargetList\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e100000\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eBenchmark\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eUseFor\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eaccum\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eTargetList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \u003cspan class=\"n\"\u003eaccum\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003eTargetList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eaccum\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eBenchmark\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eUseExtForEach\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eaccum\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eTargetList\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eaccum\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eaccum\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eBenchmark\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eUseIntForEach\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eaccum\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eTargetList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eForEach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eaccum\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eaccum\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eBenchmarkRunner\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIterationBenchmark\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eループ内では､uncheckで加算している｡\u003cbr\u003e\nこれは､検証する際に､同じコトをしているか否かの簡易的なチェックをするために行った｡\u003csup id=\"fnref5\"\u003e\u003ca href=\"#fn5\" title=\"実際の所､foreachはともかくforはこーでもしないと最適化されてループが除去されるかと思ったけど､どーもそうでもないみたい｡この辺参照\"\u003e5\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\n\u003cp\u003eで､出てきた結果が以下\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\nBenchmarkDotNet=v0.10.12, OS=Windows 10 Redstone 3 [1709, Fall Creators Update] (10.0.16299.248)\nIntel Core i7-3770K CPU 3.50GHz (Ivy Bridge), 1 CPU, 8 logical cores and 4 physical cores\nFrequency=3410222 Hz, Resolution=293.2360 ns, Timer=TSC\n  [Host]     : .NET Framework 4.7 (CLR 4.0.30319.42000), 64bit RyuJIT-v4.7.2633.0\n  DefaultJob : .NET Framework 4.7 (CLR 4.0.30319.42000), 64bit RyuJIT-v4.7.2633.0\n\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eMethod\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003eMean\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003eError\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003eStdDev\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eUseFor\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e117.7 us\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.4220 us\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.3948 us\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eUseExtForEach\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e229.9 us\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.7188 us\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.6724 us\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eUseIntForEach\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e378.8 us\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.6833 us\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.6392 us\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eこのように､全く違う結果が出てくる｡\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"なぜforeachが遅いのかまとめに変えて\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AA%E3%81%9Cforeach%E3%81%8C%E9%81%85%E3%81%84%E3%81%AE%E3%81%8B%E3%81%BE%E3%81%A8%E3%82%81%E3%81%AB%E5%A4%89%E3%81%88%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eなぜforeachが遅いのか?　~まとめに変えて~\u003c/h1\u003e\n\n\u003cp\u003e結論として､forが一番早く､ついforeach､最後にForEachと言う結果になった｡\u003cbr\u003e\nなぜforeachはforに勝てなかったかというと､foreachは内部で､\u003ccode\u003eGetEnumerator\u003c/code\u003eを呼び出し､\u003ccode\u003eEnumerator\u003c/code\u003eを取得している｡\u003cbr\u003e\n通常の場合､EnumeratorはIEnumeratorとなり､参照型なのだけど､Listの場合､マネージヒープを汚さないためとアロケーションコストを払わないようにするため､foreachを普通に使うのなら､\u003ca href=\"https://referencesource.microsoft.com/#mscorlib/system/collections/generic/list.cs,9c3d580a8b7a8fe8,references\" rel=\"nofollow noopener\" target=\"_blank\"\u003eList.Enumerator\u003c/a\u003e構造体を使う｡\u003cbr\u003e\nこのように､最適化は掛かってるのだけど､Enumeratorの内部では､Enumerator作成後に元のリストに変更がなかったかのチェック､Currentへの代入など､余計なコストがどうしても発生することになる｡\u003c/p\u003e\n\n\u003cp\u003eこの辺がforループに勝てない理由じゃないかなと思う｡\u003c/p\u003e\n\n\u003cp\u003eまた､ForEachによる内部イテレータは\u003ccode\u003eaction\u003c/code\u003eがCount回呼ばれるのでその呼び出しオーバーヘッドが効いてるのだと思う｡\u003c/p\u003e\n\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\n\u003cli id=\"fn1\"\u003e\n\u003cp\u003e記載当時のCore2.1Previewは持ってなかったんだけど、復活してたw \u003ca href=\"#fnref1\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn2\"\u003e\n\u003cp\u003e本当は､Coreの方使いたかったが､ListのForEachメソッドがOmitされていたので､Frameworkを使うこととした｡\u003ca href=\"https://qiita.com/chocolamint/items/d29d699ce27bcf685154\"\u003eこー言うこと\u003c/a\u003eがあるので､まーOmitされてしかるべきだと思う｡ \u003ca href=\"#fnref2\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn3\"\u003e\n\u003cp\u003e実際は\"\"への参照なので､文字列はインターニングされるのと､恐らくインスタンスはCPUのキャッシュに乗っかるので､こんな単純な話にはならない｡ \u003ca href=\"#fnref3\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn4\"\u003e\n\u003cp\u003eあくまで今回の目的に限定した結論であると言うことで一つ｡ \u003ca href=\"#fnref4\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn5\"\u003e\n\u003cp\u003e実際の所､foreachはともかくforはこーでもしないと最適化されてループが除去されるかと思ったけど､どーもそうでもないみたい｡\u003ca href=\"https://sharplab.io/#v2:EYLgtghgzgLgpgJwDQxNMAfAAgBgARYCMA3ALABQuBhAdADICWAdgI5nkVYDMBATHgGE8AbwoBIMQAcEDAG4R41AGwEALNQAcACiI4A2gF08EBAHMoASnFjR5CWPkI8AGwaw8AXjwBRJgFcwRAhgZzgaACUIJlM4LRwkPEIcCxoAFQB7RlgtC3ZrMQAzdKctZhg8Bk88HGIKvAAeFzcYGgF0vyYYWoYAah6rOwlbewcTCsqvV1g9BgN2ewBfayWOQek5BThlNTwAZQgwSVCAQRzrYYlHJvcvXwCgkLDI6Nj4xOS0zOac+YkihDgEAAxgALPBaK6VZjXGAWPB5QYrBZAA\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこの辺参照\u003c/a\u003e \u003ca href=\"#fnref5\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003c/ol\u003e\n\u003c/div\u003e\n","createdAt":"2018-02-19T13:00:06Z","elapsedYearsFromLastModifiedAt":3,"encryptedId":"73STYEKJBn9Ps3p8BkuERxf9HafB7joz--Ar0YLpaV1En54i95--t4W+WfZmGxPwtiFcLFlA6Q==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2018-04-27T00:15:16Z","likesCount":32,"linkUrl":"https://qiita.com/Tokeiya/items/de46281e7cf071db3336","organization":null,"originalId":611377,"stockedCount":31,"title":"List\u003cT\u003eに対するforとforeachとForEachのアクセス速度のホントの所","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#tldr\"\u003eTL;DR\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%A9%E3%81%93%E3%81%8C%E3%83%9E%E3%82%BA%E3%81%84%E3%81%AE%E3%81%8B\"\u003eどこがマズいのか\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%94%BB%E9%9D%A2%E3%83%90%E3%83%83%E3%83%95%E3%82%A1%E3%81%AE%E7%8A%B6%E6%85%8B%E3%81%A8%E5%AE%9F%E8%A1%8C%E5%8A%B9%E7%8E%87\"\u003e画面バッファの状態と実行効率\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%AA%E3%82%B9%E3%83%88%E3%81%AB%E5%8F%82%E7%85%A7%E5%9E%8B%E3%82%92%E4%BD%BF%E3%81%86%E3%81%A8%E8%A8%80%E3%81%86%E3%81%93%E3%81%A8\"\u003eリストに参照型を使うと言うこと\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%AB%E3%83%BC%E3%83%97%E5%86%85%E6%96%B9%E3%81%A7consolewriteline%E3%82%92%E8%A1%8C%E3%81%86%E3%81%A8%E8%A8%80%E3%81%86%E3%81%93%E3%81%A8\"\u003eループ内方でConsole.WriteLineを行うと言うこと｡\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E8%80%83%E6%85%AE%E3%81%99%E3%81%B9%E3%81%8D%E3%82%B3%E3%83%88\"\u003eその他考慮すべきコト\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%81%AE%E8%BE%BA%E8%80%83%E3%81%88%E3%81%A6%E5%87%A6%E7%90%86%E5%8A%B9%E7%8E%87%E3%82%92%E6%94%B9%E3%82%81%E3%81%A6%E6%A4%9C%E8%A8%BC%E3%81%99%E3%82%8B\"\u003eこの辺考えて処理効率を改めて検証する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AA%E3%81%9Cforeach%E3%81%8C%E9%81%85%E3%81%84%E3%81%AE%E3%81%8B%E3%81%BE%E3%81%A8%E3%82%81%E3%81%AB%E5%A4%89%E3%81%88%E3%81%A6\"\u003eなぜforeachが遅いのか?　~まとめに変えて~\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":16143,"uuid":"de46281e7cf071db3336","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"HL0grXLClq4eWQ5krYXi8lnbLw==--8ivF9CAqlsX4K5n4--iLTk18WS+v9aNt4L13Ytkw==","originalId":9662,"description":"C#ｽｺｼﾜｶﾙ","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"時計屋","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/9662/profile-images/1554356909","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F9662%2Fprofile-images%2F1554356909?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=6118229f89414a4b5c485868f98b7eba","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F9662%2Fprofile-images%2F1554356909?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=b571a856c59b74012dbee483be67170a","urlName":"Tokeiya","websiteUrl":"","twitterUrl":"https://twitter.com/NetSeed","twitterUrlName":"NetSeed","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"}],"followingLikers":{"edges":[]},"comments":{"totalCount":4}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
