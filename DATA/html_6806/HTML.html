<!DOCTYPE html><html><head><meta charset="utf-8" /><title>ASP.NET CoreアプリのDependency Injection処理を別のDIコンテナに委譲する(完全版) - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/yamaokunousausa/items/bc81d8498ecf62da0208" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="JFB2S8SFyz8bg1GJblXS4Va7xTnVi4Wv7A7NtZbz3HVrjzV783u9sMJC/Rpiu4lHz3Bd7Toq3n72FkHOju6e9w==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@yamaokunousausa" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="ASP.NET CoreアプリのDependency Injection処理を別のDIコンテナに委譲する(完全版) - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RVk5RTGs1RlZDQkRiM0psNDRLaTQ0T1g0NE9xNDRHdVJHVndaVzVrWlc1amVTQkpibXBsWTNScGIyN2xoNmJua0liamdwTGxpS1hqZ2E1RVNlT0NzLU9Ecy1PRGh1T0RpdU9CcS1XbmxPaXRzdU9CbWVPQ2l5amxyb3psaGFqbmlZZ3AmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9Y2EyZDFmYTE5NGRjMzk5YzM0MzU2NGRhZjhlZjNkOTM&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSGxoYldGdmEzVnViM1Z6WVhWellRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9MzI5M2IyNGNhMjQ0Yjc4OTk5MmQ0N2UwODdjYjcxNjI&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=ea319202f935892fe45b5385d8369f39"><meta property="og:description" content="

やること

独自のDependency ResolverとASP.NET Coreを連携させる方法の完全版です。

以前の記事ではIControllerActivatorを使用したコントローラーに対するDIの連携を実装しましたが、..."><meta content="https://qiita.com/yamaokunousausa/items/bc81d8498ecf62da0208" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,.NET,DependencyInjection,.NETCore,ASP.NET_Core" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-0e5025eb-d2fb-4339-a23f-9ab4ca9db0d4"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fyamaokunousausa%2Fitems%2Fbc81d8498ecf62da0208">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fyamaokunousausa%2Fitems%2Fbc81d8498ecf62da0208">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-0e5025eb-d2fb-4339-a23f-9ab4ca9db0d4">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2016-12-07T14:11:32.000+09:00","dateModified":"2016-12-07T14:24:09.000+09:00","headline":"ASP.NET CoreアプリのDependency Injection処理を別のDIコンテナに委譲する(完全版)","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RVk5RTGs1RlZDQkRiM0psNDRLaTQ0T1g0NE9xNDRHdVJHVndaVzVrWlc1amVTQkpibXBsWTNScGIyN2xoNmJua0liamdwTGxpS1hqZ2E1RVNlT0NzLU9Ecy1PRGh1T0RpdU9CcS1XbmxPaXRzdU9CbWVPQ2l5amxyb3psaGFqbmlZZ3AmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9Y2EyZDFmYTE5NGRjMzk5YzM0MzU2NGRhZjhlZjNkOTM\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSGxoYldGdmEzVnViM1Z6WVhWellRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9MzI5M2IyNGNhMjQ0Yjc4OTk5MmQ0N2UwODdjYjcxNjI\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=ea319202f935892fe45b5385d8369f39","mainEntityOfPage":"https://qiita.com/yamaokunousausa/items/bc81d8498ecf62da0208","author":{"@type":"Person","address":"山梨 落ちなし 意味深長","email":"machi.pon@gmail.com","identifier":"yamaokunousausa","name":"yamaokunousausa","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F9645%2Fprofile-images%2F1569302036?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=7b37b0fc5de942529e157bef86c17942","url":"https://qiita.com/yamaokunousausa","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"yamaokunousausa","type":"items","id":"bc81d8498ecf62da0208"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"yamaokunousausa","type":"items","id":"bc81d8498ecf62da0208"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"yamaokunousausa","type":"items","id":"bc81d8498ecf62da0208"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/yamaokunousausa/items/bc81d8498ecf62da0208","location":"/yamaokunousausa/items/bc81d8498ecf62da0208","scheme":"https","host":"qiita.com","port":null,"pathname":"/yamaokunousausa/items/bc81d8498ecf62da0208","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"lid+lB6t6u6acghCWcHlpkV9x0FFRJKMEANOQoGVYyTZ+D2kKVOcYUOzpNFVL74A3LZflarlyV0KG8I5mYghpg==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-53ec63a7-4ca3-4cb2-94a0-c9bc93157b89"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/yamaokunousausa/items/bc81d8498ecf62da0208/likers" class="css-1iupg5d">15</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">21</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/bc81d8498ecf62da0208/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/yamaokunousausa/items/bc81d8498ecf62da0208/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/yamaokunousausa/items/bc81d8498ecf62da0208/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/yamaokunousausa/items/bc81d8498ecf62da0208/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/yamaokunousausa/items/bc81d8498ecf62da0208.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/yamaokunousausa"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/9645/profile-images/1569302036" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/yamaokunousausa" class="css-10ougpm">@<!-- -->yamaokunousausa</a><div class="css-1ay9vb9"><span><meta content="2016-12-07T05:11:32Z"/><time dateTime="2016-12-07T05:24:09Z" class="css-m19uds">updated at 2016-12-07</time></span></div></div></div></div></div><h1 class="css-cgzq40">ASP.NET CoreアプリのDependency Injection処理を別のDIコンテナに委譲する(完全版)</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/.net" class="css-4czcte">.NET</a><a href="/tags/dependencyinjection" class="css-4czcte">DependencyInjection</a><a href="/tags/.netcore" class="css-4czcte">.NETCore</a><a href="/tags/asp.net_core" class="css-4czcte">ASP.NET_Core</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="やること" class="fragment"></span><a href="#%E3%82%84%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>やること</h1>

<p>独自のDependency ResolverとASP.NET Coreを連携させる方法の完全版です。</p>

<p><a href="http://qiita.com/yamaokunousausa/items/1c93740c4cae8e204331" id="reference-e1a485580c57544164d2">以前の記事</a>ではIControllerActivatorを使用したコントローラーに対するDIの連携を実装しましたが、カスタムIServiceProviderを実装することでコントローラー以外への連携も可能になるため、その方法について記述します。</p>

<h1>
<span id="環境" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>環境</h1>

<ul>
<li>Visual Strudio 2015</li>
<li>.NET Core Tooling Preview 2 for Visual Studio 2015</li>
<li>
<a href="https://github.com/usausa/Smart-Net-Resolver" rel="nofollow noopener" target="_blank">Smart.Resolver 1.1.2</a> (自作のGuice型Dependency Resolver)</li>
</ul>

<h1>
<span id="サンプル" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB"><i class="fa fa-link"></i></a>サンプル</h1>

<p>以下のサンプルを今回の内容も踏まえてアップデートしています。</p>

<ul>
<li><a href="https://github.com/usausa/Example-Net-AspNetCore/tree/master/DependencyInjectionExample" rel="nofollow noopener" target="_blank">DependencyInjectionExample</a></li>
</ul>

<h1>
<span id="aspnet-coreにおけるdi" class="fragment"></span><a href="#aspnet-core%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bdi"><i class="fa fa-link"></i></a>ASP.NET CoreにおけるDI</h1>

<p>連携方法の解説の前に、ASP.NET CoreにおけるDIが使用できる箇所をおさらいしておきます。</p>

<p>以下は全てASP.NET Coreの標準動作であり、基本的にインジェクションされるインスタンスはIServiceProviderから取得されます。</p>

<p>なお、以下の記述ではサンプルソースからの抜粋を例として扱っています。</p>

<h2>
<span id="コントローラー" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC"><i class="fa fa-link"></i></a>コントローラー</h2>

<p>コントローラーに対してコンストラクタインジェクションを行えます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="nf">Route</span><span class="p">(</span><span class="s">"api/[controller]"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ItemController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">MasterService</span> <span class="n">MasterService</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">ItemController</span><span class="p">(</span><span class="n">MasterService</span> <span class="n">masterService</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">MasterService</span> <span class="p">=</span> <span class="n">masterService</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">HttpGet</span><span class="p">]</span>
    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ItemEntity</span><span class="p">&gt;</span> <span class="nf">Get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">MasterService</span><span class="p">.</span><span class="nf">QueryItemList</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>IControllerActivatorをカスタマイズしない場合、コントローラーのインスタンス自体はIServiceProvider外で生成され、引数のインスタンスのみがIServiceProviderから取得されます。</p>

<p>IControllerActivatorをカスタマイズする場合、コントローラーの生成をカスタムResolverに行わせることで、そこから連鎖して依存するオブジェクトの解決もカスタムResolverに行わせる形となります。</p>

<p>よって、引数のインスタンスのみをカスタムResolverで解決するのであれば、IControllerActivatorをカスタマイズする方法でも、IServiceProviderを置換する方法でも、どちらの方法でも対応はできます。</p>

<p>コントローラー自体に対しても、標準ではサポートされないプロパティインジェクションやコンディショナルバインディングを行いたい場合には、IServiceProvider置換の有無にかかわらず、IControllerActivatorのカスタマイズが必要になります。</p>

<h2>
<span id="アクション" class="fragment"></span><a href="#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>アクション</h2>

<p>FromServicesAttributeを使用することで、コントローラーのアクションメソッドに対してインジェクションを行えます。</p>

<p>コントローラーの処理のうち、特定のアクションでしか使用しないコンポーネント等はこの方法で解決できます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="n">MetricsFilter</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">FilterController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Index</span><span class="p">([</span><span class="n">FromServices</span><span class="p">]</span> <span class="n">MetricsManager</span> <span class="n">metricsManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">metricsManager</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>想定される使用ケースとしては、PDF/CSV出力コンポーネントや、認証マネージャーなどのコンポーネント解決時でしょうか。</p>

<h2>
<span id="ビュー" class="fragment"></span><a href="#%E3%83%93%E3%83%A5%E3%83%BC"><i class="fa fa-link"></i></a>ビュー</h2>

<p><a href="/inject" class="user-mention js-hovercard" title="inject" data-hovercard-target-type="user" data-hovercard-target-name="inject">@inject</a>ディレクティブを使用することで、ビューに対してコンポーネントのインジェクションが行えます。</p>

<div class="code-frame" data-lang="html"><div class="highlight"><pre class="with-code"><code>@inject Microsoft.AspNetCore.Hosting.IHostingEnvironment Env
@inject Microsoft.Extensions.Options.IOptions<span class="nt">&lt;DependencyInjectionExample.Settings.ProfileSettings&gt;</span> Profile
@inject DependencyInjectionExample.Services.CharacterService CharacterService

<span class="nt">&lt;h2&gt;</span>Environment<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;div&gt;</span>@Env.EnvironmentName<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;h2&gt;</span>Option<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;div&gt;</span>@Html.DropDownList("Gender", Profile.Value.Genders.Select(_ =&gt; new SelectListItem { Text = _, Value = _ }))<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;h2&gt;</span>User Service<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;div&gt;</span>@CharacterService.QueryCharacterList().Count<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>IHostingEnvironmentの様に、ASP.NET Coreのコンポーネントを直接インジェクションして動作環境に応じて表示を変えたり、CharacterServiceの様に様アプリケーション固有のロジックをインジェクションしてビューから直接使うことも可能です。</p>

<p>また、以下のようにappsettings.jsonに設定を記述して、それに対応する設定値クラスを作成し、その内容をIServiceProviderに登録することで、設定の内容からドロップダウンリストを作成するような処理をコントローラーを経由せずに行うことも可能となります。</p>

<div class="code-frame" data-lang="javascript">
<div class="code-lang"><span class="bold">appsettings.json</span></div>
<div class="highlight"><pre class="with-code"><code><span class="p">{</span>
<span class="p">...</span>
  <span class="dl">"</span><span class="s2">ProfileSettings</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">Genders</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
      <span class="dl">"</span><span class="s2">Male</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">Female</span><span class="dl">"</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">Ohter</span><span class="dl">"</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="c1">// 設定クラス</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ProfileSettings</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">Genders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
<span class="p">...</span>
    <span class="k">public</span> <span class="n">IServiceProvider</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
<span class="p">...</span>
        <span class="c1">// Settings</span>
        <span class="nf">ConfigureSettings</span><span class="p">(</span><span class="n">services</span><span class="p">);</span>
<span class="p">...</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ConfigureSettings</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">services</span><span class="p">.</span><span class="nf">AddOptions</span><span class="p">();</span>

        <span class="c1">// 設定ファイルのセクションの内容をProfileSettingsとして登録</span>
        <span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">ProfileSettings</span><span class="p">&gt;(</span><span class="n">Configuration</span><span class="p">.</span><span class="nf">GetSection</span><span class="p">(</span><span class="s">"ProfileSettings"</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>なお、ビューから直接モデルをpullして使用することは責務を崩すことになりかねないので、適用範囲を検討し、View Componentsとの使い分けを考えて、用量用法を守って使うようにしてください。</p>

<h2>
<span id="フィルター" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%BC"><i class="fa fa-link"></i></a>フィルター</h2>

<p>TypeFilterAttributeを継承して、コンポーネントがインジェクションされたフィルタを作成することができます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">MetricsFilterAttribute</span> <span class="p">:</span> <span class="n">TypeFilterAttribute</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">MetricsFilterAttribute</span><span class="p">()</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">MetricsActionFilter</span><span class="p">))</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">MetricsActionFilter</span> <span class="p">:</span> <span class="n">IActionFilter</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">MetricsManager</span> <span class="n">metricsManager</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">MetricsActionFilter</span><span class="p">(</span><span class="n">MetricsManager</span> <span class="n">metricsManager</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">metricsManager</span> <span class="p">=</span> <span class="n">metricsManager</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">OnActionExecuting</span><span class="p">(</span><span class="n">ActionExecutingContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">metricsManager</span><span class="p">.</span><span class="nf">Increment</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">OnActionExecuted</span><span class="p">(</span><span class="n">ActionExecutedContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="c1">// 使用例</span>
<span class="p">[</span><span class="n">MetricsFilter</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">FilterController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>サービス層のコンポーネントを使用するフィルタを作ることで、データベースの値による前処理フィルタ等を簡単に作ることが可能になります。</p>

<h2>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h2>

<p>例えば、AuthorizationHandler等にもインジェクションを行えますし、そもそもASP.NET Core自体がコンポーネントのDIによって構築されているともいえます。</p>

<p>ここで一つのポイントは、ASP.NET Coreのコンポーネントも、アプリケーション固有のユーザコンポーネントも、等しくIServiceProviderを通じて扱われるという点にあります。</p>

<p>これは、ユーザコンポーネントがASP.NET Coreのコンポーネントを使用することはもちろん、ユーザコンポーネントを参照するASP.NET Coreのコンポーネントの実装を用意することで、アプリケーション固有のデータを参照してASP.NET Coreの挙動を変更することが容易にできるということでもあります。</p>

<p>以上より、カスタムResolverを使用するIServiceProviderを実装することにより、全てのDI処理をカスタムResolverに委譲することが可能になります。</p>

<h1>
<span id="カスタム版の実装" class="fragment"></span><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E7%89%88%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>カスタム版の実装</h1>

<p>ASP.NET Coreにおいて、DIの恩恵をいたるところでうけるためにはカスタムIServiceProviderを用意すれば良いことはわかったと思うので、その実装方法について記述します。</p>

<h2>
<span id="iserviceproviderの置換" class="fragment"></span><a href="#iserviceprovider%E3%81%AE%E7%BD%AE%E6%8F%9B"><i class="fa fa-link"></i></a>IServiceProviderの置換</h2>

<p>標準で使用されるIServiceProviderを置換する方法について記述します。</p>

<p>ASP.NET Core Web Applicationのテンプレートで作成した場合、Startup.csでの初期化処理は以下のようになっていると思います。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>この、ConfigureServices()の戻り値をvoidからIServiceProviderに変更することで、標準のIServiceProviderに変わってその戻り値が使用されるようになります。</p>

<p>テンプレートで生成されるコードは、以下と等価ともいえます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="n">IServiceProvider</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
    <span class="c1">// ここでカスタムIServiceProviderを返せばそれが使用される</span>
    <span class="k">return</span> <span class="n">services</span><span class="p">.</span><span class="nf">BuildServiceProvider</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>なお、ConfigureServices()が呼び出された時点で既にIServiceCollectionにはASP.NET Coreのコンポーネント情報が登録されています。</p>

<p>また、AddMvc()等の拡張メソッドによってもコンポーネント情報が登録されますが、カスタムIServiceProviderに置換する場合、IServiceCollectionに登録されているコンポーネント情報もカスタムIServiceProviderで扱えるようにする必要があります。</p>

<p>この詳細については後述します。</p>

<h2>
<span id="カスタムiserviceproviderの実装" class="fragment"></span><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0iserviceprovider%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>カスタムIServiceProviderの実装</h2>

<p>以下のような形で、カスタムResolverをラップする形でIServiceProviderを実装します。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">SmartResolverServiceProvider.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Smart.Resolver</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">SmartResolverServiceProvider</span> <span class="p">:</span> <span class="n">IServiceProvider</span><span class="p">,</span> <span class="n">ISupportRequiredService</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Type</span> <span class="n">EnumerableType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;&gt;);</span>

    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IResolver</span> <span class="n">resolver</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">SmartResolverServiceProvider</span><span class="p">(</span><span class="n">IResolver</span> <span class="n">resolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">resolver</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">object</span> <span class="nf">GetService</span><span class="p">(</span><span class="n">Type</span> <span class="n">serviceType</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">GetServiceInternal</span><span class="p">(</span><span class="n">serviceType</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">object</span> <span class="nf">GetRequiredService</span><span class="p">(</span><span class="n">Type</span> <span class="n">serviceType</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">GetServiceInternal</span><span class="p">(</span><span class="n">serviceType</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="kt">object</span> <span class="nf">GetServiceInternal</span><span class="p">(</span><span class="n">Type</span> <span class="n">serviceType</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">required</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">serviceType</span><span class="p">.</span><span class="nf">GetTypeInfo</span><span class="p">().</span><span class="n">IsGenericType</span> <span class="p">&amp;&amp;</span> <span class="n">serviceType</span><span class="p">.</span><span class="nf">GetGenericTypeDefinition</span><span class="p">()</span> <span class="p">==</span> <span class="n">EnumerableType</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">ResolverHelper</span><span class="p">.</span><span class="nf">ConvertArray</span><span class="p">(</span>
                <span class="n">serviceType</span><span class="p">.</span><span class="n">GenericTypeArguments</span><span class="p">[</span><span class="m">0</span><span class="p">],</span>
                <span class="n">resolver</span><span class="p">.</span><span class="nf">ResolveAll</span><span class="p">(</span><span class="n">serviceType</span><span class="p">.</span><span class="n">GenericTypeArguments</span><span class="p">[</span><span class="m">0</span><span class="p">],</span> <span class="k">null</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">required</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">resolver</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">serviceType</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">bool</span> <span class="n">result</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">resolver</span><span class="p">.</span><span class="nf">TryGet</span><span class="p">(</span><span class="n">serviceType</span><span class="p">,</span> <span class="k">out</span> <span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>なお、ASP.NET Coreで使用されるIServiceProviderについては、以下のような要件が必要とされます。</p>

<p>これらの要件のうち、いくつかの項目については以前のSmart.Resolverは対応していなかったので、今回の実験にあたってその部分の挙動を修正しました。</p>

<ul>
<li>IServiceProviderとISupportRequiredServiceの使い分け</li>
</ul>

<p>ASP.NET Coreが必須とするものについてはISupportRequiredService.GetRequiredService()が使用され、オプショナルなものについてはIServiceProvider.GetService()が使用されます。</p>

<p>実際には、IServiceProviderしか実装しない場合の挙動もありますが、ここでは省略します。</p>

<ul>
<li>IEnumerableの扱い</li>
</ul>

<p>ASP.NET CoreはIServiceCollectionに対して、同じインターフェースの情報を複数件登録してきます。</p>

<p>例えば、インターフェースIHoge型複数件の登録に対して、serviceTypeとしてIEnumerable&lt;IHoge&gt;がから要求された場合、個別に登録されているIHoge複数件をIEnumerable&lt;IHoge&gt;として返す挙動が求められます。</p>

<p>また、遅延評価の形だとまずいようなので、SmartResolverServiceProviderではResolverHelper.ConvertArray()を使用して、この時点でserviceType型の配列に変換して返すようにしています。</p>

<ul>
<li>オープンジェネリック型への対応 </li>
</ul>

<p>ASP.NET CoreはIServiceCollectionに対して、オープンジェネリック型の情報を登録してきます。</p>

<p>IFoo&lt;&gt; to Foo&lt;&gt;のようなオープンジェネリック型の情報登録に対して、serviceTypeとしてクローズジェネリック型のIFoo&lt;Bar&gt;が要求された場合、Foo&lt;Bar&gt;のインスタンスを返す挙動が求められます。</p>

<ul>
<li>複数のコンポーネントの登録</li>
</ul>

<p>ASP.NET CoreはIServiceCollectionに対して、登録時に重複チェックをするようなことはせず、同じ型に対するシングルトンの情報を複数件登録してきます。</p>

<p>登録情報が複数件あった場合、エラーとはせずに、そのうちの1件(一番最後)の情報を元にンスタンスを返す挙動が求められます。</p>

<ul>
<li>コンストラクタの選定</li>
</ul>

<p>複数のコンストラクタを持つクラスのインスタンスが要求された場合に、解決可能な引数の数が最も多いコンストラクタを使用する挙動が求められます。</p>

<p>例えば以下のようなクラスのインスタンスが要求されたときに、IFoo、IBarともに登録があれば引数2つのコンストラクタを、IBarの登録がなければ引数1つのコンストラクタを使用する動作である必要があります。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Hoge</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Hoge</span><span class="p">(</span><span class="n">IFoo</span> <span class="n">foo</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">Hoge</span><span class="p">(</span><span class="n">IFoo</span> <span class="n">foo</span><span class="p">,</span> <span class="n">IBar</span> <span class="n">bar</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="カスタムiserviceproviderの生成" class="fragment"></span><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0iserviceprovider%E3%81%AE%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>カスタムIServiceProviderの生成</h2>

<p>前述してあるように、カスタムIServiceProviderでは、IServiceCollectionに登録されているASP.NET Coreコンポーネントの情報も扱えるようにする必要があり、IServiceCollectionの情報の移し替えが必要になります。</p>

<p>そこで、以下のようなヘルパーを作ることで、情報の移し替えと、カスタムIServiceProviderの生成を行うようにしています。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">SmartResolverHelper.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Smart.Resolver</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Smart.Resolver.Bindings</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">SmartResolverHelper</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceProvider</span> <span class="nf">BuildServiceProvider</span><span class="p">(</span><span class="n">StandardResolver</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ServiceDescriptor</span><span class="p">&gt;</span> <span class="n">descriptors</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">descriptor</span> <span class="k">in</span> <span class="n">descriptors</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ImplementationType</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">resolver</span>
                    <span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ServiceType</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">To</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ImplementationType</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">ConfigureScope</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ImplementationFactory</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">resolver</span>
                    <span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ServiceType</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">ToMethod</span><span class="p">(</span><span class="n">kernel</span> <span class="p">=&gt;</span> <span class="n">descriptor</span><span class="p">.</span><span class="nf">ImplementationFactory</span><span class="p">(</span><span class="n">kernel</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">IServiceProvider</span><span class="p">&gt;()))</span>
                    <span class="p">.</span><span class="nf">ConfigureScope</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ImplementationInstance</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">resolver</span>
                    <span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ServiceType</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">ToConstant</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">ImplementationInstance</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">ConfigureScope</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">resolver</span><span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">IServiceProvider</span><span class="p">&gt;().</span><span class="n">To</span><span class="p">&lt;</span><span class="n">SmartResolverServiceProvider</span><span class="p">&gt;().</span><span class="nf">InSingletonScope</span><span class="p">();</span>
        <span class="n">resolver</span><span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">IServiceScopeFactory</span><span class="p">&gt;().</span><span class="n">To</span><span class="p">&lt;</span><span class="n">SmartResolverServiceScopeFactory</span><span class="p">&gt;().</span><span class="nf">InSingletonScope</span><span class="p">();</span>
        <span class="n">resolver</span><span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">IHttpContextAccessor</span><span class="p">&gt;().</span><span class="n">To</span><span class="p">&lt;</span><span class="n">HttpContextAccessor</span><span class="p">&gt;().</span><span class="nf">InSingletonScope</span><span class="p">();</span>
        <span class="n">resolver</span><span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">RequestScopeStorage</span><span class="p">&gt;().</span><span class="nf">ToSelf</span><span class="p">().</span><span class="nf">InSingletonScope</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">resolver</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">IServiceProvider</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ConfigureScope</span><span class="p">(</span><span class="k">this</span> <span class="n">IBindingInSyntax</span> <span class="n">syntax</span><span class="p">,</span> <span class="n">ServiceLifetime</span> <span class="n">lifetime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">lifetime</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="n">ServiceLifetime</span><span class="p">.</span><span class="n">Singleton</span><span class="p">:</span>
                <span class="n">syntax</span><span class="p">.</span><span class="nf">InSingletonScope</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">ServiceLifetime</span><span class="p">.</span><span class="n">Transient</span><span class="p">:</span>
                <span class="n">syntax</span><span class="p">.</span><span class="nf">InTransientScope</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">ServiceLifetime</span><span class="p">.</span><span class="n">Scoped</span><span class="p">:</span>
                <span class="n">syntax</span><span class="p">.</span><span class="nf">InRequestScope</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>IServiceCollection(IEnumerable&lt;ServiceDescriptor&gt;)の情報については、ServiceDescriptorのメンバを判定し、ImplementationTypeの型による生成か、ファクトリーメソッドImplementationFactoryによる生成か、固定値ImplementationInstanceへの参照かによって、処理を分けてStandardResolverへの登録情報を構築しています。</p>

<p>その後にあるresolver.Bind()の記述は、カスタムIServiceProvider自身を扱えるようにするための登録情報と、リクエストスコープを扱えるようにするための登録情報になります。</p>

<p>リクエストスコープの扱いについては次の段落で記述します。</p>

<p>最後は、カスタムIServiceProviderをStandardResolver自身から取得して返し、StartupのConfigureServices()で以下のように使用することでIServiceProviderの置換を行います。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="n">IServiceProvider</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Add framework services.</span>
    <span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">();</span>
<span class="p">...</span>
    <span class="c1">// Use custom service provider.</span>
    <span class="k">return</span> <span class="n">SmartResolverHelper</span><span class="p">.</span><span class="nf">BuildServiceProvider</span><span class="p">(</span><span class="n">resolver</span><span class="p">,</span> <span class="n">services</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>なお、アプリケーション固有のユーザコンポーネントは一端IServiceCollectionに登録する形でも、直接カスタムResolverに登録する形でも、どちらでも問題はありませんが。</p>

<p>サンプルでは、AddMvc()のようにIServiceCollectionへの拡張メソッドがあるもので登録されるコンポーネントは一端IServiceCollectionに情報を登録し、ユーザコンポーネントは直接カスタムResolverに登録して、最後にSmartResolverHelper.BuildServiceProvider()でマージする形としています。</p>

<h2>
<span id="リクエストスコープ" class="fragment"></span><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97"><i class="fa fa-link"></i></a>リクエストスコープ</h2>

<p>リクエストスコープに関連して、カスタムIServiceProviderにはIServiceScopeFactoryを解決できることが要件として求められます。</p>

<p>IServiceScopeFactoryとそれが生成するIServiceScopeを使用して、リクエストスコープのインスタンスが管理されます。</p>

<p>以下に、Smart.Resolver用の実装を示します。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">SmartResolverServiceScope.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">SmartResolverServiceScope</span> <span class="p">:</span> <span class="n">IServiceScope</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">RequestScopeStorage</span> <span class="n">storage</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">IServiceProvider</span> <span class="n">ServiceProvider</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">SmartResolverServiceScope</span><span class="p">(</span><span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">,</span> <span class="n">RequestScopeStorage</span> <span class="n">storage</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ServiceProvider</span> <span class="p">=</span> <span class="n">serviceProvider</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">storage</span> <span class="p">=</span> <span class="n">storage</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">storage</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">SmartResolverServiceScopeFactory.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">SmartResolverServiceScopeFactory</span> <span class="p">:</span> <span class="n">IServiceScopeFactory</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">readonly</span> <span class="n">RequestScopeStorage</span> <span class="n">storage</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">SmartResolverServiceScopeFactory</span><span class="p">(</span><span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">,</span> <span class="n">RequestScopeStorage</span> <span class="n">storage</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">serviceProvider</span> <span class="p">=</span> <span class="n">serviceProvider</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">storage</span> <span class="p">=</span> <span class="n">storage</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IServiceScope</span> <span class="nf">CreateScope</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">SmartResolverServiceScope</span><span class="p">(</span><span class="n">serviceProvider</span><span class="p">,</span> <span class="n">storage</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>IServiceScopeの実装はリクエスト毎にIServiceScopeFactoryから生成されます。</p>

<p>リクエスト中のコンポーネントは生成されたIServiceScopeのIServiceProviderプロパティから取得され、リクエスト終了時にはDispose()が呼び出されます。</p>

<p>ここにフックを用意することにより、リクエスト間のみ存在するコンポーネントを扱えるようにする、っというのが求められる実装となります。</p>

<p>Smart.Resolverのスコープ管理は単純な設計となっており、スコープとは、特定のコンテキストに関連づけられたキャッシュのストレージ(ディクショナリ)である、っという考えになっています。</p>

<p>例えば、シングルトンスコープのストレージは単一のディクショナリであり、スコープ無し(Transient)のストレージはストレージ自体がなしという形になっています。</p>

<p>そこで、リクエストスコープのストレージとしては、IHttpContextAccessorをDIしてもらい、HttpContextをコンテキストとするRequestScopeStorageを用意しています。</p>

<p>後は、IServiceScope.Dispose()ではそれをクリアするだけで、リクエストスコープの対応ができる形となっています。</p>

<p>サンプルでは、ScopedController及びそのIndex.cshtmlにおいて、スコープ管理されるScopedObjectを同一リクエスト中に複数回インジェクションしてもらい、そのインスタンスが同じものであることを確認する例が入っています。</p>

<p>以下に、サンプルでの使用ケースからコードを抜粋します。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">ScopedObject</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ScopedObject</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ScopedObject</span><span class="p">(</span><span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ScopedObject</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Construct {0}"</span><span class="p">,</span> <span class="nf">GetHashCode</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Dispose {0}"</span><span class="p">,</span> <span class="nf">GetHashCode</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">SetupComponents</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">...</span>
    <span class="n">resolver</span>
        <span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">ScopedObject</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="nf">ToSelf</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">InRequestScope</span><span class="p">();</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ScopedController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">ScopedObject</span> <span class="n">ScopedObject</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">ScopedController</span><span class="p">(</span><span class="n">ScopedObject</span> <span class="n">scopedObject</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ScopedObject</span> <span class="p">=</span> <span class="n">scopedObject</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Index</span><span class="p">([</span><span class="n">FromServices</span><span class="p">]</span> <span class="n">ScopedObject</span> <span class="n">scopedObject</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ScopedObject</span> <span class="p">!=</span> <span class="n">scopedObject</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"Scoped object unmatch."</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">ScopedObject</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="html"><div class="highlight"><pre class="with-code"><code>@inject DependencyInjectionExample.Services.ScopedObject ScopedObject

<span class="nt">&lt;h2&gt;</span>Result<span class="nt">&lt;/h2&gt;</span>
@if (Model == ScopedObject)
{
    <span class="nt">&lt;div&gt;</span>Scoped Lifetime object matched.<span class="nt">&lt;/div&gt;</span>
}
</code></pre></div></div>

<p>以下の3つのインスタンスが同一であることを確認できる内容となっています。</p>

<ul>
<li>ScopedControllerにコンストラクタインジェクションされるインスタンス</li>
<li>アクションメソッドで[FromServices]によりインジェクションされるインスタンス</li>
<li>ビューにインジェクションされるインスタンス</li>
</ul>

<p>また、リクエスト開始時と終了時にはScopedObjectのログ出力も確認でき、インスタンスがリクエスト間のみ生存することを確認できるような内容になっています。</p>

<h1>
<span id="うさコメ" class="fragment"></span><a href="#%E3%81%86%E3%81%95%E3%82%B3%E3%83%A1"><i class="fa fa-link"></i></a>うさコメ</h1>

<p>まあ、カスタムResolverとASP.NET Coreを連携させる拡張の作り方とか、ほとんどの人にはいらない知識だと思うんですけどね(´・ω・`)</p>

<p>高度なDIが必要になったとしても、普通は既存のなにかしらのコンテナを使うと思いますし、AutofacやWindsor等にはここに書いたのと同種の実装携帯による拡張があるようですが。</p>

<p>っというか、ほとんどのケースでは標準のIServiceProvider推奨だと思います(｀・ω・´)</p>

<p>そもそも、高度なDIが必要なケースって、例えばサンプルでやっているように複数のデータベース接続を使い分けてインジェクションしてもらいたい、みたいなケースとかだと思いますが。</p>

<p>その程度であれば、データベース接続のセレクター的なコンポーネントを用意して、それをDIしてもらって、定数かなんかをキーとして使うデータベース接続をそこから取得する、みたいなベタな処理でもいいかという気にもなってくるし(´д｀;)</p>

<p>標準のIServiceProvider、機能的には基本的な処理しかないけど、性能的には優秀だしね(・∀・;)</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fyamaokunousausa%2Fitems%2Fbc81d8498ecf62da0208&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fyamaokunousausa%2Fitems%2Fbc81d8498ecf62da0208&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/yamaokunousausa/items/bc81d8498ecf62da0208/likers" class="css-1iupg5d">15</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">21</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/bc81d8498ecf62da0208/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/yamaokunousausa/items/bc81d8498ecf62da0208/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/yamaokunousausa/items/bc81d8498ecf62da0208/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/yamaokunousausa/items/bc81d8498ecf62da0208/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/yamaokunousausa/items/bc81d8498ecf62da0208.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-53ec63a7-4ca3-4cb2-94a0-c9bc93157b89">{"authorAnalyticsTrackingId":"UA-388128-3","organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-348168db-ba41-446e-882b-169aec335fcd"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-348168db-ba41-446e-882b-169aec335fcd">{}</script>
      
<div id="LoginModal-react-component-7f7f4c54-22c7-4b69-ad97-c45ec4f23379"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-7f7f4c54-22c7-4b69-ad97-c45ec4f23379">{}</script>
      
<div id="StockModal-react-component-53ab576b-073c-474c-adaf-af559246a49d"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-53ab576b-073c-474c-adaf-af559246a49d">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;nv4iFQtto24C1Lw0ZidKdLtbtGH1TiOAFJtKqFNkpknRIWElPJPV4dsVEKdqyRHSIpAstRrveFEOg8bTS3nkyw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"やること\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%84%E3%82%8B%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eやること\u003c/h1\u003e\n\n\u003cp\u003e独自のDependency ResolverとASP.NET Coreを連携させる方法の完全版です。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"http://qiita.com/yamaokunousausa/items/1c93740c4cae8e204331\" id=\"reference-e1a485580c57544164d2\"\u003e以前の記事\u003c/a\u003eではIControllerActivatorを使用したコントローラーに対するDIの連携を実装しましたが、カスタムIServiceProviderを実装することでコントローラー以外への連携も可能になるため、その方法について記述します。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"環境\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%92%B0%E5%A2%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e環境\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eVisual Strudio 2015\u003c/li\u003e\n\u003cli\u003e.NET Core Tooling Preview 2 for Visual Studio 2015\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://github.com/usausa/Smart-Net-Resolver\" rel=\"nofollow noopener\" target=\"_blank\"\u003eSmart.Resolver 1.1.2\u003c/a\u003e (自作のGuice型Dependency Resolver)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"サンプル\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eサンプル\u003c/h1\u003e\n\n\u003cp\u003e以下のサンプルを今回の内容も踏まえてアップデートしています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/usausa/Example-Net-AspNetCore/tree/master/DependencyInjectionExample\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDependencyInjectionExample\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"aspnet-coreにおけるdi\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#aspnet-core%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bdi\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eASP.NET CoreにおけるDI\u003c/h1\u003e\n\n\u003cp\u003e連携方法の解説の前に、ASP.NET CoreにおけるDIが使用できる箇所をおさらいしておきます。\u003c/p\u003e\n\n\u003cp\u003e以下は全てASP.NET Coreの標準動作であり、基本的にインジェクションされるインスタンスはIServiceProviderから取得されます。\u003c/p\u003e\n\n\u003cp\u003eなお、以下の記述ではサンプルソースからの抜粋を例として扱っています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"コントローラー\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコントローラー\u003c/h2\u003e\n\n\u003cp\u003eコントローラーに対してコンストラクタインジェクションを行えます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eRoute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"api/[controller]\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eItemController\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eMasterService\u003c/span\u003e \u003cspan class=\"n\"\u003eMasterService\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eItemController\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMasterService\u003c/span\u003e \u003cspan class=\"n\"\u003emasterService\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eMasterService\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emasterService\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpGet\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eItemEntity\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eMasterService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eQueryItemList\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIControllerActivatorをカスタマイズしない場合、コントローラーのインスタンス自体はIServiceProvider外で生成され、引数のインスタンスのみがIServiceProviderから取得されます。\u003c/p\u003e\n\n\u003cp\u003eIControllerActivatorをカスタマイズする場合、コントローラーの生成をカスタムResolverに行わせることで、そこから連鎖して依存するオブジェクトの解決もカスタムResolverに行わせる形となります。\u003c/p\u003e\n\n\u003cp\u003eよって、引数のインスタンスのみをカスタムResolverで解決するのであれば、IControllerActivatorをカスタマイズする方法でも、IServiceProviderを置換する方法でも、どちらの方法でも対応はできます。\u003c/p\u003e\n\n\u003cp\u003eコントローラー自体に対しても、標準ではサポートされないプロパティインジェクションやコンディショナルバインディングを行いたい場合には、IServiceProvider置換の有無にかかわらず、IControllerActivatorのカスタマイズが必要になります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"アクション\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eアクション\u003c/h2\u003e\n\n\u003cp\u003eFromServicesAttributeを使用することで、コントローラーのアクションメソッドに対してインジェクションを行えます。\u003c/p\u003e\n\n\u003cp\u003eコントローラーの処理のうち、特定のアクションでしか使用しないコンポーネント等はこの方法で解決できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eMetricsFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFilterController\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIActionResult\u003c/span\u003e \u003cspan class=\"nf\"\u003eIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eFromServices\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eMetricsManager\u003c/span\u003e \u003cspan class=\"n\"\u003emetricsManager\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emetricsManager\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e想定される使用ケースとしては、PDF/CSV出力コンポーネントや、認証マネージャーなどのコンポーネント解決時でしょうか。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ビュー\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%93%E3%83%A5%E3%83%BC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eビュー\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"/inject\" class=\"user-mention js-hovercard\" title=\"inject\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"inject\"\u003e@inject\u003c/a\u003eディレクティブを使用することで、ビューに対してコンポーネントのインジェクションが行えます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"html\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e@inject Microsoft.AspNetCore.Hosting.IHostingEnvironment Env\n@inject Microsoft.Extensions.Options.IOptions\u003cspan class=\"nt\"\u003e\u0026lt;DependencyInjectionExample.Settings.ProfileSettings\u0026gt;\u003c/span\u003e Profile\n@inject DependencyInjectionExample.Services.CharacterService CharacterService\n\n\u003cspan class=\"nt\"\u003e\u0026lt;h2\u0026gt;\u003c/span\u003eEnvironment\u003cspan class=\"nt\"\u003e\u0026lt;/h2\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u0026gt;\u003c/span\u003e@Env.EnvironmentName\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"nt\"\u003e\u0026lt;h2\u0026gt;\u003c/span\u003eOption\u003cspan class=\"nt\"\u003e\u0026lt;/h2\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u0026gt;\u003c/span\u003e@Html.DropDownList(\"Gender\", Profile.Value.Genders.Select(_ =\u0026gt; new SelectListItem { Text = _, Value = _ }))\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"nt\"\u003e\u0026lt;h2\u0026gt;\u003c/span\u003eUser Service\u003cspan class=\"nt\"\u003e\u0026lt;/h2\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u0026gt;\u003c/span\u003e@CharacterService.QueryCharacterList().Count\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIHostingEnvironmentの様に、ASP.NET Coreのコンポーネントを直接インジェクションして動作環境に応じて表示を変えたり、CharacterServiceの様に様アプリケーション固有のロジックをインジェクションしてビューから直接使うことも可能です。\u003c/p\u003e\n\n\u003cp\u003eまた、以下のようにappsettings.jsonに設定を記述して、それに対応する設定値クラスを作成し、その内容をIServiceProviderに登録することで、設定の内容からドロップダウンリストを作成するような処理をコントローラーを経由せずに行うことも可能となります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"javascript\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eappsettings.json\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n  \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eProfileSettings\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eGenders\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eMale\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eFemale\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\u003cspan class=\"s2\"\u003eOhter\u003c/span\u003e\u003cspan class=\"dl\"\u003e\"\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 設定クラス\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProfileSettings\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eGenders\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eStartup\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureServices\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceCollection\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// Settings\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eConfigureSettings\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureSettings\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceCollection\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 設定ファイルのセクションの内容をProfileSettingsとして登録\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConfigure\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eProfileSettings\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eConfiguration\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ProfileSettings\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなお、ビューから直接モデルをpullして使用することは責務を崩すことになりかねないので、適用範囲を検討し、View Componentsとの使い分けを考えて、用量用法を守って使うようにしてください。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"フィルター\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%BC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eフィルター\u003c/h2\u003e\n\n\u003cp\u003eTypeFilterAttributeを継承して、コンポーネントがインジェクションされたフィルタを作成することができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMetricsFilterAttribute\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eTypeFilterAttribute\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eMetricsFilterAttribute\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMetricsActionFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMetricsActionFilter\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIActionFilter\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eMetricsManager\u003c/span\u003e \u003cspan class=\"n\"\u003emetricsManager\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eMetricsActionFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMetricsManager\u003c/span\u003e \u003cspan class=\"n\"\u003emetricsManager\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emetricsManager\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emetricsManager\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnActionExecuting\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eActionExecutingContext\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003emetricsManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIncrement\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnActionExecuted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eActionExecutedContext\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 使用例\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eMetricsFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFilterController\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eサービス層のコンポーネントを使用するフィルタを作ることで、データベースの値による前処理フィルタ等を簡単に作ることが可能になります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"その他\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eその他\u003c/h2\u003e\n\n\u003cp\u003e例えば、AuthorizationHandler等にもインジェクションを行えますし、そもそもASP.NET Core自体がコンポーネントのDIによって構築されているともいえます。\u003c/p\u003e\n\n\u003cp\u003eここで一つのポイントは、ASP.NET Coreのコンポーネントも、アプリケーション固有のユーザコンポーネントも、等しくIServiceProviderを通じて扱われるという点にあります。\u003c/p\u003e\n\n\u003cp\u003eこれは、ユーザコンポーネントがASP.NET Coreのコンポーネントを使用することはもちろん、ユーザコンポーネントを参照するASP.NET Coreのコンポーネントの実装を用意することで、アプリケーション固有のデータを参照してASP.NET Coreの挙動を変更することが容易にできるということでもあります。\u003c/p\u003e\n\n\u003cp\u003e以上より、カスタムResolverを使用するIServiceProviderを実装することにより、全てのDI処理をカスタムResolverに委譲することが可能になります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"カスタム版の実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E7%89%88%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eカスタム版の実装\u003c/h1\u003e\n\n\u003cp\u003eASP.NET Coreにおいて、DIの恩恵をいたるところでうけるためにはカスタムIServiceProviderを用意すれば良いことはわかったと思うので、その実装方法について記述します。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"iserviceproviderの置換\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#iserviceprovider%E3%81%AE%E7%BD%AE%E6%8F%9B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eIServiceProviderの置換\u003c/h2\u003e\n\n\u003cp\u003e標準で使用されるIServiceProviderを置換する方法について記述します。\u003c/p\u003e\n\n\u003cp\u003eASP.NET Core Web Applicationのテンプレートで作成した場合、Startup.csでの初期化処理は以下のようになっていると思います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureServices\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceCollection\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこの、ConfigureServices()の戻り値をvoidからIServiceProviderに変更することで、標準のIServiceProviderに変わってその戻り値が使用されるようになります。\u003c/p\u003e\n\n\u003cp\u003eテンプレートで生成されるコードは、以下と等価ともいえます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureServices\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceCollection\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここでカスタムIServiceProviderを返せばそれが使用される\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuildServiceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなお、ConfigureServices()が呼び出された時点で既にIServiceCollectionにはASP.NET Coreのコンポーネント情報が登録されています。\u003c/p\u003e\n\n\u003cp\u003eまた、AddMvc()等の拡張メソッドによってもコンポーネント情報が登録されますが、カスタムIServiceProviderに置換する場合、IServiceCollectionに登録されているコンポーネント情報もカスタムIServiceProviderで扱えるようにする必要があります。\u003c/p\u003e\n\n\u003cp\u003eこの詳細については後述します。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"カスタムiserviceproviderの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0iserviceprovider%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eカスタムIServiceProviderの実装\u003c/h2\u003e\n\n\u003cp\u003e以下のような形で、カスタムResolverをラップする形でIServiceProviderを実装します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSmartResolverServiceProvider.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Reflection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.Extensions.DependencyInjection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSmart.Resolver\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSmartResolverServiceProvider\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eISupportRequiredService\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eType\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerableType\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u0026gt;);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eIResolver\u003c/span\u003e \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSmartResolverServiceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIResolver\u003c/span\u003e \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eresolver\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetService\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eType\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetServiceInternal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetRequiredService\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eType\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetServiceInternal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetServiceInternal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eType\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003erequired\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetTypeInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eIsGenericType\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetGenericTypeDefinition\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerableType\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eResolverHelper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConvertArray\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGenericTypeArguments\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eResolveAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGenericTypeArguments\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erequired\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserviceType\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eなお、ASP.NET Coreで使用されるIServiceProviderについては、以下のような要件が必要とされます。\u003c/p\u003e\n\n\u003cp\u003eこれらの要件のうち、いくつかの項目については以前のSmart.Resolverは対応していなかったので、今回の実験にあたってその部分の挙動を修正しました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eIServiceProviderとISupportRequiredServiceの使い分け\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eASP.NET Coreが必須とするものについてはISupportRequiredService.GetRequiredService()が使用され、オプショナルなものについてはIServiceProvider.GetService()が使用されます。\u003c/p\u003e\n\n\u003cp\u003e実際には、IServiceProviderしか実装しない場合の挙動もありますが、ここでは省略します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eIEnumerableの扱い\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eASP.NET CoreはIServiceCollectionに対して、同じインターフェースの情報を複数件登録してきます。\u003c/p\u003e\n\n\u003cp\u003e例えば、インターフェースIHoge型複数件の登録に対して、serviceTypeとしてIEnumerable\u0026lt;IHoge\u0026gt;がから要求された場合、個別に登録されているIHoge複数件をIEnumerable\u0026lt;IHoge\u0026gt;として返す挙動が求められます。\u003c/p\u003e\n\n\u003cp\u003eまた、遅延評価の形だとまずいようなので、SmartResolverServiceProviderではResolverHelper.ConvertArray()を使用して、この時点でserviceType型の配列に変換して返すようにしています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eオープンジェネリック型への対応 \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eASP.NET CoreはIServiceCollectionに対して、オープンジェネリック型の情報を登録してきます。\u003c/p\u003e\n\n\u003cp\u003eIFoo\u0026lt;\u0026gt; to Foo\u0026lt;\u0026gt;のようなオープンジェネリック型の情報登録に対して、serviceTypeとしてクローズジェネリック型のIFoo\u0026lt;Bar\u0026gt;が要求された場合、Foo\u0026lt;Bar\u0026gt;のインスタンスを返す挙動が求められます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e複数のコンポーネントの登録\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eASP.NET CoreはIServiceCollectionに対して、登録時に重複チェックをするようなことはせず、同じ型に対するシングルトンの情報を複数件登録してきます。\u003c/p\u003e\n\n\u003cp\u003e登録情報が複数件あった場合、エラーとはせずに、そのうちの1件(一番最後)の情報を元にンスタンスを返す挙動が求められます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eコンストラクタの選定\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e複数のコンストラクタを持つクラスのインスタンスが要求された場合に、解決可能な引数の数が最も多いコンストラクタを使用する挙動が求められます。\u003c/p\u003e\n\n\u003cp\u003e例えば以下のようなクラスのインスタンスが要求されたときに、IFoo、IBarともに登録があれば引数2つのコンストラクタを、IBarの登録がなければ引数1つのコンストラクタを使用する動作である必要があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHoge\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIFoo\u003c/span\u003e \u003cspan class=\"n\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIFoo\u003c/span\u003e \u003cspan class=\"n\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIBar\u003c/span\u003e \u003cspan class=\"n\"\u003ebar\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"カスタムiserviceproviderの生成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0iserviceprovider%E3%81%AE%E7%94%9F%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eカスタムIServiceProviderの生成\u003c/h2\u003e\n\n\u003cp\u003e前述してあるように、カスタムIServiceProviderでは、IServiceCollectionに登録されているASP.NET Coreコンポーネントの情報も扱えるようにする必要があり、IServiceCollectionの情報の移し替えが必要になります。\u003c/p\u003e\n\n\u003cp\u003eそこで、以下のようなヘルパーを作ることで、情報の移し替えと、カスタムIServiceProviderの生成を行うようにしています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSmartResolverHelper.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.AspNetCore.Http\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.Extensions.DependencyInjection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSmart.Resolver\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSmart.Resolver.Bindings\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSmartResolverHelper\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"nf\"\u003eBuildServiceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStandardResolver\u003c/span\u003e \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eServiceDescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edescriptors\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003edescriptors\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eImplementationType\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eServiceType\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eImplementationType\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureScope\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLifetime\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eImplementationFactory\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eServiceType\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eImplementationFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()))\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureScope\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLifetime\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eImplementationInstance\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eServiceType\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToConstant\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eImplementationInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureScope\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edescriptor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLifetime\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBind\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSmartResolverServiceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"nf\"\u003eInSingletonScope\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBind\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceScopeFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSmartResolverServiceScopeFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"nf\"\u003eInSingletonScope\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBind\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIHttpContextAccessor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpContextAccessor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"nf\"\u003eInSingletonScope\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBind\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRequestScopeStorage\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"nf\"\u003eToSelf\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eInSingletonScope\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureScope\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIBindingInSyntax\u003c/span\u003e \u003cspan class=\"n\"\u003esyntax\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eServiceLifetime\u003c/span\u003e \u003cspan class=\"n\"\u003elifetime\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elifetime\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eServiceLifetime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSingleton\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esyntax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInSingletonScope\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eServiceLifetime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTransient\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esyntax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInTransientScope\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eServiceLifetime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eScoped\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esyntax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInRequestScope\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eIServiceCollection(IEnumerable\u0026lt;ServiceDescriptor\u0026gt;)の情報については、ServiceDescriptorのメンバを判定し、ImplementationTypeの型による生成か、ファクトリーメソッドImplementationFactoryによる生成か、固定値ImplementationInstanceへの参照かによって、処理を分けてStandardResolverへの登録情報を構築しています。\u003c/p\u003e\n\n\u003cp\u003eその後にあるresolver.Bind()の記述は、カスタムIServiceProvider自身を扱えるようにするための登録情報と、リクエストスコープを扱えるようにするための登録情報になります。\u003c/p\u003e\n\n\u003cp\u003eリクエストスコープの扱いについては次の段落で記述します。\u003c/p\u003e\n\n\u003cp\u003e最後は、カスタムIServiceProviderをStandardResolver自身から取得して返し、StartupのConfigureServices()で以下のように使用することでIServiceProviderの置換を行います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureServices\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceCollection\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Add framework services.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddMvc\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Use custom service provider.\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eSmartResolverHelper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuildServiceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなお、アプリケーション固有のユーザコンポーネントは一端IServiceCollectionに登録する形でも、直接カスタムResolverに登録する形でも、どちらでも問題はありませんが。\u003c/p\u003e\n\n\u003cp\u003eサンプルでは、AddMvc()のようにIServiceCollectionへの拡張メソッドがあるもので登録されるコンポーネントは一端IServiceCollectionに情報を登録し、ユーザコンポーネントは直接カスタムResolverに登録して、最後にSmartResolverHelper.BuildServiceProvider()でマージする形としています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"リクエストスコープ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eリクエストスコープ\u003c/h2\u003e\n\n\u003cp\u003eリクエストスコープに関連して、カスタムIServiceProviderにはIServiceScopeFactoryを解決できることが要件として求められます。\u003c/p\u003e\n\n\u003cp\u003eIServiceScopeFactoryとそれが生成するIServiceScopeを使用して、リクエストスコープのインスタンスが管理されます。\u003c/p\u003e\n\n\u003cp\u003e以下に、Smart.Resolver用の実装を示します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSmartResolverServiceScope.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.Extensions.DependencyInjection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSmartResolverServiceScope\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceScope\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eRequestScopeStorage\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"n\"\u003eServiceProvider\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSmartResolverServiceScope\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRequestScopeStorage\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eServiceProvider\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estorage\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSmartResolverServiceScopeFactory.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.Extensions.DependencyInjection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSmartResolverServiceScopeFactory\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceScopeFactory\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eRequestScopeStorage\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSmartResolverServiceScopeFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRequestScopeStorage\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserviceProvider\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estorage\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceScope\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateScope\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSmartResolverServiceScope\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eIServiceScopeの実装はリクエスト毎にIServiceScopeFactoryから生成されます。\u003c/p\u003e\n\n\u003cp\u003eリクエスト中のコンポーネントは生成されたIServiceScopeのIServiceProviderプロパティから取得され、リクエスト終了時にはDispose()が呼び出されます。\u003c/p\u003e\n\n\u003cp\u003eここにフックを用意することにより、リクエスト間のみ存在するコンポーネントを扱えるようにする、っというのが求められる実装となります。\u003c/p\u003e\n\n\u003cp\u003eSmart.Resolverのスコープ管理は単純な設計となっており、スコープとは、特定のコンテキストに関連づけられたキャッシュのストレージ(ディクショナリ)である、っという考えになっています。\u003c/p\u003e\n\n\u003cp\u003e例えば、シングルトンスコープのストレージは単一のディクショナリであり、スコープ無し(Transient)のストレージはストレージ自体がなしという形になっています。\u003c/p\u003e\n\n\u003cp\u003eそこで、リクエストスコープのストレージとしては、IHttpContextAccessorをDIしてもらい、HttpContextをコンテキストとするRequestScopeStorageを用意しています。\u003c/p\u003e\n\n\u003cp\u003e後は、IServiceScope.Dispose()ではそれをクリアするだけで、リクエストスコープの対応ができる形となっています。\u003c/p\u003e\n\n\u003cp\u003eサンプルでは、ScopedController及びそのIndex.cshtmlにおいて、スコープ管理されるScopedObjectを同一リクエスト中に複数回インジェクションしてもらい、そのインスタンスが同じものであることを確認する例が入っています。\u003c/p\u003e\n\n\u003cp\u003e以下に、サンプルでの使用ケースからコードを抜粋します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003esealed\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eScopedObject\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eILogger\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003elogger\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eScopedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eILogger\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003elogger\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elogger\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elogger\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elogger\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLogInformation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Construct {0}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetHashCode\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elogger\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLogInformation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Dispose {0}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetHashCode\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eSetupComponents\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eresolver\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBind\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToSelf\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInRequestScope\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eScopedController\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e \u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eScopedController\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e \u003cspan class=\"n\"\u003escopedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003escopedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIActionResult\u003c/span\u003e \u003cspan class=\"nf\"\u003eIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eFromServices\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e \u003cspan class=\"n\"\u003escopedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003escopedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInvalidOperationException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Scoped object unmatch.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eScopedObject\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"html\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e@inject DependencyInjectionExample.Services.ScopedObject ScopedObject\n\n\u003cspan class=\"nt\"\u003e\u0026lt;h2\u0026gt;\u003c/span\u003eResult\u003cspan class=\"nt\"\u003e\u0026lt;/h2\u0026gt;\u003c/span\u003e\n@if (Model == ScopedObject)\n{\n    \u003cspan class=\"nt\"\u003e\u0026lt;div\u0026gt;\u003c/span\u003eScoped Lifetime object matched.\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e以下の3つのインスタンスが同一であることを確認できる内容となっています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eScopedControllerにコンストラクタインジェクションされるインスタンス\u003c/li\u003e\n\u003cli\u003eアクションメソッドで[FromServices]によりインジェクションされるインスタンス\u003c/li\u003e\n\u003cli\u003eビューにインジェクションされるインスタンス\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eまた、リクエスト開始時と終了時にはScopedObjectのログ出力も確認でき、インスタンスがリクエスト間のみ生存することを確認できるような内容になっています。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"うさコメ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%86%E3%81%95%E3%82%B3%E3%83%A1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eうさコメ\u003c/h1\u003e\n\n\u003cp\u003eまあ、カスタムResolverとASP.NET Coreを連携させる拡張の作り方とか、ほとんどの人にはいらない知識だと思うんですけどね(´・ω・`)\u003c/p\u003e\n\n\u003cp\u003e高度なDIが必要になったとしても、普通は既存のなにかしらのコンテナを使うと思いますし、AutofacやWindsor等にはここに書いたのと同種の実装携帯による拡張があるようですが。\u003c/p\u003e\n\n\u003cp\u003eっというか、ほとんどのケースでは標準のIServiceProvider推奨だと思います(｀・ω・´)\u003c/p\u003e\n\n\u003cp\u003eそもそも、高度なDIが必要なケースって、例えばサンプルでやっているように複数のデータベース接続を使い分けてインジェクションしてもらいたい、みたいなケースとかだと思いますが。\u003c/p\u003e\n\n\u003cp\u003eその程度であれば、データベース接続のセレクター的なコンポーネントを用意して、それをDIしてもらって、定数かなんかをキーとして使うデータベース接続をそこから取得する、みたいなベタな処理でもいいかという気にもなってくるし(´д｀;)\u003c/p\u003e\n\n\u003cp\u003e標準のIServiceProvider、機能的には基本的な処理しかないけど、性能的には優秀だしね(・∀・;)\u003c/p\u003e\n","createdAt":"2016-12-07T05:11:32Z","elapsedYearsFromLastModifiedAt":4,"encryptedId":"MNB4BqKlJ46xcxFvwifzzfgcempvlo3+--nt4uyvocBFomNPCN--+qeWVkJRKjlv2yDpr2pfGA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2016-12-07T05:24:09Z","likesCount":15,"linkUrl":"https://qiita.com/yamaokunousausa/items/bc81d8498ecf62da0208","organization":null,"originalId":445981,"stockedCount":21,"title":"ASP.NET CoreアプリのDependency Injection処理を別のDIコンテナに委譲する(完全版)","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%84%E3%82%8B%E3%81%93%E3%81%A8\"\u003eやること\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%92%B0%E5%A2%83\"\u003e環境\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB\"\u003eサンプル\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#aspnet-core%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bdi\"\u003eASP.NET CoreにおけるDI\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%83%BC\"\u003eコントローラー\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\"\u003eアクション\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%93%E3%83%A5%E3%83%BC\"\u003eビュー\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%BC\"\u003eフィルター\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96\"\u003eその他\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E7%89%88%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eカスタム版の実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#iserviceprovider%E3%81%AE%E7%BD%AE%E6%8F%9B\"\u003eIServiceProviderの置換\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0iserviceprovider%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eカスタムIServiceProviderの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0iserviceprovider%E3%81%AE%E7%94%9F%E6%88%90\"\u003eカスタムIServiceProviderの生成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97\"\u003eリクエストスコープ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%86%E3%81%95%E3%82%B3%E3%83%A1\"\u003eうさコメ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":6626,"uuid":"bc81d8498ecf62da0208","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"MXWvT8efFamh5L7yiQBXenlOAg==--8Bj5KOCjyzA1DG95--J+GSOIohpVeo0y9833WmIg==","originalId":9645,"description":"","facebookUrl":null,"githubUrl":"https://github.com/usausa","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"うさうさ","profileImageUrl":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/9645/profile-images/1569302036","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F9645%2Fprofile-images%2F1569302036?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=ea4d0860673b2e21d62aac8fb6d33504","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F9645%2Fprofile-images%2F1569302036?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=7b37b0fc5de942529e157bef86c17942","urlName":"yamaokunousausa","websiteUrl":"https://github.com/usausa","twitterUrl":"https://twitter.com/yamaokunousausa","twitterUrlName":"yamaokunousausa","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":".NET","urlName":".net"},{"name":"DependencyInjection","urlName":"dependencyinjection"},{"name":".NETCore","urlName":".netcore"},{"name":"ASP.NET_Core","urlName":"asp.net_core"}],"followingLikers":{"edges":[]},"comments":{"totalCount":2}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
