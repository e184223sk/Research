More than 3 years have passed since last update.ASP.NET Core の WebAPI、JSONのシリアライズは自動でやってくれるわ Swagger への対応も簡単だわ便利ですよね。
と、調子に乗って作っていると例外を捕まえ忘れた時みたいな事になります(UseDeveloperExceptionPageを使わないとステータスコードのみの空ページになりますが)。
やはりエラー時はエラー情報を乗せたJSONを返すようにしたいですよね。
というわけで ExceptionFilter を差し込んで Controller 内で捕まえなかった例外を自動的にエラー用のレスポンスJSONに乗せ換えて返してくれるフィルタのサンプルの作り方です。何の例外が発生しても 500 固定にするならそれはそれでいいんですが、やはりステータスコードやメッセージをある程度制御したい事もあるので、独自の例外を定義します。ExceptionFilterAttribute から派生したフィルタの実装を行います。捕まえた例外の型が APIException だった時はそのステータスコードとメッセージから、APIException 以外だった時はステータスコード 500と、例外のメッセージからレスポンスを作成するようにします。ConfigureServices でフィルタを ServiceCollection に追加し、Controller でフィルタの使用を宣言します。
Controller で処理しない例外があった場合、フィルタで処理したレスポンスのJSONが返されます。サンプルはこちら


