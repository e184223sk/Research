<!DOCTYPE html><html><head><meta charset="utf-8" /><title>【Unity】階層型タスクネットワークを実装してみた【ゲームAI】 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/saragai/items/b53af82bab7cc86f499e" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="p6CEhMS/oUcYTQwhvkekkcLB0sjgAK7AvFE3K6YlTk0yZxZB5a4jg/Gq+hP/K5hJ5fraFgvvjAnOxWKQQeLmOQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="【Unity】階層型タスクネットワークを実装してみた【ゲームAI】 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRVlc1cGRIbmpnSkhwbW83bHNhVGxub3ZqZ3JfamdybmpncV9qZzQzamc0UGpnNGpqZzZfamc3empncV9qZ3BMbHJwX29vNFhqZ1pmamdhYmpnYl9qZ1pfamdKRGpnckxqZzd6amc2QkJTZU9Ba1EmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9Y2JmNjc3YjYzZDI0NWE2MzgzNjQ3OTdmN2ViMDE4NjQ&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5oY21GbllXayZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWRlZDliYTc1ZjlkYWE4Mzk3OGRiZDUwOTg2NjdkYzA2&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=354d503752cc07d5068bce41f9096836"><meta property="og:description" content="

概要

　Unityによって階層型タスクネットワークを実装し、以下のデモのようにプランニングと実行をできるようにします。

　Unityのバージョンは2020.2.0f1です。
　プロジェクトはGitHubに上げておきます。
　h..."><meta content="https://qiita.com/saragai/items/b53af82bab7cc86f499e" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity,ゲームAI,HTN" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-c1512908-338b-41f4-bf4e-3bd49d142076"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fsaragai%2Fitems%2Fb53af82bab7cc86f499e">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fsaragai%2Fitems%2Fb53af82bab7cc86f499e">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-c1512908-338b-41f4-bf4e-3bd49d142076">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-12-24T18:33:48.000+09:00","dateModified":"2021-05-27T17:40:54.000+09:00","headline":"【Unity】階層型タスクネットワークを実装してみた【ゲームAI】","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRVlc1cGRIbmpnSkhwbW83bHNhVGxub3ZqZ3JfamdybmpncV9qZzQzamc0UGpnNGpqZzZfamc3empncV9qZ3BMbHJwX29vNFhqZ1pmamdhYmpnYl9qZ1pfamdKRGpnckxqZzd6amc2QkJTZU9Ba1EmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9Y2JmNjc3YjYzZDI0NWE2MzgzNjQ3OTdmN2ViMDE4NjQ\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5oY21GbllXayZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWRlZDliYTc1ZjlkYWE4Mzk3OGRiZDUwOTg2NjdkYzA2\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=354d503752cc07d5068bce41f9096836","mainEntityOfPage":"https://qiita.com/saragai/items/b53af82bab7cc86f499e","author":{"@type":"Person","address":"Tokyo, Japan","email":null,"identifier":"saragai","name":"saragai","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F189786%2Fprofile-images%2F1498789786?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9d1f06bc9a3b7a50e5f15d582ddd20a9","url":"https://qiita.com/saragai","description":"都内にいます","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">CTO業務を積極的に権限移譲するユーザベースの開発組織とは</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"saragai","type":"items","id":"b53af82bab7cc86f499e"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"saragai","type":"items","id":"b53af82bab7cc86f499e"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"saragai","type":"items","id":"b53af82bab7cc86f499e"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/saragai/items/b53af82bab7cc86f499e","location":"/saragai/items/b53af82bab7cc86f499e","scheme":"https","host":"qiita.com","port":null,"pathname":"/saragai/items/b53af82bab7cc86f499e","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"qOgP8tZS59C3z+SwafYJ8aWNDi57b4EUgBZgoGdva5s9L50390NlFF4oEoIomjUpgrYG8JCAo93ygjUbgKjD7w==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-5aa98566-09f8-4c3a-b153-74f3c2d3d777"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/saragai/items/b53af82bab7cc86f499e/likers" class="css-1iupg5d">13</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">7</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/b53af82bab7cc86f499e/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/saragai/items/b53af82bab7cc86f499e/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/saragai/items/b53af82bab7cc86f499e/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/saragai/items/b53af82bab7cc86f499e/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/saragai/items/b53af82bab7cc86f499e.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2020/unity2" class="it-AdcalRibbon_title">Unity #2<!-- --> Advent Calendar<!-- --> <!-- -->2020</a>Day 21</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/saragai"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/189786/profile-images/1498789786" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/saragai" class="css-10ougpm">@<!-- -->saragai</a><div class="css-1ay9vb9"><span><meta content="2020-12-24T09:33:48Z"/><time dateTime="2021-05-27T08:40:54Z" class="css-m19uds">updated at 2021-05-27</time></span></div></div></div></div></div><h1 class="css-cgzq40">【Unity】階層型タスクネットワークを実装してみた【ゲームAI】</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/%e3%82%b2%e3%83%bc%e3%83%a0ai" class="css-4czcte">ゲームAI</a><a href="/tags/htn" class="css-4czcte">HTN</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p>　Unityによって階層型タスクネットワークを実装し、以下のデモのようにプランニングと実行をできるようにします。<br>
<a href="https://camo.qiitausercontent.com/ac659e3ccceeef0658b9e48c224fdf8c563eb905/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f39613964383864632d396131372d353836342d363638632d3538633835333163663234372e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F9a9d88dc-9a17-5864-668c-58c8531cf247.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=291c53b887cb661bfda5076154c78e01" alt="anim.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/9a9d88dc-9a17-5864-668c-58c8531cf247.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F9a9d88dc-9a17-5864-668c-58c8531cf247.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f12045ca0515f056f3079b3ddeec03ec 1x" loading="lazy"></a><br>
　Unityのバージョンは2020.2.0f1です。<br>
　プロジェクトはGitHubに上げておきます。<br>
　<a href="https://github.com/saragai/SimpleHTN" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/saragai/SimpleHTN</a><br>
（イラストの再配布を防ぐために画像がMissingになっています）</p>

<h1>
<span id="階層型タスクネットワークとは" class="fragment"></span><a href="#%E9%9A%8E%E5%B1%A4%E5%9E%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>階層型タスクネットワークとは</h1>

<p>　英語では<strong>Hierarchical Task Network</strong>と呼ばれます。以下<strong>HTN</strong>と呼びます。<br>
　<strong>HTN</strong>はその名の通り、<strong>タスク</strong>を<strong>階層的</strong>に組み合わせて作られるネットワークのことです。<br>
　<strong>HTN</strong>はゲームAIの<strong>プランニング</strong>に用いられます。</p>

<h3>
<span id="プランニングとは" class="fragment"></span><a href="#%E3%83%97%E3%83%A9%E3%83%B3%E3%83%8B%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>プランニングとは</h3>

<p>　プランニングとは、<strong>何らかの目標に対して、どの行動をどの順序で行うべきかをあらかじめ考えること</strong>です。</p>

<p>　例えば、現在家にいて、「<strong>新宿駅へ行く</strong>」という目標を立てたとします。<br>
　この目標は、最寄り駅が池袋駅だとすると</p>

<ul>
<li>「<strong>家を出る</strong> → <strong>池袋駅まで歩く</strong> → <strong>電車に乗る</strong>」</li>
</ul>

<p>のような方法で実現できるとします。<br>
　しかし、電車で行くとするとお金が必要ですが、お金が手元にないとしたらどうでしょうか。その場合は,</p>

<ul>
<li>「<strong>家を出る</strong> → <strong>銀行まで歩く</strong> -&gt; <strong>お金を下ろす</strong> -&gt; <strong>池袋駅まで歩く</strong> → <strong>電車に乗る</strong>」</li>
</ul>

<p>とする必要があります。また、足を骨折していた場合は</p>

<ul>
<li>「<strong>タクシーを呼ぶ</strong> -&gt; <strong>家を出る</strong> -&gt; <strong>池袋駅までタクシーで行く</strong> → <strong>電車に乗る</strong>」</li>
</ul>

<p>のような方法をとる必要があり、この場合はさらにお金が多く必要になります。</p>

<p>　ゲームAIとしてよく用いられる<strong>FSM</strong>や<strong>BehaviorTree</strong>などは、行動を決定する際に現在の状況しか見ることができません。<br>
　しかし、上の例のようにどのようなルートを通るかで、必要なお金は変わります。その場合、「<strong>お金が足りるか</strong>」という条件を確かめるだけでも今から行うであろう行動を想定して手動で設定しなければならず、条件分岐が大量に必要になります。</p>

<p>　しかし、目標達成までに行うべき行動をあらかじめ列挙<strong>(=プランニング)</strong>できれば、「<strong>お金が足りるか</strong>」はおのずとわかるはずです。<br>
　ここで、プランニングを行う際には、<strong>その行動に必要な条件</strong>と<strong>行動の影響</strong>がわかっている必要があります。例えば、電車に乗るのであれば、必要な条件は「運賃260円を持っている」であり、行動の影響は「所持金が260円減る・自分のいる場所が池袋から新宿にかわる」です。<br>
　これらの条件を行動自体と合わせてまとめたものを、<strong>タスク</strong>と呼びます。</p>

<h3>
<span id="タスクとは" class="fragment"></span><a href="#%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>タスクとは</h3>

<p>　改めてまとめます。HTNにおいて、<strong>タスク</strong>は以下の情報を持ちます。</p>

<ul>
<li><strong>必要な条件</strong></li>
<li><strong>実際にする行動</strong></li>
<li><strong>行動した際の影響</strong></li>
</ul>

<p>　<strong>必要な条件</strong>と<strong>行動した際の影響</strong>がまさにプランニングに必要な要素です。この情報のおかげで実際に行動しなくても仮想的に行動の結果がわかってシミュレーションが可能になります。<br>
　この二つは、どちらも<strong>WorldState</strong>と呼ばれる世界の状態を参照します。<br>
　プランニングの際は、現在の<strong>WorldState</strong>のコピーを作成し、仮想的にタスクを実行して<strong>WorldState</strong>のコピーを更新していくことでシミュレーションを行います。</p>

<h3>
<span id="階層的とは" class="fragment"></span><a href="#%E9%9A%8E%E5%B1%A4%E7%9A%84%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>階層的とは</h3>

<p>　タスクには様々な粒度があります。<br>
　先ほどの例のように<strong>「新宿駅へ行く」</strong>はタスクですが、これは<strong>「家を出る」</strong><strong>「池袋駅まで行く」</strong><strong>「電車に乗る」</strong>などのタスクに分解できます。さらに<strong>「家を出る」</strong>は<strong>「靴を履く」</strong><strong>「ドアを開ける」</strong><strong>「鍵を閉める」</strong>へと分解できるでしょう。<br>
　逆に言うと、<strong>「靴を履く」</strong>というような細かい<strong>具体的なタスク</strong>をまとめることによって<strong>「新宿駅へ行く」</strong>という<strong>抽象的なタスク</strong>にして扱いやすくできるのです。</p>

<p>　また、<strong>抽象的なタスク</strong>には複数の表現方法があることも述べました。</p>

<ul>
<li>「<strong>タクシーを呼ぶ</strong> -&gt; <strong>家を出る</strong> -&gt; <strong>池袋駅までタクシーで行く</strong> → <strong>電車に乗る</strong>」</li>
<li>「<strong>家を出る</strong> → <strong>銀行まで歩く</strong> -&gt; <strong>お金を下ろす</strong> -&gt; <strong>池袋駅まで歩く</strong> → <strong>電車に乗る</strong>」</li>
</ul>

<p>　この二つの方法の内容に差異はありますが、どちらの分解方法を選んだとしても最終的に目的は達成できるため、同一のタスクとして扱われるべきです。</p>

<p>　このような前提から上で述べた<strong>タスク</strong>をまとめた<strong>複合タスク</strong>を考えることができます。<br>
　<strong>複合タスク</strong>は、<strong>「目的を達成するための一連のタスク」</strong>と<strong>「一連のタスクを選ぶための条件」</strong>のセットを<strong>複数</strong>持つものとします。<br>
　この『<strong>「目的を達成するための一連のタスク」</strong>と<strong>「一連のタスクを選ぶための条件」</strong>のセット』は<strong>Method</strong>と呼ばれます。</p>

<p>　この<strong>複合タスク</strong>も、以下のように確かに<strong>タスク</strong>の要件を満たすため、<strong>タスク</strong>と同様に扱うことが可能になっています。</p>

<ul>
<li>
<strong>必要な条件</strong>：Methodを選ぶための条件と、選ばれたMethodが持つ一連のタスクに必要な条件</li>
<li>
<strong>実際にする行動</strong>：選ばれたMethodの持つ一連のタスクの実際にする行動</li>
<li>
<strong>行動した際の影響</strong>：選ばれたMethodの持つ一連のタスクを実行したときの影響</li>
</ul>

<p>　この<strong>複合タスク</strong>を導入することによって、<strong>タスク</strong>を<strong>階層的</strong>に扱うことができるようになります。</p>

<h1>
<span id="用語" class="fragment"></span><a href="#%E7%94%A8%E8%AA%9E"><i class="fa fa-link"></i></a>用語</h1>

<p>　ここまでで<strong>HTN</strong>に必要な一通りの要素を解説しました。実装に移る前に用語を整理しておきます。</p>

<ul>
<li>
<p><strong>Primitive Task</strong>: <strong>最も基本的なタスク</strong>のこと</p>

<ul>
<li>
<strong>Condition</strong>: <strong>必要な条件</strong>のこと</li>
<li>
<strong>Operator</strong>: <strong>実際にする行動</strong>のこと</li>
<li>
<strong>Effect</strong>: <strong>行動したときの影響</strong>のこと</li>
</ul>
</li>
<li>
<p><strong>Compound Task</strong>: <strong>複合タスク</strong>のこと</p>

<ul>
<li>
<strong>Method</strong>: Conditionと一連のタスクのセット

<ul>
<li>
<strong>Sub Task</strong>: 一連のタスク</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>World State</strong>: 世界の状態。タスクの条件や影響で参照される</p></li>
<li>
<p><strong>Planner</strong>: タスクを一つ設定し、プランニングして実行する行動の順列を割り出すひと</p>

<ul>
<li>
<strong>Root Task</strong>: プランニングしたいタスク</li>
</ul>
</li>
<li><p><strong>Plan Runner</strong>: プランを実行するひと</p></li>
</ul>

<h1>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h1>

<h3>
<span id="一般的な実装" class="fragment"></span><a href="#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>一般的な実装</h3>

<p>　HTNを解説している記事はたくさんありますが、どれも<a href="http://www.gameaipro.com/GameAIPro/GameAIPro_Chapter12_Exploring_HTN_Planners_through_Example.pdf" rel="nofollow noopener" target="_blank">Game AI Pro 12</a>を参考にしているようです。<br>
　以下に疑似コードを引用します。</p>

<div class="code-frame" data-lang="C"><div class="highlight"><pre><code><span class="n">WorkingWS</span> <span class="o">=</span> <span class="n">CurrentWorldState</span>
<span class="n">TasksToProcess</span><span class="p">.</span><span class="n">Push</span><span class="p">(</span><span class="n">RootTask</span><span class="p">)</span>
<span class="k">while</span> <span class="n">TasksToProcess</span><span class="p">.</span><span class="n">NotEmpty</span>
<span class="p">{</span>
    <span class="n">CurrentTask</span> <span class="o">=</span> <span class="n">TasksToProcess</span><span class="p">.</span><span class="n">Pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">CurrentTask</span><span class="p">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">CompoundTask</span>
    <span class="p">{</span>
        <span class="n">SatisfiedMethod</span> <span class="o">=</span> <span class="n">CurrentTask</span><span class="p">.</span><span class="n">FindSatisfiedMethod</span><span class="p">(</span><span class="n">WorkingWS</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">SatisfiedMethod</span> <span class="o">!=</span> <span class="n">null</span>
        <span class="p">{</span>
            <span class="n">RecordDecompositionOfTask</span><span class="p">(</span><span class="n">CurrentTask</span><span class="p">,</span> <span class="n">FinalPlan</span><span class="p">,</span> <span class="n">DecompHistory</span><span class="p">)</span> 
            <span class="n">TasksToProcess</span><span class="p">.</span><span class="n">InsertTop</span><span class="p">(</span><span class="n">SatisfiedMethod</span><span class="p">.</span><span class="n">SubTasks</span><span class="p">)</span> 
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">RestoreToLastDecomposedTask</span><span class="p">()</span> 
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="c1">//Primitive Task</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="n">PrimitiveConditionMet</span><span class="p">(</span><span class="n">CurrentTask</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">WorkingWS</span><span class="p">.</span><span class="n">ApplyEffects</span><span class="p">(</span><span class="n">CurrentTask</span><span class="p">.</span><span class="n">Effects</span><span class="p">)</span>
            <span class="n">FinalPlan</span><span class="p">.</span><span class="n">PushBack</span><span class="p">(</span><span class="n">CurrentTask</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">RestoreToLastDecomposedTask</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>　これについて軽く解説をします。<br>
　はじめに処理スタックに<code>RootTask</code>を積み、以下の処理を処理スタックが空になるまで繰り返します。</p>

<ul>
<li>処理スタックに乗っているタスクを取り出して、<code>CompoundTask</code>か<code>PrimitiveTask</code>かで場合分ける

<ul>
<li>
<code>CompoundTask</code>であれば、実行できる<code>Method</code>があるか確認して、あれば<code>SubTasks</code>を再び処理スタックに積む</li>
<li>
<code>PrimitiveTask</code>であれば、実行できるか確認して、実行できるならプランにそのタスクを加える</li>
</ul>
</li>
<li>どちらの場合でも、失敗したら最後に<code>CompoundTask</code>を展開したときまで状態を差し戻す</li>
</ul>

<p><strong>……なんかちょっと気になりませんか？</strong><br>
　気になるポイントは二点あります</p>

<ul>
<li>
<strong>CompoundTask</strong>か<strong>PrimitiveTask</strong>かで場合分けしているのが気持ち悪い</li>
<li>最後に展開したときまで状態を差し戻すというのが分かりづらく、今何をしているのか混乱する</li>
</ul>

<p>　個人的な理解としては<strong>CompoundTask</strong>は<strong>PrimitiveTask</strong>の拡張なので、同じインターフェースによって統一的に扱えるのではないかと思いました。また、スタックに新たなタスクがどんどん積まれていく中で、「最後に<strong>CompoundTask</strong>を展開した時まで戻す」がどういう挙動になるのかちょっと想像しにくい気がしました。</p>

<p>　もちろんそのまま組んで悪いことは全然ないのですが、そのままの実装については他の記事でもたくさん実装例があるのでちょっと変えてみようと思います。<br>
　気になるポイントへの対処としてはそれぞれ、</p>

<ul>
<li>
<strong>Task</strong>をインターフェースで扱って、<strong>CompoundTask</strong>と<strong>PrimitiveTask</strong>の処理の違いはそれぞれのTask側に実装する</li>
<li>スタックではなく再帰によって階層を実現する</li>
</ul>

<p>です。</p>

<h3>
<span id="インターフェース--再帰による実装" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9--%E5%86%8D%E5%B8%B0%E3%81%AB%E3%82%88%E3%82%8B%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>インターフェース &amp; 再帰による実装</h3>

<p>　<strong>CompoundTask</strong>と<strong>PrimitiveTask</strong>はともに<code>ITask</code>インターフェースを実装します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">ITask</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="nf">TryPlanTask</span><span class="p">(</span><span class="n">WorldState</span> <span class="n">state</span><span class="p">,</span> <span class="k">ref</span> <span class="n">Plan</span> <span class="n">plan</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>　唯一のメソッド<code>TryPlanTask()</code>は、<code>WorldState</code>を受け取ってタスクを実行できるか確認し、実行できるなら<code>Plan</code>に追加していきます。このメソッドの中で<code>WorldState</code>も更新していくことにします。</p>

<p>　また、本筋ではないですが、Unityを使った開発ではTaskの設定のために<code>ScriptableOject</code>を使うのではないかと思うので、<code>ScriptableOject</code>を継承した抽象クラスも間に挟みます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Task</span> <span class="p">:</span> <span class="n">ScriptableObject</span><span class="p">,</span> <span class="n">ITask</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">abstract</span> <span class="kt">bool</span> <span class="nf">TryPlanTask</span><span class="p">(</span><span class="n">WorldState</span> <span class="n">state</span><span class="p">,</span> <span class="k">ref</span> <span class="n">Plan</span> <span class="n">plan</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>それぞれ、以下のように実装します。</p>

<h4>
<span id="primitive-taskの実装" class="fragment"></span><a href="#primitive-task%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Primitive Taskの実装</h4>

<p>　これは何のひねりもなく、ただ<strong>Condition</strong>を満たしていたら<strong>WorldState</strong>を<strong>Effect</strong>で更新し、プランに<strong>Operator</strong>を加えているだけです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="p">[</span><span class="nf">CreateAssetMenu</span><span class="p">(</span><span class="n">fileName</span> <span class="p">=</span><span class="s">"primitive_task.asset"</span><span class="p">,</span> <span class="n">menuName</span> <span class="p">=</span> <span class="s">"Primitive Task"</span><span class="p">,</span> <span class="n">order</span> <span class="p">=</span> <span class="m">0</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">PrimitiveTask</span> <span class="p">:</span> <span class="n">Task</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Condition</span><span class="p">&gt;</span> <span class="n">m_Preconditions</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">Operator</span><span class="p">.</span><span class="n">Operator</span> <span class="n">m_Operator</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Effect</span><span class="p">&gt;</span> <span class="n">m_Effects</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">TryPlanTask</span><span class="p">(</span><span class="n">WorldState</span> <span class="n">state</span><span class="p">,</span> <span class="k">ref</span> <span class="n">Plan</span> <span class="n">plan</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">condition</span> <span class="k">in</span> <span class="n">m_Preconditions</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">condition</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">effect</span> <span class="k">in</span> <span class="n">m_Effects</span><span class="p">)</span>
            <span class="n">effect</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

        <span class="n">plan</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="n">m_Operator</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h4>
<span id="compound-taskの実装" class="fragment"></span><a href="#compound-task%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Compound Taskの実装</h4>

<p>　ここで再帰が出てきます。<br>
　階層は<strong>CompoundTask</strong>が<strong>Method</strong>を介してサブタスクの<code>TryPlanTask()</code>を呼んで再帰することで実現しています。<br>
　再帰で実装すると、「現在の状況を保存する場所」と「その状況に戻す場所」が近く、二つの対応が一目でわかるようになります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="p">[</span><span class="nf">CreateAssetMenu</span><span class="p">(</span><span class="n">fileName</span> <span class="p">=</span><span class="s">"compound_task.asset"</span><span class="p">,</span> <span class="n">menuName</span> <span class="p">=</span> <span class="s">"Compound Task"</span><span class="p">,</span> <span class="n">order</span> <span class="p">=</span> <span class="m">1</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CompoundTask</span> <span class="p">:</span> <span class="n">Task</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Method</span><span class="p">&gt;</span> <span class="n">m_Methods</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">TryPlanTask</span><span class="p">(</span><span class="n">WorldState</span> <span class="n">state</span><span class="p">,</span> <span class="k">ref</span> <span class="n">Plan</span> <span class="n">plan</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">method</span> <span class="k">in</span> <span class="n">m_Methods</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 実行するタスクを見つける</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">method</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 現在のplanを保存</span>
            <span class="kt">var</span> <span class="n">currentPlan</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Plan</span><span class="p">(</span><span class="n">plan</span><span class="p">);</span>

            <span class="c1">// サブタスクを行う</span>
            <span class="k">if</span><span class="p">(!</span><span class="n">method</span><span class="p">.</span><span class="nf">TryPlanSubTasks</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="k">ref</span> <span class="n">plan</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">// 失敗したときplanを元に戻す</span>
                <span class="n">plan</span> <span class="p">=</span> <span class="n">currentPlan</span><span class="p">;</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// サブタスクが全て完了したので成功</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 条件を満たすメソッドがなかったので失敗</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4>
<span id="methodの実装" class="fragment"></span><a href="#method%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Methodの実装</h4>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Method</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Condition</span><span class="p">&gt;</span> <span class="n">m_Conditions</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;</span> <span class="n">m_SubTasks</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Match</span><span class="p">(</span><span class="n">WorldState</span> <span class="n">state</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">condition</span> <span class="k">in</span> <span class="n">m_Conditions</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">condition</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">TryPlanSubTasks</span><span class="p">(</span><span class="n">WorldState</span> <span class="n">state</span><span class="p">,</span> <span class="k">ref</span> <span class="n">Plan</span> <span class="n">plan</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">task</span> <span class="k">in</span> <span class="n">m_SubTasks</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(!</span><span class="n">task</span><span class="p">.</span><span class="nf">TryPlanTask</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="k">ref</span> <span class="n">plan</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>　このようにすることで<strong>Planner</strong>のコードはとてもシンプルになります。</p>

<h4>
<span id="plannerの実装" class="fragment"></span><a href="#planner%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Plannerの実装</h4>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">HTNPlanner</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="n">WorldStateHolder</span> <span class="n">m_WorldStateHolder</span><span class="p">;</span>

    <span class="n">Plan</span> <span class="n">m_Plan</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">m_Plan</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Plan</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Plan</span> <span class="nf">DoPlan</span><span class="p">(</span><span class="n">ITask</span> <span class="n">rootTask</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_Plan</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>

        <span class="c1">// WorldStateのコピーを取って自由に書き換えられるようにする</span>
        <span class="kt">var</span> <span class="n">tmpState</span> <span class="p">=</span> <span class="n">m_WorldStateHolder</span><span class="p">.</span><span class="n">WorldState</span><span class="p">.</span><span class="nf">CreateCopy</span><span class="p">();</span>
        <span class="n">rootTask</span><span class="p">.</span><span class="nf">TryPlanTask</span><span class="p">(</span><span class="n">tmpState</span><span class="p">,</span> <span class="k">ref</span> <span class="n">m_Plan</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">m_Plan</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>　ここで<code>WorldState</code>ではなく<code>WorldStateHolder</code>を介しているのは、<code>WorldState</code>を<code>MonoBehaviour</code>にしたくないからです。<code>WorldState</code>を<code>MonoBehavior</code>にしてしまうとコピーを気軽にInstantiateできなくなってしまいます。</p>

<h4>
<span id="planの実装" class="fragment"></span><a href="#plan%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Planの実装</h4>

<p><strong>Operator</strong>を表すインターフェース<strong>IOperator</strong>を要素とする<strong>Queue</strong>の簡素なラッパークラスになっています。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Plan</span>
<span class="p">{</span>
    <span class="n">Queue</span><span class="p">&lt;</span><span class="n">IOperator</span><span class="p">&gt;</span> <span class="n">m_Operators</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IOperator</span><span class="p">&gt;</span> <span class="n">Operators</span> <span class="p">=&gt;</span> <span class="n">m_Operators</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">Plan</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">m_Operators</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">IOperator</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">Plan</span><span class="p">(</span><span class="n">Plan</span> <span class="n">other</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_Operators</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">IOperator</span><span class="p">&gt;(</span><span class="n">other</span><span class="p">.</span><span class="n">m_Operators</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Clear</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">m_Operators</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Enqueue</span><span class="p">(</span><span class="n">IOperator</span> <span class="n">@operator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_Operators</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="n">@operator</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1>
<span id="デモの実装" class="fragment"></span><a href="#%E3%83%87%E3%83%A2%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>デモの実装</h1>

<p>ここからはデモ用の実装をしながら、ここまで解説なしで出していたクラスについても説明します。<br>
そのため、少し具体的な実装になってしまっています。本来はまだもっと抽象化すべきだと思うのですが、デモを兼ねているということで少し手を抜きました。</p>

<h3>
<span id="デモの状況" class="fragment"></span><a href="#%E3%83%87%E3%83%A2%E3%81%AE%E7%8A%B6%E6%B3%81"><i class="fa fa-link"></i></a>デモの状況</h3>

<p>状態の種類とタスクについてはこのスライドを参考にしています<br>
<a href="https://www.slideshare.net/dena_genom/gdm37aileft-alive" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/dena_genom/gdm37aileft-alive</a></p>

<p><strong>WorldState</strong>の種類は<strong>enum</strong>で指定、値は<strong>bool</strong>のみとします。<br>
ここでは状態は</p>

<ul>
<li>空腹か</li>
<li>金を持っているか</li>
<li>食べ物を持っているか</li>
</ul>

<p>のみとします。</p>

<p><strong>Primitive Task</strong>は</p>

<ul>
<li>働く（金を得る）</li>
<li>食べ物を買う（金を使って食べ物を得る）</li>
<li>食べ物を食べる（食べ物を使って空腹を満たす）</li>
</ul>

<p><strong>Compound Task</strong>は</p>

<ul>
<li>食事をする</li>
</ul>

<p>として、どのような状況でも食べ物を食べるまで行きつくように<strong>Method</strong>を設定します。</p>

<p><strong>Operator</strong>で指定される実際の行動は、移動のみとします。</p>

<h4>
<span id="worldstateの実装" class="fragment"></span><a href="#worldstate%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>WorldStateの実装</h4>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">WorldState</span>
<span class="p">{</span>
    <span class="c1">/// 状態の種類</span>
    <span class="k">public</span> <span class="k">enum</span> <span class="n">TYPE</span>
    <span class="p">{</span>
        <span class="n">IsHungry</span><span class="p">,</span>
        <span class="n">HaveMoney</span><span class="p">,</span>
        <span class="n">HaveMeal</span><span class="p">,</span>

        <span class="n">MaxCount</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">NumStates</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">TYPE</span><span class="p">.</span><span class="n">MaxCount</span><span class="p">;</span>

    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span>
    <span class="k">private</span> <span class="kt">bool</span><span class="p">[]</span> <span class="n">m_States</span><span class="p">;</span>

    <span class="c1">/// コンストラクタ</span>
    <span class="k">public</span> <span class="nf">WorldState</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">m_States</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">bool</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">TYPE</span><span class="p">.</span><span class="n">MaxCount</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">/// 種類と値を指定して状態を設定</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Set</span><span class="p">(</span><span class="n">TYPE</span> <span class="n">type</span><span class="p">,</span> <span class="kt">bool</span> <span class="k">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_States</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">type</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// 種類を指定して状態の値を取得</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Get</span><span class="p">(</span><span class="n">TYPE</span> <span class="n">type</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">m_States</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">type</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">/// 自身を複製する（プランニングの際に必要）</span>
    <span class="k">public</span> <span class="n">WorldState</span> <span class="nf">CreateCopy</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">copy</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WorldState</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">NumStates</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">copy</span><span class="p">.</span><span class="n">m_States</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">m_States</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Condition</strong>は、<strong>WorldState</strong>の種類を指定して、その真偽を問い合わせます。<br>
<strong>Effect</strong>は、<strong>WorldState</strong>の種類を指定して、その真偽を設定します。</p>

<h4>
<span id="conditionの実装" class="fragment"></span><a href="#condition%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Conditionの実装</h4>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Condition</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">WorldState</span><span class="p">.</span><span class="n">TYPE</span> <span class="n">m_Type</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="kt">bool</span> <span class="n">m_Value</span><span class="p">;</span>

    <span class="c1">/// 状態を指定して条件を満たすか判断する</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Match</span><span class="p">(</span><span class="n">WorldState</span> <span class="n">state</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">m_Type</span><span class="p">)</span> <span class="p">==</span> <span class="n">m_Value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4>
<span id="effectの実装" class="fragment"></span><a href="#effect%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Effectの実装</h4>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Effect</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">WorldState</span><span class="p">.</span><span class="n">TYPE</span> <span class="n">m_Type</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="kt">bool</span> <span class="n">m_Value</span><span class="p">;</span>

    <span class="c1">/// 状態を指定して、新たな状態を設定する</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ApplyTo</span><span class="p">(</span><span class="n">WorldState</span> <span class="n">state</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">state</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="n">m_Type</span><span class="p">,</span> <span class="n">m_Value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4>
<span id="operatorの実装" class="fragment"></span><a href="#operator%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Operatorの実装</h4>

<p>　<strong>Operator</strong>は、用途を考えると多種多様なものが必要になりそうなものなので、少し抽象化します。</p>

<p>　<strong>Operator</strong>を<strong>Plan Runner</strong>が実行するとき、個々の<strong>Operator</strong>が何をするかを考えたくはありません。しかし、<strong>Operator</strong>には実行対象を渡さないといけないため、実行時は<strong>IOperatable</strong>というインターフェースを引数で渡すことにします。</p>

<p>　また、<strong>Operator</strong>は<strong>Planner</strong>においてはプランニングのキューに入るだけですが、<strong>Plan Runner</strong>が実行するときに実際に実行するときはある程度時間がかかるものが多いと思います。そのため、コルーチンで実装します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code>
<span class="c1">// 操作対象</span>
<span class="k">public</span> <span class="k">interface</span> <span class="nc">IOperatable</span>
<span class="p">{</span>
    <span class="n">Transform</span> <span class="n">Transform</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 操作</span>
<span class="k">public</span> <span class="k">interface</span> <span class="nc">IOperator</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">OperatorName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">IEnumerator</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">IOperatable</span> <span class="n">operatable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Operator</span> <span class="p">:</span> <span class="n">ScriptableObject</span><span class="p">,</span> <span class="n">IOperator</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="kt">string</span> <span class="n">m_OperatorName</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">OperatorName</span> <span class="p">=&gt;</span> <span class="n">m_OperatorName</span><span class="p">;</span>

    <span class="c1">/// 操作を実行</span>
    <span class="k">public</span> <span class="k">abstract</span> <span class="n">IEnumerator</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">IOperatable</span> <span class="n">operatable</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h5>
<span id="move-to-operator-operatorの具象クラス" class="fragment"></span><a href="#move-to-operator-operator%E3%81%AE%E5%85%B7%E8%B1%A1%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>Move To Operator (Operatorの具象クラス）</h5>

<p>　行きたい場所を指定してそこまで直進する<strong>Operator</strong>とします。<br>
　場所はとりあえず<strong>PlaceManager</strong>というシングルトンを作ってそこから取っていますが、細かいところなので適当です。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="p">[</span><span class="nf">CreateAssetMenu</span><span class="p">(</span><span class="n">fileName</span> <span class="p">=</span><span class="s">"move_to_operator.asset"</span><span class="p">,</span> <span class="n">menuName</span> <span class="p">=</span> <span class="s">"Operator/Move To"</span><span class="p">,</span> <span class="n">order</span> <span class="p">=</span> <span class="m">0</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">MoveToOperator</span><span class="p">:</span> <span class="n">Operator</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">PlaceManager</span><span class="p">.</span><span class="n">PLACE</span> <span class="n">m_Place</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="kt">float</span> <span class="n">m_Velocity</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">override</span> <span class="n">IEnumerator</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">IOperatable</span> <span class="n">operatable</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">targetPos</span> <span class="p">=</span> <span class="n">PlaceManager</span><span class="p">.</span><span class="nf">GetPosition</span><span class="p">(</span><span class="n">m_Place</span><span class="p">);</span>

        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">transform</span> <span class="p">=</span> <span class="n">operatable</span><span class="p">.</span><span class="n">Transform</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">dir</span> <span class="p">=</span> <span class="n">targetPos</span> <span class="p">-</span> <span class="p">(</span><span class="n">Vector2</span><span class="p">)</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">magnitude</span> <span class="p">&lt;</span> <span class="m">0.1f</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">dir</span><span class="p">.</span><span class="nf">Normalize</span><span class="p">();</span>

            <span class="c1">// 動かす</span>
            <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">+=</span> <span class="p">(</span><span class="n">Vector3</span><span class="p">)(</span> <span class="n">m_Velocity</span> <span class="p">*</span> <span class="n">dir</span> <span class="p">*</span> <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">);</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4>
<span id="plan-runnerの実装" class="fragment"></span><a href="#plan-runner%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Plan Runnerの実装</h4>

<p><strong>Planner</strong>に<strong>Root Task</strong>を渡して、受け取った<strong>IOperator</strong>のキューに入っている<strong>Execute</strong>を順番に呼んでいきます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">HTNPlanRunner</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">HTNPlanner</span> <span class="n">m_Planner</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">Operatable</span> <span class="n">m_Operatable</span><span class="p">;</span>

    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">Task</span> <span class="n">m_Task</span><span class="p">;</span>

    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="kt">float</span> <span class="n">m_ReplanningInterval</span> <span class="p">=</span> <span class="m">1f</span><span class="p">;</span>

    <span class="n">List</span><span class="p">&lt;</span><span class="n">IEnumerator</span><span class="p">&gt;</span> <span class="n">m_RunningCoroutines</span><span class="p">;</span>

    <span class="c1">// Start is called before the first frame update</span>
    <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">m_RunningCoroutines</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IEnumerator</span><span class="p">&gt;();</span>
        <span class="nf">StartCoroutine</span><span class="p">(</span><span class="nf">SetTaskRoutine</span><span class="p">(</span><span class="n">m_Task</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">IEnumerator</span> <span class="nf">SetTaskRoutine</span><span class="p">(</span><span class="n">ITask</span> <span class="n">task</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 一定時間ごとにリプランニング</span>
            <span class="nf">SetTask</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="nf">WaitForSeconds</span><span class="p">(</span><span class="n">m_ReplanningInterval</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">SetTask</span><span class="p">(</span><span class="n">ITask</span> <span class="n">task</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">StopCoroutine</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">plan</span> <span class="p">=</span> <span class="n">m_Planner</span><span class="p">.</span><span class="nf">DoPlan</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
        <span class="nf">StartPlan</span><span class="p">(</span><span class="n">plan</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// プランの実行を開始</span>
    <span class="k">void</span> <span class="nf">StartPlan</span><span class="p">(</span><span class="n">Plan</span> <span class="n">plan</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">coroutine</span> <span class="p">=</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">plan</span><span class="p">.</span><span class="n">Operators</span><span class="p">);</span>
        <span class="n">m_RunningCoroutines</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">coroutine</span><span class="p">);</span>

        <span class="nf">StartCoroutine</span><span class="p">(</span><span class="n">coroutine</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// 進行中のコルーチンを止める</span>
    <span class="k">void</span> <span class="nf">StopCoroutine</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">coroutine</span> <span class="k">in</span> <span class="n">m_RunningCoroutines</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">StopCoroutine</span><span class="p">(</span><span class="n">coroutine</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">m_RunningCoroutines</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">IEnumerator</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IOperator</span><span class="p">&gt;</span> <span class="n">operators</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">@operator</span> <span class="k">in</span> <span class="n">operators</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">action</span> <span class="p">=</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">@operator</span><span class="p">);</span>
            <span class="n">m_RunningCoroutines</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="nf">StartCoroutine</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">IEnumerator</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">IOperator</span> <span class="n">@operator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">action</span> <span class="p">=</span> <span class="n">@operator</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">m_Operatable</span><span class="p">);</span>
        <span class="n">m_RunningCoroutines</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="nf">StartCoroutine</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1>
<span id="デモの設定" class="fragment"></span><a href="#%E3%83%87%E3%83%A2%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>デモの設定</h1>

<p>　上で<strong>Primitive Task</strong>は</p>

<ul>
<li>働く（金を得る）</li>
<li>食べ物を買う（金を使って食べ物を得る）</li>
<li>食べ物を食べる（食べ物を使って空腹を満たす）</li>
</ul>

<p>の3つと言いました。それぞれ以下のように設定します。<br>
・<code>働く</code><br>
<a href="https://camo.qiitausercontent.com/4a442ed0c1420d6075b7f6791af9bf075e4ba93d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31636636353864332d393832632d303037342d616534302d6632313136313830376537662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1cf658d3-982c-0074-ae40-f21161807e7f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a3f0c1d762b401f1d5349b81ec5352eb" alt="htn4.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/1cf658d3-982c-0074-ae40-f21161807e7f.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1cf658d3-982c-0074-ae40-f21161807e7f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=662d16b9b7f71b6db000fd43034e78ad 1x" loading="lazy"></a></p>

<p>・<code>食べ物を買う</code><br>
<a href="https://camo.qiitausercontent.com/00ece717712884f33d2e49926ecfde1a06dfec9e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32306261373763632d396436652d313035652d633965352d3036393530346139666639612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F20ba77cc-9d6e-105e-c9e5-069504a9ff9a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d041871d7a677eb49db378c78c79244b" alt="htn1.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/20ba77cc-9d6e-105e-c9e5-069504a9ff9a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F20ba77cc-9d6e-105e-c9e5-069504a9ff9a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8ae002d2a7190be68a849ee3d5987d2d 1x" loading="lazy"></a></p>

<p>・<code>食べ物を食べる</code><br>
<a href="https://camo.qiitausercontent.com/ba6ec99e708c210e32898305bb423d87c8d1ab73/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f30316438633563612d303131352d613036302d316631622d3839663634353934393835302e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F01d8c5ca-0115-a060-1f1b-89f645949850.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a7531e503a5b2bfa0b73b5603ed8f9d3" alt="htn3.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/01d8c5ca-0115-a060-1f1b-89f645949850.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F01d8c5ca-0115-a060-1f1b-89f645949850.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=330cf16ca09de7938dc74f7e5f89e728 1x" loading="lazy"></a></p>

<p>　全て、実際の行動は指定の場所に行くこととしています。</p>

<p>　余談ですが、Unity2020.2からリストがデフォルトでReorderableListになっています。便利です。<br>
　参考：<a href="https://zenn.dev/ohbashunsuke/articles/1134c1615efc2b636769" class="autolink" rel="nofollow noopener" target="_blank">https://zenn.dev/ohbashunsuke/articles/1134c1615efc2b636769</a></p>

<p><strong>Compound Task</strong>の<code>食事をする</code>は以下のように設定します。<br>
<a href="https://camo.qiitausercontent.com/3b5d80aa7ecc3bb6c8cff44f7d6f20c5e2da7a02/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f35303839363238662d663762342d643133622d376430362d3036663930653362383935312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F5089628f-f7b4-d13b-7d06-06f90e3b8951.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0cad1e1310bc8daad7b4008be4541569" alt="htn2.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/5089628f-f7b4-d13b-7d06-06f90e3b8951.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F5089628f-f7b4-d13b-7d06-06f90e3b8951.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=458962e268b4b1d7938416f9951ade4b 1x" loading="lazy"></a><br>
これは3つの<strong>Method</strong>からできており、それぞれ</p>

<ul>
<li>食べ物を持っているなら、食べ物を食べる</li>
<li>金を持っているなら、食べ物を買ってから再度食事タスクをする</li>
<li>（条件なしで）働いて再度食事タスクをする</li>
</ul>

<p>となっており、これが上から順に評価されて実行されます。</p>

<h1>
<span id="デモの結果" class="fragment"></span><a href="#%E3%83%87%E3%83%A2%E3%81%AE%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>デモの結果</h1>

<p>　初めに貼ったgifの挙動になります。<br>
<a href="https://camo.qiitausercontent.com/147fd420ef4f253076d944207b286b4f75262a6c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f35613764306432622d336465382d366466352d303432302d6536626636636663646462372e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F5a7d0d2b-3de8-6df5-0420-e6bf6cfcddb7.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=91013d7b90d4bb1d3e15aaaf46689acb" alt="anim.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/5a7d0d2b-3de8-6df5-0420-e6bf6cfcddb7.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F5a7d0d2b-3de8-6df5-0420-e6bf6cfcddb7.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=eb0cca4206fa2640fbb301014ce4fb7d 1x" loading="lazy"></a></p>

<h1>
<span id="課題" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a>課題</h1>

<p>　実は今、無限再帰を防ぐための処理を全くしていません。<br>
　例えば、CompoundTaskにおいて、条件は常に真でSubTaskとして自分自身を指定すると無限ループが起きます。<br>
　無限再帰を防ぐために、「同じ条件で同じタスクを与えられたときはスキップする」というような処理が必要です。</p>

<p>　そのほかにも、デモでは本当に単純なことしかやっていないので実際にゲーム内で使用するともっと課題が出てくると思います。そのような課題は<a href="https://www.slideshare.net/dena_genom/gdm37aileft-alive" rel="nofollow noopener" target="_blank">こちらのスライド</a>などが詳しいです。</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>　HTNの解説は以前から見聞きしていましたし、Qiitaにもいくつか記事があります。</p>

<ul>
<li><a href="https://qiita.com/tyemiya/items/5c56678fe4b8afb2ee4f" id="reference-687b4e01795011e1ed97">階層化型タスクネットワークを勉強して、ゲームAIのコードを書いてみた</a></li>
<li>
<a href="https://qiita.com/Dv7Pavilion/items/3998531b66d50475bd5b" id="reference-577eb5145362db705eb1">【UE4】HTNを実装してみた</a><br>
</li>
</ul>

<p>　ですので完全に後追いなのですが、単純に自分で実装してみたかったことと、自分なりの解釈を書いておくことで誰かの理解の助けになればよいなと思ったので記事を書くことにしました。<br>
　HTNのような綺麗な概念の実装は、ログを出して確認するだけだとすぐでも、実際使うことを考えると、どういうクラス構造にするか、データは誰が持つか、という複雑さがあるので、デモが動くところまで出来て良かったです。</p>

<p>　ここはもっとこうした方がよい、のような意見があればコメントで教えていただけるとありがたいです。<br>
　ご拝読ありがとうございました。</p>

<h1>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h1>

<ul>
<li><a href="https://labs.gree.jp/blog/2017/02/16317/" rel="nofollow noopener" target="_blank">はじめての階層型タスクネットワーク</a></li>
<li><a href="https://qiita.com/tyemiya/items/5c56678fe4b8afb2ee4f">階層化型タスクネットワークを勉強して、ゲームAIのコードを書いてみた</a></li>
<li>
<a href="https://qiita.com/Dv7Pavilion/items/3998531b66d50475bd5b">【UE4】HTNを実装してみた</a><br>
</li>
<li><a href="https://cedil.cesa.or.jp/cedil_sessions/view/1476" rel="nofollow noopener" target="_blank">プレイヤーに反応するだけのAIはもう古い！ゲームAIへのプランニング技術の導入</a></li>
<li><a href="https://www.slideshare.net/dena_genom/gdm37aileft-alive" rel="nofollow noopener" target="_blank">【GDM37】ゲームAIにおける意思決定と地形表現～『LEFT ALIVE』を事例に紹介～</a></li>
<li><a href="http://www.gameaipro.com/GameAIPro/GameAIPro_Chapter12_Exploring_HTN_Planners_through_Example.pdf" rel="nofollow noopener" target="_blank">Exploring HTN Planners through Example (GameAiPro, Chapter12)</a></li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fsaragai%2Fitems%2Fb53af82bab7cc86f499e&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fsaragai%2Fitems%2Fb53af82bab7cc86f499e&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/saragai/items/b53af82bab7cc86f499e/likers" class="css-1iupg5d">13</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">7</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/b53af82bab7cc86f499e/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/saragai/items/b53af82bab7cc86f499e/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/saragai/items/b53af82bab7cc86f499e/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/saragai/items/b53af82bab7cc86f499e/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/saragai/items/b53af82bab7cc86f499e.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-5aa98566-09f8-4c3a-b153-74f3c2d3d777">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-89a0fc13-67dc-4e67-b87c-07292d3e041e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-89a0fc13-67dc-4e67-b87c-07292d3e041e">{}</script>
      
<div id="LoginModal-react-component-67e24958-d9d3-41ce-8126-dd71d31967e8"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-67e24958-d9d3-41ce-8126-dd71d31967e8">{}</script>
      
<div id="StockModal-react-component-3a18a4d3-a2f6-4ab1-b043-40238db87cf6"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-3a18a4d3-a2f6-4ab1-b043-40238db87cf6">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;lcicsMw/gzZc8KaLfpAZNpDql2VR1ynVRLjlMbtO1mwADw517S4B8rUXULk//CXut9Gfu7o4Cxw2LLCKXIl+GA==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"概要\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e概要\u003c/h1\u003e\n\n\u003cp\u003e　Unityによって階層型タスクネットワークを実装し、以下のデモのようにプランニングと実行をできるようにします。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/ac659e3ccceeef0658b9e48c224fdf8c563eb905/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f39613964383864632d396131372d353836342d363638632d3538633835333163663234372e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F9a9d88dc-9a17-5864-668c-58c8531cf247.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=291c53b887cb661bfda5076154c78e01\" alt=\"anim.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/9a9d88dc-9a17-5864-668c-58c8531cf247.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F9a9d88dc-9a17-5864-668c-58c8531cf247.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f12045ca0515f056f3079b3ddeec03ec 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n　Unityのバージョンは2020.2.0f1です。\u003cbr\u003e\n　プロジェクトはGitHubに上げておきます。\u003cbr\u003e\n　\u003ca href=\"https://github.com/saragai/SimpleHTN\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/saragai/SimpleHTN\u003c/a\u003e\u003cbr\u003e\n（イラストの再配布を防ぐために画像がMissingになっています）\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"階層型タスクネットワークとは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9A%8E%E5%B1%A4%E5%9E%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e階層型タスクネットワークとは\u003c/h1\u003e\n\n\u003cp\u003e　英語では\u003cstrong\u003eHierarchical Task Network\u003c/strong\u003eと呼ばれます。以下\u003cstrong\u003eHTN\u003c/strong\u003eと呼びます。\u003cbr\u003e\n　\u003cstrong\u003eHTN\u003c/strong\u003eはその名の通り、\u003cstrong\u003eタスク\u003c/strong\u003eを\u003cstrong\u003e階層的\u003c/strong\u003eに組み合わせて作られるネットワークのことです。\u003cbr\u003e\n　\u003cstrong\u003eHTN\u003c/strong\u003eはゲームAIの\u003cstrong\u003eプランニング\u003c/strong\u003eに用いられます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"プランニングとは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%97%E3%83%A9%E3%83%B3%E3%83%8B%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eプランニングとは\u003c/h3\u003e\n\n\u003cp\u003e　プランニングとは、\u003cstrong\u003e何らかの目標に対して、どの行動をどの順序で行うべきかをあらかじめ考えること\u003c/strong\u003eです。\u003c/p\u003e\n\n\u003cp\u003e　例えば、現在家にいて、「\u003cstrong\u003e新宿駅へ行く\u003c/strong\u003e」という目標を立てたとします。\u003cbr\u003e\n　この目標は、最寄り駅が池袋駅だとすると\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e「\u003cstrong\u003e家を出る\u003c/strong\u003e → \u003cstrong\u003e池袋駅まで歩く\u003c/strong\u003e → \u003cstrong\u003e電車に乗る\u003c/strong\u003e」\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eのような方法で実現できるとします。\u003cbr\u003e\n　しかし、電車で行くとするとお金が必要ですが、お金が手元にないとしたらどうでしょうか。その場合は,\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e「\u003cstrong\u003e家を出る\u003c/strong\u003e → \u003cstrong\u003e銀行まで歩く\u003c/strong\u003e -\u0026gt; \u003cstrong\u003eお金を下ろす\u003c/strong\u003e -\u0026gt; \u003cstrong\u003e池袋駅まで歩く\u003c/strong\u003e → \u003cstrong\u003e電車に乗る\u003c/strong\u003e」\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eとする必要があります。また、足を骨折していた場合は\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e「\u003cstrong\u003eタクシーを呼ぶ\u003c/strong\u003e -\u0026gt; \u003cstrong\u003e家を出る\u003c/strong\u003e -\u0026gt; \u003cstrong\u003e池袋駅までタクシーで行く\u003c/strong\u003e → \u003cstrong\u003e電車に乗る\u003c/strong\u003e」\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eのような方法をとる必要があり、この場合はさらにお金が多く必要になります。\u003c/p\u003e\n\n\u003cp\u003e　ゲームAIとしてよく用いられる\u003cstrong\u003eFSM\u003c/strong\u003eや\u003cstrong\u003eBehaviorTree\u003c/strong\u003eなどは、行動を決定する際に現在の状況しか見ることができません。\u003cbr\u003e\n　しかし、上の例のようにどのようなルートを通るかで、必要なお金は変わります。その場合、「\u003cstrong\u003eお金が足りるか\u003c/strong\u003e」という条件を確かめるだけでも今から行うであろう行動を想定して手動で設定しなければならず、条件分岐が大量に必要になります。\u003c/p\u003e\n\n\u003cp\u003e　しかし、目標達成までに行うべき行動をあらかじめ列挙\u003cstrong\u003e(=プランニング)\u003c/strong\u003eできれば、「\u003cstrong\u003eお金が足りるか\u003c/strong\u003e」はおのずとわかるはずです。\u003cbr\u003e\n　ここで、プランニングを行う際には、\u003cstrong\u003eその行動に必要な条件\u003c/strong\u003eと\u003cstrong\u003e行動の影響\u003c/strong\u003eがわかっている必要があります。例えば、電車に乗るのであれば、必要な条件は「運賃260円を持っている」であり、行動の影響は「所持金が260円減る・自分のいる場所が池袋から新宿にかわる」です。\u003cbr\u003e\n　これらの条件を行動自体と合わせてまとめたものを、\u003cstrong\u003eタスク\u003c/strong\u003eと呼びます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"タスクとは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eタスクとは\u003c/h3\u003e\n\n\u003cp\u003e　改めてまとめます。HTNにおいて、\u003cstrong\u003eタスク\u003c/strong\u003eは以下の情報を持ちます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e必要な条件\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e実際にする行動\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e行動した際の影響\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e　\u003cstrong\u003e必要な条件\u003c/strong\u003eと\u003cstrong\u003e行動した際の影響\u003c/strong\u003eがまさにプランニングに必要な要素です。この情報のおかげで実際に行動しなくても仮想的に行動の結果がわかってシミュレーションが可能になります。\u003cbr\u003e\n　この二つは、どちらも\u003cstrong\u003eWorldState\u003c/strong\u003eと呼ばれる世界の状態を参照します。\u003cbr\u003e\n　プランニングの際は、現在の\u003cstrong\u003eWorldState\u003c/strong\u003eのコピーを作成し、仮想的にタスクを実行して\u003cstrong\u003eWorldState\u003c/strong\u003eのコピーを更新していくことでシミュレーションを行います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"階層的とは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9A%8E%E5%B1%A4%E7%9A%84%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e階層的とは\u003c/h3\u003e\n\n\u003cp\u003e　タスクには様々な粒度があります。\u003cbr\u003e\n　先ほどの例のように\u003cstrong\u003e「新宿駅へ行く」\u003c/strong\u003eはタスクですが、これは\u003cstrong\u003e「家を出る」\u003c/strong\u003e\u003cstrong\u003e「池袋駅まで行く」\u003c/strong\u003e\u003cstrong\u003e「電車に乗る」\u003c/strong\u003eなどのタスクに分解できます。さらに\u003cstrong\u003e「家を出る」\u003c/strong\u003eは\u003cstrong\u003e「靴を履く」\u003c/strong\u003e\u003cstrong\u003e「ドアを開ける」\u003c/strong\u003e\u003cstrong\u003e「鍵を閉める」\u003c/strong\u003eへと分解できるでしょう。\u003cbr\u003e\n　逆に言うと、\u003cstrong\u003e「靴を履く」\u003c/strong\u003eというような細かい\u003cstrong\u003e具体的なタスク\u003c/strong\u003eをまとめることによって\u003cstrong\u003e「新宿駅へ行く」\u003c/strong\u003eという\u003cstrong\u003e抽象的なタスク\u003c/strong\u003eにして扱いやすくできるのです。\u003c/p\u003e\n\n\u003cp\u003e　また、\u003cstrong\u003e抽象的なタスク\u003c/strong\u003eには複数の表現方法があることも述べました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e「\u003cstrong\u003eタクシーを呼ぶ\u003c/strong\u003e -\u0026gt; \u003cstrong\u003e家を出る\u003c/strong\u003e -\u0026gt; \u003cstrong\u003e池袋駅までタクシーで行く\u003c/strong\u003e → \u003cstrong\u003e電車に乗る\u003c/strong\u003e」\u003c/li\u003e\n\u003cli\u003e「\u003cstrong\u003e家を出る\u003c/strong\u003e → \u003cstrong\u003e銀行まで歩く\u003c/strong\u003e -\u0026gt; \u003cstrong\u003eお金を下ろす\u003c/strong\u003e -\u0026gt; \u003cstrong\u003e池袋駅まで歩く\u003c/strong\u003e → \u003cstrong\u003e電車に乗る\u003c/strong\u003e」\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e　この二つの方法の内容に差異はありますが、どちらの分解方法を選んだとしても最終的に目的は達成できるため、同一のタスクとして扱われるべきです。\u003c/p\u003e\n\n\u003cp\u003e　このような前提から上で述べた\u003cstrong\u003eタスク\u003c/strong\u003eをまとめた\u003cstrong\u003e複合タスク\u003c/strong\u003eを考えることができます。\u003cbr\u003e\n　\u003cstrong\u003e複合タスク\u003c/strong\u003eは、\u003cstrong\u003e「目的を達成するための一連のタスク」\u003c/strong\u003eと\u003cstrong\u003e「一連のタスクを選ぶための条件」\u003c/strong\u003eのセットを\u003cstrong\u003e複数\u003c/strong\u003e持つものとします。\u003cbr\u003e\n　この『\u003cstrong\u003e「目的を達成するための一連のタスク」\u003c/strong\u003eと\u003cstrong\u003e「一連のタスクを選ぶための条件」\u003c/strong\u003eのセット』は\u003cstrong\u003eMethod\u003c/strong\u003eと呼ばれます。\u003c/p\u003e\n\n\u003cp\u003e　この\u003cstrong\u003e複合タスク\u003c/strong\u003eも、以下のように確かに\u003cstrong\u003eタスク\u003c/strong\u003eの要件を満たすため、\u003cstrong\u003eタスク\u003c/strong\u003eと同様に扱うことが可能になっています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e必要な条件\u003c/strong\u003e：Methodを選ぶための条件と、選ばれたMethodが持つ一連のタスクに必要な条件\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e実際にする行動\u003c/strong\u003e：選ばれたMethodの持つ一連のタスクの実際にする行動\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e行動した際の影響\u003c/strong\u003e：選ばれたMethodの持つ一連のタスクを実行したときの影響\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e　この\u003cstrong\u003e複合タスク\u003c/strong\u003eを導入することによって、\u003cstrong\u003eタスク\u003c/strong\u003eを\u003cstrong\u003e階層的\u003c/strong\u003eに扱うことができるようになります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"用語\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%94%A8%E8%AA%9E\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e用語\u003c/h1\u003e\n\n\u003cp\u003e　ここまでで\u003cstrong\u003eHTN\u003c/strong\u003eに必要な一通りの要素を解説しました。実装に移る前に用語を整理しておきます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003ePrimitive Task\u003c/strong\u003e: \u003cstrong\u003e最も基本的なタスク\u003c/strong\u003eのこと\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eCondition\u003c/strong\u003e: \u003cstrong\u003e必要な条件\u003c/strong\u003eのこと\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eOperator\u003c/strong\u003e: \u003cstrong\u003e実際にする行動\u003c/strong\u003eのこと\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eEffect\u003c/strong\u003e: \u003cstrong\u003e行動したときの影響\u003c/strong\u003eのこと\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eCompound Task\u003c/strong\u003e: \u003cstrong\u003e複合タスク\u003c/strong\u003eのこと\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eMethod\u003c/strong\u003e: Conditionと一連のタスクのセット\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eSub Task\u003c/strong\u003e: 一連のタスク\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003eWorld State\u003c/strong\u003e: 世界の状態。タスクの条件や影響で参照される\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003ePlanner\u003c/strong\u003e: タスクを一つ設定し、プランニングして実行する行動の順列を割り出すひと\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eRoot Task\u003c/strong\u003e: プランニングしたいタスク\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003ePlan Runner\u003c/strong\u003e: プランを実行するひと\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h1\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"一般的な実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e一般的な実装\u003c/h3\u003e\n\n\u003cp\u003e　HTNを解説している記事はたくさんありますが、どれも\u003ca href=\"http://www.gameaipro.com/GameAIPro/GameAIPro_Chapter12_Exploring_HTN_Planners_through_Example.pdf\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGame AI Pro 12\u003c/a\u003eを参考にしているようです。\u003cbr\u003e\n　以下に疑似コードを引用します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eWorkingWS\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCurrentWorldState\u003c/span\u003e\n\u003cspan class=\"n\"\u003eTasksToProcess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eRootTask\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"n\"\u003eTasksToProcess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNotEmpty\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCurrentTask\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTasksToProcess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePop\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eCurrentTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eType\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eCompoundTask\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSatisfiedMethod\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCurrentTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFindSatisfiedMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWorkingWS\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eSatisfiedMethod\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003enull\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eRecordDecompositionOfTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentTask\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFinalPlan\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eDecompHistory\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n            \u003cspan class=\"n\"\u003eTasksToProcess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInsertTop\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSatisfiedMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSubTasks\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eRestoreToLastDecomposedTask\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"c1\"\u003e//Primitive Task\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ePrimitiveConditionMet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentTask\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eWorkingWS\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eApplyEffects\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEffects\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eFinalPlan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePushBack\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentTask\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eRestoreToLastDecomposedTask\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e　これについて軽く解説をします。\u003cbr\u003e\n　はじめに処理スタックに\u003ccode\u003eRootTask\u003c/code\u003eを積み、以下の処理を処理スタックが空になるまで繰り返します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e処理スタックに乗っているタスクを取り出して、\u003ccode\u003eCompoundTask\u003c/code\u003eか\u003ccode\u003ePrimitiveTask\u003c/code\u003eかで場合分ける\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eCompoundTask\u003c/code\u003eであれば、実行できる\u003ccode\u003eMethod\u003c/code\u003eがあるか確認して、あれば\u003ccode\u003eSubTasks\u003c/code\u003eを再び処理スタックに積む\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003ePrimitiveTask\u003c/code\u003eであれば、実行できるか確認して、実行できるならプランにそのタスクを加える\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eどちらの場合でも、失敗したら最後に\u003ccode\u003eCompoundTask\u003c/code\u003eを展開したときまで状態を差し戻す\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003e……なんかちょっと気になりませんか？\u003c/strong\u003e\u003cbr\u003e\n　気になるポイントは二点あります\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eCompoundTask\u003c/strong\u003eか\u003cstrong\u003ePrimitiveTask\u003c/strong\u003eかで場合分けしているのが気持ち悪い\u003c/li\u003e\n\u003cli\u003e最後に展開したときまで状態を差し戻すというのが分かりづらく、今何をしているのか混乱する\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e　個人的な理解としては\u003cstrong\u003eCompoundTask\u003c/strong\u003eは\u003cstrong\u003ePrimitiveTask\u003c/strong\u003eの拡張なので、同じインターフェースによって統一的に扱えるのではないかと思いました。また、スタックに新たなタスクがどんどん積まれていく中で、「最後に\u003cstrong\u003eCompoundTask\u003c/strong\u003eを展開した時まで戻す」がどういう挙動になるのかちょっと想像しにくい気がしました。\u003c/p\u003e\n\n\u003cp\u003e　もちろんそのまま組んで悪いことは全然ないのですが、そのままの実装については他の記事でもたくさん実装例があるのでちょっと変えてみようと思います。\u003cbr\u003e\n　気になるポイントへの対処としてはそれぞれ、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eTask\u003c/strong\u003eをインターフェースで扱って、\u003cstrong\u003eCompoundTask\u003c/strong\u003eと\u003cstrong\u003ePrimitiveTask\u003c/strong\u003eの処理の違いはそれぞれのTask側に実装する\u003c/li\u003e\n\u003cli\u003eスタックではなく再帰によって階層を実現する\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"インターフェース--再帰による実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9--%E5%86%8D%E5%B8%B0%E3%81%AB%E3%82%88%E3%82%8B%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eインターフェース \u0026amp; 再帰による実装\u003c/h3\u003e\n\n\u003cp\u003e　\u003cstrong\u003eCompoundTask\u003c/strong\u003eと\u003cstrong\u003ePrimitiveTask\u003c/strong\u003eはともに\u003ccode\u003eITask\u003c/code\u003eインターフェースを実装します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eITask\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eTryPlanTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ePlan\u003c/span\u003e \u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e　唯一のメソッド\u003ccode\u003eTryPlanTask()\u003c/code\u003eは、\u003ccode\u003eWorldState\u003c/code\u003eを受け取ってタスクを実行できるか確認し、実行できるなら\u003ccode\u003ePlan\u003c/code\u003eに追加していきます。このメソッドの中で\u003ccode\u003eWorldState\u003c/code\u003eも更新していくことにします。\u003c/p\u003e\n\n\u003cp\u003e　また、本筋ではないですが、Unityを使った開発ではTaskの設定のために\u003ccode\u003eScriptableOject\u003c/code\u003eを使うのではないかと思うので、\u003ccode\u003eScriptableOject\u003c/code\u003eを継承した抽象クラスも間に挟みます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eabstract\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTask\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eScriptableObject\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eITask\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eabstract\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eTryPlanTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ePlan\u003c/span\u003e \u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eそれぞれ、以下のように実装します。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"primitive-taskの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#primitive-task%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ePrimitive Taskの実装\u003c/h4\u003e\n\n\u003cp\u003e　これは何のひねりもなく、ただ\u003cstrong\u003eCondition\u003c/strong\u003eを満たしていたら\u003cstrong\u003eWorldState\u003c/strong\u003eを\u003cstrong\u003eEffect\u003c/strong\u003eで更新し、プランに\u003cstrong\u003eOperator\u003c/strong\u003eを加えているだけです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateAssetMenu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"primitive_task.asset\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emenuName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Primitive Task\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eorder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePrimitiveTask\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCondition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_Preconditions\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eOperator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOperator\u003c/span\u003e \u003cspan class=\"n\"\u003em_Operator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eEffect\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_Effects\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eTryPlanTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ePlan\u003c/span\u003e \u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econdition\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003em_Preconditions\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003econdition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eeffect\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003em_Effects\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eeffect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eApplyTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_Operator\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"compound-taskの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#compound-task%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCompound Taskの実装\u003c/h4\u003e\n\n\u003cp\u003e　ここで再帰が出てきます。\u003cbr\u003e\n　階層は\u003cstrong\u003eCompoundTask\u003c/strong\u003eが\u003cstrong\u003eMethod\u003c/strong\u003eを介してサブタスクの\u003ccode\u003eTryPlanTask()\u003c/code\u003eを呼んで再帰することで実現しています。\u003cbr\u003e\n　再帰で実装すると、「現在の状況を保存する場所」と「その状況に戻す場所」が近く、二つの対応が一目でわかるようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateAssetMenu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"compound_task.asset\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emenuName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Compound Task\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eorder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCompoundTask\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_Methods\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eTryPlanTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ePlan\u003c/span\u003e \u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003emethod\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003em_Methods\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 実行するタスクを見つける\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003emethod\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 現在のplanを保存\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentPlan\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePlan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// サブタスクを行う\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003emethod\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryPlanSubTasks\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 失敗したときplanを元に戻す\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eplan\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentPlan\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// サブタスクが全て完了したので成功\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 条件を満たすメソッドがなかったので失敗\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"methodの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#method%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eMethodの実装\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializable\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMethod\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCondition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_Conditions\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_SubTasks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eMatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econdition\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003em_Conditions\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003econdition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eTryPlanSubTasks\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ePlan\u003c/span\u003e \u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003em_SubTasks\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryPlanTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e　このようにすることで\u003cstrong\u003ePlanner\u003c/strong\u003eのコードはとてもシンプルになります。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"plannerの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#planner%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ePlannerの実装\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHTNPlanner\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eWorldStateHolder\u003c/span\u003e \u003cspan class=\"n\"\u003em_WorldStateHolder\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ePlan\u003c/span\u003e \u003cspan class=\"n\"\u003em_Plan\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAwake\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Plan\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePlan\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003ePlan\u003c/span\u003e \u003cspan class=\"nf\"\u003eDoPlan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eITask\u003c/span\u003e \u003cspan class=\"n\"\u003erootTask\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Plan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// WorldStateのコピーを取って自由に書き換えられるようにする\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etmpState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_WorldStateHolder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCopy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erootTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryPlanTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etmpState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003em_Plan\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003em_Plan\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e　ここで\u003ccode\u003eWorldState\u003c/code\u003eではなく\u003ccode\u003eWorldStateHolder\u003c/code\u003eを介しているのは、\u003ccode\u003eWorldState\u003c/code\u003eを\u003ccode\u003eMonoBehaviour\u003c/code\u003eにしたくないからです。\u003ccode\u003eWorldState\u003c/code\u003eを\u003ccode\u003eMonoBehavior\u003c/code\u003eにしてしまうとコピーを気軽にInstantiateできなくなってしまいます。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"planの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#plan%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ePlanの実装\u003c/h4\u003e\n\n\u003cp\u003e\u003cstrong\u003eOperator\u003c/strong\u003eを表すインターフェース\u003cstrong\u003eIOperator\u003c/strong\u003eを要素とする\u003cstrong\u003eQueue\u003c/strong\u003eの簡素なラッパークラスになっています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePlan\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eQueue\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_Operators\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eOperators\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_Operators\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003ePlan\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Operators\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eQueue\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003ePlan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePlan\u003c/span\u003e \u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Operators\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eQueue\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eother\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003em_Operators\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Operators\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperator\u003c/span\u003e \u003cspan class=\"n\"\u003e@operator\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Operators\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@operator\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"デモの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%A2%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデモの実装\u003c/h1\u003e\n\n\u003cp\u003eここからはデモ用の実装をしながら、ここまで解説なしで出していたクラスについても説明します。\u003cbr\u003e\nそのため、少し具体的な実装になってしまっています。本来はまだもっと抽象化すべきだと思うのですが、デモを兼ねているということで少し手を抜きました。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"デモの状況\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%A2%E3%81%AE%E7%8A%B6%E6%B3%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデモの状況\u003c/h3\u003e\n\n\u003cp\u003e状態の種類とタスクについてはこのスライドを参考にしています\u003cbr\u003e\n\u003ca href=\"https://www.slideshare.net/dena_genom/gdm37aileft-alive\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.slideshare.net/dena_genom/gdm37aileft-alive\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eWorldState\u003c/strong\u003eの種類は\u003cstrong\u003eenum\u003c/strong\u003eで指定、値は\u003cstrong\u003ebool\u003c/strong\u003eのみとします。\u003cbr\u003e\nここでは状態は\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e空腹か\u003c/li\u003e\n\u003cli\u003e金を持っているか\u003c/li\u003e\n\u003cli\u003e食べ物を持っているか\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eのみとします。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003ePrimitive Task\u003c/strong\u003eは\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e働く（金を得る）\u003c/li\u003e\n\u003cli\u003e食べ物を買う（金を使って食べ物を得る）\u003c/li\u003e\n\u003cli\u003e食べ物を食べる（食べ物を使って空腹を満たす）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003eCompound Task\u003c/strong\u003eは\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e食事をする\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eとして、どのような状況でも食べ物を食べるまで行きつくように\u003cstrong\u003eMethod\u003c/strong\u003eを設定します。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eOperator\u003c/strong\u003eで指定される実際の行動は、移動のみとします。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"worldstateの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#worldstate%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eWorldStateの実装\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializable\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eWorldState\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// 状態の種類\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eTYPE\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eIsHungry\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eHaveMoney\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eHaveMeal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eMaxCount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eNumStates\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMaxCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003em_States\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// コンストラクタ\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eWorldState\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_States\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMaxCount\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// 種類と値を指定して状態を設定\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eSet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTYPE\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_States\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// 種類を指定して状態の値を取得\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTYPE\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003em_States\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// 自身を複製する（プランニングの際に必要）\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCopy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecopy\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eWorldState\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eNumStates\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecopy\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003em_States\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_States\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ecopy\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003eCondition\u003c/strong\u003eは、\u003cstrong\u003eWorldState\u003c/strong\u003eの種類を指定して、その真偽を問い合わせます。\u003cbr\u003e\n\u003cstrong\u003eEffect\u003c/strong\u003eは、\u003cstrong\u003eWorldState\u003c/strong\u003eの種類を指定して、その真偽を設定します。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"conditionの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#condition%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eConditionの実装\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializable\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCondition\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTYPE\u003c/span\u003e \u003cspan class=\"n\"\u003em_Type\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003em_Value\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// 状態を指定して条件を満たすか判断する\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eMatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_Type\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003em_Value\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"effectの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#effect%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eEffectの実装\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializable\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eEffect\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTYPE\u003c/span\u003e \u003cspan class=\"n\"\u003em_Type\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003em_Value\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// 状態を指定して、新たな状態を設定する\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eApplyTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWorldState\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_Type\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003em_Value\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"operatorの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#operator%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eOperatorの実装\u003c/h4\u003e\n\n\u003cp\u003e　\u003cstrong\u003eOperator\u003c/strong\u003eは、用途を考えると多種多様なものが必要になりそうなものなので、少し抽象化します。\u003c/p\u003e\n\n\u003cp\u003e　\u003cstrong\u003eOperator\u003c/strong\u003eを\u003cstrong\u003ePlan Runner\u003c/strong\u003eが実行するとき、個々の\u003cstrong\u003eOperator\u003c/strong\u003eが何をするかを考えたくはありません。しかし、\u003cstrong\u003eOperator\u003c/strong\u003eには実行対象を渡さないといけないため、実行時は\u003cstrong\u003eIOperatable\u003c/strong\u003eというインターフェースを引数で渡すことにします。\u003c/p\u003e\n\n\u003cp\u003e　また、\u003cstrong\u003eOperator\u003c/strong\u003eは\u003cstrong\u003ePlanner\u003c/strong\u003eにおいてはプランニングのキューに入るだけですが、\u003cstrong\u003ePlan Runner\u003c/strong\u003eが実行するときに実際に実行するときはある程度時間がかかるものが多いと思います。そのため、コルーチンで実装します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\n\u003cspan class=\"c1\"\u003e// 操作対象\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eIOperatable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eTransform\u003c/span\u003e \u003cspan class=\"n\"\u003eTransform\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 操作\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eIOperator\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eOperatorName\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperatable\u003c/span\u003e \u003cspan class=\"n\"\u003eoperatable\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eabstract\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOperator\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eScriptableObject\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIOperator\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003em_OperatorName\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eOperatorName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_OperatorName\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// 操作を実行\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eabstract\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperatable\u003c/span\u003e \u003cspan class=\"n\"\u003eoperatable\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch5\u003e\n\u003cspan id=\"move-to-operator-operatorの具象クラス\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#move-to-operator-operator%E3%81%AE%E5%85%B7%E8%B1%A1%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eMove To Operator (Operatorの具象クラス）\u003c/h5\u003e\n\n\u003cp\u003e　行きたい場所を指定してそこまで直進する\u003cstrong\u003eOperator\u003c/strong\u003eとします。\u003cbr\u003e\n　場所はとりあえず\u003cstrong\u003ePlaceManager\u003c/strong\u003eというシングルトンを作ってそこから取っていますが、細かいところなので適当です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateAssetMenu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"move_to_operator.asset\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emenuName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Operator/Move To\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eorder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMoveToOperator\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eOperator\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003ePlaceManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePLACE\u003c/span\u003e \u003cspan class=\"n\"\u003em_Place\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003em_Velocity\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperatable\u003c/span\u003e \u003cspan class=\"n\"\u003eoperatable\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etargetPos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePlaceManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_Place\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etransform\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eoperatable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTransform\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edir\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etargetPos\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edir\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emagnitude\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0.1f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003edir\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eNormalize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 動かす\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e \u003cspan class=\"n\"\u003em_Velocity\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edir\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eTime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edeltaTime\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"plan-runnerの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#plan-runner%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ePlan Runnerの実装\u003c/h4\u003e\n\n\u003cp\u003e\u003cstrong\u003ePlanner\u003c/strong\u003eに\u003cstrong\u003eRoot Task\u003c/strong\u003eを渡して、受け取った\u003cstrong\u003eIOperator\u003c/strong\u003eのキューに入っている\u003cstrong\u003eExecute\u003c/strong\u003eを順番に呼んでいきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHTNPlanRunner\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eHTNPlanner\u003c/span\u003e \u003cspan class=\"n\"\u003em_Planner\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eOperatable\u003c/span\u003e \u003cspan class=\"n\"\u003em_Operatable\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"n\"\u003em_Task\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003em_ReplanningInterval\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_RunningCoroutines\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Start is called before the first frame update\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_RunningCoroutines\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStartCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetTaskRoutine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_Task\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eSetTaskRoutine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eITask\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 一定時間ごとにリプランニング\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eSetTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eWaitForSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_ReplanningInterval\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eSetTask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eITask\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStopCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eplan\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Planner\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDoPlan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStartPlan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// プランの実行を開始\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStartPlan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePlan\u003c/span\u003e \u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecoroutine\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eplan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOperators\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_RunningCoroutines\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eStartCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// 進行中のコルーチンを止める\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStopCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecoroutine\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003em_RunningCoroutines\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eStopCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_RunningCoroutines\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoperators\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003e@operator\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eoperators\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eaction\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e@operator\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_RunningCoroutines\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaction\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eStartCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaction\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIOperator\u003c/span\u003e \u003cspan class=\"n\"\u003e@operator\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eaction\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e@operator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_Operatable\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_RunningCoroutines\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaction\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eStartCoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaction\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"デモの設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%A2%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデモの設定\u003c/h1\u003e\n\n\u003cp\u003e　上で\u003cstrong\u003ePrimitive Task\u003c/strong\u003eは\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e働く（金を得る）\u003c/li\u003e\n\u003cli\u003e食べ物を買う（金を使って食べ物を得る）\u003c/li\u003e\n\u003cli\u003e食べ物を食べる（食べ物を使って空腹を満たす）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eの3つと言いました。それぞれ以下のように設定します。\u003cbr\u003e\n・\u003ccode\u003e働く\u003c/code\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/4a442ed0c1420d6075b7f6791af9bf075e4ba93d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31636636353864332d393832632d303037342d616534302d6632313136313830376537662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1cf658d3-982c-0074-ae40-f21161807e7f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a3f0c1d762b401f1d5349b81ec5352eb\" alt=\"htn4.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/1cf658d3-982c-0074-ae40-f21161807e7f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1cf658d3-982c-0074-ae40-f21161807e7f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=662d16b9b7f71b6db000fd43034e78ad 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e・\u003ccode\u003e食べ物を買う\u003c/code\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/00ece717712884f33d2e49926ecfde1a06dfec9e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32306261373763632d396436652d313035652d633965352d3036393530346139666639612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F20ba77cc-9d6e-105e-c9e5-069504a9ff9a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d041871d7a677eb49db378c78c79244b\" alt=\"htn1.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/20ba77cc-9d6e-105e-c9e5-069504a9ff9a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F20ba77cc-9d6e-105e-c9e5-069504a9ff9a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8ae002d2a7190be68a849ee3d5987d2d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e・\u003ccode\u003e食べ物を食べる\u003c/code\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/ba6ec99e708c210e32898305bb423d87c8d1ab73/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f30316438633563612d303131352d613036302d316631622d3839663634353934393835302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F01d8c5ca-0115-a060-1f1b-89f645949850.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a7531e503a5b2bfa0b73b5603ed8f9d3\" alt=\"htn3.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/01d8c5ca-0115-a060-1f1b-89f645949850.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F01d8c5ca-0115-a060-1f1b-89f645949850.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=330cf16ca09de7938dc74f7e5f89e728 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e　全て、実際の行動は指定の場所に行くこととしています。\u003c/p\u003e\n\n\u003cp\u003e　余談ですが、Unity2020.2からリストがデフォルトでReorderableListになっています。便利です。\u003cbr\u003e\n　参考：\u003ca href=\"https://zenn.dev/ohbashunsuke/articles/1134c1615efc2b636769\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://zenn.dev/ohbashunsuke/articles/1134c1615efc2b636769\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eCompound Task\u003c/strong\u003eの\u003ccode\u003e食事をする\u003c/code\u003eは以下のように設定します。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/3b5d80aa7ecc3bb6c8cff44f7d6f20c5e2da7a02/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f35303839363238662d663762342d643133622d376430362d3036663930653362383935312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F5089628f-f7b4-d13b-7d06-06f90e3b8951.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=0cad1e1310bc8daad7b4008be4541569\" alt=\"htn2.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/5089628f-f7b4-d13b-7d06-06f90e3b8951.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F5089628f-f7b4-d13b-7d06-06f90e3b8951.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=458962e268b4b1d7938416f9951ade4b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれは3つの\u003cstrong\u003eMethod\u003c/strong\u003eからできており、それぞれ\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e食べ物を持っているなら、食べ物を食べる\u003c/li\u003e\n\u003cli\u003e金を持っているなら、食べ物を買ってから再度食事タスクをする\u003c/li\u003e\n\u003cli\u003e（条件なしで）働いて再度食事タスクをする\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eとなっており、これが上から順に評価されて実行されます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"デモの結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%A2%E3%81%AE%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデモの結果\u003c/h1\u003e\n\n\u003cp\u003e　初めに貼ったgifの挙動になります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/147fd420ef4f253076d944207b286b4f75262a6c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f35613764306432622d336465382d366466352d303432302d6536626636636663646462372e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F5a7d0d2b-3de8-6df5-0420-e6bf6cfcddb7.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=91013d7b90d4bb1d3e15aaaf46689acb\" alt=\"anim.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/5a7d0d2b-3de8-6df5-0420-e6bf6cfcddb7.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F5a7d0d2b-3de8-6df5-0420-e6bf6cfcddb7.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=eb0cca4206fa2640fbb301014ce4fb7d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"課題\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題\u003c/h1\u003e\n\n\u003cp\u003e　実は今、無限再帰を防ぐための処理を全くしていません。\u003cbr\u003e\n　例えば、CompoundTaskにおいて、条件は常に真でSubTaskとして自分自身を指定すると無限ループが起きます。\u003cbr\u003e\n　無限再帰を防ぐために、「同じ条件で同じタスクを与えられたときはスキップする」というような処理が必要です。\u003c/p\u003e\n\n\u003cp\u003e　そのほかにも、デモでは本当に単純なことしかやっていないので実際にゲーム内で使用するともっと課題が出てくると思います。そのような課題は\u003ca href=\"https://www.slideshare.net/dena_genom/gdm37aileft-alive\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこちらのスライド\u003c/a\u003eなどが詳しいです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おわりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおわりに\u003c/h1\u003e\n\n\u003cp\u003e　HTNの解説は以前から見聞きしていましたし、Qiitaにもいくつか記事があります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/tyemiya/items/5c56678fe4b8afb2ee4f\" id=\"reference-687b4e01795011e1ed97\"\u003e階層化型タスクネットワークを勉強して、ゲームAIのコードを書いてみた\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://qiita.com/Dv7Pavilion/items/3998531b66d50475bd5b\" id=\"reference-577eb5145362db705eb1\"\u003e【UE4】HTNを実装してみた\u003c/a\u003e\u003cbr\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e　ですので完全に後追いなのですが、単純に自分で実装してみたかったことと、自分なりの解釈を書いておくことで誰かの理解の助けになればよいなと思ったので記事を書くことにしました。\u003cbr\u003e\n　HTNのような綺麗な概念の実装は、ログを出して確認するだけだとすぐでも、実際使うことを考えると、どういうクラス構造にするか、データは誰が持つか、という複雑さがあるので、デモが動くところまで出来て良かったです。\u003c/p\u003e\n\n\u003cp\u003e　ここはもっとこうした方がよい、のような意見があればコメントで教えていただけるとありがたいです。\u003cbr\u003e\n　ご拝読ありがとうございました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"参考文献\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考文献\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://labs.gree.jp/blog/2017/02/16317/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eはじめての階層型タスクネットワーク\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/tyemiya/items/5c56678fe4b8afb2ee4f\"\u003e階層化型タスクネットワークを勉強して、ゲームAIのコードを書いてみた\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://qiita.com/Dv7Pavilion/items/3998531b66d50475bd5b\"\u003e【UE4】HTNを実装してみた\u003c/a\u003e\u003cbr\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://cedil.cesa.or.jp/cedil_sessions/view/1476\" rel=\"nofollow noopener\" target=\"_blank\"\u003eプレイヤーに反応するだけのAIはもう古い！ゲームAIへのプランニング技術の導入\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.slideshare.net/dena_genom/gdm37aileft-alive\" rel=\"nofollow noopener\" target=\"_blank\"\u003e【GDM37】ゲームAIにおける意思決定と地形表現～『LEFT ALIVE』を事例に紹介～\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://www.gameaipro.com/GameAIPro/GameAIPro_Chapter12_Exploring_HTN_Planners_through_Example.pdf\" rel=\"nofollow noopener\" target=\"_blank\"\u003eExploring HTN Planners through Example (GameAiPro, Chapter12)\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2020-12-24T09:33:48Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"DAa+LN0KL1Duh+IJTpz3VkevwRU88+ryAA==--6n174G0EVE3szMST--meDYksr4wiZnWPKsHoUq9g==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-05-27T08:40:54Z","likesCount":13,"linkUrl":"https://qiita.com/saragai/items/b53af82bab7cc86f499e","organization":null,"originalId":1366080,"stockedCount":7,"title":"【Unity】階層型タスクネットワークを実装してみた【ゲームAI】","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e概要\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9A%8E%E5%B1%A4%E5%9E%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%A8%E3%81%AF\"\u003e階層型タスクネットワークとは\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%97%E3%83%A9%E3%83%B3%E3%83%8B%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF\"\u003eプランニングとは\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%A8%E3%81%AF\"\u003eタスクとは\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9A%8E%E5%B1%A4%E7%9A%84%E3%81%A8%E3%81%AF\"\u003e階層的とは\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cli\u003e\n\u003ca href=\"#%E7%94%A8%E8%AA%9E\"\u003e用語\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E5%AE%9F%E8%A3%85\"\u003e一般的な実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9--%E5%86%8D%E5%B8%B0%E3%81%AB%E3%82%88%E3%82%8B%E5%AE%9F%E8%A3%85\"\u003eインターフェース \u0026amp; 再帰による実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#primitive-task%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003ePrimitive Taskの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#compound-task%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eCompound Taskの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#method%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eMethodの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#planner%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003ePlannerの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#plan%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003ePlanの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\n\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%A2%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eデモの実装\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%A2%E3%81%AE%E7%8A%B6%E6%B3%81\"\u003eデモの状況\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#worldstate%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eWorldStateの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#condition%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eConditionの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#effect%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eEffectの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#operator%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eOperatorの実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#move-to-operator-operator%E3%81%AE%E5%85%B7%E8%B1%A1%E3%82%AF%E3%83%A9%E3%82%B9\"\u003eMove To Operator (Operatorの具象クラス）\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#plan-runner%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003ePlan Runnerの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\n\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%A2%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003eデモの設定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%A2%E3%81%AE%E7%B5%90%E6%9E%9C\"\u003eデモの結果\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C\"\u003e課題\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003eおわりに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"\u003e参考文献\u003c/a\u003e\n\u003c/li\u003e\n\n","totalPv":1269,"uuid":"b53af82bab7cc86f499e","banReason":null,"adventCalendarItem":{"day":21,"calendar":{"name":"Unity #2","urlName":"unity2","year":2020,"organization":null}},"author":{"encryptedId":"0SewVY6hzFNHa5hDNr55PQ1eCF8x--X2JJzx9pMAehmEO7--WwL/46dmWAzXNw5EXH8J0g==","originalId":189786,"description":"都内にいます","facebookUrl":null,"githubUrl":"https://github.com/saragai","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/189786/profile-images/1498789786","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F189786%2Fprofile-images%2F1498789786?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=0cfdead3041bcb8dcce7e955748cad5d","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F189786%2Fprofile-images%2F1498789786?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9d1f06bc9a3b7a50e5f15d582ddd20a9","urlName":"saragai","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"},{"name":"ゲームAI","urlName":"%e3%82%b2%e3%83%bc%e3%83%a0ai"},{"name":"HTN","urlName":"htn"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
