<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Xamarin.Forms アプリのリークパターンについて考える - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/amay077/items/76bfd558f447e8975e23" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="6zzR7/fbQPWhwxEeDYy6ky8NFH5xfGYu5mauF9bY9i4ymRH6ye8jHtDcZldJhtxRfDLCgSZO8RQHKznB3j9gPQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@amay077" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="Xamarin.Forms アプリのリークパターンについて考える - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XR0Z0WVhKcGJpNUdiM0p0Y3lEamdxTGpnNWZqZzZyamdhN2pnNnJqZzd6amdxX2pnNUhqZ3Jfamc3empnN1BqZ2F2amdhVGpnWVRqZ2Fib2dJUGpnWWpqZ29zJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTZjMGU0MTRjNTM5MDhkYjI0YmE0Y2MyYTdkYjk0Yzg4&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR0Z0WVhrd056YyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTllNWNlMjkwZmY4ZjhhYTEyMjUwZGI5NmM0NzBkOTBk&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=73060ae5dd5af11bc907ff1559d3580c"><meta property="og:description" content="de:code が終わってからずっと Xamarin.Forms アプリでメモリリークするパターンについて考えています。
考えを吐き出すために、図が少ないですがだらだら書きます。「Xamarin.Forms の」と第を付けておきながら..."><meta content="https://qiita.com/amay077/items/76bfd558f447e8975e23" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="Android,C#,.NET,Xamarin,Xamarin.Forms" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-d76c1901-20c0-49b8-be00-bc17ba3bd946"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Famay077%2Fitems%2F76bfd558f447e8975e23">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Famay077%2Fitems%2F76bfd558f447e8975e23">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-d76c1901-20c0-49b8-be00-bc17ba3bd946">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/android","name":"Android"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-06-05T01:05:49.000+09:00","dateModified":"2019-06-05T10:28:25.000+09:00","headline":"Xamarin.Forms アプリのリークパターンについて考える","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XR0Z0WVhKcGJpNUdiM0p0Y3lEamdxTGpnNWZqZzZyamdhN2pnNnJqZzd6amdxX2pnNUhqZ3Jfamc3empnN1BqZ2F2amdhVGpnWVRqZ2Fib2dJUGpnWWpqZ29zJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTZjMGU0MTRjNTM5MDhkYjI0YmE0Y2MyYTdkYjk0Yzg4\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR0Z0WVhrd056YyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTllNWNlMjkwZmY4ZjhhYTEyMjUwZGI5NmM0NzBkOTBk\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=73060ae5dd5af11bc907ff1559d3580c","mainEntityOfPage":"https://qiita.com/amay077/items/76bfd558f447e8975e23","author":{"@type":"Person","address":"のんほいパーク","email":null,"identifier":"amay077","name":"amay077","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F8227%2Fprofile-images%2F1473680950?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=c45897bd988ad06c0759e18a4161f0ce","url":"https://qiita.com/amay077","description":"ランチの時は呼ぶといい！","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"amay077","type":"items","id":"76bfd558f447e8975e23"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"amay077","type":"items","id":"76bfd558f447e8975e23"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"amay077","type":"items","id":"76bfd558f447e8975e23"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/amay077/items/76bfd558f447e8975e23","location":"/amay077/items/76bfd558f447e8975e23","scheme":"https","host":"qiita.com","port":null,"pathname":"/amay077/items/76bfd558f447e8975e23","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"8gNrhnKtkzy5P9D1q6AUmJyz+f07ExA55p3R8DeB9eErpquTTJnw18ggp7zvqnJaz4wvAmwhhwMH0EYmP2Zj8g==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-6b350336-9b26-4870-8bd1-9adc01f6fd4f"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/amay077/items/76bfd558f447e8975e23/likers" class="css-1iupg5d">16</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">12</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/76bfd558f447e8975e23/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/amay077/items/76bfd558f447e8975e23/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/amay077/items/76bfd558f447e8975e23/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/amay077/items/76bfd558f447e8975e23/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/amay077/items/76bfd558f447e8975e23.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/amay077"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/8227/profile-images/1473680950" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/amay077" class="css-10ougpm">@<!-- -->amay077</a><div class="css-1ay9vb9"><span><meta content="2019-06-04T16:05:49Z"/><time dateTime="2019-06-05T01:28:25Z" class="css-m19uds">updated at 2019-06-05</time></span></div></div></div></div></div><h1 class="css-cgzq40">Xamarin.Forms アプリのリークパターンについて考える</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/android" class="css-4czcte">Android</a><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/.net" class="css-4czcte">.NET</a><a href="/tags/xamarin" class="css-4czcte">Xamarin</a><a href="/tags/xamarin.forms" class="css-4czcte">Xamarin.Forms</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>de:code が終わってからずっと Xamarin.Forms アプリでメモリリークするパターンについて考えています。<br>
考えを吐き出すために、図が少ないですがだらだら書きます。「Xamarin.Forms の」と第を付けておきながら、それに限らない話な気もします。</p>

<p>Xamarin.Forms アプリを作ると、現在では一般的には下図のようになると思います。</p>

<p><a href="https://camo.qiitausercontent.com/2a163344ef2cb288755caa046631555247cd3701/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f383232372f36353766663336372d343566642d376639312d323433662d3634643162343636343065322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F8227%2F657ff367-45fd-7f91-243f-64d1b46640e2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5f0070ee533f909a226f1fd24c48eb4b" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/8227/657ff367-45fd-7f91-243f-64d1b46640e2.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F8227%2F657ff367-45fd-7f91-243f-64d1b46640e2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=90d6420c879e533829f69104f84623fa 1x" loading="lazy"></a></p>

<p>私が作ったサンプル</p>

<ul>
<li><a href="https://github.com/amay077/XamMaterialTodo" rel="nofollow noopener" target="_blank">amay077/XamMaterialTodo: Xamarin.Forms Visual によるマテリアルな iOS/Android アプリのサンプル</a></li>
</ul>

<p>もこうなっています。</p>

<p>ここで、図の箱と箱をつなぐ先の ◆ は保持(UML クラス図でいう Composition のような)関係を表しています。たとえば、<code>Android.app.Application</code> は <code>MainActivity</code> を保持しています。</p>

<p>Xamarin.Forms アプリは、他の多くのクロスプラットフォームアプリと同様に、「Single Activity Application」であり、ただ一つのActivityを持ちます。</p>

<p>その中に "Xamarin.Forms としての" <code>Application</code> があり、その下に Xamarin.Forms の世界での「画面」を示す xxxPage がぶら下がります。</p>

<p>MVVM パターンで実装すると、Pageごとに ViewModel が作られ、両者はデータバインディングで相互に関連します。「依存」関係としては、View→ViewModel ですが、ViewModelの変更を監視するためにViewの一部(コールバック関数など)をViewModelに登録することになるため、「参照」関係としては「双方」です。</p>

<p>iOS アプリなどの参照カウンタ方式を採用するプラットフォームでは、お互いに強い参照を持ってしまうと、循環参照となりどちらのオブジェクトも自動破棄されずリークしてしまうので、弱参照(Weak Reference)を使ってこれを回避します。</p>

<p>Xamarin も採用するマーク・アンド・スイープ方式のガベージコレクタでは、循環参照していても、依存関係のより上位のオブジェクトが不要とマークされれば、ツリーの下位オブジェクトはすべて破棄対象になります。</p>

<p>例えば、Xamarin.Forms.Application と FirstPage を結ぶ線が断たれれば、FirstPageViewModel もゴミと判定され破棄対象になります。</p>

<p>しかし上図では、ViewModel は、ビジネスロジックが記述されるであろう Usecase クラスと循環参照でつながっています。<br>
Usecase は Application の持ち物であるので、Application と Page の線を断っても、Usecase-ViewModel が循環参照したままでは、 Page も ViewModel も破棄されません。</p>

<p>Usecase クラスは、xxxPage/xxxPageViewModel よりも生存期間が長い場合が多いでしょう。<br>
私は Xamarin.Forms.Application で Usecase クラスを生成して保持させる実装をよく行いますが、DIコンテナを使う場合も Usecase は xxxPage/xxxPageViewModel とは異なる生存期間を持つ、ことになります。</p>

<p>そして、Usecase を使用するのは xxxViewModel クラスになるでしょう。<br>
単純に Usecase の同期/非同期メソッドを呼び出して結果を返値で得る、場合には問題になりませんが、「Usecase からの通知を待つ」場合には、Page-ViewModel の関係と同様に、循環参照になります。</p>

<p>例えば、Usecase が次のような機能を提供している場合です。</p>

<ul>
<li>ネットワークのオンライン/オフラインを通知するイベントがある</li>
<li>Push 通知が届いたことを通知するイベントがある</li>
</ul>

<p>イベントに限らず、Rx の <code>IObservable&lt;T&gt;</code> でも同様です。<br>
ViewModel で Usecase からの通知を受信するには、何らかのレシーバーを Usecase に登録しないといけないので、相互参照になります。</p>

<p>なので、 <strong>ViewModel で Usecase からの通知を受信するための登録を行ったら、それは必ず解除してあげる必要があります</strong> 。<br>
それはいつ・だれが行えばよいのでしょう？</p>

<h2>
<span id="viewmodel-を-disposable-にして-pageondisappearing-で破棄するパターン" class="fragment"></span><a href="#viewmodel-%E3%82%92-disposable-%E3%81%AB%E3%81%97%E3%81%A6-pageondisappearing-%E3%81%A7%E7%A0%B4%E6%A3%84%E3%81%99%E3%82%8B%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3"><i class="fa fa-link"></i></a>ViewModel を Disposable にして Page.OnDisappearing で破棄するパターン</h2>

<p>Android Architecture Component の ViewModel には、<a href="https://developer.android.com/reference/androidx/lifecycle/ViewModel.html" rel="nofollow noopener" target="_blank"><code>onCleard</code></a> が用意されており、ここで解除処理をしてあげればよいのですが、Xamarin.Forms には、そのような用意されたものはありません。</p>

<p>問題は、登録処理は ViewModel のコンストラクタで行うであろうが、それと対になる破棄タイミングが無い、ことです。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SecondViewModel</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">SecondViewModel</span><span class="p">(</span><span class="n">MyUsecase</span> <span class="n">myUsecase</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">myUsecase</span><span class="p">.</span><span class="n">OnlineChanged</span> <span class="p">+=</span> <span class="n">ReceiveOnlineChanged</span><span class="p">;</span> <span class="c1">// いつ -= する？</span>
  <span class="p">}</span>

  <span class="k">void</span> <span class="nf">ReceiveOnlineChanged</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">online</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span> <span class="nf">DoOnlineWork</span><span class="p">();</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ひとつのアイデアとしては Page.Disappearing のタイミングで破棄させる、というものがあります。<br>
Page.Disappearing は、Page が破棄された(例： NavigationStackからPopされた)時に呼ばれるので、それを利用して次のように書けます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SecondViewModel</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">SecondViewModel</span><span class="p">(</span><span class="n">MyUsecase</span> <span class="n">myUsecase</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">myUsecase</span><span class="p">.</span><span class="n">OnlineChanged</span> <span class="p">+=</span> <span class="n">ReceiveOnlineChanged</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">void</span> <span class="nf">ReceiveOnlineChanged</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">online</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span> <span class="nf">DoOnlineWork</span><span class="p">();</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">void</span> <span class="n">IDisposable</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">myUsecase</span><span class="p">.</span><span class="n">OnlineChanged</span> <span class="p">-=</span> <span class="n">ReceiveOnlineChanged</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">SecondPage</span> <span class="p">:</span> <span class="n">ContentPage</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">SecondPage</span><span class="p">(</span><span class="n">MyUsecase</span> <span class="n">myUsecase</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nf">InitializeComponent</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="n">BindingContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SecondPageViewModel</span><span class="p">(</span><span class="n">myUsecase</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnDisappearing</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">BindingContext</span> <span class="k">as</span> <span class="n">IDisposable</span><span class="p">)?.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="k">base</span><span class="p">.</span><span class="nf">OnDisappearing</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これで大丈夫そう…ですが注意しなければならない事もあります。<br>
本来 Disappearing は Appearing と対になるライフサイクルイベントです。<br>
ViewModel の生成はコンストラクタで行っているのに、破棄は OnDisappearing で行うのは 「いびつ」 です。これの弊害は、例えば Page のインスタンスをキャッシュしておく場合に表れます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">FirstPage</span> <span class="p">:</span> <span class="n">ContentPage</span>
<span class="p">{</span>
  <span class="k">private</span> <span class="n">SecondPage</span> <span class="n">secondPage</span><span class="p">;</span>
  <span class="k">async</span> <span class="k">void</span> <span class="nf">OnButtonClick</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">secondPage</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">secondPage</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SecondPage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">myUsecase</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">Navigation</span><span class="p">.</span><span class="nf">PushAsync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">secondPage</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>こんな実装自体好ましくありませんが、生成と破棄のタイミングが「いびつ」になっていると思わぬ不具合を引き起こすかもしれない事は要注意です。</p>

<h2>
<span id="メモリリークの見つけ方" class="fragment"></span><a href="#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%AF%E3%81%AE%E8%A6%8B%E3%81%A4%E3%81%91%E6%96%B9"><i class="fa fa-link"></i></a>メモリリークの見つけ方</h2>

<p>Xamarin Profiler を使う手もあるのですが、アプリの動作が重くなるので、原始的な方法 <strong>「破棄されるべきオブジェクトのデストラクタでログ出力を仕掛けておき、GCを強制的に実行して確認する」</strong> で行っています。</p>

<h3>
<span id="1-対象クラス-に-finalizer-を定義してログを取る" class="fragment"></span><a href="#1-%E5%AF%BE%E8%B1%A1%E3%82%AF%E3%83%A9%E3%82%B9-%E3%81%AB-finalizer-%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%97%E3%81%A6%E3%83%AD%E3%82%B0%E3%82%92%E5%8F%96%E3%82%8B"><i class="fa fa-link"></i></a>1. 対象クラス に Finalizer を定義してログを取る</h3>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">SecondPage</span> <span class="p">:</span> <span class="n">ContentPage</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">SecondPage</span><span class="p">(</span><span class="n">MyUsecase</span> <span class="n">myUsecase</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call SecondPage ctor."</span><span class="p">);</span>

    <span class="c1">// 省略</span>
  <span class="p">}</span>

  <span class="p">~</span><span class="nf">SecondPage</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call SecondPage finalizer."</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="2-対象クラスのインスタンスが破棄されるべき箇所で-gccollect-を実行する" class="fragment"></span><a href="#2-%E5%AF%BE%E8%B1%A1%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%8C%E7%A0%B4%E6%A3%84%E3%81%95%E3%82%8C%E3%82%8B%E3%81%B9%E3%81%8D%E7%AE%87%E6%89%80%E3%81%A7-gccollect-%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. 対象クラスのインスタンスが破棄されるべき箇所で GC.Collect() を実行する</h3>

<p>対象クラスのインスタンスがもう不要になったと期待される箇所、例えば SecondPage ならば、FirstPage に戻ったとき（あるいは次回 SecondPage を表示したいとき）にブレークポイントで一時停止し、イミディエイトウィンドウで <code>System.GC.Collect()</code> を実行します(<del>一度の GC では破棄されないかもしれないので何度か実行するとよいです</del>  <code>GC.Collect()</code> のあとで <code>GC.WaitForPendingFinalizers()</code> を実行すると「ゴミが回収されるまで待つ」ことができます<sup id="fnref1"><a href="#fn1" title="https://twitter.com/kekyo2/status/1136056968848728065 ">1</a></sup>)。</p>

<p>期待通り破棄されていれば、以下のようにログに Finalizer が呼び出されたことが出力されます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>call SecondPage finalizer.
[Mono] GC_BRIDGE waiting for bridge processing to finish
[art] Starting a blocking GC Explicit
[art] Explicit concurrent mark sweep GC freed 9626(498KB) AllocSpace objects, 0(0B) LOS objects, 40% free, 2MB/3MB, paused 371us total 12.831ms
[Mono] GC_TAR_BRIDGE bridges 179 objects 209 opaque 6 colors 179 colors-bridged 179 colors-visible 179 xref 3 cache-hit 0 cache-semihit 0 cache-miss 0 setup 0.05ms tarjan 0.09ms scc-setup 0.05ms gather-xref 0.02ms xref-setup 0.01ms cleanup 0.12ms
[Mono] GC_BRIDGE: Complete, was running for 15.60ms
[Mono] GC_MAJOR: (user request) time 17.94ms, stw 20.85ms los size: 1024K in use: 145K
[Mono] GC_MAJOR_SWEEP: major size: 1968K in use: 791K
</code></pre></div></div>

<p><strong>ログに出力されなければ、それがリークです。</strong></p>

<h2>
<span id="android-アプリのライフサイクルとの関係" class="fragment"></span><a href="#android-%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B5%E3%82%A4%E3%82%AF%E3%83%AB%E3%81%A8%E3%81%AE%E9%96%A2%E4%BF%82"><i class="fa fa-link"></i></a>Android アプリのライフサイクルとの関係</h2>

<p>冒頭でも言ったように、Xamarin.Forms アプリは 「Single Activity App」 なので、アプリに必要なオブジェクトは、全て MainActivity が保持しています。</p>

<p>すなわち、MainActivity が破棄されれば、Xamarin.Forms の世界のオブジェクトはすべて破棄されるのが望ましい、という事です。<br>
そして Android の世界において、MainActivity はまあまあ頻繁に破棄されます。他のアプリを前面に表示して利用し続けていると、裏側の Activity は OS によって勝手に破棄されることは、よく知られています。</p>

<p>これは、Android 端末の開発者オプション - ✅<a href="https://kijonojiron.com/android_developer_options_configuration" rel="nofollow noopener" target="_blank">アクティビティを保持しない</a> で容易に再現できます。</p>

<p><a href="https://camo.qiitausercontent.com/bcfc183d73289c64031a772b0acec04be55b504e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f383232372f31636538346364312d366365662d393739642d376135662d3835383433363931623537642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F8227%2F1ce84cd1-6cef-979d-7a5f-85843691b57d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5ef5f09802fc1c2cba379c44209ea34e" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/8227/1ce84cd1-6cef-979d-7a5f-85843691b57d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F8227%2F1ce84cd1-6cef-979d-7a5f-85843691b57d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b39826b776788717ab9bdd7971cf084c 1x" loading="lazy"></a></p>

<p>さて、MainActivity が破棄されたときに Xamarin.Forms の世界のオブジェクト、<code>Page</code> や <code>Xamarin.Forms.Application</code> は破棄されるのか、確認してみます。</p>

<p>新しい Xamarin.Forms アプリのソリューションを作成し、 <code>App.xaml.cs</code>, <code>MainPage.xaml.cs</code>、そして Android 側の <code>MainActivity.cs</code> のそれぞれのコンストラクタと Finalizer でログ出力します。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">MainPage</span> <span class="p">:</span> <span class="n">ContentPage</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">MainPage</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call MainPage ctor."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">~</span><span class="nf">MainPage</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call MainPage finalizer."</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">App</span> <span class="p">:</span> <span class="n">Application</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">App</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call App ctor."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">~</span><span class="nf">App</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call App finalizer."</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="k">global</span><span class="p">::</span><span class="n">Xamarin</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">Platform</span><span class="p">.</span><span class="n">Android</span><span class="p">.</span><span class="n">FormsAppCompatActivity</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnCreate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call MainActivity OnCreate."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">OnDestroy</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call MainActivity OnDestroy."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="p">~</span><span class="nf">MainActivity</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call MainActivity finalizer."</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これ変更を加えただけのアプリを、<code>MainActivity.cs</code> の <code>OnDestroy</code> の <code>Debug.WriteLine</code> の行にブレークポイントを設定した状態で、事前に「アクティビティを保持しない」設定を有効にした端末やエミュレータでデバッグ実行します。</p>

<p>ホームボタンを押して、アプリをバックグラウンドに退避させると、ブレークポイントで停止するので、そこでイミディエイトウィンドウから <code>GC.Collect()</code> を何度か実行します。</p>

<p>何度 <code>GC.Collect()</code> を行っても、App や MainPage の Finalizer が呼び出されていないことに注目です。ここでこれらが破棄されることを期待していたのですが違ったようです。</p>

<p>デバッグを続行し、背面に退避したアプリを再び前面に表示します。この時には初回起動と同じく、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>call MainActivitｙ OnCreate.
call App ctor.
call MainPage ctor.
</code></pre></div></div>

<p>が出力されるはずです。つまり、この時点では、<code>App</code> と <code>MainPage</code> は2つのインスタンスが存在する、という事です。</p>

<p>アプリが起動したらもう一度ホームボタンを押して退避させ、ブレークポイントで止めた状態で、<code>GC.Collect()</code> を数回呼び出します。すると、以下のように出力されるはずです。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>call MainActivity finalizer.
call MainPage finalizer.
call App finalizer.
</code></pre></div></div>

<p>初回起動のときに生成されたオブジェクトが、このタイミングで破棄されました。「アクティビティを保持しない」設定によって、退避した時点で <code>MainActivity</code> はゴミとマークされ、次回新しい <code>MainActivity</code> が生成されます。ですが GC によってゴミが回収されるまでは、<code>MainAcitivity</code>, <code>App</code>, <code>MainPage</code> はそれぞれ複数のインスタンスが存在し得えます。</p>

<p>これは仕方のないことなので、せめてリソースだけは <code>MainActivity.OnDestroy</code> で解放されるように、<code>App</code> を Disposable にしてみます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">App</span> <span class="p">:</span> <span class="n">Application</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="n">IDisposable</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call App Dispose ."</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="k">global</span><span class="p">::</span><span class="n">Xamarin</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">Platform</span><span class="p">.</span><span class="n">Android</span><span class="p">.</span><span class="n">FormsAppCompatActivity</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">App</span> <span class="n">app</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 省略...</span>

        <span class="k">this</span><span class="p">.</span><span class="n">app</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">App</span><span class="p">();</span>
        <span class="nf">LoadApplication</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">app</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">app</span> <span class="k">as</span> <span class="n">IDisposable</span><span class="p">)?.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">OnDestroy</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"call MainActivity OnDestroy."</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>App を Disposable にして、MainActivity の OnDestroy でそれを呼び出すようにすれば、とりあえず「アプリが破棄される」ときに Xamarin.Forms 側のリソースを解放するトリガーとして使えそうです。</p>

<p>しかしゴミとしてマークされた App や MainPage は、Dispose されつつも GC に掃除されるまで生きているので、その間に意図しない問題を引き起こす可能性に注意を払いましょう。<br>
例えば、App.Dispose で DB 接続は閉じたものの、MainPage ではタイマーを使って定期的に DB から値を得ようとしている場合などです。それぞれが決められたライフサイクルの中で動作していれば問題は起こらないでしょうが、手を抜くと後でトラブルが発生しがちです。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<ul>
<li>自分よりも生存期間が長いオブジェクトを使うとき(ViewModel to Usecase)は、「登録」に対しての「解除」が必ず必要です</li>
<li>Xamarin.Forms の Page も App も「破棄」のタイミングを掴む方法は公式には存在しないので、<code>IDisposable</code> インターフェースを使って自力で実装するしかなさそうです</li>
<li>Usecase クラスは一般的には App の管轄なので、App の Dispose で破棄するとよいと思われます</li>
<li>「Dispose されたオブジェクト」にアクセスしてしまう事を想定して適切なエラー処理をしましょう</li>
</ul>

<h2>
<span id="おまけ" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91"><i class="fa fa-link"></i></a>おまけ</h2>

<ul>
<li>
<code>Activity.ApplicationContext</code> を Xamarin.Forms 側のオブジェクトが握ってしまうと、MainActivity が破棄されずにリークするのでしょうね。</li>
<li>
<code>Android.apps.Application</code> に持たせたオブジェクトは、最も破棄されにくく、生存期間が長くなります。<code>Xamarin.Forms.Application</code> では生存期間が短くて要件を満たせない場合は、<code>Android.apps.Application</code> にリソースを持たせる事ができると思います。ただし前述の通りリークに注意。</li>
<li>Android の Service や、Push通知の受信、ウィジェットなどは、MainActivity とは異なる別の Activity または Context になり、Xamarin.Forms とは関係ないオブジェクト達です。それらと通信する際もやはり循環参照と生存期間の長短に気をつけるべきかと。</li>
</ul>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p><a href="https://twitter.com/kekyo2/status/1136056968848728065" class="autolink" rel="nofollow noopener" target="_blank">https://twitter.com/kekyo2/status/1136056968848728065</a>  <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Famay077%2Fitems%2F76bfd558f447e8975e23&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Famay077%2Fitems%2F76bfd558f447e8975e23&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/amay077/items/76bfd558f447e8975e23/likers" class="css-1iupg5d">16</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">12</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/76bfd558f447e8975e23/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/amay077/items/76bfd558f447e8975e23/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/amay077/items/76bfd558f447e8975e23/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/amay077/items/76bfd558f447e8975e23/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/amay077/items/76bfd558f447e8975e23.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-6b350336-9b26-4870-8bd1-9adc01f6fd4f">{"authorAnalyticsTrackingId":"UA-224332-8","organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-141c0933-f17f-40c7-9984-2541889a5b63"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-141c0933-f17f-40c7-9984-2541889a5b63">{}</script>
      
<div id="LoginModal-react-component-746a3a14-9019-43d0-81b5-c87fbd89b6d9"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-746a3a14-9019-43d0-81b5-c87fbd89b6d9">{}</script>
      
<div id="StockModal-react-component-82dd5f44-e431-4dcb-bb7a-04b7ad254a72"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-82dd5f44-e431-4dcb-bb7a-04b7ad254a72">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;Uf955XbuBEEwXa+Tg0+H/AEyeCWqauC7EOimFrFwGtuIWrnwSNpnqkFC2NrHReE+Ug2u2v1Yd4HxpTHAuZeMyA==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003ede:code が終わってからずっと Xamarin.Forms アプリでメモリリークするパターンについて考えています。\u003cbr\u003e\n考えを吐き出すために、図が少ないですがだらだら書きます。「Xamarin.Forms の」と第を付けておきながら、それに限らない話な気もします。\u003c/p\u003e\n\n\u003cp\u003eXamarin.Forms アプリを作ると、現在では一般的には下図のようになると思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/2a163344ef2cb288755caa046631555247cd3701/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f383232372f36353766663336372d343566642d376639312d323433662d3634643162343636343065322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F8227%2F657ff367-45fd-7f91-243f-64d1b46640e2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5f0070ee533f909a226f1fd24c48eb4b\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/8227/657ff367-45fd-7f91-243f-64d1b46640e2.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F8227%2F657ff367-45fd-7f91-243f-64d1b46640e2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=90d6420c879e533829f69104f84623fa 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e私が作ったサンプル\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/amay077/XamMaterialTodo\" rel=\"nofollow noopener\" target=\"_blank\"\u003eamay077/XamMaterialTodo: Xamarin.Forms Visual によるマテリアルな iOS/Android アプリのサンプル\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eもこうなっています。\u003c/p\u003e\n\n\u003cp\u003eここで、図の箱と箱をつなぐ先の ◆ は保持(UML クラス図でいう Composition のような)関係を表しています。たとえば、\u003ccode\u003eAndroid.app.Application\u003c/code\u003e は \u003ccode\u003eMainActivity\u003c/code\u003e を保持しています。\u003c/p\u003e\n\n\u003cp\u003eXamarin.Forms アプリは、他の多くのクロスプラットフォームアプリと同様に、「Single Activity Application」であり、ただ一つのActivityを持ちます。\u003c/p\u003e\n\n\u003cp\u003eその中に \"Xamarin.Forms としての\" \u003ccode\u003eApplication\u003c/code\u003e があり、その下に Xamarin.Forms の世界での「画面」を示す xxxPage がぶら下がります。\u003c/p\u003e\n\n\u003cp\u003eMVVM パターンで実装すると、Pageごとに ViewModel が作られ、両者はデータバインディングで相互に関連します。「依存」関係としては、View→ViewModel ですが、ViewModelの変更を監視するためにViewの一部(コールバック関数など)をViewModelに登録することになるため、「参照」関係としては「双方」です。\u003c/p\u003e\n\n\u003cp\u003eiOS アプリなどの参照カウンタ方式を採用するプラットフォームでは、お互いに強い参照を持ってしまうと、循環参照となりどちらのオブジェクトも自動破棄されずリークしてしまうので、弱参照(Weak Reference)を使ってこれを回避します。\u003c/p\u003e\n\n\u003cp\u003eXamarin も採用するマーク・アンド・スイープ方式のガベージコレクタでは、循環参照していても、依存関係のより上位のオブジェクトが不要とマークされれば、ツリーの下位オブジェクトはすべて破棄対象になります。\u003c/p\u003e\n\n\u003cp\u003e例えば、Xamarin.Forms.Application と FirstPage を結ぶ線が断たれれば、FirstPageViewModel もゴミと判定され破棄対象になります。\u003c/p\u003e\n\n\u003cp\u003eしかし上図では、ViewModel は、ビジネスロジックが記述されるであろう Usecase クラスと循環参照でつながっています。\u003cbr\u003e\nUsecase は Application の持ち物であるので、Application と Page の線を断っても、Usecase-ViewModel が循環参照したままでは、 Page も ViewModel も破棄されません。\u003c/p\u003e\n\n\u003cp\u003eUsecase クラスは、xxxPage/xxxPageViewModel よりも生存期間が長い場合が多いでしょう。\u003cbr\u003e\n私は Xamarin.Forms.Application で Usecase クラスを生成して保持させる実装をよく行いますが、DIコンテナを使う場合も Usecase は xxxPage/xxxPageViewModel とは異なる生存期間を持つ、ことになります。\u003c/p\u003e\n\n\u003cp\u003eそして、Usecase を使用するのは xxxViewModel クラスになるでしょう。\u003cbr\u003e\n単純に Usecase の同期/非同期メソッドを呼び出して結果を返値で得る、場合には問題になりませんが、「Usecase からの通知を待つ」場合には、Page-ViewModel の関係と同様に、循環参照になります。\u003c/p\u003e\n\n\u003cp\u003e例えば、Usecase が次のような機能を提供している場合です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eネットワークのオンライン/オフラインを通知するイベントがある\u003c/li\u003e\n\u003cli\u003ePush 通知が届いたことを通知するイベントがある\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eイベントに限らず、Rx の \u003ccode\u003eIObservable\u0026lt;T\u0026gt;\u003c/code\u003e でも同様です。\u003cbr\u003e\nViewModel で Usecase からの通知を受信するには、何らかのレシーバーを Usecase に登録しないといけないので、相互参照になります。\u003c/p\u003e\n\n\u003cp\u003eなので、 \u003cstrong\u003eViewModel で Usecase からの通知を受信するための登録を行ったら、それは必ず解除してあげる必要があります\u003c/strong\u003e 。\u003cbr\u003e\nそれはいつ・だれが行えばよいのでしょう？\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"viewmodel-を-disposable-にして-pageondisappearing-で破棄するパターン\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#viewmodel-%E3%82%92-disposable-%E3%81%AB%E3%81%97%E3%81%A6-pageondisappearing-%E3%81%A7%E7%A0%B4%E6%A3%84%E3%81%99%E3%82%8B%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eViewModel を Disposable にして Page.OnDisappearing で破棄するパターン\u003c/h2\u003e\n\n\u003cp\u003eAndroid Architecture Component の ViewModel には、\u003ca href=\"https://developer.android.com/reference/androidx/lifecycle/ViewModel.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003ccode\u003eonCleard\u003c/code\u003e\u003c/a\u003e が用意されており、ここで解除処理をしてあげればよいのですが、Xamarin.Forms には、そのような用意されたものはありません。\u003c/p\u003e\n\n\u003cp\u003e問題は、登録処理は ViewModel のコンストラクタで行うであろうが、それと対になる破棄タイミングが無い、ことです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSecondViewModel\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSecondViewModel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMyUsecase\u003c/span\u003e \u003cspan class=\"n\"\u003emyUsecase\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emyUsecase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOnlineChanged\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003eReceiveOnlineChanged\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// いつ -= する？\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eReceiveOnlineChanged\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eonline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eonline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nf\"\u003eDoOnlineWork\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eひとつのアイデアとしては Page.Disappearing のタイミングで破棄させる、というものがあります。\u003cbr\u003e\nPage.Disappearing は、Page が破棄された(例： NavigationStackからPopされた)時に呼ばれるので、それを利用して次のように書けます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSecondViewModel\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSecondViewModel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMyUsecase\u003c/span\u003e \u003cspan class=\"n\"\u003emyUsecase\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emyUsecase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOnlineChanged\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003eReceiveOnlineChanged\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eReceiveOnlineChanged\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eonline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eonline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nf\"\u003eDoOnlineWork\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emyUsecase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOnlineChanged\u003c/span\u003e \u003cspan class=\"p\"\u003e-=\u003c/span\u003e \u003cspan class=\"n\"\u003eReceiveOnlineChanged\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSecondPage\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eContentPage\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSecondPage\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMyUsecase\u003c/span\u003e \u003cspan class=\"n\"\u003emyUsecase\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eInitializeComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBindingContext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSecondPageViewModel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emyUsecase\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnDisappearing\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBindingContext\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\u003cspan class=\"p\"\u003e)?.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnDisappearing\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで大丈夫そう…ですが注意しなければならない事もあります。\u003cbr\u003e\n本来 Disappearing は Appearing と対になるライフサイクルイベントです。\u003cbr\u003e\nViewModel の生成はコンストラクタで行っているのに、破棄は OnDisappearing で行うのは 「いびつ」 です。これの弊害は、例えば Page のインスタンスをキャッシュしておく場合に表れます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFirstPage\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eContentPage\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eSecondPage\u003c/span\u003e \u003cspan class=\"n\"\u003esecondPage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnButtonClick\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esecondPage\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esecondPage\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSecondPage\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emyUsecase\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNavigation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePushAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esecondPage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこんな実装自体好ましくありませんが、生成と破棄のタイミングが「いびつ」になっていると思わぬ不具合を引き起こすかもしれない事は要注意です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"メモリリークの見つけ方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%AF%E3%81%AE%E8%A6%8B%E3%81%A4%E3%81%91%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eメモリリークの見つけ方\u003c/h2\u003e\n\n\u003cp\u003eXamarin Profiler を使う手もあるのですが、アプリの動作が重くなるので、原始的な方法 \u003cstrong\u003e「破棄されるべきオブジェクトのデストラクタでログ出力を仕掛けておき、GCを強制的に実行して確認する」\u003c/strong\u003e で行っています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"1-対象クラス-に-finalizer-を定義してログを取る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-%E5%AF%BE%E8%B1%A1%E3%82%AF%E3%83%A9%E3%82%B9-%E3%81%AB-finalizer-%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%97%E3%81%A6%E3%83%AD%E3%82%B0%E3%82%92%E5%8F%96%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. 対象クラス に Finalizer を定義してログを取る\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSecondPage\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eContentPage\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSecondPage\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMyUsecase\u003c/span\u003e \u003cspan class=\"n\"\u003emyUsecase\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call SecondPage ctor.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 省略\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"p\"\u003e~\u003c/span\u003e\u003cspan class=\"nf\"\u003eSecondPage\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call SecondPage finalizer.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"2-対象クラスのインスタンスが破棄されるべき箇所で-gccollect-を実行する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2-%E5%AF%BE%E8%B1%A1%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%8C%E7%A0%B4%E6%A3%84%E3%81%95%E3%82%8C%E3%82%8B%E3%81%B9%E3%81%8D%E7%AE%87%E6%89%80%E3%81%A7-gccollect-%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2. 対象クラスのインスタンスが破棄されるべき箇所で GC.Collect() を実行する\u003c/h3\u003e\n\n\u003cp\u003e対象クラスのインスタンスがもう不要になったと期待される箇所、例えば SecondPage ならば、FirstPage に戻ったとき（あるいは次回 SecondPage を表示したいとき）にブレークポイントで一時停止し、イミディエイトウィンドウで \u003ccode\u003eSystem.GC.Collect()\u003c/code\u003e を実行します(\u003cdel\u003e一度の GC では破棄されないかもしれないので何度か実行するとよいです\u003c/del\u003e  \u003ccode\u003eGC.Collect()\u003c/code\u003e のあとで \u003ccode\u003eGC.WaitForPendingFinalizers()\u003c/code\u003e を実行すると「ゴミが回収されるまで待つ」ことができます\u003csup id=\"fnref1\"\u003e\u003ca href=\"#fn1\" title=\"https://twitter.com/kekyo2/status/1136056968848728065 \"\u003e1\u003c/a\u003e\u003c/sup\u003e)。\u003c/p\u003e\n\n\u003cp\u003e期待通り破棄されていれば、以下のようにログに Finalizer が呼び出されたことが出力されます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ecall SecondPage finalizer.\n[Mono] GC_BRIDGE waiting for bridge processing to finish\n[art] Starting a blocking GC Explicit\n[art] Explicit concurrent mark sweep GC freed 9626(498KB) AllocSpace objects, 0(0B) LOS objects, 40% free, 2MB/3MB, paused 371us total 12.831ms\n[Mono] GC_TAR_BRIDGE bridges 179 objects 209 opaque 6 colors 179 colors-bridged 179 colors-visible 179 xref 3 cache-hit 0 cache-semihit 0 cache-miss 0 setup 0.05ms tarjan 0.09ms scc-setup 0.05ms gather-xref 0.02ms xref-setup 0.01ms cleanup 0.12ms\n[Mono] GC_BRIDGE: Complete, was running for 15.60ms\n[Mono] GC_MAJOR: (user request) time 17.94ms, stw 20.85ms los size: 1024K in use: 145K\n[Mono] GC_MAJOR_SWEEP: major size: 1968K in use: 791K\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003eログに出力されなければ、それがリークです。\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"android-アプリのライフサイクルとの関係\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#android-%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B5%E3%82%A4%E3%82%AF%E3%83%AB%E3%81%A8%E3%81%AE%E9%96%A2%E4%BF%82\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eAndroid アプリのライフサイクルとの関係\u003c/h2\u003e\n\n\u003cp\u003e冒頭でも言ったように、Xamarin.Forms アプリは 「Single Activity App」 なので、アプリに必要なオブジェクトは、全て MainActivity が保持しています。\u003c/p\u003e\n\n\u003cp\u003eすなわち、MainActivity が破棄されれば、Xamarin.Forms の世界のオブジェクトはすべて破棄されるのが望ましい、という事です。\u003cbr\u003e\nそして Android の世界において、MainActivity はまあまあ頻繁に破棄されます。他のアプリを前面に表示して利用し続けていると、裏側の Activity は OS によって勝手に破棄されることは、よく知られています。\u003c/p\u003e\n\n\u003cp\u003eこれは、Android 端末の開発者オプション - ✅\u003ca href=\"https://kijonojiron.com/android_developer_options_configuration\" rel=\"nofollow noopener\" target=\"_blank\"\u003eアクティビティを保持しない\u003c/a\u003e で容易に再現できます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/bcfc183d73289c64031a772b0acec04be55b504e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f383232372f31636538346364312d366365662d393739642d376135662d3835383433363931623537642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F8227%2F1ce84cd1-6cef-979d-7a5f-85843691b57d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5ef5f09802fc1c2cba379c44209ea34e\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/8227/1ce84cd1-6cef-979d-7a5f-85843691b57d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F8227%2F1ce84cd1-6cef-979d-7a5f-85843691b57d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b39826b776788717ab9bdd7971cf084c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eさて、MainActivity が破棄されたときに Xamarin.Forms の世界のオブジェクト、\u003ccode\u003ePage\u003c/code\u003e や \u003ccode\u003eXamarin.Forms.Application\u003c/code\u003e は破棄されるのか、確認してみます。\u003c/p\u003e\n\n\u003cp\u003e新しい Xamarin.Forms アプリのソリューションを作成し、 \u003ccode\u003eApp.xaml.cs\u003c/code\u003e, \u003ccode\u003eMainPage.xaml.cs\u003c/code\u003e、そして Android 側の \u003ccode\u003eMainActivity.cs\u003c/code\u003e のそれぞれのコンストラクタと Finalizer でログ出力します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMainPage\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eContentPage\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eMainPage\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call MainPage ctor.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e~\u003c/span\u003e\u003cspan class=\"nf\"\u003eMainPage\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call MainPage finalizer.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eApp\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eApplication\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eApp\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call App ctor.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e~\u003c/span\u003e\u003cspan class=\"nf\"\u003eApp\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call App finalizer.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMainActivity\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eglobal\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eXamarin\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eForms\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlatform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAndroid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFormsAppCompatActivity\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call MainActivity OnCreate.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call MainActivity OnDestroy.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e~\u003c/span\u003e\u003cspan class=\"nf\"\u003eMainActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call MainActivity finalizer.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれ変更を加えただけのアプリを、\u003ccode\u003eMainActivity.cs\u003c/code\u003e の \u003ccode\u003eOnDestroy\u003c/code\u003e の \u003ccode\u003eDebug.WriteLine\u003c/code\u003e の行にブレークポイントを設定した状態で、事前に「アクティビティを保持しない」設定を有効にした端末やエミュレータでデバッグ実行します。\u003c/p\u003e\n\n\u003cp\u003eホームボタンを押して、アプリをバックグラウンドに退避させると、ブレークポイントで停止するので、そこでイミディエイトウィンドウから \u003ccode\u003eGC.Collect()\u003c/code\u003e を何度か実行します。\u003c/p\u003e\n\n\u003cp\u003e何度 \u003ccode\u003eGC.Collect()\u003c/code\u003e を行っても、App や MainPage の Finalizer が呼び出されていないことに注目です。ここでこれらが破棄されることを期待していたのですが違ったようです。\u003c/p\u003e\n\n\u003cp\u003eデバッグを続行し、背面に退避したアプリを再び前面に表示します。この時には初回起動と同じく、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ecall MainActivitｙ OnCreate.\ncall App ctor.\ncall MainPage ctor.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eが出力されるはずです。つまり、この時点では、\u003ccode\u003eApp\u003c/code\u003e と \u003ccode\u003eMainPage\u003c/code\u003e は2つのインスタンスが存在する、という事です。\u003c/p\u003e\n\n\u003cp\u003eアプリが起動したらもう一度ホームボタンを押して退避させ、ブレークポイントで止めた状態で、\u003ccode\u003eGC.Collect()\u003c/code\u003e を数回呼び出します。すると、以下のように出力されるはずです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ecall MainActivity finalizer.\ncall MainPage finalizer.\ncall App finalizer.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e初回起動のときに生成されたオブジェクトが、このタイミングで破棄されました。「アクティビティを保持しない」設定によって、退避した時点で \u003ccode\u003eMainActivity\u003c/code\u003e はゴミとマークされ、次回新しい \u003ccode\u003eMainActivity\u003c/code\u003e が生成されます。ですが GC によってゴミが回収されるまでは、\u003ccode\u003eMainAcitivity\u003c/code\u003e, \u003ccode\u003eApp\u003c/code\u003e, \u003ccode\u003eMainPage\u003c/code\u003e はそれぞれ複数のインスタンスが存在し得えます。\u003c/p\u003e\n\n\u003cp\u003eこれは仕方のないことなので、せめてリソースだけは \u003ccode\u003eMainActivity.OnDestroy\u003c/code\u003e で解放されるように、\u003ccode\u003eApp\u003c/code\u003e を Disposable にしてみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eApp\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eApplication\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call App Dispose .\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMainActivity\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eglobal\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eXamarin\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eForms\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlatform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAndroid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFormsAppCompatActivity\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eApp\u003c/span\u003e \u003cspan class=\"n\"\u003eapp\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBundle\u003c/span\u003e \u003cspan class=\"n\"\u003esavedInstanceState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 省略...\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eapp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eApp\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eLoadApplication\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eapp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eapp\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\u003cspan class=\"p\"\u003e)?.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"call MainActivity OnDestroy.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eApp を Disposable にして、MainActivity の OnDestroy でそれを呼び出すようにすれば、とりあえず「アプリが破棄される」ときに Xamarin.Forms 側のリソースを解放するトリガーとして使えそうです。\u003c/p\u003e\n\n\u003cp\u003eしかしゴミとしてマークされた App や MainPage は、Dispose されつつも GC に掃除されるまで生きているので、その間に意図しない問題を引き起こす可能性に注意を払いましょう。\u003cbr\u003e\n例えば、App.Dispose で DB 接続は閉じたものの、MainPage ではタイマーを使って定期的に DB から値を得ようとしている場合などです。それぞれが決められたライフサイクルの中で動作していれば問題は起こらないでしょうが、手を抜くと後でトラブルが発生しがちです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e自分よりも生存期間が長いオブジェクトを使うとき(ViewModel to Usecase)は、「登録」に対しての「解除」が必ず必要です\u003c/li\u003e\n\u003cli\u003eXamarin.Forms の Page も App も「破棄」のタイミングを掴む方法は公式には存在しないので、\u003ccode\u003eIDisposable\u003c/code\u003e インターフェースを使って自力で実装するしかなさそうです\u003c/li\u003e\n\u003cli\u003eUsecase クラスは一般的には App の管轄なので、App の Dispose で破棄するとよいと思われます\u003c/li\u003e\n\u003cli\u003e「Dispose されたオブジェクト」にアクセスしてしまう事を想定して適切なエラー処理をしましょう\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"おまけ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%81%BE%E3%81%91\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおまけ\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eActivity.ApplicationContext\u003c/code\u003e を Xamarin.Forms 側のオブジェクトが握ってしまうと、MainActivity が破棄されずにリークするのでしょうね。\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eAndroid.apps.Application\u003c/code\u003e に持たせたオブジェクトは、最も破棄されにくく、生存期間が長くなります。\u003ccode\u003eXamarin.Forms.Application\u003c/code\u003e では生存期間が短くて要件を満たせない場合は、\u003ccode\u003eAndroid.apps.Application\u003c/code\u003e にリソースを持たせる事ができると思います。ただし前述の通りリークに注意。\u003c/li\u003e\n\u003cli\u003eAndroid の Service や、Push通知の受信、ウィジェットなどは、MainActivity とは異なる別の Activity または Context になり、Xamarin.Forms とは関係ないオブジェクト達です。それらと通信する際もやはり循環参照と生存期間の長短に気をつけるべきかと。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\n\u003cli id=\"fn1\"\u003e\n\u003cp\u003e\u003ca href=\"https://twitter.com/kekyo2/status/1136056968848728065\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://twitter.com/kekyo2/status/1136056968848728065\u003c/a\u003e  \u003ca href=\"#fnref1\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003c/ol\u003e\n\u003c/div\u003e\n","createdAt":"2019-06-04T16:05:49Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"+W3H7kzfb3oBeOj4hIQHavV2TKScj7fl--RSbibEuBZ10vKkD/--E9ErYb4ZY+pucOCNXpD+Vw==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-06-05T01:28:25Z","likesCount":16,"linkUrl":"https://qiita.com/amay077/items/76bfd558f447e8975e23","organization":null,"originalId":916622,"stockedCount":12,"title":"Xamarin.Forms アプリのリークパターンについて考える","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#viewmodel-%E3%82%92-disposable-%E3%81%AB%E3%81%97%E3%81%A6-pageondisappearing-%E3%81%A7%E7%A0%B4%E6%A3%84%E3%81%99%E3%82%8B%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3\"\u003eViewModel を Disposable にして Page.OnDisappearing で破棄するパターン\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%AF%E3%81%AE%E8%A6%8B%E3%81%A4%E3%81%91%E6%96%B9\"\u003eメモリリークの見つけ方\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1-%E5%AF%BE%E8%B1%A1%E3%82%AF%E3%83%A9%E3%82%B9-%E3%81%AB-finalizer-%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%97%E3%81%A6%E3%83%AD%E3%82%B0%E3%82%92%E5%8F%96%E3%82%8B\"\u003e1. 対象クラス に Finalizer を定義してログを取る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2-%E5%AF%BE%E8%B1%A1%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%8C%E7%A0%B4%E6%A3%84%E3%81%95%E3%82%8C%E3%82%8B%E3%81%B9%E3%81%8D%E7%AE%87%E6%89%80%E3%81%A7-gccollect-%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\"\u003e2. 対象クラスのインスタンスが破棄されるべき箇所で GC.Collect() を実行する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#android-%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B5%E3%82%A4%E3%82%AF%E3%83%AB%E3%81%A8%E3%81%AE%E9%96%A2%E4%BF%82\"\u003eAndroid アプリのライフサイクルとの関係\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%81%BE%E3%81%91\"\u003eおまけ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":4502,"uuid":"76bfd558f447e8975e23","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"Fx3S/GdbGfrmuTz0ZLjOPq3g0Q==--InonHW+mdAghIIkI--uEoS4alGt5BjF94L3Ojwgw==","originalId":8227,"description":"ランチの時は呼ぶといい！","facebookUrl":null,"githubUrl":"https://github.com/amay077","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"amay077","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/8227/profile-images/1473680950","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F8227%2Fprofile-images%2F1473680950?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=5f8a635ba49a4d77663138fe55619558","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F8227%2Fprofile-images%2F1473680950?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=c45897bd988ad06c0759e18a4161f0ce","urlName":"amay077","websiteUrl":"https://blog.amay077.net/","twitterUrl":"https://twitter.com/amay077","twitterUrlName":"amay077","revealedOrganizations":{"edges":[]}},"tags":[{"name":"Android","urlName":"android"},{"name":"C#","urlName":"csharp"},{"name":".NET","urlName":".net"},{"name":"Xamarin","urlName":"xamarin"},{"name":"Xamarin.Forms","urlName":"xamarin.forms"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
