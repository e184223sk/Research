<!DOCTYPE html><html><head><meta charset="utf-8" /><title>変更に強いアーキテクチャについてIT業界19年目の僕が超ザックリ説明する - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/lobin-z0x50/items/39131a4f47ed7c5df443" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="MfbJnfYisPACdIsxXm3D9pZPY/+zBAokeN7jXaz7ES+4//eW9vx0uBgU+oczbuqidcAjA8WWYX0oZ+r6KHUgUg==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="変更に強いアーキテクチャについてIT業界19年目の僕が超ザックリ説明する - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND01YVNKNXB1MDQ0R3I1YnkzNDRHRTQ0S2k0NE84NDRLdDQ0T0c0NEt2NDRPQjQ0T2o0NEdyNDRHazQ0R0U0NEdtU1ZUbXBhM25sWXd4T2VXNXRPZWJydU9CcnVXRGxlT0JqT2kyaGVPQ3R1T0RnLU9Dci1PRHF1aXFyT2FZanVPQm1lT0NpdyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0yMGJiYzhiYTM0NDk5ODBkZjliZDlhZDk3MzAxM2VmNg&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3h2WW1sdUxYb3dlRFV3JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9ZDA5YzgwM2I4YjJmNDEwYjFjODMzOWRhZjlkNmVmOTc&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=edc8b9bd99b8fc452105bfbe1b3b3f7e"><meta property="og:description" content="この記事は、設計・アーキテクチャ Advent Calendar 2018 の第7日目の記事である。


はじめに

この記事では、IT業界19年目の僕が実践している変更に強いアーキテクチャについて、出来るだけ難しい表現を避け、教科書..."><meta content="https://qiita.com/lobin-z0x50/items/39131a4f47ed7c5df443" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,オブジェクト指向,設計,アーキテクチャ,クラス図" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-3d273958-9aa8-47e9-8d08-3be6359770cf"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Flobin-z0x50%2Fitems%2F39131a4f47ed7c5df443">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Flobin-z0x50%2Fitems%2F39131a4f47ed7c5df443">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-3d273958-9aa8-47e9-8d08-3be6359770cf">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-12-06T21:43:43.000+09:00","dateModified":"2020-04-09T08:20:53.000+09:00","headline":"変更に強いアーキテクチャについてIT業界19年目の僕が超ザックリ説明する","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND01YVNKNXB1MDQ0R3I1YnkzNDRHRTQ0S2k0NE84NDRLdDQ0T0c0NEt2NDRPQjQ0T2o0NEdyNDRHazQ0R0U0NEdtU1ZUbXBhM25sWXd4T2VXNXRPZWJydU9CcnVXRGxlT0JqT2kyaGVPQ3R1T0RnLU9Dci1PRHF1aXFyT2FZanVPQm1lT0NpdyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0yMGJiYzhiYTM0NDk5ODBkZjliZDlhZDk3MzAxM2VmNg\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3h2WW1sdUxYb3dlRFV3JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9ZDA5YzgwM2I4YjJmNDEwYjFjODMzOWRhZjlkNmVmOTc\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=edc8b9bd99b8fc452105bfbe1b3b3f7e","mainEntityOfPage":"https://qiita.com/lobin-z0x50/items/39131a4f47ed7c5df443","author":{"@type":"Person","address":"兵庫県明石市","email":"lobin.z0x50@gmail.com","identifier":"lobin-z0x50","name":"lobin-z0x50","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars0.githubusercontent.com%2Fu%2F11419109%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=855c34f5fdd094abe9b5241d0799cde7","url":"https://qiita.com/lobin-z0x50","description":"株式会社ネオジニア 代表取締役、ITアーキテクト。\r\n大阪府岸和田市出身。\r\n組み込み開発から業務システム、スマホアプリ、Webまで幅広く開発プロジェクトに従事し、2012年に独立。\r\n従来型のSI開発に限界を感じ、変更に強いソフトウェアを日々研究し、SI業界の改革を夢見ている。\r\nいろんな言語を使うが、メインは Ruby と C#。","memberOf":[{"@type":"Organization","address":"大阪市浪速区元町1-9-9 津和九ビル7F","legalName":"株式会社ネオジニア","image":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/16459a59510f0e07fd263bcf4865d0ec31859b81/original.jpg?1596812707","logo":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/90bb8133c41e36c124364b7566b728fc85e44e2f/original.jpg?1596812707","identifier":"neogenia","description":"大阪のシステム開発会社です！"}]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">CTO業務を積極的に権限移譲するユーザベースの開発組織とは</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"lobin-z0x50","type":"items","id":"39131a4f47ed7c5df443"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"lobin-z0x50","type":"items","id":"39131a4f47ed7c5df443"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"lobin-z0x50","type":"items","id":"39131a4f47ed7c5df443"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/lobin-z0x50/items/39131a4f47ed7c5df443","location":"/lobin-z0x50/items/39131a4f47ed7c5df443","scheme":"https","host":"qiita.com","port":null,"pathname":"/lobin-z0x50/items/39131a4f47ed7c5df443","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"1LjXwaqTvHzQM/UZy0yalVUXqTHKsVbRrO6qK7lAafZdsenKqk14NMpThK+mT7PBtpjpzbwjPYj8V6OMPc5Yiw==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-90f6a930-a517-4c8b-92d1-d848a8b59071"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/lobin-z0x50/items/39131a4f47ed7c5df443/likers" class="css-1iupg5d">1036</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">1149</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/39131a4f47ed7c5df443/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/lobin-z0x50/items/39131a4f47ed7c5df443/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/lobin-z0x50/items/39131a4f47ed7c5df443/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/lobin-z0x50/items/39131a4f47ed7c5df443/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/lobin-z0x50/items/39131a4f47ed7c5df443.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2018/architecture" class="it-AdcalRibbon_title">設計・アーキテクチャ<!-- --> Advent Calendar<!-- --> <!-- -->2018</a>Day 7</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/lobin-z0x50"><img class="css-100alwu eyfquo10" src="https://avatars0.githubusercontent.com/u/11419109?v=4" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/lobin-z0x50" class="css-10ougpm">@<!-- -->lobin-z0x50</a><div class="css-1ay9vb9"><span><meta content="2018-12-06T12:43:43Z"/><time dateTime="2020-04-08T23:20:53Z" class="css-m19uds">updated at 2020-04-08</time></span></div></div></div></div></div><h1 class="css-cgzq40">変更に強いアーキテクチャについてIT業界19年目の僕が超ザックリ説明する</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/%e3%82%aa%e3%83%96%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e6%8c%87%e5%90%91" class="css-4czcte">オブジェクト指向</a><a href="/tags/%e8%a8%ad%e8%a8%88" class="css-4czcte">設計</a><a href="/tags/%e3%82%a2%e3%83%bc%e3%82%ad%e3%83%86%e3%82%af%e3%83%81%e3%83%a3" class="css-4czcte">アーキテクチャ</a><a href="/tags/%e3%82%af%e3%83%a9%e3%82%b9%e5%9b%b3" class="css-4czcte">クラス図</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>この記事は、<a href="https://qiita.com/advent-calendar/2018/architecture">設計・アーキテクチャ Advent Calendar 2018</a> の第7日目の記事である。</p>

<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<p>この記事では、IT業界19年目の僕が実践している変更に強いアーキテクチャについて、出来るだけ難しい表現を避け、教科書的なありきたりな内容ではなく現場の肌感覚に近い切り口で「超ザックリ」な解説を試みてみようと思う。</p>

<p>普段自分がよく用いている実装パターンの紹介ともいうべきかも知れない。</p>

<h3>
<span id="この記事で説明すること" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E8%AA%AC%E6%98%8E%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事で説明すること</h3>

<p>いざ「変更に強いアーキテクチャとは」とズバリ訊かれても、一概に「これだ！」という答えはない。</p>

<p>プログラミング言語や、フレームワークによっても条件が異なるし、利用可能な技術や開発チームの特性、業務要件や運用要件の特性によっても様々であるし、インフラや開発プロセスまで含めて考えると考慮すべきことは無限にある。</p>

<p>ここでは主にソフトウェアの構造という観点から、"変更に強い" ということを考えてみたいと思う。</p>

<p>早速、スマホで "変更に強い アーキテクチャ" などとググッてみると、それなりに専門的な解説が書かれているサイトがヒットすると思う。<br>
例えば、オブジェクト指向を筆頭に、インターフェースやポリモーフィズム、共通性分析だとか、DI、SOA（サービス指向設計）だとか。<br>
もちろんそれらは難解ではあるが実は重要で、役に立つ概念であり、上級者になるためには理解しておくべき概念でもある。</p>

<p>だがしかし今回のテーマは <strong>「現場の肌感覚でザックリ解説」</strong> なので、専門書やググって出てくるようなサイトの難しい表記は極力避け、なるべく分かりやすく具体的に、要点だけをかいつまんで説明しながら、最後はインタフェースを使った依存関係解消の実装例まで例示してみたいと思う。</p>

<h3>
<span id="対象とする読者層" class="fragment"></span><a href="#%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%99%E3%82%8B%E8%AA%AD%E8%80%85%E5%B1%A4"><i class="fa fa-link"></i></a>対象とする読者層</h3>

<p>対象とする読者は、プログラミング経験1年以上、詳細設計やプログラム設計は何度かやったことあるけど、あまり自信がない若手プログラマ、オブジェクト指向の言葉は知ってるけどイマイチ使いこなせてない感が残る、初級から中級へステップアップしようとしているエンジニア、俗に言う <em>IT土方</em> 、といったところか。</p>

<p>特に、オブジェクト指向の本を読んで何となく理解したけども、実際に仕事でそれを活用できていない、具体的な実装例を見てみたい、といった人をターゲットとしている。</p>

<p>この記事を読んで「なるほど、そうすればいいのか」といった気づきが得られれば幸いだ。</p>

<h2>
<span id="最もコスパの良い３つの施作" class="fragment"></span><a href="#%E6%9C%80%E3%82%82%E3%82%B3%E3%82%B9%E3%83%91%E3%81%AE%E8%89%AF%E3%81%84%EF%BC%93%E3%81%A4%E3%81%AE%E6%96%BD%E4%BD%9C"><i class="fa fa-link"></i></a>最もコスパの良い３つの施作</h2>

<p>変更に強いアーキテクチャとは、いくつもの概念や指標の組み合わせと、複雑な理論の上に成り立っている。<br>
そういったいくつもの重要な概念のうち、最もコスパの良い（経験上これだけは絶対にゆずれない、費用対効果の高い）項目をあげるとすると、以下の三つだ。</p>

<ol>
<li>適切なモジュール分割</li>
<li>依存関係を一方向にする</li>
<li>テストコード</li>
</ol>

<p>誤解の無いよう再度断っておくが、この３つだけで変更に強いアーキテクチャが必ず実現できるというものではない。<br>
上記は昨今のソフトウェアの大規模化やフレームワークの流行、実装方式のトレンドなどを鑑みて、ソフトウェア設計者が<strong>最も考慮すべきで最も効果の高い項目</strong>、といった位置づけで選出したものある。</p>

<p>ある程度の設計経験がある方なら感覚で分かると思うが、実は<strong>上記3項目には相関がある</strong>。<br>
つまり、テストコードを書くためには、モジュール間が疎結合になっている必要があり、モジュール間を疎結合にするためには適切なモジュール分割が行なわれている必要がある、ということだ。</p>

<p>したがって 1 → 2 → 3 の順に実現していく必要がある。このとき、例えば 2 までしか達成できなくとも、それなりに大きな効果がある。</p>

<h2>
<span id="1-適切なモジュール分割" class="fragment"></span><a href="#1-%E9%81%A9%E5%88%87%E3%81%AA%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E5%88%86%E5%89%B2"><i class="fa fa-link"></i></a>1. 適切なモジュール分割</h2>

<p>説明のためにひとつ身近な例を挙げよう。<br>
一般的な MVC フレームワークをモジュールという観点で考えると、Model, View, Controller にモジュールが分かれている。</p>

<p><a href="https://camo.qiitausercontent.com/ea61d65a6c332b5b96a21870556119a75dd2c1ce/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f30663138303033622d633835342d626539652d306563352d3061613333383439636530382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F0f18003b-c854-be9e-0ec5-0aa33849ce08.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7e0c3060a082f6e5d723609626d97ada" alt="図1.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/0f18003b-c854-be9e-0ec5-0aa33849ce08.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F0f18003b-c854-be9e-0ec5-0aa33849ce08.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a163e57a6aadd9ec31c2a278d98bcd1a 1x" loading="lazy"></a></p>

<p>それぞれの役割分担は以下のようになっている。</p>

<ul>
<li>M: データアクセス、業務ロジック</li>
<li>V: 画面の表示、UI</li>
<li>C: M, V の制御</li>
</ul>

<p>Model が DB に対応していて（本当はそれだけではない、後述）、Controller から呼び出すわけだが、業務ロジックを直接 Controller に書くのはよくない、みたいな意識をなんとなく持っている人はいるだろうか。<br>
実際、DBアクセス処理や外部APIの呼び出しなどを Controller 内に直接ずらずらと書き連ねていくのはよろしくない。</p>

<p>※WindowsForms の人は、Form の中にずらずらと業務ロジックを書いてあるような状況と考えて欲しい。</p>

<p>小規模なアプリケーションでは何ら問題ないが、エンタープライズシステムなどといったある程度の規模のソフトウェアでこういう作り方を続けていくと、そのうち Controller が肥大化し、苦しくなってくる（下図）<sup id="fnref1"><a href="#fn1" title="Fat Controller とも呼ばれ、アンチパターンの一つだ">1</a></sup>。</p>

<p><a href="https://camo.qiitausercontent.com/ea7e8257f325b9b9915476cd0102a78d595ac5d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f66663465363336342d613737652d646137642d303937362d3737396364313133313465332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2Fff4e6364-a77e-da7d-0976-779cd11314e3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f080b966a6939a9466adf1be1c2b5917" alt="図2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/ff4e6364-a77e-da7d-0976-779cd11314e3.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2Fff4e6364-a77e-da7d-0976-779cd11314e3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e0dd231bb949eebe3a262d86c4fbfd71 1x" loading="lazy"></a></p>

<p>かといって Controller の代わりに Model に業務ロジックを実装していっても、システムの規模が大きくなれば同じように苦しくなってくる。</p>

<p>当然テストを書くことなんて到底不可能だ。</p>

<p>ではどうしたらよいのか。</p>

<h3>
<span id="サービスの導入" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>「サービス」の導入</h3>

<p>一つの解決策は、 M, V, C 以外に、<strong>S: Service というモジュール</strong>を導入することだ<sup id="fnref2"><a href="#fn2" title="Service という言葉には別の意味があるかもしれないが、SOA（サービス指向アーキテクチャ）という考え方があり、システムの規模が巨大化していくにつれて最終的には SOA に近い形態を目指すこととなるため、僕は最初からサービスという概念で設計していっている。">2</a></sup>。</p>

<p>Service モジュール内に、業務や機能の分類ごとにサービスクラスを作っていき、<strong>業務ロジックはすべてそこに追い出して</strong>しまう。<br>
Controller は単にサービスクラスを呼び出すだけ。で、サービスの出力を View に渡したり、処理結果（または例外キャッチ）を元に画面遷移したりという風に本来の Controller の仕事に専念すればよい。</p>

<p><a href="https://camo.qiitausercontent.com/d4f18de2dd97a0044f4843491881061be49de9c4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f33363862323663392d643462342d616137352d303630382d3038356565356131633932642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F368b26c9-d4b4-aa75-0608-085ee5a1c92d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=53801f323643664b069b9b59bd8c214c" alt="図3.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/368b26c9-d4b4-aa75-0608-085ee5a1c92d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F368b26c9-d4b4-aa75-0608-085ee5a1c92d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=87faacc85d06fcdb857e3c97e7648a61 1x" loading="lazy"></a></p>

<p>"MVCSアーキテクチャ" という言葉はないのだが、まぁそんなイメージだ。<sup id="fnref3"><a href="#fn3" title="ここでいうサービスモジュールは、DDD（ドメイン駆動設計）ではドメインモデルという言葉で表されるものだ。">3</a></sup></p>

<p>注意して欲しいのは、Service モジュールは、View や Controller に依存しないように構成しなくてはならない（後述）。</p>

<p>Model には依存してかまわない<sup id="fnref4"><a href="#fn4" title="本当はデータアクセスを抽象化する「リポジトリパターン」というアーキテクチャパターンもある。とりあえずここではテストコードからも実際のDBにアクセスする前提としている。">4</a></sup>。図の中で Controller の下に Service が描いてあるのはそういう意味でもある。</p>

<h3>
<span id="サービスモデル" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A2%E3%83%87%E3%83%AB"><i class="fa fa-link"></i></a>サービスモデル</h3>

<p>こうやって小さなプロダクトを完成させたとして、それを機能拡張して改修して、と続けていくと、サービスモジュール内のあるサービスクラスが大規模化してくることが起こりうる。そしてクラスの入出力データも大規模化してくる。</p>

<p>たとえば、検索処理を行って検索結果一覧を返すサービスがあったとする。<br>
その入力は、検索条件を表す画面からのポストデータ（というか連想配列）で、その出力は Model の配列だったとしよう。</p>

<p>ところが機能拡張により検索条件が複雑化して、入力データが連想配列では苦しくなってくる。</p>

<p>そういうときには、<strong>サービスの入力データを表す新しいモデルクラス</strong>を定義し、それを使ってデータを受け渡すようにする。</p>

<p>MVCフレームワークの Model とは区別したいので、それぞれに適切な呼び名をつけよう。<br>
ここまでの説明上の流れでは、MVCフレームワークの Model はデータベースモデルを指しているとしているので、これを「EntityModel」と呼ぶ。<br>
そしてサービスの入力データは、なんでも良いのだが、ここでは「ServiceModel」とでもしておこう。</p>

<p><a href="https://camo.qiitausercontent.com/0b0b93d524f77fb379a4962e0df065166231444f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f34343532313336372d303537362d393735652d633765332d3265663234373864643764332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F44521367-0576-975e-c7e3-2ef2478dd7d3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=82f5fdb6a2b5e5f6baf9327761761c1e" alt="図4.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/44521367-0576-975e-c7e3-2ef2478dd7d3.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F44521367-0576-975e-c7e3-2ef2478dd7d3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e5548a63c76aa55b2e69d396fee3939d 1x" loading="lazy"></a></p>

<p>※なお、この図からは Model を表す箱は「データ」を意味する平行四辺形で描くことにした。<br>
視覚的に分かりやすくするためであり、それ以上の深い意図はない。</p>

<h3>
<span id="ビューモデル" class="fragment"></span><a href="#%E3%83%93%E3%83%A5%E3%83%BC%E3%83%A2%E3%83%87%E3%83%AB"><i class="fa fa-link"></i></a>ビューモデル</h3>

<p>次に、サービスの出力データが複雑化してくるケースだ。<br>
これもサービスクラスが大きくなってくると当然のように起こりうる。</p>

<p>この場合も同様に、<strong>それを表す新しいモデル</strong>を定義し、それを使ってデータを受け渡すようにする。<br>
名前は、どうしようか（名前はとても重要だ。いつも命名にそれなりの時間を要する）。<br>
サービスの出力はビューに出力するためのデータであるとすると、「ViewModel」とでも呼ぶことにする。</p>

<p><a href="https://camo.qiitausercontent.com/40603f56294781d0c0c9af381b62ec832cc453c3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f38333562653561392d326565372d346132612d616637392d3930643335343038306565612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F835be5a9-2ee7-4a2a-af79-90d354080eea.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=462506b14a12e6f3e33ae4ec06a14520" alt="図5.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/835be5a9-2ee7-4a2a-af79-90d354080eea.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F835be5a9-2ee7-4a2a-af79-90d354080eea.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=50ed77bc494513c4f3b92c71c5d21959 1x" loading="lazy"></a></p>

<p>ビューモデルを使うアーキテクチャとして MVVM <sup id="fnref5"><a href="#fn5" title="Model-View-ViewModel アーキテクチャ。Microsoft の WPF を始めフロントエンドライブラリでよく用いられる。DBに対応した Model とは別に、View に対応した ViewModel を用意し、画面項目にバインディングするような考え方。">5</a></sup> があるが、まさにそれと同じようなイメージだ。この構成は Ajax を使うときにもよくマッチする。 View がブラウザ側で動いているような構成になるが、ViewModel をそのまま Json エンコードしてフロントに返してやれば、VueJS などで直接バインディングするだけで画面に値が反映される。とても分かりやすくなるしラクになるので、オススメのアーキテクチャパターンの一つだ<sup id="fnref6"><a href="#fn6" title="この場合は MVC フレームワークの View はほぼ使わないことになる。VueJS や AngularJS などのフロントエンドで MVVM を実現するフレームワークを導入するなら、バックエンドは WebAPI としての役割に徹する方が分かりやすくなる。">6</a></sup>。</p>

<p>ViewModel という名前に違和感があるなら、違った観点から命名してもよい。<br>
例えば、WebAPI の出力を表しているのなら、WebApiResultModel としてもいいだろう。</p>

<p>このように、<strong>データの意味に基づいて</strong>〇〇モデルというように命名して、入出力データを整理していけばいいのだ。</p>

<p>※（2019-01-02 追記）個人的に Model という言葉は抽象的すぎると思っているので、例えば MVC の M がDBを表しているモデルなら <code>EntityModel</code> と呼ぼう、みたいに、具体的に〇〇モデルと呼び分ける方が整理しやすくなるし、理解しやすくなると思っている。 </p>

<p>この時、サービスの入力と出力を同一のモデルに統合してしまわないこと。<br>
本当に同じ意味のデータならそれで構わないが、意味として異なるのであれば別々のモデルとして定義するべきだ。<br>
たまに見かける失敗例の一つなので、注意して欲しい（僕も何度かやらかした記憶があるが、それは秘密にしておこう）。</p>

<h3>
<span id="バッチ処理" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>バッチ処理</h3>

<p>さてここで少し視点を変えて、バッチ処理についても考えてみたい。</p>

<p>業務システムに於いて必ずといっていい程存在するのが、スケジュールバッチや夜間バッチなどと呼ばれるいわゆる "バッチ処理" だ。<br>
現場の肌感覚で説明するといった以上、バッチ処理についても触れざるを得ない（こういった現場目線での具体例が専門書には少ないように思う）。</p>

<p>MVCに於けるコントローラと同様に、実はバッチ処理についても、バッチ本体に直接業務ロジックをダラダラと書き連ねるべきではない。</p>

<p>業務ロジックはサービスクラスとして分離独立させ、バッチからはそのサービスを呼ぶだけ、という様な構成が好ましい。<br>
つまりバッチ本体は単純なコントローラーと同じような役割となるべきだ。</p>

<p><a href="https://camo.qiitausercontent.com/2bedb0eefa18cb4441e04cd4c61a45a1a18bf86f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f35623666363437302d653737302d626232342d633463352d3265616136323966373433622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F5b6f6470-e770-bb24-c4c5-2eaa629f743b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8676eb45927f6f8f1098216e66eccea1" alt="図6.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/5b6f6470-e770-bb24-c4c5-2eaa629f743b.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F5b6f6470-e770-bb24-c4c5-2eaa629f743b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=fceab187f2b226919c149066b9442c92 1x" loading="lazy"></a></p>

<p>こうすることで、バッチ処理についてもアーキテクチャの統一感をもたらし、モジュール間の疎結合を実現し、テストコードで保護するための基本構成が得られるようになる。</p>

<h2>
<span id="2-依存関係を一方向にする" class="fragment"></span><a href="#2-%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%82%92%E4%B8%80%E6%96%B9%E5%90%91%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. 依存関係を一方向にする</h2>

<p>まず依存関係について少し掘り下げて説明しておこう。</p>

<p>あるクラス <code>A</code> とクラス <code>B</code> があるとする。<br>
<code>A</code> が <code>B</code> を利用（呼び出しや参照）しているとすると、<code>A</code> は <code>B</code> に依存していることになる。次に、<code>B</code> からは <code>A</code> を一切利用していないとすると、<code>B</code> は <code>A</code> に依存していないことになる<sup id="fnref7"><a href="#fn7" title="依存関係には度合いがあり、例えばUMLではクラスの継承(is-a), インスタンス生成(create)、所有(has-a)、利用(uses-a)というように分類わけされている。このうち利用(uses-)が最も弱い依存関係だとされており、インスタンス生成(create)は最も強い結合、プログラミング言語でいう new する事にあたる。new するには相手の実体を知っている必要があるためだ。">7</a></sup>。<br>
クラスだけでなくモジュールに於いても同様に依存関係を考えることが出来る。</p>

<p>先程少し触れたように、Service は View や Controller に<strong>依存しない</strong>ようにしなくてはならない。</p>

<p>つまり、各モジュールは下位のモジュールにのみ依存するようにして欲しい。</p>

<p>言葉で説明するとイマイチぴんと来ないかもしれないので、下図を参照して頂きたい。<br>
これまで提示してきた図を、モジュールごとの上下関係（レイヤー）と依存関係に着目して書き直してみたものだ。</p>

<p><a href="https://camo.qiitausercontent.com/1c3c0f3fa5cebe694e34d850649d1d911dcf3bd2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f32363861653530382d316165662d666561352d666665352d3534383238316131646266352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F268ae508-1aef-fea5-ffe5-548281a1dbf5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5ce6ec3f8df113800613d4eac4db9826" alt="図8.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/268ae508-1aef-fea5-ffe5-548281a1dbf5.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F268ae508-1aef-fea5-ffe5-548281a1dbf5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=444f4ff18de239306e7de2a842c68043 1x" loading="lazy"></a></p>

<p>このように、図の上の方にあるモジュールから下にあるモジュールを参照したり呼び出したりするのは構わないが、その逆はダメだ。</p>

<p>また、同列のモジュール間で相互に依存するようなことが無いように注意する<sup id="fnref8"><a href="#fn8" title="循環参照といってアンチ設計パターンの一つだ">8</a></sup>。</p>

<p>モジュール間（そしてクラス間）の依存関係を上から下へ一方向にし、レイヤーを構成させるわけだ。</p>

<p>要点としては、ある下位のレイヤー（とその下）だけを取り出して、その部分だけでも構造が成り立つような仕組みになっている必要がある。<br>
例えば Service とその依存関係にある下位のモジュール（ServiceModel, ViewModel, EntityModel）を取り出して、その部分だけで構造が成り立つようになっているのが分かるだろうか<sup id="fnref9"><a href="#fn9" title="クリーンアーキテクチャという概念がこれに近い。実際、クリーンアーキテクチャという言葉は最近知ったので、それに影響を受けているわけではない。自分の勉強不足に反省。。。">9</a></sup>。<br>
これがもし、Service から Controller への依存があったりすると、そうはいかない。Controller と Service が奇麗に分離されていないということになる。</p>

<h2>
<span id="3-テストコード" class="fragment"></span><a href="#3-%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>3. テストコード</h2>

<p>ここまでの構成が出来れば、とりあえずテストコードを書くことが出来る。</p>

<p>サービスクラスが下位のモジュールにしか依存していないので、<strong>そこだけ切り出してきて全く別のコードベースから呼び出す</strong>ことが出来るはずだからだ（下図）<sup id="fnref10"><a href="#fn10" title="テスト用にDBを分けて、テストコードからテスト用DBにアクセスするというやり方になる。本当はもっと色々考慮した方がいい事があるのは重々承知であるが、とりあえずテストコードを書くことは出来る状態になっている、ということの本質をここでは伝えたい。">10</a></sup>。</p>

<p><a href="https://camo.qiitausercontent.com/1a8fa9bbeeb5a6748a7ddbe532631ac21325a1f3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f32656461633239332d376639642d633935332d313466312d3531663564383263383066382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F2edac293-7f9d-c953-14f1-51f5d82c80f8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2cdd93f6da324e0d58aaf0ca29a94b44" alt="図7.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/2edac293-7f9d-c953-14f1-51f5d82c80f8.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F2edac293-7f9d-c953-14f1-51f5d82c80f8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=dc4b9b0ebe1a74b14c45abd28a8f7e6d 1x" loading="lazy"></a></p>

<p>これまでモジュール分割だの依存関係だのと厳しい制約のもとソフトウェアの構造を整理してきた目的は、ここにある。</p>

<h3>
<span id="テストコードを書くことのメリット" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8F%E3%81%93%E3%81%A8%E3%81%AE%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>テストコードを書くことのメリット</h3>

<p>今さらかもしれないが、テストコードを書くことのメリットをおさらいしておこう。</p>

<ul>
<li>コード修正の度にデグレが発生していないか、何度でもテストを実行して検証することができる<sup id="fnref11"><a href="#fn11" title="リグレッションテスト（回帰テスト）という">11</a></sup>
</li>
<li>テストが必ず通る状態でリリースするため、品質が向上する</li>
<li>テストコードを書くこと自体にコストがかかるが、長い目で見ると全体的なコストは必ず下がる</li>
<li>テストコードを読むことでそのクラスの使い方（仕様）が分かる</li>
<li>開発チームからすると、テストが通っているという絶対的な安心感</li>
<li>そもそもテストコードを書ける構造になっていることに価値がある</li>
</ul>

<p>最後の項目が、最初に述べた 1, 2, 3 の相関関係の裏返しとなっている。<br>
つまり、<strong>奇麗な構造になっていないとテストが書けない</strong>のだ。</p>

<p>しかしながらテストコードのないソフトウェアが依然として多い。大規模SIプロジェクトや、パッケージソフトではそのほとんどがテストコード無しという現状である。</p>

<p>一方で、テストコードを書かない文化というものもあるようで、あえてそのような選択をしている開発チームであればテストは書かなくてもよいと思う。しかし、テストを書いたこともないのに書かない選択をしているとしたら、是非この機会にチャレンジしてみて欲しい。</p>

<p>特に、プロダクトの初期構築の段階に携わっている場合は、テストコードを導入するチャンスだ。最初にテストコードが書ける構造を整備してテストを書いておかないと、後になってからテストを導入することは非常に骨の折れる作業なのだ。理由は、先述の通りソフトウェアの構造が奇麗になっていないとそもそもテストが書けないため、構造改革に甚大な労力を要するためだ。それを裏返せば、<strong>テストコードを維持し続けることでソフトウェアの構造が奇麗に保たれる</strong>、という効果が得られるのだ<sup id="fnref12"><a href="#fn12" title='"奇麗" の基準に個人差があるので賛否両論あるところかと思うが、少なくともここで言わんとしているモジュール分割と依存関係の一方向性は維持できるはずと考えている'>12</a></sup>。</p>

<h2>
<span id="サービス間の依存関係への対処" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E9%96%93%E3%81%AE%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%81%B8%E3%81%AE%E5%AF%BE%E5%87%A6"><i class="fa fa-link"></i></a>サービス間の依存関係への対処</h2>

<p>さて話を続けよう。プロダクトの構築が終わって、さらに開発が続いていったとして、コードベースが発展し大規模化してくると、サービスクラスが多くなりサービス間の依存関係が増えてくる。その度に、それらの依存関係を少しづつ減らしていく努力が必要だ。そうしないと、テストコードを書くのがだんだん苦しくなってくる。</p>

<p>例えばインスタンス生成の依存関係を解消するにはいくつか対応策があるが<sup id="fnref13"><a href="#fn13" title="興味のある方は ファクトリーパターンや、DI（Dependency Injection: 依存性の外部注入）などのキーワードでググってみて欲しい。">13</a></sup>、それらの詳細な解説は他のサイトにお任せするとして、ここでは利用の依存関係を解消するために（王道とも言われる）<strong>インターフェースを抽出する方法</strong>を説明する。</p>

<h3>
<span id="依存したサービスを切り離す" class="fragment"></span><a href="#%E4%BE%9D%E5%AD%98%E3%81%97%E3%81%9F%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%88%87%E3%82%8A%E9%9B%A2%E3%81%99"><i class="fa fa-link"></i></a>依存したサービスを切り離す</h3>

<p>説明のための例として、ここに「商品受注サービス」があるとする。これは読んで字のごとく商品の受注処理を行うビジネスロジックだと思って欲しい。</p>

<p>そしてその中では、受注データの納期をセットするために「納期検索サービス」を呼び出しているとする。</p>

<p>これらの依存関係を図で表すとこうなる。</p>

<p><a href="https://camo.qiitausercontent.com/becbe1c56670c867847b24677b2ba1be2af9d8e5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f35316335613063312d653639662d376461632d316464342d3432656134313434336532372e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F51c5a0c1-e69f-7dac-1dd4-42ea41443e27.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9cc1e5528f3b0e0a415b4d072dab8a62" alt="図9.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/51c5a0c1-e69f-7dac-1dd4-42ea41443e27.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F51c5a0c1-e69f-7dac-1dd4-42ea41443e27.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=7cadc10230536056656773f995ab501d 1x" loading="lazy"></a></p>

<p>ここで「商品受注サービス」のテストを書くことを考えてみよう。</p>

<p>このサービス（クラス）のテストを書くためには、内部で利用している納期検索サービスのためのデータ（例えば納期マスタ）を用意しておく必要がある。そうなるとテストコードを書く量が増えることになる。<br>
それに納期検索サービスにバグがある状態だったり、開発工程の関係でまだ実装されていないサービスだったりするかもしれない。</p>

<p>そもそもこれは単体テストというより、結合した状態でのテストになってしまっているのだ<sup id="fnref14"><a href="#fn14" title="もちろん結合テストのためのテストコードというものも存在する。Selenium などのテストフレームワークでは、ブラウザを実際にテストコードで操作してUIからバックエンドまでモジュール結合した状態でシナリオテストを行うようなことが出来る。インテグレーションテスト、e2eテスト（End to End Test）というキーワードで調べてみよう。">14</a></sup>。</p>

<p>テストコードを書く負荷を減らすためには、テストの粒度を下げる必要がある。すなわち何とかしてこれを単体テストにする必要がある。</p>

<p>そこでインターフェースの出番だ。</p>

<h3>
<span id="インターフェースの抽出" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%81%AE%E6%8A%BD%E5%87%BA"><i class="fa fa-link"></i></a>インターフェースの抽出</h3>

<p>まず納期検索サービスの中で必要なメソッドをインタフェースに抽出する。</p>

<p>そして「商品受注サービス」から「納期検索サービス」に依存するのではなく、そのインタフェースに依存するように変更する（下図）<sup id="fnref15"><a href="#fn15" title="オブジェクト指向でいう依存関係逆転の原則である。その原則に厳密に従うなら、インタフェースは実は商品受注サービスの側のモジュールに属している必要がある。">15</a></sup>。</p>

<p><a href="https://camo.qiitausercontent.com/cb1ec9367708ad6b760d294cc03819bfdc50b707/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f31336163653538362d646666392d313637352d336235642d3834653435336236663636612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F13ace586-dff9-1675-3b5d-84e453b6f66a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ab980965b550f7529ffa9b05f4170c9d" alt="図10.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/205835/13ace586-dff9-1675-3b5d-84e453b6f66a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F13ace586-dff9-1675-3b5d-84e453b6f66a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=388b92fb3871b24c96f84d8b944b84fe 1x" loading="lazy"></a></p>

<p>これで果たして、単体テストが書けるようになる。<br>
この後は、サンプルとして C# での実装例まで見てみてほしい。Java でも大体同じような感じだ。</p>

<h4>
<span id="c-での例簡易テストコード" class="fragment"></span><a href="#c-%E3%81%A7%E3%81%AE%E4%BE%8B%E7%B0%A1%E6%98%93%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>C# での例（簡易テストコード）</h4>

<p>いざテストを書くと言っても、書いたことない人にとっては全くどうしていいのか分からないことと思う。<br>
Qiitaを読んでいるような意識高い系の人はそんなことないのかも知れないが。</p>

<p>まず心理的ハードルを下げるために一言いっておくと、<strong>重厚長大なテストフレームワークを無理に使う必要はない</strong>のだ。<br>
エンタープライズアプリケーションの開発現場に於いて、テストフレームワークを新規導入するには時間と手間がかかるし、開発チームの他のメンバーに使い方を覚えてもらうための学習コストもかかるし、テストコードの書き方や適用範囲などの標準化まで考慮しないと、実際にテストコードを書く運用を始めることは難しいだろう（あと、大人の事情によって色々ハードルがありますよね）。</p>

<p>ここでは、簡易的にテストコードを書く方法もあるということを紹介するため、本質とはズレるかもしれないが、テストフレームワークを使わずに独立した実行モジュールを自作することでテストを書いてみる。C# を選択したのは好みの問題だ。</p>

<p>Javaでいうところの main() 関数を含むクラスを自分で書いて、コンパイルして <code>java</code> コマンドで実行する、.NET でいうところのコンソールアプリケーションを作って .exe を実行する、みたいなイメージだ。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">納期検索サービス</span></div>
<div class="highlight"><pre class="with-code"><code>
<span class="c1">// 納期の検索条件</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">DeliveryScheduleSearchConditionModel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">ProductCode</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// 商品CD</span>
<span class="p">}</span>

<span class="c1">// 納期の検索結果</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">DeliveryScheduleSearchResultModel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">DeliveryScheduleDate</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// 納期日付</span>
<span class="p">}</span>


<span class="c1">// 納期検索サービスを表すインターフェース（本当のオブジェクト指向なら商品受注サービスの方に置く）</span>
<span class="k">interface</span> <span class="nc">IDeliveryScheduleSearchSvc</span>
<span class="p">{</span>
    <span class="c1">// 検索処理</span>
    <span class="n">DeliveryScheduleSearchResultModel</span> <span class="nf">Search</span><span class="p">(</span><span class="n">DeliveryScheduleSearchConditionModel</span> <span class="n">cond</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 納期検索サービス</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">DeliveryScheduleSearchSvc</span> <span class="p">:</span> <span class="n">IDeliveryScheduleSearchSvc</span>
<span class="p">{</span>
    <span class="c1">// 検索処理の実装</span>
    <span class="k">public</span> <span class="n">DeliveryScheduleSearchResultModel</span> <span class="nf">Search</span><span class="p">(</span><span class="n">DeliveryScheduleSearchConditionModel</span> <span class="n">cond</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 省略</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">商品受注サービス</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">// 商品受注サービスの入力データ</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ReceiveOrderInputModel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">ProductCode</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// 商品CD</span>
    <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Quantity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// 数量</span>
    <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Amount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// 価格</span>

    <span class="c1">// 他にもいっぱい</span>
<span class="p">}</span>

<span class="c1">// 商品受注サービスの処理結果</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ReceiveOrderResultModel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ReceiveSatus</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// 受注状態</span>

    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">DeliveryScheduleDate</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// 納期</span>
<span class="p">}</span>

<span class="c1">// 商品受注サービス</span>
<span class="k">class</span> <span class="nc">ReceiveOrderSvc</span>
<span class="p">{</span>
    <span class="n">IDeliveryScheduleSearchSvc</span> <span class="n">_deliveryScheduleSearchSvc</span><span class="p">;</span>  <span class="c1">// 納期検索サービスのインターフェース</span>

    <span class="c1">// コンストラクタ</span>
    <span class="k">public</span> <span class="nf">ReceiveOrderSvc</span><span class="p">(</span><span class="n">IDeliveryScheduleSearchSvc</span> <span class="n">deliveryScheduleSearchSvc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_deliveryScheduleSearchSvc</span> <span class="p">=</span> <span class="n">deliveryScheduleSearchSvc</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 受注処理</span>
    <span class="k">public</span> <span class="n">ReceiveOrderResultModel</span> <span class="nf">Exec</span><span class="p">(</span><span class="n">ReceiveOrderInputModel</span> <span class="n">input</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 前処理（省略）</span>

        <span class="c1">// 納期検索サービスの入力データを作る</span>
        <span class="kt">var</span> <span class="n">deliveryScheduleSearchcond</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DeliveryScheduleSearchConditionModel</span>
        <span class="p">{</span>
            <span class="n">ProductCode</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="n">ProductCode</span>
        <span class="p">};</span>
        <span class="c1">// 納期検索サービスを呼ぶ</span>
        <span class="kt">var</span> <span class="n">searchResult</span> <span class="p">=</span> <span class="n">_deliveryScheduleSearchSvc</span><span class="p">.</span><span class="nf">Search</span><span class="p">(</span><span class="n">deliveryScheduleSearchcond</span><span class="p">);</span>


        <span class="c1">// 他にもいろいろ処理（省略）</span>


        <span class="k">return</span> <span class="k">new</span> <span class="n">ReceiveOrderResultModel</span>
        <span class="p">{</span>
            <span class="n">DeliveryScheduleDate</span> <span class="p">=</span> <span class="n">searchResult</span><span class="p">.</span><span class="n">DeliveryScheduleDate</span>  <span class="c1">// 納期検索サービスの出力データを使う</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">テストコード</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">// テストコード（コンソールアプリケーション）</span>
<span class="k">class</span> <span class="nc">TestProgram</span>
<span class="p">{</span>

    <span class="c1">// テスト用の納期検索サービス（モック）</span>
    <span class="k">class</span> <span class="nc">DeliveryScheduleSearchSvcForTest</span> <span class="p">:</span> <span class="n">IDeliveryScheduleSearchSvc</span>
    <span class="p">{</span>
        <span class="c1">// 検索条件</span>
        <span class="k">public</span> <span class="n">DeliveryScheduleSearchConditionModel</span> <span class="n">Cond</span><span class="p">;</span>

        <span class="c1">// 検索処理</span>
        <span class="k">public</span> <span class="n">DeliveryScheduleSearchResultModel</span> <span class="nf">Search</span><span class="p">(</span><span class="n">DeliveryScheduleSearchConditionModel</span> <span class="n">cond</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">Cond</span> <span class="p">=</span> <span class="n">cond</span><span class="p">;</span>  <span class="c1">// 引数を保存（テストコードで内容を検証できるように）</span>

            <span class="c1">// 都合のいいようにデータを作って返却する</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">DeliveryScheduleSearchResultModel</span>
            <span class="p">{</span>
                <span class="n">DeliveryScheduleDate</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">2018</span><span class="p">,</span> <span class="m">12</span><span class="p">,</span> <span class="m">7</span><span class="p">)</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 初期化処理（フレームワークやデータベースの初期化など）</span>

        <span class="c1">// 納期検索サービスのモックを作る</span>
        <span class="kt">var</span> <span class="n">mock</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DeliveryScheduleSearchSvcForTest</span><span class="p">();</span>

        <span class="c1">// 商品受注サービスの入力データ</span>
        <span class="kt">var</span> <span class="n">input</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ReceiveOrderInputModel</span>
        <span class="p">{</span>
            <span class="c1">// 受注内容をセット</span>
        <span class="p">};</span>

        <span class="c1">// 商品受注サービスにモックを渡してインスタンス生成</span>
        <span class="kt">var</span> <span class="n">targetSvc</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ReceiveOrderSvc</span><span class="p">(</span><span class="n">mock</span><span class="p">);</span>

        <span class="c1">// 商品受注サービスを呼び出す</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">targetSvc</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

        <span class="c1">// 結果を検証</span>
        <span class="nf">AssertEqual</span><span class="p">(</span><span class="n">ReceiveSatus</span><span class="p">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">Status</span><span class="p">);</span>
        <span class="nf">AssertEqual</span><span class="p">(</span><span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">2018</span><span class="p">,</span> <span class="m">12</span><span class="p">,</span> <span class="m">7</span><span class="p">),</span> <span class="n">result</span><span class="p">.</span><span class="n">DeliveryScheduleDate</span><span class="p">);</span>
        <span class="c1">// 以下、result の内容を検証する</span>
    <span class="p">}</span>

    <span class="c1">// 検証用のメソッド（あくまで簡易な実装例。本当はもっと考慮すべきことがある）</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">AssertEqual</span><span class="p">(</span><span class="kt">object</span> <span class="n">expected</span><span class="p">,</span> <span class="kt">object</span> <span class="n">actual</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="kt">object</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Assertion error! expected: </span><span class="p">{</span><span class="n">expected</span><span class="p">}</span><span class="s">, but actually: </span><span class="p">{</span><span class="n">actual</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>こんな風に自力でテストを書けるはずだ<sup id="fnref16"><a href="#fn16" title="なお、サンプルコード中にコメントで書いてあるように、実際にはフレームワークの初期化やDBの初期化などのお膳立てが必要となる。例えば EntityFramework なら App.config を用意するだけで何とかなるし、高級なフレームワークほど外部コードから呼び出すための手順などが整備されているようなので、詳細はフレームワークのドキュメントを参照されたい。実際、Java の Play2 + JPA の案件でこのようにして自力で簡易テストコードを書いたりしたことがあった。">16</a></sup>。</p>

<p>余談になるが、Rubyなどのダックタイピングが出来る言語で同じような構造を考える際にはインターフェースを明示的に定義することはないが、僕の頭の中ではインターフェースがあるものとしてクラスを構成しているような感触がある。<br>
動的言語の力によりインターフェースを定義しなくてよいのでコードの記述量が少なくなり、慣れればスッキリした気分で書けるが、その裏を返せば頭の中にインターフェースが見えない人にとっては、理解に時間を要したり、そもそも理解できないこともあるのだろうと思う。<br>
そういう意味では、開発者のレベルに応じてプログラミング言語を選定することも大切なんだなと思う。</p>

<h2>
<span id="あとがき" class="fragment"></span><a href="#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D"><i class="fa fa-link"></i></a>あとがき</h2>

<p>変更に強いアーキテクチャの本質は、テストフレームワークを使うことでも、優秀な設計ツールを使うことでもない。<br>
これまで見てきたように、適切にモジュール分割をして依存関係を整理し、それらをテストコードで保護していく事が本質だ。<br>
それを実施するために必要な概念を整理して知識としてまとめたものがオブジェクト指向設計論であり、テストフレームであり、ドメイン駆動開発などの方法論だと僕は思っている。<br>
方法論だけを論じても意味がない。本質を見極めて、現実世界での困りごとに適切に適用できるようになりたいものだ。</p>

<p>そうはいっても、テストフレームワークを使う方がずっと楽にテストが書けて運用しやすいので、自力で実装する例はあくまでお試し、こんなことも出来ますよ、という参考までにとどめておいて欲しい。一般的に流行しているようなフレームワークはとりあえず触れてみるなどして、継続して自分の知識をアップデートしていくべきだ。</p>

<p>ここまで、3ステップでの施策として構造設計の課題点と解決策を駆け足で見てきたが、そもそもそれらを<strong>どこまで適用するかの見極め</strong>も重要である。小規模でラピッドなプロトタイプ開発であれば、最初からコントローラに全部処理を書いてしまってもいいし、中規模まで発展することを見込むなら、ユニットテストだけでなくインテグレーションテストまで最初から用意する、みたいにケースバイケースで判断していくしかない。これにはやはりある程度の経験が必要だろう。</p>

<p>また、この記事では出来るだけ専門用語を避け、平易な表現で説明してきたが、向学の志がある方のために注釈にて専門用語の紹介を書いておいた。興味があれば自分で調べてみて欲しいと思う。</p>

<p>長くなったが、この記事によって一人でも多くの人が「テストコードを導入してみよう」と思うキッカケになれば幸いに思う。</p>

<p>現場からは以上だ。</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>Fat Controller とも呼ばれ、アンチパターンの一つだ <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p>Service という言葉には別の意味があるかもしれないが、SOA（サービス指向アーキテクチャ）という考え方があり、システムの規模が巨大化していくにつれて最終的には SOA に近い形態を目指すこととなるため、僕は最初からサービスという概念で設計していっている。 <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p>ここでいうサービスモジュールは、DDD（ドメイン駆動設計）ではドメインモデルという言葉で表されるものだ。 <a href="#fnref3">↩</a></p>
</li>

<li id="fn4">
<p>本当はデータアクセスを抽象化する「リポジトリパターン」というアーキテクチャパターンもある。とりあえずここではテストコードからも実際のDBにアクセスする前提としている。 <a href="#fnref4">↩</a></p>
</li>

<li id="fn5">
<p>Model-View-ViewModel アーキテクチャ。Microsoft の WPF を始めフロントエンドライブラリでよく用いられる。DBに対応した Model とは別に、View に対応した ViewModel を用意し、画面項目にバインディングするような考え方。 <a href="#fnref5">↩</a></p>
</li>

<li id="fn6">
<p>この場合は MVC フレームワークの View はほぼ使わないことになる。VueJS や AngularJS などのフロントエンドで MVVM を実現するフレームワークを導入するなら、バックエンドは WebAPI としての役割に徹する方が分かりやすくなる。 <a href="#fnref6">↩</a></p>
</li>

<li id="fn7">
<p>依存関係には度合いがあり、例えばUMLではクラスの継承(is-a), インスタンス生成(create)、所有(has-a)、利用(uses-a)というように分類わけされている。このうち利用(uses-)が最も弱い依存関係だとされており、インスタンス生成(create)は最も強い結合、プログラミング言語でいう new する事にあたる。new するには相手の実体を知っている必要があるためだ。 <a href="#fnref7">↩</a></p>
</li>

<li id="fn8">
<p>循環参照といってアンチ設計パターンの一つだ <a href="#fnref8">↩</a></p>
</li>

<li id="fn9">
<p>クリーンアーキテクチャという概念がこれに近い。実際、クリーンアーキテクチャという言葉は最近知ったので、それに影響を受けているわけではない。自分の勉強不足に反省。。。 <a href="#fnref9">↩</a></p>
</li>

<li id="fn10">
<p>テスト用にDBを分けて、テストコードからテスト用DBにアクセスするというやり方になる。本当はもっと色々考慮した方がいい事があるのは重々承知であるが、とりあえずテストコードを書くことは出来る状態になっている、ということの本質をここでは伝えたい。 <a href="#fnref10">↩</a></p>
</li>

<li id="fn11">
<p>リグレッションテスト（回帰テスト）という <a href="#fnref11">↩</a></p>
</li>

<li id="fn12">
<p>"奇麗" の基準に個人差があるので賛否両論あるところかと思うが、少なくともここで言わんとしているモジュール分割と依存関係の一方向性は維持できるはずと考えている <a href="#fnref12">↩</a></p>
</li>

<li id="fn13">
<p>興味のある方は ファクトリーパターンや、DI（Dependency Injection: 依存性の外部注入）などのキーワードでググってみて欲しい。 <a href="#fnref13">↩</a></p>
</li>

<li id="fn14">
<p>もちろん結合テストのためのテストコードというものも存在する。Selenium などのテストフレームワークでは、ブラウザを実際にテストコードで操作してUIからバックエンドまでモジュール結合した状態でシナリオテストを行うようなことが出来る。インテグレーションテスト、e2eテスト（End to End Test）というキーワードで調べてみよう。 <a href="#fnref14">↩</a></p>
</li>

<li id="fn15">
<p>オブジェクト指向でいう依存関係逆転の原則である。その原則に厳密に従うなら、インタフェースは実は商品受注サービスの側のモジュールに属している必要がある。 <a href="#fnref15">↩</a></p>
</li>

<li id="fn16">
<p>なお、サンプルコード中にコメントで書いてあるように、実際にはフレームワークの初期化やDBの初期化などのお膳立てが必要となる。例えば EntityFramework なら App.config を用意するだけで何とかなるし、高級なフレームワークほど外部コードから呼び出すための手順などが整備されているようなので、詳細はフレームワークのドキュメントを参照されたい。実際、Java の Play2 + JPA の案件でこのようにして自力で簡易テストコードを書いたりしたことがあった。 <a href="#fnref16">↩</a></p>
</li>

</ol>
</div>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Flobin-z0x50%2Fitems%2F39131a4f47ed7c5df443&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Flobin-z0x50%2Fitems%2F39131a4f47ed7c5df443&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/lobin-z0x50/items/39131a4f47ed7c5df443/likers" class="css-1iupg5d">1036</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">1149</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/39131a4f47ed7c5df443/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/lobin-z0x50/items/39131a4f47ed7c5df443/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/lobin-z0x50/items/39131a4f47ed7c5df443/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/lobin-z0x50/items/39131a4f47ed7c5df443/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/lobin-z0x50/items/39131a4f47ed7c5df443.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-90f6a930-a517-4c8b-92d1-d848a8b59071">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-8462fbbb-2b39-4d7d-a9e0-7af2b8cfedab"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-8462fbbb-2b39-4d7d-a9e0-7af2b8cfedab">{}</script>
      
<div id="LoginModal-react-component-dd36c26a-68fa-46f7-9a4c-1049b6c4593c"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-dd36c26a-68fa-46f7-9a4c-1049b6c4593c">{}</script>
      
<div id="StockModal-react-component-40c9cc3d-0ea3-45c2-be5d-ee8993d43c45"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-40c9cc3d-0ea3-45c2-be5d-ee8993d43c45">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;IRYoDGpzlP9f9tEhIYYmhJaXoZYPMv0MUlc71r/KHSuoHxYHaq1Qt0WWoJdMhQ/QdRjhanmgllUC7jJxO0QsVg==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003eこの記事は、\u003ca href=\"https://qiita.com/advent-calendar/2018/architecture\"\u003e設計・アーキテクチャ Advent Calendar 2018\u003c/a\u003e の第7日目の記事である。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h2\u003e\n\n\u003cp\u003eこの記事では、IT業界19年目の僕が実践している変更に強いアーキテクチャについて、出来るだけ難しい表現を避け、教科書的なありきたりな内容ではなく現場の肌感覚に近い切り口で「超ザックリ」な解説を試みてみようと思う。\u003c/p\u003e\n\n\u003cp\u003e普段自分がよく用いている実装パターンの紹介ともいうべきかも知れない。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"この記事で説明すること\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E8%AA%AC%E6%98%8E%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこの記事で説明すること\u003c/h3\u003e\n\n\u003cp\u003eいざ「変更に強いアーキテクチャとは」とズバリ訊かれても、一概に「これだ！」という答えはない。\u003c/p\u003e\n\n\u003cp\u003eプログラミング言語や、フレームワークによっても条件が異なるし、利用可能な技術や開発チームの特性、業務要件や運用要件の特性によっても様々であるし、インフラや開発プロセスまで含めて考えると考慮すべきことは無限にある。\u003c/p\u003e\n\n\u003cp\u003eここでは主にソフトウェアの構造という観点から、\"変更に強い\" ということを考えてみたいと思う。\u003c/p\u003e\n\n\u003cp\u003e早速、スマホで \"変更に強い アーキテクチャ\" などとググッてみると、それなりに専門的な解説が書かれているサイトがヒットすると思う。\u003cbr\u003e\n例えば、オブジェクト指向を筆頭に、インターフェースやポリモーフィズム、共通性分析だとか、DI、SOA（サービス指向設計）だとか。\u003cbr\u003e\nもちろんそれらは難解ではあるが実は重要で、役に立つ概念であり、上級者になるためには理解しておくべき概念でもある。\u003c/p\u003e\n\n\u003cp\u003eだがしかし今回のテーマは \u003cstrong\u003e「現場の肌感覚でザックリ解説」\u003c/strong\u003e なので、専門書やググって出てくるようなサイトの難しい表記は極力避け、なるべく分かりやすく具体的に、要点だけをかいつまんで説明しながら、最後はインタフェースを使った依存関係解消の実装例まで例示してみたいと思う。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"対象とする読者層\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%99%E3%82%8B%E8%AA%AD%E8%80%85%E5%B1%A4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e対象とする読者層\u003c/h3\u003e\n\n\u003cp\u003e対象とする読者は、プログラミング経験1年以上、詳細設計やプログラム設計は何度かやったことあるけど、あまり自信がない若手プログラマ、オブジェクト指向の言葉は知ってるけどイマイチ使いこなせてない感が残る、初級から中級へステップアップしようとしているエンジニア、俗に言う \u003cem\u003eIT土方\u003c/em\u003e 、といったところか。\u003c/p\u003e\n\n\u003cp\u003e特に、オブジェクト指向の本を読んで何となく理解したけども、実際に仕事でそれを活用できていない、具体的な実装例を見てみたい、といった人をターゲットとしている。\u003c/p\u003e\n\n\u003cp\u003eこの記事を読んで「なるほど、そうすればいいのか」といった気づきが得られれば幸いだ。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"最もコスパの良い３つの施作\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%80%E3%82%82%E3%82%B3%E3%82%B9%E3%83%91%E3%81%AE%E8%89%AF%E3%81%84%EF%BC%93%E3%81%A4%E3%81%AE%E6%96%BD%E4%BD%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e最もコスパの良い３つの施作\u003c/h2\u003e\n\n\u003cp\u003e変更に強いアーキテクチャとは、いくつもの概念や指標の組み合わせと、複雑な理論の上に成り立っている。\u003cbr\u003e\nそういったいくつもの重要な概念のうち、最もコスパの良い（経験上これだけは絶対にゆずれない、費用対効果の高い）項目をあげるとすると、以下の三つだ。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e適切なモジュール分割\u003c/li\u003e\n\u003cli\u003e依存関係を一方向にする\u003c/li\u003e\n\u003cli\u003eテストコード\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e誤解の無いよう再度断っておくが、この３つだけで変更に強いアーキテクチャが必ず実現できるというものではない。\u003cbr\u003e\n上記は昨今のソフトウェアの大規模化やフレームワークの流行、実装方式のトレンドなどを鑑みて、ソフトウェア設計者が\u003cstrong\u003e最も考慮すべきで最も効果の高い項目\u003c/strong\u003e、といった位置づけで選出したものある。\u003c/p\u003e\n\n\u003cp\u003eある程度の設計経験がある方なら感覚で分かると思うが、実は\u003cstrong\u003e上記3項目には相関がある\u003c/strong\u003e。\u003cbr\u003e\nつまり、テストコードを書くためには、モジュール間が疎結合になっている必要があり、モジュール間を疎結合にするためには適切なモジュール分割が行なわれている必要がある、ということだ。\u003c/p\u003e\n\n\u003cp\u003eしたがって 1 → 2 → 3 の順に実現していく必要がある。このとき、例えば 2 までしか達成できなくとも、それなりに大きな効果がある。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"1-適切なモジュール分割\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-%E9%81%A9%E5%88%87%E3%81%AA%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E5%88%86%E5%89%B2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. 適切なモジュール分割\u003c/h2\u003e\n\n\u003cp\u003e説明のためにひとつ身近な例を挙げよう。\u003cbr\u003e\n一般的な MVC フレームワークをモジュールという観点で考えると、Model, View, Controller にモジュールが分かれている。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ea61d65a6c332b5b96a21870556119a75dd2c1ce/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f30663138303033622d633835342d626539652d306563352d3061613333383439636530382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F0f18003b-c854-be9e-0ec5-0aa33849ce08.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7e0c3060a082f6e5d723609626d97ada\" alt=\"図1.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/0f18003b-c854-be9e-0ec5-0aa33849ce08.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F0f18003b-c854-be9e-0ec5-0aa33849ce08.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a163e57a6aadd9ec31c2a278d98bcd1a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eそれぞれの役割分担は以下のようになっている。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eM: データアクセス、業務ロジック\u003c/li\u003e\n\u003cli\u003eV: 画面の表示、UI\u003c/li\u003e\n\u003cli\u003eC: M, V の制御\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eModel が DB に対応していて（本当はそれだけではない、後述）、Controller から呼び出すわけだが、業務ロジックを直接 Controller に書くのはよくない、みたいな意識をなんとなく持っている人はいるだろうか。\u003cbr\u003e\n実際、DBアクセス処理や外部APIの呼び出しなどを Controller 内に直接ずらずらと書き連ねていくのはよろしくない。\u003c/p\u003e\n\n\u003cp\u003e※WindowsForms の人は、Form の中にずらずらと業務ロジックを書いてあるような状況と考えて欲しい。\u003c/p\u003e\n\n\u003cp\u003e小規模なアプリケーションでは何ら問題ないが、エンタープライズシステムなどといったある程度の規模のソフトウェアでこういう作り方を続けていくと、そのうち Controller が肥大化し、苦しくなってくる（下図）\u003csup id=\"fnref1\"\u003e\u003ca href=\"#fn1\" title=\"Fat Controller とも呼ばれ、アンチパターンの一つだ\"\u003e1\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ea7e8257f325b9b9915476cd0102a78d595ac5d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f66663465363336342d613737652d646137642d303937362d3737396364313133313465332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2Fff4e6364-a77e-da7d-0976-779cd11314e3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f080b966a6939a9466adf1be1c2b5917\" alt=\"図2.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/ff4e6364-a77e-da7d-0976-779cd11314e3.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2Fff4e6364-a77e-da7d-0976-779cd11314e3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e0dd231bb949eebe3a262d86c4fbfd71 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eかといって Controller の代わりに Model に業務ロジックを実装していっても、システムの規模が大きくなれば同じように苦しくなってくる。\u003c/p\u003e\n\n\u003cp\u003e当然テストを書くことなんて到底不可能だ。\u003c/p\u003e\n\n\u003cp\u003eではどうしたらよいのか。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"サービスの導入\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%B0%8E%E5%85%A5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「サービス」の導入\u003c/h3\u003e\n\n\u003cp\u003e一つの解決策は、 M, V, C 以外に、\u003cstrong\u003eS: Service というモジュール\u003c/strong\u003eを導入することだ\u003csup id=\"fnref2\"\u003e\u003ca href=\"#fn2\" title=\"Service という言葉には別の意味があるかもしれないが、SOA（サービス指向アーキテクチャ）という考え方があり、システムの規模が巨大化していくにつれて最終的には SOA に近い形態を目指すこととなるため、僕は最初からサービスという概念で設計していっている。\"\u003e2\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cp\u003eService モジュール内に、業務や機能の分類ごとにサービスクラスを作っていき、\u003cstrong\u003e業務ロジックはすべてそこに追い出して\u003c/strong\u003eしまう。\u003cbr\u003e\nController は単にサービスクラスを呼び出すだけ。で、サービスの出力を View に渡したり、処理結果（または例外キャッチ）を元に画面遷移したりという風に本来の Controller の仕事に専念すればよい。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/d4f18de2dd97a0044f4843491881061be49de9c4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f33363862323663392d643462342d616137352d303630382d3038356565356131633932642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F368b26c9-d4b4-aa75-0608-085ee5a1c92d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=53801f323643664b069b9b59bd8c214c\" alt=\"図3.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/368b26c9-d4b4-aa75-0608-085ee5a1c92d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F368b26c9-d4b4-aa75-0608-085ee5a1c92d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=87faacc85d06fcdb857e3c97e7648a61 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\"MVCSアーキテクチャ\" という言葉はないのだが、まぁそんなイメージだ。\u003csup id=\"fnref3\"\u003e\u003ca href=\"#fn3\" title=\"ここでいうサービスモジュールは、DDD（ドメイン駆動設計）ではドメインモデルという言葉で表されるものだ。\"\u003e3\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\n\u003cp\u003e注意して欲しいのは、Service モジュールは、View や Controller に依存しないように構成しなくてはならない（後述）。\u003c/p\u003e\n\n\u003cp\u003eModel には依存してかまわない\u003csup id=\"fnref4\"\u003e\u003ca href=\"#fn4\" title=\"本当はデータアクセスを抽象化する「リポジトリパターン」というアーキテクチャパターンもある。とりあえずここではテストコードからも実際のDBにアクセスする前提としている。\"\u003e4\u003c/a\u003e\u003c/sup\u003e。図の中で Controller の下に Service が描いてあるのはそういう意味でもある。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"サービスモデル\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A2%E3%83%87%E3%83%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eサービスモデル\u003c/h3\u003e\n\n\u003cp\u003eこうやって小さなプロダクトを完成させたとして、それを機能拡張して改修して、と続けていくと、サービスモジュール内のあるサービスクラスが大規模化してくることが起こりうる。そしてクラスの入出力データも大規模化してくる。\u003c/p\u003e\n\n\u003cp\u003eたとえば、検索処理を行って検索結果一覧を返すサービスがあったとする。\u003cbr\u003e\nその入力は、検索条件を表す画面からのポストデータ（というか連想配列）で、その出力は Model の配列だったとしよう。\u003c/p\u003e\n\n\u003cp\u003eところが機能拡張により検索条件が複雑化して、入力データが連想配列では苦しくなってくる。\u003c/p\u003e\n\n\u003cp\u003eそういうときには、\u003cstrong\u003eサービスの入力データを表す新しいモデルクラス\u003c/strong\u003eを定義し、それを使ってデータを受け渡すようにする。\u003c/p\u003e\n\n\u003cp\u003eMVCフレームワークの Model とは区別したいので、それぞれに適切な呼び名をつけよう。\u003cbr\u003e\nここまでの説明上の流れでは、MVCフレームワークの Model はデータベースモデルを指しているとしているので、これを「EntityModel」と呼ぶ。\u003cbr\u003e\nそしてサービスの入力データは、なんでも良いのだが、ここでは「ServiceModel」とでもしておこう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/0b0b93d524f77fb379a4962e0df065166231444f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f34343532313336372d303537362d393735652d633765332d3265663234373864643764332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F44521367-0576-975e-c7e3-2ef2478dd7d3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=82f5fdb6a2b5e5f6baf9327761761c1e\" alt=\"図4.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/44521367-0576-975e-c7e3-2ef2478dd7d3.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F44521367-0576-975e-c7e3-2ef2478dd7d3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e5548a63c76aa55b2e69d396fee3939d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e※なお、この図からは Model を表す箱は「データ」を意味する平行四辺形で描くことにした。\u003cbr\u003e\n視覚的に分かりやすくするためであり、それ以上の深い意図はない。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ビューモデル\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%93%E3%83%A5%E3%83%BC%E3%83%A2%E3%83%87%E3%83%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eビューモデル\u003c/h3\u003e\n\n\u003cp\u003e次に、サービスの出力データが複雑化してくるケースだ。\u003cbr\u003e\nこれもサービスクラスが大きくなってくると当然のように起こりうる。\u003c/p\u003e\n\n\u003cp\u003eこの場合も同様に、\u003cstrong\u003eそれを表す新しいモデル\u003c/strong\u003eを定義し、それを使ってデータを受け渡すようにする。\u003cbr\u003e\n名前は、どうしようか（名前はとても重要だ。いつも命名にそれなりの時間を要する）。\u003cbr\u003e\nサービスの出力はビューに出力するためのデータであるとすると、「ViewModel」とでも呼ぶことにする。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/40603f56294781d0c0c9af381b62ec832cc453c3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f38333562653561392d326565372d346132612d616637392d3930643335343038306565612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F835be5a9-2ee7-4a2a-af79-90d354080eea.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=462506b14a12e6f3e33ae4ec06a14520\" alt=\"図5.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/835be5a9-2ee7-4a2a-af79-90d354080eea.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F835be5a9-2ee7-4a2a-af79-90d354080eea.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=50ed77bc494513c4f3b92c71c5d21959 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eビューモデルを使うアーキテクチャとして MVVM \u003csup id=\"fnref5\"\u003e\u003ca href=\"#fn5\" title=\"Model-View-ViewModel アーキテクチャ。Microsoft の WPF を始めフロントエンドライブラリでよく用いられる。DBに対応した Model とは別に、View に対応した ViewModel を用意し、画面項目にバインディングするような考え方。\"\u003e5\u003c/a\u003e\u003c/sup\u003e があるが、まさにそれと同じようなイメージだ。この構成は Ajax を使うときにもよくマッチする。 View がブラウザ側で動いているような構成になるが、ViewModel をそのまま Json エンコードしてフロントに返してやれば、VueJS などで直接バインディングするだけで画面に値が反映される。とても分かりやすくなるしラクになるので、オススメのアーキテクチャパターンの一つだ\u003csup id=\"fnref6\"\u003e\u003ca href=\"#fn6\" title=\"この場合は MVC フレームワークの View はほぼ使わないことになる。VueJS や AngularJS などのフロントエンドで MVVM を実現するフレームワークを導入するなら、バックエンドは WebAPI としての役割に徹する方が分かりやすくなる。\"\u003e6\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cp\u003eViewModel という名前に違和感があるなら、違った観点から命名してもよい。\u003cbr\u003e\n例えば、WebAPI の出力を表しているのなら、WebApiResultModel としてもいいだろう。\u003c/p\u003e\n\n\u003cp\u003eこのように、\u003cstrong\u003eデータの意味に基づいて\u003c/strong\u003e〇〇モデルというように命名して、入出力データを整理していけばいいのだ。\u003c/p\u003e\n\n\u003cp\u003e※（2019-01-02 追記）個人的に Model という言葉は抽象的すぎると思っているので、例えば MVC の M がDBを表しているモデルなら \u003ccode\u003eEntityModel\u003c/code\u003e と呼ぼう、みたいに、具体的に〇〇モデルと呼び分ける方が整理しやすくなるし、理解しやすくなると思っている。 \u003c/p\u003e\n\n\u003cp\u003eこの時、サービスの入力と出力を同一のモデルに統合してしまわないこと。\u003cbr\u003e\n本当に同じ意味のデータならそれで構わないが、意味として異なるのであれば別々のモデルとして定義するべきだ。\u003cbr\u003e\nたまに見かける失敗例の一つなので、注意して欲しい（僕も何度かやらかした記憶があるが、それは秘密にしておこう）。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"バッチ処理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eバッチ処理\u003c/h3\u003e\n\n\u003cp\u003eさてここで少し視点を変えて、バッチ処理についても考えてみたい。\u003c/p\u003e\n\n\u003cp\u003e業務システムに於いて必ずといっていい程存在するのが、スケジュールバッチや夜間バッチなどと呼ばれるいわゆる \"バッチ処理\" だ。\u003cbr\u003e\n現場の肌感覚で説明するといった以上、バッチ処理についても触れざるを得ない（こういった現場目線での具体例が専門書には少ないように思う）。\u003c/p\u003e\n\n\u003cp\u003eMVCに於けるコントローラと同様に、実はバッチ処理についても、バッチ本体に直接業務ロジックをダラダラと書き連ねるべきではない。\u003c/p\u003e\n\n\u003cp\u003e業務ロジックはサービスクラスとして分離独立させ、バッチからはそのサービスを呼ぶだけ、という様な構成が好ましい。\u003cbr\u003e\nつまりバッチ本体は単純なコントローラーと同じような役割となるべきだ。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/2bedb0eefa18cb4441e04cd4c61a45a1a18bf86f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f35623666363437302d653737302d626232342d633463352d3265616136323966373433622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F5b6f6470-e770-bb24-c4c5-2eaa629f743b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=8676eb45927f6f8f1098216e66eccea1\" alt=\"図6.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/5b6f6470-e770-bb24-c4c5-2eaa629f743b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F5b6f6470-e770-bb24-c4c5-2eaa629f743b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=fceab187f2b226919c149066b9442c92 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこうすることで、バッチ処理についてもアーキテクチャの統一感をもたらし、モジュール間の疎結合を実現し、テストコードで保護するための基本構成が得られるようになる。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"2-依存関係を一方向にする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2-%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%82%92%E4%B8%80%E6%96%B9%E5%90%91%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2. 依存関係を一方向にする\u003c/h2\u003e\n\n\u003cp\u003eまず依存関係について少し掘り下げて説明しておこう。\u003c/p\u003e\n\n\u003cp\u003eあるクラス \u003ccode\u003eA\u003c/code\u003e とクラス \u003ccode\u003eB\u003c/code\u003e があるとする。\u003cbr\u003e\n\u003ccode\u003eA\u003c/code\u003e が \u003ccode\u003eB\u003c/code\u003e を利用（呼び出しや参照）しているとすると、\u003ccode\u003eA\u003c/code\u003e は \u003ccode\u003eB\u003c/code\u003e に依存していることになる。次に、\u003ccode\u003eB\u003c/code\u003e からは \u003ccode\u003eA\u003c/code\u003e を一切利用していないとすると、\u003ccode\u003eB\u003c/code\u003e は \u003ccode\u003eA\u003c/code\u003e に依存していないことになる\u003csup id=\"fnref7\"\u003e\u003ca href=\"#fn7\" title=\"依存関係には度合いがあり、例えばUMLではクラスの継承(is-a), インスタンス生成(create)、所有(has-a)、利用(uses-a)というように分類わけされている。このうち利用(uses-)が最も弱い依存関係だとされており、インスタンス生成(create)は最も強い結合、プログラミング言語でいう new する事にあたる。new するには相手の実体を知っている必要があるためだ。\"\u003e7\u003c/a\u003e\u003c/sup\u003e。\u003cbr\u003e\nクラスだけでなくモジュールに於いても同様に依存関係を考えることが出来る。\u003c/p\u003e\n\n\u003cp\u003e先程少し触れたように、Service は View や Controller に\u003cstrong\u003e依存しない\u003c/strong\u003eようにしなくてはならない。\u003c/p\u003e\n\n\u003cp\u003eつまり、各モジュールは下位のモジュールにのみ依存するようにして欲しい。\u003c/p\u003e\n\n\u003cp\u003e言葉で説明するとイマイチぴんと来ないかもしれないので、下図を参照して頂きたい。\u003cbr\u003e\nこれまで提示してきた図を、モジュールごとの上下関係（レイヤー）と依存関係に着目して書き直してみたものだ。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/1c3c0f3fa5cebe694e34d850649d1d911dcf3bd2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f32363861653530382d316165662d666561352d666665352d3534383238316131646266352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F268ae508-1aef-fea5-ffe5-548281a1dbf5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5ce6ec3f8df113800613d4eac4db9826\" alt=\"図8.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/268ae508-1aef-fea5-ffe5-548281a1dbf5.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F268ae508-1aef-fea5-ffe5-548281a1dbf5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=444f4ff18de239306e7de2a842c68043 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこのように、図の上の方にあるモジュールから下にあるモジュールを参照したり呼び出したりするのは構わないが、その逆はダメだ。\u003c/p\u003e\n\n\u003cp\u003eまた、同列のモジュール間で相互に依存するようなことが無いように注意する\u003csup id=\"fnref8\"\u003e\u003ca href=\"#fn8\" title=\"循環参照といってアンチ設計パターンの一つだ\"\u003e8\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cp\u003eモジュール間（そしてクラス間）の依存関係を上から下へ一方向にし、レイヤーを構成させるわけだ。\u003c/p\u003e\n\n\u003cp\u003e要点としては、ある下位のレイヤー（とその下）だけを取り出して、その部分だけでも構造が成り立つような仕組みになっている必要がある。\u003cbr\u003e\n例えば Service とその依存関係にある下位のモジュール（ServiceModel, ViewModel, EntityModel）を取り出して、その部分だけで構造が成り立つようになっているのが分かるだろうか\u003csup id=\"fnref9\"\u003e\u003ca href=\"#fn9\" title=\"クリーンアーキテクチャという概念がこれに近い。実際、クリーンアーキテクチャという言葉は最近知ったので、それに影響を受けているわけではない。自分の勉強不足に反省。。。\"\u003e9\u003c/a\u003e\u003c/sup\u003e。\u003cbr\u003e\nこれがもし、Service から Controller への依存があったりすると、そうはいかない。Controller と Service が奇麗に分離されていないということになる。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"3-テストコード\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3-%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3. テストコード\u003c/h2\u003e\n\n\u003cp\u003eここまでの構成が出来れば、とりあえずテストコードを書くことが出来る。\u003c/p\u003e\n\n\u003cp\u003eサービスクラスが下位のモジュールにしか依存していないので、\u003cstrong\u003eそこだけ切り出してきて全く別のコードベースから呼び出す\u003c/strong\u003eことが出来るはずだからだ（下図）\u003csup id=\"fnref10\"\u003e\u003ca href=\"#fn10\" title=\"テスト用にDBを分けて、テストコードからテスト用DBにアクセスするというやり方になる。本当はもっと色々考慮した方がいい事があるのは重々承知であるが、とりあえずテストコードを書くことは出来る状態になっている、ということの本質をここでは伝えたい。\"\u003e10\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/1a8fa9bbeeb5a6748a7ddbe532631ac21325a1f3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f32656461633239332d376639642d633935332d313466312d3531663564383263383066382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F2edac293-7f9d-c953-14f1-51f5d82c80f8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2cdd93f6da324e0d58aaf0ca29a94b44\" alt=\"図7.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/2edac293-7f9d-c953-14f1-51f5d82c80f8.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F2edac293-7f9d-c953-14f1-51f5d82c80f8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=dc4b9b0ebe1a74b14c45abd28a8f7e6d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれまでモジュール分割だの依存関係だのと厳しい制約のもとソフトウェアの構造を整理してきた目的は、ここにある。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"テストコードを書くことのメリット\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8F%E3%81%93%E3%81%A8%E3%81%AE%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eテストコードを書くことのメリット\u003c/h3\u003e\n\n\u003cp\u003e今さらかもしれないが、テストコードを書くことのメリットをおさらいしておこう。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eコード修正の度にデグレが発生していないか、何度でもテストを実行して検証することができる\u003csup id=\"fnref11\"\u003e\u003ca href=\"#fn11\" title=\"リグレッションテスト（回帰テスト）という\"\u003e11\u003c/a\u003e\u003c/sup\u003e\n\u003c/li\u003e\n\u003cli\u003eテストが必ず通る状態でリリースするため、品質が向上する\u003c/li\u003e\n\u003cli\u003eテストコードを書くこと自体にコストがかかるが、長い目で見ると全体的なコストは必ず下がる\u003c/li\u003e\n\u003cli\u003eテストコードを読むことでそのクラスの使い方（仕様）が分かる\u003c/li\u003e\n\u003cli\u003e開発チームからすると、テストが通っているという絶対的な安心感\u003c/li\u003e\n\u003cli\u003eそもそもテストコードを書ける構造になっていることに価値がある\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e最後の項目が、最初に述べた 1, 2, 3 の相関関係の裏返しとなっている。\u003cbr\u003e\nつまり、\u003cstrong\u003e奇麗な構造になっていないとテストが書けない\u003c/strong\u003eのだ。\u003c/p\u003e\n\n\u003cp\u003eしかしながらテストコードのないソフトウェアが依然として多い。大規模SIプロジェクトや、パッケージソフトではそのほとんどがテストコード無しという現状である。\u003c/p\u003e\n\n\u003cp\u003e一方で、テストコードを書かない文化というものもあるようで、あえてそのような選択をしている開発チームであればテストは書かなくてもよいと思う。しかし、テストを書いたこともないのに書かない選択をしているとしたら、是非この機会にチャレンジしてみて欲しい。\u003c/p\u003e\n\n\u003cp\u003e特に、プロダクトの初期構築の段階に携わっている場合は、テストコードを導入するチャンスだ。最初にテストコードが書ける構造を整備してテストを書いておかないと、後になってからテストを導入することは非常に骨の折れる作業なのだ。理由は、先述の通りソフトウェアの構造が奇麗になっていないとそもそもテストが書けないため、構造改革に甚大な労力を要するためだ。それを裏返せば、\u003cstrong\u003eテストコードを維持し続けることでソフトウェアの構造が奇麗に保たれる\u003c/strong\u003e、という効果が得られるのだ\u003csup id=\"fnref12\"\u003e\u003ca href=\"#fn12\" title='\"奇麗\" の基準に個人差があるので賛否両論あるところかと思うが、少なくともここで言わんとしているモジュール分割と依存関係の一方向性は維持できるはずと考えている'\u003e12\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"サービス間の依存関係への対処\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E9%96%93%E3%81%AE%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%81%B8%E3%81%AE%E5%AF%BE%E5%87%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eサービス間の依存関係への対処\u003c/h2\u003e\n\n\u003cp\u003eさて話を続けよう。プロダクトの構築が終わって、さらに開発が続いていったとして、コードベースが発展し大規模化してくると、サービスクラスが多くなりサービス間の依存関係が増えてくる。その度に、それらの依存関係を少しづつ減らしていく努力が必要だ。そうしないと、テストコードを書くのがだんだん苦しくなってくる。\u003c/p\u003e\n\n\u003cp\u003e例えばインスタンス生成の依存関係を解消するにはいくつか対応策があるが\u003csup id=\"fnref13\"\u003e\u003ca href=\"#fn13\" title=\"興味のある方は ファクトリーパターンや、DI（Dependency Injection: 依存性の外部注入）などのキーワードでググってみて欲しい。\"\u003e13\u003c/a\u003e\u003c/sup\u003e、それらの詳細な解説は他のサイトにお任せするとして、ここでは利用の依存関係を解消するために（王道とも言われる）\u003cstrong\u003eインターフェースを抽出する方法\u003c/strong\u003eを説明する。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"依存したサービスを切り離す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BE%9D%E5%AD%98%E3%81%97%E3%81%9F%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%88%87%E3%82%8A%E9%9B%A2%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e依存したサービスを切り離す\u003c/h3\u003e\n\n\u003cp\u003e説明のための例として、ここに「商品受注サービス」があるとする。これは読んで字のごとく商品の受注処理を行うビジネスロジックだと思って欲しい。\u003c/p\u003e\n\n\u003cp\u003eそしてその中では、受注データの納期をセットするために「納期検索サービス」を呼び出しているとする。\u003c/p\u003e\n\n\u003cp\u003eこれらの依存関係を図で表すとこうなる。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/becbe1c56670c867847b24677b2ba1be2af9d8e5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f35316335613063312d653639662d376461632d316464342d3432656134313434336532372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F51c5a0c1-e69f-7dac-1dd4-42ea41443e27.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=9cc1e5528f3b0e0a415b4d072dab8a62\" alt=\"図9.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/51c5a0c1-e69f-7dac-1dd4-42ea41443e27.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F51c5a0c1-e69f-7dac-1dd4-42ea41443e27.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=7cadc10230536056656773f995ab501d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eここで「商品受注サービス」のテストを書くことを考えてみよう。\u003c/p\u003e\n\n\u003cp\u003eこのサービス（クラス）のテストを書くためには、内部で利用している納期検索サービスのためのデータ（例えば納期マスタ）を用意しておく必要がある。そうなるとテストコードを書く量が増えることになる。\u003cbr\u003e\nそれに納期検索サービスにバグがある状態だったり、開発工程の関係でまだ実装されていないサービスだったりするかもしれない。\u003c/p\u003e\n\n\u003cp\u003eそもそもこれは単体テストというより、結合した状態でのテストになってしまっているのだ\u003csup id=\"fnref14\"\u003e\u003ca href=\"#fn14\" title=\"もちろん結合テストのためのテストコードというものも存在する。Selenium などのテストフレームワークでは、ブラウザを実際にテストコードで操作してUIからバックエンドまでモジュール結合した状態でシナリオテストを行うようなことが出来る。インテグレーションテスト、e2eテスト（End to End Test）というキーワードで調べてみよう。\"\u003e14\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cp\u003eテストコードを書く負荷を減らすためには、テストの粒度を下げる必要がある。すなわち何とかしてこれを単体テストにする必要がある。\u003c/p\u003e\n\n\u003cp\u003eそこでインターフェースの出番だ。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"インターフェースの抽出\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%81%AE%E6%8A%BD%E5%87%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eインターフェースの抽出\u003c/h3\u003e\n\n\u003cp\u003eまず納期検索サービスの中で必要なメソッドをインタフェースに抽出する。\u003c/p\u003e\n\n\u003cp\u003eそして「商品受注サービス」から「納期検索サービス」に依存するのではなく、そのインタフェースに依存するように変更する（下図）\u003csup id=\"fnref15\"\u003e\u003ca href=\"#fn15\" title=\"オブジェクト指向でいう依存関係逆転の原則である。その原則に厳密に従うなら、インタフェースは実は商品受注サービスの側のモジュールに属している必要がある。\"\u003e15\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/cb1ec9367708ad6b760d294cc03819bfdc50b707/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3230353833352f31336163653538362d646666392d313637352d336235642d3834653435336236663636612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F13ace586-dff9-1675-3b5d-84e453b6f66a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ab980965b550f7529ffa9b05f4170c9d\" alt=\"図10.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/205835/13ace586-dff9-1675-3b5d-84e453b6f66a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F205835%2F13ace586-dff9-1675-3b5d-84e453b6f66a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=388b92fb3871b24c96f84d8b944b84fe 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれで果たして、単体テストが書けるようになる。\u003cbr\u003e\nこの後は、サンプルとして C# での実装例まで見てみてほしい。Java でも大体同じような感じだ。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"c-での例簡易テストコード\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#c-%E3%81%A7%E3%81%AE%E4%BE%8B%E7%B0%A1%E6%98%93%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eC# での例（簡易テストコード）\u003c/h4\u003e\n\n\u003cp\u003eいざテストを書くと言っても、書いたことない人にとっては全くどうしていいのか分からないことと思う。\u003cbr\u003e\nQiitaを読んでいるような意識高い系の人はそんなことないのかも知れないが。\u003c/p\u003e\n\n\u003cp\u003eまず心理的ハードルを下げるために一言いっておくと、\u003cstrong\u003e重厚長大なテストフレームワークを無理に使う必要はない\u003c/strong\u003eのだ。\u003cbr\u003e\nエンタープライズアプリケーションの開発現場に於いて、テストフレームワークを新規導入するには時間と手間がかかるし、開発チームの他のメンバーに使い方を覚えてもらうための学習コストもかかるし、テストコードの書き方や適用範囲などの標準化まで考慮しないと、実際にテストコードを書く運用を始めることは難しいだろう（あと、大人の事情によって色々ハードルがありますよね）。\u003c/p\u003e\n\n\u003cp\u003eここでは、簡易的にテストコードを書く方法もあるということを紹介するため、本質とはズレるかもしれないが、テストフレームワークを使わずに独立した実行モジュールを自作することでテストを書いてみる。C# を選択したのは好みの問題だ。\u003c/p\u003e\n\n\u003cp\u003eJavaでいうところの main() 関数を含むクラスを自分で書いて、コンパイルして \u003ccode\u003ejava\u003c/code\u003e コマンドで実行する、.NET でいうところのコンソールアプリケーションを作って .exe を実行する、みたいなイメージだ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e納期検索サービス\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n\u003cspan class=\"c1\"\u003e// 納期の検索条件\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDeliveryScheduleSearchConditionModel\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eProductCode\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 商品CD\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 納期の検索結果\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDeliveryScheduleSearchResultModel\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003eDeliveryScheduleDate\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 納期日付\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"c1\"\u003e// 納期検索サービスを表すインターフェース（本当のオブジェクト指向なら商品受注サービスの方に置く）\u003c/span\u003e\n\u003cspan class=\"k\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eIDeliveryScheduleSearchSvc\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 検索処理\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDeliveryScheduleSearchResultModel\u003c/span\u003e \u003cspan class=\"nf\"\u003eSearch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDeliveryScheduleSearchConditionModel\u003c/span\u003e \u003cspan class=\"n\"\u003econd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 納期検索サービス\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDeliveryScheduleSearchSvc\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDeliveryScheduleSearchSvc\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 検索処理の実装\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDeliveryScheduleSearchResultModel\u003c/span\u003e \u003cspan class=\"nf\"\u003eSearch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDeliveryScheduleSearchConditionModel\u003c/span\u003e \u003cspan class=\"n\"\u003econd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 省略\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e商品受注サービス\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 商品受注サービスの入力データ\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eReceiveOrderInputModel\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eProductCode\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 商品CD\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003eQuantity\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 数量\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003eAmount\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 価格\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 他にもいっぱい\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 商品受注サービスの処理結果\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eReceiveOrderResultModel\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eReceiveSatus\u003c/span\u003e \u003cspan class=\"n\"\u003eStatus\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 受注状態\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003eDeliveryScheduleDate\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 納期\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 商品受注サービス\u003c/span\u003e\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eReceiveOrderSvc\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIDeliveryScheduleSearchSvc\u003c/span\u003e \u003cspan class=\"n\"\u003e_deliveryScheduleSearchSvc\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 納期検索サービスのインターフェース\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// コンストラクタ\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eReceiveOrderSvc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIDeliveryScheduleSearchSvc\u003c/span\u003e \u003cspan class=\"n\"\u003edeliveryScheduleSearchSvc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_deliveryScheduleSearchSvc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edeliveryScheduleSearchSvc\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 受注処理\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eReceiveOrderResultModel\u003c/span\u003e \u003cspan class=\"nf\"\u003eExec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eReceiveOrderInputModel\u003c/span\u003e \u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 前処理（省略）\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 納期検索サービスの入力データを作る\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edeliveryScheduleSearchcond\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDeliveryScheduleSearchConditionModel\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eProductCode\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eProductCode\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 納期検索サービスを呼ぶ\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esearchResult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_deliveryScheduleSearchSvc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSearch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edeliveryScheduleSearchcond\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\n        \u003cspan class=\"c1\"\u003e// 他にもいろいろ処理（省略）\u003c/span\u003e\n\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eReceiveOrderResultModel\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDeliveryScheduleDate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esearchResult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDeliveryScheduleDate\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 納期検索サービスの出力データを使う\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eテストコード\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// テストコード（コンソールアプリケーション）\u003c/span\u003e\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTestProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// テスト用の納期検索サービス（モック）\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDeliveryScheduleSearchSvcForTest\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDeliveryScheduleSearchSvc\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 検索条件\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDeliveryScheduleSearchConditionModel\u003c/span\u003e \u003cspan class=\"n\"\u003eCond\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 検索処理\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDeliveryScheduleSearchResultModel\u003c/span\u003e \u003cspan class=\"nf\"\u003eSearch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDeliveryScheduleSearchConditionModel\u003c/span\u003e \u003cspan class=\"n\"\u003econd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCond\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 引数を保存（テストコードで内容を検証できるように）\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 都合のいいようにデータを作って返却する\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDeliveryScheduleSearchResultModel\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDeliveryScheduleDate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2018\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e12\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e7\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 初期化処理（フレームワークやデータベースの初期化など）\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 納期検索サービスのモックを作る\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003emock\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDeliveryScheduleSearchSvcForTest\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 商品受注サービスの入力データ\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003einput\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eReceiveOrderInputModel\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 受注内容をセット\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 商品受注サービスにモックを渡してインスタンス生成\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etargetSvc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eReceiveOrderSvc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emock\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 商品受注サービスを呼び出す\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etargetSvc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 結果を検証\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eAssertEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eReceiveSatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSUCCESS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eAssertEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2018\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e12\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e7\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDeliveryScheduleDate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 以下、result の内容を検証する\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 検証用のメソッド（あくまで簡易な実装例。本当はもっと考慮すべきことがある）\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAssertEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003eexpected\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003eactual\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eexpected\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eactual\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Assertion error! expected: \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eexpected\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e, but actually: \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eactual\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこんな風に自力でテストを書けるはずだ\u003csup id=\"fnref16\"\u003e\u003ca href=\"#fn16\" title=\"なお、サンプルコード中にコメントで書いてあるように、実際にはフレームワークの初期化やDBの初期化などのお膳立てが必要となる。例えば EntityFramework なら App.config を用意するだけで何とかなるし、高級なフレームワークほど外部コードから呼び出すための手順などが整備されているようなので、詳細はフレームワークのドキュメントを参照されたい。実際、Java の Play2 + JPA の案件でこのようにして自力で簡易テストコードを書いたりしたことがあった。\"\u003e16\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cp\u003e余談になるが、Rubyなどのダックタイピングが出来る言語で同じような構造を考える際にはインターフェースを明示的に定義することはないが、僕の頭の中ではインターフェースがあるものとしてクラスを構成しているような感触がある。\u003cbr\u003e\n動的言語の力によりインターフェースを定義しなくてよいのでコードの記述量が少なくなり、慣れればスッキリした気分で書けるが、その裏を返せば頭の中にインターフェースが見えない人にとっては、理解に時間を要したり、そもそも理解できないこともあるのだろうと思う。\u003cbr\u003e\nそういう意味では、開発者のレベルに応じてプログラミング言語を選定することも大切なんだなと思う。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"あとがき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eあとがき\u003c/h2\u003e\n\n\u003cp\u003e変更に強いアーキテクチャの本質は、テストフレームワークを使うことでも、優秀な設計ツールを使うことでもない。\u003cbr\u003e\nこれまで見てきたように、適切にモジュール分割をして依存関係を整理し、それらをテストコードで保護していく事が本質だ。\u003cbr\u003e\nそれを実施するために必要な概念を整理して知識としてまとめたものがオブジェクト指向設計論であり、テストフレームであり、ドメイン駆動開発などの方法論だと僕は思っている。\u003cbr\u003e\n方法論だけを論じても意味がない。本質を見極めて、現実世界での困りごとに適切に適用できるようになりたいものだ。\u003c/p\u003e\n\n\u003cp\u003eそうはいっても、テストフレームワークを使う方がずっと楽にテストが書けて運用しやすいので、自力で実装する例はあくまでお試し、こんなことも出来ますよ、という参考までにとどめておいて欲しい。一般的に流行しているようなフレームワークはとりあえず触れてみるなどして、継続して自分の知識をアップデートしていくべきだ。\u003c/p\u003e\n\n\u003cp\u003eここまで、3ステップでの施策として構造設計の課題点と解決策を駆け足で見てきたが、そもそもそれらを\u003cstrong\u003eどこまで適用するかの見極め\u003c/strong\u003eも重要である。小規模でラピッドなプロトタイプ開発であれば、最初からコントローラに全部処理を書いてしまってもいいし、中規模まで発展することを見込むなら、ユニットテストだけでなくインテグレーションテストまで最初から用意する、みたいにケースバイケースで判断していくしかない。これにはやはりある程度の経験が必要だろう。\u003c/p\u003e\n\n\u003cp\u003eまた、この記事では出来るだけ専門用語を避け、平易な表現で説明してきたが、向学の志がある方のために注釈にて専門用語の紹介を書いておいた。興味があれば自分で調べてみて欲しいと思う。\u003c/p\u003e\n\n\u003cp\u003e長くなったが、この記事によって一人でも多くの人が「テストコードを導入してみよう」と思うキッカケになれば幸いに思う。\u003c/p\u003e\n\n\u003cp\u003e現場からは以上だ。\u003c/p\u003e\n\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\n\u003cli id=\"fn1\"\u003e\n\u003cp\u003eFat Controller とも呼ばれ、アンチパターンの一つだ \u003ca href=\"#fnref1\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn2\"\u003e\n\u003cp\u003eService という言葉には別の意味があるかもしれないが、SOA（サービス指向アーキテクチャ）という考え方があり、システムの規模が巨大化していくにつれて最終的には SOA に近い形態を目指すこととなるため、僕は最初からサービスという概念で設計していっている。 \u003ca href=\"#fnref2\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn3\"\u003e\n\u003cp\u003eここでいうサービスモジュールは、DDD（ドメイン駆動設計）ではドメインモデルという言葉で表されるものだ。 \u003ca href=\"#fnref3\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn4\"\u003e\n\u003cp\u003e本当はデータアクセスを抽象化する「リポジトリパターン」というアーキテクチャパターンもある。とりあえずここではテストコードからも実際のDBにアクセスする前提としている。 \u003ca href=\"#fnref4\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn5\"\u003e\n\u003cp\u003eModel-View-ViewModel アーキテクチャ。Microsoft の WPF を始めフロントエンドライブラリでよく用いられる。DBに対応した Model とは別に、View に対応した ViewModel を用意し、画面項目にバインディングするような考え方。 \u003ca href=\"#fnref5\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn6\"\u003e\n\u003cp\u003eこの場合は MVC フレームワークの View はほぼ使わないことになる。VueJS や AngularJS などのフロントエンドで MVVM を実現するフレームワークを導入するなら、バックエンドは WebAPI としての役割に徹する方が分かりやすくなる。 \u003ca href=\"#fnref6\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn7\"\u003e\n\u003cp\u003e依存関係には度合いがあり、例えばUMLではクラスの継承(is-a), インスタンス生成(create)、所有(has-a)、利用(uses-a)というように分類わけされている。このうち利用(uses-)が最も弱い依存関係だとされており、インスタンス生成(create)は最も強い結合、プログラミング言語でいう new する事にあたる。new するには相手の実体を知っている必要があるためだ。 \u003ca href=\"#fnref7\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn8\"\u003e\n\u003cp\u003e循環参照といってアンチ設計パターンの一つだ \u003ca href=\"#fnref8\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn9\"\u003e\n\u003cp\u003eクリーンアーキテクチャという概念がこれに近い。実際、クリーンアーキテクチャという言葉は最近知ったので、それに影響を受けているわけではない。自分の勉強不足に反省。。。 \u003ca href=\"#fnref9\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn10\"\u003e\n\u003cp\u003eテスト用にDBを分けて、テストコードからテスト用DBにアクセスするというやり方になる。本当はもっと色々考慮した方がいい事があるのは重々承知であるが、とりあえずテストコードを書くことは出来る状態になっている、ということの本質をここでは伝えたい。 \u003ca href=\"#fnref10\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn11\"\u003e\n\u003cp\u003eリグレッションテスト（回帰テスト）という \u003ca href=\"#fnref11\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn12\"\u003e\n\u003cp\u003e\"奇麗\" の基準に個人差があるので賛否両論あるところかと思うが、少なくともここで言わんとしているモジュール分割と依存関係の一方向性は維持できるはずと考えている \u003ca href=\"#fnref12\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn13\"\u003e\n\u003cp\u003e興味のある方は ファクトリーパターンや、DI（Dependency Injection: 依存性の外部注入）などのキーワードでググってみて欲しい。 \u003ca href=\"#fnref13\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn14\"\u003e\n\u003cp\u003eもちろん結合テストのためのテストコードというものも存在する。Selenium などのテストフレームワークでは、ブラウザを実際にテストコードで操作してUIからバックエンドまでモジュール結合した状態でシナリオテストを行うようなことが出来る。インテグレーションテスト、e2eテスト（End to End Test）というキーワードで調べてみよう。 \u003ca href=\"#fnref14\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn15\"\u003e\n\u003cp\u003eオブジェクト指向でいう依存関係逆転の原則である。その原則に厳密に従うなら、インタフェースは実は商品受注サービスの側のモジュールに属している必要がある。 \u003ca href=\"#fnref15\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn16\"\u003e\n\u003cp\u003eなお、サンプルコード中にコメントで書いてあるように、実際にはフレームワークの初期化やDBの初期化などのお膳立てが必要となる。例えば EntityFramework なら App.config を用意するだけで何とかなるし、高級なフレームワークほど外部コードから呼び出すための手順などが整備されているようなので、詳細はフレームワークのドキュメントを参照されたい。実際、Java の Play2 + JPA の案件でこのようにして自力で簡易テストコードを書いたりしたことがあった。 \u003ca href=\"#fnref16\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003c/ol\u003e\n\u003c/div\u003e\n","createdAt":"2018-12-06T12:43:43Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"g+uO7fgiYcqp8SwTZEmd/mwQRxq2bE/t--OrsBxPOYmDStlcQ5--TLu25ertvCz62UBg5xTUmA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-04-08T23:20:53Z","likesCount":1036,"linkUrl":"https://qiita.com/lobin-z0x50/items/39131a4f47ed7c5df443","organization":null,"originalId":734431,"stockedCount":1149,"title":"変更に強いアーキテクチャについてIT業界19年目の僕が超ザックリ説明する","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E8%AA%AC%E6%98%8E%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8\"\u003eこの記事で説明すること\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%99%E3%82%8B%E8%AA%AD%E8%80%85%E5%B1%A4\"\u003e対象とする読者層\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%80%E3%82%82%E3%82%B3%E3%82%B9%E3%83%91%E3%81%AE%E8%89%AF%E3%81%84%EF%BC%93%E3%81%A4%E3%81%AE%E6%96%BD%E4%BD%9C\"\u003e最もコスパの良い３つの施作\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#1-%E9%81%A9%E5%88%87%E3%81%AA%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E5%88%86%E5%89%B2\"\u003e1. 適切なモジュール分割\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%B0%8E%E5%85%A5\"\u003e「サービス」の導入\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A2%E3%83%87%E3%83%AB\"\u003eサービスモデル\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%93%E3%83%A5%E3%83%BC%E3%83%A2%E3%83%87%E3%83%AB\"\u003eビューモデル\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%90%E3%83%83%E3%83%81%E5%87%A6%E7%90%86\"\u003eバッチ処理\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2-%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%82%92%E4%B8%80%E6%96%B9%E5%90%91%E3%81%AB%E3%81%99%E3%82%8B\"\u003e2. 依存関係を一方向にする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3-%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89\"\u003e3. テストコード\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%9B%B8%E3%81%8F%E3%81%93%E3%81%A8%E3%81%AE%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88\"\u003eテストコードを書くことのメリット\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E9%96%93%E3%81%AE%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%81%B8%E3%81%AE%E5%AF%BE%E5%87%A6\"\u003eサービス間の依存関係への対処\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BE%9D%E5%AD%98%E3%81%97%E3%81%9F%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E5%88%87%E3%82%8A%E9%9B%A2%E3%81%99\"\u003e依存したサービスを切り離す\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%81%AE%E6%8A%BD%E5%87%BA\"\u003eインターフェースの抽出\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#c-%E3%81%A7%E3%81%AE%E4%BE%8B%E7%B0%A1%E6%98%93%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89\"\u003eC# での例（簡易テストコード）\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D\"\u003eあとがき\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":67267,"uuid":"39131a4f47ed7c5df443","banReason":null,"adventCalendarItem":{"day":7,"calendar":{"name":"設計・アーキテクチャ","urlName":"architecture","year":2018,"organization":null}},"author":{"encryptedId":"P2+qm5F4ohE8+/rviJU6vwOKvEu9--qRJIQ/ailkCbNnIr--CP6lOAPXllfhllk2SVczug==","originalId":205835,"description":"株式会社ネオジニア 代表取締役、ITアーキテクト。\r\n大阪府岸和田市出身。\r\n組み込み開発から業務システム、スマホアプリ、Webまで幅広く開発プロジェクトに従事し、2012年に独立。\r\n従来型のSI開発に限界を感じ、変更に強いソフトウェアを日々研究し、SI業界の改革を夢見ている。\r\nいろんな言語を使うが、メインは Ruby と C#。","facebookUrl":null,"githubUrl":"https://github.com/lobin-z0x50","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"Wataru Maeda","profileImageUrl":"https://avatars0.githubusercontent.com/u/11419109?v=4","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars0.githubusercontent.com%2Fu%2F11419109%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=39bb1e7bf936693cf88e0ce7fb7df741","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars0.githubusercontent.com%2Fu%2F11419109%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=855c34f5fdd094abe9b5241d0799cde7","urlName":"lobin-z0x50","websiteUrl":"http://architect-wat.hatenablog.jp/","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[{"node":{"encryptedId":"jCj1KxW9HtAj2WNENPBDKyaEcGLQa8xCbVXc--2YvoYUe+yvS5uDVV--DmwzWaQz5Yx5nkt3rOJqjg==","isBetaReleaseEnabled":false,"isFollowableByViewer":false,"isFollowedByViewer":false,"name":"株式会社ネオジニア","logoUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/90bb8133c41e36c124364b7566b728fc85e44e2f/original.jpg?1596812707","urlName":"neogenia","description":"大阪のシステム開発会社です！","url":"https://www.neogenia.co.jp/"}}]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"オブジェクト指向","urlName":"%e3%82%aa%e3%83%96%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e6%8c%87%e5%90%91"},{"name":"設計","urlName":"%e8%a8%ad%e8%a8%88"},{"name":"アーキテクチャ","urlName":"%e3%82%a2%e3%83%bc%e3%82%ad%e3%83%86%e3%82%af%e3%83%81%e3%83%a3"},{"name":"クラス図","urlName":"%e3%82%af%e3%83%a9%e3%82%b9%e5%9b%b3"}],"followingLikers":{"edges":[]},"comments":{"totalCount":9}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
