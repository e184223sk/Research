More than 1 year has passed since last update.AzureのAPIを使用して、ささっと画像ファイルから顔情報を取得してみます。意外とハードルが低いので、これをベースに他のAPIやアイデアと紐づけると面白いものが作れそうですよね。Microsoft Azure Face API（のDetect機能）Azureの中でもCognitive Servicesと呼ばれる、AIや機械学習を用いたサービスの内の一つです。画像ファイル内に含まれる人物の顔を検出したり、比較対象の画像に写っている人が同一人物かを検証できたりします。
Face API紹介ページにデモがあるので、実際にどういうことができるのか試してみると面白いです。
今回使用するのはDetect（顔検出）という機能ですが、Face APIではこの他に以下の機能が提供されています。①Find Similar
②Group
③Identify
④Verify
※①③④を利用するためにはDetect実行時に発行されるFace IDが必要となります。こちらのページから、「Face」という項目の横にある「APIキーの取得」というボタンを選択してください。
まだAzureのアカウントを持っていない方は以下のような画面が出ると思います。
Azureのサービスを利用するために、まずはアカウントを登録する必要があります。

こちらにも書いてありますが、Face APIは「20件のトランザクション／分」であれば毎月30,000トランザクションまでは無料で使用できるようです。お試しで利用する分にはとりあえず問題ないかと思います。
とりあえずやってみたいということであれば、7日間だけ利用できるゲストユーザーでもいいでしょう。登録できたら、以下のような画面が表示されると思います。

この内、「キー１」または「キー２」がAPIキーです。この後使うので、メモしておいてください。
ちなみになぜAPIキーが２つあるのかは不明です…。
とりあえずどちらを使っても問題なくデータが取得できました。ソースコードは公式のFace APIクイックスタートに記載のサンプルを持ってきて、一部コメントを日本語にしただけです。こう書けば使えるよ！という情報は公式ページ見れば全部載っています。
（この記事の意味…？）今回はC#で書いてますが、Face APIクイックスタートの遷移先のサイドバーから以下のサンプルも表示できます。
（GO, Java, JavaScript, Node.js, PHP, Python, Ruby, cURL）以下はC#のコンソールアプリ（.NET Framework）のソースです。
新規プロジェクトを作成して、using含めコピペしてください。const string subscriptionKey = "あなたのAPIキー";を、先ほどメモしたAPIキーに書き換えてください。実行してコンソール上で画像ファイルのパスを指定してあげれば、解析結果が返ってきます。簡単ですね。uriBaseにはFace API取得時に表示された「エンドポイント＋/detect」で、接続先のURLを設定しています。なのでもしFace APIのFind Similarを使う場合には「エンドポイント＋/findsimilars」のように指定することになります。
もっと具体的なURLの書き方についてはFace API公式リファレンスの「Request URL」の項目を参考にしてみてください。また、requestParametersのreturnFaceAttributes=の後に指定している項目が、顔の属性としてJSON形式で返ってきます。例えば年齢と性別の情報だけが欲しければ、
"&amp;returnFaceAttributes=age,gender"
としてあげればOKです。上記コードを実行してリクエストが成功すれば、画像の解析結果がJSONで返ってきます。今回はぱくたそよりダウンロードした以下の画像を使用してみます。

ちなみにJPEG、PNG、GIF（検出対象は最初のフレームのみ）、BMPの画像ファイルがサポートされており、画像サイズは1KB以上、6MB以下でなければなりません。Face APIに画像を投げると、以下のJSONがかえってきました。
右側の「◆」「・」に各項目の説明を記載しています。結構詳細にわかりますね。
今回は1人分だけですが、同じ画像に2人以上写っていた場合、検出できた人数分の配列が返ってきます。
Detectだけでも、趣味レベルでの単純な画像ファイルの振り分けなどいろいろできそうです。ちなみに以下のように人の顔が写っていない（と認識された）場合、

特にエラーとはならずに空っぽの[]が返ってきます。今回はFace APIを使用して画像から顔の属性を検出してみました。
次回はDetectで取得したFace IDを使って、2枚の画像の中に同じ人物がいるかを検出してみたいと思います。・Face API紹介ページ
・Face APIクイックスタート（サンプルコード）
・Face API公式リファレンス


