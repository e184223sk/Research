<!DOCTYPE html><html><head><meta charset="utf-8" /><title>C#クイズとその解説 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/matarillo/items/39e8666652f11d5c98d9" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="4tf1+MvOKrsZGQ10yILTw1L1Tu9IJh+ZsR9xBFWWFvwVHU5+/VXb6I8kAYyC3rf+xMFQaWwmFMGU7zfjK4licA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@matarillo" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="C#クイズとその解説 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReVBqZ3FfamdxVGpncnJqZ2FqamdaM2pnYTdvcDZQb3FxdyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0xYzk2NDYwMGQxZjZjMDIwOTM0OTk0ZmE0YjY1OWI5NQ&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzFoZEdGeWFXeHNidyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTcyNzI1Y2NmNzc5N2ZmODNhNDc5NTIyOTlhNTJmNGZl&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=95fdeaa6d689343d64b2a213f08e9317"><meta property="og:description" content="元ネタはEric Lippertのブログです。コードは少し改変していますが、言っていることは同じです。


A dynamic definite assignment puzzle
A dynamic definite assignm..."><meta content="https://qiita.com/matarillo/items/39e8666652f11d5c98d9" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,dynamic,演算子オーバーロード" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-822c778a-619d-461d-bb9a-23dd5535640e"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fmatarillo%2Fitems%2F39e8666652f11d5c98d9">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fmatarillo%2Fitems%2F39e8666652f11d5c98d9">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-822c778a-619d-461d-bb9a-23dd5535640e">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-11-28T15:44:06.000+09:00","dateModified":"2018-12-13T11:46:52.000+09:00","headline":"C#クイズとその解説","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReVBqZ3FfamdxVGpncnJqZ2FqamdaM2pnYTdvcDZQb3FxdyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0xYzk2NDYwMGQxZjZjMDIwOTM0OTk0ZmE0YjY1OWI5NQ\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzFoZEdGeWFXeHNidyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTcyNzI1Y2NmNzc5N2ZmODNhNDc5NTIyOTlhNTJmNGZl\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=95fdeaa6d689343d64b2a213f08e9317","mainEntityOfPage":"https://qiita.com/matarillo/items/39e8666652f11d5c98d9","author":{"@type":"Person","address":null,"email":null,"identifier":"matarillo","name":"matarillo","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F2079%2Fprofile-images%2F1473680702?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=f5d14452e90e4b7c9f5d33050622ea16","url":"https://qiita.com/matarillo","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202106-uzabase-3/">経済情報で世界を変えていけているユーザベースの可能性</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202106-uzabase-3/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"matarillo","type":"items","id":"39e8666652f11d5c98d9"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"経済情報で世界を変えていけているユーザベースの可能性","url":"https://zine.qiita.com/interview/202106-uzabase-3/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"matarillo","type":"items","id":"39e8666652f11d5c98d9"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"経済情報で世界を変えていけているユーザベースの可能性","url":"https://zine.qiita.com/interview/202106-uzabase-3/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"matarillo","type":"items","id":"39e8666652f11d5c98d9"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"経済情報で世界を変えていけているユーザベースの可能性","url":"https://zine.qiita.com/interview/202106-uzabase-3/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/matarillo/items/39e8666652f11d5c98d9","location":"/matarillo/items/39e8666652f11d5c98d9","scheme":"https","host":"qiita.com","port":null,"pathname":"/matarillo/items/39e8666652f11d5c98d9","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"ef7TQAnXIvRUxQOHx8LNND7Ug0ZX59TTTXnUiz2TnrmONGjGP0zTp8L4D3+NnqkJqOCdwHPn34toiZJsQ4zqNQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-9a16f0f4-44d9-47b7-8973-c5bd7740a56b"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/matarillo/items/39e8666652f11d5c98d9/likers" class="css-1iupg5d">19</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">5</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/39e8666652f11d5c98d9/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/matarillo/items/39e8666652f11d5c98d9/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/matarillo/items/39e8666652f11d5c98d9/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/matarillo/items/39e8666652f11d5c98d9/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/matarillo/items/39e8666652f11d5c98d9.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2018/c-sharp-2" class="it-AdcalRibbon_title">C# その2 <!-- --> Advent Calendar<!-- --> <!-- -->2018</a>Day 2</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/matarillo"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/2079/profile-images/1473680702" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/matarillo" class="css-10ougpm">@<!-- -->matarillo</a><div class="css-1ay9vb9"><span><meta content="2018-11-28T06:44:06Z"/><time dateTime="2018-12-13T02:46:52Z" class="css-m19uds">updated at 2018-12-13</time></span></div></div></div></div></div><h1 class="css-cgzq40">C#クイズとその解説</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/dynamic" class="css-4czcte">dynamic</a><a href="/tags/%e6%bc%94%e7%ae%97%e5%ad%90%e3%82%aa%e3%83%bc%e3%83%90%e3%83%bc%e3%83%ad%e3%83%bc%e3%83%89" class="css-4czcte">演算子オーバーロード</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>元ネタはEric Lippertのブログです。コードは少し改変していますが、言っていることは同じです。</p>

<ul>
<li><a href="https://ericlippert.com/2018/11/14/a-dynamic-definite-assignment-puzzle/" rel="nofollow noopener" target="_blank">A dynamic definite assignment puzzle</a></li>
<li><a href="https://ericlippert.com/2018/11/19/a-dynamic-definite-assignment-puzzle-part-2/" rel="nofollow noopener" target="_blank">A dynamic definite assignment puzzle, part 2</a></li>
</ul>

<h1>
<span id="クイズ" class="fragment"></span><a href="#%E3%82%AF%E3%82%A4%E3%82%BA"><i class="fa fa-link"></i></a>クイズ</h1>

<p>次のコードがあります。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">object</span> <span class="n">obj</span> <span class="p">=</span> <span class="nf">GetObject</span><span class="p">();</span> <span class="c1">// ★</span>
        <span class="kt">string</span> <span class="n">str</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">obj</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">((</span><span class="n">str</span> <span class="p">=</span> <span class="nf">GetString</span><span class="p">())</span> <span class="p">!=</span> <span class="k">null</span><span class="p">))</span> <span class="c1">// ◆</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">obj</span> <span class="p">+</span> <span class="n">str</span><span class="p">);</span> <span class="c1">// ▲</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">object</span> <span class="nf">GetObject</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">"hello"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetString</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">"goodbye"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>このコードは普通にコンパイルも通りますし動作しますが、★印をつけた7行目を次のように変更すると</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>        <span class="kt">dynamic</span> <span class="n">obj</span> <span class="p">=</span> <span class="nf">GetObject</span><span class="p">();</span> <span class="c1">// ★ 変数の型をdynamicに変更</span>
</code></pre></div></div>

<p>とたんに▲印をつけた9行目でコンパイルが通らなくなります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>Compilation error (line 9, col 44): Use of unassigned local variable 'str'
</code></pre></div></div>

<p>エラーメッセージは、<code>str</code>変数が初期化されていないというものです。<br>
確かに、6行目で変数を定義したときは初期化していないのですが、◆印をつけた7行目の<code>if</code>文の条件式の中、<code>&amp;&amp;</code>演算子の右側で初期化しています。<br>
<code>&amp;&amp;</code>の意味を考えると、9行目に到達するには<code>str</code>を初期化するコードも評価実行されるはずですし、実際最初の段階ではコンパイルできていたのですが、どうしてこうなるのでしょうか。</p>

<p>気になる人は<a href="https://dotnetfiddle.net/lxHExk" rel="nofollow noopener" target="_blank">オンラインのPlaygroundで試してみてください</a>。</p>

<h1>
<span id="解説" class="fragment"></span><a href="#%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>解説</h1>

<h2>
<span id="dynamic型" class="fragment"></span><a href="#dynamic%E5%9E%8B"><i class="fa fa-link"></i></a><code>dynamic</code>型</h2>

<p>C#は基本的には静的に型をチェックするタイプのプログラミング言語ですが、いくつか例外があります。その一つがこの<code>dynamic</code>型で、この型の値に対する操作、たとえばメソッド呼び出しやフィールド参照など、についてはその存在がコンパイル時にはチェックされず、実行時にしかチェックされなくなります。</p>

<p>それだけではなく、<code>dynamic</code>型の変数があったとすると、その変数が実際にはどんな型の値を保持しているかについて、仮定も追跡もせず、いつも不確定として扱われます。<br>
今回のクイズのコードで言えば、<code>GetObject()</code>が<code>object</code>型（実体は<code>string</code>）を返すこと、<code>obj</code>変数はローカル変数なので、知らぬ間に外部から値が書き換えられたりしない<sup id="fnref1"><a href="#fn1" title="refを使って明示的に参照渡しをすれば書き換えることもできますが、それは意図的にやることですね。">1</a></sup>こと、などは明白なのですが、それでも◆印をつけた7行目の<code>if</code>文の条件式においては、<code>obj</code>にどんな値が入っているかは実行してみるまでわからない、という風にコンパイラは扱います。<br>
それにしても、コンパイルが通らなくなるのは不思議ですね。<code>obj</code>変数に「なにか謎の型の値」が入っていた場合に<code>str</code>が初期化されなくなるようなことが起こり得るとでも言うのでしょうか。<strong>実はその通り</strong>なのです。そしてそこには、演算子オーバーロードが関係しています。</p>

<h2>
<span id="nullチェックと演算子" class="fragment"></span><a href="#null%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%A8%E6%BC%94%E7%AE%97%E5%AD%90"><i class="fa fa-link"></i></a>nullチェックと演算子</h2>

<p>◆印をつけた7行目の<code>if</code>文の条件式を見ると、<code>obj</code>変数と<code>null</code>を比較しています。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="p">(</span><span class="n">obj</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</code></pre></div></div>

<p>普通はこのようなコードでnullチェックができるのですが、<code>obj</code>の型によっては期待する動きにならない可能性もあるのです。それは、<code>obj</code>の型が<strong>等値演算子 <code>==</code> と 非等値演算子 <code>!=</code> をオーバーロード定義して、独自の処理にしている場合</strong>です。（<code>==</code>演算子と<code>!=</code>演算子は、かならずペアでオーバーロード定義する必要があります<sup id="fnref2"><a href="#fn2" title="Equals()とGetHashCode()もオーバーライドしないとコンパイル時に警告が出ます。ですが今回は無視します。">2</a></sup>。）</p>

<p>たとえば以下のような<code>Weird</code>クラスがあるとします。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">Weird</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="p">==(</span><span class="n">Weird</span> <span class="n">left</span><span class="p">,</span> <span class="n">Weird</span> <span class="n">right</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="p">!=(</span><span class="n">Weird</span> <span class="n">left</span><span class="p">,</span> <span class="n">Weird</span> <span class="n">right</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>上のコードでは、<code>Weird</code>型同士に対する <code>==</code>演算も<code>!=</code>演算も、いつでも<code>true</code>を返します。ということは、</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="n">Weird</span> <span class="n">obj</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>こんなコードを書くと、<code>obj</code>がnullでないことを確認したつもりが、実際はnullにもかかわらず条件式が真になってしまうので、<code>ToString()</code>メソッド呼び出しのところで<code>NullReferenceException</code>が投げられてしまいます！</p>

<p>ここで教訓の1つ目。</p>

<p><strong>等値演算子がオーバーロードされているときは、<code>null</code>と比較してもnullチェックにならないことがある。</strong></p>

<p>この教訓はあくまで、クラスの利用側で安全側に倒す方針を取るときのものです。クラスの定義側で等値演算子をオーバーロードするときは、<code>null</code>との比較がおかしなことになるようなコードを書くべきではありません！</p>

<p>とはいえ、C#を採用していることで有名なゲームプラットフォームである<a href="https://unity3d.com/jp" rel="nofollow noopener" target="_blank">Unity</a>では、<a href="https://docs.unity3d.com/ja/current/ScriptReference/Object.Destroy.html" rel="nofollow noopener" target="_blank"><code>UnityEngine.Object.Destroy()</code>メソッド</a>で破壊されたオブジェクトは、その後<code>null</code>との比較が<code>true</code>を返すようになります。</p>

<p>参考：<a href="https://qiita.com/RyotaMurohoshi/items/339d77d10b89198ce4fc" id="reference-80acf39e16099a43638b">GameObjectやComponentをnullと比較するときの落し穴</a></p>

<p>そのような、比較演算子がオーバーロードされている（かもしれない）状況で、本当に<code>null</code>かどうかをチェックしたい場合は、以下のような選択肢があります<sup id="fnref3"><a href="#fn3" title="岩永さんのコメントを受けて編集しました。">3</a></sup>。</p>

<ul>
<li>
<a href="https://docs.microsoft.com/ja-jp/dotnet/csharp/pattern-matching" rel="nofollow noopener" target="_blank">パターンマッチ</a>でnullチェックをする</li>
<li>
<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.object.referenceequals" rel="nofollow noopener" target="_blank"><code>System.Object.ReferenceEquals()</code>静的メソッド</a>を呼び出す</li>
<li>
<code>object</code>型にアップキャストしてから比較演算子を使う</li>
</ul>

<p>C# 7以降のパターンマッチでは、型パターンを使った場合<code>null</code>とはマッチしないので<code>null</code>でないことが確かめられます。また、<code>null</code>定数パターンを使った場合<code>null</code>にしかマッチしません。</p>

<p><code>null</code>定数パターンでnullチェックをするコード例はこうなります。単純ですね。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="p">(</span><span class="n">obj</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span>
</code></pre></div></div>

<p>さて、これで最初のコードの謎が解けた……と思ったら、そうではありません。</p>

<p><code>!=</code>演算子がオーバーロードされているとしても、<code>true</code>を返すのであれば <code>&amp;&amp;</code> の右側が評価されて<code>str</code>は初期化されるはずだし、<code>false</code>を返すのであれば<code>if</code>文の条件式そのものが<code>false</code>になるので▲の印をつけた9行目は実行されないわけですから、コンパイルエラーになるのはおかしいのです。</p>

<p>では、等値演算子が<code>bool</code>型を返さないとしたら？</p>

<p>そんなことができるのか？というと、<strong>できます</strong>。演算子のオーバーロードでは、一部の単項演算子<sup id="fnref4"><a href="#fn4" title="true演算子とfalse演算子はbool型しか返せません。++演算子と--演算子は元の型かその派生型しか返せません。">4</a></sup>を除き、演算結果を独自の型にすることができるのです。たとえば、<code>Weird</code>クラスの<code>==</code>演算子と<code>!=</code>演算子を次のように書き直してみます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">Weird</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">CustomBoolean</span> <span class="k">operator</span> <span class="p">==(</span><span class="n">Weird</span> <span class="n">left</span><span class="p">,</span> <span class="n">Weird</span> <span class="n">right</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomBoolean</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">CustomBoolean</span> <span class="k">operator</span> <span class="p">!=(</span><span class="n">Weird</span> <span class="n">left</span><span class="p">,</span> <span class="n">Weird</span> <span class="n">right</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomBoolean</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">CustomBoolean</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>

<p>このようにカスタムの<code>CustomBoolean</code>という型を返すように演算子を定義したとしても<code>Weird</code>クラス自体はコンパイルに通ります。</p>

<p>ですが、このままでは次の２つの問題があります。</p>

<ul>
<li>◆印をつけた7行目の<code>if</code>文の条件式にあるような、 <code>CustomBoolean</code> 型と <code>bool</code> 型に対する <code>&amp;&amp;</code> 演算をどう定義するか</li>
<li>もし <code>&amp;&amp;</code> 演算をしなかったら <code>if (obj != null) {}</code> の条件式の型は <code>CustomBoolean</code> になるが、<code>if</code> 文はどう動作するのか</li>
</ul>

<p><code>CustomBoolean</code>型から<code>bool</code>型に暗黙のキャストをする演算子を定義すれば、どちらの問題も起きません。ですがそれは、<code>==</code>や<code>!=</code>で<code>CustomBoolean</code>型を返し、即座に<code>bool</code>に変換する、ということになりますから、わざわざ独自の型を経由する意味がありません。<code>CustomBoolean</code>のような型を使うのであれば、<strong>論理演算の間は<code>CustomBoolean</code>型の上で行い</strong>、<code>if</code>文などの<strong>条件式に使うところで真偽を確定させる</strong>ような動きになっていてほしいわけです。ということで、<code>bool</code>型から<code>CustomBoolean</code>型に暗黙のキャストをする演算子を定義すれば、論理演算の対象が<code>CustomBoolean</code>型同士になりますので、後は<code>CustomBoolean</code>型のふるまいだけの問題です。</p>

<ul>
<li>
<code>CustomBoolean</code>型同士の論理演算</li>
<li>
<code>if</code>文などの制御構文の条件式が<code>CustomBoolean</code>型のときの挙動</li>
</ul>

<p>そして、C#はこの2つをカスタマイズする仕組みが用意されています。</p>

<p>なるほどなるほど、<code>str</code>変数が初期化されないケースを作れそうな気がしてきました。ですがそこに行く前に、どうして<code>CustomBoolean</code>みたいな型を定義できる仕組みが用意されているのか、それを説明しましょう。</p>

<h2>
<span id="論理演算と真偽チェックと演算子" class="fragment"></span><a href="#%E8%AB%96%E7%90%86%E6%BC%94%E7%AE%97%E3%81%A8%E7%9C%9F%E5%81%BD%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%A8%E6%BC%94%E7%AE%97%E5%AD%90"><i class="fa fa-link"></i></a>論理演算と真偽チェックと演算子</h2>

<p><code>+</code> <code>-</code> <code>*</code> <code>/</code> の算術演算子をオーバーロード定義したいケースはいろいろ思いつくと思います。標準クラスライブラリの型でいえば<code>System.Numerics</code>名前空間に含まれる  <code>BigInteger</code> （任意精度整数）構造体や <code>Complex</code> （複素数）構造体などが算術演算子をオーバーロード定義することで、四則演算をやりやすくしています。</p>

<p>一方で、<code>!</code> <code>&amp;</code> <code>&amp;&amp;</code> <code>|</code> <code>||</code> の論理演算子をオーバーロード定義したいケースにはどのようなものがあるというのでしょうか。ひとつには独自の型でビット演算を実現することがあると思いますが、その場合は <code>&amp;&amp;</code> や <code>||</code> は使いませんね。もうひとつは独自の型で論理演算を実現することで、この場合は<code>&amp;&amp;</code> や <code>||</code> が関係してきます。独自の型で論理演算をしたい代表的なケース（というより、唯一に近いケース）が <strong>三値論理</strong> を扱うことです。</p>

<p>詳細は<a href="https://ja.wikipedia.org/wiki/3%E5%80%A4%E8%AB%96%E7%90%86" rel="nofollow noopener" target="_blank">Wikipedia</a>を読んでもらえたらと思いますが、ごく簡単に言うと、真偽値として「真(true)」「偽(false)」に加えて「不明(unknown)」という値を取れるようにした論理演算です。そして、論理演算 <code>!</code> <code>&amp;</code> <code>|</code> はunknownを含む形で拡張されます。たとえば、<code>A</code>がunknownの時の<code>A &amp; B</code>の結果は、<code>B</code>がfalseの時だけ<code>A &amp; B</code>もfalseになりますが、それ以外の場合は<code>A &amp; B</code>はunknownになります。</p>

<p>三値論理が使われる代表的な例がSQLです。例として<code>SELECT</code>文を考えます。<code>WHERE</code>句の条件式がNULLとの比較を含む場合、比較結果はtrueでもfalseでもないunknownとして扱われます。そして、<code>SELECT</code>文で選択される行は、<code>WHERE</code>句の条件式がtrueと評価される行だけです。つまり、論理演算の結果、条件式がunknownになる場合は、その行は選択されません。</p>

<p>SQLの場合は<code>WHERE</code>句や<code>HAVING</code>句や<code>CASE</code>式などが条件式の値を評価してtrueかどうか確かめます。C#の場合は、次の制御構文の中で、条件式の値を評価します。</p>

<ul>
<li>
<code>if</code>文</li>
<li>
<code>else</code>文</li>
<li>
<code>while</code>文</li>
<li>
<code>do</code>文</li>
<li>
<code>for</code>文</li>
<li>三項条件演算子 <code>? :</code>
</li>
<li>条件論理演算子 <code>&amp;&amp;</code> <code>||</code>
</li>
</ul>

<p>コンパイル時には条件式の型がチェックされますが、<code>bool</code>型、または暗黙的に<code>bool</code>型に変換可能な型の場合は普通にコンパイルが通ります。一方、<code>bool</code>型に変換できない型が条件式に使われている場合、真偽チェック専用の単項演算子である <a href="https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/keywords/true-operator" rel="nofollow noopener" target="_blank">true演算子</a> と <a href="https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/keywords/false-operator" rel="nofollow noopener" target="_blank">false演算子</a>がオーバーロード定義されているかをコンパイラーがチェックします。（<code>true</code>演算子と<code>false</code>演算子は、かならずペアでオーバーロード定義する必要があります。）この2つの演算子がオーバーロード定義されている型であれば、<code>bool</code>に変換することなく、制御構文の中で使用できます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">CustomBoolean</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="k">true</span><span class="p">(</span><span class="n">CustomBoolean</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 条件式でtrueと評価できる場合はtrueを返す</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="k">false</span><span class="p">(</span><span class="n">CustomBoolean</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 条件式でfalseと評価できる場合はtrueを返す</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>なぜ<code>bool</code>型に変換するのではなく、<code>true</code>演算子と<code>false</code>演算子を使うのか、ですが、上でも述べたように3値論理のunknownは「trueでもfalseでもない値」なのですから、それを表現できるようにするためです。<code>true</code>演算子と<code>false</code>演算子をペアで用意することで、<code>true</code>演算子の適用結果も、<code>false</code>演算子の適用結果も、どちらも<code>false</code>を返すような実装をすることができます。</p>

<p>……と書きましたが、上に挙げた制御構文の条件式では、実は1つを除いて他はすべてtrueのチェックしかしません（<code>true</code>演算子だけを適用する形にしかコンパイルされません）。<strong>唯一例外的にfalseのチェックをする</strong>（<code>false</code>演算子を適用する形にコンパイルされる）<strong>のが、<code>&amp;&amp;</code> 条件論理演算子</strong>なのです。</p>

<p>三項条件演算子 <code>? :</code> と 条件論理演算子 <code>&amp;&amp;</code> <code>||</code> は、直接オーバーロード定義することができません。<code>true</code>演算子や<code>false</code>演算子などを使った形にコンパイルされることがC#の言語仕様書に記載されています。言語仕様書には形式的な定義が書かれていますが、それを元に、三項条件演算子 <code>? :</code> と条件論理演算子 <code>&amp;&amp;</code> <code>||</code> で<code>CustomBoolean</code>のような型を使うとどんな感じにコンパイルされるのか、説明してみます<sup id="fnref5"><a href="#fn5" title="if文などの制御構文の方は細かい説明を省略しますが、true演算子の適用結果がtrue値を返すかどうかがチェックされます。">5</a></sup>。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">三項条件演算子</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">CustomBoolean</span> <span class="n">expr</span> <span class="p">=</span> <span class="nf">GetCustomBoolean</span><span class="p">();</span>

<span class="n">Foo</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">expr</span> <span class="p">?</span> <span class="nf">GetBar</span><span class="p">()</span> <span class="p">:</span> <span class="nf">GetBaz</span><span class="p">();</span>
<span class="c1">// 以下、等価なコードのイメージ</span>
<span class="c1">// ただし本当は、演算子の適用をメソッド呼び出しの形で書くことはできない。</span>
<span class="cm">/*
Foo foo;
if (CustomBoolean.op_True(expr)) // true演算子の適用
{
    foo = GetBar();
}
else
{
    foo = GetBaz();
}
*/</span> 
</code></pre></div>
</div>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">条件論理演算子&amp;&amp;</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">CustomBoolean</span> <span class="n">expr</span> <span class="p">=</span> <span class="nf">GetCustomBoolean</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="nf">GetAnotherCustomBoolean</span><span class="p">();</span>
<span class="c1">// 以下、等価なコードのイメージ</span>
<span class="c1">// ただし本当は、演算子の適用をメソッド呼び出しの形で書くことはできない。</span>
<span class="cm">/*
CustomBoolean expr;
CustomBoolean left = GetCustomBoolean();
if (CustomBoolean.op_False(expr)) // false演算子の適用
{
    expr = left;
}
else
{
    CustomBoolean right = GetAnotherCustomBoolean();
    expr = CustomBoolean.op_BitwiseAnd(left, right); // left &amp; right
}
*/</span> 
</code></pre></div>
</div>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">条件論理演算子||</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">CustomBoolean</span> <span class="n">expr</span> <span class="p">=</span> <span class="nf">GetCustomBoolean</span><span class="p">()</span> <span class="p">||</span> <span class="nf">GetAnotherCustomBoolean</span><span class="p">();</span>
<span class="c1">// 以下、等価なコードのイメージ</span>
<span class="c1">// ただし本当は、演算子の適用をメソッド呼び出しの形で書くことはできない。</span>
<span class="cm">/*
CustomBoolean expr;
CustomBoolean left = GetCustomBoolean();
if (CustomBoolean.op_True(expr)) // true演算子の適用
{
    expr = left;
}
else
{
    CustomBoolean right = GetAnotherCustomBoolean();
    expr = CustomBoolean.op_BitwiseOr(left, right); // left | right
}
*/</span> 
</code></pre></div>
</div>

<p>上では3つの演算子の動きをコードで書きましたが、<code>&amp;&amp;</code> については言葉でも説明しておきましょう。「左項の評価結果がfalseと判断される場合（<code>false</code>演算子が<code>true</code>を返した場合）はショートサーキットで右項は評価されず、左項の値がそのまま式の値となる。そうでない場合（<code>false</code>演算子が<code>false</code>を返した場合）は右項も評価され、最終的に左項と右項の（<code>&amp;</code>演算子オーバーロードによる）論理積が式の値となる。」です。</p>

<p>というわけで、<code>CustomBoolean</code>クラスのような独自の型に対して <code>&amp;&amp;</code> 演算子を適用するには、<code>true</code>演算子と<code>false</code>演算子に加えて、<code>&amp;</code>演算子をオーバーロード定義しておく必要があります。同様に、<code>||</code>演算子を適用するには、<code>true</code>演算子と<code>false</code>演算子に加えて、<code>|</code>演算子をオーバーロード定義しておく必要があります。</p>

<p>さて、ここで問題です。もし、<code>CustomBoolean</code>クラスが<code>true</code>演算子と<code>false</code>演算子をオーバーロードして、どちらも常に<code>true</code>を返すようにしていたら、どんなことが起きるでしょうか？</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">CustomBoolean</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="k">true</span><span class="p">(</span><span class="n">CustomBoolean</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="k">false</span><span class="p">(</span><span class="n">CustomBoolean</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>もし上のようなむちゃくちゃなクラスを書いてしまうと、次のコードがひどいことになります！</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">if</span> <span class="p">(</span><span class="nf">GetCustomBoolean</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="nf">GetAnotherCustomBoolean</span><span class="p">())</span>
<span class="p">{</span>
    <span class="nf">DoSomething</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>まず、<code>GetCustomBoolean()</code>が呼び出され、<code>CustomBoolean</code>型の値を受け取ります。次に、オーバーロードされた<code>false</code>演算子が呼び出されますが、これが<code>true</code>を返すため、<code>&amp;&amp;</code> 演算子の右項は実行されず、さっき受け取った<code>CustomBoolean</code>型の値がそのまま <code>if</code>文の条件式になります。ここで今度は<code>true</code>演算子が呼び出されますが、こちらも<code>true</code>を返します。そのため、<code>if</code>文直後のブロックが実行されます。<strong><code>&amp;&amp;</code>の右項が実行されなかったのに<code>if</code>直後のブロックが実行される</strong>ことは、このようにして起こってしまうわけです<sup id="fnref6"><a href="#fn6" title="コンパイルを通すためには &amp; 演算子もオーバーロード定義する必要があります。&amp;&amp; の右項は実行されないので、結果として&amp;演算子も呼び出されませんが。">6</a></sup>。</p>

<p>ここで教訓の2つ目。</p>

<p><strong><code>&amp;&amp;</code> や <code>||</code> といった短絡評価する論理演算の意味を<code>true</code>と<code>false</code>の演算子オーバーロードでぶっ壊すことができてしまう。</strong></p>

<p>ちなみに、C#の言語設計チームが当初想定していた、カスタムの三値論理については、<code>bool?</code>型 （<code>Nullable&lt;bool&gt;</code>構造体）を使えば済むようになったため、あえて自分で定義する必要はほぼまったくありません。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>さて、これで▲をつけた9行目でコンパイルが通らなくなったわけを説明する材料が出そろいました。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">dynamic</span> <span class="n">obj</span> <span class="p">=</span> <span class="nf">GetObject</span><span class="p">();</span> <span class="c1">// ★</span>
        <span class="kt">string</span> <span class="n">str</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">obj</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">((</span><span class="n">str</span> <span class="p">=</span> <span class="nf">GetString</span><span class="p">())</span> <span class="p">!=</span> <span class="k">null</span><span class="p">))</span> <span class="c1">// ◆</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">obj</span> <span class="p">+</span> <span class="n">str</span><span class="p">);</span> <span class="c1">// ▲</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">object</span> <span class="nf">GetObject</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">"hello"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetString</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">"goodbye"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>このようなコードでは、<code>true</code>演算子と<code>false</code>演算子がどちらも<code>true</code>を返すような<code>CustomBoolean</code>クラスと、<code>!=</code> 演算子が<code>CustomBoolean</code>型を返すような<code>Weird</code>クラスを使った場合、◆印をつけた7行目で<code>&amp;&amp;</code> の右項<sup id="fnref7"><a href="#fn7" title="&amp;&amp; 演算子の右項はbool型のままなので、dynamicではなく実際にWeirdのような型でコンパイルを通そうと思ったら、bool型をCustomBooleanクラスに変換する、暗黙的なキャスト演算子も定義する必要があります。">7</a></sup>が実行されないため<code>str</code>変数が初期化されていないにもかかわらず、▲印をつけた9行目が実行されるというケースがありえてしまいます。</p>

<p>また、★印をつけた5行目を見れば、<code>obj</code>変数は<code>GetObject()</code>の戻り値が格納されることははっきりしています。ですが、変数の型を<code>dynamic</code>にしてしまうと、◆印をつけた7行目で<code>obj</code>変数が何を格納しているか、まったく想定できません。想定できないということは、それが<code>Weird</code>のようなクラスのインスタンスである可能性を排除できないということです。しかも、コード上はそのようなクラスを定義していなかったとしても、参照しているアセンブリや、リフレクションを使って動的にロードするアセンブリを考えれば、<code>Weird</code>みたいなクラスがどこにもまったく存在しないことまでは保証できません。</p>

<p>したがって、<code>obj</code>変数の型を<code>dynamic</code>に変えたとたん、▲印をつけた9行目でコンパイルエラーが起きるのは、コンパイラーに問題があるからではない、というわけです。</p>

<p>最後に教訓を2つ。</p>

<p><strong>予想もしないコンパイルエラーが出るからと言って、コンパイラーのバグとは限らない。</strong></p>

<p><strong>演算子オーバーロードは、意味論・用法を守って正しく使いましょう。</strong></p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p><code>ref</code>を使って明示的に<a href="https://ufcpp.net/study/csharp/sp_ref.html" rel="nofollow noopener" target="_blank">参照渡し</a>をすれば書き換えることもできますが、それは意図的にやることですね。 <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p><code>Equals()</code>と<code>GetHashCode()</code>もオーバーライドしないとコンパイル時に警告が出ます。ですが今回は無視します。 <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p><a href="https://twitter.com/ufcpp/status/1069019554909585408" rel="nofollow noopener" target="_blank">岩永さんのコメント</a>を受けて編集しました。 <a href="#fnref3">↩</a></p>
</li>

<li id="fn4">
<p><code>true</code>演算子と<code>false</code>演算子は<code>bool</code>型しか返せません。<code>++</code>演算子と<code>--</code>演算子は元の型かその派生型しか返せません。 <a href="#fnref4">↩</a></p>
</li>

<li id="fn5">
<p><code>if</code>文などの制御構文の方は細かい説明を省略しますが、<code>true</code>演算子の適用結果が<code>true</code>値を返すかどうかがチェックされます。 <a href="#fnref5">↩</a></p>
</li>

<li id="fn6">
<p>コンパイルを通すためには <code>&amp;</code> 演算子もオーバーロード定義する必要があります。<code>&amp;&amp;</code> の右項は実行されないので、結果として<code>&amp;</code>演算子も呼び出されませんが。 <a href="#fnref6">↩</a></p>
</li>

<li id="fn7">
<p><code>&amp;&amp;</code> 演算子の右項は<code>bool</code>型のままなので、<code>dynamic</code>ではなく実際に<code>Weird</code>のような型でコンパイルを通そうと思ったら、<code>bool</code>型を<code>CustomBoolean</code>クラスに変換する、暗黙的なキャスト演算子も定義する必要があります。 <a href="#fnref7">↩</a></p>
</li>

</ol>
</div>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fmatarillo%2Fitems%2F39e8666652f11d5c98d9&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fmatarillo%2Fitems%2F39e8666652f11d5c98d9&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/matarillo/items/39e8666652f11d5c98d9/likers" class="css-1iupg5d">19</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">5</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/39e8666652f11d5c98d9/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/matarillo/items/39e8666652f11d5c98d9/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/matarillo/items/39e8666652f11d5c98d9/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/matarillo/items/39e8666652f11d5c98d9/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/matarillo/items/39e8666652f11d5c98d9.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-9a16f0f4-44d9-47b7-8973-c5bd7740a56b">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-fd2e026f-1646-40fc-b409-53e36bea096e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-fd2e026f-1646-40fc-b409-53e36bea096e">{}</script>
      
<div id="LoginModal-react-component-e4ced7f1-11a4-4062-bbc5-81dbe053186e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-e4ced7f1-11a4-4062-bbc5-81dbe053186e">{}</script>
      
<div id="StockModal-react-component-a4667d90-c70f-425a-a5f6-63b22a2e29b4"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-a4667d90-c70f-425a-a5f6-63b22a2e29b4">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;QbMqMGDxGWqKtVAJZN0fB/83/IodxnXM/6jwZPTlux22eZG2VmroORyIXPEugXs6aQPiDDnGfpTaWLaDivrPkQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e元ネタはEric Lippertのブログです。コードは少し改変していますが、言っていることは同じです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://ericlippert.com/2018/11/14/a-dynamic-definite-assignment-puzzle/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eA dynamic definite assignment puzzle\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://ericlippert.com/2018/11/19/a-dynamic-definite-assignment-puzzle-part-2/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eA dynamic definite assignment puzzle, part 2\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"クイズ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AF%E3%82%A4%E3%82%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eクイズ\u003c/h1\u003e\n\n\u003cp\u003e次のコードがあります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetObject\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ★\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetString\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ◆\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ▲\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetObject\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s\"\u003e\"hello\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetString\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s\"\u003e\"goodbye\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのコードは普通にコンパイルも通りますし動作しますが、★印をつけた7行目を次のように変更すると\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"kt\"\u003edynamic\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetObject\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ★ 変数の型をdynamicに変更\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとたんに▲印をつけた9行目でコンパイルが通らなくなります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eCompilation error (line 9, col 44): Use of unassigned local variable 'str'\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eエラーメッセージは、\u003ccode\u003estr\u003c/code\u003e変数が初期化されていないというものです。\u003cbr\u003e\n確かに、6行目で変数を定義したときは初期化していないのですが、◆印をつけた7行目の\u003ccode\u003eif\u003c/code\u003e文の条件式の中、\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e演算子の右側で初期化しています。\u003cbr\u003e\n\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003eの意味を考えると、9行目に到達するには\u003ccode\u003estr\u003c/code\u003eを初期化するコードも評価実行されるはずですし、実際最初の段階ではコンパイルできていたのですが、どうしてこうなるのでしょうか。\u003c/p\u003e\n\n\u003cp\u003e気になる人は\u003ca href=\"https://dotnetfiddle.net/lxHExk\" rel=\"nofollow noopener\" target=\"_blank\"\u003eオンラインのPlaygroundで試してみてください\u003c/a\u003e。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"解説\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A7%A3%E8%AA%AC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e解説\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"dynamic型\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dynamic%E5%9E%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003edynamic\u003c/code\u003e型\u003c/h2\u003e\n\n\u003cp\u003eC#は基本的には静的に型をチェックするタイプのプログラミング言語ですが、いくつか例外があります。その一つがこの\u003ccode\u003edynamic\u003c/code\u003e型で、この型の値に対する操作、たとえばメソッド呼び出しやフィールド参照など、についてはその存在がコンパイル時にはチェックされず、実行時にしかチェックされなくなります。\u003c/p\u003e\n\n\u003cp\u003eそれだけではなく、\u003ccode\u003edynamic\u003c/code\u003e型の変数があったとすると、その変数が実際にはどんな型の値を保持しているかについて、仮定も追跡もせず、いつも不確定として扱われます。\u003cbr\u003e\n今回のクイズのコードで言えば、\u003ccode\u003eGetObject()\u003c/code\u003eが\u003ccode\u003eobject\u003c/code\u003e型（実体は\u003ccode\u003estring\u003c/code\u003e）を返すこと、\u003ccode\u003eobj\u003c/code\u003e変数はローカル変数なので、知らぬ間に外部から値が書き換えられたりしない\u003csup id=\"fnref1\"\u003e\u003ca href=\"#fn1\" title=\"refを使って明示的に参照渡しをすれば書き換えることもできますが、それは意図的にやることですね。\"\u003e1\u003c/a\u003e\u003c/sup\u003eこと、などは明白なのですが、それでも◆印をつけた7行目の\u003ccode\u003eif\u003c/code\u003e文の条件式においては、\u003ccode\u003eobj\u003c/code\u003eにどんな値が入っているかは実行してみるまでわからない、という風にコンパイラは扱います。\u003cbr\u003e\nそれにしても、コンパイルが通らなくなるのは不思議ですね。\u003ccode\u003eobj\u003c/code\u003e変数に「なにか謎の型の値」が入っていた場合に\u003ccode\u003estr\u003c/code\u003eが初期化されなくなるようなことが起こり得るとでも言うのでしょうか。\u003cstrong\u003e実はその通り\u003c/strong\u003eなのです。そしてそこには、演算子オーバーロードが関係しています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"nullチェックと演算子\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#null%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%A8%E6%BC%94%E7%AE%97%E5%AD%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003enullチェックと演算子\u003c/h2\u003e\n\n\u003cp\u003e◆印をつけた7行目の\u003ccode\u003eif\u003c/code\u003e文の条件式を見ると、\u003ccode\u003eobj\u003c/code\u003e変数と\u003ccode\u003enull\u003c/code\u003eを比較しています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e普通はこのようなコードでnullチェックができるのですが、\u003ccode\u003eobj\u003c/code\u003eの型によっては期待する動きにならない可能性もあるのです。それは、\u003ccode\u003eobj\u003c/code\u003eの型が\u003cstrong\u003e等値演算子 \u003ccode\u003e==\u003c/code\u003e と 非等値演算子 \u003ccode\u003e!=\u003c/code\u003e をオーバーロード定義して、独自の処理にしている場合\u003c/strong\u003eです。（\u003ccode\u003e==\u003c/code\u003e演算子と\u003ccode\u003e!=\u003c/code\u003e演算子は、かならずペアでオーバーロード定義する必要があります\u003csup id=\"fnref2\"\u003e\u003ca href=\"#fn2\" title=\"Equals()とGetHashCode()もオーバーライドしないとコンパイル時に警告が出ます。ですが今回は無視します。\"\u003e2\u003c/a\u003e\u003c/sup\u003e。）\u003c/p\u003e\n\n\u003cp\u003eたとえば以下のような\u003ccode\u003eWeird\u003c/code\u003eクラスがあるとします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eWeird\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e==(\u003c/span\u003e\u003cspan class=\"n\"\u003eWeird\u003c/span\u003e \u003cspan class=\"n\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eWeird\u003c/span\u003e \u003cspan class=\"n\"\u003eright\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e!=(\u003c/span\u003e\u003cspan class=\"n\"\u003eWeird\u003c/span\u003e \u003cspan class=\"n\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eWeird\u003c/span\u003e \u003cspan class=\"n\"\u003eright\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e上のコードでは、\u003ccode\u003eWeird\u003c/code\u003e型同士に対する \u003ccode\u003e==\u003c/code\u003e演算も\u003ccode\u003e!=\u003c/code\u003e演算も、いつでも\u003ccode\u003etrue\u003c/code\u003eを返します。ということは、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eWeird\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこんなコードを書くと、\u003ccode\u003eobj\u003c/code\u003eがnullでないことを確認したつもりが、実際はnullにもかかわらず条件式が真になってしまうので、\u003ccode\u003eToString()\u003c/code\u003eメソッド呼び出しのところで\u003ccode\u003eNullReferenceException\u003c/code\u003eが投げられてしまいます！\u003c/p\u003e\n\n\u003cp\u003eここで教訓の1つ目。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e等値演算子がオーバーロードされているときは、\u003ccode\u003enull\u003c/code\u003eと比較してもnullチェックにならないことがある。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eこの教訓はあくまで、クラスの利用側で安全側に倒す方針を取るときのものです。クラスの定義側で等値演算子をオーバーロードするときは、\u003ccode\u003enull\u003c/code\u003eとの比較がおかしなことになるようなコードを書くべきではありません！\u003c/p\u003e\n\n\u003cp\u003eとはいえ、C#を採用していることで有名なゲームプラットフォームである\u003ca href=\"https://unity3d.com/jp\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnity\u003c/a\u003eでは、\u003ca href=\"https://docs.unity3d.com/ja/current/ScriptReference/Object.Destroy.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003ccode\u003eUnityEngine.Object.Destroy()\u003c/code\u003eメソッド\u003c/a\u003eで破壊されたオブジェクトは、その後\u003ccode\u003enull\u003c/code\u003eとの比較が\u003ccode\u003etrue\u003c/code\u003eを返すようになります。\u003c/p\u003e\n\n\u003cp\u003e参考：\u003ca href=\"https://qiita.com/RyotaMurohoshi/items/339d77d10b89198ce4fc\" id=\"reference-80acf39e16099a43638b\"\u003eGameObjectやComponentをnullと比較するときの落し穴\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eそのような、比較演算子がオーバーロードされている（かもしれない）状況で、本当に\u003ccode\u003enull\u003c/code\u003eかどうかをチェックしたい場合は、以下のような選択肢があります\u003csup id=\"fnref3\"\u003e\u003ca href=\"#fn3\" title=\"岩永さんのコメントを受けて編集しました。\"\u003e3\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/csharp/pattern-matching\" rel=\"nofollow noopener\" target=\"_blank\"\u003eパターンマッチ\u003c/a\u003eでnullチェックをする\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/api/system.object.referenceequals\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003ccode\u003eSystem.Object.ReferenceEquals()\u003c/code\u003e静的メソッド\u003c/a\u003eを呼び出す\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eobject\u003c/code\u003e型にアップキャストしてから比較演算子を使う\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eC# 7以降のパターンマッチでは、型パターンを使った場合\u003ccode\u003enull\u003c/code\u003eとはマッチしないので\u003ccode\u003enull\u003c/code\u003eでないことが確かめられます。また、\u003ccode\u003enull\u003c/code\u003e定数パターンを使った場合\u003ccode\u003enull\u003c/code\u003eにしかマッチしません。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003enull\u003c/code\u003e定数パターンでnullチェックをするコード例はこうなります。単純ですね。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eさて、これで最初のコードの謎が解けた……と思ったら、そうではありません。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003e!=\u003c/code\u003e演算子がオーバーロードされているとしても、\u003ccode\u003etrue\u003c/code\u003eを返すのであれば \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e の右側が評価されて\u003ccode\u003estr\u003c/code\u003eは初期化されるはずだし、\u003ccode\u003efalse\u003c/code\u003eを返すのであれば\u003ccode\u003eif\u003c/code\u003e文の条件式そのものが\u003ccode\u003efalse\u003c/code\u003eになるので▲の印をつけた9行目は実行されないわけですから、コンパイルエラーになるのはおかしいのです。\u003c/p\u003e\n\n\u003cp\u003eでは、等値演算子が\u003ccode\u003ebool\u003c/code\u003e型を返さないとしたら？\u003c/p\u003e\n\n\u003cp\u003eそんなことができるのか？というと、\u003cstrong\u003eできます\u003c/strong\u003e。演算子のオーバーロードでは、一部の単項演算子\u003csup id=\"fnref4\"\u003e\u003ca href=\"#fn4\" title=\"true演算子とfalse演算子はbool型しか返せません。++演算子と--演算子は元の型かその派生型しか返せません。\"\u003e4\u003c/a\u003e\u003c/sup\u003eを除き、演算結果を独自の型にすることができるのです。たとえば、\u003ccode\u003eWeird\u003c/code\u003eクラスの\u003ccode\u003e==\u003c/code\u003e演算子と\u003ccode\u003e!=\u003c/code\u003e演算子を次のように書き直してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eWeird\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eCustomBoolean\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e==(\u003c/span\u003e\u003cspan class=\"n\"\u003eWeird\u003c/span\u003e \u003cspan class=\"n\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eWeird\u003c/span\u003e \u003cspan class=\"n\"\u003eright\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCustomBoolean\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eCustomBoolean\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e!=(\u003c/span\u003e\u003cspan class=\"n\"\u003eWeird\u003c/span\u003e \u003cspan class=\"n\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eWeird\u003c/span\u003e \u003cspan class=\"n\"\u003eright\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCustomBoolean\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomBoolean\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのようにカスタムの\u003ccode\u003eCustomBoolean\u003c/code\u003eという型を返すように演算子を定義したとしても\u003ccode\u003eWeird\u003c/code\u003eクラス自体はコンパイルに通ります。\u003c/p\u003e\n\n\u003cp\u003eですが、このままでは次の２つの問題があります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e◆印をつけた7行目の\u003ccode\u003eif\u003c/code\u003e文の条件式にあるような、 \u003ccode\u003eCustomBoolean\u003c/code\u003e 型と \u003ccode\u003ebool\u003c/code\u003e 型に対する \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e 演算をどう定義するか\u003c/li\u003e\n\u003cli\u003eもし \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e 演算をしなかったら \u003ccode\u003eif (obj != null) {}\u003c/code\u003e の条件式の型は \u003ccode\u003eCustomBoolean\u003c/code\u003e になるが、\u003ccode\u003eif\u003c/code\u003e 文はどう動作するのか\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003ccode\u003eCustomBoolean\u003c/code\u003e型から\u003ccode\u003ebool\u003c/code\u003e型に暗黙のキャストをする演算子を定義すれば、どちらの問題も起きません。ですがそれは、\u003ccode\u003e==\u003c/code\u003eや\u003ccode\u003e!=\u003c/code\u003eで\u003ccode\u003eCustomBoolean\u003c/code\u003e型を返し、即座に\u003ccode\u003ebool\u003c/code\u003eに変換する、ということになりますから、わざわざ独自の型を経由する意味がありません。\u003ccode\u003eCustomBoolean\u003c/code\u003eのような型を使うのであれば、\u003cstrong\u003e論理演算の間は\u003ccode\u003eCustomBoolean\u003c/code\u003e型の上で行い\u003c/strong\u003e、\u003ccode\u003eif\u003c/code\u003e文などの\u003cstrong\u003e条件式に使うところで真偽を確定させる\u003c/strong\u003eような動きになっていてほしいわけです。ということで、\u003ccode\u003ebool\u003c/code\u003e型から\u003ccode\u003eCustomBoolean\u003c/code\u003e型に暗黙のキャストをする演算子を定義すれば、論理演算の対象が\u003ccode\u003eCustomBoolean\u003c/code\u003e型同士になりますので、後は\u003ccode\u003eCustomBoolean\u003c/code\u003e型のふるまいだけの問題です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eCustomBoolean\u003c/code\u003e型同士の論理演算\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eif\u003c/code\u003e文などの制御構文の条件式が\u003ccode\u003eCustomBoolean\u003c/code\u003e型のときの挙動\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eそして、C#はこの2つをカスタマイズする仕組みが用意されています。\u003c/p\u003e\n\n\u003cp\u003eなるほどなるほど、\u003ccode\u003estr\u003c/code\u003e変数が初期化されないケースを作れそうな気がしてきました。ですがそこに行く前に、どうして\u003ccode\u003eCustomBoolean\u003c/code\u003eみたいな型を定義できる仕組みが用意されているのか、それを説明しましょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"論理演算と真偽チェックと演算子\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AB%96%E7%90%86%E6%BC%94%E7%AE%97%E3%81%A8%E7%9C%9F%E5%81%BD%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%A8%E6%BC%94%E7%AE%97%E5%AD%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e論理演算と真偽チェックと演算子\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003e+\u003c/code\u003e \u003ccode\u003e-\u003c/code\u003e \u003ccode\u003e*\u003c/code\u003e \u003ccode\u003e/\u003c/code\u003e の算術演算子をオーバーロード定義したいケースはいろいろ思いつくと思います。標準クラスライブラリの型でいえば\u003ccode\u003eSystem.Numerics\u003c/code\u003e名前空間に含まれる  \u003ccode\u003eBigInteger\u003c/code\u003e （任意精度整数）構造体や \u003ccode\u003eComplex\u003c/code\u003e （複素数）構造体などが算術演算子をオーバーロード定義することで、四則演算をやりやすくしています。\u003c/p\u003e\n\n\u003cp\u003e一方で、\u003ccode\u003e!\u003c/code\u003e \u003ccode\u003e\u0026amp;\u003c/code\u003e \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e \u003ccode\u003e|\u003c/code\u003e \u003ccode\u003e||\u003c/code\u003e の論理演算子をオーバーロード定義したいケースにはどのようなものがあるというのでしょうか。ひとつには独自の型でビット演算を実現することがあると思いますが、その場合は \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e や \u003ccode\u003e||\u003c/code\u003e は使いませんね。もうひとつは独自の型で論理演算を実現することで、この場合は\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e や \u003ccode\u003e||\u003c/code\u003e が関係してきます。独自の型で論理演算をしたい代表的なケース（というより、唯一に近いケース）が \u003cstrong\u003e三値論理\u003c/strong\u003e を扱うことです。\u003c/p\u003e\n\n\u003cp\u003e詳細は\u003ca href=\"https://ja.wikipedia.org/wiki/3%E5%80%A4%E8%AB%96%E7%90%86\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWikipedia\u003c/a\u003eを読んでもらえたらと思いますが、ごく簡単に言うと、真偽値として「真(true)」「偽(false)」に加えて「不明(unknown)」という値を取れるようにした論理演算です。そして、論理演算 \u003ccode\u003e!\u003c/code\u003e \u003ccode\u003e\u0026amp;\u003c/code\u003e \u003ccode\u003e|\u003c/code\u003e はunknownを含む形で拡張されます。たとえば、\u003ccode\u003eA\u003c/code\u003eがunknownの時の\u003ccode\u003eA \u0026amp; B\u003c/code\u003eの結果は、\u003ccode\u003eB\u003c/code\u003eがfalseの時だけ\u003ccode\u003eA \u0026amp; B\u003c/code\u003eもfalseになりますが、それ以外の場合は\u003ccode\u003eA \u0026amp; B\u003c/code\u003eはunknownになります。\u003c/p\u003e\n\n\u003cp\u003e三値論理が使われる代表的な例がSQLです。例として\u003ccode\u003eSELECT\u003c/code\u003e文を考えます。\u003ccode\u003eWHERE\u003c/code\u003e句の条件式がNULLとの比較を含む場合、比較結果はtrueでもfalseでもないunknownとして扱われます。そして、\u003ccode\u003eSELECT\u003c/code\u003e文で選択される行は、\u003ccode\u003eWHERE\u003c/code\u003e句の条件式がtrueと評価される行だけです。つまり、論理演算の結果、条件式がunknownになる場合は、その行は選択されません。\u003c/p\u003e\n\n\u003cp\u003eSQLの場合は\u003ccode\u003eWHERE\u003c/code\u003e句や\u003ccode\u003eHAVING\u003c/code\u003e句や\u003ccode\u003eCASE\u003c/code\u003e式などが条件式の値を評価してtrueかどうか確かめます。C#の場合は、次の制御構文の中で、条件式の値を評価します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eif\u003c/code\u003e文\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eelse\u003c/code\u003e文\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003ewhile\u003c/code\u003e文\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003edo\u003c/code\u003e文\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003efor\u003c/code\u003e文\u003c/li\u003e\n\u003cli\u003e三項条件演算子 \u003ccode\u003e? :\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003e条件論理演算子 \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e \u003ccode\u003e||\u003c/code\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eコンパイル時には条件式の型がチェックされますが、\u003ccode\u003ebool\u003c/code\u003e型、または暗黙的に\u003ccode\u003ebool\u003c/code\u003e型に変換可能な型の場合は普通にコンパイルが通ります。一方、\u003ccode\u003ebool\u003c/code\u003e型に変換できない型が条件式に使われている場合、真偽チェック専用の単項演算子である \u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/keywords/true-operator\" rel=\"nofollow noopener\" target=\"_blank\"\u003etrue演算子\u003c/a\u003e と \u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/keywords/false-operator\" rel=\"nofollow noopener\" target=\"_blank\"\u003efalse演算子\u003c/a\u003eがオーバーロード定義されているかをコンパイラーがチェックします。（\u003ccode\u003etrue\u003c/code\u003e演算子と\u003ccode\u003efalse\u003c/code\u003e演算子は、かならずペアでオーバーロード定義する必要があります。）この2つの演算子がオーバーロード定義されている型であれば、\u003ccode\u003ebool\u003c/code\u003eに変換することなく、制御構文の中で使用できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomBoolean\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCustomBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 条件式でtrueと評価できる場合はtrueを返す\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCustomBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 条件式でfalseと評価できる場合はtrueを返す\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなぜ\u003ccode\u003ebool\u003c/code\u003e型に変換するのではなく、\u003ccode\u003etrue\u003c/code\u003e演算子と\u003ccode\u003efalse\u003c/code\u003e演算子を使うのか、ですが、上でも述べたように3値論理のunknownは「trueでもfalseでもない値」なのですから、それを表現できるようにするためです。\u003ccode\u003etrue\u003c/code\u003e演算子と\u003ccode\u003efalse\u003c/code\u003e演算子をペアで用意することで、\u003ccode\u003etrue\u003c/code\u003e演算子の適用結果も、\u003ccode\u003efalse\u003c/code\u003e演算子の適用結果も、どちらも\u003ccode\u003efalse\u003c/code\u003eを返すような実装をすることができます。\u003c/p\u003e\n\n\u003cp\u003e……と書きましたが、上に挙げた制御構文の条件式では、実は1つを除いて他はすべてtrueのチェックしかしません（\u003ccode\u003etrue\u003c/code\u003e演算子だけを適用する形にしかコンパイルされません）。\u003cstrong\u003e唯一例外的にfalseのチェックをする\u003c/strong\u003e（\u003ccode\u003efalse\u003c/code\u003e演算子を適用する形にコンパイルされる）\u003cstrong\u003eのが、\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e 条件論理演算子\u003c/strong\u003eなのです。\u003c/p\u003e\n\n\u003cp\u003e三項条件演算子 \u003ccode\u003e? :\u003c/code\u003e と 条件論理演算子 \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e \u003ccode\u003e||\u003c/code\u003e は、直接オーバーロード定義することができません。\u003ccode\u003etrue\u003c/code\u003e演算子や\u003ccode\u003efalse\u003c/code\u003e演算子などを使った形にコンパイルされることがC#の言語仕様書に記載されています。言語仕様書には形式的な定義が書かれていますが、それを元に、三項条件演算子 \u003ccode\u003e? :\u003c/code\u003e と条件論理演算子 \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e \u003ccode\u003e||\u003c/code\u003e で\u003ccode\u003eCustomBoolean\u003c/code\u003eのような型を使うとどんな感じにコンパイルされるのか、説明してみます\u003csup id=\"fnref5\"\u003e\u003ca href=\"#fn5\" title=\"if文などの制御構文の方は細かい説明を省略しますが、true演算子の適用結果がtrue値を返すかどうかがチェックされます。\"\u003e5\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e三項条件演算子\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eCustomBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003eexpr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetCustomBoolean\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eFoo\u003c/span\u003e \u003cspan class=\"n\"\u003efoo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eexpr\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBar\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBaz\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 以下、等価なコードのイメージ\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ただし本当は、演算子の適用をメソッド呼び出しの形で書くことはできない。\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/*\nFoo foo;\nif (CustomBoolean.op_True(expr)) // true演算子の適用\n{\n    foo = GetBar();\n}\nelse\n{\n    foo = GetBaz();\n}\n*/\u003c/span\u003e \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e条件論理演算子\u0026amp;\u0026amp;\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eCustomBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003eexpr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetCustomBoolean\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAnotherCustomBoolean\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 以下、等価なコードのイメージ\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ただし本当は、演算子の適用をメソッド呼び出しの形で書くことはできない。\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/*\nCustomBoolean expr;\nCustomBoolean left = GetCustomBoolean();\nif (CustomBoolean.op_False(expr)) // false演算子の適用\n{\n    expr = left;\n}\nelse\n{\n    CustomBoolean right = GetAnotherCustomBoolean();\n    expr = CustomBoolean.op_BitwiseAnd(left, right); // left \u0026amp; right\n}\n*/\u003c/span\u003e \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e条件論理演算子||\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eCustomBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003eexpr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetCustomBoolean\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAnotherCustomBoolean\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 以下、等価なコードのイメージ\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ただし本当は、演算子の適用をメソッド呼び出しの形で書くことはできない。\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/*\nCustomBoolean expr;\nCustomBoolean left = GetCustomBoolean();\nif (CustomBoolean.op_True(expr)) // true演算子の適用\n{\n    expr = left;\n}\nelse\n{\n    CustomBoolean right = GetAnotherCustomBoolean();\n    expr = CustomBoolean.op_BitwiseOr(left, right); // left | right\n}\n*/\u003c/span\u003e \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e上では3つの演算子の動きをコードで書きましたが、\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e については言葉でも説明しておきましょう。「左項の評価結果がfalseと判断される場合（\u003ccode\u003efalse\u003c/code\u003e演算子が\u003ccode\u003etrue\u003c/code\u003eを返した場合）はショートサーキットで右項は評価されず、左項の値がそのまま式の値となる。そうでない場合（\u003ccode\u003efalse\u003c/code\u003e演算子が\u003ccode\u003efalse\u003c/code\u003eを返した場合）は右項も評価され、最終的に左項と右項の（\u003ccode\u003e\u0026amp;\u003c/code\u003e演算子オーバーロードによる）論理積が式の値となる。」です。\u003c/p\u003e\n\n\u003cp\u003eというわけで、\u003ccode\u003eCustomBoolean\u003c/code\u003eクラスのような独自の型に対して \u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e 演算子を適用するには、\u003ccode\u003etrue\u003c/code\u003e演算子と\u003ccode\u003efalse\u003c/code\u003e演算子に加えて、\u003ccode\u003e\u0026amp;\u003c/code\u003e演算子をオーバーロード定義しておく必要があります。同様に、\u003ccode\u003e||\u003c/code\u003e演算子を適用するには、\u003ccode\u003etrue\u003c/code\u003e演算子と\u003ccode\u003efalse\u003c/code\u003e演算子に加えて、\u003ccode\u003e|\u003c/code\u003e演算子をオーバーロード定義しておく必要があります。\u003c/p\u003e\n\n\u003cp\u003eさて、ここで問題です。もし、\u003ccode\u003eCustomBoolean\u003c/code\u003eクラスが\u003ccode\u003etrue\u003c/code\u003e演算子と\u003ccode\u003efalse\u003c/code\u003e演算子をオーバーロードして、どちらも常に\u003ccode\u003etrue\u003c/code\u003eを返すようにしていたら、どんなことが起きるでしょうか？\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomBoolean\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCustomBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCustomBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eもし上のようなむちゃくちゃなクラスを書いてしまうと、次のコードがひどいことになります！\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCustomBoolean\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAnotherCustomBoolean\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eDoSomething\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまず、\u003ccode\u003eGetCustomBoolean()\u003c/code\u003eが呼び出され、\u003ccode\u003eCustomBoolean\u003c/code\u003e型の値を受け取ります。次に、オーバーロードされた\u003ccode\u003efalse\u003c/code\u003e演算子が呼び出されますが、これが\u003ccode\u003etrue\u003c/code\u003eを返すため、\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e 演算子の右項は実行されず、さっき受け取った\u003ccode\u003eCustomBoolean\u003c/code\u003e型の値がそのまま \u003ccode\u003eif\u003c/code\u003e文の条件式になります。ここで今度は\u003ccode\u003etrue\u003c/code\u003e演算子が呼び出されますが、こちらも\u003ccode\u003etrue\u003c/code\u003eを返します。そのため、\u003ccode\u003eif\u003c/code\u003e文直後のブロックが実行されます。\u003cstrong\u003e\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003eの右項が実行されなかったのに\u003ccode\u003eif\u003c/code\u003e直後のブロックが実行される\u003c/strong\u003eことは、このようにして起こってしまうわけです\u003csup id=\"fnref6\"\u003e\u003ca href=\"#fn6\" title=\"コンパイルを通すためには \u0026amp; 演算子もオーバーロード定義する必要があります。\u0026amp;\u0026amp; の右項は実行されないので、結果として\u0026amp;演算子も呼び出されませんが。\"\u003e6\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cp\u003eここで教訓の2つ目。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e や \u003ccode\u003e||\u003c/code\u003e といった短絡評価する論理演算の意味を\u003ccode\u003etrue\u003c/code\u003eと\u003ccode\u003efalse\u003c/code\u003eの演算子オーバーロードでぶっ壊すことができてしまう。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eちなみに、C#の言語設計チームが当初想定していた、カスタムの三値論理については、\u003ccode\u003ebool?\u003c/code\u003e型 （\u003ccode\u003eNullable\u0026lt;bool\u0026gt;\u003c/code\u003e構造体）を使えば済むようになったため、あえて自分で定義する必要はほぼまったくありません。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003eさて、これで▲をつけた9行目でコンパイルが通らなくなったわけを説明する材料が出そろいました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003edynamic\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetObject\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ★\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetString\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ◆\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ▲\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetObject\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s\"\u003e\"hello\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetString\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s\"\u003e\"goodbye\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのようなコードでは、\u003ccode\u003etrue\u003c/code\u003e演算子と\u003ccode\u003efalse\u003c/code\u003e演算子がどちらも\u003ccode\u003etrue\u003c/code\u003eを返すような\u003ccode\u003eCustomBoolean\u003c/code\u003eクラスと、\u003ccode\u003e!=\u003c/code\u003e 演算子が\u003ccode\u003eCustomBoolean\u003c/code\u003e型を返すような\u003ccode\u003eWeird\u003c/code\u003eクラスを使った場合、◆印をつけた7行目で\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e の右項\u003csup id=\"fnref7\"\u003e\u003ca href=\"#fn7\" title=\"\u0026amp;\u0026amp; 演算子の右項はbool型のままなので、dynamicではなく実際にWeirdのような型でコンパイルを通そうと思ったら、bool型をCustomBooleanクラスに変換する、暗黙的なキャスト演算子も定義する必要があります。\"\u003e7\u003c/a\u003e\u003c/sup\u003eが実行されないため\u003ccode\u003estr\u003c/code\u003e変数が初期化されていないにもかかわらず、▲印をつけた9行目が実行されるというケースがありえてしまいます。\u003c/p\u003e\n\n\u003cp\u003eまた、★印をつけた5行目を見れば、\u003ccode\u003eobj\u003c/code\u003e変数は\u003ccode\u003eGetObject()\u003c/code\u003eの戻り値が格納されることははっきりしています。ですが、変数の型を\u003ccode\u003edynamic\u003c/code\u003eにしてしまうと、◆印をつけた7行目で\u003ccode\u003eobj\u003c/code\u003e変数が何を格納しているか、まったく想定できません。想定できないということは、それが\u003ccode\u003eWeird\u003c/code\u003eのようなクラスのインスタンスである可能性を排除できないということです。しかも、コード上はそのようなクラスを定義していなかったとしても、参照しているアセンブリや、リフレクションを使って動的にロードするアセンブリを考えれば、\u003ccode\u003eWeird\u003c/code\u003eみたいなクラスがどこにもまったく存在しないことまでは保証できません。\u003c/p\u003e\n\n\u003cp\u003eしたがって、\u003ccode\u003eobj\u003c/code\u003e変数の型を\u003ccode\u003edynamic\u003c/code\u003eに変えたとたん、▲印をつけた9行目でコンパイルエラーが起きるのは、コンパイラーに問題があるからではない、というわけです。\u003c/p\u003e\n\n\u003cp\u003e最後に教訓を2つ。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e予想もしないコンパイルエラーが出るからと言って、コンパイラーのバグとは限らない。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e演算子オーバーロードは、意味論・用法を守って正しく使いましょう。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\n\u003cli id=\"fn1\"\u003e\n\u003cp\u003e\u003ccode\u003eref\u003c/code\u003eを使って明示的に\u003ca href=\"https://ufcpp.net/study/csharp/sp_ref.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e参照渡し\u003c/a\u003eをすれば書き換えることもできますが、それは意図的にやることですね。 \u003ca href=\"#fnref1\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn2\"\u003e\n\u003cp\u003e\u003ccode\u003eEquals()\u003c/code\u003eと\u003ccode\u003eGetHashCode()\u003c/code\u003eもオーバーライドしないとコンパイル時に警告が出ます。ですが今回は無視します。 \u003ca href=\"#fnref2\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn3\"\u003e\n\u003cp\u003e\u003ca href=\"https://twitter.com/ufcpp/status/1069019554909585408\" rel=\"nofollow noopener\" target=\"_blank\"\u003e岩永さんのコメント\u003c/a\u003eを受けて編集しました。 \u003ca href=\"#fnref3\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn4\"\u003e\n\u003cp\u003e\u003ccode\u003etrue\u003c/code\u003e演算子と\u003ccode\u003efalse\u003c/code\u003e演算子は\u003ccode\u003ebool\u003c/code\u003e型しか返せません。\u003ccode\u003e++\u003c/code\u003e演算子と\u003ccode\u003e--\u003c/code\u003e演算子は元の型かその派生型しか返せません。 \u003ca href=\"#fnref4\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn5\"\u003e\n\u003cp\u003e\u003ccode\u003eif\u003c/code\u003e文などの制御構文の方は細かい説明を省略しますが、\u003ccode\u003etrue\u003c/code\u003e演算子の適用結果が\u003ccode\u003etrue\u003c/code\u003e値を返すかどうかがチェックされます。 \u003ca href=\"#fnref5\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn6\"\u003e\n\u003cp\u003eコンパイルを通すためには \u003ccode\u003e\u0026amp;\u003c/code\u003e 演算子もオーバーロード定義する必要があります。\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e の右項は実行されないので、結果として\u003ccode\u003e\u0026amp;\u003c/code\u003e演算子も呼び出されませんが。 \u003ca href=\"#fnref6\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn7\"\u003e\n\u003cp\u003e\u003ccode\u003e\u0026amp;\u0026amp;\u003c/code\u003e 演算子の右項は\u003ccode\u003ebool\u003c/code\u003e型のままなので、\u003ccode\u003edynamic\u003c/code\u003eではなく実際に\u003ccode\u003eWeird\u003c/code\u003eのような型でコンパイルを通そうと思ったら、\u003ccode\u003ebool\u003c/code\u003e型を\u003ccode\u003eCustomBoolean\u003c/code\u003eクラスに変換する、暗黙的なキャスト演算子も定義する必要があります。 \u003ca href=\"#fnref7\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003c/ol\u003e\n\u003c/div\u003e\n","createdAt":"2018-11-28T06:44:06Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"jdzmZhZi/RSUbJoeVOCGuS9kKGLpCvk3--Yyrh/IhmBpCzDKKI--rgn7A/adWNnVxgtc1O0Jsg==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2018-12-13T02:46:52Z","likesCount":19,"linkUrl":"https://qiita.com/matarillo/items/39e8666652f11d5c98d9","organization":null,"originalId":728732,"stockedCount":5,"title":"C#クイズとその解説","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AF%E3%82%A4%E3%82%BA\"\u003eクイズ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A7%A3%E8%AA%AC\"\u003e解説\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#dynamic%E5%9E%8B\"\u003edynamic型\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#null%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%A8%E6%BC%94%E7%AE%97%E5%AD%90\"\u003enullチェックと演算子\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AB%96%E7%90%86%E6%BC%94%E7%AE%97%E3%81%A8%E7%9C%9F%E5%81%BD%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%A8%E6%BC%94%E7%AE%97%E5%AD%90\"\u003e論理演算と真偽チェックと演算子\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":8741,"uuid":"39e8666652f11d5c98d9","banReason":null,"adventCalendarItem":{"day":2,"calendar":{"name":"C# その2 ","urlName":"c-sharp-2","year":2018,"organization":null}},"author":{"encryptedId":"SeKIezQ6KmH9cempxOcbeBzDNg==--K6CIi/XRd6HFOogK--/N0l49soPoAzpwDYEpGLBQ==","originalId":2079,"description":"","facebookUrl":null,"githubUrl":"https://github.com/matarillo","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/2079/profile-images/1473680702","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F2079%2Fprofile-images%2F1473680702?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=fcc5bb05225881c227703339a5b282b7","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F2079%2Fprofile-images%2F1473680702?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=f5d14452e90e4b7c9f5d33050622ea16","urlName":"matarillo","websiteUrl":null,"twitterUrl":"https://twitter.com/matarillo","twitterUrlName":"matarillo","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"dynamic","urlName":"dynamic"},{"name":"演算子オーバーロード","urlName":"%e6%bc%94%e7%ae%97%e5%ad%90%e3%82%aa%e3%83%bc%e3%83%90%e3%83%bc%e3%83%ad%e3%83%bc%e3%83%89"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
