<!DOCTYPE html><html><head><meta charset="utf-8" /><title>[Unity] 海洋シミュレーションFFT Oceanを実装したい - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/Red_Black_GPGPU/items/2652f5bfd6d311d2034b" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="07QRQdbb/CBTK/zbTqygFCySvlTY5i8Vz+dSKZ2J6A5S633/FUdrLSpIO2YHO376Sbhttw6rkLtVnhVG24RJ3Q==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@Red_Black_GPGPU" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="[Unity] 海洋シミュレーションFFT Oceanを実装したい - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XMVZ1YVhSNVhTRG10YmZtdEl2amdyZmpnNV9qZzZYamc2empnN3pqZ3Jmamc2ZmpnN05HUmxRZ1QyTmxZVzdqZ3BMbHJwX29vNFhqZ1pmamdaX2pnWVEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ODg1Y2JlNzViZjRkZWY0ZjFlNjJjYzM4M2JhOGE5NjA&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRkpsWkY5Q2JHRmphMTlIVUVkUVZRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGY1NDE1ZTgwN2QzNmU5MTQ4ZWU2YmFjYmFjNjZkYzU&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=8a23b8b91a5a3dee1bb3c7bd5fc60347"><meta property="og:description" content="

はじめに

この記事はUnity #3 Advent Calendar 2020の9日目の記事です。

この記事では高速フーリエ変換(FFT)を使った海洋シミュレーション、FFT Oceanについて書いていこうと思います。Unit..."><meta content="https://qiita.com/Red_Black_GPGPU/items/2652f5bfd6d311d2034b" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity,GPGPU,FFT,ComputeShader" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-5e0329a2-ca5b-4c60-a397-fe5ea15be2ec"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FRed_Black_GPGPU%2Fitems%2F2652f5bfd6d311d2034b">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FRed_Black_GPGPU%2Fitems%2F2652f5bfd6d311d2034b">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-5e0329a2-ca5b-4c60-a397-fe5ea15be2ec">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-12-09T16:16:24.000+09:00","dateModified":"2021-02-26T20:02:51.000+09:00","headline":"[Unity] 海洋シミュレーションFFT Oceanを実装したい","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XMVZ1YVhSNVhTRG10YmZtdEl2amdyZmpnNV9qZzZYamc2empnN3pqZ3Jmamc2ZmpnN05HUmxRZ1QyTmxZVzdqZ3BMbHJwX29vNFhqZ1pmamdaX2pnWVEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ODg1Y2JlNzViZjRkZWY0ZjFlNjJjYzM4M2JhOGE5NjA\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRkpsWkY5Q2JHRmphMTlIVUVkUVZRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGY1NDE1ZTgwN2QzNmU5MTQ4ZWU2YmFjYmFjNjZkYzU\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=8a23b8b91a5a3dee1bb3c7bd5fc60347","mainEntityOfPage":"https://qiita.com/Red_Black_GPGPU/items/2652f5bfd6d311d2034b","author":{"@type":"Person","address":"","email":null,"identifier":"Red_Black_GPGPU","name":"Red_Black_GPGPU","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fprofile-images%2F1570536563?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=09ca64e33bfb58d31bd1925c4a039826","url":"https://qiita.com/Red_Black_GPGPU","description":"GPGPUでいろいろやりたくてさまよっている人です。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Red_Black_GPGPU","type":"items","id":"2652f5bfd6d311d2034b"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Red_Black_GPGPU","type":"items","id":"2652f5bfd6d311d2034b"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Red_Black_GPGPU","type":"items","id":"2652f5bfd6d311d2034b"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/Red_Black_GPGPU/items/2652f5bfd6d311d2034b","location":"/Red_Black_GPGPU/items/2652f5bfd6d311d2034b","scheme":"https","host":"qiita.com","port":null,"pathname":"/Red_Black_GPGPU/items/2652f5bfd6d311d2034b","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"mLIkLDpgyqlz0HNlajZImhJYYGIEZEr9bdm7sjBtQiwZ7UiS+fxdpAqztNgjoZZ0d3KzgdIp9VP3oPzddmDj/w==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-67251f46-c56b-4bc2-9f07-3fc3d131221d"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b/likers" class="css-1iupg5d">124</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">103</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/2652f5bfd6d311d2034b/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2020/unity3" class="it-AdcalRibbon_title">Unity #3<!-- --> Advent Calendar<!-- --> <!-- -->2020</a>Day 9</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/Red_Black_GPGPU"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/profile-images/1570536563" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/Red_Black_GPGPU" class="css-10ougpm">@<!-- -->Red_Black_GPGPU</a><div class="css-1ay9vb9"><span><meta content="2020-12-09T07:16:24Z"/><time dateTime="2021-02-26T11:02:51Z" class="css-m19uds">updated at 2021-02-26</time></span></div></div></div></div></div><h1 class="css-cgzq40">[Unity] 海洋シミュレーションFFT Oceanを実装したい</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/gpgpu" class="css-4czcte">GPGPU</a><a href="/tags/fft" class="css-4czcte">FFT</a><a href="/tags/computeshader" class="css-4czcte">ComputeShader</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>この記事は<a href="https://qiita.com/advent-calendar/2020/unity3">Unity #3 Advent Calendar 2020</a>の9日目の記事です。</p>

<p>この記事では高速フーリエ変換(FFT)を使った海洋シミュレーション、FFT Oceanについて書いていこうと思います。Unityに限らずいろんなゲームエンジンで再現できるよう理論サイドも俯瞰しつつ、私が実装を通して理解したことをまとめさせていただければと思います。</p>

<p>まずはこんな感じの絵を出すところまでを目標にします。<br>
<a href="https://camo.qiitausercontent.com/513d97a241919ff1a36d133d3dddcdf9964d8190/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f36363932616336652d353062612d666635652d386564332d3530633536366464636638352e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3db1af5c549408c40b0c5ca4c5b92618" alt="ezgif-4-f4ec4a5a133b.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=dd4aabb5d608b40bbaeecf31c0d7990a 1x" loading="lazy"></a></p>

<p>次に発展として、法線ベクトルの算出や、より波を尖らせてそれっぽくすることをやっていこうと思います。<br>
最終的にはこんな絵ができあがります。<br>
<a href="https://camo.qiitausercontent.com/edaedb8253279c70ec45b071980f5cec50227c8b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f37306137636463332d333862612d366338372d306465392d3432353035343233643031382e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F70a7cdc3-38ba-6c87-0de9-42505423d018.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9f87d8838abfef951d8ad12a2fc99075" alt="LjjFC1W1vV33n67B.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/70a7cdc3-38ba-6c87-0de9-42505423d018.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F70a7cdc3-38ba-6c87-0de9-42505423d018.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b2a7997b21c15a1c638d35ed07469473 1x" loading="lazy"></a></p>

<h2>
<span id="fft-oceanについて" class="fragment"></span><a href="#fft-ocean%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>FFT Oceanについて</h2>

<p>音声信号などの波形はフーリエ変換することで周波数を得ることができます。逆に周波数情報から波形を求めることができます(逆フーリエ変換)。</p>

<p>FFT Oceanは海面の高さを周波数から逆フーリエ変換で求めてしまおうというものです。すなわち周波数スペクトルが大事になってきます。</p>

<p>この周波数スペクトルをTessendorfの書いた手法で生成します。<br>
<a href="https://evasion.imag.fr/Membres/Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/simulating-ocean-water-01.pdf" class="autolink" rel="nofollow noopener" target="_blank">https://evasion.imag.fr/Membres/Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/simulating-ocean-water-01.pdf</a></p>

<p>一部のゲームや映画(タイタニック)などいろんなところに使われている有名(?)な手法のようです。</p>

<p>CUDA Sampleの中にもあったりします。<br>
<a href="https://docs.nvidia.com/cuda/cuda-samples/index.html#cuda-fft-ocean-simulation" class="autolink" rel="nofollow noopener" target="_blank">https://docs.nvidia.com/cuda/cuda-samples/index.html#cuda-fft-ocean-simulation</a><br>
<a href="https://camo.qiitausercontent.com/2702595913b37b1de9fb0077ca58277bf587230f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f33653237663831362d323638372d666564622d336537382d3566326461323966393236382e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F3e27f816-2687-fedb-3e78-5f2da29f9268.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=dd9325fa6b65aea9a60f9345618bf468" alt="out_20201204_010043.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/3e27f816-2687-fedb-3e78-5f2da29f9268.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F3e27f816-2687-fedb-3e78-5f2da29f9268.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ee655382ed5a3d743db3202ca2c82d28 1x" loading="lazy"></a></p>

<h1>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h1>

<h2>
<span id="0概要をざっくりと" class="fragment"></span><a href="#0%E6%A6%82%E8%A6%81%E3%82%92%E3%81%96%E3%81%A3%E3%81%8F%E3%82%8A%E3%81%A8"><i class="fa fa-link"></i></a>0.概要をざっくりと</h2>

<p>(画像はNVIDIAのOceanCSのpdfより)<br>
<a href="https://camo.qiitausercontent.com/032a168d502d6cc62873b9e458288fc2a0363f3c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f66353135383231342d653836372d373430332d306637612d3934396238343436373431382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Ff5158214-e867-7403-0f7a-949b84467418.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d0269a3e0ce7b63fbfd7674889a1c133" alt="nvtex1.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/f5158214-e867-7403-0f7a-949b84467418.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Ff5158214-e867-7403-0f7a-949b84467418.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6c9d8bfe80060c43f342543ad58fb08e 1x" loading="lazy"></a></p>

<p>１、まずは事前計算で左の画像をCPUで計算しGPU上のメモリに載せておく<br>
２、それをベースに毎フレーム真ん中の画像をGPU上で生成(tはtime)。これが周波数に相当<br>
３、GPU上で逆フーリエ変換をして右の画像(=海面の高さ)を生成<br>
４、右の画像から実際の位置にレンダリング</p>

<p>※数式上、最初から最後まで複素数がでてきますが、画像でいうと左の画像と中央の画像ではr,gが実数,虚数に対応、右の画像は実数を白で表現してい(ると思われ)ます。CUDA Sampleでも海面の高さには実数のみを使っていました。</p>

<h2>
<span id="1事前計算でh0kをcpuで計算しgpu上のメモリに載せておく" class="fragment"></span><a href="#1%E4%BA%8B%E5%89%8D%E8%A8%88%E7%AE%97%E3%81%A7h0k%E3%82%92cpu%E3%81%A7%E8%A8%88%E7%AE%97%E3%81%97gpu%E4%B8%8A%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E8%BC%89%E3%81%9B%E3%81%A6%E3%81%8A%E3%81%8F"><i class="fa fa-link"></i></a>1.事前計算でh0(k)をCPUで計算しGPU上のメモリに載せておく</h2>

<p>ここで求めたいのは<br>
<a href="https://camo.qiitausercontent.com/b3d62483aba7d71b23a607c87fedbd6acc960349/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32393564643665622d326637612d346262342d643762342d6266646365666434336135382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F295dd6eb-2f7a-4bb4-d7b4-bfdcefd43a58.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8f6c046f1d29d6bf105570d386311787" alt="nvtex_left_copy.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/295dd6eb-2f7a-4bb4-d7b4-bfdcefd43a58.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F295dd6eb-2f7a-4bb4-d7b4-bfdcefd43a58.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=31623739f137ed42e61680cb9ab60953 1x" loading="lazy"></a></p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>
  \tilde{h}_0(\vec{k})  =\frac{1}{\sqrt{2}}(\xi_r+i\xi_i)\sqrt{P_h(\vec{k})}

</code></pre></div></div>

<p>です。<br>
正直最初ほとんどの記号が意味ワカンナイ状態でしたが、他人のコードを見ながらちょっとずつ理解していった感じです。ひとつずつ見ていきましょう。</p>

<h3>
<span id="kの定義" class="fragment"></span><a href="#k%E3%81%AE%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>Kの定義</h3>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\vec{k}=(k_x,k_z)=(\frac{2\pi n}{L_x},\frac{2\pi m}{L_z})
</code></pre></div></div>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>-\frac{N}{2}\leq n&lt;\frac{N}{2}\\
-\frac{M}{2}\leq m&lt;\frac{M}{2}\\
n,mは整数
</code></pre></div></div>

<p>早速難しそうですが、kはN×Mの二次元配列みたいなもんです。画像の各ピクセルにkの各要素が対応している感じです。</p>

<p>今後FFTで実装することを考慮し2のべき乗とし、今は$N=256$,$M=256$くらいで考えておけばよいです。<br>
また$L_x,L_z$は海面サイズです。<br>
こちらに関しては、スケールの問題なので何でもいいと最初思ってましたが論文にはこうありました。<br>
・$dx=L_x/N &gt; 2$<br>
・$dz=L_z/M &gt; 2$<br>
・$dx,dz=2.5$  が最も良い (←自信ないのですが間違ってたらコメントしてください)</p>

<h3>
<span id="正規分布に基づく乱数" class="fragment"></span><a href="#%E6%AD%A3%E8%A6%8F%E5%88%86%E5%B8%83%E3%81%AB%E5%9F%BA%E3%81%A5%E3%81%8F%E4%B9%B1%E6%95%B0"><i class="fa fa-link"></i></a>正規分布に基づく乱数</h3>

<p>$\xi_r$と$\xi_i$はランダムな数です。具体的には正規分布する乱数が必要です。なんでこう難しそうな記号を使うのか・・・<br>
コードではボックス＝ミュラー法を使っています。これは標準正規分布する乱数を生成する手法です。<br>
参考<br>
<a href="https://qiita.com/sw1227/items/8f5da8c22d907352e4c9" id="reference-2d23c6ac074d90903943">JavaScriptでBox-Muller法による正規分布からのサンプリング</a></p>

<div class="code-frame" data-lang="c#"><div class="highlight"><pre class="with-code"><code><span class="c1">// Generates Gaussian random number with mean 0 and standard deviation 1.</span>
    <span class="n">Vector2</span> <span class="nf">Gauss</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">u1</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">u2</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">logU1</span> <span class="p">=</span> <span class="p">-</span><span class="m">2f</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">u1</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">sqrt</span> <span class="p">=</span> <span class="p">(</span><span class="n">logU1</span> <span class="p">&lt;=</span> <span class="m">0f</span><span class="p">)</span> <span class="p">?</span> <span class="m">0f</span> <span class="p">:</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">logU1</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">theta</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PI</span> <span class="p">*</span> <span class="m">2.0f</span> <span class="p">*</span> <span class="n">u2</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">z0</span> <span class="p">=</span> <span class="n">sqrt</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">z1</span> <span class="p">=</span> <span class="n">sqrt</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sin</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="phillips-spectrum" class="fragment"></span><a href="#phillips-spectrum"><i class="fa fa-link"></i></a>Phillips Spectrum</h3>

<p>最後に残った$P_h(\vec{k})$の中身はこれです。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>P_h(\vec{k})=A\frac{e^\frac{-1}{(kL)^2}}{k^4}|\vec{k}\cdot\vec{\omega}|^2
</code></pre></div></div>

<p>？？？？？？？？？<br>
<a href="https://camo.qiitausercontent.com/0db50e40c85acfcfaffd105bb94738cb4b47da46/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f63663237303364322d626266362d663632652d333562632d3365613164323731343435662e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcf2703d2-bbf6-f62e-35bc-3ea1d271445f.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0bd08bd7eccd255a7cdeb027da0c7261" alt="utyuneko.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/cf2703d2-bbf6-f62e-35bc-3ea1d271445f.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcf2703d2-bbf6-f62e-35bc-3ea1d271445f.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8bb3c629d7abdbcc385e740ca4398c2d 1x" loading="lazy"></a></p>

<p>えー、これも一つずつ見ていきましょう。</p>

<p>$A$：これは定数です。最終的な波の高さのスケールだと思ってください。<br>
$e$：これはさすがに自然対数の底でいいでしょう。<br>
$k$：$\vec{k}$ の長さ。sqrt(k.x*k.x+k.y*k.y)とかで求められますね。<br>
$L$：$L=V^2/g$ ここで$V$は風速 つまり定数、$g$は重力定数で$g=9.81$です。<br>
$\vec{\omega}$：風向きの単位ベクトル(風がないと波が起きません)</p>

<p>これですべてそろいました。<br>
なお、この式の意味するところですが理論的に導き出されたというよりは、テッセンドルフさんが必死に海を観察し導き出された"経験的"な式らしいです。なのであまり細かいことを気にせずに、こういうものだと思ったほうがいいです、精神衛生上。</p>

<p>で、ここまではまぁいいのですが、論文にはさらにこうあります。<br>
<a href="https://camo.qiitausercontent.com/cca09e9887f101af7ab862725d9e40f73010ef23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f35336431303837612d363862662d396564652d336537352d3833336637613832386431652e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F53d1087a-68bf-9ede-3e75-833f7a828d1e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=37c9aae924e6e20a909a84a613a735df" alt="ronbun.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/53d1087a-68bf-9ede-3e75-833f7a828d1e.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F53d1087a-68bf-9ede-3e75-833f7a828d1e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f2e4abbf841e29d5a6b2f1c8d4216a8e 1x" loading="lazy"></a></p>

<p>多分ですが|k|が大きいとなにかがダメなようで、ちょっと修正しろと言ってるんですね。<br>
他のコードも参考に下記のような修正を加えるようにしました。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>
P_{h_{modify}}(\vec{k})=P_h(\vec{k})×e^{-k^2(0.001L)^2}

</code></pre></div></div>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">Phillips.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Phillips</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">uint</span> <span class="n">meshSize</span> <span class="p">=</span> <span class="m">256</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">uint</span> <span class="n">seasizeLx</span> <span class="p">=</span> <span class="n">meshSize</span> <span class="p">*</span> <span class="m">5</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">uint</span> <span class="n">seasizeLz</span> <span class="p">=</span> <span class="n">meshSize</span> <span class="p">*</span> <span class="m">5</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">G</span> <span class="p">=</span> <span class="m">9.81f</span><span class="p">;</span>              <span class="c1">// gravitational constant</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">A</span> <span class="p">=</span> <span class="m">0.000001f</span><span class="p">;</span>              <span class="c1">// wave scale factor  A - constant</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">windSpeed</span> <span class="p">=</span> <span class="m">30.0f</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">windDir</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PI</span> <span class="p">*</span> <span class="m">1.234f</span><span class="p">;</span> <span class="c1">//wind angle in radians</span>

    <span class="c1">// Generates Gaussian random number with mean 0 and standard deviation 1.</span>
    <span class="n">Vector2</span> <span class="nf">Gauss</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">u1</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">u2</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">logU1</span> <span class="p">=</span> <span class="p">-</span><span class="m">2f</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">u1</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">sqrt</span> <span class="p">=</span> <span class="p">(</span><span class="n">logU1</span> <span class="p">&lt;=</span> <span class="m">0f</span><span class="p">)</span> <span class="p">?</span> <span class="m">0f</span> <span class="p">:</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">logU1</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">theta</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PI</span> <span class="p">*</span> <span class="m">2.0f</span> <span class="p">*</span> <span class="n">u2</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">z0</span> <span class="p">=</span> <span class="n">sqrt</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">z1</span> <span class="p">=</span> <span class="n">sqrt</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sin</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Phillips spectrum</span>
    <span class="c1">// (Kx, Ky) - normalized wave vector</span>
    <span class="kt">float</span> <span class="nf">Generate_Phillips</span><span class="p">(</span><span class="kt">float</span> <span class="n">Kx</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Ky</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">k2mag</span> <span class="p">=</span> <span class="n">Kx</span> <span class="p">*</span> <span class="n">Kx</span> <span class="p">+</span> <span class="n">Ky</span> <span class="p">*</span> <span class="n">Ky</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">k2mag</span> <span class="p">==</span> <span class="m">0.0f</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="m">0.0f</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">float</span> <span class="n">k4mag</span> <span class="p">=</span> <span class="n">k2mag</span> <span class="p">*</span> <span class="n">k2mag</span><span class="p">;</span>

        <span class="c1">// largest possible wave from constant wind of velocity v</span>
        <span class="kt">float</span> <span class="n">L</span> <span class="p">=</span> <span class="n">windSpeed</span> <span class="p">*</span> <span class="n">windSpeed</span> <span class="p">/</span> <span class="n">G</span><span class="p">;</span>

        <span class="kt">float</span> <span class="n">k_x</span> <span class="p">=</span> <span class="n">Kx</span> <span class="p">/</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">k2mag</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">k_y</span> <span class="p">=</span> <span class="n">Ky</span> <span class="p">/</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">k2mag</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">w_dot_k</span> <span class="p">=</span> <span class="n">k_x</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">windDir</span><span class="p">)</span> <span class="p">+</span> <span class="n">k_y</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sin</span><span class="p">(</span><span class="n">windDir</span><span class="p">);</span>

        <span class="kt">float</span> <span class="n">phillips</span> <span class="p">=</span> <span class="n">A</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Exp</span><span class="p">(-</span><span class="m">1.0f</span> <span class="p">/</span> <span class="p">(</span><span class="n">k2mag</span> <span class="p">*</span> <span class="n">L</span> <span class="p">*</span> <span class="n">L</span><span class="p">))</span> <span class="p">/</span> <span class="n">k4mag</span> <span class="p">*</span> <span class="n">w_dot_k</span> <span class="p">*</span> <span class="n">w_dot_k</span><span class="p">;</span>

        <span class="c1">// damp out waves with very small length w &lt;&lt; l</span>
        <span class="kt">float</span> <span class="n">l2</span> <span class="p">=</span> <span class="p">(</span><span class="n">L</span> <span class="p">/</span> <span class="m">1000</span><span class="p">)</span> <span class="p">*</span> <span class="p">(</span><span class="n">L</span> <span class="p">/</span> <span class="m">1000</span><span class="p">);</span>
        <span class="n">phillips</span> <span class="p">*=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Exp</span><span class="p">(-</span><span class="n">k2mag</span> <span class="p">*</span> <span class="n">l2</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">phillips</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Generate base heightfield in frequency space</span>
    <span class="k">public</span> <span class="n">Vector2</span><span class="p">[]</span> <span class="nf">Generate_h0</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Vector2</span><span class="p">[]</span> <span class="n">h0</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">[</span><span class="n">meshSize</span> <span class="p">*</span> <span class="n">meshSize</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">y</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">y</span> <span class="p">&lt;</span> <span class="n">meshSize</span><span class="p">;</span> <span class="n">y</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">x</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="n">meshSize</span><span class="p">;</span> <span class="n">x</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="kt">float</span> <span class="n">kx</span> <span class="p">=</span> <span class="p">(-(</span><span class="kt">int</span><span class="p">)</span><span class="n">meshSize</span> <span class="p">/</span> <span class="m">2.0f</span> <span class="p">+</span> <span class="n">x</span><span class="p">)</span> <span class="p">*</span> <span class="p">(</span><span class="m">2.0f</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PI</span> <span class="p">/</span> <span class="n">seasizeLx</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">ky</span> <span class="p">=</span> <span class="p">(-(</span><span class="kt">int</span><span class="p">)</span><span class="n">meshSize</span> <span class="p">/</span> <span class="m">2.0f</span> <span class="p">+</span> <span class="n">y</span><span class="p">)</span> <span class="p">*</span> <span class="p">(</span><span class="m">2.0f</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">PI</span> <span class="p">/</span> <span class="n">seasizeLz</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">P</span> <span class="p">=</span> <span class="nf">Generate_Phillips</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kx</span> <span class="p">==</span> <span class="m">0.0f</span> <span class="p">&amp;&amp;</span> <span class="n">ky</span> <span class="p">==</span> <span class="m">0.0f</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">P</span> <span class="p">=</span> <span class="m">0.0f</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="kt">uint</span> <span class="n">i</span> <span class="p">=</span> <span class="n">y</span> <span class="p">*</span> <span class="n">meshSize</span> <span class="p">+</span> <span class="n">x</span><span class="p">;</span>
                <span class="n">h0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="nf">Gauss</span><span class="p">()</span> <span class="p">*</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">P</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">h0</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

</code></pre></div>
</div>

<p>これでCPU上で$h_0(\vec{k})$を計算することができました。</p>

<p>後のコードに含まれていますが、GPUに転送するコードの一部を載せておきます。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">FFTOceanMain.cs</span></div>
<div class="highlight"><pre class="with-code"><code>
    <span class="n">Vector2</span><span class="p">[]</span> <span class="n">h_h0</span><span class="p">;</span>
    <span class="n">ComputeBuffer</span> <span class="n">d_h0</span><span class="p">;</span>
    <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">h_h0</span> <span class="p">=</span> <span class="n">phillips</span><span class="p">.</span><span class="nf">Generate_h0</span><span class="p">();</span><span class="c1">//CPU側メモリ確保。サイズはsizeof(Vector2)*256*256</span>
        <span class="n">d_h0</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">h_h0</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">2</span><span class="p">);</span><span class="c1">//GPU側メモリ確保 サイズはsizeof(Vector2)*256*256</span>
        <span class="n">d_h0</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">h_h0</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="余談-w_dot_kの6乗のとき" class="fragment"></span><a href="#%E4%BD%99%E8%AB%87-w_dot_k%E3%81%AE6%E4%B9%97%E3%81%AE%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>余談 w_dot_kの6乗のとき</h4>

<p>余談ですが、Phillips Spectrumの計算でw_dot_kを2乗ではなく6乗でやる流派もあるようです。6乗にすることで、風の方向に応じた波が今まで以上に際立つそうです。</p>

<h4>
<span id="余談-donelan-bannerというワード" class="fragment"></span><a href="#%E4%BD%99%E8%AB%87-donelan-banner%E3%81%A8%E3%81%84%E3%81%86%E3%83%AF%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>余談 Donelan-Bannerというワード</h4>

<p>これも余談ですがPhillips Spectrumを求めた後、Donelan-Banner方向拡張?(中国語の翻訳なのでわかりませんが)という謎の計算をしてかけているコードも見かけたので一応書いておきます。<br>
<a href="https://zhuanlan.zhihu.com/p/96811613" class="autolink" rel="nofollow noopener" target="_blank">https://zhuanlan.zhihu.com/p/96811613</a><br>
(もう一つ別の人のコードでDonelan-Bannerを計算しているのを見つけたがどっかいった)</p>

<h2>
<span id="2それをベースに毎フレームhktをgpu上で生成tはtime" class="fragment"></span><a href="#2%E3%81%9D%E3%82%8C%E3%82%92%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E6%AF%8E%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0hkt%E3%82%92gpu%E4%B8%8A%E3%81%A7%E7%94%9F%E6%88%90t%E3%81%AFtime"><i class="fa fa-link"></i></a>2.それをベースに毎フレームh(k,t)をGPU上で生成(tはtime)</h2>

<p>次に求めるべきはこれです。<br>
<a href="https://camo.qiitausercontent.com/a667501190454808991537160bc6cb267d48942b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f65343537343237662d303831332d616537372d653331352d3161656463343565613938342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=240fe4a227e2810145815f9fe58fbfe8" alt="nvtex_mid_copy.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/e457427f-0813-ae77-e315-1aedc45ea984.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=df971c2a7d0e6f1ae6dcf14ee2c9720b 1x" loading="lazy"></a></p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\tilde{h}(\vec{k},t)=\tilde{h}_0(\vec{k})e^{i\omega(k)t}+\tilde{h}_0^*(-\vec{k})e^{-i\omega(k)t}
</code></pre></div></div>

<p>ここで$ \tilde{h}_0^*$は$ \tilde{h}_0$の共役複素数です。※虚部を−1倍した複素数のことを共役複素数と言います。<br>
あとhの上に乗ってる波線はチルダと読みますが特に深い意味はないので無視してください(なんか"似てる"的な意味合いがあるようです)<br>
$\omega(k)=\sqrt{gk}$<br>
$g$は重力定数 $=9.81$<br>
$k$は$\vec{k}$の長さです。<br>
$t$はtimeです。毎フレーム動的にh(k,t)が変わるということが分かります。</p>

<p>あと$e$の肩に虚数$i$が乗っています。高校数学でここまで習わないかもしれませんが、この計算は有名なヤツです。</p>

<p>オイラーの公式<br>
$$ e^{i\theta} = \cos\theta + i\sin\theta $$</p>

<p>プログラム実装的にはどうすればよいかと言うと<br>
「実数xが与えられるので$e^{ix}$を求めてください、cosとsin関数を駆使してね」<br>
ということなので四則演算とsin,cosが書ければ実装できることがわかります。</p>

<p>したがってこんなコードになります。<br>
GPU上にあるデータに対しての計算なのでCompute Shaderのコードになります。</p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">GenerateSpectrum.compute</span></div>
<div class="highlight"><pre class="with-code"><code>
<span class="cp">#pragma kernel GenerateSpectrumKernel
#define PI 3.14159265358979323846264338328
</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">h0</span><span class="p">;</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">ht</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">N</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">seasizeLx</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">seasizeLz</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">t</span><span class="p">;</span>

<span class="n">float2</span> <span class="nf">conjugate</span><span class="p">(</span><span class="n">float2</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">float2</span> <span class="n">f2</span><span class="p">;</span>
    <span class="n">f2</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">f2</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">arg</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">float2</span><span class="p">)</span><span class="n">f2</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">float2</span> <span class="nf">complex_exp</span><span class="p">(</span><span class="kt">float</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">float2</span><span class="p">)(</span><span class="n">cos</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">float2</span> <span class="nf">complex_add</span><span class="p">(</span><span class="n">float2</span> <span class="n">a</span><span class="p">,</span> <span class="n">float2</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">float2</span><span class="p">)(</span><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">float2</span> <span class="nf">complex_mult</span><span class="p">(</span><span class="n">float2</span> <span class="n">ab</span><span class="p">,</span> <span class="n">float2</span> <span class="n">cd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">float2</span><span class="p">)(</span><span class="n">ab</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">cd</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">ab</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">cd</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">cd</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">ab</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">cd</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">numthreads</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">GenerateSpectrumKernel</span><span class="p">(</span><span class="n">uint2</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">x</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">y</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">in_index</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">in_mindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span> <span class="c1">// mirrored</span>
    <span class="n">uint</span> <span class="n">out_index</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
    <span class="c1">// calculate wave vector</span>
    <span class="n">float2</span> <span class="n">k</span><span class="p">;</span>
    <span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">seasizeLx</span><span class="p">);</span>
    <span class="n">k</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">seasizeLz</span><span class="p">);</span>
    <span class="c1">// calculate dispersion w(k)</span>
    <span class="kt">float</span> <span class="n">k_len</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">k</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">w</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">9</span><span class="p">.</span><span class="mi">81</span><span class="n">f</span> <span class="o">*</span> <span class="n">k_len</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">N</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">N</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">float2</span> <span class="n">h0_k</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="n">in_index</span><span class="p">];</span>
        <span class="n">float2</span> <span class="n">h0_mk</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="n">in_mindex</span><span class="p">];</span>
        <span class="c1">// output frequency-space complex values</span>
        <span class="n">ht</span><span class="p">[</span><span class="n">out_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">complex_add</span><span class="p">(</span><span class="n">complex_mult</span><span class="p">(</span><span class="n">h0_k</span><span class="p">,</span> <span class="n">complex_exp</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">t</span><span class="p">)),</span> <span class="n">complex_mult</span><span class="p">(</span><span class="n">conjugate</span><span class="p">(</span><span class="n">h0_mk</span><span class="p">),</span> <span class="n">complex_exp</span><span class="p">(</span><span class="o">-</span><span class="n">w</span> <span class="o">*</span> <span class="n">t</span><span class="p">)));</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
</div>

<p>難しい点としては$ \tilde{h}_0(-\vec{k}) $のメモリアクセスかなと思います。</p>

<p>コードでいうとin_mindexの計算についてです。</p>

<h3>
<span id="in_mindexの計算" class="fragment"></span><a href="#in_mindex%E3%81%AE%E8%A8%88%E7%AE%97"><i class="fa fa-link"></i></a>in_mindexの計算</h3>

<p>ちょっと考えてみましょう(自分のメモ代わりにもなるので)</p>

<p>ここで h0[y*N+x] というように配列変数にアクセスし$\tilde{h}_0(\vec{k})$の値を取り出せたとします。</p>

<p>そのときx,yを使って$\tilde{h}_0(-\vec{k})$を取り出すにはどうしたらいいでしょう、という問題になります。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\vec{k}=(k_x,k_z)=(\frac{2\pi n}{L_x},\frac{2\pi m}{L_z})\\
 n=-\frac{N}{2}+x\\
 m=-\frac{M}{2}+y\\
 0\leqq x&lt;N\\
 0\leqq y&lt;M\\
 x,yは整数
</code></pre></div></div>

<p>なのでマイナスは</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>-\vec{k}=(-k_x,-k_z)=(-\frac{2\pi n}{L_x},-\frac{2\pi m}{L_z})\\
</code></pre></div></div>

<p>ここから</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>-\vec{k}=(\frac{2\pi n'}{L_x},\frac{2\pi m'}{L_z})\\
とし\\
n'=-n=\frac{N}{2}-x=-\frac{N}{2}+(N-x)\\
m'=-m=\frac{M}{2}-y=-\frac{M}{2}+(M-y)\\
</code></pre></div></div>

<p>つまり</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>x'=N-x\\
y'=M-y\\
</code></pre></div></div>

<p>としてx' y'を使ってh0[y'*N+x'] というようアクセスすることで$ \tilde{h}_0(-\vec{k}) $が得られることがわかりました。</p>

<p>ただしx=0 や y=0のときx'=N y'=Mとなり範囲外のアクセスになるのでx'=Nのときはx'=0(y'のときも同様)の値を使って計算してしまっています。ここは目を瞑ります。</p>

<h3>
<span id="dispatchグループ数について" class="fragment"></span><a href="#dispatch%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>Dispatchグループ数について</h3>

<p>このCompute Shaderコードでは<br>
id.x id.yが0～255になることを想定しているので、C#のDispatch側でも</p>

<div class="code-frame" data-lang="c#"><div class="highlight"><pre class="with-code"><code><span class="n">shader</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernel_GenerateSpectrumKernel</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">256</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</code></pre></div></div>

<p>このようにグループ数を指定する必要があります。</p>

<h2>
<span id="3gpu上で逆フーリエ変換をして右の画像海面の高さを生成" class="fragment"></span><a href="#3gpu%E4%B8%8A%E3%81%A7%E9%80%86%E3%83%95%E3%83%BC%E3%83%AA%E3%82%A8%E5%A4%89%E6%8F%9B%E3%82%92%E3%81%97%E3%81%A6%E5%8F%B3%E3%81%AE%E7%94%BB%E5%83%8F%E6%B5%B7%E9%9D%A2%E3%81%AE%E9%AB%98%E3%81%95%E3%82%92%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>3.GPU上で逆フーリエ変換をして右の画像(=海面の高さ)を生成</h2>

<p>さきほど求めた画像$\tilde{h}(\vec{k},t)$をもとに逆2DFFTをかけ海面の高さを算出します。<br>
式で書くと</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>h(\vec{x},t)=\sum_{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot\vec{x}}\\
</code></pre></div></div>

<p>を求めたいです。<br>
その計算の仕方ですが、ちょっと長めの説明をしたいので先に結論だけ言います。<br>
<a href="https://camo.qiitausercontent.com/a667501190454808991537160bc6cb267d48942b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f65343537343237662d303831332d616537372d653331352d3161656463343565613938342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=240fe4a227e2810145815f9fe58fbfe8" alt="nvtex_mid_copy.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/e457427f-0813-ae77-e315-1aedc45ea984.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=df971c2a7d0e6f1ae6dcf14ee2c9720b 1x" loading="lazy"></a><br>
まずこの画像を普通に2次元逆FFTで変換します。そのあと<br>
<b>・計算結果全体を(N/2,M/2)ずらす<br>
・要素のindex x,zが(x+z)%2==1となる要素に-1をかける</b><br>
をすればよいです。</p>

<h3>
<span id="2次元fft" class="fragment"></span><a href="#2%E6%AC%A1%E5%85%83fft"><i class="fa fa-link"></i></a>2次元FFT</h3>

<p>まずは普通の方法からおさらいしましょう。(普通ってなんだよ)</p>

<p>2DFFTのやりかたはまず横方向にそれぞれFFTを実行し<br>
<a href="https://camo.qiitausercontent.com/a63c42b7624c7e04f259ab892fc617105a389c0f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f63656639306565302d393836322d656634312d613066342d3033346130353432393330392e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcef90ee0-9862-ef41-a0f4-034a05429309.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c0af89ab71fae9adeacac4a4bcd693c5" alt="fftx.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/cef90ee0-9862-ef41-a0f4-034a05429309.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcef90ee0-9862-ef41-a0f4-034a05429309.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=75f5b2af4eeff84f5c4467b50454f254 1x" loading="lazy"></a><br>
その結果を今度は縦方向にFFTします。<br>
<a href="https://camo.qiitausercontent.com/fc0ef2b0bc60bc84dde26438cd0f8cd38ef94c33/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f38666335376535352d323036632d643765632d303532652d6665356331613938306565382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F8fc57e55-206c-d7ec-052e-fe5c1a980ee8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f79fac0b803ee59c9dba4851c084290a" alt="ffty.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/8fc57e55-206c-d7ec-052e-fe5c1a980ee8.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F8fc57e55-206c-d7ec-052e-fe5c1a980ee8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d56c975fabfc855c39de0583bab84037 1x" loading="lazy"></a><br>
iFFT(逆フーリエ変換)でも同様です。また縦→横の順にやっても答えは変わりません。<br>
FFTの具体的な計算方法についてはわかりやすいサイトがたくさんあるのでここでは割愛させてください。またDFTからFFTで計算量が削減される話もこの記事では割愛させてください。</p>

<p>投げっぱなしなのもあれなので参考になりそうな記事をいくつかピックアップしてみました。</p>

<p>Compute Shaderで2DFFTしているコード<br>
<a href="http://hikita12312.hatenablog.com/?page=1511103886" rel="nofollow noopener" target="_blank">下町のナポレオン Compute ShaderでFFTと畳み込み演算でブラー</a></p>

<p>Compute Shaderではないが、ループ型のFFT計算のコードが乗ってる記事<br>
<a href="https://qiita.com/habuyoshiaki/items/68d502c7bc0c35c168ef#%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%8C2%E3%81%AE%E5%86%AA%E4%B9%97%E5%B0%82%E7%94%A8%E3%81%AEfft%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E5%AE%9F%E8%A3%85" id="reference-fd263576ea69167c0c2b">任意要素数の高速フーリエ変換</a><br>
<a href="https://qiita.com/bellbind/items/ba7aa07f6c915d400000#7-javascript%E3%81%AB%E3%82%88%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%97%E7%89%88fft%E5%AE%9F%E8%A3%85%E3%82%B3%E3%83%BC%E3%83%89" id="reference-be5a5ec582f08401473a">高速フーリエ変換FFTを理解する</a><br>
<a href="https://qiita.com/hayasagatarinai/items/b9fe56b79c9af20a98d9" id="reference-f5cea7849d4ff30d45de">FFT(Fast Fourier transform)をC++で実装する</a></p>

<p>DFTから理解する<br>
<a href="https://qiita.com/TumoiYorozu/items/5855d75a47ef2c7e62c8" id="reference-751ccfe47600176c3229">離散フーリエ変換(DFT)の仕組みを完全に理解する</a></p>

<h3>
<span id="マイナス周波数成分から始まるスペクトルのifft" class="fragment"></span><a href="#%E3%83%9E%E3%82%A4%E3%83%8A%E3%82%B9%E5%91%A8%E6%B3%A2%E6%95%B0%E6%88%90%E5%88%86%E3%81%8B%E3%82%89%E5%A7%8B%E3%81%BE%E3%82%8B%E3%82%B9%E3%83%9A%E3%82%AF%E3%83%88%E3%83%AB%E3%81%AEifft"><i class="fa fa-link"></i></a>マイナス周波数成分から始まるスペクトルのiFFT</h3>

<p>先ほどの式を再掲します。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>h(\vec{x},t)=\sum_{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot\vec{x}}\\
</code></pre></div></div>

<p>ここで$\vec{k}$と$\vec{x}$の定義は</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\vec{k}=(k_x,k_z)=(\frac{2\pi n}{L_x},\frac{2\pi m}{L_z})\\
-\frac{N}{2}\leq n&lt;\frac{N}{2}\\
-\frac{M}{2}\leq m&lt;\frac{M}{2}\\
n,mは整数
</code></pre></div></div>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\vec{x}=(x,z)=(\frac{qL_x}{N},\frac{rL_z}{M})\\
-\frac{N}{2}\leq q&lt;\frac{N}{2}\\
-\frac{M}{2}\leq r&lt;\frac{M}{2}\\
q,rは整数
</code></pre></div></div>

<p>こうなっています。<br>
ベクトルを成分別に分けて書くと上記の式はこうなります。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>h(\vec{x},t)=h(x,z,t)=\sum_{m=-\frac{M}{2}}^{\frac{M}{2}-1}\sum_{n=-\frac{N}{2}}^{\frac{N}{2}-1}\tilde{h}(\frac{2\pi n}{Lx},\frac{2\pi m}{Lz},t)e^{i(\frac{2\pi n}{Lx}x+\frac{2\pi m}{Lz}z)}
</code></pre></div></div>

<p>n,m,x,zがマイナスから始まっていることに注意です。なので普通にFFT(iFFT)の計算を適応しただけだと間違った答えになります。</p>

<p>画像をみればわかるとおり、中心に周波数0成分がきていますね。<br>
<a href="https://camo.qiitausercontent.com/a667501190454808991537160bc6cb267d48942b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f65343537343237662d303831332d616537372d653331352d3161656463343565613938342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=240fe4a227e2810145815f9fe58fbfe8" alt="nvtex_mid_copy.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/e457427f-0813-ae77-e315-1aedc45ea984.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=df971c2a7d0e6f1ae6dcf14ee2c9720b 1x" loading="lazy"></a></p>

<h4>
<span id="一応証明" class="fragment"></span><a href="#%E4%B8%80%E5%BF%9C%E8%A8%BC%E6%98%8E"><i class="fa fa-link"></i></a>一応証明</h4>

<p>普通にFFT(iFFT)の計算を適応しただけだと間違った答えになるので、さっき太文字で書いたやり方でやる必要があります。<br>
本当にそれでいいのか証明させてください・・・<br>
まずは0オリジンで考えたいのでこうします。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>n'\in{(0,1,2,3,...,N-1)}\\
m'\in{(0,1,2,3,...,M-1)}\\
x'\in{(0,1,2,3,...,N-1)}\\
z'\in{(0,1,2,3,...,M-1)}\\
x''\equiv x'+N/2 \quad(mod \quad N)\\
z''\equiv z'+M/2 \quad(mod \quad M)\\
</code></pre></div></div>

<p>するとx,z,n,mはこう書けます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>n=n'-\frac{N}{2}\\
m=m'-\frac{M}{2}\\
x=\frac{L_x(-\frac{N}{2}+x')}{N}=-\frac{L_x}{2}+\frac{x'L_x}{N}\\
z=\frac{L_z(-\frac{M}{2}+z')}{M}=-\frac{L_z}{2}+\frac{z'L_z}{M}\\
</code></pre></div></div>

<p>続いて式簡略化のため${h'}$と$\tilde{h'}$を定義</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>{h'}({x'},{z'},t)=h(x,z,t)\\
\tilde{h'}(n',m',t)=\tilde{h}(\frac{2\pi n}{Lx},\frac{2\pi m}{Lz},t)\\
</code></pre></div></div>

<p>あとは求めたい$h()$についてゴリゴリ式変形すると</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>{h'}({x'},{z'},t)=h(x,z,t)=\sum_{m=-\frac{M}{2}}^{\frac{M}{2}-1}\sum_{n=-\frac{N}{2}}^{\frac{N}{2}-1}\tilde{h}(\frac{2\pi n}{Lx},\frac{2\pi m}{Lz},t)e^{i(\frac{2\pi n}{Lx}x+\frac{2\pi m}{Lz}z)}\\
=\sum_{m'=0}^{M-1}\sum_{n'=0}^{N-1}\tilde{h'}(n',m',t)e^{i(\frac{2\pi (n'-\frac{N}{2})}{Lx}x+\frac{2\pi (m'-\frac{M}{2})}{Lz}z)}\\
=\sum_{m'=0}^{M-1}\sum_{n'=0}^{N-1}\tilde{h'}(n',m',t)e^{
i(\frac{\pi N}{2}-\pi x'+\frac{2\pi n'(x'-N/2)}{N})+
i(\frac{\pi M}{2}-\pi z'+\frac{2\pi m'(z'-M/2)}{M})
}\\
</code></pre></div></div>

<p>ここでN,Mは256としていたので</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>e^{i(\frac{\pi N}{2})}=1\\
e^{i(\frac{\pi M}{2})}=1\\
</code></pre></div></div>

<p>なので消すことができ</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>e^{i (\frac{2\pi (x'+N/2)}{N})}=\\
e^{i (\frac{2\pi (x'-N/2) +2\pi N}{N})}=\\
e^{i (\frac{2\pi (x'-N/2)}{N})}=\\
e^{i (\frac{2\pi x''}{N})}\\
</code></pre></div></div>

<p>と置き換えられ</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>e^{i \pi}=-1
</code></pre></div></div>

<p>なのでまとめると</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>{h'}({x'},{z'},t)=
\sum_{m'=0}^{M-1}
\sum_{n'=0}^{N-1}
\tilde{h'}(n',m',t)e^{
i(\frac{\pi N}{2}-\pi x'+\frac{2\pi n'(x'-N/2)}{N})+
i(\frac{\pi M}{2}-\pi z'+\frac{2\pi m'(z'-M/2)}{M}) }\\

=(-1)^{x'}(-1)^{z'}\sum_{m'=0}^{M-1}\sum_{n'=0}^{N-1}\tilde{h'}(n',m',t)e^{
i(\frac{2\pi n'x''}{N})+
i(\frac{2\pi m'z''}{M})
}
</code></pre></div></div>

<p>あとは$x'$と$x''$を入れ替え、$z$も同様にして</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>
{h'}({x''},{z''},t)\\
={h'}({x'}+\frac{N}{2} (mod N),{z'}+\frac{M}{2} (mod M),t)\\
=(-1)^{x''}(-1)^{z''}\sum_{m'=0}^{M-1}\sum_{n'=0}^{N-1}\tilde{h'}(n',m',t)e^{
i(\frac{2\pi n'x'}{N})+
i(\frac{2\pi m'z'}{M})
}

</code></pre></div></div>

<p>これでやっとよくあるFFTの形になりました(ほんとか)。。。<br>
普通と違うところは</p>

<p>・$h'$の添え字 ： →計算結果の書き込み先を(N/2,M/2)ずらせばよい<br>
・$(-1)^{x''}$と$(-1)^{z''}$ : →計算結果の書き込み先index x,zが(x+z)%2==1となる要素に-1をかければよい</p>

<p>ということでやはりよさそうです。</p>

<p>これらの要素を盛り込むことでこのようなコードになります。<br>
ここでは横方向のfftと縦方向のfftを同じコードで実現しています。横方向を計算した後 縦方向を計算するので合計2回実行される前提のコードです。</p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">fft.compute</span></div>
<div class="highlight"><pre class="with-code"><code><span class="cp">#pragma kernel FFT2Dfunc256inv
#pragma kernel DFT2Dfunc256inv
#define PI 3.14159265358979323846264338328
</span><span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">;</span><span class="c1">//xが実数、yが虚数を格納</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">buffer_dmy</span><span class="p">;</span><span class="c1">//xが実数、yが虚数を格納</span>

<span class="c1">//256*256要素の2D IFFT専用かつ負の周波数もあることも考慮しているコード(普通のFFT,DFTは正の周波数からはじまる)</span>
<span class="c1">//グループ数Nで実行されること前提</span>
<span class="c1">//2回実行されること前提</span>
<span class="cp">#define M (8)
#define N (1&lt;&lt;M)
</span><span class="n">groupshared</span> <span class="n">float2</span> <span class="n">block</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
<span class="p">[</span><span class="n">numthreads</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">FFT2Dfunc256inv</span><span class="p">(</span><span class="n">uint</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">,</span> <span class="n">uint</span> <span class="n">grid</span> <span class="o">:</span> <span class="n">SV_GroupID</span><span class="p">,</span> <span class="n">uint</span> <span class="n">gi</span> <span class="o">:</span> <span class="n">SV_GroupIndex</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">block</span><span class="p">[</span><span class="n">gi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">grid</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">gi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
    <span class="n">block</span><span class="p">[</span><span class="n">gi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">grid</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">gi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">loopidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loopidx</span> <span class="o">&lt;</span> <span class="n">M</span><span class="p">;</span> <span class="n">loopidx</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">dleng</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">loopidx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">uint</span> <span class="n">t</span> <span class="o">=</span> <span class="n">gi</span> <span class="o">%</span> <span class="n">dleng</span><span class="p">;</span>
        <span class="n">uint</span> <span class="n">t0</span> <span class="o">=</span> <span class="p">(</span><span class="n">gi</span> <span class="o">/</span> <span class="n">dleng</span><span class="p">)</span> <span class="o">*</span> <span class="n">dleng</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="p">;</span>
        <span class="n">uint</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">dleng</span><span class="p">;</span>
        <span class="n">GroupMemoryBarrierWithGroupSync</span><span class="p">();</span>
        <span class="kt">float</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="n">t1</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="n">t1</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">r0</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="n">t0</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">r1</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">i0</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="n">t0</span><span class="p">].</span><span class="n">y</span> <span class="o">-</span> <span class="n">i1</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">rad</span> <span class="o">=</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">t</span> <span class="o">/</span> <span class="n">dleng</span><span class="p">;</span><span class="c1">//invなので-がかかっている</span>
        <span class="kt">float</span> <span class="n">fsin</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">fcos</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">);</span>
        <span class="n">block</span><span class="p">[</span><span class="n">t0</span><span class="p">].</span><span class="n">x</span> <span class="o">+=</span> <span class="n">r1</span><span class="p">;</span>
        <span class="n">block</span><span class="p">[</span><span class="n">t0</span><span class="p">].</span><span class="n">y</span> <span class="o">+=</span> <span class="n">i1</span><span class="p">;</span>
        <span class="n">block</span><span class="p">[</span><span class="n">t1</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">fcos</span> <span class="o">-</span> <span class="n">i0</span> <span class="o">*</span> <span class="n">fsin</span><span class="p">;</span>
        <span class="n">block</span><span class="p">[</span><span class="n">t1</span><span class="p">].</span><span class="n">y</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="n">fsin</span> <span class="o">+</span> <span class="n">i0</span> <span class="o">*</span> <span class="n">fcos</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">GroupMemoryBarrierWithGroupSync</span><span class="p">();</span>
    <span class="n">float2</span> <span class="n">reim0</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="n">reversebits</span><span class="p">(</span><span class="n">gi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">M</span><span class="p">)];</span><span class="c1">//32はuint=32bitの32</span>
    <span class="n">float2</span> <span class="n">reim1</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="n">reversebits</span><span class="p">(</span><span class="n">gi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">M</span><span class="p">)];</span>
    <span class="n">reim1</span> <span class="o">=</span> <span class="o">-</span><span class="n">reim1</span><span class="p">;</span><span class="c1">//出力結果に(-1)^indexが乗算されるので</span>
    <span class="c1">//書き込みはx,yを転置している。これによって2D FFTの計算の1回目と2回目を同じコードにできて、かつ、最終的なメモリ配置は最初と同じに戻る</span>
    <span class="c1">//最終的な書き込み先をN/2,N/2ずらすのも忘れずに</span>
    <span class="n">buffer_dmy</span><span class="p">[(</span><span class="n">gi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">grid</span><span class="p">]</span> <span class="o">=</span> <span class="n">reim0</span><span class="p">;</span>
    <span class="n">buffer_dmy</span><span class="p">[(</span><span class="n">gi</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">grid</span><span class="p">]</span> <span class="o">=</span> <span class="n">reim1</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">//DFTで愚直に書いたバージョン</span>
<span class="c1">//デバッグ用、理解を深める用</span>
<span class="c1">//グループ数Nで実行されること前提</span>
<span class="p">[</span><span class="n">numthreads</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">DFT2Dfunc256inv</span><span class="p">(</span><span class="n">uint</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">,</span> <span class="n">uint</span> <span class="n">grid</span> <span class="o">:</span> <span class="n">SV_GroupID</span><span class="p">,</span> <span class="n">uint</span> <span class="n">gi</span> <span class="o">:</span> <span class="n">SV_GroupIndex</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">gi</span> <span class="o">-</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">z</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">-</span> <span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

    <span class="n">float2</span> <span class="n">dftsum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">kz</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span><span class="c1">//* (2.0f * PI / N);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">kx</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span><span class="c1">// *(2.0f * PI / N);</span>
            <span class="kt">float</span> <span class="n">rad</span> <span class="o">=</span> <span class="p">((</span><span class="n">kx</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">kz</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">N</span><span class="p">);</span>
            <span class="n">float2</span> <span class="n">h</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
            <span class="n">dftsum</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">h</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">-</span> <span class="n">h</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">);</span>
            <span class="n">dftsum</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">h</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span> <span class="o">+</span> <span class="n">h</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">rad</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">buffer_dmy</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dftsum</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>Dispatch側のコード</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">FFT.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">FFT</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">bool</span> <span class="n">DEBUG</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">ComputeShader</span> <span class="n">shader</span><span class="p">;</span>
    <span class="n">ComputeBuffer</span> <span class="n">buffer_dbg</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">kernel_FFT2Dfunc256inv</span><span class="p">,</span> <span class="n">kernel_DFT2Dfunc256inv</span><span class="p">;</span>

    <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">kernel_FFT2Dfunc256inv</span> <span class="p">=</span> <span class="n">shader</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"FFT2Dfunc256inv"</span><span class="p">);</span>
        <span class="n">kernel_DFT2Dfunc256inv</span> <span class="p">=</span> <span class="n">shader</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"DFT2Dfunc256inv"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="n">buffer_dbg</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//bufferが入力、FFTの結果がbufferに出力</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">FFT2D_256_Dispatch</span><span class="p">(</span><span class="n">ComputeBuffer</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">ComputeBuffer</span> <span class="n">buffer_dmy</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="nf">DEBUG_func1</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="c1">//①引数をセット</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernel_FFT2Dfunc256inv</span><span class="p">,</span> <span class="s">"buffer"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernel_FFT2Dfunc256inv</span><span class="p">,</span> <span class="s">"buffer_dmy"</span><span class="p">,</span> <span class="n">buffer_dmy</span><span class="p">);</span>
        <span class="c1">// GPUで計算</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernel_FFT2Dfunc256inv</span><span class="p">,</span> <span class="m">256</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>

        <span class="c1">//②引数をセット</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernel_FFT2Dfunc256inv</span><span class="p">,</span> <span class="s">"buffer"</span><span class="p">,</span> <span class="n">buffer_dmy</span><span class="p">);</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernel_FFT2Dfunc256inv</span><span class="p">,</span> <span class="s">"buffer_dmy"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
        <span class="c1">// GPUで計算</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernel_FFT2Dfunc256inv</span><span class="p">,</span> <span class="m">256</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span> <span class="nf">DEBUG_func2</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//bufferが入力、FFTの結果がbuffer_dmyに出力</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DFT2D_256_Dispatch</span><span class="p">(</span><span class="n">ComputeBuffer</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">ComputeBuffer</span> <span class="n">buffer_dmy</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//引数をセット</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernel_DFT2Dfunc256inv</span><span class="p">,</span> <span class="s">"buffer"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernel_DFT2Dfunc256inv</span><span class="p">,</span> <span class="s">"buffer_dmy"</span><span class="p">,</span> <span class="n">buffer_dmy</span><span class="p">);</span>
        <span class="c1">// GPUで計算</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernel_DFT2Dfunc256inv</span><span class="p">,</span> <span class="m">256</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
    <span class="p">}</span>



    <span class="c1">//FFTとDFTを比較</span>
    <span class="k">void</span> <span class="nf">DEBUG_func1</span><span class="p">(</span><span class="n">ComputeBuffer</span> <span class="n">buffer</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">buffer_dbg</span><span class="p">.</span><span class="n">count</span><span class="p">!=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
            <span class="n">buffer_dbg</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">2</span><span class="p">);</span>
        <span class="nf">DFT2D_256_Dispatch</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer_dbg</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//FFTとDFTを比較</span>
    <span class="k">void</span> <span class="nf">DEBUG_func2</span><span class="p">(</span><span class="n">ComputeBuffer</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Vector2</span><span class="p">[]</span> <span class="n">bfr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">[</span><span class="n">buffer</span><span class="p">.</span><span class="n">count</span><span class="p">];</span>
        <span class="n">Vector2</span><span class="p">[]</span> <span class="n">bfr_dbg</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">[</span><span class="n">buffer</span><span class="p">.</span><span class="n">count</span><span class="p">];</span>
        <span class="n">buffer</span><span class="p">.</span><span class="nf">GetData</span><span class="p">(</span><span class="n">bfr</span><span class="p">);</span>
        <span class="n">buffer_dbg</span><span class="p">.</span><span class="nf">GetData</span><span class="p">(</span><span class="n">bfr_dbg</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">rss</span> <span class="p">=</span> <span class="m">0.0f</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span><span class="n">i</span><span class="p">&lt;</span> <span class="n">buffer</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">Vector2</span> <span class="n">v2</span> <span class="p">=</span> <span class="n">bfr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">-</span> <span class="n">bfr_dbg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">rss</span> <span class="p">+=</span> <span class="n">v2</span><span class="p">.</span><span class="n">sqrMagnitude</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="n">rss</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</div>

<p>カーネルプログラムFFT2Dfunc256invはコメントにもあるよう<br>
・iFFTを普通に計算し(Cooley-Tukeyなので最後にbit逆順がある)<br>
・書き込み先indexが奇数なら-1をかけ<br>
・N/2ずらして<br>
・行列転置(縦横入れ替え)してメモリに書き込み</p>

<p>しています。<br>
文字だけだとわかりにくいのでプログラムの動作を画像化してみました。カラーが最初のメモリの位置に相当します。色味が落ちてるところは-1がかかっているという意味です。<br>
<a href="https://camo.qiitausercontent.com/d38d8ddbc94b375ef9827f9d5867ec8d644fca78/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32383935373838372d616165312d363139612d306565622d3038643032646365303431382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F28957887-aae1-619a-0eeb-08d02dce0418.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=bd96dc5dde6e47cc446285a7fed89e00" alt="kansei_syukusyou.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/28957887-aae1-619a-0eeb-08d02dce0418.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F28957887-aae1-619a-0eeb-08d02dce0418.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f3dbed06ea4252eb46525cf493e2fd3a 1x" loading="lazy"></a></p>

<p>これによって<br>
<b>・計算結果全体を(N/2,N/2)ずらす<br>
・要素のindex x,zが(x+z)%2==1となる要素に-1をかける</b><br>
が実現していることがわかります。<br>
(と、偉そうにのたまいましたが皆さんの好きなように2D逆フリーエ変換を実装すればいいと思います。)</p>

<h2>
<span id="4右の画像から実際の位置にレンダリング" class="fragment"></span><a href="#4%E5%8F%B3%E3%81%AE%E7%94%BB%E5%83%8F%E3%81%8B%E3%82%89%E5%AE%9F%E9%9A%9B%E3%81%AE%E4%BD%8D%E7%BD%AE%E3%81%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>4.右の画像から実際の位置にレンダリング</h2>

<p>いろいろ大変な実装でしたが画面に描画してうまくいったとき疲れが全部吹き飛びます！あと一歩です。<br>
すでに高さ情報はComputeBufferに格納されているので<br>
Graphics.DrawProceduralNow<br>
などで手軽に描画することができます。一番簡単なPointsの描画をしてみます。<br>
CPU側コードとShaderはこんなかんじ</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">FFTOceanMain.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">FFTOceanMain</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">ComputeShader</span> <span class="n">shader</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">Shader</span> <span class="n">renderingShader</span><span class="p">;</span>
    <span class="n">Material</span> <span class="n">renderingShader_Material</span><span class="p">;</span>

    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">FFT</span> <span class="n">fFT</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="n">Phillips</span> <span class="n">phillips</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">kernel_GenerateSpectrumKernel</span><span class="p">;</span>
    <span class="n">Vector2</span><span class="p">[]</span> <span class="n">h_h0</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">ComputeBuffer</span> <span class="n">d_h0</span><span class="p">,</span> <span class="n">d_ht</span><span class="p">,</span> <span class="n">d_ht_dmy</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">kernel_GenerateSpectrumKernel</span> <span class="p">=</span> <span class="n">shader</span><span class="p">.</span><span class="nf">FindKernel</span><span class="p">(</span><span class="s">"GenerateSpectrumKernel"</span><span class="p">);</span>
        <span class="n">renderingShader_Material</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Material</span><span class="p">(</span><span class="n">renderingShader</span><span class="p">);</span>
        <span class="n">cnt</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">h_h0</span> <span class="p">=</span> <span class="n">phillips</span><span class="p">.</span><span class="nf">Generate_h0</span><span class="p">();</span><span class="c1">//CPU側メモリ確保。サイズはsizeof(Vector2)*256*256</span>
        <span class="n">d_h0</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">h_h0</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">2</span><span class="p">);</span><span class="c1">//GPU側メモリ確保 サイズはsizeof(Vector2)*256*256</span>
        <span class="n">d_ht</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">Phillips</span><span class="p">.</span><span class="n">meshSize</span> <span class="p">*</span> <span class="n">Phillips</span><span class="p">.</span><span class="n">meshSize</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">2</span><span class="p">);</span><span class="c1">//GPU側メモリ確保 サイズはsizeof(Vector2)*256*256</span>
        <span class="n">d_ht_dmy</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ComputeBuffer</span><span class="p">(</span><span class="n">d_ht</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">*</span> <span class="m">2</span><span class="p">);</span>
        <span class="n">d_h0</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="n">h_h0</span><span class="p">);</span>
        <span class="nf">SetArgs</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">SetArgs</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//ComputeShader引数をセット</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernel_GenerateSpectrumKernel</span><span class="p">,</span> <span class="s">"h0"</span><span class="p">,</span> <span class="n">d_h0</span><span class="p">);</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="n">kernel_GenerateSpectrumKernel</span><span class="p">,</span> <span class="s">"ht"</span><span class="p">,</span> <span class="n">d_ht</span><span class="p">);</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="s">"N"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Phillips</span><span class="p">.</span><span class="n">meshSize</span><span class="p">);</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="s">"seasizeLx"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Phillips</span><span class="p">.</span><span class="n">seasizeLx</span><span class="p">);</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="s">"seasizeLz"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Phillips</span><span class="p">.</span><span class="n">seasizeLz</span><span class="p">);</span>
        <span class="c1">// GPUバッファをマテリアルに設定</span>
        <span class="n">renderingShader_Material</span><span class="p">.</span><span class="nf">SetBuffer</span><span class="p">(</span><span class="s">"d_ht"</span><span class="p">,</span> <span class="n">d_ht</span><span class="p">);</span>
        <span class="c1">// その他Shader 定数関連</span>
        <span class="n">renderingShader_Material</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="s">"N"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Phillips</span><span class="p">.</span><span class="n">meshSize</span><span class="p">);</span>
        <span class="n">renderingShader_Material</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"halfN"</span><span class="p">,</span> <span class="m">0.5f</span> <span class="p">*</span> <span class="n">Phillips</span><span class="p">.</span><span class="n">meshSize</span><span class="p">);</span>
        <span class="n">renderingShader_Material</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"dx"</span><span class="p">,</span> <span class="m">1.0f</span> <span class="p">*</span> <span class="n">Phillips</span><span class="p">.</span><span class="n">seasizeLx</span> <span class="p">/</span> <span class="n">Phillips</span><span class="p">.</span><span class="n">meshSize</span><span class="p">);</span>
        <span class="n">renderingShader_Material</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"dz"</span><span class="p">,</span> <span class="m">1.0f</span> <span class="p">*</span> <span class="n">Phillips</span><span class="p">.</span><span class="n">seasizeLz</span> <span class="p">/</span> <span class="n">Phillips</span><span class="p">.</span><span class="n">meshSize</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//引数をセット</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="s">"t"</span><span class="p">,</span> <span class="m">0.03f</span> <span class="p">*</span> <span class="n">cnt</span><span class="p">);</span>
        <span class="n">shader</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="n">kernel_GenerateSpectrumKernel</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">256</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span><span class="c1">//d_h0からd_htを計算</span>
        <span class="n">fFT</span><span class="p">.</span><span class="nf">FFT2D_256_Dispatch</span><span class="p">(</span><span class="n">d_ht</span><span class="p">,</span> <span class="n">d_ht_dmy</span><span class="p">);</span><span class="c1">//d_htから高さデータを計算</span>
        <span class="n">cnt</span><span class="p">++;</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">OnRenderObject</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// レンダリングを開始</span>
        <span class="n">renderingShader_Material</span><span class="p">.</span><span class="nf">SetPass</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
        <span class="c1">// n個のオブジェクトをレンダリング</span>
        <span class="n">Graphics</span><span class="p">.</span><span class="nf">DrawProceduralNow</span><span class="p">(</span><span class="n">MeshTopology</span><span class="p">.</span><span class="n">Points</span><span class="p">,</span> <span class="m">256</span> <span class="p">*</span> <span class="m">256</span><span class="p">);</span>   
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//解放</span>
        <span class="n">d_h0</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
        <span class="n">d_ht</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
        <span class="n">d_ht_dmy</span><span class="p">.</span><span class="nf">Release</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">SurfaceShader.shader</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">Shader</span> <span class="s">"Custom/SurfaceShader"</span> <span class="p">{</span>
    <span class="n">SubShader</span><span class="p">{</span>

        <span class="n">Pass</span> <span class="p">{</span>
            <span class="n">CGPROGRAM</span>
            <span class="c1">// シェーダーモデルは5.0を指定</span>
            <span class="cp">#pragma target 5.0
</span>            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="cp">#include "UnityCG.cginc"
</span>
    <span class="n">StructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">d_ht</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">N</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">halfN</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">dx</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">dz</span><span class="p">;</span>

    <span class="n">float4</span> <span class="n">ui_calcPos</span><span class="p">(</span><span class="n">uint</span> <span class="n">ui_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">uint</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ui_idx</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
        <span class="n">uint</span> <span class="n">z</span> <span class="o">=</span> <span class="n">ui_idx</span> <span class="o">/</span> <span class="n">N</span><span class="p">;</span>
        <span class="n">float2</span> <span class="n">h</span> <span class="o">=</span> <span class="n">d_ht</span><span class="p">[</span><span class="n">ui_idx</span><span class="p">];</span>
        <span class="k">return</span> <span class="n">float4</span><span class="p">((</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">halfN</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">,</span> <span class="n">h</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="n">halfN</span><span class="p">)</span> <span class="o">*</span> <span class="n">dz</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">VSOut</span> <span class="p">{</span>
        <span class="n">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">// 頂点シェーダ</span>
    <span class="n">VSOut</span> <span class="n">vert</span><span class="p">(</span><span class="n">uint</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_VertexID</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">VSOut</span> <span class="n">output</span><span class="p">;</span>
        <span class="n">output</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">ui_calcPos</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
        <span class="n">output</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_VP</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ピクセルシェーダー</span>
    <span class="n">fixed4</span> <span class="n">frag</span><span class="p">(</span><span class="n">VSOut</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">COLOR</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">float4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ENDCG</span>
 <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="実行結果" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>実行結果</h3>

<p><a href="https://camo.qiitausercontent.com/513d97a241919ff1a36d133d3dddcdf9964d8190/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f36363932616336652d353062612d666635652d386564332d3530633536366464636638352e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3db1af5c549408c40b0c5ca4c5b92618" alt="ezgif-4-f4ec4a5a133b.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=dd4aabb5d608b40bbaeecf31c0d7990a 1x" loading="lazy"></a><br>
これだけでも十分綺麗ですね～！<br>
ここまでのコードは<br>
github<br>
<a href="https://github.com/toropippi/OceanFFT/tree/main/OceanFFT1_points" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/toropippi/OceanFFT/tree/main/OceanFFT1_points</a><br>
にUPしてます。</p>

<h2>
<span id="法線を計算" class="fragment"></span><a href="#%E6%B3%95%E7%B7%9A%E3%82%92%E8%A8%88%E7%AE%97"><i class="fa fa-link"></i></a>法線を計算</h2>

<p>さてせっかく綺麗な絵が出そうな雰囲気なので法線も計算してみましょう。</p>

<h3>
<span id="中心差分で算出" class="fragment"></span><a href="#%E4%B8%AD%E5%BF%83%E5%B7%AE%E5%88%86%E3%81%A7%E7%AE%97%E5%87%BA"><i class="fa fa-link"></i></a>中心差分で算出</h3>

<p>お手軽な方法として、すでに計算してある海面の高さを利用して中心差分で勾配を計算します。<del>だんだん<a href="https://qiita.com/advent-calendar/2020/numerical_analysis">数値計算 Advent Calendar</a>みが増してきました</del><br>
x,z方向の勾配が求まれば、海面と垂直なベクトルがでます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\vec{N}=normalize(-xの傾き,1,-zの傾き)
</code></pre></div></div>

<p>この計算のところだけピックアップします。雰囲気だけでもわかってもらえれば幸いです。</p>

<div class="code-frame" data-lang="c"><div class="highlight"><pre class="with-code"><code>    <span class="n">uint</span> <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">y0</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">subx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="n">x1</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">ht</span><span class="p">[</span><span class="n">x0</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">rdx</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">subz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">ht</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">ht</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">rdz</span><span class="p">;</span>
    <span class="n">float3</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="o">-</span><span class="n">subx</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">subz</span><span class="p">));</span>
    <span class="n">float4</span> <span class="n">out4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">out4</span><span class="p">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">vec</span><span class="p">;</span>
    <span class="n">tex</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">out4</span><span class="p">;</span>
</code></pre></div></div>

<p>法線ベクトル情報x,y,zをr,g,bで出力<br>
<a href="https://camo.qiitausercontent.com/415ba5fecd0329e626139a19be34327bea52b61d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f62306434313162312d303336352d393032652d373862342d3033326465643265353665332e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fb0d411b1-0365-902e-78b4-032ded2e56e3.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b866b103b436f4ca3482b7d4ab3cbcb4" alt="xyzrgb_normal.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/b0d411b1-0365-902e-78b4-032ded2e56e3.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fb0d411b1-0365-902e-78b4-032ded2e56e3.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4bb6c59c40e7866106a2c02600ae0f10 1x" loading="lazy"></a><br>
できました。あとは煮るなり焼くなり法線情報でうまくライティングすればきれいな絵ができるでしょう。</p>

<p>github<br>
<a href="https://github.com/toropippi/OceanFFT/tree/main/OceanFFT2_normal" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/toropippi/OceanFFT/tree/main/OceanFFT2_normal</a></p>

<p>念のためですが、法線が本当に正しいか、Aを100倍にして出力してみました。<br>
<a href="https://camo.qiitausercontent.com/7905225e9cb0a6d35d7945d858b74ac02f3969f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f33393831356362372d643139322d346266372d313339642d3862343761303765373835322e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F39815cb7-d192-4bf7-139d-8b47a07e7852.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=eacb8022a48d88e0b3cb22e2917ce7b8" alt="kensyou.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/39815cb7-d192-4bf7-139d-8b47a07e7852.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F39815cb7-d192-4bf7-139d-8b47a07e7852.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=277b3118796ab0908dc88e783b7e050c 1x" loading="lazy"></a><br>
x方向に向いている面は赤く、z方向に向いている面は青くなっています。面の法線ベクトルのx,z成分がr,bに対応しているので正しそうです。</p>

<h3>
<span id="偏微分で解析的に算出" class="fragment"></span><a href="#%E5%81%8F%E5%BE%AE%E5%88%86%E3%81%A7%E8%A7%A3%E6%9E%90%E7%9A%84%E3%81%AB%E7%AE%97%E5%87%BA"><i class="fa fa-link"></i></a>偏微分で解析的に算出</h3>

<p>ところでせっかく難しい式を計算をしてスペクトルを出してきたので、法線も式から求められないでしょうか。<br>
これも結論から言うとできます。<br>
これで偏微分が計算できます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\nabla h(\vec{x},t)=\sum_{\vec{k}}i\vec{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot \vec{x}}
</code></pre></div></div>

<p>$\tilde{h}(\vec{k},t)$は「2.それをベースに毎フレームh(k,t)をGPU上で生成」で求めたやつです。これに$i\vec{k}$がかかっていますが、各要素の計算時に求めていた$kx,kz$を使うだけです。<br>
x方向の偏微分ならkxをz方向の偏微分ならkzのみを使います。</p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">例</span></div>
<div class="highlight"><pre class="with-code"><code><span class="p">...............................</span>
<span class="p">[</span><span class="n">numthreads</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">GenerateSpectrumKernel</span><span class="p">(</span><span class="n">uint2</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">x</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">y</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">in_index</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">in_mindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span> <span class="c1">// mirrored</span>
    <span class="n">uint</span> <span class="n">out_index</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
    <span class="c1">// calculate wave vector</span>
    <span class="n">float2</span> <span class="n">k</span><span class="p">;</span>
    <span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">seasizeLx</span><span class="p">);</span>
    <span class="n">k</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">seasizeLz</span><span class="p">);</span>
    <span class="c1">// calculate dispersion w(k)</span>
    <span class="kt">float</span> <span class="n">k_len</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">k</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">w</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">9</span><span class="p">.</span><span class="mi">81</span><span class="n">f</span> <span class="o">*</span> <span class="n">k_len</span><span class="p">);</span>

    <span class="n">float2</span> <span class="n">h0_k</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="n">in_index</span><span class="p">];</span>
    <span class="n">float2</span> <span class="n">h0_mk</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="n">in_mindex</span><span class="p">];</span>
    <span class="c1">// output frequency-space complex values</span>
    <span class="n">float2</span> <span class="n">htval</span> <span class="o">=</span> <span class="n">complex_add</span><span class="p">(</span><span class="n">complex_mult</span><span class="p">(</span><span class="n">h0_k</span><span class="p">,</span> <span class="n">complex_exp</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">t</span><span class="p">)),</span> <span class="n">complex_mult</span><span class="p">(</span><span class="n">conjugate</span><span class="p">(</span><span class="n">h0_mk</span><span class="p">),</span> <span class="n">complex_exp</span><span class="p">(</span><span class="o">-</span><span class="n">w</span> <span class="o">*</span> <span class="n">t</span><span class="p">)));</span>
    <span class="n">ht</span><span class="p">[</span><span class="n">out_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">htval</span><span class="p">;</span><span class="c1">//普通の高さの逆フーリエ前</span>

    <span class="n">float2</span> <span class="n">htival</span><span class="p">;</span><span class="c1">//i*htval</span>
    <span class="n">htival</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">htval</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">htival</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">htval</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">ht_dx</span><span class="p">[</span><span class="n">out_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">htival</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="c1">//x方向偏微分の逆フーリエ前</span>
    <span class="n">ht_dz</span><span class="p">[</span><span class="n">out_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">htival</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">y</span><span class="p">;</span> <span class="c1">//z方向偏微分の逆フーリエ前</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>そしてそれを逆フーリエ変換することで海面の高さの勾配(偏微分)が求まります。ここで、手元には複素数の状態で結果があると思いますが、使うのは実数成分のみです。海面の高さには実数のみを使用しているので勾配情報も実数のみを使う必要があります。<br>
あとはさっきと同じように法線を計算し</p>

<p><a href="https://camo.qiitausercontent.com/b3de66c7e6292fec050a9a05187d85c6caadb7c5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f30386638396562392d643133312d333164352d663030312d3766656463306331303131312e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F08f89eb9-d131-31d5-f001-7fedc0c10111.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e025dfa7d73f3830134eb2c980768069" alt="henbibun.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/08f89eb9-d131-31d5-f001-7fedc0c10111.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F08f89eb9-d131-31d5-f001-7fedc0c10111.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a5712c36154a8463574343498a357bcb 1x" loading="lazy"></a></p>

<p>できました。<br>
さっきと見た目かわんないですが、中心差分よりは精度よくできてると思います。<br>
これもgithubにupしてるので参考にしてください。<br>
github<br>
<a href="https://github.com/toropippi/OceanFFT/tree/main/OceanFFT3_analyticalNormal" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/toropippi/OceanFFT/tree/main/OceanFFT3_analyticalNormal</a></p>

<h3>
<span id="もうちょっとライティングを頑張る" class="fragment"></span><a href="#%E3%82%82%E3%81%86%E3%81%A1%E3%82%87%E3%81%A3%E3%81%A8%E3%83%A9%E3%82%A4%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E9%A0%91%E5%BC%B5%E3%82%8B"><i class="fa fa-link"></i></a>もうちょっとライティングを頑張る</h3>

<p>正直Compute Shader以外のシェーダーやレンダリングは詳しくないのでたいしたことは書けません。<br>
一応、法線から反射ベクトルを計算してフレネル反射とか実装したりしなかったり・・・<br>
コードを見ればわかりますが視線ベクトル決め打ちのレイトレーシングみたいなことをしています、、、だからカメラ動かしても絵は変わらないというひどいコード。誰かレンダリング教えて・・・</p>

<p><a href="https://camo.qiitausercontent.com/172c65767fe05378f348d124327971a9aad56470/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32633933353731392d373663322d386634332d386638302d3732376338363661623932622e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2c935719-76c2-8f43-8f80-727c866ab92b.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=316347e48839ff248288289caa15c851" alt="out_20201207_033459.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/2c935719-76c2-8f43-8f80-727c866ab92b.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2c935719-76c2-8f43-8f80-727c866ab92b.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=753980be0fcd282a03f60328a935c84a 1x" loading="lazy"></a><br>
github<br>
<a href="https://github.com/toropippi/OceanFFT/tree/main/OceanFFT4lighting" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/toropippi/OceanFFT/tree/main/OceanFFT4lighting</a></p>

<p>まぁかつてないほど海っぽくなったのでいいでしょう。</p>

<h2>
<span id="choppy-wave" class="fragment"></span><a href="#choppy-wave"><i class="fa fa-link"></i></a>Choppy wave</h2>

<p>NVIDIAのスライドを見るに、さっきの偏微分にすごい似た、でもちょっと違う式で計算されたDx,Dyというのを求めています。これは法線を計算するためのものではなく、波をより尖らせたChoppy waveを作るために必要なようです。<br>
<a href="https://camo.qiitausercontent.com/56ae0bc43f3f93b5c41907c477e631bb3f35872d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32626231633531632d336664342d396461652d373733312d6365393138363638323666642e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2bb1c51c-3fd4-9dae-7731-ce91866826fd.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=83b8a88208c8b79649738adfe0aa83e2" alt="nvslide2.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/2bb1c51c-3fd4-9dae-7731-ce91866826fd.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2bb1c51c-3fd4-9dae-7731-ce91866826fd.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=05f460383bc40b91c874bcc3ce7bf514 1x" loading="lazy"></a></p>

<p>今までの波はあくまで有限個のsin,cosの足し合わせでできた波で、ちょっと滑らかになりすぎてるという問題があったようです。それをアーティスティックな謎テクで解決するのが今から説明する方法です。</p>

<p>いや滑らかすぎるならもっと離散点を増やして細かいsin,cosを足し合わせばいいじゃないかと個人的には思いましたが、そう書いてあるので仕方ありません。<br>
まぁおそらく離散点を増やすと計算負荷が上がるからダメなんでしょうね。</p>

<p>Choppy waveの計算手順はというと、まずDx,Dyを計算します。数式では $\vec{D}$ と書いてあります。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\vec{D}(\vec{x},t)=\sum_{\vec{k}}-i\frac{\vec{k}}{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot \vec{x}}\\
\vec{x}'=\vec{x}+\lambda \vec{D}(\vec{x},t)
</code></pre></div></div>

<p>そしてこの$\vec{x}'$を新しい座標として使います。</p>

<p>今まで$\vec{x}=(x,z)$としてx,z座標は固定でやってきてましたよね。でy座標だけが動いていたと。</p>

<p>今度は$\lambda$に2.0とか-3.4とか適当な値をいれることでx,zもリアルタイムに動いて、見た目が激しくなるというイメージです。</p>

<p><a href="https://camo.qiitausercontent.com/231dd0646ea6dd2dfbf6205426652103aba3a593/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32386636653938612d396431322d303731372d383031352d6431353762383536306238392e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F28f6e98a-9d12-0717-8015-d157b8560b89.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ab0bad4e45175a20cde9a4ed35605589" alt="ezgif-3-1ac62bac3f22.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/28f6e98a-9d12-0717-8015-d157b8560b89.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F28f6e98a-9d12-0717-8015-d157b8560b89.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=94b4563750ca98796d146056a73cb6a5 1x" loading="lazy"></a><br>
今までと違い、x,z方向にもうねうねしていますね。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\vec{D}(\vec{x},t)=\sum_{\vec{k}}-i\frac{\vec{k}}{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot \vec{x}}\\
</code></pre></div></div>

<p>の求め方ですが、偏微分を求めるときに書いたコードにちょっと付け足すだけです。</p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">GenerateSpectrum.compute</span></div>
<div class="highlight"><pre class="with-code"><code><span class="p">..................</span>
<span class="p">[</span><span class="n">numthreads</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">GenerateSpectrumKernel</span><span class="p">(</span><span class="n">uint2</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">x</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">y</span> <span class="o">=</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">in_index</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">in_mindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span> <span class="c1">// mirrored</span>
    <span class="n">uint</span> <span class="n">out_index</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
    <span class="c1">// calculate wave vector</span>
    <span class="n">float2</span> <span class="n">k</span><span class="p">;</span>
    <span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">seasizeLx</span><span class="p">);</span>
    <span class="n">k</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">N</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">/</span> <span class="n">seasizeLz</span><span class="p">);</span>
    <span class="c1">// calculate dispersion w(k)</span>
    <span class="kt">float</span> <span class="n">k_len</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">k</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">w</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">9</span><span class="p">.</span><span class="mi">81</span><span class="n">f</span> <span class="o">*</span> <span class="n">k_len</span><span class="p">);</span>

    <span class="n">float2</span> <span class="n">h0_k</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="n">in_index</span><span class="p">];</span>
    <span class="n">float2</span> <span class="n">h0_mk</span> <span class="o">=</span> <span class="n">h0</span><span class="p">[</span><span class="n">in_mindex</span><span class="p">];</span>
    <span class="c1">// output frequency-space complex values</span>
    <span class="n">float2</span> <span class="n">htval</span> <span class="o">=</span> <span class="n">complex_add</span><span class="p">(</span><span class="n">complex_mult</span><span class="p">(</span><span class="n">h0_k</span><span class="p">,</span> <span class="n">complex_exp</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">t</span><span class="p">)),</span> <span class="n">complex_mult</span><span class="p">(</span><span class="n">conjugate</span><span class="p">(</span><span class="n">h0_mk</span><span class="p">),</span> <span class="n">complex_exp</span><span class="p">(</span><span class="o">-</span><span class="n">w</span> <span class="o">*</span> <span class="n">t</span><span class="p">)));</span>
    <span class="n">ht</span><span class="p">[</span><span class="n">out_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">htval</span><span class="p">;</span><span class="c1">//普通の高さの逆フーリエ前</span>

    <span class="n">float2</span> <span class="n">htival</span><span class="p">;</span><span class="c1">//i*htval</span>
    <span class="n">htival</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">htval</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">htival</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">htval</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">ht_dx</span><span class="p">[</span><span class="n">out_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">htival</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="c1">//x方向偏微分の逆フーリエ前</span>
    <span class="n">ht_dz</span><span class="p">[</span><span class="n">out_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">htival</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">y</span><span class="p">;</span> <span class="c1">//z方向偏微分の逆フーリエ前</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">k_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">k</span><span class="p">.</span><span class="n">x</span> <span class="o">/=</span> <span class="n">k_len</span><span class="p">;</span>
        <span class="n">k</span><span class="p">.</span><span class="n">y</span> <span class="o">/=</span> <span class="n">k_len</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">displaceX</span><span class="p">[</span><span class="n">out_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">htival</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="c1">//Dxの逆フーリエ前</span>
    <span class="n">displaceZ</span><span class="p">[</span><span class="n">out_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">htival</span> <span class="o">*</span> <span class="n">k</span><span class="p">.</span><span class="n">y</span><span class="p">;</span> <span class="c1">//Dyの逆フーリエ前</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>これで</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>-i\frac{\vec{k}}{k}\tilde{h}(\vec{k},t)
</code></pre></div></div>

<p>の部分まで求まったので、あとは3の手順でiFFTして完成です。</p>

<h3>
<span id="数式のお気持ちを考える" class="fragment"></span><a href="#%E6%95%B0%E5%BC%8F%E3%81%AE%E3%81%8A%E6%B0%97%E6%8C%81%E3%81%A1%E3%82%92%E8%80%83%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>数式のお気持ちを考える</h3>

<p>これで新しい座標$\vec{x}'$を求めることができましたが、これがどんな意味があるのか少し考えてみましょう。<br>
上でも書いたよう、$\vec{D}(\vec{x},t)$の式は偏微分の式に酷似しています。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\nabla h(\vec{x},t)=\sum_{\vec{k}}i\vec{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot \vec{x}}\\
\vec{D}(\vec{x},t)=\sum_{\vec{k}}-i\frac{\vec{k}}{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot \vec{x}}\\
</code></pre></div></div>

<p>違うのはマイナスがかかっていることと、ベクトルの長さkで割っているところです。<br>
kで割っても正負は反転しないのでここはざっくり"(偏微分×-1)に近い値"として思考を進めてみます。</p>

<p>簡単に1次元として、x座標を移動させるということは、こんな形の波があったときに青丸が矢印の方向に移動することが想像できます。<br>
<a href="https://camo.qiitausercontent.com/9bd3dd16967bcfb8b7674179bec8db4448c4c297/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f63663734313033622d633564302d613636652d653063322d3839396364656439613333372e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcf74103b-c5d0-a66e-e0c2-899cded9a337.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d88e16dd26e2efbf9a26d70dd0438876" alt="Figure_2.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/cf74103b-c5d0-a66e-e0c2-899cded9a337.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcf74103b-c5d0-a66e-e0c2-899cded9a337.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1a4245be869f3473c198660ef3dccd69 1x" loading="lazy"></a></p>

<p>ということは移動後は</p>

<p><a href="https://camo.qiitausercontent.com/ef2a82db6c30ad38ec4c7280c4cd9528610a86c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f33303935396130392d383039612d376564352d353135632d6537626437363235643931632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F30959a09-809a-7ed5-515c-e7bd7625d91c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=63797617c17d3a822b258e0782b9a9b9" alt="Figure_3.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/30959a09-809a-7ed5-515c-e7bd7625d91c.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F30959a09-809a-7ed5-515c-e7bd7625d91c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d1684b828941e8abfc5718c9ecd2fdcb 1x" loading="lazy"></a><br>
となります。あれ、波が尖がるどころかなだらかになってるじゃないか・・・</p>

<p>次sinカーブでも同じように考えてみます。<br>
<a href="https://camo.qiitausercontent.com/5f8c92a7663059166b7c53b8139fea533c292be5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f66346566373531662d626338642d633832622d326561312d6634353534343463393936372e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Ff4ef751f-bc8d-c82b-2ea1-f455444c9967.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c5018adaf01b12cfeeb70aff4a51aa13" alt="Figure_4.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/f4ef751f-bc8d-c82b-2ea1-f455444c9967.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Ff4ef751f-bc8d-c82b-2ea1-f455444c9967.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1ce7a012a996c482c1d9d01c98abf7c4 1x" loading="lazy"></a><br>
これが$\lambda=1$のとき<br>
<a href="https://camo.qiitausercontent.com/4e689c7e7b530cd9e6f1de35a44fa08dd6079ff9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f30373063353264662d386438342d623436662d333962652d3130653338316334393562322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F070c52df-8d84-b46f-39be-10e381c495b2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c443c62f9626c9d5000271e06ca90850" alt="Figure_5.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/070c52df-8d84-b46f-39be-10e381c495b2.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F070c52df-8d84-b46f-39be-10e381c495b2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=aa2216c17b94bb9d5de15c9990d3ef11 1x" loading="lazy"></a><br>
やっぱりなだらかになってる。</p>

<p>じゃあ$\lambda=-1$にしたらどうだろう・・・<br>
<a href="https://camo.qiitausercontent.com/c008899c50a4e5644177d4d94b3a22c1f318526a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f36316564616563642d653731652d656362362d343865642d3332343639363037356539342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F61edaecd-e71e-ecb6-48ed-324696075e94.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c69112a771aaaada783c9aadb33b3955" alt="Figure_6.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/61edaecd-e71e-ecb6-48ed-324696075e94.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F61edaecd-e71e-ecb6-48ed-324696075e94.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f5816572d6e52f4b1bba131c35c7948c 1x" loading="lazy"></a></p>

<p>これが正解では？？？</p>

<h3>
<span id="λをいじって最適なchoppy-waveを作る" class="fragment"></span><a href="#%CE%BB%E3%82%92%E3%81%84%E3%81%98%E3%81%A3%E3%81%A6%E6%9C%80%E9%81%A9%E3%81%AAchoppy-wave%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>λをいじって最適なChoppy waveを作る</h3>

<p>実は論文にもほかの参考になりそうなサイトにも、λの決め方についてほとんどなにも書かれていません。まぁ適当にいじって決めてねってことなんだと思いますが、数式のお気持ちを察するに、これはマイナスの値を入れないといけないのではないでしょうか。</p>

<p>実際にやってみました。</p>

<h4>
<span id="λ00のとき" class="fragment"></span><a href="#%CE%BB00%E3%81%AE%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>λ=0.0のとき</h4>

<p>まずはコントロール<br>
<a href="https://camo.qiitausercontent.com/8b10eeb38e7db99119314b9a509c92c75a61aacb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f61383331633766382d333533372d346334332d346135372d6465613264633637623863622e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fa831c7f8-3537-4c43-4a57-dea2dc67b8cb.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=84fb684602b168afca8a532dd9f42787" alt="l0.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/a831c7f8-3537-4c43-4a57-dea2dc67b8cb.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fa831c7f8-3537-4c43-4a57-dea2dc67b8cb.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3f8ff74fedd01324aedcac1f1b5cf79b 1x" loading="lazy"></a></p>

<h4>
<span id="λ20のとき" class="fragment"></span><a href="#%CE%BB20%E3%81%AE%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>λ=2.0のとき</h4>

<p><a href="https://camo.qiitausercontent.com/1d38e71b0a3ba67a1059709e16c7cd010a6bc91c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f35356638373866652d643433332d663963382d666236362d3937393535653430633433622e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F55f878fe-d433-f9c8-fb66-97955e40c43b.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9402c548863258b53fb1306aad55e373" alt="l2.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/55f878fe-d433-f9c8-fb66-97955e40c43b.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F55f878fe-d433-f9c8-fb66-97955e40c43b.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3941f729530a9f6949aeecce0fe3c1d8 1x" loading="lazy"></a><br>
表面が丸くなってる？</p>

<h4>
<span id="λ-20のとき" class="fragment"></span><a href="#%CE%BB-20%E3%81%AE%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>λ=-2.0のとき</h4>

<p><a href="https://camo.qiitausercontent.com/3b69ca2a52e50494e72260fadaa4e8f52f64b1dc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32616334356134352d383163622d643639652d623235322d3330613533353430656632372e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2ac45a45-81cb-d69e-b252-30a53540ef27.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=abda0024af7b5df6658ad81daf2a57b0" alt="lm2.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/2ac45a45-81cb-d69e-b252-30a53540ef27.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2ac45a45-81cb-d69e-b252-30a53540ef27.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b0c3f436f2c18619cb8bafe78c891463 1x" loading="lazy"></a><br>
これだよこれ！</p>

<h4>
<span id="λ90のとき" class="fragment"></span><a href="#%CE%BB90%E3%81%AE%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>λ=9.0のとき</h4>

<p><a href="https://camo.qiitausercontent.com/c1724e3e26a9541bd46629781c24d1bcd13d9364/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f62666161373436332d396235342d366332642d363263642d3165316237303339613165332e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fbfaa7463-9b54-6c2d-62cd-1e1b7039a1e3.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=63ce32143b0329344c8d52468a5137e5" alt="l9.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/bfaa7463-9b54-6c2d-62cd-1e1b7039a1e3.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fbfaa7463-9b54-6c2d-62cd-1e1b7039a1e3.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6189788aa95c9f115a441ce29401215a 1x" loading="lazy"></a><br>
これはなんですか？</p>

<h4>
<span id="λ-90のとき" class="fragment"></span><a href="#%CE%BB-90%E3%81%AE%E3%81%A8%E3%81%8D"><i class="fa fa-link"></i></a>λ=-9.0のとき</h4>

<p><a href="https://camo.qiitausercontent.com/0f6ea8d398c796e16dcf8f30adac751eac138ff2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f30366264643464312d393936642d353464642d663035612d6439666632373562656239612e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F06bdd4d1-996d-54dd-f05a-d9ff275beb9a.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5cf9ebcb76dbc446f561d9672d6bffdd" alt="lm9.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/06bdd4d1-996d-54dd-f05a-d9ff275beb9a.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F06bdd4d1-996d-54dd-f05a-d9ff275beb9a.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6cba165188a79834c9ae211e6419d137 1x" loading="lazy"></a><br>
何事もやりすぎはよくないということですね</p>

<h4>
<span id="やっぱり" class="fragment"></span><a href="#%E3%82%84%E3%81%A3%E3%81%B1%E3%82%8A"><i class="fa fa-link"></i></a>やっぱり</h4>

<p>λはマイナスの数字を入れることで波を尖がらせることができ、プラスの値をいれると滑らかにすることができます。と私は理解しています。</p>

<h3>
<span id="法線を修正" class="fragment"></span><a href="#%E6%B3%95%E7%B7%9A%E3%82%92%E4%BF%AE%E6%AD%A3"><i class="fa fa-link"></i></a>法線を修正</h3>

<p>さて、x,zの位置がずれたことで海面の傾きが変わったので法線も今までの値を使うことはできません。</p>

<p>今のところchoppy waveを実装して海面の法線をまじめに計算しているコードは中国語の <a href="https://zhuanlan.zhihu.com/p/96811613" class="autolink" rel="nofollow noopener" target="_blank">https://zhuanlan.zhihu.com/p/96811613</a> ここで紹介されてる <a href="https://github.com/Straw1997/FFTOcean" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Straw1997/FFTOcean</a> にupされてるコードしか確認できませんでした (探せばほかにもあるかもしれませんが)。</p>

<p>この方のコードをみると、x,z座標を動かあした後 中心差分で求めているようでした。しかしそもそも海面の高さをhtの実数じゃなくて複素数の絶対値で求めていたり、ちょっと私のやり方とは違うので参考にはできませんでした。</p>

<p>そこで私オリジナルのやり方になりますが、下記のような方法で実装してみました。</p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">SetNormal.compute</span></div>
<div class="highlight"><pre class="with-code"><code><span class="cp">#pragma kernel SetNormal
</span><span class="n">RWTexture2D</span><span class="o">&lt;</span><span class="n">float4</span><span class="o">&gt;</span> <span class="n">tex</span><span class="p">;</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">ht_dx</span><span class="p">;</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">ht_dz</span><span class="p">;</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">displaceX</span><span class="p">;</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">displaceZ</span><span class="p">;</span>
<span class="n">uint</span> <span class="n">N</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">dx</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">dz</span><span class="p">;</span>

<span class="kt">float</span> <span class="n">lambda</span><span class="p">;</span>
<span class="p">[</span><span class="n">numthreads</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">SetNormal</span><span class="p">(</span><span class="n">uint2</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">y0</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>

    <span class="kt">float</span> <span class="n">subx</span> <span class="o">=</span> <span class="n">ht_dx</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">subz</span> <span class="o">=</span> <span class="n">ht_dz</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
    <span class="c1">//displaceXZだけ定義点が移動することを考えここで傾きをさらにいじる</span>
    <span class="n">subx</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="p">((</span><span class="n">displaceX</span><span class="p">[</span><span class="n">x1</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">displaceX</span><span class="p">[</span><span class="n">x0</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">lambda</span> <span class="o">+</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="n">dx</span><span class="p">);</span>
    <span class="n">subz</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="p">((</span><span class="n">displaceZ</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">displaceZ</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">lambda</span> <span class="o">+</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="n">dz</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="o">-</span><span class="n">subx</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">subz</span><span class="p">));</span>
    <span class="n">float4</span> <span class="n">out4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">out4</span><span class="p">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">vec</span><span class="p">;</span>
    <span class="n">tex</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">out4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>考え方としてはこんな感じ。解説図では$\lambda=1$として省略してます。<br>
<a href="https://camo.qiitausercontent.com/804da318b48084920411238719aba0d25ae8f61d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f30373433623430622d663131342d626538332d646265302d6635356139643533623730332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F0743b40b-f114-be83-dbe0-f55a9d53b703.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=925ed04198023dd399d6943782581550" alt="Figure_7.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/0743b40b-f114-be83-dbe0-f55a9d53b703.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F0743b40b-f114-be83-dbe0-f55a9d53b703.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=48f5ed0d30a72916198e1d25d0fe4011 1x" loading="lazy"></a><br>
displaceXの分だけ点が動いて線の傾きかたが圧縮、拡張されるというイメージです。</p>

<p>これらを適応して$\lambda=-2$としたコードがこちら。</p>

<p>github<br>
<a href="https://github.com/toropippi/OceanFFT/tree/main/OceanFFT5ChoppyWave" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/toropippi/OceanFFT/tree/main/OceanFFT5ChoppyWave</a></p>

<p>ちなみに見た目はほとんど変わりませんでした。<br>
<a href="https://camo.qiitausercontent.com/290541c30097619210b5b1d36bb5988052cc6e88/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f37643761303863352d616566312d353634622d373861382d6135313065646530663263612e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F7d7a08c5-aef1-564b-78a8-a510ede0f2ca.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=39853b0da7448c6687896d4b2f41faac" alt="ezgif-4-0622a24ac01b.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/7d7a08c5-aef1-564b-78a8-a510ede0f2ca.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F7d7a08c5-aef1-564b-78a8-a510ede0f2ca.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ada607f81def9e966930ab951b8c2dbb 1x" loading="lazy"></a></p>

<p>ま、十分綺麗なのでいいでしょう。</p>

<p>ここで、波のポリゴンが交差してるのが見えるでしょうか。画面左と、左奥の2か所です。これがchoppy waveの恩恵で、今回の実装で相当リアルになってきたのがわかると思います。<br>
実際自分も実装していて、この絵が作れた時はかなりテンションあがりました。それまでは確かにのぺっとしていて、ちょっとおかしいなって感じはありました。<br>
ここまでくるとFFT Oceanの実装で一番重要なのってここなんじゃ・・・？とすら思います。</p>

<h2>
<span id="泡表現bubbles" class="fragment"></span><a href="#%E6%B3%A1%E8%A1%A8%E7%8F%BEbubbles"><i class="fa fa-link"></i></a>泡表現(bubbles)</h2>

<p>さっき波ポリゴンが重なるといいましたが、今度はこの重なりを検出して泡を表現しようという話です。</p>

<p>この検出にも$\vec{D}(\vec{x},t)$を使います。(プログラムでいうとdisplaceX,displaceZ)</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>J=J_{xx}J_{zz}-J_{xz}J_{zx}\\
J_{xx}=1+\lambda\frac{\partial D_x(\vec{x},t)}{\partial x}\\
J_{zz}=1+\lambda\frac{\partial D_z(\vec{x},t)}{\partial z}\\
J_{xz}=\lambda\frac{\partial D_x(\vec{x},t)}{\partial z}\\
J_{zx}=\lambda\frac{\partial D_z(\vec{x},t)}{\partial x}\\
</code></pre></div></div>

<p>このJの正負がマイナスのとき、その場所で重なり(反転)が起きていることになります。<br>
したがってこんなコードになります。</p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">SetNormal.compute</span></div>
<div class="highlight"><pre class="with-code"><code><span class="cp">#pragma kernel SetNormalBubble
</span><span class="n">RWTexture2D</span><span class="o">&lt;</span><span class="n">float4</span><span class="o">&gt;</span> <span class="n">normalTex</span><span class="p">;</span>
<span class="n">RWTexture2D</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">bubbleTex</span><span class="p">;</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">ht_dx</span><span class="p">;</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">ht_dz</span><span class="p">;</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">displaceX</span><span class="p">;</span>
<span class="n">RWStructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">displaceZ</span><span class="p">;</span>
<span class="n">uint</span> <span class="n">N</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">dx</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">dz</span><span class="p">;</span>

<span class="kt">float</span> <span class="n">lambda</span><span class="p">;</span>
<span class="p">[</span><span class="n">numthreads</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="kt">void</span> <span class="nf">SetNormalBubble</span><span class="p">(</span><span class="n">uint2</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_DispatchThreadID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint</span> <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">y0</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">dDxdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">displaceX</span><span class="p">[</span><span class="n">x1</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">displaceX</span><span class="p">[</span><span class="n">x0</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">);</span><span class="c1">//中心差分</span>
    <span class="kt">float</span> <span class="n">dDzdz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">displaceZ</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">displaceZ</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">);</span><span class="c1">//中心差分</span>
    <span class="kt">float</span> <span class="n">dDxdz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">displaceX</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">displaceX</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">);</span><span class="c1">//中心差分</span>
    <span class="kt">float</span> <span class="n">dDzdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">displaceZ</span><span class="p">[</span><span class="n">x1</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">displaceZ</span><span class="p">[</span><span class="n">x0</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">);</span><span class="c1">//中心差分</span>

    <span class="kt">float</span> <span class="n">gradx</span> <span class="o">=</span> <span class="n">ht_dx</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">gradz</span> <span class="o">=</span> <span class="n">ht_dz</span><span class="p">[</span><span class="n">id</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">id</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">N</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
    <span class="c1">//displaceXZだけ定義点が移動することを考えここで傾きをさらにいじる</span>
    <span class="n">gradx</span> <span class="o">*=</span> <span class="n">dx</span> <span class="o">/</span> <span class="p">(</span><span class="n">dDxdx</span> <span class="o">*</span> <span class="n">lambda</span> <span class="o">+</span> <span class="n">dx</span><span class="p">);</span>
    <span class="n">gradz</span> <span class="o">*=</span> <span class="n">dz</span> <span class="o">/</span> <span class="p">(</span><span class="n">dDzdz</span> <span class="o">*</span> <span class="n">lambda</span> <span class="o">+</span> <span class="n">dz</span><span class="p">);</span>
    <span class="n">float3</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="o">-</span><span class="n">gradx</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">gradz</span><span class="p">));</span>
    <span class="n">float4</span> <span class="n">out4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">out4</span><span class="p">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">vec</span><span class="p">;</span>
    <span class="n">normalTex</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">out4</span><span class="p">;</span>

    <span class="c1">//Jの計算</span>
    <span class="kt">float</span> <span class="n">Jxx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">+</span> <span class="n">dDxdx</span> <span class="o">*</span> <span class="n">lambda</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">Jzz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">+</span> <span class="n">dDzdz</span> <span class="o">*</span> <span class="n">lambda</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">Jxz</span> <span class="o">=</span> <span class="n">dDxdz</span> <span class="o">*</span> <span class="n">lambda</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">Jzx</span> <span class="o">=</span> <span class="n">dDzdx</span> <span class="o">*</span> <span class="n">lambda</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">J</span> <span class="o">=</span> <span class="n">Jxx</span> <span class="o">*</span> <span class="n">Jzz</span> <span class="o">-</span> <span class="n">Jxz</span> <span class="o">*</span> <span class="n">Jzx</span><span class="p">;</span><span class="c1">//J&lt;0なら面が裏返しになってる</span>
    <span class="n">bubbleTex</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">J</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div>
</div>

<p>レンダリング側</p>

<div class="code-frame" data-lang="glsl">
<div class="code-lang"><span class="bold">SurfaceShader.shader</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">Shader</span> <span class="s">"Custom/SurfaceShader"</span> <span class="p">{</span>
    <span class="n">Properties</span><span class="p">{</span>
        <span class="n">_MainTexN</span><span class="p">(</span><span class="s">"-"</span> <span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"black"</span> <span class="p">{}</span>
        <span class="n">_MainTexB</span><span class="p">(</span><span class="s">"-"</span> <span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"black"</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="n">SubShader</span><span class="p">{</span>

        <span class="n">Pass</span> <span class="p">{</span>
            <span class="n">CGPROGRAM</span>
            <span class="c1">// シェーダーモデルは5.0を指定</span>
            <span class="cp">#pragma target 5.0
</span>            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            <span class="cp">#include "UnityCG.cginc"
</span>
            <span class="kt">sampler2D</span> <span class="n">_MainTexN</span><span class="p">;</span>
            <span class="kt">sampler2D</span> <span class="n">_MainTexB</span><span class="p">;</span>
    <span class="n">StructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">d_ht</span><span class="p">;</span>
    <span class="n">StructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">d_displaceX</span><span class="p">;</span>
    <span class="n">StructuredBuffer</span><span class="o">&lt;</span><span class="n">float2</span><span class="o">&gt;</span> <span class="n">d_displaceZ</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="n">N</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">halfN</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">dx</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">dz</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">lambda</span><span class="p">;</span>

    <span class="kt">float</span> <span class="n">Get_d_ht_real</span><span class="p">(</span><span class="kt">uint</span> <span class="n">x</span><span class="p">,</span><span class="kt">uint</span> <span class="n">z</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">float2</span> <span class="n">h</span> <span class="o">=</span> <span class="n">d_ht</span><span class="p">[</span><span class="n">x</span> <span class="o">%</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">z</span> <span class="o">%</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">256</span><span class="p">];</span>
        <span class="k">return</span> <span class="n">h</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">float2</span> <span class="n">Get_d_displaceXZ</span><span class="p">(</span><span class="kt">uint</span> <span class="n">x</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">z</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">float2</span> <span class="n">ret</span><span class="p">;</span>
        <span class="n">ret</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">d_displaceX</span><span class="p">[</span><span class="n">x</span> <span class="o">%</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">z</span> <span class="o">%</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">256</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
        <span class="n">ret</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">d_displaceZ</span><span class="p">[</span><span class="n">x</span> <span class="o">%</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">z</span> <span class="o">%</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">256</span><span class="p">].</span><span class="n">x</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">lambda</span> <span class="o">*</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">VSOut</span> <span class="p">{</span>
        <span class="n">float4</span> <span class="n">pos</span> <span class="o">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
        <span class="n">float3</span> <span class="n">pos2</span> <span class="o">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
        <span class="n">float2</span> <span class="n">uv</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">// 頂点シェーダ、1つの4角形ポリゴンに頂点4つ</span>
    <span class="n">VSOut</span> <span class="n">vert</span><span class="p">(</span><span class="kt">uint</span> <span class="n">id</span> <span class="o">:</span> <span class="n">SV_VertexID</span><span class="p">,</span><span class="n">float3</span> <span class="n">normal</span> <span class="o">:</span> <span class="n">NORMAL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">VSOut</span> <span class="kr">output</span><span class="p">;</span>
        <span class="kt">uint</span> <span class="n">sqx</span> <span class="o">=</span> <span class="p">((</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span><span class="c1">//連続するid4つで四角形を作る</span>
        <span class="kt">uint</span> <span class="n">sqz</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">id</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">sqx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">id</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
        <span class="n">sqz</span> <span class="o">+=</span> <span class="p">(</span><span class="n">id</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
        <span class="kr">output</span><span class="p">.</span><span class="n">pos</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">Get_d_ht_real</span><span class="p">(</span><span class="n">sqx</span><span class="p">,</span> <span class="n">sqz</span><span class="p">);</span>
        <span class="kr">output</span><span class="p">.</span><span class="n">pos</span><span class="p">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">float2</span><span class="p">((</span><span class="n">sqx</span> <span class="o">-</span> <span class="n">halfN</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span><span class="p">,</span> <span class="p">(</span><span class="n">sqz</span> <span class="o">-</span> <span class="n">halfN</span><span class="p">)</span> <span class="o">*</span> <span class="n">dz</span><span class="p">);</span><span class="c1">//4角形</span>
        <span class="kr">output</span><span class="p">.</span><span class="n">pos</span><span class="p">.</span><span class="n">xz</span> <span class="o">+=</span> <span class="n">Get_d_displaceXZ</span><span class="p">(</span><span class="n">sqx</span><span class="p">,</span> <span class="n">sqz</span><span class="p">);</span>
        <span class="kr">output</span><span class="p">.</span><span class="n">pos</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kr">output</span><span class="p">.</span><span class="n">pos2</span> <span class="o">=</span> <span class="kr">output</span><span class="p">.</span><span class="n">pos</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
        <span class="kr">output</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_VP</span><span class="p">,</span> <span class="kr">output</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">rN1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="n">N</span><span class="p">;</span>
        <span class="kr">output</span><span class="p">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">float2</span><span class="p">(</span><span class="n">sqx</span><span class="p">,</span> <span class="n">sqz</span><span class="p">)</span> <span class="o">*</span> <span class="n">rN1</span> <span class="o">+</span> <span class="n">float2</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">rN1</span><span class="p">;</span>
        <span class="k">return</span> <span class="kr">output</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ピクセルシェーダー</span>
    <span class="c1">// ワールド座標系がよくわからないのでレイトレーシング的に色を決定している(要修正)</span>
    <span class="n">float4</span> <span class="n">frag</span><span class="p">(</span><span class="n">VSOut</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="n">COLOR</span>
    <span class="p">{</span>
        <span class="n">float4</span> <span class="n">col</span><span class="p">;</span> <span class="n">col</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">float3</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTexN</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">xyz</span><span class="p">);</span><span class="c1">//線形補完されて単位ベクトルじゃなくなっているので</span>
        <span class="n">float3</span> <span class="n">viewDir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">pos2</span> <span class="o">-</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="o">-</span><span class="mi">330</span><span class="p">));</span><span class="c1">//ここはMain Cameraの座標を埋め込み</span>
        <span class="n">float3</span> <span class="n">lightDir</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">));</span><span class="c1">//ライトベクトルも埋め込み</span>
        <span class="n">float3</span> <span class="n">reflectDir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">viewDir</span><span class="p">)</span> <span class="o">*</span> <span class="n">normal</span> <span class="o">+</span> <span class="n">viewDir</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">v</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">reflectDir</span><span class="p">,</span> <span class="n">lightDir</span><span class="p">);</span>
        <span class="n">float3</span> <span class="n">sky</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(</span><span class="mi">105</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">133</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">184</span><span class="p">.</span><span class="mi">0</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span><span class="c1">//空の色も埋め込み、しかも単色</span>
        <span class="kt">float</span> <span class="n">fresnel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mo">05</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">0</span><span class="p">.</span><span class="mo">05</span><span class="p">)</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="o">-</span><span class="n">viewDir</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span> <span class="mi">5</span><span class="p">));</span>
        <span class="n">col</span><span class="p">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">sky</span> <span class="o">*</span> <span class="n">fresnel</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">fresnel</span><span class="p">)</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="p">);</span><span class="c1">//海の色も埋め込み</span>
        <span class="n">col</span><span class="p">.</span><span class="n">xyz</span> <span class="o">+=</span> <span class="n">pow</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">649</span><span class="p">)</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">86</span><span class="p">);</span><span class="c1">//太陽の色も埋め込み</span>

        <span class="c1">//泡</span>
        <span class="kt">float</span> <span class="n">bubble</span> <span class="o">=</span> <span class="n">tex2D</span><span class="p">(</span><span class="n">_MainTexB</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bubble</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bubble</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">-</span><span class="n">bubble</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span><span class="c1">//裏返り度合いに応じて徐々に白くなる</span>
            <span class="n">col</span><span class="p">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">bubble</span> <span class="o">*</span> <span class="n">float3</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">bubble</span><span class="p">)</span> <span class="o">*</span> <span class="n">col</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">col</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ENDCG</span>
 <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>結果</p>

<p><a href="https://camo.qiitausercontent.com/edaedb8253279c70ec45b071980f5cec50227c8b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f37306137636463332d333862612d366338372d306465392d3432353035343233643031382e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F70a7cdc3-38ba-6c87-0de9-42505423d018.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9f87d8838abfef951d8ad12a2fc99075" alt="LjjFC1W1vV33n67B.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/70a7cdc3-38ba-6c87-0de9-42505423d018.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F70a7cdc3-38ba-6c87-0de9-42505423d018.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b2a7997b21c15a1c638d35ed07469473 1x" loading="lazy"></a></p>

<p>github<br>
<a href="https://github.com/toropippi/OceanFFT/tree/main/OceanFFT6Bubbles" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/toropippi/OceanFFT/tree/main/OceanFFT6Bubbles</a></p>

<p>波のてっぺん付近が白く着色されているのがわかります。波の先端、特にとがっているところは海面が90度以上傾いていることがあります。それを先ほどの計算で検出し、泡としてレンダリングしたということになります。</p>

<p><a href="https://camo.qiitausercontent.com/c8c5967d4d757eecda19185b63d1e88fb2b4104d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32636532623061662d666661352d643134342d313164362d6135336563656234323834352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2ce2b0af-ffa5-d144-11d6-a53eceb42845.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a456053a9aeb25e01360c7e5e718a3ff" alt="fig20choppysurface.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/2ce2b0af-ffa5-d144-11d6-a53eceb42845.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2ce2b0af-ffa5-d144-11d6-a53eceb42845.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e44472664e3f9759097db99c6eaa7845 1x" loading="lazy"></a></p>

<p>論文のFigureがわかりやすいかなと思ったのですが、Choppy Surfaceと書いてある波はよく目を凝らしてみるとPosition=15付近でぐるっと回っているのがわかります。これに対しMinimum E-value(最小固有値)がそこで0を下回っているというのが読み取れます。<br>
論文では、最大固有値は常に正で最小固有値は図のように負になるから、最大固有値×最小固有値がマイナスなのを確認できれば検出できるよねと言ってます。プログラムでは$Jxx,Jxz,Jzx,Jzz$の2*2の行列の行列式を求めることで、この最大固有値×最小固有値がマイナスかどうかを判定しています。(というか参考にしたコードがそういうコードだった)</p>

<h2>
<span id="おしまい" class="fragment"></span><a href="#%E3%81%8A%E3%81%97%E3%81%BE%E3%81%84"><i class="fa fa-link"></i></a>おしまい</h2>

<p>以上です。お疲れ様でした。</p>

<h3>
<span id="残った課題を箇条書きで" class="fragment"></span><a href="#%E6%AE%8B%E3%81%A3%E3%81%9F%E8%AA%B2%E9%A1%8C%E3%82%92%E7%AE%87%E6%9D%A1%E6%9B%B8%E3%81%8D%E3%81%A7"><i class="fa fa-link"></i></a>残った課題を箇条書きで</h3>

<p>・Shaderの要修正の部分はそのうち修正してgithubに<br>
・泡のレンダリングもうちょっと頑張れるはず<br>
・Donelan-Banner調べる<br>
・海面をループさせて無限海面に、遠くはLODで</p>

<h3>
<span id="解決した課題を箇条書きで" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E3%81%97%E3%81%9F%E8%AA%B2%E9%A1%8C%E3%82%92%E7%AE%87%E6%9D%A1%E6%9B%B8%E3%81%8D%E3%81%A7"><i class="fa fa-link"></i></a>解決した課題を箇条書きで</h3>

<p>・FFTの計算部分は2倍高速化できる。海面の高さはFFTの計算結果のうち実数しか使わないので、実数FFTの逆の手順を行うことで1/2のサイズのFFTで済む。<a href="https://xn--w6q13e505b.jp/method/fft/rft.html" rel="nofollow noopener" target="_blank">円周率.jpの実数FFTの説明</a>を参考に<a href="https://github.com/toropippi/fft_r2c_c2r" rel="nofollow noopener" target="_blank">複素数→実数FFTのC++コード</a>を書いたのでこれを参考に。ただ並列化しにくい部分があるのでComputeShaderへの適応はよく考える必要がある。</p>

<h1>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h1>

<p>一番参考にした中国語の解説<br>
<a href="https://zhuanlan.zhihu.com/p/96811613" class="autolink" rel="nofollow noopener" target="_blank">https://zhuanlan.zhihu.com/p/96811613</a><br>
<a href="https://zhuanlan.zhihu.com/p/64414956" class="autolink" rel="nofollow noopener" target="_blank">https://zhuanlan.zhihu.com/p/64414956</a><br>
<a href="https://zhuanlan.zhihu.com/p/95482541" class="autolink" rel="nofollow noopener" target="_blank">https://zhuanlan.zhihu.com/p/95482541</a><br>
<a href="https://github.com/Straw1997/FFTOcean" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Straw1997/FFTOcean</a></p>

<p>論文pdf<br>
<a href="https://evasion.imag.fr/Membres/Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/simulating-ocean-water-01.pdf" class="autolink" rel="nofollow noopener" target="_blank">https://evasion.imag.fr/Membres/Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/simulating-ocean-water-01.pdf</a></p>

<p>NV_OceanCS_Slides<br>
<a href="http://www-evasion.imag.fr/~Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/NV_OceanCS_Slides.pdf" class="autolink" rel="nofollow noopener" target="_blank">http://www-evasion.imag.fr/~Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/NV_OceanCS_Slides.pdf</a></p>

<p>UE4で海面シミュレーションと描画を行う at Qiita<br>
<a href="https://qiita.com/monguri/items/3ad184c3316343c635f5" class="autolink" id="reference-23b5990ff24fd4804f15">https://qiita.com/monguri/items/3ad184c3316343c635f5</a></p>

<p>その他英語スライドなど<br>
<a href="http://developer.download.nvidia.com/assets/gameworks/downloads/regular/events/cgdc15/CGDC2015_ocean_simulation_en.pdf" class="autolink" rel="nofollow noopener" target="_blank">http://developer.download.nvidia.com/assets/gameworks/downloads/regular/events/cgdc15/CGDC2015_ocean_simulation_en.pdf</a><br>
<a href="http://evasion.imag.fr/~Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/waterslides2001.pdf" class="autolink" rel="nofollow noopener" target="_blank">http://evasion.imag.fr/~Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/waterslides2001.pdf</a><br>
<a href="https://www.slideshare.net/Codemotion/an-introduction-to-realistic-ocean-rendering-through-fft-fabio-suriano-codemotion-rome-2017" class="autolink" rel="nofollow noopener" target="_blank">https://www.slideshare.net/Codemotion/an-introduction-to-realistic-ocean-rendering-through-fft-fabio-suriano-codemotion-rome-2017</a></p>

<p>参考にしたコード<br>
<a href="https://github.com/nobnak/FftUnity" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/nobnak/FftUnity</a><br>
<a href="https://github.com/gasgiant/FFT-Ocean" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/gasgiant/FFT-Ocean</a></p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FRed_Black_GPGPU%2Fitems%2F2652f5bfd6d311d2034b&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FRed_Black_GPGPU%2Fitems%2F2652f5bfd6d311d2034b&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b/likers" class="css-1iupg5d">124</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">103</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/2652f5bfd6d311d2034b/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Red_Black_GPGPU/items/2652f5bfd6d311d2034b.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-67251f46-c56b-4bc2-9f07-3fc3d131221d">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-3acf5727-3f1e-4c54-83ac-716521ac1fb6"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-3acf5727-3f1e-4c54-83ac-716521ac1fb6">{}</script>
      
<div id="LoginModal-react-component-164f9b1d-2930-477f-b0f5-736354503f9f"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-164f9b1d-2930-477f-b0f5-736354503f9f">{}</script>
      
<div id="StockModal-react-component-0f217f51-5e7d-4b51-a066-8be38e398d40"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-0f217f51-5e7d-4b51-a066-8be38e398d40">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;YuQjqSiWo+Xj4Rv0d45/qtVfPLnZ9VWhh4fz9u6yAEfju08X6wo06JqC3Ek+GaFEsHXvWg+46g8d/rSZqL+hlA==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003eこの記事は\u003ca href=\"https://qiita.com/advent-calendar/2020/unity3\"\u003eUnity #3 Advent Calendar 2020\u003c/a\u003eの9日目の記事です。\u003c/p\u003e\n\n\u003cp\u003eこの記事では高速フーリエ変換(FFT)を使った海洋シミュレーション、FFT Oceanについて書いていこうと思います。Unityに限らずいろんなゲームエンジンで再現できるよう理論サイドも俯瞰しつつ、私が実装を通して理解したことをまとめさせていただければと思います。\u003c/p\u003e\n\n\u003cp\u003eまずはこんな感じの絵を出すところまでを目標にします。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/513d97a241919ff1a36d133d3dddcdf9964d8190/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f36363932616336652d353062612d666635652d386564332d3530633536366464636638352e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3db1af5c549408c40b0c5ca4c5b92618\" alt=\"ezgif-4-f4ec4a5a133b.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=dd4aabb5d608b40bbaeecf31c0d7990a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e次に発展として、法線ベクトルの算出や、より波を尖らせてそれっぽくすることをやっていこうと思います。\u003cbr\u003e\n最終的にはこんな絵ができあがります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/edaedb8253279c70ec45b071980f5cec50227c8b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f37306137636463332d333862612d366338372d306465392d3432353035343233643031382e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F70a7cdc3-38ba-6c87-0de9-42505423d018.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=9f87d8838abfef951d8ad12a2fc99075\" alt=\"LjjFC1W1vV33n67B.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/70a7cdc3-38ba-6c87-0de9-42505423d018.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F70a7cdc3-38ba-6c87-0de9-42505423d018.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b2a7997b21c15a1c638d35ed07469473 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"fft-oceanについて\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#fft-ocean%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFFT Oceanについて\u003c/h2\u003e\n\n\u003cp\u003e音声信号などの波形はフーリエ変換することで周波数を得ることができます。逆に周波数情報から波形を求めることができます(逆フーリエ変換)。\u003c/p\u003e\n\n\u003cp\u003eFFT Oceanは海面の高さを周波数から逆フーリエ変換で求めてしまおうというものです。すなわち周波数スペクトルが大事になってきます。\u003c/p\u003e\n\n\u003cp\u003eこの周波数スペクトルをTessendorfの書いた手法で生成します。\u003cbr\u003e\n\u003ca href=\"https://evasion.imag.fr/Membres/Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/simulating-ocean-water-01.pdf\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://evasion.imag.fr/Membres/Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/simulating-ocean-water-01.pdf\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e一部のゲームや映画(タイタニック)などいろんなところに使われている有名(?)な手法のようです。\u003c/p\u003e\n\n\u003cp\u003eCUDA Sampleの中にもあったりします。\u003cbr\u003e\n\u003ca href=\"https://docs.nvidia.com/cuda/cuda-samples/index.html#cuda-fft-ocean-simulation\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.nvidia.com/cuda/cuda-samples/index.html#cuda-fft-ocean-simulation\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/2702595913b37b1de9fb0077ca58277bf587230f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f33653237663831362d323638372d666564622d336537382d3566326461323966393236382e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F3e27f816-2687-fedb-3e78-5f2da29f9268.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=dd9325fa6b65aea9a60f9345618bf468\" alt=\"out_20201204_010043.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/3e27f816-2687-fedb-3e78-5f2da29f9268.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F3e27f816-2687-fedb-3e78-5f2da29f9268.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=ee655382ed5a3d743db3202ca2c82d28 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"0概要をざっくりと\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#0%E6%A6%82%E8%A6%81%E3%82%92%E3%81%96%E3%81%A3%E3%81%8F%E3%82%8A%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e0.概要をざっくりと\u003c/h2\u003e\n\n\u003cp\u003e(画像はNVIDIAのOceanCSのpdfより)\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/032a168d502d6cc62873b9e458288fc2a0363f3c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f66353135383231342d653836372d373430332d306637612d3934396238343436373431382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Ff5158214-e867-7403-0f7a-949b84467418.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d0269a3e0ce7b63fbfd7674889a1c133\" alt=\"nvtex1.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/f5158214-e867-7403-0f7a-949b84467418.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Ff5158214-e867-7403-0f7a-949b84467418.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6c9d8bfe80060c43f342543ad58fb08e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e１、まずは事前計算で左の画像をCPUで計算しGPU上のメモリに載せておく\u003cbr\u003e\n２、それをベースに毎フレーム真ん中の画像をGPU上で生成(tはtime)。これが周波数に相当\u003cbr\u003e\n３、GPU上で逆フーリエ変換をして右の画像(=海面の高さ)を生成\u003cbr\u003e\n４、右の画像から実際の位置にレンダリング\u003c/p\u003e\n\n\u003cp\u003e※数式上、最初から最後まで複素数がでてきますが、画像でいうと左の画像と中央の画像ではr,gが実数,虚数に対応、右の画像は実数を白で表現してい(ると思われ)ます。CUDA Sampleでも海面の高さには実数のみを使っていました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"1事前計算でh0kをcpuで計算しgpu上のメモリに載せておく\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1%E4%BA%8B%E5%89%8D%E8%A8%88%E7%AE%97%E3%81%A7h0k%E3%82%92cpu%E3%81%A7%E8%A8%88%E7%AE%97%E3%81%97gpu%E4%B8%8A%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E8%BC%89%E3%81%9B%E3%81%A6%E3%81%8A%E3%81%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1.事前計算でh0(k)をCPUで計算しGPU上のメモリに載せておく\u003c/h2\u003e\n\n\u003cp\u003eここで求めたいのは\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/b3d62483aba7d71b23a607c87fedbd6acc960349/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32393564643665622d326637612d346262342d643762342d6266646365666434336135382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F295dd6eb-2f7a-4bb4-d7b4-bfdcefd43a58.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=8f6c046f1d29d6bf105570d386311787\" alt=\"nvtex_left_copy.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/295dd6eb-2f7a-4bb4-d7b4-bfdcefd43a58.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F295dd6eb-2f7a-4bb4-d7b4-bfdcefd43a58.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=31623739f137ed42e61680cb9ab60953 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n  \\tilde{h}_0(\\vec{k})  =\\frac{1}{\\sqrt{2}}(\\xi_r+i\\xi_i)\\sqrt{P_h(\\vec{k})}\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eです。\u003cbr\u003e\n正直最初ほとんどの記号が意味ワカンナイ状態でしたが、他人のコードを見ながらちょっとずつ理解していった感じです。ひとつずつ見ていきましょう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"kの定義\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#k%E3%81%AE%E5%AE%9A%E7%BE%A9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eKの定義\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\vec{k}=(k_x,k_z)=(\\frac{2\\pi n}{L_x},\\frac{2\\pi m}{L_z})\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e-\\frac{N}{2}\\leq n\u0026lt;\\frac{N}{2}\\\\\n-\\frac{M}{2}\\leq m\u0026lt;\\frac{M}{2}\\\\\nn,mは整数\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e早速難しそうですが、kはN×Mの二次元配列みたいなもんです。画像の各ピクセルにkの各要素が対応している感じです。\u003c/p\u003e\n\n\u003cp\u003e今後FFTで実装することを考慮し2のべき乗とし、今は$N=256$,$M=256$くらいで考えておけばよいです。\u003cbr\u003e\nまた$L_x,L_z$は海面サイズです。\u003cbr\u003e\nこちらに関しては、スケールの問題なので何でもいいと最初思ってましたが論文にはこうありました。\u003cbr\u003e\n・$dx=L_x/N \u0026gt; 2$\u003cbr\u003e\n・$dz=L_z/M \u0026gt; 2$\u003cbr\u003e\n・$dx,dz=2.5$  が最も良い (←自信ないのですが間違ってたらコメントしてください)\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"正規分布に基づく乱数\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%AD%A3%E8%A6%8F%E5%88%86%E5%B8%83%E3%81%AB%E5%9F%BA%E3%81%A5%E3%81%8F%E4%B9%B1%E6%95%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e正規分布に基づく乱数\u003c/h3\u003e\n\n\u003cp\u003e$\\xi_r$と$\\xi_i$はランダムな数です。具体的には正規分布する乱数が必要です。なんでこう難しそうな記号を使うのか・・・\u003cbr\u003e\nコードではボックス＝ミュラー法を使っています。これは標準正規分布する乱数を生成する手法です。\u003cbr\u003e\n参考\u003cbr\u003e\n\u003ca href=\"https://qiita.com/sw1227/items/8f5da8c22d907352e4c9\" id=\"reference-2d23c6ac074d90903943\"\u003eJavaScriptでBox-Muller法による正規分布からのサンプリング\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// Generates Gaussian random number with mean 0 and standard deviation 1.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"nf\"\u003eGauss\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eu1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRandom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eu2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRandom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elogU1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e2f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eu1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elogU1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"m\"\u003e0f\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elogU1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etheta\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eu2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ez0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etheta\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ez1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etheta\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ez0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ez1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"phillips-spectrum\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#phillips-spectrum\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ePhillips Spectrum\u003c/h3\u003e\n\n\u003cp\u003e最後に残った$P_h(\\vec{k})$の中身はこれです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eP_h(\\vec{k})=A\\frac{e^\\frac{-1}{(kL)^2}}{k^4}|\\vec{k}\\cdot\\vec{\\omega}|^2\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e？？？？？？？？？\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/0db50e40c85acfcfaffd105bb94738cb4b47da46/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f63663237303364322d626266362d663632652d333562632d3365613164323731343435662e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcf2703d2-bbf6-f62e-35bc-3ea1d271445f.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=0bd08bd7eccd255a7cdeb027da0c7261\" alt=\"utyuneko.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/cf2703d2-bbf6-f62e-35bc-3ea1d271445f.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcf2703d2-bbf6-f62e-35bc-3ea1d271445f.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8bb3c629d7abdbcc385e740ca4398c2d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eえー、これも一つずつ見ていきましょう。\u003c/p\u003e\n\n\u003cp\u003e$A$：これは定数です。最終的な波の高さのスケールだと思ってください。\u003cbr\u003e\n$e$：これはさすがに自然対数の底でいいでしょう。\u003cbr\u003e\n$k$：$\\vec{k}$ の長さ。sqrt(k.x*k.x+k.y*k.y)とかで求められますね。\u003cbr\u003e\n$L$：$L=V^2/g$ ここで$V$は風速 つまり定数、$g$は重力定数で$g=9.81$です。\u003cbr\u003e\n$\\vec{\\omega}$：風向きの単位ベクトル(風がないと波が起きません)\u003c/p\u003e\n\n\u003cp\u003eこれですべてそろいました。\u003cbr\u003e\nなお、この式の意味するところですが理論的に導き出されたというよりは、テッセンドルフさんが必死に海を観察し導き出された\"経験的\"な式らしいです。なのであまり細かいことを気にせずに、こういうものだと思ったほうがいいです、精神衛生上。\u003c/p\u003e\n\n\u003cp\u003eで、ここまではまぁいいのですが、論文にはさらにこうあります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/cca09e9887f101af7ab862725d9e40f73010ef23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f35336431303837612d363862662d396564652d336537352d3833336637613832386431652e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F53d1087a-68bf-9ede-3e75-833f7a828d1e.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=37c9aae924e6e20a909a84a613a735df\" alt=\"ronbun.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/53d1087a-68bf-9ede-3e75-833f7a828d1e.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F53d1087a-68bf-9ede-3e75-833f7a828d1e.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f2e4abbf841e29d5a6b2f1c8d4216a8e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e多分ですが|k|が大きいとなにかがダメなようで、ちょっと修正しろと言ってるんですね。\u003cbr\u003e\n他のコードも参考に下記のような修正を加えるようにしました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\nP_{h_{modify}}(\\vec{k})=P_h(\\vec{k})×e^{-k^2(0.001L)^2}\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ePhillips.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePhillips\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLx\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLz\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eG\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e9.81f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e              \u003cspan class=\"c1\"\u003e// gravitational constant\u003c/span\u003e\n    \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0.000001f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e              \u003cspan class=\"c1\"\u003e// wave scale factor  A - constant\u003c/span\u003e\n    \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ewindSpeed\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e30.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ewindDir\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e1.234f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e//wind angle in radians\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Generates Gaussian random number with mean 0 and standard deviation 1.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"nf\"\u003eGauss\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eu1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRandom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eu2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRandom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elogU1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e2f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eu1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elogU1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"m\"\u003e0f\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elogU1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etheta\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eu2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ez0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etheta\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ez1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etheta\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ez0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ez1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Phillips spectrum\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// (Kx, Ky) - normalized wave vector\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"nf\"\u003eGenerate_Phillips\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eKx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eKy\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ek2mag\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eKx\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eKx\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eKy\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eKy\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek2mag\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e0.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ek4mag\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ek2mag\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek2mag\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// largest possible wave from constant wind of velocity v\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eL\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ewindSpeed\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ewindSpeed\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eG\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ek_x\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eKx\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek2mag\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ek_y\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eKy\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek2mag\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ew_dot_k\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ek_x\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewindDir\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ek_y\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewindDir\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ephillips\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExp\u003c/span\u003e\u003cspan class=\"p\"\u003e(-\u003c/span\u003e\u003cspan class=\"m\"\u003e1.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek2mag\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eL\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003ek4mag\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ew_dot_k\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ew_dot_k\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// damp out waves with very small length w \u0026lt;\u0026lt; l\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003el2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ephillips\u003c/span\u003e \u003cspan class=\"p\"\u003e*=\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExp\u003c/span\u003e\u003cspan class=\"p\"\u003e(-\u003c/span\u003e\u003cspan class=\"n\"\u003ek2mag\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003el2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ephillips\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Generate base heightfield in frequency space\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003eGenerate_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eh0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ekx\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(-(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eky\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(-(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eP\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGenerate_Phillips\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eky\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekx\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eky\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eP\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eh0\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGauss\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eP\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e0.5f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eh0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこれでCPU上で$h_0(\\vec{k})$を計算することができました。\u003c/p\u003e\n\n\u003cp\u003e後のコードに含まれていますが、GPUに転送するコードの一部を載せておきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eFFTOceanMain.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eh_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eComputeBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ed_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eh_h0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ephillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGenerate_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"c1\"\u003e//CPU側メモリ確保。サイズはsizeof(Vector2)*256*256\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ed_h0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eComputeBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//GPU側メモリ確保 サイズはsizeof(Vector2)*256*256\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ed_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"余談-w_dot_kの6乗のとき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%99%E8%AB%87-w_dot_k%E3%81%AE6%E4%B9%97%E3%81%AE%E3%81%A8%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e余談 w_dot_kの6乗のとき\u003c/h4\u003e\n\n\u003cp\u003e余談ですが、Phillips Spectrumの計算でw_dot_kを2乗ではなく6乗でやる流派もあるようです。6乗にすることで、風の方向に応じた波が今まで以上に際立つそうです。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"余談-donelan-bannerというワード\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%99%E8%AB%87-donelan-banner%E3%81%A8%E3%81%84%E3%81%86%E3%83%AF%E3%83%BC%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e余談 Donelan-Bannerというワード\u003c/h4\u003e\n\n\u003cp\u003eこれも余談ですがPhillips Spectrumを求めた後、Donelan-Banner方向拡張?(中国語の翻訳なのでわかりませんが)という謎の計算をしてかけているコードも見かけたので一応書いておきます。\u003cbr\u003e\n\u003ca href=\"https://zhuanlan.zhihu.com/p/96811613\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://zhuanlan.zhihu.com/p/96811613\u003c/a\u003e\u003cbr\u003e\n(もう一つ別の人のコードでDonelan-Bannerを計算しているのを見つけたがどっかいった)\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"2それをベースに毎フレームhktをgpu上で生成tはtime\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2%E3%81%9D%E3%82%8C%E3%82%92%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E6%AF%8E%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0hkt%E3%82%92gpu%E4%B8%8A%E3%81%A7%E7%94%9F%E6%88%90t%E3%81%AFtime\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2.それをベースに毎フレームh(k,t)をGPU上で生成(tはtime)\u003c/h2\u003e\n\n\u003cp\u003e次に求めるべきはこれです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/a667501190454808991537160bc6cb267d48942b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f65343537343237662d303831332d616537372d653331352d3161656463343565613938342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=240fe4a227e2810145815f9fe58fbfe8\" alt=\"nvtex_mid_copy.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/e457427f-0813-ae77-e315-1aedc45ea984.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=df971c2a7d0e6f1ae6dcf14ee2c9720b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\tilde{h}(\\vec{k},t)=\\tilde{h}_0(\\vec{k})e^{i\\omega(k)t}+\\tilde{h}_0^*(-\\vec{k})e^{-i\\omega(k)t}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここで$ \\tilde{h}_0^*$は$ \\tilde{h}_0$の共役複素数です。※虚部を−1倍した複素数のことを共役複素数と言います。\u003cbr\u003e\nあとhの上に乗ってる波線はチルダと読みますが特に深い意味はないので無視してください(なんか\"似てる\"的な意味合いがあるようです)\u003cbr\u003e\n$\\omega(k)=\\sqrt{gk}$\u003cbr\u003e\n$g$は重力定数 $=9.81$\u003cbr\u003e\n$k$は$\\vec{k}$の長さです。\u003cbr\u003e\n$t$はtimeです。毎フレーム動的にh(k,t)が変わるということが分かります。\u003c/p\u003e\n\n\u003cp\u003eあと$e$の肩に虚数$i$が乗っています。高校数学でここまで習わないかもしれませんが、この計算は有名なヤツです。\u003c/p\u003e\n\n\u003cp\u003eオイラーの公式\u003cbr\u003e\n$$ e^{i\\theta} = \\cos\\theta + i\\sin\\theta $$\u003c/p\u003e\n\n\u003cp\u003eプログラム実装的にはどうすればよいかと言うと\u003cbr\u003e\n「実数xが与えられるので$e^{ix}$を求めてください、cosとsin関数を駆使してね」\u003cbr\u003e\nということなので四則演算とsin,cosが書ければ実装できることがわかります。\u003c/p\u003e\n\n\u003cp\u003eしたがってこんなコードになります。\u003cbr\u003e\nGPU上にあるデータに対しての計算なのでCompute Shaderのコードになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eGenerateSpectrum.compute\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n\u003cspan class=\"cp\"\u003e#pragma kernel GenerateSpectrumKernel\n#define PI 3.14159265358979323846264338328\n\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eh0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eht\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"nf\"\u003econjugate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ef2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ef2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ef2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ef2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"nf\"\u003ecomplex_exp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ecos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003esin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"nf\"\u003ecomplex_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"nf\"\u003ecomplex_mult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eab\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ecd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003eab\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eab\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eab\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eab\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enumthreads\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eGenerateSpectrumKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint2\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_DispatchThreadID\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ein_index\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ein_mindex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// mirrored\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eout_index\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// calculate wave vector\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// calculate dispersion w(k)\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ek_len\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e9\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e81\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eh0_k\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eh0\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ein_index\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eh0_mk\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eh0\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ein_mindex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// output frequency-space complex values\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eht\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eout_index\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecomplex_mult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh0_k\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_exp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_mult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econjugate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh0_mk\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_exp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e難しい点としては$ \\tilde{h}_0(-\\vec{k}) $のメモリアクセスかなと思います。\u003c/p\u003e\n\n\u003cp\u003eコードでいうとin_mindexの計算についてです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"in_mindexの計算\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#in_mindex%E3%81%AE%E8%A8%88%E7%AE%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ein_mindexの計算\u003c/h3\u003e\n\n\u003cp\u003eちょっと考えてみましょう(自分のメモ代わりにもなるので)\u003c/p\u003e\n\n\u003cp\u003eここで h0[y*N+x] というように配列変数にアクセスし$\\tilde{h}_0(\\vec{k})$の値を取り出せたとします。\u003c/p\u003e\n\n\u003cp\u003eそのときx,yを使って$\\tilde{h}_0(-\\vec{k})$を取り出すにはどうしたらいいでしょう、という問題になります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\vec{k}=(k_x,k_z)=(\\frac{2\\pi n}{L_x},\\frac{2\\pi m}{L_z})\\\\\n n=-\\frac{N}{2}+x\\\\\n m=-\\frac{M}{2}+y\\\\\n 0\\leqq x\u0026lt;N\\\\\n 0\\leqq y\u0026lt;M\\\\\n x,yは整数\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなのでマイナスは\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e-\\vec{k}=(-k_x,-k_z)=(-\\frac{2\\pi n}{L_x},-\\frac{2\\pi m}{L_z})\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここから\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e-\\vec{k}=(\\frac{2\\pi n'}{L_x},\\frac{2\\pi m'}{L_z})\\\\\nとし\\\\\nn'=-n=\\frac{N}{2}-x=-\\frac{N}{2}+(N-x)\\\\\nm'=-m=\\frac{M}{2}-y=-\\frac{M}{2}+(M-y)\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eつまり\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ex'=N-x\\\\\ny'=M-y\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとしてx' y'を使ってh0[y'*N+x'] というようアクセスすることで$ \\tilde{h}_0(-\\vec{k}) $が得られることがわかりました。\u003c/p\u003e\n\n\u003cp\u003eただしx=0 や y=0のときx'=N y'=Mとなり範囲外のアクセスになるのでx'=Nのときはx'=0(y'のときも同様)の値を使って計算してしまっています。ここは目を瞑ります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"dispatchグループ数について\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dispatch%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDispatchグループ数について\u003c/h3\u003e\n\n\u003cp\u003eこのCompute Shaderコードでは\u003cbr\u003e\nid.x id.yが0～255になることを想定しているので、C#のDispatch側でも\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_GenerateSpectrumKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのようにグループ数を指定する必要があります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"3gpu上で逆フーリエ変換をして右の画像海面の高さを生成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3gpu%E4%B8%8A%E3%81%A7%E9%80%86%E3%83%95%E3%83%BC%E3%83%AA%E3%82%A8%E5%A4%89%E6%8F%9B%E3%82%92%E3%81%97%E3%81%A6%E5%8F%B3%E3%81%AE%E7%94%BB%E5%83%8F%E6%B5%B7%E9%9D%A2%E3%81%AE%E9%AB%98%E3%81%95%E3%82%92%E7%94%9F%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.GPU上で逆フーリエ変換をして右の画像(=海面の高さ)を生成\u003c/h2\u003e\n\n\u003cp\u003eさきほど求めた画像$\\tilde{h}(\\vec{k},t)$をもとに逆2DFFTをかけ海面の高さを算出します。\u003cbr\u003e\n式で書くと\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eh(\\vec{x},t)=\\sum_{k}\\tilde{h}(\\vec{k},t)e^{i\\vec{k}\\cdot\\vec{x}}\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eを求めたいです。\u003cbr\u003e\nその計算の仕方ですが、ちょっと長めの説明をしたいので先に結論だけ言います。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/a667501190454808991537160bc6cb267d48942b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f65343537343237662d303831332d616537372d653331352d3161656463343565613938342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=240fe4a227e2810145815f9fe58fbfe8\" alt=\"nvtex_mid_copy.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/e457427f-0813-ae77-e315-1aedc45ea984.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=df971c2a7d0e6f1ae6dcf14ee2c9720b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nまずこの画像を普通に2次元逆FFTで変換します。そのあと\u003cbr\u003e\n\u003cb\u003e・計算結果全体を(N/2,M/2)ずらす\u003cbr\u003e\n・要素のindex x,zが(x+z)%2==1となる要素に-1をかける\u003c/b\u003e\u003cbr\u003e\nをすればよいです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"2次元fft\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2%E6%AC%A1%E5%85%83fft\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2次元FFT\u003c/h3\u003e\n\n\u003cp\u003eまずは普通の方法からおさらいしましょう。(普通ってなんだよ)\u003c/p\u003e\n\n\u003cp\u003e2DFFTのやりかたはまず横方向にそれぞれFFTを実行し\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/a63c42b7624c7e04f259ab892fc617105a389c0f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f63656639306565302d393836322d656634312d613066342d3033346130353432393330392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcef90ee0-9862-ef41-a0f4-034a05429309.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c0af89ab71fae9adeacac4a4bcd693c5\" alt=\"fftx.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/cef90ee0-9862-ef41-a0f4-034a05429309.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcef90ee0-9862-ef41-a0f4-034a05429309.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=75f5b2af4eeff84f5c4467b50454f254 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nその結果を今度は縦方向にFFTします。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/fc0ef2b0bc60bc84dde26438cd0f8cd38ef94c33/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f38666335376535352d323036632d643765632d303532652d6665356331613938306565382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F8fc57e55-206c-d7ec-052e-fe5c1a980ee8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f79fac0b803ee59c9dba4851c084290a\" alt=\"ffty.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/8fc57e55-206c-d7ec-052e-fe5c1a980ee8.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F8fc57e55-206c-d7ec-052e-fe5c1a980ee8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d56c975fabfc855c39de0583bab84037 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\niFFT(逆フーリエ変換)でも同様です。また縦→横の順にやっても答えは変わりません。\u003cbr\u003e\nFFTの具体的な計算方法についてはわかりやすいサイトがたくさんあるのでここでは割愛させてください。またDFTからFFTで計算量が削減される話もこの記事では割愛させてください。\u003c/p\u003e\n\n\u003cp\u003e投げっぱなしなのもあれなので参考になりそうな記事をいくつかピックアップしてみました。\u003c/p\u003e\n\n\u003cp\u003eCompute Shaderで2DFFTしているコード\u003cbr\u003e\n\u003ca href=\"http://hikita12312.hatenablog.com/?page=1511103886\" rel=\"nofollow noopener\" target=\"_blank\"\u003e下町のナポレオン Compute ShaderでFFTと畳み込み演算でブラー\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eCompute Shaderではないが、ループ型のFFT計算のコードが乗ってる記事\u003cbr\u003e\n\u003ca href=\"https://qiita.com/habuyoshiaki/items/68d502c7bc0c35c168ef#%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%8C2%E3%81%AE%E5%86%AA%E4%B9%97%E5%B0%82%E7%94%A8%E3%81%AEfft%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3%E3%81%AE%E5%AE%9F%E8%A3%85\" id=\"reference-fd263576ea69167c0c2b\"\u003e任意要素数の高速フーリエ変換\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/bellbind/items/ba7aa07f6c915d400000#7-javascript%E3%81%AB%E3%82%88%E3%82%8B%E3%83%AB%E3%83%BC%E3%83%97%E7%89%88fft%E5%AE%9F%E8%A3%85%E3%82%B3%E3%83%BC%E3%83%89\" id=\"reference-be5a5ec582f08401473a\"\u003e高速フーリエ変換FFTを理解する\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/hayasagatarinai/items/b9fe56b79c9af20a98d9\" id=\"reference-f5cea7849d4ff30d45de\"\u003eFFT(Fast Fourier transform)をC++で実装する\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eDFTから理解する\u003cbr\u003e\n\u003ca href=\"https://qiita.com/TumoiYorozu/items/5855d75a47ef2c7e62c8\" id=\"reference-751ccfe47600176c3229\"\u003e離散フーリエ変換(DFT)の仕組みを完全に理解する\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"マイナス周波数成分から始まるスペクトルのifft\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%83%8A%E3%82%B9%E5%91%A8%E6%B3%A2%E6%95%B0%E6%88%90%E5%88%86%E3%81%8B%E3%82%89%E5%A7%8B%E3%81%BE%E3%82%8B%E3%82%B9%E3%83%9A%E3%82%AF%E3%83%88%E3%83%AB%E3%81%AEifft\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eマイナス周波数成分から始まるスペクトルのiFFT\u003c/h3\u003e\n\n\u003cp\u003e先ほどの式を再掲します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eh(\\vec{x},t)=\\sum_{k}\\tilde{h}(\\vec{k},t)e^{i\\vec{k}\\cdot\\vec{x}}\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここで$\\vec{k}$と$\\vec{x}$の定義は\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\vec{k}=(k_x,k_z)=(\\frac{2\\pi n}{L_x},\\frac{2\\pi m}{L_z})\\\\\n-\\frac{N}{2}\\leq n\u0026lt;\\frac{N}{2}\\\\\n-\\frac{M}{2}\\leq m\u0026lt;\\frac{M}{2}\\\\\nn,mは整数\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\vec{x}=(x,z)=(\\frac{qL_x}{N},\\frac{rL_z}{M})\\\\\n-\\frac{N}{2}\\leq q\u0026lt;\\frac{N}{2}\\\\\n-\\frac{M}{2}\\leq r\u0026lt;\\frac{M}{2}\\\\\nq,rは整数\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこうなっています。\u003cbr\u003e\nベクトルを成分別に分けて書くと上記の式はこうなります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eh(\\vec{x},t)=h(x,z,t)=\\sum_{m=-\\frac{M}{2}}^{\\frac{M}{2}-1}\\sum_{n=-\\frac{N}{2}}^{\\frac{N}{2}-1}\\tilde{h}(\\frac{2\\pi n}{Lx},\\frac{2\\pi m}{Lz},t)e^{i(\\frac{2\\pi n}{Lx}x+\\frac{2\\pi m}{Lz}z)}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003en,m,x,zがマイナスから始まっていることに注意です。なので普通にFFT(iFFT)の計算を適応しただけだと間違った答えになります。\u003c/p\u003e\n\n\u003cp\u003e画像をみればわかるとおり、中心に周波数0成分がきていますね。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/a667501190454808991537160bc6cb267d48942b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f65343537343237662d303831332d616537372d653331352d3161656463343565613938342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=240fe4a227e2810145815f9fe58fbfe8\" alt=\"nvtex_mid_copy.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/e457427f-0813-ae77-e315-1aedc45ea984.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fe457427f-0813-ae77-e315-1aedc45ea984.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=df971c2a7d0e6f1ae6dcf14ee2c9720b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"一応証明\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%80%E5%BF%9C%E8%A8%BC%E6%98%8E\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e一応証明\u003c/h4\u003e\n\n\u003cp\u003e普通にFFT(iFFT)の計算を適応しただけだと間違った答えになるので、さっき太文字で書いたやり方でやる必要があります。\u003cbr\u003e\n本当にそれでいいのか証明させてください・・・\u003cbr\u003e\nまずは0オリジンで考えたいのでこうします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003en'\\in{(0,1,2,3,...,N-1)}\\\\\nm'\\in{(0,1,2,3,...,M-1)}\\\\\nx'\\in{(0,1,2,3,...,N-1)}\\\\\nz'\\in{(0,1,2,3,...,M-1)}\\\\\nx''\\equiv x'+N/2 \\quad(mod \\quad N)\\\\\nz''\\equiv z'+M/2 \\quad(mod \\quad M)\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eするとx,z,n,mはこう書けます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003en=n'-\\frac{N}{2}\\\\\nm=m'-\\frac{M}{2}\\\\\nx=\\frac{L_x(-\\frac{N}{2}+x')}{N}=-\\frac{L_x}{2}+\\frac{x'L_x}{N}\\\\\nz=\\frac{L_z(-\\frac{M}{2}+z')}{M}=-\\frac{L_z}{2}+\\frac{z'L_z}{M}\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e続いて式簡略化のため${h'}$と$\\tilde{h'}$を定義\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e{h'}({x'},{z'},t)=h(x,z,t)\\\\\n\\tilde{h'}(n',m',t)=\\tilde{h}(\\frac{2\\pi n}{Lx},\\frac{2\\pi m}{Lz},t)\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eあとは求めたい$h()$についてゴリゴリ式変形すると\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e{h'}({x'},{z'},t)=h(x,z,t)=\\sum_{m=-\\frac{M}{2}}^{\\frac{M}{2}-1}\\sum_{n=-\\frac{N}{2}}^{\\frac{N}{2}-1}\\tilde{h}(\\frac{2\\pi n}{Lx},\\frac{2\\pi m}{Lz},t)e^{i(\\frac{2\\pi n}{Lx}x+\\frac{2\\pi m}{Lz}z)}\\\\\n=\\sum_{m'=0}^{M-1}\\sum_{n'=0}^{N-1}\\tilde{h'}(n',m',t)e^{i(\\frac{2\\pi (n'-\\frac{N}{2})}{Lx}x+\\frac{2\\pi (m'-\\frac{M}{2})}{Lz}z)}\\\\\n=\\sum_{m'=0}^{M-1}\\sum_{n'=0}^{N-1}\\tilde{h'}(n',m',t)e^{\ni(\\frac{\\pi N}{2}-\\pi x'+\\frac{2\\pi n'(x'-N/2)}{N})+\ni(\\frac{\\pi M}{2}-\\pi z'+\\frac{2\\pi m'(z'-M/2)}{M})\n}\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここでN,Mは256としていたので\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ee^{i(\\frac{\\pi N}{2})}=1\\\\\ne^{i(\\frac{\\pi M}{2})}=1\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなので消すことができ\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ee^{i (\\frac{2\\pi (x'+N/2)}{N})}=\\\\\ne^{i (\\frac{2\\pi (x'-N/2) +2\\pi N}{N})}=\\\\\ne^{i (\\frac{2\\pi (x'-N/2)}{N})}=\\\\\ne^{i (\\frac{2\\pi x''}{N})}\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eと置き換えられ\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ee^{i \\pi}=-1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなのでまとめると\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e{h'}({x'},{z'},t)=\n\\sum_{m'=0}^{M-1}\n\\sum_{n'=0}^{N-1}\n\\tilde{h'}(n',m',t)e^{\ni(\\frac{\\pi N}{2}-\\pi x'+\\frac{2\\pi n'(x'-N/2)}{N})+\ni(\\frac{\\pi M}{2}-\\pi z'+\\frac{2\\pi m'(z'-M/2)}{M}) }\\\\\n\n=(-1)^{x'}(-1)^{z'}\\sum_{m'=0}^{M-1}\\sum_{n'=0}^{N-1}\\tilde{h'}(n',m',t)e^{\ni(\\frac{2\\pi n'x''}{N})+\ni(\\frac{2\\pi m'z''}{M})\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eあとは$x'$と$x''$を入れ替え、$z$も同様にして\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n{h'}({x''},{z''},t)\\\\\n={h'}({x'}+\\frac{N}{2} (mod N),{z'}+\\frac{M}{2} (mod M),t)\\\\\n=(-1)^{x''}(-1)^{z''}\\sum_{m'=0}^{M-1}\\sum_{n'=0}^{N-1}\\tilde{h'}(n',m',t)e^{\ni(\\frac{2\\pi n'x'}{N})+\ni(\\frac{2\\pi m'z'}{M})\n}\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれでやっとよくあるFFTの形になりました(ほんとか)。。。\u003cbr\u003e\n普通と違うところは\u003c/p\u003e\n\n\u003cp\u003e・$h'$の添え字 ： →計算結果の書き込み先を(N/2,M/2)ずらせばよい\u003cbr\u003e\n・$(-1)^{x''}$と$(-1)^{z''}$ : →計算結果の書き込み先index x,zが(x+z)%2==1となる要素に-1をかければよい\u003c/p\u003e\n\n\u003cp\u003eということでやはりよさそうです。\u003c/p\u003e\n\n\u003cp\u003eこれらの要素を盛り込むことでこのようなコードになります。\u003cbr\u003e\nここでは横方向のfftと縦方向のfftを同じコードで実現しています。横方向を計算した後 縦方向を計算するので合計2回実行される前提のコードです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003efft.compute\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#pragma kernel FFT2Dfunc256inv\n#pragma kernel DFT2Dfunc256inv\n#define PI 3.14159265358979323846264338328\n\u003c/span\u003e\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//xが実数、yが虚数を格納\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//xが実数、yが虚数を格納\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//256*256要素の2D IFFT専用かつ負の周波数もあることも考慮しているコード(普通のFFT,DFTは正の周波数からはじまる)\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//グループ数Nで実行されること前提\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//2回実行されること前提\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#define M (8)\n#define N (1\u0026lt;\u0026lt;M)\n\u003c/span\u003e\u003cspan class=\"n\"\u003egroupshared\u003c/span\u003e \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enumthreads\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_DispatchThreadID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003egrid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_GroupID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_GroupIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003egrid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003egrid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eloopidx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003eloopidx\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eM\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003eloopidx\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edleng\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eM\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eloopidx\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003edleng\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003et0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003edleng\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edleng\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003et1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003et0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edleng\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGroupMemoryBarrierWithGroupSync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003er1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003et1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ei1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003et1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003er0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003et0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003er1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ei0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003et0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ei1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003erad\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003edleng\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//invなので-がかかっている\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003efsin\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erad\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003efcos\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erad\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003et0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003er1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003et0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003ei1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003et1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003er0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003efcos\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ei0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003efsin\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003et1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003er0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003efsin\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003efcos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eGroupMemoryBarrierWithGroupSync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ereim0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ereversebits\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eM\u003c/span\u003e\u003cspan class=\"p\"\u003e)];\u003c/span\u003e\u003cspan class=\"c1\"\u003e//32はuint=32bitの32\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ereim1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ereversebits\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eM\u003c/span\u003e\u003cspan class=\"p\"\u003e)];\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ereim1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ereim1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//出力結果に(-1)^indexが乗算されるので\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//書き込みはx,yを転置している。これによって2D FFTの計算の1回目と2回目を同じコードにできて、かつ、最終的なメモリ配置は最初と同じに戻る\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//最終的な書き込み先をN/2,N/2ずらすのも忘れずに\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ebuffer_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003egrid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereim0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ebuffer_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003egrid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereim1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"c1\"\u003e//DFTで愚直に書いたバージョン\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//デバッグ用、理解を深める用\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//グループ数Nで実行されること前提\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enumthreads\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_DispatchThreadID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003egrid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_GroupID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_GroupIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egi\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egrid\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003edftsum\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ekz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//* (2.0f * PI / N);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ekx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e// *(2.0f * PI / N);\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003erad\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003ekx\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ekz\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edftsum\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erad\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003esin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erad\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edftsum\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erad\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003esin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erad\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ebuffer_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edftsum\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eDispatch側のコード\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eFFT.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFFT\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eComputeShader\u003c/span\u003e \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eComputeBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer_dbg\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_FFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_DFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAwake\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ekernel_FFT2Dfunc256inv\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFindKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"FFT2Dfunc256inv\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ekernel_DFT2Dfunc256inv\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFindKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"DFT2Dfunc256inv\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer_dbg\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eComputeBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//bufferが入力、FFTの結果がbufferに出力\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFFT2D_256_Dispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eComputeBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eComputeBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eDEBUG_func1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//①引数をセット\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_FFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"buffer\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_FFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"buffer_dmy\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// GPUで計算\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_FFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//②引数をセット\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_FFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"buffer\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_FFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"buffer_dmy\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// GPUで計算\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_FFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDEBUG\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eDEBUG_func2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//bufferが入力、FFTの結果がbuffer_dmyに出力\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDFT2D_256_Dispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eComputeBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eComputeBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//引数をセット\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_DFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"buffer\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_DFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"buffer_dmy\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// GPUで計算\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_DFT2Dfunc256inv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\n    \u003cspan class=\"c1\"\u003e//FFTとDFTを比較\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDEBUG_func1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eComputeBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer_dbg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuffer_dbg\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eComputeBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eDFT2D_256_Dispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer_dbg\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//FFTとDFTを比較\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDEBUG_func2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eComputeBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ebfr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ebfr_dbg\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebfr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebuffer_dbg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebfr_dbg\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003erss\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ev2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebfr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ebfr_dbg\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003erss\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003ev2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrMagnitude\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erss\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eカーネルプログラムFFT2Dfunc256invはコメントにもあるよう\u003cbr\u003e\n・iFFTを普通に計算し(Cooley-Tukeyなので最後にbit逆順がある)\u003cbr\u003e\n・書き込み先indexが奇数なら-1をかけ\u003cbr\u003e\n・N/2ずらして\u003cbr\u003e\n・行列転置(縦横入れ替え)してメモリに書き込み\u003c/p\u003e\n\n\u003cp\u003eしています。\u003cbr\u003e\n文字だけだとわかりにくいのでプログラムの動作を画像化してみました。カラーが最初のメモリの位置に相当します。色味が落ちてるところは-1がかかっているという意味です。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/d38d8ddbc94b375ef9827f9d5867ec8d644fca78/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32383935373838372d616165312d363139612d306565622d3038643032646365303431382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F28957887-aae1-619a-0eeb-08d02dce0418.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=bd96dc5dde6e47cc446285a7fed89e00\" alt=\"kansei_syukusyou.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/28957887-aae1-619a-0eeb-08d02dce0418.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F28957887-aae1-619a-0eeb-08d02dce0418.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f3dbed06ea4252eb46525cf493e2fd3a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれによって\u003cbr\u003e\n\u003cb\u003e・計算結果全体を(N/2,N/2)ずらす\u003cbr\u003e\n・要素のindex x,zが(x+z)%2==1となる要素に-1をかける\u003c/b\u003e\u003cbr\u003e\nが実現していることがわかります。\u003cbr\u003e\n(と、偉そうにのたまいましたが皆さんの好きなように2D逆フリーエ変換を実装すればいいと思います。)\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"4右の画像から実際の位置にレンダリング\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4%E5%8F%B3%E3%81%AE%E7%94%BB%E5%83%8F%E3%81%8B%E3%82%89%E5%AE%9F%E9%9A%9B%E3%81%AE%E4%BD%8D%E7%BD%AE%E3%81%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.右の画像から実際の位置にレンダリング\u003c/h2\u003e\n\n\u003cp\u003eいろいろ大変な実装でしたが画面に描画してうまくいったとき疲れが全部吹き飛びます！あと一歩です。\u003cbr\u003e\nすでに高さ情報はComputeBufferに格納されているので\u003cbr\u003e\nGraphics.DrawProceduralNow\u003cbr\u003e\nなどで手軽に描画することができます。一番簡単なPointsの描画をしてみます。\u003cbr\u003e\nCPU側コードとShaderはこんなかんじ\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eFFTOceanMain.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFFTOceanMain\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eComputeShader\u003c/span\u003e \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eShader\u003c/span\u003e \u003cspan class=\"n\"\u003erenderingShader\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eMaterial\u003c/span\u003e \u003cspan class=\"n\"\u003erenderingShader_Material\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eFFT\u003c/span\u003e \u003cspan class=\"n\"\u003efFT\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e \u003cspan class=\"n\"\u003ephillips\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_GenerateSpectrumKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eh_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eComputeBuffer\u003c/span\u003e \u003cspan class=\"n\"\u003ed_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed_ht_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecnt\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAwake\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ekernel_GenerateSpectrumKernel\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFindKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"GenerateSpectrumKernel\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderingShader_Material\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMaterial\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erenderingShader\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecnt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eh_h0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ephillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGenerate_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\u003cspan class=\"c1\"\u003e//CPU側メモリ確保。サイズはsizeof(Vector2)*256*256\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ed_h0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eComputeBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//GPU側メモリ確保 サイズはsizeof(Vector2)*256*256\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eComputeBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//GPU側メモリ確保 サイズはsizeof(Vector2)*256*256\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ed_ht_dmy\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eComputeBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ed_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eSetArgs\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eSetArgs\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//ComputeShader引数をセット\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_GenerateSpectrumKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"h0\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_GenerateSpectrumKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"ht\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"N\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"seasizeLx\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eseasizeLx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"seasizeLz\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eseasizeLz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// GPUバッファをマテリアルに設定\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderingShader_Material\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"d_ht\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// その他Shader 定数関連\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderingShader_Material\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"N\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderingShader_Material\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetFloat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"halfN\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0.5f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderingShader_Material\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetFloat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"dx\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eseasizeLx\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderingShader_Material\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetFloat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"dz\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1.0f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eseasizeLz\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003ePhillips\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emeshSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//引数をセット\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetFloat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"t\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0.03f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecnt\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eshader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel_GenerateSpectrumKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//d_h0からd_htを計算\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efFT\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFFT2D_256_Dispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed_ht_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//d_htから高さデータを計算\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecnt\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnRenderObject\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// レンダリングを開始\u003c/span\u003e\n        \u003cspan class=\"n\"\u003erenderingShader_Material\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetPass\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// n個のオブジェクトをレンダリング\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDrawProceduralNow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMeshTopology\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e256\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e   \n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//解放\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ed_h0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRelease\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRelease\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ed_ht_dmy\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRelease\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSurfaceShader.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eShader\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Custom/SurfaceShader\"\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eSubShader\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ePass\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eCGPROGRAM\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// シェーダーモデルは5.0を指定\u003c/span\u003e\n            \u003cspan class=\"cp\"\u003e#pragma target 5.0\n\u003c/span\u003e            \u003cspan class=\"cp\"\u003e#pragma vertex vert\n\u003c/span\u003e            \u003cspan class=\"cp\"\u003e#pragma fragment frag\n\u003c/span\u003e            \u003cspan class=\"cp\"\u003e#include \"UnityCG.cginc\"\n\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ehalfN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003eui_calcPos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eui_idx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eui_idx\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eui_idx\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eui_idx\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ehalfN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ehalfN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eVSOut\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_POSITION\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 頂点シェーダ\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVSOut\u003c/span\u003e \u003cspan class=\"n\"\u003evert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_VertexID\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVSOut\u003c/span\u003e \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eui_calcPos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emul\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUNITY_MATRIX_VP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// ピクセルシェーダー\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efixed4\u003c/span\u003e \u003cspan class=\"n\"\u003efrag\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVSOut\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eCOLOR\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eENDCG\u003c/span\u003e\n \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"実行結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実行結果\u003c/h3\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/513d97a241919ff1a36d133d3dddcdf9964d8190/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f36363932616336652d353062612d666635652d386564332d3530633536366464636638352e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3db1af5c549408c40b0c5ca4c5b92618\" alt=\"ezgif-4-f4ec4a5a133b.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F6692ac6e-50ba-ff5e-8ed3-50c566ddcf85.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=dd4aabb5d608b40bbaeecf31c0d7990a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれだけでも十分綺麗ですね～！\u003cbr\u003e\nここまでのコードは\u003cbr\u003e\ngithub\u003cbr\u003e\n\u003ca href=\"https://github.com/toropippi/OceanFFT/tree/main/OceanFFT1_points\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/toropippi/OceanFFT/tree/main/OceanFFT1_points\u003c/a\u003e\u003cbr\u003e\nにUPしてます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"法線を計算\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B3%95%E7%B7%9A%E3%82%92%E8%A8%88%E7%AE%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e法線を計算\u003c/h2\u003e\n\n\u003cp\u003eさてせっかく綺麗な絵が出そうな雰囲気なので法線も計算してみましょう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"中心差分で算出\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%AD%E5%BF%83%E5%B7%AE%E5%88%86%E3%81%A7%E7%AE%97%E5%87%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e中心差分で算出\u003c/h3\u003e\n\n\u003cp\u003eお手軽な方法として、すでに計算してある海面の高さを利用して中心差分で勾配を計算します。\u003cdel\u003eだんだん\u003ca href=\"https://qiita.com/advent-calendar/2020/numerical_analysis\"\u003e数値計算 Advent Calendar\u003c/a\u003eみが増してきました\u003c/del\u003e\u003cbr\u003e\nx,z方向の勾配が求まれば、海面と垂直なベクトルがでます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\vec{N}=normalize(-xの傾き,1,-zの傾き)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこの計算のところだけピックアップします。雰囲気だけでもわかってもらえれば幸いです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003esubx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eht\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eht\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003erdx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003esubz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eht\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey1\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eht\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003erdz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003evec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enormalize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003esubx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003esubz\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003eout4\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eout4\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exyz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003evec\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eout4\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e法線ベクトル情報x,y,zをr,g,bで出力\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/415ba5fecd0329e626139a19be34327bea52b61d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f62306434313162312d303336352d393032652d373862342d3033326465643265353665332e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fb0d411b1-0365-902e-78b4-032ded2e56e3.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b866b103b436f4ca3482b7d4ab3cbcb4\" alt=\"xyzrgb_normal.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/b0d411b1-0365-902e-78b4-032ded2e56e3.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fb0d411b1-0365-902e-78b4-032ded2e56e3.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=4bb6c59c40e7866106a2c02600ae0f10 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nできました。あとは煮るなり焼くなり法線情報でうまくライティングすればきれいな絵ができるでしょう。\u003c/p\u003e\n\n\u003cp\u003egithub\u003cbr\u003e\n\u003ca href=\"https://github.com/toropippi/OceanFFT/tree/main/OceanFFT2_normal\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/toropippi/OceanFFT/tree/main/OceanFFT2_normal\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e念のためですが、法線が本当に正しいか、Aを100倍にして出力してみました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/7905225e9cb0a6d35d7945d858b74ac02f3969f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f33393831356362372d643139322d346266372d313339642d3862343761303765373835322e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F39815cb7-d192-4bf7-139d-8b47a07e7852.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=eacb8022a48d88e0b3cb22e2917ce7b8\" alt=\"kensyou.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/39815cb7-d192-4bf7-139d-8b47a07e7852.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F39815cb7-d192-4bf7-139d-8b47a07e7852.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=277b3118796ab0908dc88e783b7e050c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nx方向に向いている面は赤く、z方向に向いている面は青くなっています。面の法線ベクトルのx,z成分がr,bに対応しているので正しそうです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"偏微分で解析的に算出\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%81%8F%E5%BE%AE%E5%88%86%E3%81%A7%E8%A7%A3%E6%9E%90%E7%9A%84%E3%81%AB%E7%AE%97%E5%87%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e偏微分で解析的に算出\u003c/h3\u003e\n\n\u003cp\u003eところでせっかく難しい式を計算をしてスペクトルを出してきたので、法線も式から求められないでしょうか。\u003cbr\u003e\nこれも結論から言うとできます。\u003cbr\u003e\nこれで偏微分が計算できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\nabla h(\\vec{x},t)=\\sum_{\\vec{k}}i\\vec{k}\\tilde{h}(\\vec{k},t)e^{i\\vec{k}\\cdot \\vec{x}}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e$\\tilde{h}(\\vec{k},t)$は「2.それをベースに毎フレームh(k,t)をGPU上で生成」で求めたやつです。これに$i\\vec{k}$がかかっていますが、各要素の計算時に求めていた$kx,kz$を使うだけです。\u003cbr\u003e\nx方向の偏微分ならkxをz方向の偏微分ならkzのみを使います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e例\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e...............................\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enumthreads\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eGenerateSpectrumKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint2\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_DispatchThreadID\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ein_index\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ein_mindex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// mirrored\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eout_index\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// calculate wave vector\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// calculate dispersion w(k)\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ek_len\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e9\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e81\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eh0_k\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eh0\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ein_index\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eh0_mk\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eh0\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ein_mindex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// output frequency-space complex values\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ehtval\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecomplex_mult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh0_k\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_exp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_mult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econjugate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh0_mk\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_exp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eht\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eout_index\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtval\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//普通の高さの逆フーリエ前\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//i*htval\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ehtval\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtval\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eht_dx\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eout_index\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e//x方向偏微分の逆フーリエ前\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eht_dz\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eout_index\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e//z方向偏微分の逆フーリエ前\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eそしてそれを逆フーリエ変換することで海面の高さの勾配(偏微分)が求まります。ここで、手元には複素数の状態で結果があると思いますが、使うのは実数成分のみです。海面の高さには実数のみを使用しているので勾配情報も実数のみを使う必要があります。\u003cbr\u003e\nあとはさっきと同じように法線を計算し\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/b3de66c7e6292fec050a9a05187d85c6caadb7c5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f30386638396562392d643133312d333164352d663030312d3766656463306331303131312e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F08f89eb9-d131-31d5-f001-7fedc0c10111.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e025dfa7d73f3830134eb2c980768069\" alt=\"henbibun.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/08f89eb9-d131-31d5-f001-7fedc0c10111.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F08f89eb9-d131-31d5-f001-7fedc0c10111.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a5712c36154a8463574343498a357bcb 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eできました。\u003cbr\u003e\nさっきと見た目かわんないですが、中心差分よりは精度よくできてると思います。\u003cbr\u003e\nこれもgithubにupしてるので参考にしてください。\u003cbr\u003e\ngithub\u003cbr\u003e\n\u003ca href=\"https://github.com/toropippi/OceanFFT/tree/main/OceanFFT3_analyticalNormal\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/toropippi/OceanFFT/tree/main/OceanFFT3_analyticalNormal\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"もうちょっとライティングを頑張る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%82%E3%81%86%E3%81%A1%E3%82%87%E3%81%A3%E3%81%A8%E3%83%A9%E3%82%A4%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E9%A0%91%E5%BC%B5%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eもうちょっとライティングを頑張る\u003c/h3\u003e\n\n\u003cp\u003e正直Compute Shader以外のシェーダーやレンダリングは詳しくないのでたいしたことは書けません。\u003cbr\u003e\n一応、法線から反射ベクトルを計算してフレネル反射とか実装したりしなかったり・・・\u003cbr\u003e\nコードを見ればわかりますが視線ベクトル決め打ちのレイトレーシングみたいなことをしています、、、だからカメラ動かしても絵は変わらないというひどいコード。誰かレンダリング教えて・・・\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/172c65767fe05378f348d124327971a9aad56470/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32633933353731392d373663322d386634332d386638302d3732376338363661623932622e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2c935719-76c2-8f43-8f80-727c866ab92b.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=316347e48839ff248288289caa15c851\" alt=\"out_20201207_033459.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/2c935719-76c2-8f43-8f80-727c866ab92b.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2c935719-76c2-8f43-8f80-727c866ab92b.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=753980be0fcd282a03f60328a935c84a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\ngithub\u003cbr\u003e\n\u003ca href=\"https://github.com/toropippi/OceanFFT/tree/main/OceanFFT4lighting\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/toropippi/OceanFFT/tree/main/OceanFFT4lighting\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eまぁかつてないほど海っぽくなったのでいいでしょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"choppy-wave\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#choppy-wave\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eChoppy wave\u003c/h2\u003e\n\n\u003cp\u003eNVIDIAのスライドを見るに、さっきの偏微分にすごい似た、でもちょっと違う式で計算されたDx,Dyというのを求めています。これは法線を計算するためのものではなく、波をより尖らせたChoppy waveを作るために必要なようです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/56ae0bc43f3f93b5c41907c477e631bb3f35872d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32626231633531632d336664342d396461652d373733312d6365393138363638323666642e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2bb1c51c-3fd4-9dae-7731-ce91866826fd.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=83b8a88208c8b79649738adfe0aa83e2\" alt=\"nvslide2.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/2bb1c51c-3fd4-9dae-7731-ce91866826fd.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2bb1c51c-3fd4-9dae-7731-ce91866826fd.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=05f460383bc40b91c874bcc3ce7bf514 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e今までの波はあくまで有限個のsin,cosの足し合わせでできた波で、ちょっと滑らかになりすぎてるという問題があったようです。それをアーティスティックな謎テクで解決するのが今から説明する方法です。\u003c/p\u003e\n\n\u003cp\u003eいや滑らかすぎるならもっと離散点を増やして細かいsin,cosを足し合わせばいいじゃないかと個人的には思いましたが、そう書いてあるので仕方ありません。\u003cbr\u003e\nまぁおそらく離散点を増やすと計算負荷が上がるからダメなんでしょうね。\u003c/p\u003e\n\n\u003cp\u003eChoppy waveの計算手順はというと、まずDx,Dyを計算します。数式では $\\vec{D}$ と書いてあります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\vec{D}(\\vec{x},t)=\\sum_{\\vec{k}}-i\\frac{\\vec{k}}{k}\\tilde{h}(\\vec{k},t)e^{i\\vec{k}\\cdot \\vec{x}}\\\\\n\\vec{x}'=\\vec{x}+\\lambda \\vec{D}(\\vec{x},t)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eそしてこの$\\vec{x}'$を新しい座標として使います。\u003c/p\u003e\n\n\u003cp\u003e今まで$\\vec{x}=(x,z)$としてx,z座標は固定でやってきてましたよね。でy座標だけが動いていたと。\u003c/p\u003e\n\n\u003cp\u003e今度は$\\lambda$に2.0とか-3.4とか適当な値をいれることでx,zもリアルタイムに動いて、見た目が激しくなるというイメージです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/231dd0646ea6dd2dfbf6205426652103aba3a593/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32386636653938612d396431322d303731372d383031352d6431353762383536306238392e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F28f6e98a-9d12-0717-8015-d157b8560b89.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ab0bad4e45175a20cde9a4ed35605589\" alt=\"ezgif-3-1ac62bac3f22.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/28f6e98a-9d12-0717-8015-d157b8560b89.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F28f6e98a-9d12-0717-8015-d157b8560b89.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=94b4563750ca98796d146056a73cb6a5 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n今までと違い、x,z方向にもうねうねしていますね。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\vec{D}(\\vec{x},t)=\\sum_{\\vec{k}}-i\\frac{\\vec{k}}{k}\\tilde{h}(\\vec{k},t)e^{i\\vec{k}\\cdot \\vec{x}}\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eの求め方ですが、偏微分を求めるときに書いたコードにちょっと付け足すだけです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eGenerateSpectrum.compute\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e..................\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enumthreads\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eGenerateSpectrumKernel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint2\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_DispatchThreadID\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ein_index\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ein_mindex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// mirrored\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eout_index\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// calculate wave vector\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eseasizeLz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// calculate dispersion w(k)\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ek_len\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e9\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e81\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eh0_k\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eh0\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ein_index\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eh0_mk\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eh0\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ein_mindex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// output frequency-space complex values\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ehtval\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecomplex_mult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh0_k\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_exp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_mult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econjugate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh0_mk\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ecomplex_exp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eht\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eout_index\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtval\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//普通の高さの逆フーリエ前\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//i*htval\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ehtval\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtval\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eht_dx\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eout_index\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e//x方向偏微分の逆フーリエ前\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eht_dz\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eout_index\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtival\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e//z方向偏微分の逆フーリエ前\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek_len\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e/=\u003c/span\u003e \u003cspan class=\"n\"\u003ek_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e/=\u003c/span\u003e \u003cspan class=\"n\"\u003ek_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003edisplaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eout_index\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ehtival\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e//Dxの逆フーリエ前\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edisplaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eout_index\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ehtival\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e//Dyの逆フーリエ前\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこれで\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e-i\\frac{\\vec{k}}{k}\\tilde{h}(\\vec{k},t)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eの部分まで求まったので、あとは3の手順でiFFTして完成です。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"数式のお気持ちを考える\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%95%B0%E5%BC%8F%E3%81%AE%E3%81%8A%E6%B0%97%E6%8C%81%E3%81%A1%E3%82%92%E8%80%83%E3%81%88%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e数式のお気持ちを考える\u003c/h3\u003e\n\n\u003cp\u003eこれで新しい座標$\\vec{x}'$を求めることができましたが、これがどんな意味があるのか少し考えてみましょう。\u003cbr\u003e\n上でも書いたよう、$\\vec{D}(\\vec{x},t)$の式は偏微分の式に酷似しています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\nabla h(\\vec{x},t)=\\sum_{\\vec{k}}i\\vec{k}\\tilde{h}(\\vec{k},t)e^{i\\vec{k}\\cdot \\vec{x}}\\\\\n\\vec{D}(\\vec{x},t)=\\sum_{\\vec{k}}-i\\frac{\\vec{k}}{k}\\tilde{h}(\\vec{k},t)e^{i\\vec{k}\\cdot \\vec{x}}\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e違うのはマイナスがかかっていることと、ベクトルの長さkで割っているところです。\u003cbr\u003e\nkで割っても正負は反転しないのでここはざっくり\"(偏微分×-1)に近い値\"として思考を進めてみます。\u003c/p\u003e\n\n\u003cp\u003e簡単に1次元として、x座標を移動させるということは、こんな形の波があったときに青丸が矢印の方向に移動することが想像できます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/9bd3dd16967bcfb8b7674179bec8db4448c4c297/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f63663734313033622d633564302d613636652d653063322d3839396364656439613333372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcf74103b-c5d0-a66e-e0c2-899cded9a337.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d88e16dd26e2efbf9a26d70dd0438876\" alt=\"Figure_2.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/cf74103b-c5d0-a66e-e0c2-899cded9a337.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fcf74103b-c5d0-a66e-e0c2-899cded9a337.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1a4245be869f3473c198660ef3dccd69 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eということは移動後は\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ef2a82db6c30ad38ec4c7280c4cd9528610a86c1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f33303935396130392d383039612d376564352d353135632d6537626437363235643931632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F30959a09-809a-7ed5-515c-e7bd7625d91c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=63797617c17d3a822b258e0782b9a9b9\" alt=\"Figure_3.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/30959a09-809a-7ed5-515c-e7bd7625d91c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F30959a09-809a-7ed5-515c-e7bd7625d91c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d1684b828941e8abfc5718c9ecd2fdcb 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nとなります。あれ、波が尖がるどころかなだらかになってるじゃないか・・・\u003c/p\u003e\n\n\u003cp\u003e次sinカーブでも同じように考えてみます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/5f8c92a7663059166b7c53b8139fea533c292be5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f66346566373531662d626338642d633832622d326561312d6634353534343463393936372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Ff4ef751f-bc8d-c82b-2ea1-f455444c9967.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c5018adaf01b12cfeeb70aff4a51aa13\" alt=\"Figure_4.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/f4ef751f-bc8d-c82b-2ea1-f455444c9967.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Ff4ef751f-bc8d-c82b-2ea1-f455444c9967.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1ce7a012a996c482c1d9d01c98abf7c4 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれが$\\lambda=1$のとき\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/4e689c7e7b530cd9e6f1de35a44fa08dd6079ff9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f30373063353264662d386438342d623436662d333962652d3130653338316334393562322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F070c52df-8d84-b46f-39be-10e381c495b2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c443c62f9626c9d5000271e06ca90850\" alt=\"Figure_5.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/070c52df-8d84-b46f-39be-10e381c495b2.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F070c52df-8d84-b46f-39be-10e381c495b2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=aa2216c17b94bb9d5de15c9990d3ef11 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nやっぱりなだらかになってる。\u003c/p\u003e\n\n\u003cp\u003eじゃあ$\\lambda=-1$にしたらどうだろう・・・\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c008899c50a4e5644177d4d94b3a22c1f318526a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f36316564616563642d653731652d656362362d343865642d3332343639363037356539342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F61edaecd-e71e-ecb6-48ed-324696075e94.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c69112a771aaaada783c9aadb33b3955\" alt=\"Figure_6.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/61edaecd-e71e-ecb6-48ed-324696075e94.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F61edaecd-e71e-ecb6-48ed-324696075e94.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f5816572d6e52f4b1bba131c35c7948c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれが正解では？？？\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"λをいじって最適なchoppy-waveを作る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%CE%BB%E3%82%92%E3%81%84%E3%81%98%E3%81%A3%E3%81%A6%E6%9C%80%E9%81%A9%E3%81%AAchoppy-wave%E3%82%92%E4%BD%9C%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eλをいじって最適なChoppy waveを作る\u003c/h3\u003e\n\n\u003cp\u003e実は論文にもほかの参考になりそうなサイトにも、λの決め方についてほとんどなにも書かれていません。まぁ適当にいじって決めてねってことなんだと思いますが、数式のお気持ちを察するに、これはマイナスの値を入れないといけないのではないでしょうか。\u003c/p\u003e\n\n\u003cp\u003e実際にやってみました。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"λ00のとき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%CE%BB00%E3%81%AE%E3%81%A8%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eλ=0.0のとき\u003c/h4\u003e\n\n\u003cp\u003eまずはコントロール\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/8b10eeb38e7db99119314b9a509c92c75a61aacb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f61383331633766382d333533372d346334332d346135372d6465613264633637623863622e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fa831c7f8-3537-4c43-4a57-dea2dc67b8cb.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=84fb684602b168afca8a532dd9f42787\" alt=\"l0.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/a831c7f8-3537-4c43-4a57-dea2dc67b8cb.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fa831c7f8-3537-4c43-4a57-dea2dc67b8cb.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=3f8ff74fedd01324aedcac1f1b5cf79b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"λ20のとき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%CE%BB20%E3%81%AE%E3%81%A8%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eλ=2.0のとき\u003c/h4\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/1d38e71b0a3ba67a1059709e16c7cd010a6bc91c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f35356638373866652d643433332d663963382d666236362d3937393535653430633433622e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F55f878fe-d433-f9c8-fb66-97955e40c43b.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=9402c548863258b53fb1306aad55e373\" alt=\"l2.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/55f878fe-d433-f9c8-fb66-97955e40c43b.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F55f878fe-d433-f9c8-fb66-97955e40c43b.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=3941f729530a9f6949aeecce0fe3c1d8 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n表面が丸くなってる？\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"λ-20のとき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%CE%BB-20%E3%81%AE%E3%81%A8%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eλ=-2.0のとき\u003c/h4\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/3b69ca2a52e50494e72260fadaa4e8f52f64b1dc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32616334356134352d383163622d643639652d623235322d3330613533353430656632372e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2ac45a45-81cb-d69e-b252-30a53540ef27.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=abda0024af7b5df6658ad81daf2a57b0\" alt=\"lm2.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/2ac45a45-81cb-d69e-b252-30a53540ef27.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2ac45a45-81cb-d69e-b252-30a53540ef27.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b0c3f436f2c18619cb8bafe78c891463 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれだよこれ！\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"λ90のとき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%CE%BB90%E3%81%AE%E3%81%A8%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eλ=9.0のとき\u003c/h4\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/c1724e3e26a9541bd46629781c24d1bcd13d9364/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f62666161373436332d396235342d366332642d363263642d3165316237303339613165332e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fbfaa7463-9b54-6c2d-62cd-1e1b7039a1e3.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=63ce32143b0329344c8d52468a5137e5\" alt=\"l9.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/bfaa7463-9b54-6c2d-62cd-1e1b7039a1e3.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fbfaa7463-9b54-6c2d-62cd-1e1b7039a1e3.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6189788aa95c9f115a441ce29401215a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれはなんですか？\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"λ-90のとき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%CE%BB-90%E3%81%AE%E3%81%A8%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eλ=-9.0のとき\u003c/h4\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/0f6ea8d398c796e16dcf8f30adac751eac138ff2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f30366264643464312d393936642d353464642d663035612d6439666632373562656239612e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F06bdd4d1-996d-54dd-f05a-d9ff275beb9a.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5cf9ebcb76dbc446f561d9672d6bffdd\" alt=\"lm9.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/06bdd4d1-996d-54dd-f05a-d9ff275beb9a.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F06bdd4d1-996d-54dd-f05a-d9ff275beb9a.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6cba165188a79834c9ae211e6419d137 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n何事もやりすぎはよくないということですね\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"やっぱり\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%84%E3%81%A3%E3%81%B1%E3%82%8A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eやっぱり\u003c/h4\u003e\n\n\u003cp\u003eλはマイナスの数字を入れることで波を尖がらせることができ、プラスの値をいれると滑らかにすることができます。と私は理解しています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"法線を修正\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B3%95%E7%B7%9A%E3%82%92%E4%BF%AE%E6%AD%A3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e法線を修正\u003c/h3\u003e\n\n\u003cp\u003eさて、x,zの位置がずれたことで海面の傾きが変わったので法線も今までの値を使うことはできません。\u003c/p\u003e\n\n\u003cp\u003e今のところchoppy waveを実装して海面の法線をまじめに計算しているコードは中国語の \u003ca href=\"https://zhuanlan.zhihu.com/p/96811613\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://zhuanlan.zhihu.com/p/96811613\u003c/a\u003e ここで紹介されてる \u003ca href=\"https://github.com/Straw1997/FFTOcean\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/Straw1997/FFTOcean\u003c/a\u003e にupされてるコードしか確認できませんでした (探せばほかにもあるかもしれませんが)。\u003c/p\u003e\n\n\u003cp\u003eこの方のコードをみると、x,z座標を動かあした後 中心差分で求めているようでした。しかしそもそも海面の高さをhtの実数じゃなくて複素数の絶対値で求めていたり、ちょっと私のやり方とは違うので参考にはできませんでした。\u003c/p\u003e\n\n\u003cp\u003eそこで私オリジナルのやり方になりますが、下記のような方法で実装してみました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSetNormal.compute\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#pragma kernel SetNormal\n\u003c/span\u003e\u003cspan class=\"n\"\u003eRWTexture2D\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat4\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eht_dx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eht_dz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enumthreads\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eSetNormal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint2\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_DispatchThreadID\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003esubx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eht_dx\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003esubz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eht_dz\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//displaceXZだけ定義点が移動することを考えここで傾きをさらにいじる\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esubx\u003c/span\u003e \u003cspan class=\"o\"\u003e*=\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003edisplaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esubz\u003c/span\u003e \u003cspan class=\"o\"\u003e*=\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003edisplaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey1\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003evec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enormalize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003esubx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003esubz\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003eout4\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eout4\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exyz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003evec\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eout4\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e考え方としてはこんな感じ。解説図では$\\lambda=1$として省略してます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/804da318b48084920411238719aba0d25ae8f61d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f30373433623430622d663131342d626538332d646265302d6635356139643533623730332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F0743b40b-f114-be83-dbe0-f55a9d53b703.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=925ed04198023dd399d6943782581550\" alt=\"Figure_7.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/0743b40b-f114-be83-dbe0-f55a9d53b703.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F0743b40b-f114-be83-dbe0-f55a9d53b703.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=48f5ed0d30a72916198e1d25d0fe4011 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\ndisplaceXの分だけ点が動いて線の傾きかたが圧縮、拡張されるというイメージです。\u003c/p\u003e\n\n\u003cp\u003eこれらを適応して$\\lambda=-2$としたコードがこちら。\u003c/p\u003e\n\n\u003cp\u003egithub\u003cbr\u003e\n\u003ca href=\"https://github.com/toropippi/OceanFFT/tree/main/OceanFFT5ChoppyWave\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/toropippi/OceanFFT/tree/main/OceanFFT5ChoppyWave\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eちなみに見た目はほとんど変わりませんでした。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/290541c30097619210b5b1d36bb5988052cc6e88/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f37643761303863352d616566312d353634622d373861382d6135313065646530663263612e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F7d7a08c5-aef1-564b-78a8-a510ede0f2ca.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=39853b0da7448c6687896d4b2f41faac\" alt=\"ezgif-4-0622a24ac01b.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/7d7a08c5-aef1-564b-78a8-a510ede0f2ca.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F7d7a08c5-aef1-564b-78a8-a510ede0f2ca.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=ada607f81def9e966930ab951b8c2dbb 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eま、十分綺麗なのでいいでしょう。\u003c/p\u003e\n\n\u003cp\u003eここで、波のポリゴンが交差してるのが見えるでしょうか。画面左と、左奥の2か所です。これがchoppy waveの恩恵で、今回の実装で相当リアルになってきたのがわかると思います。\u003cbr\u003e\n実際自分も実装していて、この絵が作れた時はかなりテンションあがりました。それまでは確かにのぺっとしていて、ちょっとおかしいなって感じはありました。\u003cbr\u003e\nここまでくるとFFT Oceanの実装で一番重要なのってここなんじゃ・・・？とすら思います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"泡表現bubbles\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B3%A1%E8%A1%A8%E7%8F%BEbubbles\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e泡表現(bubbles)\u003c/h2\u003e\n\n\u003cp\u003eさっき波ポリゴンが重なるといいましたが、今度はこの重なりを検出して泡を表現しようという話です。\u003c/p\u003e\n\n\u003cp\u003eこの検出にも$\\vec{D}(\\vec{x},t)$を使います。(プログラムでいうとdisplaceX,displaceZ)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eJ=J_{xx}J_{zz}-J_{xz}J_{zx}\\\\\nJ_{xx}=1+\\lambda\\frac{\\partial D_x(\\vec{x},t)}{\\partial x}\\\\\nJ_{zz}=1+\\lambda\\frac{\\partial D_z(\\vec{x},t)}{\\partial z}\\\\\nJ_{xz}=\\lambda\\frac{\\partial D_x(\\vec{x},t)}{\\partial z}\\\\\nJ_{zx}=\\lambda\\frac{\\partial D_z(\\vec{x},t)}{\\partial x}\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのJの正負がマイナスのとき、その場所で重なり(反転)が起きていることになります。\u003cbr\u003e\nしたがってこんなコードになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSetNormal.compute\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#pragma kernel SetNormalBubble\n\u003c/span\u003e\u003cspan class=\"n\"\u003eRWTexture2D\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat4\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003enormalTex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWTexture2D\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebubbleTex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eht_dx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eht_dz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eRWStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enumthreads\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eSetNormalBubble\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euint2\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_DispatchThreadID\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey0\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ey1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edDxdx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edisplaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//中心差分\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edDzdz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edisplaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey1\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//中心差分\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edDxdz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edisplaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey1\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ey0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//中心差分\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edDzdx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edisplaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003edisplaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//中心差分\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003egradx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eht_dx\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003egradz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eht_dz\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//displaceXZだけ定義点が移動することを考えここで傾きをさらにいじる\u003c/span\u003e\n    \u003cspan class=\"n\"\u003egradx\u003c/span\u003e \u003cspan class=\"o\"\u003e*=\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edDxdx\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003egradz\u003c/span\u003e \u003cspan class=\"o\"\u003e*=\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edDzdz\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003evec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enormalize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003egradx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003egradz\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003eout4\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eout4\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exyz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003evec\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enormalTex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eout4\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//Jの計算\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eJxx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edDxdx\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eJzz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edDzdz\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eJxz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edDxdz\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eJzx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edDzdx\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eJ\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eJxx\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eJzz\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eJxz\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eJzx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//J\u0026lt;0なら面が裏返しになってる\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ebubbleTex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eJ\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eレンダリング側\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"glsl\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSurfaceShader.shader\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eShader\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Custom/SurfaceShader\"\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eProperties\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_MainTexN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"-\"\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"n\"\u003eD\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"black\"\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_MainTexB\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"-\"\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"n\"\u003eD\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"black\"\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eSubShader\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ePass\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eCGPROGRAM\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// シェーダーモデルは5.0を指定\u003c/span\u003e\n            \u003cspan class=\"cp\"\u003e#pragma target 5.0\n\u003c/span\u003e            \u003cspan class=\"cp\"\u003e#pragma vertex vert\n\u003c/span\u003e            \u003cspan class=\"cp\"\u003e#pragma fragment frag\n\u003c/span\u003e            \u003cspan class=\"cp\"\u003e#include \"UnityCG.cginc\"\n\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003esampler2D\u003c/span\u003e \u003cspan class=\"n\"\u003e_MainTexN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003esampler2D\u003c/span\u003e \u003cspan class=\"n\"\u003e_MainTexB\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ed_displaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eStructuredBuffer\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ed_displaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ehalfN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eGet_d_ht_real\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ed_ht\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eGet_d_displaceXZ\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ed_displaceX\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ed_displaceZ\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elambda\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eVSOut\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_POSITION\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003epos2\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eTEXCOORD2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e \u003cspan class=\"n\"\u003euv\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eTEXCOORD0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 頂点シェーダ、1つの4角形ポリゴンに頂点4つ\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVSOut\u003c/span\u003e \u003cspan class=\"n\"\u003evert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSV_VertexID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003enormal\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eNORMAL\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVSOut\u003c/span\u003e \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003esqx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//連続するid4つで四角形を作る\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003esqz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esqx\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esqz\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGet_d_ht_real\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esqx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esqz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003esqx\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ehalfN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esqz\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ehalfN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//4角形\u003c/span\u003e\n        \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exz\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003eGet_d_displaceXZ\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esqx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esqz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exyz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emul\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUNITY_MATRIX_VP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003erN1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esqx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esqz\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003erN1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efloat2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003erN1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kr\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// ピクセルシェーダー\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ワールド座標系がよくわからないのでレイトレーシング的に色を決定している(要修正)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003efrag\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVSOut\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eCOLOR\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat4\u003c/span\u003e \u003cspan class=\"n\"\u003ecol\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ecol\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003enormal\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enormalize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etex2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_MainTexN\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003exyz\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//線形補完されて単位ベクトルじゃなくなっているので\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003eviewDir\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enormalize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epos2\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e41\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e330\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"c1\"\u003e//ここはMain Cameraの座標を埋め込み\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003elightDir\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enormalize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloat3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e15\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e45\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"c1\"\u003e//ライトベクトルも埋め込み\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003ereflectDir\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edot\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enormal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eviewDir\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003enormal\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eviewDir\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edot\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereflectDir\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elightDir\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e \u003cspan class=\"n\"\u003esky\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e105\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e133\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e184\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//空の色も埋め込み、しかも単色\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003efresnel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mo\"\u003e05\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mo\"\u003e05\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003epow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edot\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enormal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eviewDir\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecol\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exyz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esky\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003efresnel\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003efresnel\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mo\"\u003e01\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e13\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e15\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//海の色も埋め込み\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecol\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exyz\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003epow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e649\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e86\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//太陽の色も埋め込み\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//泡\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ebubble\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etex2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_MainTexB\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euv\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebubble\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebubble\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ebubble\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//裏返り度合いに応じて徐々に白くなる\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecol\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exyz\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebubble\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003efloat3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ebubble\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecol\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003exyz\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ecol\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eENDCG\u003c/span\u003e\n \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e結果\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/edaedb8253279c70ec45b071980f5cec50227c8b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f37306137636463332d333862612d366338372d306465392d3432353035343233643031382e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F70a7cdc3-38ba-6c87-0de9-42505423d018.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=9f87d8838abfef951d8ad12a2fc99075\" alt=\"LjjFC1W1vV33n67B.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/70a7cdc3-38ba-6c87-0de9-42505423d018.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F70a7cdc3-38ba-6c87-0de9-42505423d018.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b2a7997b21c15a1c638d35ed07469473 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003egithub\u003cbr\u003e\n\u003ca href=\"https://github.com/toropippi/OceanFFT/tree/main/OceanFFT6Bubbles\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/toropippi/OceanFFT/tree/main/OceanFFT6Bubbles\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e波のてっぺん付近が白く着色されているのがわかります。波の先端、特にとがっているところは海面が90度以上傾いていることがあります。それを先ほどの計算で検出し、泡としてレンダリングしたということになります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/c8c5967d4d757eecda19185b63d1e88fb2b4104d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3232373336312f32636532623061662d666661352d643134342d313164362d6135336563656234323834352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2ce2b0af-ffa5-d144-11d6-a53eceb42845.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a456053a9aeb25e01360c7e5e718a3ff\" alt=\"fig20choppysurface.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/2ce2b0af-ffa5-d144-11d6-a53eceb42845.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2F2ce2b0af-ffa5-d144-11d6-a53eceb42845.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e44472664e3f9759097db99c6eaa7845 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e論文のFigureがわかりやすいかなと思ったのですが、Choppy Surfaceと書いてある波はよく目を凝らしてみるとPosition=15付近でぐるっと回っているのがわかります。これに対しMinimum E-value(最小固有値)がそこで0を下回っているというのが読み取れます。\u003cbr\u003e\n論文では、最大固有値は常に正で最小固有値は図のように負になるから、最大固有値×最小固有値がマイナスなのを確認できれば検出できるよねと言ってます。プログラムでは$Jxx,Jxz,Jzx,Jzz$の2*2の行列の行列式を求めることで、この最大固有値×最小固有値がマイナスかどうかを判定しています。(というか参考にしたコードがそういうコードだった)\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"おしまい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%81%97%E3%81%BE%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおしまい\u003c/h2\u003e\n\n\u003cp\u003e以上です。お疲れ様でした。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"残った課題を箇条書きで\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%AE%8B%E3%81%A3%E3%81%9F%E8%AA%B2%E9%A1%8C%E3%82%92%E7%AE%87%E6%9D%A1%E6%9B%B8%E3%81%8D%E3%81%A7\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e残った課題を箇条書きで\u003c/h3\u003e\n\n\u003cp\u003e・Shaderの要修正の部分はそのうち修正してgithubに\u003cbr\u003e\n・泡のレンダリングもうちょっと頑張れるはず\u003cbr\u003e\n・Donelan-Banner調べる\u003cbr\u003e\n・海面をループさせて無限海面に、遠くはLODで\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"解決した課題を箇条書きで\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A7%A3%E6%B1%BA%E3%81%97%E3%81%9F%E8%AA%B2%E9%A1%8C%E3%82%92%E7%AE%87%E6%9D%A1%E6%9B%B8%E3%81%8D%E3%81%A7\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e解決した課題を箇条書きで\u003c/h3\u003e\n\n\u003cp\u003e・FFTの計算部分は2倍高速化できる。海面の高さはFFTの計算結果のうち実数しか使わないので、実数FFTの逆の手順を行うことで1/2のサイズのFFTで済む。\u003ca href=\"https://xn--w6q13e505b.jp/method/fft/rft.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e円周率.jpの実数FFTの説明\u003c/a\u003eを参考に\u003ca href=\"https://github.com/toropippi/fft_r2c_c2r\" rel=\"nofollow noopener\" target=\"_blank\"\u003e複素数→実数FFTのC++コード\u003c/a\u003eを書いたのでこれを参考に。ただ並列化しにくい部分があるのでComputeShaderへの適応はよく考える必要がある。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"参考文献\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考文献\u003c/h1\u003e\n\n\u003cp\u003e一番参考にした中国語の解説\u003cbr\u003e\n\u003ca href=\"https://zhuanlan.zhihu.com/p/96811613\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://zhuanlan.zhihu.com/p/96811613\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://zhuanlan.zhihu.com/p/64414956\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://zhuanlan.zhihu.com/p/64414956\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://zhuanlan.zhihu.com/p/95482541\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://zhuanlan.zhihu.com/p/95482541\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/Straw1997/FFTOcean\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/Straw1997/FFTOcean\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e論文pdf\u003cbr\u003e\n\u003ca href=\"https://evasion.imag.fr/Membres/Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/simulating-ocean-water-01.pdf\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://evasion.imag.fr/Membres/Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/simulating-ocean-water-01.pdf\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eNV_OceanCS_Slides\u003cbr\u003e\n\u003ca href=\"http://www-evasion.imag.fr/~Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/NV_OceanCS_Slides.pdf\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://www-evasion.imag.fr/~Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/NV_OceanCS_Slides.pdf\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eUE4で海面シミュレーションと描画を行う at Qiita\u003cbr\u003e\n\u003ca href=\"https://qiita.com/monguri/items/3ad184c3316343c635f5\" class=\"autolink\" id=\"reference-23b5990ff24fd4804f15\"\u003ehttps://qiita.com/monguri/items/3ad184c3316343c635f5\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eその他英語スライドなど\u003cbr\u003e\n\u003ca href=\"http://developer.download.nvidia.com/assets/gameworks/downloads/regular/events/cgdc15/CGDC2015_ocean_simulation_en.pdf\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://developer.download.nvidia.com/assets/gameworks/downloads/regular/events/cgdc15/CGDC2015_ocean_simulation_en.pdf\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"http://evasion.imag.fr/~Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/waterslides2001.pdf\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://evasion.imag.fr/~Fabrice.Neyret/images/fluids-nuages/waves/Jonathan/articlesCG/waterslides2001.pdf\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://www.slideshare.net/Codemotion/an-introduction-to-realistic-ocean-rendering-through-fft-fabio-suriano-codemotion-rome-2017\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.slideshare.net/Codemotion/an-introduction-to-realistic-ocean-rendering-through-fft-fabio-suriano-codemotion-rome-2017\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e参考にしたコード\u003cbr\u003e\n\u003ca href=\"https://github.com/nobnak/FftUnity\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/nobnak/FftUnity\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/gasgiant/FFT-Ocean\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/gasgiant/FFT-Ocean\u003c/a\u003e\u003c/p\u003e\n","createdAt":"2020-12-09T07:16:24Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"BkDKfivz/3aAa+7bh48pgBVp+alY2hNq8Q==--ZzrS/rYN4/qGYzZP--44djbSr7IsdbKl7io+j/aQ==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-02-26T11:02:51Z","likesCount":124,"linkUrl":"https://qiita.com/Red_Black_GPGPU/items/2652f5bfd6d311d2034b","organization":null,"originalId":1353907,"stockedCount":103,"title":"[Unity] 海洋シミュレーションFFT Oceanを実装したい","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#fft-ocean%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eFFT Oceanについて\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#0%E6%A6%82%E8%A6%81%E3%82%92%E3%81%96%E3%81%A3%E3%81%8F%E3%82%8A%E3%81%A8\"\u003e0.概要をざっくりと\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#1%E4%BA%8B%E5%89%8D%E8%A8%88%E7%AE%97%E3%81%A7h0k%E3%82%92cpu%E3%81%A7%E8%A8%88%E7%AE%97%E3%81%97gpu%E4%B8%8A%E3%81%AE%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E8%BC%89%E3%81%9B%E3%81%A6%E3%81%8A%E3%81%8F\"\u003e1.事前計算でh0(k)をCPUで計算しGPU上のメモリに載せておく\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#k%E3%81%AE%E5%AE%9A%E7%BE%A9\"\u003eKの定義\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%AD%A3%E8%A6%8F%E5%88%86%E5%B8%83%E3%81%AB%E5%9F%BA%E3%81%A5%E3%81%8F%E4%B9%B1%E6%95%B0\"\u003e正規分布に基づく乱数\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#phillips-spectrum\"\u003ePhillips Spectrum\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%99%E8%AB%87-w_dot_k%E3%81%AE6%E4%B9%97%E3%81%AE%E3%81%A8%E3%81%8D\"\u003e余談 w_dot_kの6乗のとき\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%99%E8%AB%87-donelan-banner%E3%81%A8%E3%81%84%E3%81%86%E3%83%AF%E3%83%BC%E3%83%89\"\u003e余談 Donelan-Bannerというワード\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2%E3%81%9D%E3%82%8C%E3%82%92%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E6%AF%8E%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0hkt%E3%82%92gpu%E4%B8%8A%E3%81%A7%E7%94%9F%E6%88%90t%E3%81%AFtime\"\u003e2.それをベースに毎フレームh(k,t)をGPU上で生成(tはtime)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#in_mindex%E3%81%AE%E8%A8%88%E7%AE%97\"\u003ein_mindexの計算\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#dispatch%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eDispatchグループ数について\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3gpu%E4%B8%8A%E3%81%A7%E9%80%86%E3%83%95%E3%83%BC%E3%83%AA%E3%82%A8%E5%A4%89%E6%8F%9B%E3%82%92%E3%81%97%E3%81%A6%E5%8F%B3%E3%81%AE%E7%94%BB%E5%83%8F%E6%B5%B7%E9%9D%A2%E3%81%AE%E9%AB%98%E3%81%95%E3%82%92%E7%94%9F%E6%88%90\"\u003e3.GPU上で逆フーリエ変換をして右の画像(=海面の高さ)を生成\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#2%E6%AC%A1%E5%85%83fft\"\u003e2次元FFT\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%83%8A%E3%82%B9%E5%91%A8%E6%B3%A2%E6%95%B0%E6%88%90%E5%88%86%E3%81%8B%E3%82%89%E5%A7%8B%E3%81%BE%E3%82%8B%E3%82%B9%E3%83%9A%E3%82%AF%E3%83%88%E3%83%AB%E3%81%AEifft\"\u003eマイナス周波数成分から始まるスペクトルのiFFT\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%80%E5%BF%9C%E8%A8%BC%E6%98%8E\"\u003e一応証明\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4%E5%8F%B3%E3%81%AE%E7%94%BB%E5%83%8F%E3%81%8B%E3%82%89%E5%AE%9F%E9%9A%9B%E3%81%AE%E4%BD%8D%E7%BD%AE%E3%81%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0\"\u003e4.右の画像から実際の位置にレンダリング\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C\"\u003e実行結果\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B3%95%E7%B7%9A%E3%82%92%E8%A8%88%E7%AE%97\"\u003e法線を計算\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%AD%E5%BF%83%E5%B7%AE%E5%88%86%E3%81%A7%E7%AE%97%E5%87%BA\"\u003e中心差分で算出\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%81%8F%E5%BE%AE%E5%88%86%E3%81%A7%E8%A7%A3%E6%9E%90%E7%9A%84%E3%81%AB%E7%AE%97%E5%87%BA\"\u003e偏微分で解析的に算出\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%82%E3%81%86%E3%81%A1%E3%82%87%E3%81%A3%E3%81%A8%E3%83%A9%E3%82%A4%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%92%E9%A0%91%E5%BC%B5%E3%82%8B\"\u003eもうちょっとライティングを頑張る\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#choppy-wave\"\u003eChoppy wave\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%95%B0%E5%BC%8F%E3%81%AE%E3%81%8A%E6%B0%97%E6%8C%81%E3%81%A1%E3%82%92%E8%80%83%E3%81%88%E3%82%8B\"\u003e数式のお気持ちを考える\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%CE%BB%E3%82%92%E3%81%84%E3%81%98%E3%81%A3%E3%81%A6%E6%9C%80%E9%81%A9%E3%81%AAchoppy-wave%E3%82%92%E4%BD%9C%E3%82%8B\"\u003eλをいじって最適なChoppy waveを作る\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%CE%BB00%E3%81%AE%E3%81%A8%E3%81%8D\"\u003eλ=0.0のとき\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%CE%BB20%E3%81%AE%E3%81%A8%E3%81%8D\"\u003eλ=2.0のとき\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%CE%BB-20%E3%81%AE%E3%81%A8%E3%81%8D\"\u003eλ=-2.0のとき\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%CE%BB90%E3%81%AE%E3%81%A8%E3%81%8D\"\u003eλ=9.0のとき\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%CE%BB-90%E3%81%AE%E3%81%A8%E3%81%8D\"\u003eλ=-9.0のとき\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%84%E3%81%A3%E3%81%B1%E3%82%8A\"\u003eやっぱり\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B3%95%E7%B7%9A%E3%82%92%E4%BF%AE%E6%AD%A3\"\u003e法線を修正\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B3%A1%E8%A1%A8%E7%8F%BEbubbles\"\u003e泡表現(bubbles)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%81%97%E3%81%BE%E3%81%84\"\u003eおしまい\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%AE%8B%E3%81%A3%E3%81%9F%E8%AA%B2%E9%A1%8C%E3%82%92%E7%AE%87%E6%9D%A1%E6%9B%B8%E3%81%8D%E3%81%A7\"\u003e残った課題を箇条書きで\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A7%A3%E6%B1%BA%E3%81%97%E3%81%9F%E8%AA%B2%E9%A1%8C%E3%82%92%E7%AE%87%E6%9D%A1%E6%9B%B8%E3%81%8D%E3%81%A7\"\u003e解決した課題を箇条書きで\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"\u003e参考文献\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":12191,"uuid":"2652f5bfd6d311d2034b","banReason":null,"adventCalendarItem":{"day":9,"calendar":{"name":"Unity #3","urlName":"unity3","year":2020,"organization":null}},"author":{"encryptedId":"8fnhZy4yuJkX5PGTIBocsGJcvqp0--/dmxo1GZeI1gWw1G--Kx7YOD/jeb71z9MuABypYg==","originalId":227361,"description":"GPGPUでいろいろやりたくてさまよっている人です。","facebookUrl":null,"githubUrl":"https://github.com/toropippi","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/227361/profile-images/1570536563","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fprofile-images%2F1570536563?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=1e8613b9371c45a4640e74118ebc86e0","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F227361%2Fprofile-images%2F1570536563?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=09ca64e33bfb58d31bd1925c4a039826","urlName":"Red_Black_GPGPU","websiteUrl":"","twitterUrl":"https://twitter.com/Red_Black_GPGPU","twitterUrlName":"Red_Black_GPGPU","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"},{"name":"GPGPU","urlName":"gpgpu"},{"name":"FFT","urlName":"fft"},{"name":"ComputeShader","urlName":"computeshader"}],"followingLikers":{"edges":[]},"comments":{"totalCount":4}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
