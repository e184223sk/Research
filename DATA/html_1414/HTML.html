<!DOCTYPE html><html><head><meta charset="utf-8" /><title>格闘ゲームのコマンド判定をReactiveに書いてみた - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/rita0222/items/c67338cd7f8ca9ac11af" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="NwvWtAoIMVRI89UCZNKB2pw3/z+87ISkLBxaud9vrE7dDLHLRqVH3dZla0OiB4adxXIwTt7Aw2E5Ol6TwXmRyg==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="格闘ゲームのコマンド判定をReactiveに書いてみた - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND01cUM4NlplWTQ0S3k0NE84NDRPZzQ0R3U0NEt6NDRPZTQ0T3o0NE9KNVlpazVhNmE0NEtTVW1WaFkzUnBkbVhqZ2F2bW03ampnWVRqZ2FiamdiX2pnWjgmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZWRhYzM0NDRkOTdiMzdiNDg2MWUzYTJkNWNkNGMxYTA&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSEpwZEdFd01qSXkmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz02NjQ5MjcxNzQyZDdkOWY5Y2ViMzE4MGI4MDM5NWRmNQ&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=19eda20652e0ddfdcf76dccb74fa8c1a"><meta property="og:description" content="

動機

Rxの解説などを見ると、だいたい「イベントのLinq化」「断続的なメッセージをストリームとして」「フィルタ、合成、変換といったオペレータを」などなどの文言が並びます。初見ではなかなか理解が難しいかも知れません。私もそうでし..."><meta content="https://qiita.com/rita0222/items/c67338cd7f8ca9ac11af" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,game,ReactiveExtensions,input" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-d05d850a-c6e8-4962-b140-801979fc71c3"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Frita0222%2Fitems%2Fc67338cd7f8ca9ac11af">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Frita0222%2Fitems%2Fc67338cd7f8ca9ac11af">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-d05d850a-c6e8-4962-b140-801979fc71c3">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-05-07T18:05:57.000+09:00","dateModified":"2020-05-12T00:26:49.000+09:00","headline":"格闘ゲームのコマンド判定をReactiveに書いてみた","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND01cUM4NlplWTQ0S3k0NE84NDRPZzQ0R3U0NEt6NDRPZTQ0T3o0NE9KNVlpazVhNmE0NEtTVW1WaFkzUnBkbVhqZ2F2bW03ampnWVRqZ2FiamdiX2pnWjgmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZWRhYzM0NDRkOTdiMzdiNDg2MWUzYTJkNWNkNGMxYTA\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSEpwZEdFd01qSXkmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz02NjQ5MjcxNzQyZDdkOWY5Y2ViMzE4MGI4MDM5NWRmNQ\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=19eda20652e0ddfdcf76dccb74fa8c1a","mainEntityOfPage":"https://qiita.com/rita0222/items/c67338cd7f8ca9ac11af","author":{"@type":"Person","address":"","email":null,"identifier":"rita0222","name":"rita0222","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F58083%2Fprofile-images%2F1478538396?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=436812485ffbd2258edea3e289914295","url":"https://qiita.com/rita0222","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"rita0222","type":"items","id":"c67338cd7f8ca9ac11af"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"rita0222","type":"items","id":"c67338cd7f8ca9ac11af"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"rita0222","type":"items","id":"c67338cd7f8ca9ac11af"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/rita0222/items/c67338cd7f8ca9ac11af","location":"/rita0222/items/c67338cd7f8ca9ac11af","scheme":"https","host":"qiita.com","port":null,"pathname":"/rita0222/items/c67338cd7f8ca9ac11af","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"RIQQz46KYLQ+3pJFkEeMvK+v6xLfJdEEbxhdBRNnyaaug3ewwicWPaBILARWkov79uokY70JlsF6PlkvDXH0Ig==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-46b1095b-b75b-4889-b91d-02587e437d6a"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/rita0222/items/c67338cd7f8ca9ac11af/likers" class="css-1iupg5d">69</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">55</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/c67338cd7f8ca9ac11af/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/rita0222/items/c67338cd7f8ca9ac11af/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/rita0222/items/c67338cd7f8ca9ac11af/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/rita0222/items/c67338cd7f8ca9ac11af/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/rita0222/items/c67338cd7f8ca9ac11af.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/rita0222"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/58083/profile-images/1478538396" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/rita0222" class="css-10ougpm">@<!-- -->rita0222</a><div class="css-1ay9vb9"><span><meta content="2020-05-07T09:05:57Z"/><time dateTime="2020-05-11T15:26:49Z" class="css-m19uds">updated at 2020-05-11</time></span></div></div></div></div></div><h1 class="css-cgzq40">格闘ゲームのコマンド判定をReactiveに書いてみた</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/game" class="css-4czcte">game</a><a href="/tags/reactiveextensions" class="css-4czcte">ReactiveExtensions</a><a href="/tags/input" class="css-4czcte">input</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="動機" class="fragment"></span><a href="#%E5%8B%95%E6%A9%9F"><i class="fa fa-link"></i></a>動機</h1>

<p>Rxの解説などを見ると、だいたい「イベントのLinq化」「断続的なメッセージをストリームとして」「フィルタ、合成、変換といったオペレータを」などなどの文言が並びます。初見ではなかなか理解が難しいかも知れません。私もそうでした。<br>
ただ、下手くそながらも格闘ゲームを愛する1人として、ピンと来るモノがありました。</p>

<p><strong>これ、コマンドの入力判定に使えるんじゃね？</strong></p>

<p>思い立ったらやってみよう！ということで、Rxを駆使してコマンド入力判定処理を作ってみます。</p>

<h1>
<span id="更新履歴" class="fragment"></span><a href="#%E6%9B%B4%E6%96%B0%E5%B1%A5%E6%AD%B4"><i class="fa fa-link"></i></a>更新履歴</h1>

<ul>
<li>レバー1回転とタメ系のコマンドに対応しました(2020/5/11)</li>
</ul>

<h1>
<span id="下ごしらえ" class="fragment"></span><a href="#%E4%B8%8B%E3%81%94%E3%81%97%E3%82%89%E3%81%88"><i class="fa fa-link"></i></a>下ごしらえ</h1>

<p>とりあえず、Windows環境でSharpDX + Reactive Extensionsという構成で作っていきます。Unityだったら、UniRxを使えば多分同じことはできるでしょう。</p>

<p>まずはゲームパッドの入力をObserveできるようにします。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">InputManager</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">struct</span> <span class="nc">KeyInfo</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">char</span> <span class="n">Key</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">bool</span> <span class="n">State</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">Frame</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Subject</span><span class="p">&lt;</span><span class="n">KeyInfo</span><span class="p">&gt;</span> <span class="n">_keyStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="p">&lt;</span><span class="n">KeyInfo</span><span class="p">&gt;();</span>
        <span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">KeyInfo</span><span class="p">&gt;</span> <span class="n">KeyStream</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">_keyStream</span><span class="p">.</span><span class="nf">AsObservable</span><span class="p">();</span>

        <span class="k">private</span> <span class="kt">int</span> <span class="n">frame</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>入力の変化を<code>KeyStream</code>という<code>IObservable</code>に通知することにします。通知を行う<code>Subject</code>はバッキングフィールドとして<code>private</code>にしておき、外部には<code>AsObservable()</code>してプロパティとして公開します。</p>

<p>通知する情報は<code>KeyInfo</code>という型で定義しました。どのキーの情報か(<code>Key</code>)、押されたのか離されたのか(<code>State</code>)、何フレーム目に発生したのか(<code>Frame</code>)の3つです。後で改修したくなりそうな気もしますが、とりあえずこれで行きましょう。</p>

<p>Rxでは通知した値に対してタイムスタンプを付ける機能がありますが、格闘ゲームではフレーム数の方が信頼できる情報だろうということで、自前で持たせるようにしています。フレーム数のオーバーフローについてはケアする必要がありそうですが、今回は割愛します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">InputManager</span>
    <span class="p">{</span>
        <span class="c1">// 前述したクラスのメンバは省略</span>

        <span class="k">private</span> <span class="n">Joystick</span> <span class="n">pad</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">JoystickState</span> <span class="n">prevState</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">JoystickState</span><span class="p">();</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">pad</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="k">this</span><span class="p">.</span><span class="n">pad</span><span class="p">.</span><span class="nf">Acquire</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="n">pad</span><span class="p">.</span><span class="nf">Poll</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">pad</span><span class="p">.</span><span class="nf">GetCurrentState</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">X</span> <span class="p">!=</span> <span class="k">this</span><span class="p">.</span><span class="n">prevState</span><span class="p">.</span><span class="n">X</span> <span class="p">||</span> <span class="n">state</span><span class="p">.</span><span class="n">Y</span> <span class="p">!=</span> <span class="k">this</span><span class="p">.</span><span class="n">prevState</span><span class="p">.</span><span class="n">Y</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">X</span> <span class="p">&gt;</span> <span class="m">300</span><span class="p">)</span> <span class="k">value</span> <span class="p">+=</span> <span class="m">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">X</span> <span class="p">&lt;</span> <span class="p">-</span><span class="m">300</span><span class="p">)</span> <span class="k">value</span> <span class="p">-=</span> <span class="m">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">Y</span> <span class="p">&lt;</span> <span class="p">-</span><span class="m">300</span><span class="p">)</span> <span class="k">value</span> <span class="p">+=</span> <span class="m">3</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">Y</span> <span class="p">&gt;</span> <span class="m">300</span><span class="p">)</span> <span class="k">value</span> <span class="p">-=</span> <span class="m">3</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="n">_keyStream</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyInfo</span>
                <span class="p">{</span>
                    <span class="n">Key</span> <span class="p">=</span> <span class="k">value</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()[</span><span class="m">0</span><span class="p">],</span>
                    <span class="n">State</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                    <span class="n">Frame</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">frame</span><span class="p">,</span>
                <span class="p">});</span>
            <span class="p">}</span>

            <span class="kt">char</span><span class="p">[]</span> <span class="n">buttonName</span> <span class="p">=</span> <span class="p">{</span> <span class="sc">'A'</span><span class="p">,</span> <span class="sc">'B'</span><span class="p">,</span> <span class="sc">'C'</span><span class="p">,</span> <span class="sc">'D'</span> <span class="p">};</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">4</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">Buttons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">!=</span> <span class="k">this</span><span class="p">.</span><span class="n">prevState</span><span class="p">.</span><span class="n">Buttons</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="n">_keyStream</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyInfo</span>
                    <span class="p">{</span>
                        <span class="n">Key</span> <span class="p">=</span> <span class="n">buttonName</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">Buttons</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">Frame</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">frame</span><span class="p">,</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="n">prevState</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
            <span class="p">++</span><span class="k">this</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><code>JoyStick</code>の初期化はコンストラクタあたりでやっておくとして、毎フレーム状態をポーリングしつつ、変化があったら<code>KeyStream</code>に対して値を発行する処理はこんな感じです。イベントだったら<code>Invoke</code>していたのが<code>OnNext</code>に変わるだけ、という理解でも最初は十分だと思います。</p>

<p>レバー入力について若干変なことをしていますが、これはいわゆるテンキー表記への変換をやっています。ニュートラルを5として、左右方向の入力があったら+/-1して4か6にし、上下方向の入力があったら+/-3して789か123にする、という処理です。これにより、上下左右が8246、斜め方向を1379で表現するという、古き良き格ゲー攻略サイトなどではお馴染みの記法になります。</p>

<p><img alt=":arrow_upper_left:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2196-fe0f.png" title=":arrow_upper_left:" width="20" loading="lazy"> <img alt=":arrow_up:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2b06-fe0f.png" title=":arrow_up:" width="20" loading="lazy"> <img alt=":arrow_upper_right:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2197-fe0f.png" title=":arrow_upper_right:" width="20" loading="lazy">  -&gt;  7 8 9<br>
<img alt=":arrow_left:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2b05-fe0f.png" title=":arrow_left:" width="20" loading="lazy"> <img alt=":record_button:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/23fa.png" title=":record_button:" width="20" loading="lazy"> <img alt=":arrow_right:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/27a1-fe0f.png" title=":arrow_right:" width="20" loading="lazy">  -&gt;  4 5 6<br>
<img alt=":arrow_lower_left:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2199-fe0f.png" title=":arrow_lower_left:" width="20" loading="lazy"> <img alt=":arrow_down:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2b07-fe0f.png" title=":arrow_down:" width="20" loading="lazy"> <img alt=":arrow_lower_right:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2198-fe0f.png" title=":arrow_lower_right:" width="20" loading="lazy">  -&gt;  1 2 3</p>

<p>ボタン数は、とりあえず4ボタンを想定しておきました。実用する際には、Unityなどにも存在するような、論理ボタンを介したアクセスになると思います。</p>

<p>これで入力の変化を外部からObserveする仕組みが整いました。</p>

<h1>
<span id="格闘ゲームのコマンドに関する要求仕様" class="fragment"></span><a href="#%E6%A0%BC%E9%97%98%E3%82%B2%E3%83%BC%E3%83%A0%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E8%A6%81%E6%B1%82%E4%BB%95%E6%A7%98"><i class="fa fa-link"></i></a>格闘ゲームのコマンドに関する要求仕様</h1>

<p>コマンドの代表例として、ストリートファイターシリーズの必殺技「波動拳」を考えてみます。</p>

<p><img alt=":arrow_down:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2b07-fe0f.png" title=":arrow_down:" width="20" loading="lazy"><img alt=":arrow_lower_right:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2198-fe0f.png" title=":arrow_lower_right:" width="20" loading="lazy"><img alt=":arrow_right:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/27a1-fe0f.png" title=":arrow_right:" width="20" loading="lazy"><img alt=":fist:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/270a.png" title=":fist:" width="20" loading="lazy">と表現されるコマンドですが、これを前述したテンキー表記に直すと <strong>236+パンチ</strong> です。とりあえずAボタンがパンチボタンだとして <strong>236A</strong> という連続的な入力を検出することを考えます。</p>

<h2>
<span id="素早く入力する" class="fragment"></span><a href="#%E7%B4%A0%E6%97%A9%E3%81%8F%E5%85%A5%E5%8A%9B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>素早く入力する</h2>

<p>格闘ゲームのコマンドはのんびり入力しても受け付けてくれません。ある程度素早く入力する必要があります。じゃあどの程度よ？という話ですが、<a href="https://game.capcom.com/cfn/sfv/column-130284.html" rel="nofollow noopener" target="_blank">カプコンさんの情報</a>によれば、方向キーの入力完成からボタンを押すまでには10フレーム(166ms)ほど猶予があるようです。これを参考にして、<strong>コマンドの各ステップの間隔は10フレーム以内</strong>ということにしましょう。<br>
（ゲームによってはもっと猶予のあるもの、厳しいものがあります）</p>

<h2>
<span id="多少余計な入力も許容する" class="fragment"></span><a href="#%E5%A4%9A%E5%B0%91%E4%BD%99%E8%A8%88%E3%81%AA%E5%85%A5%E5%8A%9B%E3%82%82%E8%A8%B1%E5%AE%B9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>多少余計な入力も許容する</h2>

<p>では入力の間隔をチェックしつつ、入力の順番が 236A で揃えばOKかというと、それだけでは厳しいゲームになってしまいます。<br>
もう1つ、代表的なコマンドとして「昇龍拳」を考えてみます。</p>

<p><img alt=":arrow_right:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/27a1-fe0f.png" title=":arrow_right:" width="20" loading="lazy"><img alt=":arrow_down:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2b07-fe0f.png" title=":arrow_down:" width="20" loading="lazy"><img alt=":arrow_lower_right:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2198-fe0f.png" title=":arrow_lower_right:" width="20" loading="lazy"><img alt=":fist:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/270a.png" title=":fist:" width="20" loading="lazy">というコマンドで、テンキー表記では <strong>623P</strong> です。<br>
格闘ゲーム初心者にとっては鬼門となりがちなこのコマンド、先ほどの波動拳とは違って、入力方向が連続的ではありません。<br>
波動拳はぐるっと1/4回転すればいいのですが、昇龍拳は右(6)から下(2)に一気に持って行く必要があります。<br>
この時、ニュートラル(5)や右下(3)を経由してしまったりして、綺麗に623とは行かないケースが多く出てきます。<br>
プロゲーマーやいにしえからのゲーマーなら常に正確な入力ができるかもしれませんが、ただでさえ格闘ゲームのコマンド入力は敷居の高さの要因にされがちです。多少は判定を甘くしておいた方が良いと思います。</p>

<p>余計な入力を許容するにはどうすればいいかですが、<strong>厳密な連続一致を取らず、1ステップごとの要素が順番に現れるかで判定する</strong>という方針にすれば実現できそうです。これなら、6523・6323・6123などの入力も許容できることになります。<br>
余計な入力がたくさん挟まった場合も許容されてしまうのでは、と心配になるかもしれませんが、そこは前述した10フレーム以内の制限でふるい落とされるはずですので、気にしないことにしましょう。</p>

<h1>
<span id="rxのオペレータを駆使してコマンドオブザーバーを作る" class="fragment"></span><a href="#rx%E3%81%AE%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%BF%E3%82%92%E9%A7%86%E4%BD%BF%E3%81%97%E3%81%A6%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%AA%E3%83%96%E3%82%B6%E3%83%BC%E3%83%90%E3%83%BC%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>Rxのオペレータを駆使してコマンドオブザーバーを作る</h1>

<p>ではコマンドオブザーバーを組み立てていきましょう。</p>

<h2>
<span id="1-特定の入力のみを抽出する" class="fragment"></span><a href="#1-%E7%89%B9%E5%AE%9A%E3%81%AE%E5%85%A5%E5%8A%9B%E3%81%AE%E3%81%BF%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. 特定の入力のみを抽出する</h2>

<p><code>KeyStream</code>にはレバーの方向変化とボタン全てのON/OFF情報が流れてきますので、特定の操作の変化だけ取り出します。こういうときは<strong>Where</strong>です。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>    <span class="k">private</span> <span class="n">InputManager</span> <span class="n">input</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">InputManager</span><span class="p">();</span>
<span class="p">---</span>
    <span class="kt">var</span> <span class="n">observe2</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'2'</span><span class="p">);</span>
</code></pre></div></div>

<p>これで「下方向に入力が入った瞬間に通知が飛ぶ」observerができました。</p>

<h2>
<span id="2-次の入力をマージする" class="fragment"></span><a href="#2-%E6%AC%A1%E3%81%AE%E5%85%A5%E5%8A%9B%E3%82%92%E3%83%9E%E3%83%BC%E3%82%B8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. 次の入力をマージする</h2>

<p>次の入力は右下方向です。右下observerを作り、前のobserverとマージ(<strong>Merge</strong>)します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>    <span class="kt">var</span> <span class="n">observe3</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'3'</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">observe23</span> <span class="p">=</span> <span class="n">observer2</span><span class="p">.</span><span class="nf">Merge</span><span class="p">(</span><span class="n">observe3</span><span class="p">);</span>
</code></pre></div></div>

<p>これで「下方向と右下方向に入力が入った瞬間に通知が飛ぶ」observerになりました。</p>

<h2>
<span id="3-入力の順序と間隔をチェックする" class="fragment"></span><a href="#3-%E5%85%A5%E5%8A%9B%E3%81%AE%E9%A0%86%E5%BA%8F%E3%81%A8%E9%96%93%E9%9A%94%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. 入力の順序と間隔をチェックする</h2>

<p><code>IObservable</code>は、飛んできた複数の通知をまとめて評価することができます。いくつか手段はありますが、今は2ステップの順序と間隔を調べたいので、<strong>Buffer</strong>を使って2つの通知を取り出して比較します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>    <span class="n">observe23</span> <span class="p">=</span> <span class="n">observer23</span><span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>  <span class="c1">// 通知を1つずつスライドしながら2つ取り出す</span>
                <span class="c1">// 後続の値はIList&lt;KeyInfo&gt;になるので、添え字でアクセスできる</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Frame</span> <span class="p">&lt;</span> <span class="m">10</span>         <span class="c1">// 間隔をチェック</span>
                         <span class="p">&amp;&amp;</span> <span class="n">b</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'2'</span> <span class="p">&amp;&amp;</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'3'</span><span class="p">)</span>  <span class="c1">// 順序をチェック</span>
                <span class="c1">// 上記のフィルタにより、間隔と順序が正しい場合のみ後続に通知が流れる</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>  <span class="c1">// 以降も同様にチェーンできるように、2つめの入力情報のみを流す</span>
</code></pre></div></div>

<p>メソッドチェーンを使って、ちょっとRxらしいコードになってきました。<br>
<code>Buffer</code>の引数は(取り出す個数, 先頭をスライドする個数)なので、(2, 1)とすることで新しい通知が来るたびに1つ前の通知とセットで流れてくるようになります。<strong>Pairwise</strong>でも同様のことができます。<br>
<strong>Select</strong>も多用するオペレータです。<code>Buffer</code>した時点で流れる値の型が <code>IList&lt;KeyInfo&gt;</code> になるため、そのままでは次の入力の <code>IObservable&lt;KeyInfo&gt;</code> がマージできません。そこで2つめの入力情報を単体で後続に流すようにし、次のステップも反復的に処理できるようにします。</p>

<h2>
<span id="4-コマンド文字列からobserverを生成できるようにする" class="fragment"></span><a href="#4-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E6%96%87%E5%AD%97%E5%88%97%E3%81%8B%E3%82%89observer%E3%82%92%E7%94%9F%E6%88%90%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>4. コマンド文字列からobserverを生成できるようにする</h2>

<p>上記の手順2,3を繰り返すことで、コマンドが完成した時に通知が飛んでくるobserverになります。<br>
というわけで、出来上がった関数がこちら。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>        <span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">KeyInfo</span><span class="p">&gt;</span> <span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="kt">string</span> <span class="n">command</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 指定したキーの押し下げを通知するObserverを返す</span>
            <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">KeyInfo</span><span class="p">&gt;</span> <span class="nf">getInputObserver</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="n">c</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">observer</span> <span class="p">=</span> <span class="nf">getInputObserver</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">command</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">index</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>  <span class="c1">// ループカウンタをラムダ式にキャプチャするために退避</span>
                <span class="n">observer</span> <span class="p">=</span> <span class="n">observer</span>
                    <span class="p">.</span><span class="nf">Merge</span><span class="p">(</span><span class="nf">getInputObserver</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
                    <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                    <span class="c1">// 最初のレバー入力は入れっぱなしでも許容したいので、初回のみ間隔チェックはパス</span>
                    <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">index</span> <span class="p">==</span> <span class="m">1</span> <span class="p">||</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Frame</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Key</span> <span class="p">==</span> <span class="n">command</span><span class="p">[</span><span class="n">index</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Key</span> <span class="p">==</span> <span class="n">command</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                    <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">observer</span><span class="p">;</span>
        <span class="p">}</span>

</code></pre></div></div>

<p>手順1~3の内容を手続き化したかたちになります。<br>
1つ付け加えている処理として、コマンドの最初の方向に入れっぱなしの状態から残りのコマンドを入力するケースを許容するため、最初のステップは間隔チェックを無条件でパスするようにしています。これにより、しゃがみっぱなしの状態から波動拳、前に歩いてから昇龍拳、という状況に対応できます。</p>

<h2>
<span id="5-コマンドオブザーバーをじゃんじゃん作って使う" class="fragment"></span><a href="#5-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%AA%E3%83%96%E3%82%B6%E3%83%BC%E3%83%90%E3%83%BC%E3%82%92%E3%81%98%E3%82%83%E3%82%93%E3%81%98%E3%82%83%E3%82%93%E4%BD%9C%E3%81%A3%E3%81%A6%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>5. コマンドオブザーバーをじゃんじゃん作って使う</h2>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>            <span class="kt">var</span> <span class="n">hadohken</span> <span class="p">=</span><span class="k">this</span><span class="p">.</span><span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="s">"236A"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"波動拳！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">shoryuken</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="s">"623C"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"昇龍拳！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">tatsumaki</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="s">"214B"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"竜巻旋風脚！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">shinkuhadoh</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="s">"236236C"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"真空波動拳！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">yaotome</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="s">"2363214C"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"遊びは終わりだ！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">powergazer</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="s">"21416C"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"パワゲイザーッ！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">razingstorm</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="s">"1632143C"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"レイジングストォーム！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">jigokugokuraku</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="s">"6321463214C"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"チョーシこいてんじゃねぇぞコラァ！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
</code></pre></div></div>

<p>楽ちんでいいですね！やはりRxで出来るんじゃないか？という直感は正しかったのだ……。<br>
<code>Do</code>は流れてきた通知の値はスルーしつつ記述した処理を実行するためのオペレータです。デバッグ時のログ出力でよく用いられます。</p>

<p>実用の際は<code>Subscribe</code>に渡す関数で技のトリガーを引くような処理を書くと思います。引数には最後のキー情報が送られてくるので、コマンド成立時のフレーム時間を取得して利用することもできます。</p>

<p>Rxは実行コンテキストが不明瞭になりがちですが、普通に<code>Subscribe</code>する限りでは、実行スレッドは<code>InputManager.Update()</code>と同じになります。安心してご利用ください。</p>

<p>また<code>Subscribe</code>の返り値は、判定が不要になったら必ず<code>Dispose</code>して、通知の購読を解除する必要がありますので、お忘れ無くお願いします。</p>

<p>注意点として、重複するコマンドの優先順位などは、ハンドリングする側でよしなにしてやる必要があります。<br>
真空波動拳は内部に波動拳と昇龍拳を内包しているので、優先度を高くする必要があります。<br>
また、昇龍拳の勢いが良すぎて 6236 となってしまうことは良くあるため、波動拳より優先度が上になっているゲームが多いように見えます。<br>
（そうなると前歩きからの波動拳が漏れなく昇龍拳になるので、それはそれでストレスかも……ここらへんは要調整ですね）</p>

<h1>
<span id="落ち穂拾い" class="fragment"></span><a href="#%E8%90%BD%E3%81%A1%E7%A9%82%E6%8B%BE%E3%81%84"><i class="fa fa-link"></i></a>落ち穂拾い</h1>

<h2>
<span id="ボタン順番押し系は行ける" class="fragment"></span><a href="#%E3%83%9C%E3%82%BF%E3%83%B3%E9%A0%86%E7%95%AA%E6%8A%BC%E3%81%97%E7%B3%BB%E3%81%AF%E8%A1%8C%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>ボタン順番押し系は行ける？</h2>

<p>いわゆる瞬獄殺・ダークネスイリュージョン系のコマンドです。<br>
基本的な考え方は同じで行けますが、<code>CreateCommandObserver</code>にいくつか手直しが必要です。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>        <span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">KeyInfo</span><span class="p">&gt;</span> <span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="kt">string</span> <span class="n">command</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">KeyInfo</span><span class="p">&gt;</span> <span class="nf">inputObserverSelector</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
                <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="n">c</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">);</span>

            <span class="c1">// 方向キーを識別するための関数</span>
            <span class="kt">bool</span> <span class="nf">isDirection</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">return</span> <span class="sc">'1'</span> <span class="p">&lt;=</span> <span class="n">c</span> <span class="p">&amp;&amp;</span> <span class="n">c</span> <span class="p">&lt;=</span> <span class="sc">'9'</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">observer</span> <span class="p">=</span> <span class="nf">inputObserverSelector</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">command</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">index</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="c1">// 同じ入力が連続する場合、マージしてしまうと通知が重複して飛んでくるのを回避</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">!=</span> <span class="n">command</span><span class="p">[</span><span class="n">index</span> <span class="p">-</span> <span class="m">1</span><span class="p">])</span>
                <span class="p">{</span>
                    <span class="n">observer</span> <span class="p">=</span> <span class="n">observer</span><span class="p">.</span><span class="nf">Merge</span><span class="p">(</span><span class="nf">inputObserverSelector</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
                <span class="p">}</span>

                <span class="n">observer</span> <span class="p">=</span> <span class="n">observer</span>
                    <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                    <span class="c1">// 最初の入力がボタンの場合は間隔チェックが必要</span>
                    <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">index</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="nf">isDirection</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="m">0</span><span class="p">]))</span>
                             <span class="p">||</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Frame</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Key</span> <span class="p">==</span> <span class="n">command</span><span class="p">[</span><span class="n">index</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span>
                             <span class="p">&amp;&amp;</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Key</span> <span class="p">==</span> <span class="n">command</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                    <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">observer</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>これでOKです。ただ、レバー入力主体のコマンドに比べて、間隔の猶予が10フレームだと若干厳しいかもしれないです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>            <span class="kt">var</span> <span class="n">shungoku</span> <span class="p">=</span> <span class="nf">CreateCommandObserver</span><span class="p">(</span><span class="s">"AA6BC"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"一瞬千撃！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
</code></pre></div></div>

<h2>
<span id="同時押しは" class="fragment"></span><a href="#%E5%90%8C%E6%99%82%E6%8A%BC%E3%81%97%E3%81%AF"><i class="fa fa-link"></i></a>同時押しは？</h2>

<p>Rxの得意とするところです！ABCボタンの同時押しを判定してみます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>            <span class="kt">var</span> <span class="n">hatsudo</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'A'</span> <span class="p">||</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'B'</span> <span class="p">||</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'C'</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Frame</span><span class="p">)</span> <span class="p">-</span> <span class="n">b</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Frame</span><span class="p">)</span> <span class="p">&lt;</span> <span class="m">2</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">a</span> <span class="p">=&gt;</span> <span class="n">a</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="sc">'A'</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">a</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="sc">'B'</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">a</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="sc">'C'</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"じゃきーん！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
</code></pre></div></div>

<p>同時押しを判定したいキーのみが通過するフィルタを<code>Where</code>で作り、<br>
<code>Buffer</code>で3つ取り出し、<br>
ボタンが押されたフレームの最大値-最小値が規定フレーム(2)以内かどうかでフィルタし、<br>
キー情報のみの配列に変換し、<br>
対象とするキーが全て含まれているかを判定して、<br>
以下判定時の処理、という具合です。</p>

<p>RxとLinqの真骨頂ですね。同時押し猶予フレームを手軽に制御できるのも良い感じです。</p>

<h2>
<span id="連打系は" class="fragment"></span><a href="#%E9%80%A3%E6%89%93%E7%B3%BB%E3%81%AF"><i class="fa fa-link"></i></a>連打系は？</h2>

<p>Rxの得意とするところです！(その2)</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>            <span class="kt">var</span> <span class="n">hyakuretu</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'D'</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">4</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Frame</span> <span class="p">&lt;</span> <span class="m">30</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"やっやっやっ"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">();</span>
</code></pre></div></div>

<p>30フレーム以内に4回以上連打して発動、であれば上記のようになります。<br>
<code>Buffer(4, 1)</code>でボタン押し下げ4回分の通知を取り出し、先頭と末尾のフレーム差分が規定の時間内なら発動です。<br>
これで書けるのは強いかと思います。</p>

<h2>
<span id="左右反転は" class="fragment"></span><a href="#%E5%B7%A6%E5%8F%B3%E5%8F%8D%E8%BB%A2%E3%81%AF"><i class="fa fa-link"></i></a>左右反転は？</h2>

<p>キャラの方向が入れ替わるたびにObserverを作り直すのは効率悪いので……</p>

<ul>
<li>左右両方向用のObserverを作って使い分ける</li>
<li>キャラ方向に応じて入力方向が入れ替わるKeyStreamを作って、それからObserverを作る</li>
</ul>

<p>のどちらかが良さそうです。後者の方が効率良さそうですね。</p>

<h2>
<span id="簡易入力のサポートは" class="fragment"></span><a href="#%E7%B0%A1%E6%98%93%E5%85%A5%E5%8A%9B%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%AF"><i class="fa fa-link"></i></a>簡易入力のサポートは？</h2>

<p>例えば41236を想定したコマンドを、426や16とすることで対応できますが、やりすぎると暴発しまくるので注意が必要です。<br>
あるいは、上下左右(8246)の許容範囲を789,123,741,963にまで広げる(いわゆる左要素、下要素などでOKとする)ことで、やりやすくなるかもしれませんが、機械的に適用していいかどうかは、ゲーム性にもよるかと思われます。</p>

<h2>
<span id="タメコマンドはレバー1回転は" class="fragment"></span><a href="#%E3%82%BF%E3%83%A1%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AF%E3%83%AC%E3%83%90%E3%83%BC1%E5%9B%9E%E8%BB%A2%E3%81%AF"><i class="fa fa-link"></i></a>タメコマンドは？レバー1回転は？</h2>

<p>これまでの実装に拡張が必要なので、次節でまとめて解説します。</p>

<h1>
<span id="タメと1回転への対応" class="fragment"></span><a href="#%E3%82%BF%E3%83%A1%E3%81%A81%E5%9B%9E%E8%BB%A2%E3%81%B8%E3%81%AE%E5%AF%BE%E5%BF%9C"><i class="fa fa-link"></i></a>タメと1回転への対応</h1>

<p><code>InputManager</code>に拡張が必要なため、先に追加の下ごしらえを済ませます。</p>

<h2>
<span id="追加の下ごしらえ" class="fragment"></span><a href="#%E8%BF%BD%E5%8A%A0%E3%81%AE%E4%B8%8B%E3%81%94%E3%81%97%E3%82%89%E3%81%88"><i class="fa fa-link"></i></a>追加の下ごしらえ</h2>

<p><code>KeyStream</code>には方向とボタンの入力が混ざっているため、このままでは「方向キーのみを取り出したい」といった場合の条件式が若干書きづらいです。また、方向のタメ入力では「左要素」「下要素」のように、7 or 4 or 1や1 or 2 or 3といった複数方向の入力を許容するケースが出てきます。</p>

<p>それともう1点、現在ボタンを離した通知も飛んできますが、この時に「何フレーム継続して押されていたか」を含められると、タメ押し系のコマンドが楽に作れそうです。</p>

<p>そこで、<code>KeyInfo</code>型を次のように拡張します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">struct</span> <span class="nc">KeyInfo</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">char</span> <span class="n">Key</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Frame</span><span class="p">;</span>
        <span class="c1">// 新たに持続フレームを保持するDurationを追加</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Duration</span><span class="p">;</span>
        <span class="c1">// これまでのStateは意味を変えず、0ならば押し下げ通知、1以上なら離し通知として扱う</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">State</span> <span class="p">=&gt;</span> <span class="n">Duration</span> <span class="p">==</span> <span class="m">0</span><span class="p">;</span>
        <span class="c1">// 方向の入力であることを識別可能なプロパティを追加</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsDirection</span> <span class="p">=&gt;</span> <span class="sc">'1'</span> <span class="p">&lt;=</span> <span class="n">Key</span> <span class="p">&amp;&amp;</span> <span class="n">Key</span> <span class="p">&lt;=</span> <span class="sc">'9'</span><span class="p">;</span>
        <span class="c1">// 上下左右方向の要素を持つかを示すメソッドを追加</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">HasAttribute</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="sc">'8'</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'7'</span> <span class="p">||</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'8'</span> <span class="p">||</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'9'</span><span class="p">;</span>
                <span class="k">case</span> <span class="sc">'2'</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'1'</span> <span class="p">||</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'2'</span> <span class="p">||</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'3'</span><span class="p">;</span>
                <span class="k">case</span> <span class="sc">'4'</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'7'</span> <span class="p">||</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'4'</span> <span class="p">||</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'1'</span><span class="p">;</span>
                <span class="k">case</span> <span class="sc">'6'</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'9'</span> <span class="p">||</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'6'</span> <span class="p">||</span> <span class="n">Key</span> <span class="p">==</span> <span class="sc">'3'</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 厳密なエラーチェックは割愛</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>更にInputManagerを次のように拡張します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">InputManager</span>
    <span class="p">{</span>
        <span class="c1">// 追加と修正のあるメンバ以外は省略</span>

        <span class="c1">// 方向キーとボタンの押し下げ持続時間を保持するフィールド</span>
        <span class="k">private</span> <span class="kt">int</span> <span class="n">directionDuration</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">int</span><span class="p">[]</span> <span class="n">buttonsDuration</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="m">4</span><span class="p">];</span>

        <span class="c1">// テンキー表記変換をメソッド化</span>
        <span class="k">private</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">ToDirection</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">&gt;</span> <span class="m">300</span><span class="p">)</span> <span class="k">value</span> <span class="p">+=</span> <span class="m">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">&lt;</span> <span class="p">-</span><span class="m">300</span><span class="p">)</span> <span class="k">value</span> <span class="p">-=</span> <span class="m">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="p">&lt;</span> <span class="p">-</span><span class="m">300</span><span class="p">)</span> <span class="k">value</span> <span class="p">+=</span> <span class="m">3</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="p">&gt;</span> <span class="m">300</span><span class="p">)</span> <span class="k">value</span> <span class="p">-=</span> <span class="m">3</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">pad</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="k">this</span><span class="p">.</span><span class="n">pad</span><span class="p">.</span><span class="nf">Acquire</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="n">pad</span><span class="p">.</span><span class="nf">Poll</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">pad</span><span class="p">.</span><span class="nf">GetCurrentState</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">X</span> <span class="p">!=</span> <span class="k">this</span><span class="p">.</span><span class="n">prevState</span><span class="p">.</span><span class="n">X</span> <span class="p">||</span> <span class="n">state</span><span class="p">.</span><span class="n">Y</span> <span class="p">!=</span> <span class="k">this</span><span class="p">.</span><span class="n">prevState</span><span class="p">.</span><span class="n">Y</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// 方向切り替わり時に持続フレームを通知</span>
                <span class="k">this</span><span class="p">.</span><span class="n">_keyStream</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyInfo</span>
                <span class="p">{</span>
                    <span class="n">Key</span> <span class="p">=</span> <span class="nf">ToDirection</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">prevState</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">prevState</span><span class="p">.</span><span class="n">Y</span><span class="p">).</span><span class="nf">ToString</span><span class="p">()[</span><span class="m">0</span><span class="p">],</span>
                    <span class="n">Duration</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">directionDuration</span><span class="p">,</span>
                    <span class="n">Frame</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">frame</span><span class="p">,</span>
                <span class="p">});</span>
                <span class="c1">// 持続フレームをリセットしつつ新たな方向を押し下げ通知</span>
                <span class="k">this</span><span class="p">.</span><span class="n">_keyStream</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyInfo</span>
                <span class="p">{</span>
                    <span class="n">Key</span> <span class="p">=</span> <span class="nf">ToDirection</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">Y</span><span class="p">).</span><span class="nf">ToString</span><span class="p">()[</span><span class="m">0</span><span class="p">],</span>
                    <span class="n">Duration</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">directionDuration</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
                    <span class="n">Frame</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">frame</span><span class="p">,</span>
                <span class="p">});</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">// 方向に変化がなかった場合は持続フレームをインクリメント</span>
                <span class="p">++</span><span class="k">this</span><span class="p">.</span><span class="n">directionDuration</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">char</span><span class="p">[]</span> <span class="n">buttonName</span> <span class="p">=</span> <span class="p">{</span> <span class="sc">'A'</span><span class="p">,</span> <span class="sc">'B'</span><span class="p">,</span> <span class="sc">'C'</span><span class="p">,</span> <span class="sc">'D'</span> <span class="p">};</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">4</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">Buttons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">!=</span> <span class="k">this</span><span class="p">.</span><span class="n">prevState</span><span class="p">.</span><span class="n">Buttons</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="p">{</span>
                    <span class="c1">// 押し下げ時は0を、離し時は持続フレームを通知</span>
                    <span class="k">this</span><span class="p">.</span><span class="n">_keyStream</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyInfo</span>
                    <span class="p">{</span>
                        <span class="n">Key</span> <span class="p">=</span> <span class="n">buttonName</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">Duration</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">Buttons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">?</span> <span class="m">0</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="n">buttonsDuration</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">Frame</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">frame</span><span class="p">,</span>
                    <span class="p">});</span>
                    <span class="k">this</span><span class="p">.</span><span class="n">buttonsDuration</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">Buttons</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="p">{</span>
                    <span class="c1">// 押し下げ継続時は持続フレームをインクリメント</span>
                    <span class="p">++</span><span class="k">this</span><span class="p">.</span><span class="n">buttonsDuration</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="n">prevState</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
            <span class="p">++</span><span class="k">this</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>これでタメとレバー1回転への対応準備ができました。</p>

<h2>
<span id="レバー1回転" class="fragment"></span><a href="#%E3%83%AC%E3%83%90%E3%83%BC1%E5%9B%9E%E8%BB%A2"><i class="fa fa-link"></i></a>レバー1回転</h2>

<p>では早速書いてみましょう。若干ゴリ押し感ありますが。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>            <span class="k">const</span> <span class="kt">string</span> <span class="n">clockWise</span> <span class="p">=</span> <span class="s">"89632147896321478"</span><span class="p">;</span>
            <span class="k">const</span> <span class="kt">string</span> <span class="n">counterClockWise</span> <span class="p">=</span> <span class="s">"87412369874123698"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">screw</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">IsDirection</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">6</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">[</span><span class="m">5</span><span class="p">].</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Frame</span> <span class="p">&lt;</span> <span class="m">50</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()).</span><span class="nf">Aggregate</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">a</span> <span class="p">+</span> <span class="n">c</span><span class="p">);</span>
                    <span class="k">return</span> <span class="n">clockWise</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">||</span> <span class="n">counterClockWise</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">())</span>
                <span class="p">.</span><span class="nf">Merge</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'C'</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">().</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="n">Frame</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="n">IsDirection</span> <span class="p">&amp;&amp;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">().</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'C'</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">())</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"フンッ！どりゃあ！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">().</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">_cd</span><span class="p">);</span>

</code></pre></div></div>

<p>まず、方向キーの押し下げのみを取り出すために <code>Where(k =&gt; k.IsDirection &amp;&amp; k.State)</code> でフィルタします。</p>

<p>そして判定基準ですが、昨今のタイトルでは「5/8回転で1回転とみなす」という若干甘めの設定が多いようなので、それを採用します。テンキー表記だと6個分の入力になるので、 <code>Buffer(6, 1)</code> で取り出します。</p>

<p>入力間隔は、最初の方向は入れっぱなしでも良いことにして、2番目から最後の入力までがそれぞれ10フレーム以内ならOKというのを、まとめて50フレーム以内として判定しています。</p>

<p>次に、6個分の入力が連続した方向変化（時計回り or 反時計回り）かどうかを判断する方法として、方向を表す文字を連結して履歴を文字列化し、それが時計回りか反時計回りを表す文字列に含まれるかどうか、という判定を行っています。若干雑な気もしますが、お手軽に書けることを重視しました。</p>

<p>後は通常のコマンドと同じく、最後の入力を <code>Select</code> して後ろに流し、ボタンの入力をマージして、<code>Buffer(2, 1)</code> で間隔と順序をチェックして、パスしたらコマンド成立として扱います。<code>Buffer</code>でまとめた配列に対しては、添え字でアクセスしてもいいですが、先頭と末尾であることを明示するなら<code>First</code>と<code>Last</code>を使った方が、配列の長さに影響されなくて良いかもしれません。</p>

<h2>
<span id="タメ" class="fragment"></span><a href="#%E3%82%BF%E3%83%A1"><i class="fa fa-link"></i></a>タメ</h2>

<p>タメ技といった場合、いわゆる <img alt=":arrow_left:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2b05-fe0f.png" title=":arrow_left:" width="20" loading="lazy">タメ<img alt=":arrow_right:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/27a1-fe0f.png" title=":arrow_right:" width="20" loading="lazy"><img alt=":fist:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/270a.png" title=":fist:" width="20" loading="lazy"> や <img alt=":arrow_down:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2b07-fe0f.png" title=":arrow_down:" width="20" loading="lazy">タメ<img alt=":arrow_up:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2b06-fe0f.png" title=":arrow_up:" width="20" loading="lazy"><img alt=":footprints:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f463.png" title=":footprints:" width="20" loading="lazy"> などのコマンドが代表的ですが、ボタンを長押しして離した時に発動するコマンドも存在します。ここではその両方を扱います。</p>

<p>まずは簡単な方から。ボタン2つの同時押しの後、どちらかを離した時に発動するコマンドの例です。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>            <span class="kt">var</span> <span class="n">turnpunch</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'A'</span> <span class="p">||</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'C'</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Frame</span><span class="p">)</span> <span class="p">-</span> <span class="n">b</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Frame</span><span class="p">)</span> <span class="p">&lt;</span> <span class="m">2</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">a</span> <span class="p">=</span> <span class="n">b</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
                    <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="sc">'A'</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">a</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="sc">'C'</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">())</span>
                <span class="p">.</span><span class="nf">Merge</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'A'</span> <span class="p">||</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'C'</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">().</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="n">Frame</span> <span class="p">&gt;</span> <span class="m">60</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="n">State</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">().</span><span class="n">State</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">())</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">Duration</span> <span class="p">+</span> <span class="s">"フレームためたターンパンチ！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">().</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">_cd</span><span class="p">);</span>
</code></pre></div></div>

<p>同時押しの押し下げ判定までは前述の通りですが、その後マージしている条件式が <code>!k.State</code> で離し通知でフィルタするようになっています。<br>
更に、先んじて <code>KeyInfo</code> を拡張しておいたおかげで、<code>k.Duration</code> で何フレーム継続して押されていたかを取得することができます。これを使って、技の発動時に段階的に威力を変える、といったことが実現できます。</p>

<p>では最後に、レバーのタメを使ったコマンドです。<strong>4タメ6A</strong>を判定してみます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>            <span class="kt">var</span> <span class="n">sonic</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="nf">HasAttribute</span><span class="p">(</span><span class="sc">'4'</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Take</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">k</span><span class="p">.</span><span class="nf">HasAttribute</span><span class="p">(</span><span class="sc">'4'</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">).</span><span class="nf">Take</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Repeat</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">().</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="n">Frame</span> <span class="p">&gt;=</span> <span class="m">40</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">().</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'6'</span>
                                <span class="p">?</span> <span class="n">Observable</span><span class="p">.</span><span class="nf">Return</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">())</span>
                                <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span>
                                    <span class="n">kk</span> <span class="p">=&gt;</span> <span class="n">kk</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'6'</span> <span class="p">&amp;&amp;</span> <span class="n">kk</span><span class="p">.</span><span class="n">State</span> <span class="p">&amp;&amp;</span> <span class="n">kk</span><span class="p">.</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">().</span><span class="n">Frame</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Switch</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">Merge</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">KeyStream</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'A'</span> <span class="p">&amp;&amp;</span> <span class="n">k</span><span class="p">.</span><span class="n">State</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">().</span><span class="n">Frame</span> <span class="p">-</span> <span class="n">b</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="n">Frame</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="n">IsDirection</span> <span class="p">&amp;&amp;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">().</span><span class="n">Key</span> <span class="p">==</span> <span class="sc">'A'</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="nf">Last</span><span class="p">())</span>
                <span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"ソニックブーム！"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">().</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">_cd</span><span class="p">);</span>
</code></pre></div></div>

<p>最後にもってきただけあって、なかなか複雑なことになっています。紐解いていきましょう。</p>

<p>方向変化でも持続フレームを取れるようにしましたが、やっかいなことに一般的な方向タメでは<img alt=":arrow_left:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2b05-fe0f.png" title=":arrow_left:" width="20" loading="lazy">と表記されていたら<img alt=":arrow_upper_left:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2196-fe0f.png" title=":arrow_upper_left:" width="20" loading="lazy">や<img alt=":arrow_lower_left:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/2199-fe0f.png" title=":arrow_lower_left:" width="20" loading="lazy">に入っていたフレームもカウントします。当初は<code>InputManager</code>内で、そういった要素ごとの持続フレームを持つことを考えましたが、あまり<code>InputManager</code>にゲーム固有の仕様を意識させるのもうまくありません。Rxのオペレータで書き切る方針で考えます。</p>

<p>やりたいことは「左要素を含む最初の通知を保持しつつ（その後左要素の方向をガシャガシャしたとしても無視して）左要素以外に入力が移った際の通知を捕まえて、タメ時間を判定できる」ところに持ち込むことです。要素単位でのキー指定には、以前に拡張した<code>HasAttribute()</code>を使って条件をシンプルに記述します。</p>

<p>最初の入力のみを受け取るのは<strong>Take(1)</strong>を付けることで実現できます。これを行うと、通知を受け取った時点でストリームはいったん「完了」状態となります。<code>Merge</code>は稼働中のストリームに別のストリームを合成するオペレータでしたが、完了したストリームには<strong>Concat</strong>で後続のストリームをつなげることができます。ここで左要素以外の初回の入力を受け取り、いつもの<code>Buffer(2, 1)</code>でまとめます。このままだと、1回の<code>Subscribe</code>で一度しかこのペアを受け取ることができませんので、<strong>Repeat</strong>でこの流れを繰り返すように指示します。</p>

<p>後はタメ時間を判定して、次のレバー入力の判定……といきたいのですが、タメを解除した方向がぴったり次のコマンドの方向だった場合と、そうでない場合があり得るのをケアしないといけません。<code>!k.HasAttribute('4')</code>は 8,5,2,9,6,3 のいずれかで成立します。6 ならばその入力情報をそのままもう一度流し、そうでなければ 6 を待つストリームからの通知を待つようにする。これを実現するのが、<code>Select</code>内での3項演算子による分岐と、その後ろにある<strong>Switch</strong>の組み合わせです。</p>

<p><code>Select</code>は値を変換して後続にパスするだけでなく、受け取った値を使って生成した<code>IObservable</code>自体を後続に投げる使い方もあります。その場合、<code>Select</code>の後ろには引数を取らない<code>Merge</code>や<code>Switch</code>を置いて合成を行うのがお決まりのパターンです。特に<code>Select</code>&amp;<code>Merge</code>の組み合わせは<code>SelectMany</code>と同様の効果を持ちます。</p>

<p>最後の A ボタン入力待ちは、通常のコマンドと同様でOKです。コマンドオブザーバーのファクトリ関数を拡張する場合は、タメの後の方向までを1セットで扱うと、反復的に処理できて良さそうですね。</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>かなり大更新になってしまいましたが、コードをきれいにしたらGitHubあたりで公開することも考えています。そうしたらまたここでお知らせします。</p>

<p>また、どなたかこの記事を参考に格闘ゲーム作ったらご一報ください。遊びに行きます。<br>
Reactive Fighters 2020、お待ちしております。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Frita0222%2Fitems%2Fc67338cd7f8ca9ac11af&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Frita0222%2Fitems%2Fc67338cd7f8ca9ac11af&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/rita0222/items/c67338cd7f8ca9ac11af/likers" class="css-1iupg5d">69</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">55</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/c67338cd7f8ca9ac11af/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/rita0222/items/c67338cd7f8ca9ac11af/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/rita0222/items/c67338cd7f8ca9ac11af/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/rita0222/items/c67338cd7f8ca9ac11af/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/rita0222/items/c67338cd7f8ca9ac11af.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-46b1095b-b75b-4889-b91d-02587e437d6a">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-ce914d0d-f4a5-4134-8c80-a5d79398389e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-ce914d0d-f4a5-4134-8c80-a5d79398389e">{}</script>
      
<div id="LoginModal-react-component-7d623714-3148-4e27-a040-2866e7d6ba30"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-7d623714-3148-4e27-a040-2866e7d6ba30">{}</script>
      
<div id="StockModal-react-component-121ac9fd-873b-4ca5-afb2-75a180f0bf93"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-121ac9fd-873b-4ca5-afb2-75a180f0bf93">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;PHwpe86luy6QRAyEpqOwtfZlhFr6xAhpkmCREGMGRMrWe04EggjNpw7SssVgdrfyryBLK5joT6yHRpU6fRB5Tg==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"動機\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8B%95%E6%A9%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e動機\u003c/h1\u003e\n\n\u003cp\u003eRxの解説などを見ると、だいたい「イベントのLinq化」「断続的なメッセージをストリームとして」「フィルタ、合成、変換といったオペレータを」などなどの文言が並びます。初見ではなかなか理解が難しいかも知れません。私もそうでした。\u003cbr\u003e\nただ、下手くそながらも格闘ゲームを愛する1人として、ピンと来るモノがありました。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eこれ、コマンドの入力判定に使えるんじゃね？\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e思い立ったらやってみよう！ということで、Rxを駆使してコマンド入力判定処理を作ってみます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"更新履歴\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9B%B4%E6%96%B0%E5%B1%A5%E6%AD%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e更新履歴\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eレバー1回転とタメ系のコマンドに対応しました(2020/5/11)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"下ごしらえ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%8B%E3%81%94%E3%81%97%E3%82%89%E3%81%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e下ごしらえ\u003c/h1\u003e\n\n\u003cp\u003eとりあえず、Windows環境でSharpDX + Reactive Extensionsという構成で作っていきます。Unityだったら、UniRxを使えば多分同じことはできるでしょう。\u003c/p\u003e\n\n\u003cp\u003eまずはゲームパッドの入力をObserveできるようにします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputManager\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eKeyInfo\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eFrame\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eSubject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_keyStream\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eSubject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIObservable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_keyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAsObservable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eframe\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e入力の変化を\u003ccode\u003eKeyStream\u003c/code\u003eという\u003ccode\u003eIObservable\u003c/code\u003eに通知することにします。通知を行う\u003ccode\u003eSubject\u003c/code\u003eはバッキングフィールドとして\u003ccode\u003eprivate\u003c/code\u003eにしておき、外部には\u003ccode\u003eAsObservable()\u003c/code\u003eしてプロパティとして公開します。\u003c/p\u003e\n\n\u003cp\u003e通知する情報は\u003ccode\u003eKeyInfo\u003c/code\u003eという型で定義しました。どのキーの情報か(\u003ccode\u003eKey\u003c/code\u003e)、押されたのか離されたのか(\u003ccode\u003eState\u003c/code\u003e)、何フレーム目に発生したのか(\u003ccode\u003eFrame\u003c/code\u003e)の3つです。後で改修したくなりそうな気もしますが、とりあえずこれで行きましょう。\u003c/p\u003e\n\n\u003cp\u003eRxでは通知した値に対してタイムスタンプを付ける機能がありますが、格闘ゲームではフレーム数の方が信頼できる情報だろうということで、自前で持たせるようにしています。フレーム数のオーバーフローについてはケアする必要がありそうですが、今回は割愛します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputManager\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 前述したクラスのメンバは省略\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eJoystick\u003c/span\u003e \u003cspan class=\"n\"\u003epad\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eJoystickState\u003c/span\u003e \u003cspan class=\"n\"\u003eprevState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eJoystickState\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAcquire\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePoll\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCurrentState\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e300\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e300\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e-=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e300\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e300\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e-=\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_keyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnNext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e()[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ebuttonName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"sc\"\u003e'A'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"sc\"\u003e'B'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"sc\"\u003e'C'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"sc\"\u003e'D'\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eButtons\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eButtons\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_keyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnNext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuttonName\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eButtons\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eJoyStick\u003c/code\u003eの初期化はコンストラクタあたりでやっておくとして、毎フレーム状態をポーリングしつつ、変化があったら\u003ccode\u003eKeyStream\u003c/code\u003eに対して値を発行する処理はこんな感じです。イベントだったら\u003ccode\u003eInvoke\u003c/code\u003eしていたのが\u003ccode\u003eOnNext\u003c/code\u003eに変わるだけ、という理解でも最初は十分だと思います。\u003c/p\u003e\n\n\u003cp\u003eレバー入力について若干変なことをしていますが、これはいわゆるテンキー表記への変換をやっています。ニュートラルを5として、左右方向の入力があったら+/-1して4か6にし、上下方向の入力があったら+/-3して789か123にする、という処理です。これにより、上下左右が8246、斜め方向を1379で表現するという、古き良き格ゲー攻略サイトなどではお馴染みの記法になります。\u003c/p\u003e\n\n\u003cp\u003e\u003cimg alt=\":arrow_upper_left:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2196-fe0f.png\" title=\":arrow_upper_left:\" width=\"20\" loading=\"lazy\"\u003e \u003cimg alt=\":arrow_up:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2b06-fe0f.png\" title=\":arrow_up:\" width=\"20\" loading=\"lazy\"\u003e \u003cimg alt=\":arrow_upper_right:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2197-fe0f.png\" title=\":arrow_upper_right:\" width=\"20\" loading=\"lazy\"\u003e  -\u0026gt;  7 8 9\u003cbr\u003e\n\u003cimg alt=\":arrow_left:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2b05-fe0f.png\" title=\":arrow_left:\" width=\"20\" loading=\"lazy\"\u003e \u003cimg alt=\":record_button:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/23fa.png\" title=\":record_button:\" width=\"20\" loading=\"lazy\"\u003e \u003cimg alt=\":arrow_right:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/27a1-fe0f.png\" title=\":arrow_right:\" width=\"20\" loading=\"lazy\"\u003e  -\u0026gt;  4 5 6\u003cbr\u003e\n\u003cimg alt=\":arrow_lower_left:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2199-fe0f.png\" title=\":arrow_lower_left:\" width=\"20\" loading=\"lazy\"\u003e \u003cimg alt=\":arrow_down:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2b07-fe0f.png\" title=\":arrow_down:\" width=\"20\" loading=\"lazy\"\u003e \u003cimg alt=\":arrow_lower_right:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2198-fe0f.png\" title=\":arrow_lower_right:\" width=\"20\" loading=\"lazy\"\u003e  -\u0026gt;  1 2 3\u003c/p\u003e\n\n\u003cp\u003eボタン数は、とりあえず4ボタンを想定しておきました。実用する際には、Unityなどにも存在するような、論理ボタンを介したアクセスになると思います。\u003c/p\u003e\n\n\u003cp\u003eこれで入力の変化を外部からObserveする仕組みが整いました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"格闘ゲームのコマンドに関する要求仕様\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A0%BC%E9%97%98%E3%82%B2%E3%83%BC%E3%83%A0%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E8%A6%81%E6%B1%82%E4%BB%95%E6%A7%98\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e格闘ゲームのコマンドに関する要求仕様\u003c/h1\u003e\n\n\u003cp\u003eコマンドの代表例として、ストリートファイターシリーズの必殺技「波動拳」を考えてみます。\u003c/p\u003e\n\n\u003cp\u003e\u003cimg alt=\":arrow_down:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2b07-fe0f.png\" title=\":arrow_down:\" width=\"20\" loading=\"lazy\"\u003e\u003cimg alt=\":arrow_lower_right:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2198-fe0f.png\" title=\":arrow_lower_right:\" width=\"20\" loading=\"lazy\"\u003e\u003cimg alt=\":arrow_right:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/27a1-fe0f.png\" title=\":arrow_right:\" width=\"20\" loading=\"lazy\"\u003e\u003cimg alt=\":fist:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/270a.png\" title=\":fist:\" width=\"20\" loading=\"lazy\"\u003eと表現されるコマンドですが、これを前述したテンキー表記に直すと \u003cstrong\u003e236+パンチ\u003c/strong\u003e です。とりあえずAボタンがパンチボタンだとして \u003cstrong\u003e236A\u003c/strong\u003e という連続的な入力を検出することを考えます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"素早く入力する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B4%A0%E6%97%A9%E3%81%8F%E5%85%A5%E5%8A%9B%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e素早く入力する\u003c/h2\u003e\n\n\u003cp\u003e格闘ゲームのコマンドはのんびり入力しても受け付けてくれません。ある程度素早く入力する必要があります。じゃあどの程度よ？という話ですが、\u003ca href=\"https://game.capcom.com/cfn/sfv/column-130284.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eカプコンさんの情報\u003c/a\u003eによれば、方向キーの入力完成からボタンを押すまでには10フレーム(166ms)ほど猶予があるようです。これを参考にして、\u003cstrong\u003eコマンドの各ステップの間隔は10フレーム以内\u003c/strong\u003eということにしましょう。\u003cbr\u003e\n（ゲームによってはもっと猶予のあるもの、厳しいものがあります）\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"多少余計な入力も許容する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A4%9A%E5%B0%91%E4%BD%99%E8%A8%88%E3%81%AA%E5%85%A5%E5%8A%9B%E3%82%82%E8%A8%B1%E5%AE%B9%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e多少余計な入力も許容する\u003c/h2\u003e\n\n\u003cp\u003eでは入力の間隔をチェックしつつ、入力の順番が 236A で揃えばOKかというと、それだけでは厳しいゲームになってしまいます。\u003cbr\u003e\nもう1つ、代表的なコマンドとして「昇龍拳」を考えてみます。\u003c/p\u003e\n\n\u003cp\u003e\u003cimg alt=\":arrow_right:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/27a1-fe0f.png\" title=\":arrow_right:\" width=\"20\" loading=\"lazy\"\u003e\u003cimg alt=\":arrow_down:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2b07-fe0f.png\" title=\":arrow_down:\" width=\"20\" loading=\"lazy\"\u003e\u003cimg alt=\":arrow_lower_right:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2198-fe0f.png\" title=\":arrow_lower_right:\" width=\"20\" loading=\"lazy\"\u003e\u003cimg alt=\":fist:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/270a.png\" title=\":fist:\" width=\"20\" loading=\"lazy\"\u003eというコマンドで、テンキー表記では \u003cstrong\u003e623P\u003c/strong\u003e です。\u003cbr\u003e\n格闘ゲーム初心者にとっては鬼門となりがちなこのコマンド、先ほどの波動拳とは違って、入力方向が連続的ではありません。\u003cbr\u003e\n波動拳はぐるっと1/4回転すればいいのですが、昇龍拳は右(6)から下(2)に一気に持って行く必要があります。\u003cbr\u003e\nこの時、ニュートラル(5)や右下(3)を経由してしまったりして、綺麗に623とは行かないケースが多く出てきます。\u003cbr\u003e\nプロゲーマーやいにしえからのゲーマーなら常に正確な入力ができるかもしれませんが、ただでさえ格闘ゲームのコマンド入力は敷居の高さの要因にされがちです。多少は判定を甘くしておいた方が良いと思います。\u003c/p\u003e\n\n\u003cp\u003e余計な入力を許容するにはどうすればいいかですが、\u003cstrong\u003e厳密な連続一致を取らず、1ステップごとの要素が順番に現れるかで判定する\u003c/strong\u003eという方針にすれば実現できそうです。これなら、6523・6323・6123などの入力も許容できることになります。\u003cbr\u003e\n余計な入力がたくさん挟まった場合も許容されてしまうのでは、と心配になるかもしれませんが、そこは前述した10フレーム以内の制限でふるい落とされるはずですので、気にしないことにしましょう。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"rxのオペレータを駆使してコマンドオブザーバーを作る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#rx%E3%81%AE%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%BF%E3%82%92%E9%A7%86%E4%BD%BF%E3%81%97%E3%81%A6%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%AA%E3%83%96%E3%82%B6%E3%83%BC%E3%83%90%E3%83%BC%E3%82%92%E4%BD%9C%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRxのオペレータを駆使してコマンドオブザーバーを作る\u003c/h1\u003e\n\n\u003cp\u003eではコマンドオブザーバーを組み立てていきましょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"1-特定の入力のみを抽出する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-%E7%89%B9%E5%AE%9A%E3%81%AE%E5%85%A5%E5%8A%9B%E3%81%AE%E3%81%BF%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. 特定の入力のみを抽出する\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eKeyStream\u003c/code\u003eにはレバーの方向変化とボタン全てのON/OFF情報が流れてきますので、特定の操作の変化だけ取り出します。こういうときは\u003cstrong\u003eWhere\u003c/strong\u003eです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eInputManager\u003c/span\u003e \u003cspan class=\"n\"\u003einput\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInputManager\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e---\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eobserve2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'2'\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで「下方向に入力が入った瞬間に通知が飛ぶ」observerができました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"2-次の入力をマージする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2-%E6%AC%A1%E3%81%AE%E5%85%A5%E5%8A%9B%E3%82%92%E3%83%9E%E3%83%BC%E3%82%B8%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2. 次の入力をマージする\u003c/h2\u003e\n\n\u003cp\u003e次の入力は右下方向です。右下observerを作り、前のobserverとマージ(\u003cstrong\u003eMerge\u003c/strong\u003e)します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eobserve3\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'3'\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eobserve23\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eobserver2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMerge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobserve3\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで「下方向と右下方向に入力が入った瞬間に通知が飛ぶ」observerになりました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"3-入力の順序と間隔をチェックする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3-%E5%85%A5%E5%8A%9B%E3%81%AE%E9%A0%86%E5%BA%8F%E3%81%A8%E9%96%93%E9%9A%94%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3. 入力の順序と間隔をチェックする\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eIObservable\u003c/code\u003eは、飛んできた複数の通知をまとめて評価することができます。いくつか手段はありますが、今は2ステップの順序と間隔を調べたいので、\u003cstrong\u003eBuffer\u003c/strong\u003eを使って2つの通知を取り出して比較します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"n\"\u003eobserve23\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eobserver23\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 通知を1つずつスライドしながら2つ取り出す\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 後続の値はIList\u0026lt;KeyInfo\u0026gt;になるので、添え字でアクセスできる\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e         \u003cspan class=\"c1\"\u003e// 間隔をチェック\u003c/span\u003e\n                         \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'2'\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'3'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 順序をチェック\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 上記のフィルタにより、間隔と順序が正しい場合のみ後続に通知が流れる\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 以降も同様にチェーンできるように、2つめの入力情報のみを流す\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eメソッドチェーンを使って、ちょっとRxらしいコードになってきました。\u003cbr\u003e\n\u003ccode\u003eBuffer\u003c/code\u003eの引数は(取り出す個数, 先頭をスライドする個数)なので、(2, 1)とすることで新しい通知が来るたびに1つ前の通知とセットで流れてくるようになります。\u003cstrong\u003ePairwise\u003c/strong\u003eでも同様のことができます。\u003cbr\u003e\n\u003cstrong\u003eSelect\u003c/strong\u003eも多用するオペレータです。\u003ccode\u003eBuffer\u003c/code\u003eした時点で流れる値の型が \u003ccode\u003eIList\u0026lt;KeyInfo\u0026gt;\u003c/code\u003e になるため、そのままでは次の入力の \u003ccode\u003eIObservable\u0026lt;KeyInfo\u0026gt;\u003c/code\u003e がマージできません。そこで2つめの入力情報を単体で後続に流すようにし、次のステップも反復的に処理できるようにします。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"4-コマンド文字列からobserverを生成できるようにする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E6%96%87%E5%AD%97%E5%88%97%E3%81%8B%E3%82%89observer%E3%82%92%E7%94%9F%E6%88%90%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4. コマンド文字列からobserverを生成できるようにする\u003c/h2\u003e\n\n\u003cp\u003e上記の手順2,3を繰り返すことで、コマンドが完成した時に通知が飛んでくるobserverになります。\u003cbr\u003e\nというわけで、出来上がった関数がこちら。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIObservable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 指定したキーの押し下げを通知するObserverを返す\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eIObservable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003egetInputObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003egetInputObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ループカウンタをラムダ式にキャプチャするために退避\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMerge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003egetInputObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]))\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// 最初のレバー入力は入れっぱなしでも許容したいので、初回のみ間隔チェックはパス\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e手順1~3の内容を手続き化したかたちになります。\u003cbr\u003e\n1つ付け加えている処理として、コマンドの最初の方向に入れっぱなしの状態から残りのコマンドを入力するケースを許容するため、最初のステップは間隔チェックを無条件でパスするようにしています。これにより、しゃがみっぱなしの状態から波動拳、前に歩いてから昇龍拳、という状況に対応できます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"5-コマンドオブザーバーをじゃんじゃん作って使う\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#5-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%AA%E3%83%96%E3%82%B6%E3%83%BC%E3%83%90%E3%83%BC%E3%82%92%E3%81%98%E3%82%83%E3%82%93%E3%81%98%E3%82%83%E3%82%93%E4%BD%9C%E3%81%A3%E3%81%A6%E4%BD%BF%E3%81%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5. コマンドオブザーバーをじゃんじゃん作って使う\u003c/h2\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ehadohken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"236A\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"波動拳！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eshoryuken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"623C\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"昇龍拳！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etatsumaki\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"214B\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"竜巻旋風脚！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eshinkuhadoh\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"236236C\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"真空波動拳！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eyaotome\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"2363214C\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"遊びは終わりだ！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epowergazer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"21416C\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"パワゲイザーッ！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003erazingstorm\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"1632143C\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"レイジングストォーム！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ejigokugokuraku\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"6321463214C\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"チョーシこいてんじゃねぇぞコラァ！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e楽ちんでいいですね！やはりRxで出来るんじゃないか？という直感は正しかったのだ……。\u003cbr\u003e\n\u003ccode\u003eDo\u003c/code\u003eは流れてきた通知の値はスルーしつつ記述した処理を実行するためのオペレータです。デバッグ時のログ出力でよく用いられます。\u003c/p\u003e\n\n\u003cp\u003e実用の際は\u003ccode\u003eSubscribe\u003c/code\u003eに渡す関数で技のトリガーを引くような処理を書くと思います。引数には最後のキー情報が送られてくるので、コマンド成立時のフレーム時間を取得して利用することもできます。\u003c/p\u003e\n\n\u003cp\u003eRxは実行コンテキストが不明瞭になりがちですが、普通に\u003ccode\u003eSubscribe\u003c/code\u003eする限りでは、実行スレッドは\u003ccode\u003eInputManager.Update()\u003c/code\u003eと同じになります。安心してご利用ください。\u003c/p\u003e\n\n\u003cp\u003eまた\u003ccode\u003eSubscribe\u003c/code\u003eの返り値は、判定が不要になったら必ず\u003ccode\u003eDispose\u003c/code\u003eして、通知の購読を解除する必要がありますので、お忘れ無くお願いします。\u003c/p\u003e\n\n\u003cp\u003e注意点として、重複するコマンドの優先順位などは、ハンドリングする側でよしなにしてやる必要があります。\u003cbr\u003e\n真空波動拳は内部に波動拳と昇龍拳を内包しているので、優先度を高くする必要があります。\u003cbr\u003e\nまた、昇龍拳の勢いが良すぎて 6236 となってしまうことは良くあるため、波動拳より優先度が上になっているゲームが多いように見えます。\u003cbr\u003e\n（そうなると前歩きからの波動拳が漏れなく昇龍拳になるので、それはそれでストレスかも……ここらへんは要調整ですね）\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"落ち穂拾い\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%90%BD%E3%81%A1%E7%A9%82%E6%8B%BE%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e落ち穂拾い\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ボタン順番押し系は行ける\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9C%E3%82%BF%E3%83%B3%E9%A0%86%E7%95%AA%E6%8A%BC%E3%81%97%E7%B3%BB%E3%81%AF%E8%A1%8C%E3%81%91%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eボタン順番押し系は行ける？\u003c/h2\u003e\n\n\u003cp\u003eいわゆる瞬獄殺・ダークネスイリュージョン系のコマンドです。\u003cbr\u003e\n基本的な考え方は同じで行けますが、\u003ccode\u003eCreateCommandObserver\u003c/code\u003eにいくつか手直しが必要です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIObservable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eIObservable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003einputObserverSelector\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 方向キーを識別するための関数\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eisDirection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"sc\"\u003e'1'\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"sc\"\u003e'9'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003einputObserverSelector\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 同じ入力が連続する場合、マージしてしまうと通知が重複して飛んでくるのを回避\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMerge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003einputObserverSelector\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]));\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// 最初の入力がボタンの場合は間隔チェックが必要\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nf\"\u003eisDirection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]))\u003c/span\u003e\n                             \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n                             \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecommand\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eobserver\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれでOKです。ただ、レバー入力主体のコマンドに比べて、間隔の猶予が10フレームだと若干厳しいかもしれないです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eshungoku\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCommandObserver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"AA6BC\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"一瞬千撃！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"同時押しは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%90%8C%E6%99%82%E6%8A%BC%E3%81%97%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e同時押しは？\u003c/h2\u003e\n\n\u003cp\u003eRxの得意とするところです！ABCボタンの同時押しを判定してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ehatsudo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'A'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'B'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'C'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'A'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'B'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'C'\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"じゃきーん！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e同時押しを判定したいキーのみが通過するフィルタを\u003ccode\u003eWhere\u003c/code\u003eで作り、\u003cbr\u003e\n\u003ccode\u003eBuffer\u003c/code\u003eで3つ取り出し、\u003cbr\u003e\nボタンが押されたフレームの最大値-最小値が規定フレーム(2)以内かどうかでフィルタし、\u003cbr\u003e\nキー情報のみの配列に変換し、\u003cbr\u003e\n対象とするキーが全て含まれているかを判定して、\u003cbr\u003e\n以下判定時の処理、という具合です。\u003c/p\u003e\n\n\u003cp\u003eRxとLinqの真骨頂ですね。同時押し猶予フレームを手軽に制御できるのも良い感じです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"連打系は\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%80%A3%E6%89%93%E7%B3%BB%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e連打系は？\u003c/h2\u003e\n\n\u003cp\u003eRxの得意とするところです！(その2)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ehyakuretu\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'D'\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e30\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"やっやっやっ\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e30フレーム以内に4回以上連打して発動、であれば上記のようになります。\u003cbr\u003e\n\u003ccode\u003eBuffer(4, 1)\u003c/code\u003eでボタン押し下げ4回分の通知を取り出し、先頭と末尾のフレーム差分が規定の時間内なら発動です。\u003cbr\u003e\nこれで書けるのは強いかと思います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"左右反転は\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%B7%A6%E5%8F%B3%E5%8F%8D%E8%BB%A2%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e左右反転は？\u003c/h2\u003e\n\n\u003cp\u003eキャラの方向が入れ替わるたびにObserverを作り直すのは効率悪いので……\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e左右両方向用のObserverを作って使い分ける\u003c/li\u003e\n\u003cli\u003eキャラ方向に応じて入力方向が入れ替わるKeyStreamを作って、それからObserverを作る\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eのどちらかが良さそうです。後者の方が効率良さそうですね。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"簡易入力のサポートは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B0%A1%E6%98%93%E5%85%A5%E5%8A%9B%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e簡易入力のサポートは？\u003c/h2\u003e\n\n\u003cp\u003e例えば41236を想定したコマンドを、426や16とすることで対応できますが、やりすぎると暴発しまくるので注意が必要です。\u003cbr\u003e\nあるいは、上下左右(8246)の許容範囲を789,123,741,963にまで広げる(いわゆる左要素、下要素などでOKとする)ことで、やりやすくなるかもしれませんが、機械的に適用していいかどうかは、ゲーム性にもよるかと思われます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"タメコマンドはレバー1回転は\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%BF%E3%83%A1%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AF%E3%83%AC%E3%83%90%E3%83%BC1%E5%9B%9E%E8%BB%A2%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eタメコマンドは？レバー1回転は？\u003c/h2\u003e\n\n\u003cp\u003eこれまでの実装に拡張が必要なので、次節でまとめて解説します。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"タメと1回転への対応\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%BF%E3%83%A1%E3%81%A81%E5%9B%9E%E8%BB%A2%E3%81%B8%E3%81%AE%E5%AF%BE%E5%BF%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eタメと1回転への対応\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode\u003eInputManager\u003c/code\u003eに拡張が必要なため、先に追加の下ごしらえを済ませます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"追加の下ごしらえ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%BF%BD%E5%8A%A0%E3%81%AE%E4%B8%8B%E3%81%94%E3%81%97%E3%82%89%E3%81%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e追加の下ごしらえ\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eKeyStream\u003c/code\u003eには方向とボタンの入力が混ざっているため、このままでは「方向キーのみを取り出したい」といった場合の条件式が若干書きづらいです。また、方向のタメ入力では「左要素」「下要素」のように、7 or 4 or 1や1 or 2 or 3といった複数方向の入力を許容するケースが出てきます。\u003c/p\u003e\n\n\u003cp\u003eそれともう1点、現在ボタンを離した通知も飛んできますが、この時に「何フレーム継続して押されていたか」を含められると、タメ押し系のコマンドが楽に作れそうです。\u003c/p\u003e\n\n\u003cp\u003eそこで、\u003ccode\u003eKeyInfo\u003c/code\u003e型を次のように拡張します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eKeyInfo\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eFrame\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 新たに持続フレームを保持するDurationを追加\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eDuration\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// これまでのStateは意味を変えず、0ならば押し下げ通知、1以上なら離し通知として扱う\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDuration\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 方向の入力であることを識別可能なプロパティを追加\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eIsDirection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"sc\"\u003e'1'\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"sc\"\u003e'9'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 上下左右方向の要素を持つかを示すメソッドを追加\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eHasAttribute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"sc\"\u003e'8'\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'7'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'8'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'9'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"sc\"\u003e'2'\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'1'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'2'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'3'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"sc\"\u003e'4'\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'7'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'4'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'1'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"sc\"\u003e'6'\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'9'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'6'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'3'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 厳密なエラーチェックは割愛\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e更にInputManagerを次のように拡張します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputManager\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 追加と修正のあるメンバ以外は省略\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 方向キーとボタンの押し下げ持続時間を保持するフィールド\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edirectionDuration\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ebuttonsDuration\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// テンキー表記変換をメソッド化\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eToDirection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e300\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e300\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e-=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e300\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e300\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e-=\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAcquire\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePoll\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epad\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCurrentState\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 方向切り替わり時に持続フレームを通知\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_keyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnNext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eToDirection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e()[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eDuration\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edirectionDuration\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 持続フレームをリセットしつつ新たな方向を押し下げ通知\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_keyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnNext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eToDirection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e()[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eDuration\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edirectionDuration\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 方向に変化がなかった場合は持続フレームをインクリメント\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edirectionDuration\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ebuttonName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"sc\"\u003e'A'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"sc\"\u003e'B'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"sc\"\u003e'C'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"sc\"\u003e'D'\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eButtons\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eButtons\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// 押し下げ時は0を、離し時は持続フレームを通知\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_keyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnNext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eKeyInfo\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuttonName\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eDuration\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eButtons\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebuttonsDuration\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebuttonsDuration\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eButtons\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// 押し下げ継続時は持続フレームをインクリメント\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebuttonsDuration\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprevState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれでタメとレバー1回転への対応準備ができました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"レバー1回転\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%AC%E3%83%90%E3%83%BC1%E5%9B%9E%E8%BB%A2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eレバー1回転\u003c/h2\u003e\n\n\u003cp\u003eでは早速書いてみましょう。若干ゴリ押し感ありますが。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e            \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eclockWise\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"89632147896321478\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecounterClockWise\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"87412369874123698\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003escrew\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsDirection\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e()).\u003c/span\u003e\u003cspan class=\"nf\"\u003eAggregate\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eclockWise\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ecounterClockWise\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMerge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'C'\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eIsDirection\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'C'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"フンッ！どりゃあ！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_cd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまず、方向キーの押し下げのみを取り出すために \u003ccode\u003eWhere(k =\u0026gt; k.IsDirection \u0026amp;\u0026amp; k.State)\u003c/code\u003e でフィルタします。\u003c/p\u003e\n\n\u003cp\u003eそして判定基準ですが、昨今のタイトルでは「5/8回転で1回転とみなす」という若干甘めの設定が多いようなので、それを採用します。テンキー表記だと6個分の入力になるので、 \u003ccode\u003eBuffer(6, 1)\u003c/code\u003e で取り出します。\u003c/p\u003e\n\n\u003cp\u003e入力間隔は、最初の方向は入れっぱなしでも良いことにして、2番目から最後の入力までがそれぞれ10フレーム以内ならOKというのを、まとめて50フレーム以内として判定しています。\u003c/p\u003e\n\n\u003cp\u003e次に、6個分の入力が連続した方向変化（時計回り or 反時計回り）かどうかを判断する方法として、方向を表す文字を連結して履歴を文字列化し、それが時計回りか反時計回りを表す文字列に含まれるかどうか、という判定を行っています。若干雑な気もしますが、お手軽に書けることを重視しました。\u003c/p\u003e\n\n\u003cp\u003e後は通常のコマンドと同じく、最後の入力を \u003ccode\u003eSelect\u003c/code\u003e して後ろに流し、ボタンの入力をマージして、\u003ccode\u003eBuffer(2, 1)\u003c/code\u003e で間隔と順序をチェックして、パスしたらコマンド成立として扱います。\u003ccode\u003eBuffer\u003c/code\u003eでまとめた配列に対しては、添え字でアクセスしてもいいですが、先頭と末尾であることを明示するなら\u003ccode\u003eFirst\u003c/code\u003eと\u003ccode\u003eLast\u003c/code\u003eを使った方が、配列の長さに影響されなくて良いかもしれません。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"タメ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%BF%E3%83%A1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eタメ\u003c/h2\u003e\n\n\u003cp\u003eタメ技といった場合、いわゆる \u003cimg alt=\":arrow_left:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2b05-fe0f.png\" title=\":arrow_left:\" width=\"20\" loading=\"lazy\"\u003eタメ\u003cimg alt=\":arrow_right:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/27a1-fe0f.png\" title=\":arrow_right:\" width=\"20\" loading=\"lazy\"\u003e\u003cimg alt=\":fist:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/270a.png\" title=\":fist:\" width=\"20\" loading=\"lazy\"\u003e や \u003cimg alt=\":arrow_down:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2b07-fe0f.png\" title=\":arrow_down:\" width=\"20\" loading=\"lazy\"\u003eタメ\u003cimg alt=\":arrow_up:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2b06-fe0f.png\" title=\":arrow_up:\" width=\"20\" loading=\"lazy\"\u003e\u003cimg alt=\":footprints:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/1f463.png\" title=\":footprints:\" width=\"20\" loading=\"lazy\"\u003e などのコマンドが代表的ですが、ボタンを長押しして離した時に発動するコマンドも存在します。ここではその両方を扱います。\u003c/p\u003e\n\n\u003cp\u003eまずは簡単な方から。ボタン2つの同時押しの後、どちらかを離した時に発動するコマンドの例です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eturnpunch\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'A'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'C'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'A'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'C'\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMerge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'A'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'C'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e60\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDuration\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\"フレームためたターンパンチ！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_cd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e同時押しの押し下げ判定までは前述の通りですが、その後マージしている条件式が \u003ccode\u003e!k.State\u003c/code\u003e で離し通知でフィルタするようになっています。\u003cbr\u003e\n更に、先んじて \u003ccode\u003eKeyInfo\u003c/code\u003e を拡張しておいたおかげで、\u003ccode\u003ek.Duration\u003c/code\u003e で何フレーム継続して押されていたかを取得することができます。これを使って、技の発動時に段階的に威力を変える、といったことが実現できます。\u003c/p\u003e\n\n\u003cp\u003eでは最後に、レバーのタメを使ったコマンドです。\u003cstrong\u003e4タメ6A\u003c/strong\u003eを判定してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esonic\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHasAttribute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'4'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHasAttribute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'4'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eTake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRepeat\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e40\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'6'\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003eObservable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReturn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                                    \u003cspan class=\"n\"\u003ekk\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ekk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'6'\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ekk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ekk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSwitch\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMerge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'A'\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eFrame\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eIsDirection\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'A'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ソニックブーム！\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_cd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e最後にもってきただけあって、なかなか複雑なことになっています。紐解いていきましょう。\u003c/p\u003e\n\n\u003cp\u003e方向変化でも持続フレームを取れるようにしましたが、やっかいなことに一般的な方向タメでは\u003cimg alt=\":arrow_left:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2b05-fe0f.png\" title=\":arrow_left:\" width=\"20\" loading=\"lazy\"\u003eと表記されていたら\u003cimg alt=\":arrow_upper_left:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2196-fe0f.png\" title=\":arrow_upper_left:\" width=\"20\" loading=\"lazy\"\u003eや\u003cimg alt=\":arrow_lower_left:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/2199-fe0f.png\" title=\":arrow_lower_left:\" width=\"20\" loading=\"lazy\"\u003eに入っていたフレームもカウントします。当初は\u003ccode\u003eInputManager\u003c/code\u003e内で、そういった要素ごとの持続フレームを持つことを考えましたが、あまり\u003ccode\u003eInputManager\u003c/code\u003eにゲーム固有の仕様を意識させるのもうまくありません。Rxのオペレータで書き切る方針で考えます。\u003c/p\u003e\n\n\u003cp\u003eやりたいことは「左要素を含む最初の通知を保持しつつ（その後左要素の方向をガシャガシャしたとしても無視して）左要素以外に入力が移った際の通知を捕まえて、タメ時間を判定できる」ところに持ち込むことです。要素単位でのキー指定には、以前に拡張した\u003ccode\u003eHasAttribute()\u003c/code\u003eを使って条件をシンプルに記述します。\u003c/p\u003e\n\n\u003cp\u003e最初の入力のみを受け取るのは\u003cstrong\u003eTake(1)\u003c/strong\u003eを付けることで実現できます。これを行うと、通知を受け取った時点でストリームはいったん「完了」状態となります。\u003ccode\u003eMerge\u003c/code\u003eは稼働中のストリームに別のストリームを合成するオペレータでしたが、完了したストリームには\u003cstrong\u003eConcat\u003c/strong\u003eで後続のストリームをつなげることができます。ここで左要素以外の初回の入力を受け取り、いつもの\u003ccode\u003eBuffer(2, 1)\u003c/code\u003eでまとめます。このままだと、1回の\u003ccode\u003eSubscribe\u003c/code\u003eで一度しかこのペアを受け取ることができませんので、\u003cstrong\u003eRepeat\u003c/strong\u003eでこの流れを繰り返すように指示します。\u003c/p\u003e\n\n\u003cp\u003e後はタメ時間を判定して、次のレバー入力の判定……といきたいのですが、タメを解除した方向がぴったり次のコマンドの方向だった場合と、そうでない場合があり得るのをケアしないといけません。\u003ccode\u003e!k.HasAttribute('4')\u003c/code\u003eは 8,5,2,9,6,3 のいずれかで成立します。6 ならばその入力情報をそのままもう一度流し、そうでなければ 6 を待つストリームからの通知を待つようにする。これを実現するのが、\u003ccode\u003eSelect\u003c/code\u003e内での3項演算子による分岐と、その後ろにある\u003cstrong\u003eSwitch\u003c/strong\u003eの組み合わせです。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eSelect\u003c/code\u003eは値を変換して後続にパスするだけでなく、受け取った値を使って生成した\u003ccode\u003eIObservable\u003c/code\u003e自体を後続に投げる使い方もあります。その場合、\u003ccode\u003eSelect\u003c/code\u003eの後ろには引数を取らない\u003ccode\u003eMerge\u003c/code\u003eや\u003ccode\u003eSwitch\u003c/code\u003eを置いて合成を行うのがお決まりのパターンです。特に\u003ccode\u003eSelect\u003c/code\u003e\u0026amp;\u003ccode\u003eMerge\u003c/code\u003eの組み合わせは\u003ccode\u003eSelectMany\u003c/code\u003eと同様の効果を持ちます。\u003c/p\u003e\n\n\u003cp\u003e最後の A ボタン入力待ちは、通常のコマンドと同様でOKです。コマンドオブザーバーのファクトリ関数を拡張する場合は、タメの後の方向までを1セットで扱うと、反復的に処理できて良さそうですね。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おわりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおわりに\u003c/h1\u003e\n\n\u003cp\u003eかなり大更新になってしまいましたが、コードをきれいにしたらGitHubあたりで公開することも考えています。そうしたらまたここでお知らせします。\u003c/p\u003e\n\n\u003cp\u003eまた、どなたかこの記事を参考に格闘ゲーム作ったらご一報ください。遊びに行きます。\u003cbr\u003e\nReactive Fighters 2020、お待ちしております。\u003c/p\u003e\n","createdAt":"2020-05-07T09:05:57Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"MGbgWdb0eWWBbjsrZq2XJ87BoyKe2GVyMg==--2/czgLeo/fep5s5K--H02kP1sf1YPvLASuaO6DSg==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-05-11T15:26:49Z","likesCount":69,"linkUrl":"https://qiita.com/rita0222/items/c67338cd7f8ca9ac11af","organization":null,"originalId":1218609,"stockedCount":55,"title":"格闘ゲームのコマンド判定をReactiveに書いてみた","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8B%95%E6%A9%9F\"\u003e動機\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9B%B4%E6%96%B0%E5%B1%A5%E6%AD%B4\"\u003e更新履歴\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%8B%E3%81%94%E3%81%97%E3%82%89%E3%81%88\"\u003e下ごしらえ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A0%BC%E9%97%98%E3%82%B2%E3%83%BC%E3%83%A0%E3%81%AE%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E8%A6%81%E6%B1%82%E4%BB%95%E6%A7%98\"\u003e格闘ゲームのコマンドに関する要求仕様\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B4%A0%E6%97%A9%E3%81%8F%E5%85%A5%E5%8A%9B%E3%81%99%E3%82%8B\"\u003e素早く入力する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A4%9A%E5%B0%91%E4%BD%99%E8%A8%88%E3%81%AA%E5%85%A5%E5%8A%9B%E3%82%82%E8%A8%B1%E5%AE%B9%E3%81%99%E3%82%8B\"\u003e多少余計な入力も許容する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#rx%E3%81%AE%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%BF%E3%82%92%E9%A7%86%E4%BD%BF%E3%81%97%E3%81%A6%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%AA%E3%83%96%E3%82%B6%E3%83%BC%E3%83%90%E3%83%BC%E3%82%92%E4%BD%9C%E3%82%8B\"\u003eRxのオペレータを駆使してコマンドオブザーバーを作る\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1-%E7%89%B9%E5%AE%9A%E3%81%AE%E5%85%A5%E5%8A%9B%E3%81%AE%E3%81%BF%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B\"\u003e1. 特定の入力のみを抽出する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2-%E6%AC%A1%E3%81%AE%E5%85%A5%E5%8A%9B%E3%82%92%E3%83%9E%E3%83%BC%E3%82%B8%E3%81%99%E3%82%8B\"\u003e2. 次の入力をマージする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3-%E5%85%A5%E5%8A%9B%E3%81%AE%E9%A0%86%E5%BA%8F%E3%81%A8%E9%96%93%E9%9A%94%E3%82%92%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%99%E3%82%8B\"\u003e3. 入力の順序と間隔をチェックする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E6%96%87%E5%AD%97%E5%88%97%E3%81%8B%E3%82%89observer%E3%82%92%E7%94%9F%E6%88%90%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e4. コマンド文字列からobserverを生成できるようにする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#5-%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%AA%E3%83%96%E3%82%B6%E3%83%BC%E3%83%90%E3%83%BC%E3%82%92%E3%81%98%E3%82%83%E3%82%93%E3%81%98%E3%82%83%E3%82%93%E4%BD%9C%E3%81%A3%E3%81%A6%E4%BD%BF%E3%81%86\"\u003e5. コマンドオブザーバーをじゃんじゃん作って使う\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%90%BD%E3%81%A1%E7%A9%82%E6%8B%BE%E3%81%84\"\u003e落ち穂拾い\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9C%E3%82%BF%E3%83%B3%E9%A0%86%E7%95%AA%E6%8A%BC%E3%81%97%E7%B3%BB%E3%81%AF%E8%A1%8C%E3%81%91%E3%82%8B\"\u003eボタン順番押し系は行ける？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%90%8C%E6%99%82%E6%8A%BC%E3%81%97%E3%81%AF\"\u003e同時押しは？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%80%A3%E6%89%93%E7%B3%BB%E3%81%AF\"\u003e連打系は？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%B7%A6%E5%8F%B3%E5%8F%8D%E8%BB%A2%E3%81%AF\"\u003e左右反転は？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B0%A1%E6%98%93%E5%85%A5%E5%8A%9B%E3%81%AE%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%AF\"\u003e簡易入力のサポートは？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%BF%E3%83%A1%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AF%E3%83%AC%E3%83%90%E3%83%BC1%E5%9B%9E%E8%BB%A2%E3%81%AF\"\u003eタメコマンドは？レバー1回転は？\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%BF%E3%83%A1%E3%81%A81%E5%9B%9E%E8%BB%A2%E3%81%B8%E3%81%AE%E5%AF%BE%E5%BF%9C\"\u003eタメと1回転への対応\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%BF%BD%E5%8A%A0%E3%81%AE%E4%B8%8B%E3%81%94%E3%81%97%E3%82%89%E3%81%88\"\u003e追加の下ごしらえ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%AC%E3%83%90%E3%83%BC1%E5%9B%9E%E8%BB%A2\"\u003eレバー1回転\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%BF%E3%83%A1\"\u003eタメ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003eおわりに\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":4879,"uuid":"c67338cd7f8ca9ac11af","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"niQCtj9XgAHivHncpyTqSgWah7E=--iSOMoKpvCetIEYih--csU3eYbaqA6rvfFO8bFUIA==","originalId":58083,"description":"","facebookUrl":null,"githubUrl":"https://github.com/rita0222","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/58083/profile-images/1478538396","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F58083%2Fprofile-images%2F1478538396?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=5ead75e85b5a2234cf4c45bbad65fcbf","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F58083%2Fprofile-images%2F1478538396?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=436812485ffbd2258edea3e289914295","urlName":"rita0222","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"game","urlName":"game"},{"name":"ReactiveExtensions","urlName":"reactiveextensions"},{"name":"input","urlName":"input"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
