UnityでHTTPリクエストを投げるのって割と面倒なんですよね。
UnityWebRequest で簡単 HTTP(POST)通信 | 株式会社ビヨンド
こちらでUnityWebRequestを使って簡単にPOSTリクエストを行う方法が解説されていました。
これをベースにGETリクエストも行えるようにして、細かい部分を自分なりに使いやすいようカスタマイズしたところ、割と実用的なレベルになったのではと思うので、公開します。
(元記事の作成者である株式会社ビヨンドの松山賢勝さんに許可をいただいております。ありがとうございます！)基本的な動作の流れや利用している技術は 元記事 とほとんど変わっていないため、そちらをご参照ください。
本記事では使い方のみ記載します。元記事に書いていない処理で気になるところがあれば質問していただけたらと思います。まずコールしたいAPIのエンドポイント1つにつき1つのクラスを作成します。
必要なコーディングは最低この3つがあればOKです。
以下、サンプルコードを見ながら使い方を説明していきます。順番に見ていきましょう。この書き方で int型の city をリクエストパラメータとして送ることになります。レスポンスもリクエストパラメータの方と基本的に書き方は同じです。
データが階層構造になっている場合は構造体(struct)で定義してください。コンストラクタ内でリクエスト内容の設定を行います。
BaseUrl, EndPoint にはそれぞれ名前の通りベースとなるURLとエンドポイントの情報をセットしてください。
今回のサンプルでは 天気予報 API（livedoor 天気互換） を使わせていただきました。
最後に引数から受け取った city をリクエストパラメータにセットしています。
(ヘッダー情報のセットも可能ですが、POSTの方で説明します。)以上でGETリクエストを行う場合のAPIクラスは完成です。POSTリクエストもGETリクエストと全く同じ書き方です。GETと同じですね。
POSTは登録不要で使えるAPIを見つけられなかったので、ダミーのURLでセットしています。
ヘッダー設定は
Headers.Add("content-type", "application/json");
このようにDectionary型で追加してください。各APIのクラスを作成したら、実際にAPIのコールを実行する側の処理を書きます。こちらも順番に見ていきましょう。久留米の地域IDをリクエストパラメータにセットしてAPIのインスタンスを初期化しています。getApi.Get&lt;Api.GetWeatherApi.Request&gt;(ref getApi.request, result =&gt;
この書き方にちょっとクセがありますね。
基底クラスでGETリクエストの実行を Get&lt;T&gt;() として定義しており、TはRequestの構造体を指定します。
リクエストに成功した場合は result.isSuccess にTrueがセットされるので、 if (result.isSuccess) の中の処理が走ります。
getApi.response = getApi.Response&lt;Api.GetWeatherApi.Response&gt;(); でJson形式のレスポンスをAPIクラスの中で定義したResponseの構造体に変換しています。
else にはリクエストに失敗した場合のエラー処理を書いてください。リクエストの実行が Post&lt;T&gt;() になっているだけで、GETとほとんど同じですね。
ちなみにコメントにも書いてある通り、こちらはダミーのURLを叩いているためリクエストは失敗します。
ちゃんとGETの方は成功して、POSTの方は失敗してますね。
GETの方よりPOSTのログが先に出力されているのは、APIのコール処理を非同期で行っているためです。
処理の順番が重要な場合はこの辺も気にする必要があります。
詳しくはこの記事が参考になります！GET/POSTのどちらの場合でもほとんど同じ記法でリクエストが行えるようにしました。
「とりあえずUnityでHTTPリクエストをしたい」という方には十分ではないでしょうか。ソースコードを公開しているので自由にお使いください。
実現できなかったこととしてなどがあります。どなたかチャレンジいただければ非常に嬉しいです(プルリクお待ちしてます…！)最後に、あらためて素晴らしい元記事の作成者である株式会社ビヨンドの松山賢勝さんにお礼を申し上げます！ありがとうございました！！
UnityWebRequest で簡単 HTTP(POST)通信 | 株式会社ビヨンド


