Azure/azure-functions-templates のリポジトリで初めて dotnet の template を触るので個別の技術を理解しようとチュートリアルを流して意味を見ることにした。これを流して理解してみる。下記のようなディレクトリ構造を作る。extensions の配下がテンプレートのルートになる。.template.config ディレクトリが存在する箇所がテンプレートの場所になる。サンプルでは簡単な Extension メソッドを作成する。単純に文字列をリバースするだけの簡単なコードだ。このコードを extension ディレクトリ配下に配置する。今回のテンプレートは、Item と呼ばれる種類で、プロジェクト自体を生成するテンプレートではなくて、プロジェクトを作った後に、プロジェクトの中に追加するアイテムを作成するためのテンプレートになる。StringExtensions.cs.template.config の下に template.json を作成する。下記のような内容になる。template.json大切な箇所は少ない。よくある extension の設定ファイルという感じだ。classifications はいわゆるTagである。 name, shortname はご想像の通りで、名前を付けているのみ。ポイントは、 type: の箇所に item を指定している。project というのも選択可能のようだ。スキーマを確認してみよう。スキーマを読めば定義は明確で、 identity は、テンプレートのユニークな名前なので、他と被らない名前付けが必要なのだろう。作成は上記で終了。
思ったよりずっと簡単だ。テンプレートのインストールは、dotnet new -i &lt;directory&gt; になる。今回は、テンプレートのルートを指定すると良い。ちなみに、-i のオプションをつけて、新しいバージョンをインストールすると、単に上書きされる。インストールは、今回のようにファイルシステムでも良いが、Nuget パッケージからも可能なようだ。次のような実行結果になり、再生されたテンプレートがインストールされたのがわかる。では実際につかってみよう。
ところで、インストールされたテンプレートはどこに保存されるのだろうか？指定したディレクトリを参照するのだろうか？もしくしゃ、どこかにCache が村債するのだろうか？あたりをつけて調べてみたけどわからないので、Windows のディレクトリをフル検索してみたが、キャッシュ的なディレクトリは見つからなかった。（もしくは、アーカイブされている可能性はあるのだが）この辺りも今後読み進めていくと、明確になってくるだろうか。コンソールアプリのテンプレートを使って、コンソールアプリのプロジェクトを作る。既にテンプレートをインストールしているので、どこのディレクトリでも良い。出来たプロジェクトに対して、Itemテンプレートを適用してみよう。先ほどのテンプレートの shortname を指定してインストールする。しっかり拡張メソッドを持ったクラスが追加されている。Program を拡張メソッドを使いように改造する。Program.csうむ。いい感じである。ではテンプレートの削除はどうだろう？アンインストールの場合は相対パスではなく、フルパスが必要になる。その情報を見つけるにはどうするか？というとで現在インストールされているリストを見ることが出来るのでそれを活用する。これは、Item とさほど大差はない。単純にプロジェクトを作ってみようcsproj と cs ファイルが出来上がる。中身をちょっとだけ変える。Program.cs先ほどと違うのは、tags の type の箇所だ。project が指定されている。.template.config/template.json同様の方法でインストールNuGetファイルを作ると、複数のテンプレートをまとめることが出来る。２つのテンプレートが既にあるので、その上位のディレクトリ、working ディレクトリに行く。その中に templatesディレクトリがある。
ここで、テンプレートパックと呼ばれるNuGetファイルを作る。名前は、templatepack カレントディレクトリにテンプレートを出力する。生成された csproj ファイルを編集する　PackageIdでユニークな名前を指定している。またプロジェクトに含む、含まないのエントリが ItemGroup で指定されているのに注目したい。ここで先に作成されたテンプレートを含むようにする。これも上記のものと同様だが、作成されたNuGetのファイルを指定する。先ほど作成されたテンプレートが二つとも含まれているのがわかるだろう。クリーンアップも同じだが、NuGetからインストールした場合は、分からなくなると思うので確認する。テンプレートの名前を指定する。次は、Action Id 等のテンプレートでジェネレートされるIDの意味も読み解いていきたい。


