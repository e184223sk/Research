<!DOCTYPE html><html><head><meta charset="utf-8" /><title>C#のクラスの内部構造を黒魔術で分析してみた - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/WakateKun/items/103d61a1f9e2fac6324d" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="zlXYa8E334bXtInTYyS/gEJamRB/IkZGjXuf26ur0FjhXRNiYFJ1vnxUSUMbrXYhA5PND6BtnzTRLsncjvI+RQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="C#のクラスの内部構造を黒魔術で分析してみた - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReVBqZ2E3amdxX2pnNm5qZ3JuamdhN2xob1hwZzZqbXA0dnBnS0RqZ3BMcHU1THByWlRvb1pQamdhZmxpSWJtbnBEamdaZmpnYWJqZ2JfamdaOCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz02NDY5MmJiYmE3ZWEwZDQ2NTZhNmU2MTBkYzg3NDUwZg&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRmRoYTJGMFpVdDFiZyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWU4NWZkY2FhYzdhOGE1MTU1YTg0MWU2MWE1MTg0ODU4&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=2d6f8dc87cd3b6be27f193f503c95833"><meta property="og:description" content="

全てはこの疑問から始まった。

皆さんはC#プログラマをやっているなら一度は疑問に思ったことがあるでしょうそうでしょう。

「インスタンスってどうやって変数を保持してるんだろう」

と。

え？思ったことないって？それは粛（殴）
..."><meta content="https://qiita.com/WakateKun/items/103d61a1f9e2fac6324d" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,class,struct,Pointer,unsafe" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-197bac84-1e58-485d-8262-a3899820f721"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FWakateKun%2Fitems%2F103d61a1f9e2fac6324d">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FWakateKun%2Fitems%2F103d61a1f9e2fac6324d">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-197bac84-1e58-485d-8262-a3899820f721">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2021-01-14T02:36:39.000+09:00","dateModified":"2021-01-14T02:36:39.000+09:00","headline":"C#のクラスの内部構造を黒魔術で分析してみた","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReVBqZ2E3amdxX2pnNm5qZ3JuamdhN2xob1hwZzZqbXA0dnBnS0RqZ3BMcHU1THByWlRvb1pQamdhZmxpSWJtbnBEamdaZmpnYWJqZ2JfamdaOCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz02NDY5MmJiYmE3ZWEwZDQ2NTZhNmU2MTBkYzg3NDUwZg\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRmRoYTJGMFpVdDFiZyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWU4NWZkY2FhYzdhOGE1MTU1YTg0MWU2MWE1MTg0ODU4\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=2d6f8dc87cd3b6be27f193f503c95833","mainEntityOfPage":"https://qiita.com/WakateKun/items/103d61a1f9e2fac6324d","author":{"@type":"Person","address":"","email":null,"identifier":"WakateKun","name":"WakateKun","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Fprofile-images%2F1630976431?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=485a833d538dc9ccaced490df6d22756","url":"https://qiita.com/WakateKun","description":"C# / python3 /Rなどなど。ヒトの人工脳とトランスクリプトームの研究をしています。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita&amp;utm_medium=header-banner">「最高の開発者体験」を目指す NewsPicks開発チーム</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"WakateKun","type":"items","id":"103d61a1f9e2fac6324d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「最高の開発者体験」を目指す NewsPicks開発チーム","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"WakateKun","type":"items","id":"103d61a1f9e2fac6324d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「最高の開発者体験」を目指す NewsPicks開発チーム","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"WakateKun","type":"items","id":"103d61a1f9e2fac6324d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「最高の開発者体験」を目指す NewsPicks開発チーム","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/WakateKun/items/103d61a1f9e2fac6324d","location":"/WakateKun/items/103d61a1f9e2fac6324d","scheme":"https","host":"qiita.com","port":null,"pathname":"/WakateKun/items/103d61a1f9e2fac6324d","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"f8GXwCUNJsY5bHsj8YPEjQsgAj5zmNH2aA19T3kJs51QyVzJhGiM/pKMu7OJCg0sSulWIazXCIQ0WCtIXFBdgA==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-c70bc934-6ed7-4fc3-9bbf-6ed0289a1ddb"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/WakateKun/items/103d61a1f9e2fac6324d/likers" class="css-1iupg5d">6</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">5</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/103d61a1f9e2fac6324d/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/WakateKun/items/103d61a1f9e2fac6324d/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/WakateKun/items/103d61a1f9e2fac6324d/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/WakateKun/items/103d61a1f9e2fac6324d/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/WakateKun/items/103d61a1f9e2fac6324d.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/WakateKun"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/profile-images/1630976431" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/WakateKun" class="css-10ougpm">@<!-- -->WakateKun</a><div class="css-1ay9vb9"><time dateTime="2021-01-13T17:36:39Z" class="css-m19uds">posted at 2021-01-13</time></div></div></div></div></div><h1 class="css-cgzq40">C#のクラスの内部構造を黒魔術で分析してみた</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/class" class="css-4czcte">class</a><a href="/tags/struct" class="css-4czcte">struct</a><a href="/tags/pointer" class="css-4czcte">Pointer</a><a href="/tags/unsafe" class="css-4czcte">unsafe</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="全てはこの疑問から始まった" class="fragment"></span><a href="#%E5%85%A8%E3%81%A6%E3%81%AF%E3%81%93%E3%81%AE%E7%96%91%E5%95%8F%E3%81%8B%E3%82%89%E5%A7%8B%E3%81%BE%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>全てはこの疑問から始まった。</h1>

<p>皆さんはC#プログラマをやっているなら一度は疑問に思ったことがあるでしょうそうでしょう。</p>

<p>「インスタンスってどうやって変数を保持してるんだろう」</p>

<p>と。</p>

<p>え？思ったことないって？それは粛（殴）</p>

<p>そもそもC#という言語はポインタなんぞ面倒なことは気にしなくてもコードがかけてしまう、そんな素敵な言語なのです。<br>
従って我々C#プログラマは、このインスタンスはどこに保存されているいるんだ？だとか、Fieldってどこに保存されてるの？とか、ましてやTypeってどうやって管理されているの？なんてことは気にしなくて良いのです。</p>

<p>実際、そんなことはネット上に記事で載ってないです。</p>

<p>ただ時に「無駄なメモリなんぞ1bitも使いたくない！」とか「boxing？なにそれおいしいの？するわけないじゃん笑」とか「純粋にクラスってどうなってるんだ」とか考える変態さん（褒め言葉）がいらっしゃるわけです。</p>

<p>そこでこの記事では、そんな変態さんのためにそもそも論に立ち返り、</p>

<p><strong>「クラス」の根本的な仕組み</strong></p>

<p>をポインタという概念から紐解いていきたいと思います。</p>

<p>この記事を読んだ暁には皆さんも最適化の沼に嵌っていることでしょうきっと。</p>

<p>※記事の内容に間違いなどありましたらコメントにて指摘いただけると幸いです。</p>

<h1>
<span id="この記事を読んでわかること" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A7%E3%82%8F%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事を読んでわかること</h1>

<ul>
<li>インスタンスはどのようにして変数を保持しているのか</li>
<li>Type、FieldInfoの根本的な仕組み</li>
<li>Boxingなんてもってのほか、ILを使って最適化?
--&gt;Unsafeを使えば一発で解決</li>
</ul>

<h1>
<span id="インスタンスとは何ぞや" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%9E%E3%82%84"><i class="fa fa-link"></i></a>インスタンスとは何ぞや</h1>

<p>C#はオブジェクト指向な言語です。従って、クラスという構造（正確にはType）を定義し、そのインスタンスを作ることで、個別にデータを管理できるわけです。（とっても便利でわかりやすい）</p>

<p>しかし、そんな恩恵を受けられるが故、裏ではちょっと複雑なことをしているのです。</p>

<h2>
<span id="値型と参照型理論" class="fragment"></span><a href="#%E5%80%A4%E5%9E%8B%E3%81%A8%E5%8F%82%E7%85%A7%E5%9E%8B%E7%90%86%E8%AB%96"><i class="fa fa-link"></i></a>値型と参照型（理論）</h2>

<p>さて、質問です。クラスの中で実体のあるデータはどんなデータでしょう？</p>

<p>例えば下のようなクラスがあったとします。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Data.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Data</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">Nested</span> <span class="n">nested</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Nested</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">val2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>実際にデータ（値）を持っているのは<code>val</code>と<code>val2</code>だけです。<code>nested</code>は値を持ってはいません。<br>
即ち、実体のあるデータは「値を持っている」データのみです。<br>
このように、直接値を持たなくても良い変数を参照型変数、値を持つ変数を値型変数と言います。</p>

<p>値型はスタック領域（実際に値を持つメモリ領域）に、参照型はヒープ領域（インスタンスを保持するメモリ領域）という仮想メモリ領域に保持されています。</p>

<p>そして、この参照型はヒープ領域にいるインスタンスの参照（ポインタ）を保持しているのです。</p>

<h2>
<span id="値型と参照型現実" class="fragment"></span><a href="#%E5%80%A4%E5%9E%8B%E3%81%A8%E5%8F%82%E7%85%A7%E5%9E%8B%E7%8F%BE%E5%AE%9F"><i class="fa fa-link"></i></a>値型と参照型（現実）</h2>

<p>しかし、現実の保持のされ方を見てみるとこの理論ではわかりにくい部分があります。<br>
もっと直感的に示した図を載せます。<br>
<a href="https://camo.qiitausercontent.com/39df467fe81a6f74fe03d6a23ac8b60fd4cbc60d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3136333031322f66343562336234642d303137302d306131622d663739372d3336663636316361623861662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Ff45b3b4d-0170-0a1b-f797-36f661cab8af.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=081b17146d1f3c4c5f3d29c2606729d9" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/f45b3b4d-0170-0a1b-f797-36f661cab8af.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Ff45b3b4d-0170-0a1b-f797-36f661cab8af.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8f32b0b5056409eecc26fbf7bdd7b2c3 1x" loading="lazy"></a></p>

<p>因みにこちらの図に示している構造は私がポインタを解析して出した答えなので間違っていたらごめんなさい。</p>

<p>そもそもデータは基本（ローカル変数以外は）インスタンスの中に保持されます。値はむき出しにならず大体の場合はクラスの中に入ってしまいます。ですので、スタックとかヒープに分けて考えるより、こっちの方が直感的かなと思います。</p>

<p>C#のインスタンスではまず、先頭に自分のインスタンスのポインタをInt64のサイズで保存しています（8byte）。そして、その後の8byteでType Handlerのポインタを保持しています。（後の項で説明します）</p>

<p>その後、そのインスタンス内に保持しているインスタンス（ネストしたインスタンス）へのポインタを保持、最後に実データを保持しています。</p>

<p>このように、インスタンスはポインタとデータのbyte配列で構成されているのです。</p>

<p>はい、これでインスタンスのデータを保持することができるようになりました。<br>
(インスタンスはどのようにして変数を保持しているのかの答え)</p>

<h1>
<span id="typeとは何ぞや" class="fragment"></span><a href="#type%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%9E%E3%82%84"><i class="fa fa-link"></i></a>Typeとは何ぞや</h1>

<p>C#プログラマにとって、Typeは大事な存在です。</p>

<p>こいつがなければType-safeなプログラムがかけず、勿論我らがIntelliSense君（コードを予測して出してくれるアレ）も機能してくれません。</p>

<p>しかし、実際にコードを走らせる際、「このTypeとこのフィールドを...」とかやっていたら重くて仕方ありません。そこで、C#はRuntimeTypeHandleというものをメモリ上に生成することで素早いコード実行を実現しています。</p>

<p>そして、インスタンスを生成する時は必ず、先頭から9 byte目から16 byte目までの8 byte区間にTypeHandleのポインタを書き込みます。</p>

<p>因みにこのTypehandleには</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">code.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">//Handleにアクセス</span>
<span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="n">TypeHandle</span><span class="p">;</span>
<span class="c1">//IntPtrにアクセス</span>
<span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="n">TypeHandle</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</code></pre></div>
</div>

<p>でPublicにアクセスできますので見てみるといいかもしれないです。</p>

<p>また、Fieldなどについても同様にFieldInfoの中にFieldHandleがありますので是非確認してみると幸せになれるかもしれません（たぶんなれない）</p>

<p>(Type、FieldInfoの根本的な仕組みの答え)</p>

<h1>
<span id="unsafeを使った黒魔術" class="fragment"></span><a href="#unsafe%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E9%BB%92%E9%AD%94%E8%A1%93"><i class="fa fa-link"></i></a>Unsafeを使った黒魔術</h1>

<p>さて皆さんお待たせいたしました。</p>

<p>実践編です。</p>

<h2>
<span id="reflectionなにそれおいしいの" class="fragment"></span><a href="#reflection%E3%81%AA%E3%81%AB%E3%81%9D%E3%82%8C%E3%81%8A%E3%81%84%E3%81%97%E3%81%84%E3%81%AE"><i class="fa fa-link"></i></a>Reflection？なにそれおいしいの。</h2>

<p>Reflectionはよく耳にするFieldなどの動的取得法です。</p>

<p>いいところ：簡単。誰でもできる。<br>
悪いところ：遅い。黒魔術じゃない。</p>

<p>はい、皆さんなら使いませんね。（強制）</p>

<p>というのは投げやりなので一応説明しておきます。</p>

<p>Reflectionを使えばクラスの内部構造を取得し、その取得した結果に基づいてFieldの値を取得できてしまいます。</p>

<p>こんな感じで取得します。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">FieldGetterReflection.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">FieldGetter</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">Getter</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">FieldInfo</span> <span class="n">fieldInfo</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="nf">GetField</span><span class="p">(</span><span class="s">"FieldName"</span><span class="p">);</span>
        <span class="n">T</span> <span class="n">obj</span> <span class="p">=</span> <span class="s">"Data"</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">fieldInfo</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>後はfieldInfoとobjに適切なデータを入れてください。<br>
ね？とっても簡単でしょう？</p>

<p>しかし、ここに重要な落とし穴があります。<br>
<code>fieldInfo.GetValue(obj);</code>この部分のコード定義を見てみましょう。</p>

<p><a href="https://camo.qiitausercontent.com/291366dd5aecf70dfa4e3587511afdeeeab62158/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3136333031322f35323536633637632d396237302d633035642d643137642d6332653166363839346538352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2F5256c67c-9b70-c05d-d17d-c2e1f6894e85.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=39ebfb46b231d7a146d275057739fc75" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/5256c67c-9b70-c05d-d17d-c2e1f6894e85.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2F5256c67c-9b70-c05d-d17d-c2e1f6894e85.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b506f0a2f66eac4a36e3d207c995f1d1 1x" loading="lazy"></a></p>

<p>ふぁっ！？なんと？<br>
返り値がobjectじゃないですかやだー</p>

<p>そう。これがReflectionが遅くなる原因です。</p>

<p>Fieldの中身が先ほど話した参照型であれば大した問題はおきません。<br>
しかし、これが値型だった場合は大きな問題が生じます。</p>

<p>値型はスタック領域にデータがいます。<br>
しかし、objectは参照型であるため、値型のデータを引っ張ってきて<strong>わざわざ</strong>ヒープ領域に持っていき、さらに<strong>わざわざ</strong>値型に直すハメになるのです。コードでこれを再現するとこんな感じ。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">hogehoge.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">// 100をdataの中に入れる</span>
<span class="kt">int</span> <span class="n">data</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">object</span><span class="p">)</span><span class="m">100</span><span class="p">;</span>
</code></pre></div>
</div>

<p>あ ほ く さ。</p>

<p>はい。これが理由です。</p>

<p>なんで<code>GetValue&lt;T&gt;</code>を実装しなかったんだろう()。</p>

<p>ということでReflectionを使うのがおすすめできない理由はこれです。</p>

<h2>
<span id="il生成やっぱやりたくない" class="fragment"></span><a href="#il%E7%94%9F%E6%88%90%E3%82%84%E3%81%A3%E3%81%B1%E3%82%84%E3%82%8A%E3%81%9F%E3%81%8F%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>IL生成？やっぱやりたくない。</h2>

<p>よく最適化をするにあたって、ILを使うという解決策があります。</p>

<p>ILとは共通中間言語（intermediate language）の略で、.Netで最も低水準な命令を書くのに使われる言語です。</p>

<p>そこで直接ILを書き、動的にコンパイルさせちゃえばいいじゃんということになるわけです。</p>

<p>因みに、フィールドの変数を取ってくるILコードを作っておいたので参考までに。<br>
（中身は単純で、インスタンスをスタックに積み上げ、Ldfldに渡してRetというものを書いてるだけです）</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">FieldGetterIL.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">FieldGetter</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">Getter</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">FieldInfo</span> <span class="n">fieldInfo</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="nf">GetField</span><span class="p">(</span><span class="s">"FieldName"</span><span class="p">);</span>
        <span class="n">T</span> <span class="n">obj</span> <span class="p">=</span> <span class="s">"Data"</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">met</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Emit</span><span class="p">.</span><span class="nf">DynamicMethod</span><span class="p">(</span><span class="s">"Get"</span><span class="p">,</span>
            <span class="n">fieldInfo</span><span class="p">.</span><span class="n">FieldType</span><span class="p">,</span> <span class="k">new</span> <span class="n">Type</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">FieldInfo</span><span class="p">)</span> <span class="p">});</span>
        <span class="kt">var</span> <span class="n">il</span> <span class="p">=</span> <span class="n">met</span><span class="p">.</span><span class="nf">GetILGenerator</span><span class="p">();</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Emit</span><span class="p">.</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Emit</span><span class="p">.</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldfld</span><span class="p">,</span> <span class="n">fieldInfo</span><span class="p">);</span>
        <span class="n">il</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Emit</span><span class="p">.</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ret</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">del</span> <span class="p">=</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Delegate</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;)</span><span class="n">met</span><span class="p">.</span><span class="nf">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Delegate</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;));</span>
        <span class="kt">var</span> <span class="n">func</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">obj</span><span class="p">);</span>
        <span class="n">del</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>TにはオブジェクトのType、objには実際のオブジェクトを入れればOKです。<br>
後は出来たdelをちゃんとキャッシュしておけば問題ありません。</p>

<p>実際大変便利な、便利すぎる手法なのですが、残念ながらC#が多く活躍するUnityで使われるIL2CPP（c++に直してくれるというもの、iOSなどでは良く使われる）では使用できません。<br>
また、せっかくポインタでやればいいのに、動的コンパイルの時間が無駄です。</p>

<p>おすすめしたいのはやまやまですが、IL2CPPで使えないのが痛すぎる。ので、却下です。</p>

<h2>
<span id="unsafeという黒魔術真" class="fragment"></span><a href="#unsafe%E3%81%A8%E3%81%84%E3%81%86%E9%BB%92%E9%AD%94%E8%A1%93%E7%9C%9F"><i class="fa fa-link"></i></a>Unsafeという黒魔術（真）</h2>

<p>最後に残された手段、Unsafeクラスです。<br>
これはそもそもデフォルトで使えないようになっているのでNuGetとかでSystem.Runtime.CompilerServices.Unsafeと調べ、インスコしちゃいましょう。</p>

<p><a href="https://camo.qiitausercontent.com/8d0f3258507ccb8ab931a098314757c5f34a2a20/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3136333031322f62343232383964632d356338352d376135612d636536642d3930663533316134393161372e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Fb42289dc-5c85-7a5a-ce6d-90f531a491a7.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a7ccc4f7f424589700fb1ac890330663" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/b42289dc-5c85-7a5a-ce6d-90f531a491a7.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Fb42289dc-5c85-7a5a-ce6d-90f531a491a7.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1651f03ba5fe87826fc4db9389859722 1x" loading="lazy"></a></p>

<p>こんな感じです。</p>

<p>すると、<code>System.Runtime.CompilerServices.Unsafe</code>が使えるようになります。<br>
それでは先ほどの例を基にコードを作っていきましょう。</p>

<p><a href="https://camo.qiitausercontent.com/39df467fe81a6f74fe03d6a23ac8b60fd4cbc60d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3136333031322f66343562336234642d303137302d306131622d663739372d3336663636316361623861662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Ff45b3b4d-0170-0a1b-f797-36f661cab8af.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=081b17146d1f3c4c5f3d29c2606729d9" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/f45b3b4d-0170-0a1b-f797-36f661cab8af.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Ff45b3b4d-0170-0a1b-f797-36f661cab8af.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8f32b0b5056409eecc26fbf7bdd7b2c3 1x" loading="lazy"></a><br>
まず、Dataのインスタンス、dataインスタンスのポインタを取得してみましょう。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Unsafe.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">Unsafe</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">&gt;(</span><span class="k">ref</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>
</div>

<p>こんな感じです。これでポインタ（を安全に使える）IntPtrが返ってきます。<br>
このIntPtrが「自分のポインタ」の部分であるハズです。</p>

<p>従って、nestedを示すポインタは</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Unsafe.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">unsafe</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">data_ptr</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">*)</span><span class="n">Unsafe</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">&gt;(</span><span class="k">ref</span> <span class="n">data</span><span class="p">).</span><span class="nf">ToPointer</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">nested_ptr_arr</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">8</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">8</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
         <span class="c1">//先頭の16byte分ずらしたところから8byte分だけ切り取る</span>
         <span class="n">nested_ptr_arr</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">*((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">data_ptr</span> <span class="p">+</span> <span class="m">16</span> <span class="p">+</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">var</span> <span class="n">nested_ptr</span> <span class="p">=</span> <span class="p">(</span><span class="k">void</span><span class="p">*)</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt64</span><span class="p">(</span><span class="n">nested_ptr_arr</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>こんな感じで取得できます。(OffsetとかBitConverterを使わないとかそういう最適化をすればもっと早いですが。)<br>
こういう感じで、ポインタを駆使しながら解析をしてしまえば、理論上最速でデータをそのまま持ってくることができます。</p>

<p>また、同様にvalのポインタ（val_ptr）を計算し、Marshalで適当に確保したbyte領域に対しコピーして突っ込んであげれば</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Copy.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">dest</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">AllocHGlobal</span><span class="p">(</span><span class="m">4</span><span class="p">);</span>
<span class="n">Unsafe</span><span class="p">.</span><span class="nf">CopyBlock</span><span class="p">(</span><span class="n">dest</span><span class="p">.</span><span class="nf">ToPointer</span><span class="p">(),</span> <span class="n">val_ptr</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
</code></pre></div>
</div>

<p>こんな感じで理論上最速でbyte変換（実際はそもそも変換をしない。stackにいるbyteデータをそのままコピっているだけなので）しちゃえばOKです。</p>

<p>私が考え付く限り、これが最速のチューニング方法です。</p>

<h1>
<span id="結局" class="fragment"></span><a href="#%E7%B5%90%E5%B1%80"><i class="fa fa-link"></i></a>結局？</h1>

<p>長々とお付き合いいただきありがとうございました。</p>

<p>「インスタンスってどうやって変数を保持してるんだろう」</p>

<p>の疑問を解決することは出来ましたでしょうか？</p>

<p>Unsafeを好きになってくれましたでしょうか？</p>

<p>この記事を読んで、少しでも好きになってくれたら私としてはとても嬉しい限りです。</p>

<p>最速というところに焦点を置き、仕組みを一から研究してみるというのも面白いC#の遊び方なのではないでしょうか？</p>

<p>是非これを機に、皆さんも黒魔術の沼にはまってみてはいかがでしょうか？</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FWakateKun%2Fitems%2F103d61a1f9e2fac6324d&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FWakateKun%2Fitems%2F103d61a1f9e2fac6324d&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/WakateKun/items/103d61a1f9e2fac6324d/likers" class="css-1iupg5d">6</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">5</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/103d61a1f9e2fac6324d/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/WakateKun/items/103d61a1f9e2fac6324d/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/WakateKun/items/103d61a1f9e2fac6324d/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/WakateKun/items/103d61a1f9e2fac6324d/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/WakateKun/items/103d61a1f9e2fac6324d.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-c70bc934-6ed7-4fc3-9bbf-6ed0289a1ddb">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-ba9b8d1c-e752-403b-acd8-1ccee1434607"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-ba9b8d1c-e752-403b-acd8-1ccee1434607">{}</script>
      
<div id="LoginModal-react-component-e8b8985d-bc2d-49b5-981f-a1699f7c5ec5"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-e8b8985d-bc2d-49b5-981f-a1699f7c5ec5">{}</script>
      
<div id="StockModal-react-component-ce2b509a-be7e-4d62-8586-c8980970044f"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-ce2b509a-be7e-4d62-8586-c8980970044f">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;7fVwmkYSv+Opfqm4CQohoBytFgSZO5Mjr8V+Ao/uEhTC/buT53cV2wKeaShxg+gBXWRCG0Z0SlHzkCgFqrf8CQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"全てはこの疑問から始まった\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%85%A8%E3%81%A6%E3%81%AF%E3%81%93%E3%81%AE%E7%96%91%E5%95%8F%E3%81%8B%E3%82%89%E5%A7%8B%E3%81%BE%E3%81%A3%E3%81%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e全てはこの疑問から始まった。\u003c/h1\u003e\n\n\u003cp\u003e皆さんはC#プログラマをやっているなら一度は疑問に思ったことがあるでしょうそうでしょう。\u003c/p\u003e\n\n\u003cp\u003e「インスタンスってどうやって変数を保持してるんだろう」\u003c/p\u003e\n\n\u003cp\u003eと。\u003c/p\u003e\n\n\u003cp\u003eえ？思ったことないって？それは粛（殴）\u003c/p\u003e\n\n\u003cp\u003eそもそもC#という言語はポインタなんぞ面倒なことは気にしなくてもコードがかけてしまう、そんな素敵な言語なのです。\u003cbr\u003e\n従って我々C#プログラマは、このインスタンスはどこに保存されているいるんだ？だとか、Fieldってどこに保存されてるの？とか、ましてやTypeってどうやって管理されているの？なんてことは気にしなくて良いのです。\u003c/p\u003e\n\n\u003cp\u003e実際、そんなことはネット上に記事で載ってないです。\u003c/p\u003e\n\n\u003cp\u003eただ時に「無駄なメモリなんぞ1bitも使いたくない！」とか「boxing？なにそれおいしいの？するわけないじゃん笑」とか「純粋にクラスってどうなってるんだ」とか考える変態さん（褒め言葉）がいらっしゃるわけです。\u003c/p\u003e\n\n\u003cp\u003eそこでこの記事では、そんな変態さんのためにそもそも論に立ち返り、\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e「クラス」の根本的な仕組み\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eをポインタという概念から紐解いていきたいと思います。\u003c/p\u003e\n\n\u003cp\u003eこの記事を読んだ暁には皆さんも最適化の沼に嵌っていることでしょうきっと。\u003c/p\u003e\n\n\u003cp\u003e※記事の内容に間違いなどありましたらコメントにて指摘いただけると幸いです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"この記事を読んでわかること\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A7%E3%82%8F%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこの記事を読んでわかること\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eインスタンスはどのようにして変数を保持しているのか\u003c/li\u003e\n\u003cli\u003eType、FieldInfoの根本的な仕組み\u003c/li\u003e\n\u003cli\u003eBoxingなんてもってのほか、ILを使って最適化?\n--\u0026gt;Unsafeを使えば一発で解決\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"インスタンスとは何ぞや\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%9E%E3%82%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eインスタンスとは何ぞや\u003c/h1\u003e\n\n\u003cp\u003eC#はオブジェクト指向な言語です。従って、クラスという構造（正確にはType）を定義し、そのインスタンスを作ることで、個別にデータを管理できるわけです。（とっても便利でわかりやすい）\u003c/p\u003e\n\n\u003cp\u003eしかし、そんな恩恵を受けられるが故、裏ではちょっと複雑なことをしているのです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"値型と参照型理論\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%80%A4%E5%9E%8B%E3%81%A8%E5%8F%82%E7%85%A7%E5%9E%8B%E7%90%86%E8%AB%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e値型と参照型（理論）\u003c/h2\u003e\n\n\u003cp\u003eさて、質問です。クラスの中で実体のあるデータはどんなデータでしょう？\u003c/p\u003e\n\n\u003cp\u003e例えば下のようなクラスがあったとします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eData.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eData\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eNested\u003c/span\u003e \u003cspan class=\"n\"\u003enested\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eNested\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eval2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e実際にデータ（値）を持っているのは\u003ccode\u003eval\u003c/code\u003eと\u003ccode\u003eval2\u003c/code\u003eだけです。\u003ccode\u003enested\u003c/code\u003eは値を持ってはいません。\u003cbr\u003e\n即ち、実体のあるデータは「値を持っている」データのみです。\u003cbr\u003e\nこのように、直接値を持たなくても良い変数を参照型変数、値を持つ変数を値型変数と言います。\u003c/p\u003e\n\n\u003cp\u003e値型はスタック領域（実際に値を持つメモリ領域）に、参照型はヒープ領域（インスタンスを保持するメモリ領域）という仮想メモリ領域に保持されています。\u003c/p\u003e\n\n\u003cp\u003eそして、この参照型はヒープ領域にいるインスタンスの参照（ポインタ）を保持しているのです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"値型と参照型現実\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%80%A4%E5%9E%8B%E3%81%A8%E5%8F%82%E7%85%A7%E5%9E%8B%E7%8F%BE%E5%AE%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e値型と参照型（現実）\u003c/h2\u003e\n\n\u003cp\u003eしかし、現実の保持のされ方を見てみるとこの理論ではわかりにくい部分があります。\u003cbr\u003e\nもっと直感的に示した図を載せます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/39df467fe81a6f74fe03d6a23ac8b60fd4cbc60d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3136333031322f66343562336234642d303137302d306131622d663739372d3336663636316361623861662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Ff45b3b4d-0170-0a1b-f797-36f661cab8af.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=081b17146d1f3c4c5f3d29c2606729d9\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/f45b3b4d-0170-0a1b-f797-36f661cab8af.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Ff45b3b4d-0170-0a1b-f797-36f661cab8af.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8f32b0b5056409eecc26fbf7bdd7b2c3 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e因みにこちらの図に示している構造は私がポインタを解析して出した答えなので間違っていたらごめんなさい。\u003c/p\u003e\n\n\u003cp\u003eそもそもデータは基本（ローカル変数以外は）インスタンスの中に保持されます。値はむき出しにならず大体の場合はクラスの中に入ってしまいます。ですので、スタックとかヒープに分けて考えるより、こっちの方が直感的かなと思います。\u003c/p\u003e\n\n\u003cp\u003eC#のインスタンスではまず、先頭に自分のインスタンスのポインタをInt64のサイズで保存しています（8byte）。そして、その後の8byteでType Handlerのポインタを保持しています。（後の項で説明します）\u003c/p\u003e\n\n\u003cp\u003eその後、そのインスタンス内に保持しているインスタンス（ネストしたインスタンス）へのポインタを保持、最後に実データを保持しています。\u003c/p\u003e\n\n\u003cp\u003eこのように、インスタンスはポインタとデータのbyte配列で構成されているのです。\u003c/p\u003e\n\n\u003cp\u003eはい、これでインスタンスのデータを保持することができるようになりました。\u003cbr\u003e\n(インスタンスはどのようにして変数を保持しているのかの答え)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"typeとは何ぞや\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#type%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%9E%E3%82%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTypeとは何ぞや\u003c/h1\u003e\n\n\u003cp\u003eC#プログラマにとって、Typeは大事な存在です。\u003c/p\u003e\n\n\u003cp\u003eこいつがなければType-safeなプログラムがかけず、勿論我らがIntelliSense君（コードを予測して出してくれるアレ）も機能してくれません。\u003c/p\u003e\n\n\u003cp\u003eしかし、実際にコードを走らせる際、「このTypeとこのフィールドを...」とかやっていたら重くて仕方ありません。そこで、C#はRuntimeTypeHandleというものをメモリ上に生成することで素早いコード実行を実現しています。\u003c/p\u003e\n\n\u003cp\u003eそして、インスタンスを生成する時は必ず、先頭から9 byte目から16 byte目までの8 byte区間にTypeHandleのポインタを書き込みます。\u003c/p\u003e\n\n\u003cp\u003e因みにこのTypehandleには\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ecode.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e//Handleにアクセス\u003c/span\u003e\n\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eTypeHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//IntPtrにアクセス\u003c/span\u003e\n\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eTypeHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eでPublicにアクセスできますので見てみるといいかもしれないです。\u003c/p\u003e\n\n\u003cp\u003eまた、Fieldなどについても同様にFieldInfoの中にFieldHandleがありますので是非確認してみると幸せになれるかもしれません（たぶんなれない）\u003c/p\u003e\n\n\u003cp\u003e(Type、FieldInfoの根本的な仕組みの答え)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"unsafeを使った黒魔術\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unsafe%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E9%BB%92%E9%AD%94%E8%A1%93\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUnsafeを使った黒魔術\u003c/h1\u003e\n\n\u003cp\u003eさて皆さんお待たせいたしました。\u003c/p\u003e\n\n\u003cp\u003e実践編です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"reflectionなにそれおいしいの\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#reflection%E3%81%AA%E3%81%AB%E3%81%9D%E3%82%8C%E3%81%8A%E3%81%84%E3%81%97%E3%81%84%E3%81%AE\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eReflection？なにそれおいしいの。\u003c/h2\u003e\n\n\u003cp\u003eReflectionはよく耳にするFieldなどの動的取得法です。\u003c/p\u003e\n\n\u003cp\u003eいいところ：簡単。誰でもできる。\u003cbr\u003e\n悪いところ：遅い。黒魔術じゃない。\u003c/p\u003e\n\n\u003cp\u003eはい、皆さんなら使いませんね。（強制）\u003c/p\u003e\n\n\u003cp\u003eというのは投げやりなので一応説明しておきます。\u003c/p\u003e\n\n\u003cp\u003eReflectionを使えばクラスの内部構造を取得し、その取得した結果に基づいてFieldの値を取得できてしまいます。\u003c/p\u003e\n\n\u003cp\u003eこんな感じで取得します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eFieldGetterReflection.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFieldGetter\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eFieldInfo\u003c/span\u003e \u003cspan class=\"n\"\u003efieldInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetField\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"FieldName\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Data\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efieldInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e後はfieldInfoとobjに適切なデータを入れてください。\u003cbr\u003e\nね？とっても簡単でしょう？\u003c/p\u003e\n\n\u003cp\u003eしかし、ここに重要な落とし穴があります。\u003cbr\u003e\n\u003ccode\u003efieldInfo.GetValue(obj);\u003c/code\u003eこの部分のコード定義を見てみましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/291366dd5aecf70dfa4e3587511afdeeeab62158/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3136333031322f35323536633637632d396237302d633035642d643137642d6332653166363839346538352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2F5256c67c-9b70-c05d-d17d-c2e1f6894e85.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=39ebfb46b231d7a146d275057739fc75\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/5256c67c-9b70-c05d-d17d-c2e1f6894e85.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2F5256c67c-9b70-c05d-d17d-c2e1f6894e85.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b506f0a2f66eac4a36e3d207c995f1d1 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eふぁっ！？なんと？\u003cbr\u003e\n返り値がobjectじゃないですかやだー\u003c/p\u003e\n\n\u003cp\u003eそう。これがReflectionが遅くなる原因です。\u003c/p\u003e\n\n\u003cp\u003eFieldの中身が先ほど話した参照型であれば大した問題はおきません。\u003cbr\u003e\nしかし、これが値型だった場合は大きな問題が生じます。\u003c/p\u003e\n\n\u003cp\u003e値型はスタック領域にデータがいます。\u003cbr\u003e\nしかし、objectは参照型であるため、値型のデータを引っ張ってきて\u003cstrong\u003eわざわざ\u003c/strong\u003eヒープ領域に持っていき、さらに\u003cstrong\u003eわざわざ\u003c/strong\u003e値型に直すハメになるのです。コードでこれを再現するとこんな感じ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ehogehoge.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 100をdataの中に入れる\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eあ ほ く さ。\u003c/p\u003e\n\n\u003cp\u003eはい。これが理由です。\u003c/p\u003e\n\n\u003cp\u003eなんで\u003ccode\u003eGetValue\u0026lt;T\u0026gt;\u003c/code\u003eを実装しなかったんだろう()。\u003c/p\u003e\n\n\u003cp\u003eということでReflectionを使うのがおすすめできない理由はこれです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"il生成やっぱやりたくない\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#il%E7%94%9F%E6%88%90%E3%82%84%E3%81%A3%E3%81%B1%E3%82%84%E3%82%8A%E3%81%9F%E3%81%8F%E3%81%AA%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eIL生成？やっぱやりたくない。\u003c/h2\u003e\n\n\u003cp\u003eよく最適化をするにあたって、ILを使うという解決策があります。\u003c/p\u003e\n\n\u003cp\u003eILとは共通中間言語（intermediate language）の略で、.Netで最も低水準な命令を書くのに使われる言語です。\u003c/p\u003e\n\n\u003cp\u003eそこで直接ILを書き、動的にコンパイルさせちゃえばいいじゃんということになるわけです。\u003c/p\u003e\n\n\u003cp\u003e因みに、フィールドの変数を取ってくるILコードを作っておいたので参考までに。\u003cbr\u003e\n（中身は単純で、インスタンスをスタックに積み上げ、Ldfldに渡してRetというものを書いてるだけです）\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eFieldGetterIL.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFieldGetter\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eFieldInfo\u003c/span\u003e \u003cspan class=\"n\"\u003efieldInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetField\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"FieldName\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Data\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003emet\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReflection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDynamicMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Get\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efieldInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFieldType\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eType\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFieldInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eil\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetILGenerator\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eil\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReflection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOpCodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLdarg_0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eil\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReflection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOpCodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLdfld\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efieldInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eil\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReflection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOpCodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRet\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edel\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;)\u003c/span\u003e\u003cspan class=\"n\"\u003emet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;));\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eTにはオブジェクトのType、objには実際のオブジェクトを入れればOKです。\u003cbr\u003e\n後は出来たdelをちゃんとキャッシュしておけば問題ありません。\u003c/p\u003e\n\n\u003cp\u003e実際大変便利な、便利すぎる手法なのですが、残念ながらC#が多く活躍するUnityで使われるIL2CPP（c++に直してくれるというもの、iOSなどでは良く使われる）では使用できません。\u003cbr\u003e\nまた、せっかくポインタでやればいいのに、動的コンパイルの時間が無駄です。\u003c/p\u003e\n\n\u003cp\u003eおすすめしたいのはやまやまですが、IL2CPPで使えないのが痛すぎる。ので、却下です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"unsafeという黒魔術真\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unsafe%E3%81%A8%E3%81%84%E3%81%86%E9%BB%92%E9%AD%94%E8%A1%93%E7%9C%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUnsafeという黒魔術（真）\u003c/h2\u003e\n\n\u003cp\u003e最後に残された手段、Unsafeクラスです。\u003cbr\u003e\nこれはそもそもデフォルトで使えないようになっているのでNuGetとかでSystem.Runtime.CompilerServices.Unsafeと調べ、インスコしちゃいましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/8d0f3258507ccb8ab931a098314757c5f34a2a20/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3136333031322f62343232383964632d356338352d376135612d636536642d3930663533316134393161372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Fb42289dc-5c85-7a5a-ce6d-90f531a491a7.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a7ccc4f7f424589700fb1ac890330663\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/b42289dc-5c85-7a5a-ce6d-90f531a491a7.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Fb42289dc-5c85-7a5a-ce6d-90f531a491a7.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1651f03ba5fe87826fc4db9389859722 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこんな感じです。\u003c/p\u003e\n\n\u003cp\u003eすると、\u003ccode\u003eSystem.Runtime.CompilerServices.Unsafe\u003c/code\u003eが使えるようになります。\u003cbr\u003e\nそれでは先ほどの例を基にコードを作っていきましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/39df467fe81a6f74fe03d6a23ac8b60fd4cbc60d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3136333031322f66343562336234642d303137302d306131622d663739372d3336663636316361623861662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Ff45b3b4d-0170-0a1b-f797-36f661cab8af.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=081b17146d1f3c4c5f3d29c2606729d9\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/f45b3b4d-0170-0a1b-f797-36f661cab8af.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Ff45b3b4d-0170-0a1b-f797-36f661cab8af.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8f32b0b5056409eecc26fbf7bdd7b2c3 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nまず、Dataのインスタンス、dataインスタンスのポインタを取得してみましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eUnsafe.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eUnsafe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAs\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこんな感じです。これでポインタ（を安全に使える）IntPtrが返ってきます。\u003cbr\u003e\nこのIntPtrが「自分のポインタ」の部分であるハズです。\u003c/p\u003e\n\n\u003cp\u003e従って、nestedを示すポインタは\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eUnsafe.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edata_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003eUnsafe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAs\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToPointer\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enested_ptr_arr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"c1\"\u003e//先頭の16byte分ずらしたところから8byte分だけ切り取る\u003c/span\u003e\n         \u003cspan class=\"n\"\u003enested_ptr_arr\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e*((\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003edata_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e16\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enested_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enested_ptr_arr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこんな感じで取得できます。(OffsetとかBitConverterを使わないとかそういう最適化をすればもっと早いですが。)\u003cbr\u003e\nこういう感じで、ポインタを駆使しながら解析をしてしまえば、理論上最速でデータをそのまま持ってくることができます。\u003c/p\u003e\n\n\u003cp\u003eまた、同様にvalのポインタ（val_ptr）を計算し、Marshalで適当に確保したbyte領域に対しコピーして突っ込んであげれば\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eCopy.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edest\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAllocHGlobal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003eUnsafe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCopyBlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToPointer\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eval_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこんな感じで理論上最速でbyte変換（実際はそもそも変換をしない。stackにいるbyteデータをそのままコピっているだけなので）しちゃえばOKです。\u003c/p\u003e\n\n\u003cp\u003e私が考え付く限り、これが最速のチューニング方法です。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"結局\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E5%B1%80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結局？\u003c/h1\u003e\n\n\u003cp\u003e長々とお付き合いいただきありがとうございました。\u003c/p\u003e\n\n\u003cp\u003e「インスタンスってどうやって変数を保持してるんだろう」\u003c/p\u003e\n\n\u003cp\u003eの疑問を解決することは出来ましたでしょうか？\u003c/p\u003e\n\n\u003cp\u003eUnsafeを好きになってくれましたでしょうか？\u003c/p\u003e\n\n\u003cp\u003eこの記事を読んで、少しでも好きになってくれたら私としてはとても嬉しい限りです。\u003c/p\u003e\n\n\u003cp\u003e最速というところに焦点を置き、仕組みを一から研究してみるというのも面白いC#の遊び方なのではないでしょうか？\u003c/p\u003e\n\n\u003cp\u003e是非これを機に、皆さんも黒魔術の沼にはまってみてはいかがでしょうか？\u003c/p\u003e\n","createdAt":"2021-01-13T17:36:39Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"VdNvuegcDzP5Oi5He2riJKdq4T7PlFZBHw==--gXHRcBLXGu6wH4FH--lMtiZLPu3HUVKHhV7D+P8A==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2021-01-13T17:36:39Z","likesCount":6,"linkUrl":"https://qiita.com/WakateKun/items/103d61a1f9e2fac6324d","organization":null,"originalId":1377048,"stockedCount":5,"title":"C#のクラスの内部構造を黒魔術で分析してみた","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%85%A8%E3%81%A6%E3%81%AF%E3%81%93%E3%81%AE%E7%96%91%E5%95%8F%E3%81%8B%E3%82%89%E5%A7%8B%E3%81%BE%E3%81%A3%E3%81%9F\"\u003e全てはこの疑問から始まった。\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A7%E3%82%8F%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8\"\u003eこの記事を読んでわかること\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%9E%E3%82%84\"\u003eインスタンスとは何ぞや\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%80%A4%E5%9E%8B%E3%81%A8%E5%8F%82%E7%85%A7%E5%9E%8B%E7%90%86%E8%AB%96\"\u003e値型と参照型（理論）\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%80%A4%E5%9E%8B%E3%81%A8%E5%8F%82%E7%85%A7%E5%9E%8B%E7%8F%BE%E5%AE%9F\"\u003e値型と参照型（現実）\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#type%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%9E%E3%82%84\"\u003eTypeとは何ぞや\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unsafe%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E9%BB%92%E9%AD%94%E8%A1%93\"\u003eUnsafeを使った黒魔術\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#reflection%E3%81%AA%E3%81%AB%E3%81%9D%E3%82%8C%E3%81%8A%E3%81%84%E3%81%97%E3%81%84%E3%81%AE\"\u003eReflection？なにそれおいしいの。\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#il%E7%94%9F%E6%88%90%E3%82%84%E3%81%A3%E3%81%B1%E3%82%84%E3%82%8A%E3%81%9F%E3%81%8F%E3%81%AA%E3%81%84\"\u003eIL生成？やっぱやりたくない。\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unsafe%E3%81%A8%E3%81%84%E3%81%86%E9%BB%92%E9%AD%94%E8%A1%93%E7%9C%9F\"\u003eUnsafeという黒魔術（真）\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E5%B1%80\"\u003e結局？\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":833,"uuid":"103d61a1f9e2fac6324d","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"ByOIi+w84eIDKK0BuF8CdkRfj9bc--hfSGT9r11esjGg4g--GSZQcjl2VKS0QoNPmdYm7w==","originalId":163012,"description":"C# / python3 /Rなどなど。ヒトの人工脳とトランスクリプトームの研究をしています。","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"ワカテ 君","profileImageUrl":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/163012/profile-images/1630976431","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Fprofile-images%2F1630976431?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=670b74d988a751ff01c7c83133e7051d","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F163012%2Fprofile-images%2F1630976431?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=485a833d538dc9ccaced490df6d22756","urlName":"WakateKun","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"class","urlName":"class"},{"name":"struct","urlName":"struct"},{"name":"Pointer","urlName":"pointer"},{"name":"unsafe","urlName":"unsafe"}],"followingLikers":{"edges":[]},"comments":{"totalCount":1}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
