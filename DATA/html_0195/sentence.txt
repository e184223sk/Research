.NET Core + Docker(Alpine)な環境でZStandardで圧縮したデータをAPIに投げる要件が出てきました。
この記事では、ZstdNetを利用してZStandardで圧縮したデータをHTTPでリクスエトする方法について説明します。ZStandardはfacebookがオープンソース化したライブラリで、高い圧縮率を実現する高速圧縮アルゴリズムだそうです。ZStandardのホームページには、.NETで利用できるライブラリとして下記3つが紹介されています。今回はgithubで最もスターが多かったZstdNetを利用していきます。コード自体はZstdNetのgithubにあるサンプルコードを参考にとりあえず次のコードで圧縮しています。CompressionOptionsクラスのコンストラクタに対する引数は圧縮レベルで、1-19の範囲で指定することができます（デフォルトは3）。あとは圧縮したデータのcontent-typeをzstdにして送ってあげればよいです。Visual Studioが作ってくれるDockerfileでそのまま動かそうとすると、下記のようにlibzstdが見当たらないよという例外が発生してしまいます。zstd net Unable to load shared library 'libzstd' or one of its dependencies. In order to help diagnose loading problems, consider setting the LD_DEBUG environment variable: Error loading shared library liblibzstd: No such file or directoryZstdNetはネイティブライブラリであるlibzstdのラッパーでしかないので、Windows以外の環境で実行する場合は個別にインストールする必要があります（Windows用のlibzstd.dllはnugetで一緒にインストールされます）。
Alpineの場合、zstd-libsというパッケージがmainリポジトリで公開されているのでapk addしてあげます。また、上記のパッケージを追加した場合、/usr/lib/ディレクトリにlibzstd.so.1とlibzstd.so.1.4.5の2つのファイルが配置されるのですが、ZstdNetはlibzstd.soという名前でネイティブライブラリを探しに行くのでシンボリックリンクを作成して騙してあげます。Dockerfileは次のようになります。通信電文を見た限りちゃんと圧縮されているようです。


