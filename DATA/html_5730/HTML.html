<!DOCTYPE html><html><head><meta charset="utf-8" /><title>ASP.net MVC 5 で Stripe のカード決済を試してみる - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/yukataoka/items/1c6b34818f6b7753631a" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="HW7Afo+1TPulyqEMAHF0JDpG1LOWrKErI6qgdYvUNXmBjQ45P7CKtDEVEY+UKTpgV4Yz0n+X+M3aZSwDyt1uqQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@ykataoka" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="ASP.net MVC 5 で Stripe のカード決済を試してみる - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RVk5RTG01bGRDQk5Wa01nTlNEamdhY2dVM1J5YVhCbElPT0JydU9DcS1PRHZPT0RpZWF4dXVhNGlPT0NrdWlwcHVPQmwtT0JwdU9Cdi1PQ2l3JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTNkOGEzMGI2YjlkNTRiNGIwYWEzNjI3ZWVkYzdjYmIx&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSGwxYTJGMFlXOXJZUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTlhZmQ0OTU4Y2I4N2I2MjIyMWM5YmE4NDUyN2M2YTMw&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=db09fafe44f5c28778c04b8563ddd443"><meta property="og:description" content="

経緯

これは JP_Stripes (Stripe ユーザーグループ）in 松山 キックオフ のLT登壇のためにまとめた記事です。

オンライン決済で話題になっているStripe 、LT登壇ネタとして、ちょうど仕事の開発でも使っ..."><meta content="https://qiita.com/yukataoka/items/1c6b34818f6b7753631a" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,ASP.NET,stripe,mvc,カード決済" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-50e7cfbe-5472-42e9-a4c5-708c69284df4"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fyukataoka%2Fitems%2F1c6b34818f6b7753631a">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fyukataoka%2Fitems%2F1c6b34818f6b7753631a">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-50e7cfbe-5472-42e9-a4c5-708c69284df4">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2017-12-14T17:58:05.000+09:00","dateModified":"2017-12-21T12:06:49.000+09:00","headline":"ASP.net MVC 5 で Stripe のカード決済を試してみる","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RVk5RTG01bGRDQk5Wa01nTlNEamdhY2dVM1J5YVhCbElPT0JydU9DcS1PRHZPT0RpZWF4dXVhNGlPT0NrdWlwcHVPQmwtT0JwdU9Cdi1PQ2l3JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTNkOGEzMGI2YjlkNTRiNGIwYWEzNjI3ZWVkYzdjYmIx\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSGwxYTJGMFlXOXJZUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTlhZmQ0OTU4Y2I4N2I2MjIyMWM5YmE4NDUyN2M2YTMw\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=db09fafe44f5c28778c04b8563ddd443","mainEntityOfPage":"https://qiita.com/yukataoka/items/1c6b34818f6b7753631a","author":{"@type":"Person","address":"kochi, Japan","email":null,"identifier":"yukataoka","name":"yukataoka","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F75892%2Fprofile-images%2F1512029696?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=627b67c001043b46f9248bb3d252c04f","url":"https://qiita.com/yukataoka","description":"若い頃にUターンしたIT屋で、出身は高知県仁淀川町。IoTとクラウドを活用した地域課題解決などに挑戦。\r\nコミュニティ活動の傍ら、サイボウズ公認 kintone エバンジェリスト も務める複業者。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"yukataoka","type":"items","id":"1c6b34818f6b7753631a"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"yukataoka","type":"items","id":"1c6b34818f6b7753631a"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"yukataoka","type":"items","id":"1c6b34818f6b7753631a"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/yukataoka/items/1c6b34818f6b7753631a","location":"/yukataoka/items/1c6b34818f6b7753631a","scheme":"https","host":"qiita.com","port":null,"pathname":"/yukataoka/items/1c6b34818f6b7753631a","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"dhyHunjQT9j1lRS8SelWE9nxg5A8LMatUavlrm3/u83q/0n9yNWJl2FKpD/dsRhXtDFk8dUXn0uoZGnYLPbgHQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-028e96a5-79fc-4714-91ad-817f8308788a"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/yukataoka/items/1c6b34818f6b7753631a/likers" class="css-1iupg5d">5</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">12</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/1c6b34818f6b7753631a/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/yukataoka/items/1c6b34818f6b7753631a/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/yukataoka/items/1c6b34818f6b7753631a/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/yukataoka/items/1c6b34818f6b7753631a/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/yukataoka/items/1c6b34818f6b7753631a.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/yukataoka"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/75892/profile-images/1512029696" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/yukataoka" class="css-10ougpm">@<!-- -->yukataoka</a><div class="css-1ay9vb9"><span><meta content="2017-12-14T08:58:05Z"/><time dateTime="2017-12-21T03:06:49Z" class="css-m19uds">updated at 2017-12-21</time></span></div></div></div></div></div><h1 class="css-cgzq40">ASP.net MVC 5 で Stripe のカード決済を試してみる</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/asp.net" class="css-4czcte">ASP.NET</a><a href="/tags/stripe" class="css-4czcte">stripe</a><a href="/tags/mvc" class="css-4czcte">mvc</a><a href="/tags/%e3%82%ab%e3%83%bc%e3%83%89%e6%b1%ba%e6%b8%88" class="css-4czcte">カード決済</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="経緯" class="fragment"></span><a href="#%E7%B5%8C%E7%B7%AF"><i class="fa fa-link"></i></a>経緯</h1>

<p>これは <a href="http://eventregist.com/e/JP_Stripes_MYJ" title="JP_Stripes" rel="nofollow noopener" target="_blank">JP_Stripes (Stripe ユーザーグループ）in 松山 キックオフ</a> のLT登壇のためにまとめた記事です。</p>

<p>オンライン決済で話題になっている<a href="https://stripe.com/jp" title="Stripe" rel="nofollow noopener" target="_blank">Stripe</a> 、LT登壇ネタとして、ちょうど仕事の開発でも使っている ASP.net MVC 5 で、噂どおり簡単に実装できるか試してみることにしました。<br>
結果、簡単過ぎて、、、開発する手ごたえがないほど楽でした。（笑）</p>

<h2>
<span id="試すこと" class="fragment"></span><a href="#%E8%A9%A6%E3%81%99%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>試すこと</h2>

<p>会員がログインした後、商品を発注しカード決済するまでの一連の流れを想定して実装してみます。</p>

<p>「会員登録」→「ログイン」→「商品を発注」→「カード決済入力」→「カード決裁結果を表示」</p>

<p>使用するPCの環境は以下です。</p>

<ul>
<li>OS : Windows 10 Professional</li>
<li>開発環境 : VisualStudio 2017 Professional</li>
</ul>

<h1>
<span id="実装してみる" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>実装してみる</h1>

<h2>
<span id="手順" class="fragment"></span><a href="#%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>手順</h2>

<ol>
<li>
<a href="https://stripe.com/jp" title="Stripe" rel="nofollow noopener" target="_blank">Stripe</a> のアカウント登録</li>
<li>ASP.net MVC 5 のプロジェクトを、認証は「個別ユーザアカウント」を選択し作成</li>
<li>
<a href="https://github.com/stripe/stripe-dotnet" title="Stripe.net" rel="nofollow noopener" target="_blank">Stripe.net</a> のクラスライブラリィを設定</li>
<li>ASP.net MVC のプロジェクトに課金処理を実装・テスト</li>
</ol>

<p>以上の手順で進めます。</p>

<h2>
<span id="stripe-のアカウント登録" class="fragment"></span><a href="#stripe-%E3%81%AE%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E7%99%BB%E9%8C%B2"><i class="fa fa-link"></i></a>Stripe のアカウント登録</h2>

<p>以下の Stripe のサイトにアクセスし「アカウント登録」を行いましょう。<br>
<a href="https://stripe.com/jp" class="autolink" rel="nofollow noopener" target="_blank">https://stripe.com/jp</a><br>
簡単なので説明は省略します。</p>

<p>アカウント登録が終わったらダッシュボードに進みましょう。<br>
Unnamed Acount が作成されていますが、私は試験用のアカウントを追加しました。</p>

<p><a href="https://camo.qiitausercontent.com/58164773bc45e5f64a0f5f4e55fe287259b2bb42/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706530332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe03.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1e0eea47421813e8361c1c7fe68c07c1" alt="ダッシュボード" title="ダッシュボード" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe03.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe03.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5a901200a1e4337d81ba91053e733413 1x" loading="lazy"></a></p>

<p>早速売上があるように見えてますが、これはテストデータです。（笑）<br>
テストデータは消せれるようにして欲しいですね。</p>

<h2>
<span id="aspnet-mvc-5-のプロジェクトを作成" class="fragment"></span><a href="#aspnet-mvc-5-%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>ASP.net MVC 5 のプロジェクトを作成</h2>

<p>次に、VisualStudio を起動して、ASP.net MVC 5 のプロジェクトを作成しまししょう。</p>

<p><a href="https://camo.qiitausercontent.com/782bfe83af75b3996a531f3c54b8883e3c32b582/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706530342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe04.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4858ab1a291dfda0d05bddd808f9fb39" alt="VisualStudio PJ作成1" title="VisualStudio PJ作成1" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe04.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe04.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=04722c51187bf7c21f40b28c74ba3082 1x" loading="lazy"></a></p>

<p>認証は、今回「個別のユーザアカウント」を選択します。</p>

<p><a href="https://camo.qiitausercontent.com/08a3827e9fe33abb9209d6092d4c2b43ba2427d4/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706530352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe05.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=666738012846b5ec5436db0653c5bd8a" alt="VisualStudio PJ作成2" title="VisualStudio PJ作成2" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe05.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe05.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=234218b96e75f5b0cc9203a9fb990055 1x" loading="lazy"></a></p>

<p>以上で、最初から認証機能（ユーザ登録、ログインなど）が実装された、ASP.net MVC のプロジェクトが追加されます。<br>
ASP.net MVC って、本当にプロジェクトを作ってから手軽に開発をスタートできるのがいいですね！</p>

<h2>
<span id="stripenet-クラスライブラリィの導入" class="fragment"></span><a href="#stripenet-%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%A3%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>Stripe.net クラスライブラリィの導入</h2>

<p>今回はカード決済の実装に Stripe を使いますので、そのクラスライブラリィを導入します。<br>
コードは以下の Github に公開されているので、何かあった時でもコードを直接参照できるのは安心です。<br>
<a href="https://github.com/stripe/stripe-dotnet" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/stripe/stripe-dotnet</a></p>

<p>NuGet で簡単にインストールできるのもいいですね！<br>
パッケージマネージャーコンソールで、以下を実行するだけでインストールは終わりです。</p>

<p><code>PM&gt; Install-Package Stripe.net</code></p>

<p><a href="https://camo.qiitausercontent.com/7d88064a188ad68e937a8ade8f96b24b1a204080/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706530382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe08.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1e949aaa0cb2258d14c0b7372cdec29e" alt="Stripe Install 1" title="Stripe Install 1" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe08.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe08.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8843dcb7451f7b210e299b064cc6188e 1x" loading="lazy"></a></p>

<p>Stripe.net.11.9.0 のインストールで、自動で依存関係にある Newtonsoft.Json も 6.0.4 から 9.0.1 アップデートされてますね。</p>

<p><a href="https://camo.qiitausercontent.com/75784aac2bccbc607d71d1621500bbdb3df6d8c3/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706531302e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe10.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a422f13fa7d7cb89cbda1e6b5f6f38f9" alt="Stripe Install 2" title="Stripe Install 2" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe10.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe10.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4d8cf1c0e95fe43e24382f9f46a9f54c 1x" loading="lazy"></a></p>

<h2>
<span id="dbマイグレーションの設定必須ではないが" class="fragment"></span><a href="#db%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%BF%85%E9%A0%88%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84%E3%81%8C"><i class="fa fa-link"></i></a>DBマイグレーションの設定（必須ではないが）</h2>

<p>Stripe の顧客はメアドが重複しても、そのまま追加されてしまいます。</p>

<p>試験といえども、同じメールアドレスの顧客が重複して登録されるのは避けたいところ。<br>
ローカルの DB で Stripe の顧客IDを管理して、Stripe の顧客が重複するのを避けます。</p>

<p>いちいちDBのテーブルを手動で追加するのも面倒ですので、マイグレーションの設定を追加します。</p>

<p>Stripe の顧客IDを管理するため、Customer エンティティを追加します。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">/Model/Customer.cs</span></div>
<div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">Customer</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Email</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">StripeId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</div>

<p>Customer エンティティを保管する DB のコンテキスト AppDbContext を追加します。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">/Model/AppDbContext.cs</span></div>
<div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">AppDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Customer</span><span class="p">&gt;</span> <span class="n">Customers</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</div>

<p>パッケージマネージャーコンソールで、マイグレーションを有効にします。<br>
オプションで DB のコンテキスト名と、自動マイグレーションの指定を追加します。</p>

<p><code>PM&gt; Enable-Migrations -ContextTypeName WebApplication1.Models.AppDbContext -EnableAutomaticMigrations</code></p>

<p>マイグレーションを有効にすると /Migrations/Configuration.cs が自動で追加されます。</p>

<p><a href="https://camo.qiitausercontent.com/c802649887e66314d093c4e95362539a2f31ac69/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f5374726970653134622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe14b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8071a26e200c31a8bb8b243ef6ee95c8" alt="Enable-Migrations 2" title="Enable-Migrations 2" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe14b.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe14b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=7a823e68009c34c9f2a34a787056a669 1x" loading="lazy"></a></p>

<p>続いて、データベースの接続設定を追加します。</p>

<p>DB の保管場所を明示的に指定することで管理しやすくなります。<br>
<code>&lt;add name="DefaultConnection" ... /&gt;</code> の1つ目は、認証部分のコンテキスト用です。<br>
その下に <code>&lt;add name="WebApplication1.Models.AppDbContext" ... /&gt;</code> を追加します。 </p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">/Web.config</span></div>
<div class="highlight"><pre class="with-code"><code>  <span class="nt">&lt;connectionStrings&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"DefaultConnection"</span> <span class="na">connectionString=</span><span class="s">"Data Source=(LocalDb)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\aspnet-WebApplication1-20171214041732.mdf;Initial Catalog=aspnet-WebApplication1-20171214041732;Integrated Security=True"</span> <span class="na">providerName=</span><span class="s">"System.Data.SqlClient"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"WebApplication1.Models.AppDbContext"</span> <span class="na">connectionString=</span><span class="s">"Data Source=(LocalDb)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\AppDb.mdf;Initial Catalog=AppDb;Integrated Security=True"</span> <span class="na">providerName=</span><span class="s">"System.Data.SqlClient"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/connectionStrings&gt;</span>
</code></pre></div>
</div>

<p>さらに Global.asax.cs に Database.SetInitializer() を追加して、Web.config で指定した定義で AppDbContext の DB に接続するようにします。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">/Global.asax.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">WebApplication1.Migrations</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">WebApplication1.Models</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">WebApplication1</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MvcApplication</span> <span class="p">:</span> <span class="n">System</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">HttpApplication</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">AreaRegistration</span><span class="p">.</span><span class="nf">RegisterAllAreas</span><span class="p">();</span>
            <span class="n">FilterConfig</span><span class="p">.</span><span class="nf">RegisterGlobalFilters</span><span class="p">(</span><span class="n">GlobalFilters</span><span class="p">.</span><span class="n">Filters</span><span class="p">);</span>
            <span class="n">RouteConfig</span><span class="p">.</span><span class="nf">RegisterRoutes</span><span class="p">(</span><span class="n">RouteTable</span><span class="p">.</span><span class="n">Routes</span><span class="p">);</span>
            <span class="n">BundleConfig</span><span class="p">.</span><span class="nf">RegisterBundles</span><span class="p">(</span><span class="n">BundleTable</span><span class="p">.</span><span class="n">Bundles</span><span class="p">);</span>

            <span class="n">Database</span><span class="p">.</span><span class="nf">SetInitializer</span><span class="p">(</span><span class="k">new</span> <span class="n">MigrateDatabaseToLatestVersion</span><span class="p">&lt;</span><span class="n">AppDbContext</span><span class="p">,</span> <span class="n">Configuration</span><span class="p">&gt;());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>以上の設定が終わったら、<strong>再度マイグレーションの設定を -Force で上書き</strong>します。</p>

<p><code>PM&gt; Enable-Migrations -ContextTypeName WebApplication1.Models.AppDbContext -EnableAutomaticMigrations -Force</code></p>

<p>これで AppDbContext にセットされたモデルに変更・追加があっても、自動でマイグレーションしてくれます。</p>

<h2>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h2>

<p>Stripe には多くのドキュメントが整備されています。（日本語対応が遅れているのが残念ではありますが。）<br>
stripe docs の以下を参照しながら、ASP.net MVC 5 への実装を進めます。</p>

<p>Using Checkout in an ASP.NET MVC application<br>
<a href="https://stripe.com/docs/checkout/aspnet" class="autolink" rel="nofollow noopener" target="_blank">https://stripe.com/docs/checkout/aspnet</a></p>

<p>Creating Charges<br>
<a href="https://stripe.com/docs/charges" class="autolink" rel="nofollow noopener" target="_blank">https://stripe.com/docs/charges</a></p>

<p>Detailed Checkout Guide<br>
<a href="https://stripe.com/docs/checkout" class="autolink" rel="nofollow noopener" target="_blank">https://stripe.com/docs/checkout</a></p>

<p>Retrieve a customer<br>
<a href="https://stripe.com/docs/api#retrieve_customer" class="autolink" rel="nofollow noopener" target="_blank">https://stripe.com/docs/api#retrieve_customer</a></p>

<h3>
<span id="鍵の管理" class="fragment"></span><a href="#%E9%8D%B5%E3%81%AE%E7%AE%A1%E7%90%86"><i class="fa fa-link"></i></a>鍵の管理</h3>

<p>実装の前に、Stripe のダッシュボードで APIキー（公開鍵、シークレット鍵）を確認します。</p>

<p><a href="https://camo.qiitausercontent.com/af29a22d852620940d50818a284b7daddd9381b0/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe24.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=95a1f233ab01f41b1996f55f2824421c" alt="Stripe API" title="Stripe API" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe24.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe24.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8dc602d6ead097ba28f4a25b54f87c5a 1x" loading="lazy"></a></p>

<p>シークレット鍵がいきなり表示されないように工夫されているのは良いですね！<br>
APIキーは以下のように Web.config などに保管しておくと良いでしょう。<br>
（本当は暗号化などして、もっと厳重に管理した方が良いですが、今回は省略しました。）</p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">/Web.config</span></div>
<div class="highlight"><pre class="with-code"><code>  <span class="nt">&lt;appSettings&gt;</span>

（中略）

    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"StripeSecretKey"</span> <span class="na">value=</span><span class="s">"sk_test_Key値"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"StripePublishableKey"</span> <span class="na">value=</span><span class="s">"pk_test_Key値"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/appSettings&gt;</span>
</code></pre></div>
</div>

<p>シークレットキーの Configuration への設定は Startup.cs などで実施すると良いでしょう。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">/Startup.cs</span></div>
<div class="highlight"><pre class="with-code"><code>        <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">ConfigureAuth</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>

            <span class="c1">// Stripe の初期設定</span>
            <span class="n">StripeConfiguration</span><span class="p">.</span><span class="nf">SetApiKey</span><span class="p">(</span><span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"StripeSecretKey"</span><span class="p">]);</span>
        <span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="コントローラの実装" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>コントローラの実装</h3>

<p>コントローラに以下の2つのメソッドを追加します。</p>

<ul>
<li>商品を発注、カード決裁入力する Order メソッド</li>
<li>カード決済と、決裁結果を表示する Charge メソッド</li>
</ul>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">/Controllers/HomeController.cs</span></div>
<div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">HomeController</span> <span class="p">:</span> <span class="n">Controller</span>
    <span class="p">{</span>
        <span class="c1">// カード処理を実装するアプリケーションサービス</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">HomeControlerService</span> <span class="n">service</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">HomeController</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">service</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HomeControlerService</span><span class="p">();</span>
        <span class="p">}</span>

<span class="err">（中略）</span>

        <span class="c1">// 商品を発注、カード決裁入力</span>
        <span class="p">[</span><span class="n">Authorize</span><span class="p">]</span>
        <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Order</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// カード情報入力画面（checkout.js）に必要な引数をセット（Stripeの公開鍵とメールアドレス）</span>
            <span class="n">ViewBag</span><span class="p">.</span><span class="n">PublishableKey</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"StripePublishableKey"</span><span class="p">];</span> 
            <span class="n">ViewBag</span><span class="p">.</span><span class="n">Email</span> <span class="p">=</span> <span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
            <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// カード決済と、決裁結果を表示</span>
        <span class="p">[</span><span class="n">HttpPost</span><span class="p">]</span>
        <span class="p">[</span><span class="n">Authorize</span><span class="p">]</span>
        <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Charge</span><span class="p">(</span><span class="kt">string</span> <span class="n">stripeEmail</span><span class="p">,</span> <span class="kt">string</span> <span class="n">stripeToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// クロスドメインでも実行できるように</span>
            <span class="n">Response</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">"Expires"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"-1"</span><span class="p">;</span>
            <span class="n">Response</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">"Access-Control-Allow-Origin"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"*"</span><span class="p">;</span>

            <span class="k">try</span>
            <span class="p">{</span>
                <span class="c1">// 課金処理</span>
                <span class="n">service</span><span class="p">.</span><span class="nf">Charge</span><span class="p">(</span><span class="n">stripeEmail</span><span class="p">,</span> <span class="n">stripeToken</span><span class="p">);</span>
                <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// 課金エラー処理</span>
                <span class="c1">// 本当なら service からスローされたエラーを処理します</span>
                <span class="c1">// こんなアバウトなキャッチはだめですよ！(^^;;</span>
                <span class="n">ViewBag</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">"エラー発生："</span> <span class="p">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">;</span>
                <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="s">"Error"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="アプリケーションサービスの実装" class="fragment"></span><a href="#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>アプリケーションサービスの実装</h3>

<p>実際のカード決裁処理は、アプリケーションサービスクラスに実装します。</p>

<p>Stripe の顧客情報はメールアドレスが重複しても追加されてしまいます。<br>
メールアドレスが重複する顧客情報は登録したくないので、ローカルDB で Stripe の顧客IDを管理して重複しないようにします。<br>
（本来は課金結果も保管しますが、今回は省略します。）</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">/Model/HomeControlerService.cs</span></div>
<div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">HomeControlerService</span> <span class="p">:</span> <span class="n">IDisposable</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="kt">bool</span> <span class="n">disposed</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">AppDbContext</span> <span class="n">AppDb</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AppDbContext</span><span class="p">();</span>

        <span class="k">public</span> <span class="nf">HomeControlerService</span><span class="p">()</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="n">GC</span><span class="p">.</span><span class="nf">SuppressFinalize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">disposed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">disposing</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">AppDb</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="n">AppDb</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">disposed</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// カード決裁処理</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Charge</span><span class="p">(</span><span class="kt">string</span> <span class="n">stripeEmail</span><span class="p">,</span> <span class="kt">string</span> <span class="n">stripeToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">customersService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StripeCustomerService</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">chargesService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StripeChargeService</span><span class="p">();</span>
            <span class="n">StripeCustomer</span> <span class="n">customer</span><span class="p">;</span>
            <span class="n">Customer</span> <span class="n">dbCustomer</span><span class="p">;</span>

            <span class="c1">// DBにメアドが存在しなければ、顧客登録を行う</span>
            <span class="kt">var</span> <span class="n">dbCustomers</span> <span class="p">=</span> <span class="n">AppDb</span><span class="p">.</span><span class="n">Customers</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">Email</span> <span class="p">==</span> <span class="n">stripeEmail</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dbCustomers</span><span class="p">.</span><span class="nf">Count</span><span class="p">()</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Stripe に顧客を追加</span>
                <span class="n">customer</span> <span class="p">=</span> <span class="n">customersService</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="k">new</span> <span class="n">StripeCustomerCreateOptions</span>
                <span class="p">{</span>
                    <span class="n">Email</span> <span class="p">=</span> <span class="n">stripeEmail</span><span class="p">,</span>
                    <span class="n">SourceToken</span> <span class="p">=</span> <span class="n">stripeToken</span>
                <span class="p">});</span>

                <span class="c1">// DB に顧客を追加</span>
                <span class="n">dbCustomer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Customer</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">Email</span> <span class="p">=</span> <span class="n">stripeEmail</span><span class="p">,</span>
                    <span class="n">StripeId</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span>
                <span class="p">};</span>
                <span class="n">AppDb</span><span class="p">.</span><span class="n">Customers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">dbCustomer</span><span class="p">);</span>
                <span class="n">AppDb</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">// Stripe の顧客を取得</span>
                <span class="n">dbCustomer</span> <span class="p">=</span> <span class="n">dbCustomers</span><span class="p">.</span><span class="nf">First</span><span class="p">();</span>
                <span class="n">customer</span> <span class="p">=</span> <span class="n">customersService</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">dbCustomer</span><span class="p">.</span><span class="n">StripeId</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// 課金を追加</span>
            <span class="kt">var</span> <span class="n">charge</span> <span class="p">=</span> <span class="n">chargesService</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="k">new</span> <span class="n">StripeChargeCreateOptions</span>
            <span class="p">{</span>
                <span class="n">Amount</span> <span class="p">=</span> <span class="m">1000</span><span class="p">,</span>
                <span class="n">Currency</span> <span class="p">=</span> <span class="s">"jpy"</span><span class="p">,</span>
                <span class="n">Description</span> <span class="p">=</span> <span class="s">"Example charge"</span><span class="p">,</span>
                <span class="n">CustomerId</span> <span class="p">=</span> <span class="n">customer</span><span class="p">.</span><span class="n">Id</span>
            <span class="p">});</span>

            <span class="c1">// ここで課金結果をDBに登録（今回は実装しない）</span>
            <span class="c1">// DBに charge.id を保管すれば、Stripe 側の課金情報と紐づけできる</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</div>

<p>最後に、以下の View の追加・修正を行います。</p>

<ul>
<li>商品の発注画面のリンクを追加し Index ビューを修正</li>
<li>商品を発注、カード決裁入力する Order ビューを追加</li>
<li>カード決済と、決裁結果を表示する Charge ビューを追加</li>
<li>カード決済のエラーを表示する Error ビューを追加</li>
</ul>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">/Views/Home/Index.cshtml</span></div>
<div class="highlight"><pre class="with-code"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
@if (Request.IsAuthenticated)
{
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h2&gt;</span>Stripe Charge 試験（芋けんぴ注文）<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>
            Stripe Charge の試験を、「芋けんぴ注文」画面で行います!
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>@Html.ActionLink("芋けんぴ注文", "Order", "Home")<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">/Views/Home/Order.cshtml</span></div>
<div class="highlight"><pre class="with-code"><code>@{
    ViewBag.Title = "芋けんぴ注文";
}

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"jumbotron"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>芋けんぴ注文<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/Home/Charge"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;article&gt;</span>
            <span class="nt">&lt;label&gt;</span>芋けんぴ： <span class="ni">&amp;yen;</span>1,000<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;/article&gt;</span>
        <span class="c">&lt;!-- ボタンを押すと支払をするカード情報を入力するダイアログを表示 --&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"//checkout.stripe.com/v2/checkout.js"</span>
                <span class="na">class=</span><span class="s">"stripe-button"</span>
                <span class="na">data-key=</span><span class="s">"@ViewBag.PublishableKey"</span>
                <span class="na">data-email=</span><span class="s">"@ViewBag.Email"</span>
                <span class="na">data-locale=</span><span class="s">"auto"</span>
                <span class="na">data-currency=</span><span class="s">"JPY"</span>
                <span class="na">data-description=</span><span class="s">"芋けんぴ代 支払い"</span>
                <span class="na">data-amount=</span><span class="s">"1000"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">/Views/Home/Charge.cshtml</span></div>
<div class="highlight"><pre class="with-code"><code>@{
    ViewBag.Title = "芋けんぴ支払い完了";
}

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"jumbotron"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>芋けんぴ支払い完了<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>芋けんぴ代 支払い完了しました！<span class="nt">&lt;strong&gt;</span><span class="ni">&amp;yen;</span>1,000<span class="nt">&lt;/strong&gt;&lt;/h2&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="html">
<div class="code-lang"><span class="bold">/Views/Home/Error.cshtml</span></div>
<div class="highlight"><pre class="with-code"><code>@{
    ViewBag.Title = "芋けんぴ支払いエラー";
}

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"jumbotron"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>芋けんぴ支払いエラー<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>@ViewBag.Message<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
</div>

<p>以上で実装は終わりです。</p>

<h2>
<span id="テスト" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>テスト</h2>

<p>実装が終わったら、VisualStudio でデバッグ実行してみます。<br>
デバッグ実行前に Stripe の顧客と、支払いを確認します。</p>

<p><a href="https://camo.qiitausercontent.com/880e15d3a4415a515800359a9ea0438fd5d2d6cc/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe25.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d6875d949aac8aab35d3c1eace3f96da" alt="Stripe 顧客" title="Stripe 顧客" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe25.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe25.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=208e6447c7f32ad85c80a8ad94182a1b 1x" loading="lazy"></a></p>

<p><a href="https://camo.qiitausercontent.com/9e89edaadce482ec5cde702ca5f79c822cfda01e/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe26.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d7ff32932f1e18be21b35bf30aaff321" alt="Stripe 支払い" title="Stripe 支払い" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe26.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe26.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b2c5f4923f1f512094f27c19f85d8fab 1x" loading="lazy"></a></p>

<p>デバック起動した最初の画面です。</p>

<p><a href="https://camo.qiitausercontent.com/c59b3ca374065461f367929c3f2c299a86765b56/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe21.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8032c4ac99ce52304dd0980f58383b24" alt="Home画面" title="Home画面" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe21.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe21.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e5616ed88a00188a894b93f89273e0a3 1x" loading="lazy"></a></p>

<p>先ずはアカウント（ <a href="mailto:test@example.com" class="autolink">test@example.com</a> ）を登録します。<br>
プロジェクトを作る際に「個別のアカウント」を選択した場合は、アカウントは電子メールアドレスを使うように初期設定されています。</p>

<p><a href="https://camo.qiitausercontent.com/8fb0fe79580d9b0acc6ba564ee2904b688a47ee0/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe22.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6fc063e39f9591ba612905af1aa78f79" alt="アカウント登録画面" title="アカウント登録画面" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe22.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe22.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a364efc37ab46e2ccd7a4b2d0c1729fd 1x" loading="lazy"></a></p>

<p>アカウント登録が終わると、ログイン状態で最初の画面に遷移します。<br>
画面右端に「芋けんぴの注文」のリンクが表示されているのが確認できます。</p>

<p><a href="https://camo.qiitausercontent.com/05d4fade7eecc69234cc9e49d0d26b8acadd13f2/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532372e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe27.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fdf95938a7fd205b9e19e2dea3c22cda" alt="ログインHome画面" title="ログインHome画面" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe27.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe27.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=49cdeb8882a0eb6637244ad015769557 1x" loading="lazy"></a></p>

<p>では、実際に注文してカード決裁を行います。</p>

<p><a href="https://camo.qiitausercontent.com/a28864af1f2fdac4a8bab9b1b32eb4c5976d2584/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe28.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b475afb772fdb705d3007da2b33e4cbd" alt="注文画面" title="注文画面" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe28.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe28.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=10776cd9f9271c4ba1056e55eb9dd2a7 1x" loading="lazy"></a></p>

<p>注文画面「Pay with Card」ボタンをクリックすると、カード情報入力ダイアログが表示されます。<br>
ですが、Edge、IE で表示されないことがありました。（現状ではまだ原因は不明です。）<br>
とりあえず、以下のように入力してみます。</p>

<ul>
<li>カード番号：テスト用 4242 4242 4242 4242 </li>
<li>月/年：適当な値</li>
<li>CVC：適当な値</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/6a9b6e281b516ae7f6ac514a559bd4cf2f567df6/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532392e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe29.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=49485b1a4fdb49bdc78e6d2a90c5f2eb" alt="カード情報入力画面" title="カード情報入力画面" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe29.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe29.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=41a78bae69f08626ca54c522cad22422 1x" loading="lazy"></a></p>

<p>カード決済が完了すると、以下の画面に遷移します。</p>

<p><a href="https://camo.qiitausercontent.com/e13f1d9fd6b5686533bb7d4830ce235819599678/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706533312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe31.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0e97e3e25be4a78dff55ba00d3ba6ed4" alt="決済完了画面" title="決済完了画面" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe31.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe31.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a69d61c3863f1aa4885370c421ee1d7f 1x" loading="lazy"></a></p>

<p>実際に Stripe に顧客、支払いが追加されたか確認します。</p>

<p><a href="https://camo.qiitausercontent.com/4389a1c235517e1faf7d730b82786927e3c430a0/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706533322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe32.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9e61304b0b14ff3326c4ea4b8e2c6a8f" alt="Stripe 顧客" title="Stripe 顧客" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe32.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe32.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=9b35b701134a81b72cb7be1586bdc788 1x" loading="lazy"></a></p>

<p><a href="https://camo.qiitausercontent.com/9eccd4fee3a53b85c1ba7a31ebbc5ebbe93ff89c/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706533332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe33.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d09282ceb61061250cef7c396f9cdc1d" alt="Stripe 支払い" title="Stripe 支払い" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe33.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe33.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=698cceb8659243134da5d5aa481aa02f 1x" loading="lazy"></a></p>

<p>Stripe に無事追加されました。<br>
ローカルDBにも、以下のように顧客（Custmer）が追加されていますね。</p>

<p><a href="https://camo.qiitausercontent.com/84f8bad4c9c9a41cc2ebb9ddd023d3d56561a65f/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f5374726970653334622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe34b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7f6b239b14e63a83234a829fbfacc18a" alt="local DB" title="local DB" data-canonical-src="https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe34b.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe34b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8abc4dc428ae0fb5b17cc9a6a7cf9e48 1x" loading="lazy"></a></p>

<h2>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h2>

<p>実際にアカウント登録、ドキュメントを参照、ASP.net MVC 5 を設定、カード決裁を実装するまで、だいたい半日程度でできました。</p>

<p>とりあえずカード課金を試してみましたが、本命は月・年額会費の課金対応。<br>
以下を参考に、後日追加で試してみるつもりです。</p>

<p>Stripe Subscription （定期支払い）101 - Part 1（Stripe 日本 <a href="/y_toku" class="user-mention js-hovercard" title="y_toku" data-hovercard-target-type="user" data-hovercard-target-name="y_toku">@y_toku</a> さん）<br>
<a href="https://qiita.com/y_toku/items/235b5e7ee00792edcbbf" class="autolink" id="reference-5a1947cfd06020e302c9">https://qiita.com/y_toku/items/235b5e7ee00792edcbbf</a> </p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fyukataoka%2Fitems%2F1c6b34818f6b7753631a&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fyukataoka%2Fitems%2F1c6b34818f6b7753631a&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/yukataoka/items/1c6b34818f6b7753631a/likers" class="css-1iupg5d">5</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">12</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/1c6b34818f6b7753631a/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/yukataoka/items/1c6b34818f6b7753631a/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/yukataoka/items/1c6b34818f6b7753631a/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/yukataoka/items/1c6b34818f6b7753631a/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/yukataoka/items/1c6b34818f6b7753631a.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-028e96a5-79fc-4714-91ad-817f8308788a">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-50f84abd-937a-4ed5-b646-0158c92c4156"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-50f84abd-937a-4ed5-b646-0158c92c4156">{}</script>
      
<div id="LoginModal-react-component-2bb63592-c0a5-4d8f-91c1-9eec5528b4f1"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-2bb63592-c0a5-4d8f-91c1-9eec5528b4f1">{}</script>
      
<div id="StockModal-react-component-a65eec97-b62e-4dfd-91a5-2883853190b6"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-a65eec97-b62e-4dfd-91a5-2883853190b6">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;OiuLvm88f1Qll8T+ckSVDXOZxXzlSXzsqx3DMbTPSnOmyEX53zm5G7FIdH3mHNtJHlkiHQxyJQpS0k9H9cYRow==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"経緯\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%8C%E7%B7%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e経緯\u003c/h1\u003e\n\n\u003cp\u003eこれは \u003ca href=\"http://eventregist.com/e/JP_Stripes_MYJ\" title=\"JP_Stripes\" rel=\"nofollow noopener\" target=\"_blank\"\u003eJP_Stripes (Stripe ユーザーグループ）in 松山 キックオフ\u003c/a\u003e のLT登壇のためにまとめた記事です。\u003c/p\u003e\n\n\u003cp\u003eオンライン決済で話題になっている\u003ca href=\"https://stripe.com/jp\" title=\"Stripe\" rel=\"nofollow noopener\" target=\"_blank\"\u003eStripe\u003c/a\u003e 、LT登壇ネタとして、ちょうど仕事の開発でも使っている ASP.net MVC 5 で、噂どおり簡単に実装できるか試してみることにしました。\u003cbr\u003e\n結果、簡単過ぎて、、、開発する手ごたえがないほど楽でした。（笑）\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"試すこと\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A9%A6%E3%81%99%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e試すこと\u003c/h2\u003e\n\n\u003cp\u003e会員がログインした後、商品を発注しカード決済するまでの一連の流れを想定して実装してみます。\u003c/p\u003e\n\n\u003cp\u003e「会員登録」→「ログイン」→「商品を発注」→「カード決済入力」→「カード決裁結果を表示」\u003c/p\u003e\n\n\u003cp\u003e使用するPCの環境は以下です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eOS : Windows 10 Professional\u003c/li\u003e\n\u003cli\u003e開発環境 : VisualStudio 2017 Professional\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実装してみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装してみる\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"手順\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%89%8B%E9%A0%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e手順\u003c/h2\u003e\n\n\u003col\u003e\n\u003cli\u003e\n\u003ca href=\"https://stripe.com/jp\" title=\"Stripe\" rel=\"nofollow noopener\" target=\"_blank\"\u003eStripe\u003c/a\u003e のアカウント登録\u003c/li\u003e\n\u003cli\u003eASP.net MVC 5 のプロジェクトを、認証は「個別ユーザアカウント」を選択し作成\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://github.com/stripe/stripe-dotnet\" title=\"Stripe.net\" rel=\"nofollow noopener\" target=\"_blank\"\u003eStripe.net\u003c/a\u003e のクラスライブラリィを設定\u003c/li\u003e\n\u003cli\u003eASP.net MVC のプロジェクトに課金処理を実装・テスト\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e以上の手順で進めます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"stripe-のアカウント登録\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#stripe-%E3%81%AE%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E7%99%BB%E9%8C%B2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStripe のアカウント登録\u003c/h2\u003e\n\n\u003cp\u003e以下の Stripe のサイトにアクセスし「アカウント登録」を行いましょう。\u003cbr\u003e\n\u003ca href=\"https://stripe.com/jp\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://stripe.com/jp\u003c/a\u003e\u003cbr\u003e\n簡単なので説明は省略します。\u003c/p\u003e\n\n\u003cp\u003eアカウント登録が終わったらダッシュボードに進みましょう。\u003cbr\u003e\nUnnamed Acount が作成されていますが、私は試験用のアカウントを追加しました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/58164773bc45e5f64a0f5f4e55fe287259b2bb42/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706530332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe03.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=1e0eea47421813e8361c1c7fe68c07c1\" alt=\"ダッシュボード\" title=\"ダッシュボード\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe03.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe03.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5a901200a1e4337d81ba91053e733413 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e早速売上があるように見えてますが、これはテストデータです。（笑）\u003cbr\u003e\nテストデータは消せれるようにして欲しいですね。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"aspnet-mvc-5-のプロジェクトを作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#aspnet-mvc-5-%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eASP.net MVC 5 のプロジェクトを作成\u003c/h2\u003e\n\n\u003cp\u003e次に、VisualStudio を起動して、ASP.net MVC 5 のプロジェクトを作成しまししょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/782bfe83af75b3996a531f3c54b8883e3c32b582/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706530342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe04.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=4858ab1a291dfda0d05bddd808f9fb39\" alt=\"VisualStudio PJ作成1\" title=\"VisualStudio PJ作成1\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe04.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe04.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=04722c51187bf7c21f40b28c74ba3082 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e認証は、今回「個別のユーザアカウント」を選択します。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/08a3827e9fe33abb9209d6092d4c2b43ba2427d4/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706530352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe05.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=666738012846b5ec5436db0653c5bd8a\" alt=\"VisualStudio PJ作成2\" title=\"VisualStudio PJ作成2\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe05.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe05.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=234218b96e75f5b0cc9203a9fb990055 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e以上で、最初から認証機能（ユーザ登録、ログインなど）が実装された、ASP.net MVC のプロジェクトが追加されます。\u003cbr\u003e\nASP.net MVC って、本当にプロジェクトを作ってから手軽に開発をスタートできるのがいいですね！\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"stripenet-クラスライブラリィの導入\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#stripenet-%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%A3%E3%81%AE%E5%B0%8E%E5%85%A5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStripe.net クラスライブラリィの導入\u003c/h2\u003e\n\n\u003cp\u003e今回はカード決済の実装に Stripe を使いますので、そのクラスライブラリィを導入します。\u003cbr\u003e\nコードは以下の Github に公開されているので、何かあった時でもコードを直接参照できるのは安心です。\u003cbr\u003e\n\u003ca href=\"https://github.com/stripe/stripe-dotnet\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/stripe/stripe-dotnet\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eNuGet で簡単にインストールできるのもいいですね！\u003cbr\u003e\nパッケージマネージャーコンソールで、以下を実行するだけでインストールは終わりです。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ePM\u0026gt; Install-Package Stripe.net\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/7d88064a188ad68e937a8ade8f96b24b1a204080/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706530382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe08.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=1e949aaa0cb2258d14c0b7372cdec29e\" alt=\"Stripe Install 1\" title=\"Stripe Install 1\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe08.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe08.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8843dcb7451f7b210e299b064cc6188e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eStripe.net.11.9.0 のインストールで、自動で依存関係にある Newtonsoft.Json も 6.0.4 から 9.0.1 アップデートされてますね。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/75784aac2bccbc607d71d1621500bbdb3df6d8c3/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706531302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe10.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a422f13fa7d7cb89cbda1e6b5f6f38f9\" alt=\"Stripe Install 2\" title=\"Stripe Install 2\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe10.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe10.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=4d8cf1c0e95fe43e24382f9f46a9f54c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"dbマイグレーションの設定必須ではないが\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#db%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%BF%85%E9%A0%88%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84%E3%81%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDBマイグレーションの設定（必須ではないが）\u003c/h2\u003e\n\n\u003cp\u003eStripe の顧客はメアドが重複しても、そのまま追加されてしまいます。\u003c/p\u003e\n\n\u003cp\u003e試験といえども、同じメールアドレスの顧客が重複して登録されるのは避けたいところ。\u003cbr\u003e\nローカルの DB で Stripe の顧客IDを管理して、Stripe の顧客が重複するのを避けます。\u003c/p\u003e\n\n\u003cp\u003eいちいちDBのテーブルを手動で追加するのも面倒ですので、マイグレーションの設定を追加します。\u003c/p\u003e\n\n\u003cp\u003eStripe の顧客IDを管理するため、Customer エンティティを追加します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Model/Customer.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomer\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eEmail\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eStripeId\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eCustomer エンティティを保管する DB のコンテキスト AppDbContext を追加します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Model/AppDbContext.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAppDbContext\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eDbContext\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDbSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCustomer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eCustomers\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eパッケージマネージャーコンソールで、マイグレーションを有効にします。\u003cbr\u003e\nオプションで DB のコンテキスト名と、自動マイグレーションの指定を追加します。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ePM\u0026gt; Enable-Migrations -ContextTypeName WebApplication1.Models.AppDbContext -EnableAutomaticMigrations\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eマイグレーションを有効にすると /Migrations/Configuration.cs が自動で追加されます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/c802649887e66314d093c4e95362539a2f31ac69/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f5374726970653134622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe14b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=8071a26e200c31a8bb8b243ef6ee95c8\" alt=\"Enable-Migrations 2\" title=\"Enable-Migrations 2\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe14b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe14b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=7a823e68009c34c9f2a34a787056a669 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e続いて、データベースの接続設定を追加します。\u003c/p\u003e\n\n\u003cp\u003eDB の保管場所を明示的に指定することで管理しやすくなります。\u003cbr\u003e\n\u003ccode\u003e\u0026lt;add name=\"DefaultConnection\" ... /\u0026gt;\u003c/code\u003e の1つ目は、認証部分のコンテキスト用です。\u003cbr\u003e\nその下に \u003ccode\u003e\u0026lt;add name=\"WebApplication1.Models.AppDbContext\" ... /\u0026gt;\u003c/code\u003e を追加します。 \u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Web.config\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;connectionStrings\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;add\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"DefaultConnection\"\u003c/span\u003e \u003cspan class=\"na\"\u003econnectionString=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Data Source=(LocalDb)\\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\\aspnet-WebApplication1-20171214041732.mdf;Initial Catalog=aspnet-WebApplication1-20171214041732;Integrated Security=True\"\u003c/span\u003e \u003cspan class=\"na\"\u003eproviderName=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"System.Data.SqlClient\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;add\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"WebApplication1.Models.AppDbContext\"\u003c/span\u003e \u003cspan class=\"na\"\u003econnectionString=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Data Source=(LocalDb)\\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\\AppDb.mdf;Initial Catalog=AppDb;Integrated Security=True\"\u003c/span\u003e \u003cspan class=\"na\"\u003eproviderName=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"System.Data.SqlClient\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;/connectionStrings\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eさらに Global.asax.cs に Database.SetInitializer() を追加して、Web.config で指定した定義で AppDbContext の DB に接続するようにします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Global.asax.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Data.Entity\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eWebApplication1.Migrations\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eWebApplication1.Models\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eWebApplication1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMvcApplication\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWeb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpApplication\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eApplication_Start\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eAreaRegistration\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterAllAreas\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eFilterConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterGlobalFilters\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eGlobalFilters\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFilters\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eRouteConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterRoutes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eRouteTable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRoutes\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eBundleConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterBundles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBundleTable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBundles\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eDatabase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetInitializer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eMigrateDatabaseToLatestVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAppDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eConfiguration\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;());\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e以上の設定が終わったら、\u003cstrong\u003e再度マイグレーションの設定を -Force で上書き\u003c/strong\u003eします。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ePM\u0026gt; Enable-Migrations -ContextTypeName WebApplication1.Models.AppDbContext -EnableAutomaticMigrations -Force\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eこれで AppDbContext にセットされたモデルに変更・追加があっても、自動でマイグレーションしてくれます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h2\u003e\n\n\u003cp\u003eStripe には多くのドキュメントが整備されています。（日本語対応が遅れているのが残念ではありますが。）\u003cbr\u003e\nstripe docs の以下を参照しながら、ASP.net MVC 5 への実装を進めます。\u003c/p\u003e\n\n\u003cp\u003eUsing Checkout in an ASP.NET MVC application\u003cbr\u003e\n\u003ca href=\"https://stripe.com/docs/checkout/aspnet\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://stripe.com/docs/checkout/aspnet\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eCreating Charges\u003cbr\u003e\n\u003ca href=\"https://stripe.com/docs/charges\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://stripe.com/docs/charges\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eDetailed Checkout Guide\u003cbr\u003e\n\u003ca href=\"https://stripe.com/docs/checkout\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://stripe.com/docs/checkout\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eRetrieve a customer\u003cbr\u003e\n\u003ca href=\"https://stripe.com/docs/api#retrieve_customer\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://stripe.com/docs/api#retrieve_customer\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"鍵の管理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%8D%B5%E3%81%AE%E7%AE%A1%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e鍵の管理\u003c/h3\u003e\n\n\u003cp\u003e実装の前に、Stripe のダッシュボードで APIキー（公開鍵、シークレット鍵）を確認します。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/af29a22d852620940d50818a284b7daddd9381b0/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe24.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=95a1f233ab01f41b1996f55f2824421c\" alt=\"Stripe API\" title=\"Stripe API\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe24.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe24.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8dc602d6ead097ba28f4a25b54f87c5a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eシークレット鍵がいきなり表示されないように工夫されているのは良いですね！\u003cbr\u003e\nAPIキーは以下のように Web.config などに保管しておくと良いでしょう。\u003cbr\u003e\n（本当は暗号化などして、もっと厳重に管理した方が良いですが、今回は省略しました。）\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Web.config\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e  \u003cspan class=\"nt\"\u003e\u0026lt;appSettings\u0026gt;\u003c/span\u003e\n\n（中略）\n\n    \u003cspan class=\"nt\"\u003e\u0026lt;add\u003c/span\u003e \u003cspan class=\"na\"\u003ekey=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"StripeSecretKey\"\u003c/span\u003e \u003cspan class=\"na\"\u003evalue=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"sk_test_Key値\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;add\u003c/span\u003e \u003cspan class=\"na\"\u003ekey=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"StripePublishableKey\"\u003c/span\u003e \u003cspan class=\"na\"\u003evalue=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"pk_test_Key値\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;/appSettings\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eシークレットキーの Configuration への設定は Startup.cs などで実施すると良いでしょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Startup.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfiguration\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIAppBuilder\u003c/span\u003e \u003cspan class=\"n\"\u003eapp\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eConfigureAuth\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eapp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// Stripe の初期設定\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eStripeConfiguration\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetApiKey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eConfigurationManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAppSettings\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"StripeSecretKey\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"コントローラの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコントローラの実装\u003c/h3\u003e\n\n\u003cp\u003eコントローラに以下の2つのメソッドを追加します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e商品を発注、カード決裁入力する Order メソッド\u003c/li\u003e\n\u003cli\u003eカード決済と、決裁結果を表示する Charge メソッド\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Controllers/HomeController.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHomeController\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// カード処理を実装するアプリケーションサービス\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eHomeControlerService\u003c/span\u003e \u003cspan class=\"n\"\u003eservice\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eHomeController\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eservice\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eHomeControlerService\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"err\"\u003e（中略）\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 商品を発注、カード決裁入力\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eAuthorize\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eActionResult\u003c/span\u003e \u003cspan class=\"nf\"\u003eOrder\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// カード情報入力画面（checkout.js）に必要な引数をセット（Stripeの公開鍵とメールアドレス）\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eViewBag\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePublishableKey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConfigurationManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAppSettings\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"StripePublishableKey\"\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e \n            \u003cspan class=\"n\"\u003eViewBag\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmail\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIdentity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eView\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// カード決済と、決裁結果を表示\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpPost\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eAuthorize\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eActionResult\u003c/span\u003e \u003cspan class=\"nf\"\u003eCharge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003estripeEmail\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003estripeToken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// クロスドメインでも実行できるように\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeaders\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Expires\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"-1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeaders\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Access-Control-Allow-Origin\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"*\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 課金処理\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eservice\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCharge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estripeEmail\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estripeToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eView\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003eex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 課金エラー処理\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 本当なら service からスローされたエラーを処理します\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// こんなアバウトなキャッチはだめですよ！(^^;;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eViewBag\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMessage\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"エラー発生：\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Error\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"アプリケーションサービスの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eアプリケーションサービスの実装\u003c/h3\u003e\n\n\u003cp\u003e実際のカード決裁処理は、アプリケーションサービスクラスに実装します。\u003c/p\u003e\n\n\u003cp\u003eStripe の顧客情報はメールアドレスが重複しても追加されてしまいます。\u003cbr\u003e\nメールアドレスが重複する顧客情報は登録したくないので、ローカルDB で Stripe の顧客IDを管理して重複しないようにします。\u003cbr\u003e\n（本来は課金結果も保管しますが、今回は省略します。）\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Model/HomeControlerService.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHomeControlerService\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003edisposed\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eAppDbContext\u003c/span\u003e \u003cspan class=\"n\"\u003eAppDb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAppDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eHomeControlerService\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSuppressFinalize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003edisposing\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edisposed\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edisposing\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAppDb\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAppDb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003edisposed\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// カード決裁処理\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eCharge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003estripeEmail\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003estripeToken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomersService\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStripeCustomerService\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003echargesService\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStripeChargeService\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eStripeCustomer\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eCustomer\u003c/span\u003e \u003cspan class=\"n\"\u003edbCustomer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// DBにメアドが存在しなければ、顧客登録を行う\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edbCustomers\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eAppDb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCustomers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmail\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003estripeEmail\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edbCustomers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// Stripe に顧客を追加\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecustomer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomersService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eStripeCustomerCreateOptions\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eEmail\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estripeEmail\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eSourceToken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estripeToken\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e// DB に顧客を追加\u003c/span\u003e\n                \u003cspan class=\"n\"\u003edbCustomer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCustomer\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eEmail\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estripeEmail\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eStripeId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eId\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eAppDb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCustomers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edbCustomer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eAppDb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSaveChanges\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// Stripe の顧客を取得\u003c/span\u003e\n                \u003cspan class=\"n\"\u003edbCustomer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edbCustomers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecustomer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomersService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edbCustomer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStripeId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 課金を追加\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003echarge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003echargesService\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eStripeChargeCreateOptions\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eAmount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eCurrency\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"jpy\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDescription\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Example charge\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eCustomerId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eId\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// ここで課金結果をDBに登録（今回は実装しない）\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// DBに charge.id を保管すれば、Stripe 側の課金情報と紐づけできる\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e最後に、以下の View の追加・修正を行います。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e商品の発注画面のリンクを追加し Index ビューを修正\u003c/li\u003e\n\u003cli\u003e商品を発注、カード決裁入力する Order ビューを追加\u003c/li\u003e\n\u003cli\u003eカード決済と、決裁結果を表示する Charge ビューを追加\u003c/li\u003e\n\u003cli\u003eカード決済のエラーを表示する Error ビューを追加\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"html\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Views/Home/Index.cshtml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"row\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n@if (Request.IsAuthenticated)\n{\n    \u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"col-md-4\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;h2\u0026gt;\u003c/span\u003eStripe Charge 試験（芋けんぴ注文）\u003cspan class=\"nt\"\u003e\u0026lt;/h2\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;p\u0026gt;\u003c/span\u003e\n            Stripe Charge の試験を、「芋けんぴ注文」画面で行います!\n        \u003cspan class=\"nt\"\u003e\u0026lt;/p\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;p\u0026gt;\u003c/span\u003e@Html.ActionLink(\"芋けんぴ注文\", \"Order\", \"Home\")\u003cspan class=\"nt\"\u003e\u0026lt;/p\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n}\n    \u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"col-md-4\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"html\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Views/Home/Order.cshtml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e@{\n    ViewBag.Title = \"芋けんぴ注文\";\n}\n\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"jumbotron\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;h1\u0026gt;\u003c/span\u003e芋けんぴ注文\u003cspan class=\"nt\"\u003e\u0026lt;/h1\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"row\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;form\u003c/span\u003e \u003cspan class=\"na\"\u003eaction=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"/Home/Charge\"\u003c/span\u003e \u003cspan class=\"na\"\u003emethod=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"POST\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;article\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;label\u0026gt;\u003c/span\u003e芋けんぴ： \u003cspan class=\"ni\"\u003e\u0026amp;yen;\u003c/span\u003e1,000\u003cspan class=\"nt\"\u003e\u0026lt;/label\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/article\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"c\"\u003e\u0026lt;!-- ボタンを押すと支払をするカード情報を入力するダイアログを表示 --\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;script \u003c/span\u003e\u003cspan class=\"na\"\u003esrc=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"//checkout.stripe.com/v2/checkout.js\"\u003c/span\u003e\n                \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"stripe-button\"\u003c/span\u003e\n                \u003cspan class=\"na\"\u003edata-key=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"@ViewBag.PublishableKey\"\u003c/span\u003e\n                \u003cspan class=\"na\"\u003edata-email=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"@ViewBag.Email\"\u003c/span\u003e\n                \u003cspan class=\"na\"\u003edata-locale=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"auto\"\u003c/span\u003e\n                \u003cspan class=\"na\"\u003edata-currency=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"JPY\"\u003c/span\u003e\n                \u003cspan class=\"na\"\u003edata-description=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"芋けんぴ代 支払い\"\u003c/span\u003e\n                \u003cspan class=\"na\"\u003edata-amount=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"1000\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/form\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"html\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Views/Home/Charge.cshtml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e@{\n    ViewBag.Title = \"芋けんぴ支払い完了\";\n}\n\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"jumbotron\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;h1\u0026gt;\u003c/span\u003e芋けんぴ支払い完了\u003cspan class=\"nt\"\u003e\u0026lt;/h1\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"row\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;h2\u0026gt;\u003c/span\u003e芋けんぴ代 支払い完了しました！\u003cspan class=\"nt\"\u003e\u0026lt;strong\u0026gt;\u003c/span\u003e\u003cspan class=\"ni\"\u003e\u0026amp;yen;\u003c/span\u003e1,000\u003cspan class=\"nt\"\u003e\u0026lt;/strong\u0026gt;\u0026lt;/h2\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"html\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e/Views/Home/Error.cshtml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e@{\n    ViewBag.Title = \"芋けんぴ支払いエラー\";\n}\n\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"jumbotron\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;h1\u0026gt;\u003c/span\u003e芋けんぴ支払いエラー\u003cspan class=\"nt\"\u003e\u0026lt;/h1\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eclass=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"row\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;h2\u0026gt;\u003c/span\u003e@ViewBag.Message\u003cspan class=\"nt\"\u003e\u0026lt;/h2\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e以上で実装は終わりです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"テスト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%86%E3%82%B9%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eテスト\u003c/h2\u003e\n\n\u003cp\u003e実装が終わったら、VisualStudio でデバッグ実行してみます。\u003cbr\u003e\nデバッグ実行前に Stripe の顧客と、支払いを確認します。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/880e15d3a4415a515800359a9ea0438fd5d2d6cc/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe25.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d6875d949aac8aab35d3c1eace3f96da\" alt=\"Stripe 顧客\" title=\"Stripe 顧客\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe25.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe25.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=208e6447c7f32ad85c80a8ad94182a1b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/9e89edaadce482ec5cde702ca5f79c822cfda01e/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe26.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d7ff32932f1e18be21b35bf30aaff321\" alt=\"Stripe 支払い\" title=\"Stripe 支払い\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe26.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe26.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b2c5f4923f1f512094f27c19f85d8fab 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eデバック起動した最初の画面です。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/c59b3ca374065461f367929c3f2c299a86765b56/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe21.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=8032c4ac99ce52304dd0980f58383b24\" alt=\"Home画面\" title=\"Home画面\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe21.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe21.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e5616ed88a00188a894b93f89273e0a3 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e先ずはアカウント（ \u003ca href=\"mailto:test@example.com\" class=\"autolink\"\u003etest@example.com\u003c/a\u003e ）を登録します。\u003cbr\u003e\nプロジェクトを作る際に「個別のアカウント」を選択した場合は、アカウントは電子メールアドレスを使うように初期設定されています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/8fb0fe79580d9b0acc6ba564ee2904b688a47ee0/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe22.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=6fc063e39f9591ba612905af1aa78f79\" alt=\"アカウント登録画面\" title=\"アカウント登録画面\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe22.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe22.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a364efc37ab46e2ccd7a4b2d0c1729fd 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eアカウント登録が終わると、ログイン状態で最初の画面に遷移します。\u003cbr\u003e\n画面右端に「芋けんぴの注文」のリンクが表示されているのが確認できます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/05d4fade7eecc69234cc9e49d0d26b8acadd13f2/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe27.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=fdf95938a7fd205b9e19e2dea3c22cda\" alt=\"ログインHome画面\" title=\"ログインHome画面\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe27.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe27.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=49cdeb8882a0eb6637244ad015769557 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eでは、実際に注文してカード決裁を行います。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/a28864af1f2fdac4a8bab9b1b32eb4c5976d2584/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe28.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b475afb772fdb705d3007da2b33e4cbd\" alt=\"注文画面\" title=\"注文画面\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe28.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe28.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=10776cd9f9271c4ba1056e55eb9dd2a7 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e注文画面「Pay with Card」ボタンをクリックすると、カード情報入力ダイアログが表示されます。\u003cbr\u003e\nですが、Edge、IE で表示されないことがありました。（現状ではまだ原因は不明です。）\u003cbr\u003e\nとりあえず、以下のように入力してみます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eカード番号：テスト用 4242 4242 4242 4242 \u003c/li\u003e\n\u003cli\u003e月/年：適当な値\u003c/li\u003e\n\u003cli\u003eCVC：適当な値\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/6a9b6e281b516ae7f6ac514a559bd4cf2f567df6/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706532392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe29.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=49485b1a4fdb49bdc78e6d2a90c5f2eb\" alt=\"カード情報入力画面\" title=\"カード情報入力画面\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe29.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe29.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=41a78bae69f08626ca54c522cad22422 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eカード決済が完了すると、以下の画面に遷移します。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/e13f1d9fd6b5686533bb7d4830ce235819599678/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706533312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe31.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=0e97e3e25be4a78dff55ba00d3ba6ed4\" alt=\"決済完了画面\" title=\"決済完了画面\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe31.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe31.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a69d61c3863f1aa4885370c421ee1d7f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e実際に Stripe に顧客、支払いが追加されたか確認します。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/4389a1c235517e1faf7d730b82786927e3c430a0/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706533322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe32.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=9e61304b0b14ff3326c4ea4b8e2c6a8f\" alt=\"Stripe 顧客\" title=\"Stripe 顧客\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe32.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe32.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=9b35b701134a81b72cb7be1586bdc788 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/9eccd4fee3a53b85c1ba7a31ebbc5ebbe93ff89c/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f53747269706533332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe33.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d09282ceb61061250cef7c396f9cdc1d\" alt=\"Stripe 支払い\" title=\"Stripe 支払い\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe33.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe33.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=698cceb8659243134da5d5aa481aa02f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eStripe に無事追加されました。\u003cbr\u003e\nローカルDBにも、以下のように顧客（Custmer）が追加されていますね。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/84f8bad4c9c9a41cc2ebb9ddd023d3d56561a65f/68747470733a2f2f73332d61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f736f66742d76696c6c6167652f71696974612f7374726970652f5374726970653334622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe34b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7f6b239b14e63a83234a829fbfacc18a\" alt=\"local DB\" title=\"local DB\" data-canonical-src=\"https://s3-ap-northeast-1.amazonaws.com/soft-village/qiita/stripe/Stripe34b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fsoft-village%2Fqiita%2Fstripe%2FStripe34b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8abc4dc428ae0fb5b17cc9a6a7cf9e48 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"最後に\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e最後に\u003c/h2\u003e\n\n\u003cp\u003e実際にアカウント登録、ドキュメントを参照、ASP.net MVC 5 を設定、カード決裁を実装するまで、だいたい半日程度でできました。\u003c/p\u003e\n\n\u003cp\u003eとりあえずカード課金を試してみましたが、本命は月・年額会費の課金対応。\u003cbr\u003e\n以下を参考に、後日追加で試してみるつもりです。\u003c/p\u003e\n\n\u003cp\u003eStripe Subscription （定期支払い）101 - Part 1（Stripe 日本 \u003ca href=\"/y_toku\" class=\"user-mention js-hovercard\" title=\"y_toku\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"y_toku\"\u003e@y_toku\u003c/a\u003e さん）\u003cbr\u003e\n\u003ca href=\"https://qiita.com/y_toku/items/235b5e7ee00792edcbbf\" class=\"autolink\" id=\"reference-5a1947cfd06020e302c9\"\u003ehttps://qiita.com/y_toku/items/235b5e7ee00792edcbbf\u003c/a\u003e \u003c/p\u003e\n","createdAt":"2017-12-14T08:58:05Z","elapsedYearsFromLastModifiedAt":3,"encryptedId":"O5NtueY1HlzpMUJXx160sthzcbe2+3f4--wmRm0ssgN8sp29wD--7qGuQyYksdsYnwHL0XWw9Q==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2017-12-21T03:06:49Z","likesCount":5,"linkUrl":"https://qiita.com/yukataoka/items/1c6b34818f6b7753631a","organization":null,"originalId":588286,"stockedCount":12,"title":"ASP.net MVC 5 で Stripe のカード決済を試してみる","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%8C%E7%B7%AF\"\u003e経緯\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A9%A6%E3%81%99%E3%81%93%E3%81%A8\"\u003e試すこと\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e実装してみる\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%89%8B%E9%A0%86\"\u003e手順\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#stripe-%E3%81%AE%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E7%99%BB%E9%8C%B2\"\u003eStripe のアカウント登録\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#aspnet-mvc-5-%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90\"\u003eASP.net MVC 5 のプロジェクトを作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#stripenet-%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%A3%E3%81%AE%E5%B0%8E%E5%85%A5\"\u003eStripe.net クラスライブラリィの導入\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#db%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A%E5%BF%85%E9%A0%88%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%84%E3%81%8C\"\u003eDBマイグレーションの設定（必須ではないが）\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%8D%B5%E3%81%AE%E7%AE%A1%E7%90%86\"\u003e鍵の管理\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%B3%E3%83%88%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eコントローラの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eアプリケーションサービスの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%86%E3%82%B9%E3%83%88\"\u003eテスト\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"\u003e最後に\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":3825,"uuid":"1c6b34818f6b7753631a","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"BBMP9Dbo7QJMyRUyo5/uL6COwGM=--Fa55/FvO2vMuhktS--In+afG97of5HyMuIu3MC2A==","originalId":75892,"description":"若い頃にUターンしたIT屋で、出身は高知県仁淀川町。IoTとクラウドを活用した地域課題解決などに挑戦。\r\nコミュニティ活動の傍ら、サイボウズ公認 kintone エバンジェリスト も務める複業者。","facebookUrl":"https://facebook.com/yukihito.kataoka","githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"幸人 片岡","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/75892/profile-images/1512029696","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F75892%2Fprofile-images%2F1512029696?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=dbc0c412d8c6b47305762bfef6e7aecd","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F75892%2Fprofile-images%2F1512029696?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=627b67c001043b46f9248bb3d252c04f","urlName":"yukataoka","websiteUrl":"","twitterUrl":"https://twitter.com/ykataoka","twitterUrlName":"ykataoka","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"ASP.NET","urlName":"asp.net"},{"name":"stripe","urlName":"stripe"},{"name":"mvc","urlName":"mvc"},{"name":"カード決済","urlName":"%e3%82%ab%e3%83%bc%e3%83%89%e6%b1%ba%e6%b8%88"}],"followingLikers":{"edges":[]},"comments":{"totalCount":1}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
