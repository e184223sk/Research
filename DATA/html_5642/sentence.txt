More than 1 year has passed since last update.OneNoteのアドイン(dll)を開発中、クリップボードに文字列を設定できず嵌った。[C#][.NET] クリップボードに文字列を設定する
を見ながらコーディングしたがうまくいかない。
別のプロジェクトにミニマムを作って同じコードで動かすとうまくいく。ググった感じSTAThread属性が付いていないと上手く値が反映されないらしい。WinFormsを作成した時に勝手にできてるあれです。いつも何も考えずにつけてるので完全にノーマークでした。STAはSingle Thread Apartmentの略で、逆はMTAでMulti Thread Apartmentの略です。２つに違いはオブジェクトが単一スレッドを想定しているか、マルチスレッドを想定しているかとのこと。まず、ClipboardはCOMを利用しています。COMはオブジェクトやスレッドを、アパートメントと呼ばれるCOMがその境界を越えて呼び出しをマーシャリングする領域に割り当てられます。このCOMは作成したスレッドと別のスレッドで動かすことができないらしい。なので、コードを動かすスレッドのメソッドに属性としてSTAThreadを付けないと動かない見たいです。
COMを使っている代表例に、があるんだそうな。こんな感じで書いたらとりあえず動きました。色々調べながら書いてたけど間違ってる気しかしない。タスケテ。。。
ところで、今回一番驚いたのはMACでC#のClipboardを利用できることでしたとさ。


