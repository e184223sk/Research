More than 1 year has passed since last update.Unity2018で登場したConstraint系コンポーネント．
使い方はわかったけど，スクリプトでこのコンポーネントを操作するにはどうすればいいか．自分がはまったところを中心に語っていきたいと思います．なお，Constraintについての説明は省略気味で行きます．僕が説明するよりも，先人の人が詳しく説明しているので，下記を見てください．従来のUnityの親子関係は，親と子の関係は１対多になっています．(下の図のようにHierarchyで子オブジェクトの階層が下がってます．)
そして，親オブジェクトのTransformの変化を子オブジェクトも受けるというのが特徴的でした．
ただ，UIだと必ず子オブジェクトが前面に出てしまうという欠点がありました．親子関係を持つとレイヤー分けができないこととUIだとLayerの設定を変えても適用されないのが原因みたいですが．．．(参考：)
もちろん，SpriteRendererのSortingLayerで描画順を設定すればこの問題を解決できます．でも，これだとUIを使えないという悲しい結果になります．Constraintは直訳すると制限って意味です．このコンポーネントを使うとオブジェクトの動作について他のオブジェクトとの関係を使っての制限を設けることができます．詳しくはコチラに書いてあります．
http://tsubakit1.hateblo.jp/entry/2018/01/12/233522※注意※
今後の説明で影響を受けさせるオブジェクトのことを便宜上「親オブジェクト」と表現します．Constraintは，主観的にいうと3点の特徴が挙げられます．1:親子関係が多対１な形を形成できること．2:親子関係のUIを作る必要がないために，Hierarchyの位置を変えるだけで，描画順を変えられる．
(※描画順の解決にはなってない)3:Constraint(制限)を受ける場所について，Positonのみ，Rotationのみ，全部(Parent)の3種類があって，状況で使い分けができる．最近，GitHubでUnityのエディタがどのように動いているか公開されました．これを見ながらコードについて軽く説明します．
コードだけ知りたい人は，下記のスクリプトを見てください．１：Constarint系コンポーネントを取得２：ConstraintSource構造体を作成し・どのオブジェクトによる制限を受けさせるか設定３：Constraintに２で作成したConstraintSourceをAddはまりポイントは主に２つ．１：親オブジェクトの要素を追加する場合は，ConstarintSource構造体を作成してそこにオブジェクトのTransform系の情報を追加しないといけない．
２：１の追加に加えて，影響度Weightを1に設定する必要がある．Weightは影響度のことで0~1のfloat値が入ります．0だと設定していても親オブジェクトへの支配が起きず，1であれば完全に支配します．
完全な支配になると親オブジェクトが変化(Transformが変化)しない限り，そのConstarintを付けられたオブジェクトは変化できないというものです．
スクリプトで追加するときには，Weightがデフォルトで0になっちゃう仕様のようで，これを見落としていたことが大きなはまりポイントでした．ConstraintSourceについては，下記のGitHubのUnityリファレンスに書いてあります．これを踏まえて作っていきます．今回は，PositionConstraint(位置のみ)とParentConstraint(親子関係みたいなもの)の2パターン用意しました．
はまりポイントを解決することを考慮するとちょっとくどい感じになっちゃいますね．
Constraintコンポーネントの有効無効は，isActiveでもいいかもしれません．次に親オブジェクトにアタッチするスクリプトです．(ファイル名がてきとうなのは仕様です．)では，実際に動かしてみましょう．今回はUIのImageを使っていきます．
Imageを2こSceneに配置し，それぞれ"Parent"，"Child"という名前にしてください．
そのあと，下記のように設定をしてください．ここでChildの設定時に注意点が2つあります．
１：Constraint系コンポーネントでIsActiveにチェックを入れておくこと(デフォルトだと入ってません)
２：ConstraintTestスクリプトのSourceRectTransformにParentをアタッチすること(追従する親オブジェクトの登録ができません)　　最後に描画順を考慮して，上からChild，Parentとなるように配置してください．
これで完成です．
さっそくプレビューで動かしてみましょう．Spaceキーを押すとParentがマウスカーソルの位置に追従します．ここでRキーを押すとChildオブジェクトもParentを追従しだし，マウスカーソルに追従するような動きを見せてくれるはずです．(ここまででうまくいかない場合は最初からやり直してみてください)
さて，一度Spaceキーでマウスカーソルの追従を止めて，ChildオブジェクトのInspectorを見てみましょう．はい，ParentがSourcesに追加されていますね．横の数値が先述した影響度になります．ここでこれを0にして，再度Spaceキーを押してみましょう．Parentしか追従しなくなるはずです．というわけで，Constraint系コンポーネントをスクリプトから動的に扱うための備忘録でした．
間違いがありましたらご指摘お願いします．


