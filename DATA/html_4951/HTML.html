<!DOCTYPE html><html><head><meta charset="utf-8" /><title>EventHub -&gt; Stream Analytics -&gt; CosmosDB で E2E テストをしようとしてハマったこと - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/TsuyoshiUshio@github/items/6560f7323db7044a3a49" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="VDiccPyibWZ01d9EbhgBXJK5h/sRx1CLorjJXZXDR2BjU5zpj5eVHHVxzobYfKTFt7FVmtddohbQqiQ2oaBlmw==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="EventHub -&gt; Stream Analytics -&gt; CosmosDB で E2E テストをしようとしてハマったこと - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1SWFpsYm5SSWRXSWdMVDRnVTNSeVpXRnRJRUZ1WVd4NWRHbGpjeUF0UGlCRGIzTnRiM05FUWlEamdhY2dSVEpGSU9PRGh1T0N1ZU9EaU9PQ2t1T0JsLU9DaU9PQmh1T0JxT09CbC1PQnB1T0RqLU9EbnVPQm8tT0JuLU9Cay1PQnFBJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPThkZjMwZjdiYjFmZTJiN2E3YmU2ZTU1ZThmYTc1Y2Rl&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=cd7b83303a636f4429ac72027d615e7b"><meta property="og:description" content="前回のStream Analytics で 凝った集計処理を実装するで書いた通り、Stream Analytics でテストデータから、Portal 上で想定通りデータがサマリされるところまで確認した。次に、EventHub -&amp;gt..."><meta content="https://qiita.com/TsuyoshiUshio@github/items/6560f7323db7044a3a49" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,StreamAnalytics,EventHubs,CosmosDB" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-abdd99de-8a50-48f0-bf33-62a6316854a9"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F6560f7323db7044a3a49">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F6560f7323db7044a3a49">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-abdd99de-8a50-48f0-bf33-62a6316854a9">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-06-23T00:23:29.000+09:00","dateModified":"2018-06-23T00:28:41.000+09:00","headline":"EventHub -\u003e Stream Analytics -\u003e CosmosDB で E2E テストをしようとしてハマったこと","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1SWFpsYm5SSWRXSWdMVDRnVTNSeVpXRnRJRUZ1WVd4NWRHbGpjeUF0UGlCRGIzTnRiM05FUWlEamdhY2dSVEpGSU9PRGh1T0N1ZU9EaU9PQ2t1T0JsLU9DaU9PQmh1T0JxT09CbC1PQnB1T0RqLU9EbnVPQm8tT0JuLU9Cay1PQnFBJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPThkZjMwZjdiYjFmZTJiN2E3YmU2ZTU1ZThmYTc1Y2Rl\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=cd7b83303a636f4429ac72027d615e7b","mainEntityOfPage":"https://qiita.com/TsuyoshiUshio@github/items/6560f7323db7044a3a49","author":{"@type":"Person","address":"Kanagwa, Japan","email":null,"identifier":"TsuyoshiUshio@github","name":"TsuyoshiUshio@github","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","url":"https://qiita.com/TsuyoshiUshio@github","description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202106-uzabase-3/">社員の行動の基盤となるユーザベースのミッション・バリュー</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202106-uzabase-3/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"6560f7323db7044a3a49"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"社員の行動の基盤となるユーザベースのミッション・バリュー","url":"https://zine.qiita.com/interview/202106-uzabase-3/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"6560f7323db7044a3a49"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"社員の行動の基盤となるユーザベースのミッション・バリュー","url":"https://zine.qiita.com/interview/202106-uzabase-3/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"6560f7323db7044a3a49"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"社員の行動の基盤となるユーザベースのミッション・バリュー","url":"https://zine.qiita.com/interview/202106-uzabase-3/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/TsuyoshiUshio@github/items/6560f7323db7044a3a49","location":"/TsuyoshiUshio@github/items/6560f7323db7044a3a49","scheme":"https","host":"qiita.com","port":null,"pathname":"/TsuyoshiUshio@github/items/6560f7323db7044a3a49","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"wlHM1hp90WBjlpd3Iu7QA9EHMlqUmh1bcJalSdJnwjf1OsxPaUgpGmIyhrWUinWa9A/gO1IA78YChEgi5gTgzA==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-151be2d0-b9dc-4d91-9335-2010698db377"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49/likers" class="css-1iupg5d">3</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">0</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/6560f7323db7044a3a49/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/TsuyoshiUshio@github"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/TsuyoshiUshio@github" class="css-10ougpm">@<!-- -->TsuyoshiUshio@github</a><div class="css-1ay9vb9"><span><meta content="2018-06-22T15:23:29Z"/><time dateTime="2018-06-22T15:28:41Z" class="css-m19uds">updated at 2018-06-22</time></span></div></div></div></div></div><h1 class="css-cgzq40">EventHub -&gt; Stream Analytics -&gt; CosmosDB で E2E テストをしようとしてハマったこと</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/streamanalytics" class="css-4czcte">StreamAnalytics</a><a href="/tags/eventhubs" class="css-4czcte">EventHubs</a><a href="/tags/cosmosdb" class="css-4czcte">CosmosDB</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>前回の<a href="https://qiita.com/TsuyoshiUshio@github/items/d046a8820ab8e528c9b2" id="reference-1149e8204a2bfa09fc5c">Stream Analytics で 凝った集計処理を実装する</a>で書いた通り、Stream Analytics でテストデータから、Portal 上で想定通りデータがサマリされるところまで確認した。次に、<code>EventHub -&gt; Stream Analytics -&gt; CosmosDB</code> の構成なので、それがちゃんと動作するかのE2Eのスモークテストを簡単に書いておこうと思った。ところが、これが早速うまくいかなかった。出てきた問題点を次にはまらないように整理しておく。</p>

<h1>
<span id="課題" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a>課題</h1>

<p>課題は前回の記事のSQL を作成して、ポータル上でテストも完成したので、まったく同じデータを使って、EventHubs のライブラリからポストすると CosmosDBに全くストアされない。なんでやねん。この問題を解決したいと思った。結構解決に時間がかかったが、様々な要因が絡み合っていたので、それを忘れないようにメモしておきたい。</p>

<h1>
<span id="eventhubs-のクライアントライブラリ" class="fragment"></span><a href="#eventhubs-%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a>EventHubs のクライアントライブラリ</h1>

<p>EventHubs のクライアントライブラリを使ったコードは、<a href="https://docs.microsoft.com/ja-jp/azure/event-hubs/event-hubs-programming-guide" rel="nofollow noopener" target="_blank">Event Hubs のプログラミング ガイド</a>というページがあるのだが、少なくとも .NetCore を使っている人はこの書き方はバージョンが古い上に、<code>WindowsAzure.ServiceBus</code> をインストールする必要がある。.NETCore 使いの人はこちら。</p>

<h2>
<span id="net-standard-用のドキュメントを見る" class="fragment"></span><a href="#net-standard-%E7%94%A8%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%82%92%E8%A6%8B%E3%82%8B"><i class="fa fa-link"></i></a>.Net Standard 用のドキュメントを見る</h2>

<ul>
<li><a href="https://docs.microsoft.com/ja-jp/azure/event-hubs/event-hubs-dotnet-standard-getstarted-send" rel="nofollow noopener" target="_blank">.NET Standard で Azure Event Hubs へのメッセージ送信を開始する</a></li>
</ul>

<h2>
<span id="azure-functions-で使うならextensions-を使う" class="fragment"></span><a href="#azure-functions-%E3%81%A7%E4%BD%BF%E3%81%86%E3%81%AA%E3%82%89extensions-%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>Azure Functions で使うなら、Extensions を使う</h2>

<p>nuget パッケージも <code>Microsoft.Azure.EventHubs</code> のみでよい。かなりすっきりする。私はAzure Functions で使うので、‘Microsoft.Azure.WebJobs.Extensions.EventHubs (v3.0.0-beta7-11351)` のパッケージを使っている。</p>

<p>このバージョンでいくと、古いバージョンだと<code>NameSpaceManager</code> 等が必要だったのがもっとすっきり書ける。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>   <span class="p">:</span>
<span class="kt">var</span> <span class="n">eventHubsConnectionString</span> <span class="p">=</span> <span class="n">configration</span><span class="p">[</span><span class="s">"EvebtHubsConnectionString"</span><span class="p">];</span>
<span class="kt">var</span> <span class="n">eventHubsEntityPath</span> <span class="p">=</span> <span class="n">configration</span><span class="p">[</span><span class="s">"EventHubsEntityPath"</span><span class="p">];</span>

<span class="kt">var</span> <span class="n">connectionStringBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EventHubsConnectionStringBuilder</span><span class="p">(</span><span class="n">eventHubsConnectionString</span><span class="p">)</span>
<span class="p">{</span>  
    <span class="n">EntityPath</span> <span class="p">=</span> <span class="n">eventHubsEntityPath</span>
<span class="p">};</span>
<span class="n">eventHubClient</span> <span class="p">=</span> <span class="n">EventHubClient</span><span class="p">.</span><span class="nf">CreateFromConnectionString</span><span class="p">(</span><span class="n">connectionStringBuilder</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>

<span class="k">await</span> <span class="n">eventHubClient</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="k">new</span> <span class="nf">EventData</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">message</span><span class="p">)));</span>
</code></pre></div></div>

<p>ぐらいの感じでかけて相当すっきりとかけていい感じ。</p>

<h1>
<span id="stream-analytics-のクエリーから出力された結果の-json-が小文字になる" class="fragment"></span><a href="#stream-analytics-%E3%81%AE%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%BC%E3%81%8B%E3%82%89%E5%87%BA%E5%8A%9B%E3%81%95%E3%82%8C%E3%81%9F%E7%B5%90%E6%9E%9C%E3%81%AE-json-%E3%81%8C%E5%B0%8F%E6%96%87%E5%AD%97%E3%81%AB%E3%81%AA%E3%82%8B"><i class="fa fa-link"></i></a>Stream Analytics のクエリーから出力された結果の JSON が小文字になる</h1>

<p>現在の制限事項らしい。泣く泣く出力先のクラスの属性を小文字にした。(属性をつけてもよかったけど）</p>

<ul>
<li><a href="https://stackoverflow.com/questions/37008643/azure-stream-analytics-output-headers-case-sensitivity" rel="nofollow noopener" target="_blank">Azure stream analytics output headers case sensitivity?</a></li>
</ul>

<h1>
<span id="cosmosdb-にデータが出力されなかった原因" class="fragment"></span><a href="#cosmosdb-%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E5%87%BA%E5%8A%9B%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E5%8E%9F%E5%9B%A0"><i class="fa fa-link"></i></a>CosmosDB にデータが出力されなかった原因</h1>

<h2>
<span id="stream-analytics-を開始していない" class="fragment"></span><a href="#stream-analytics-%E3%82%92%E9%96%8B%E5%A7%8B%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>Stream Analytics を開始していない</h2>

<p>これは、まず疑うべきところ。実際わすれていた。</p>

<h2>
<span id="timestamp--window-を使ったクエリの場合データはstream-analytics-の開始時より後でないといけない" class="fragment"></span><a href="#timestamp--window-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AE%E5%A0%B4%E5%90%88%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AFstream-analytics-%E3%81%AE%E9%96%8B%E5%A7%8B%E6%99%82%E3%82%88%E3%82%8A%E5%BE%8C%E3%81%A7%E3%81%AA%E3%81%84%E3%81%A8%E3%81%84%E3%81%91%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>timestamp / window を使ったクエリの場合、データはStream Analytics の開始時より後でないといけない</h2>

<p>次のページが参考になった。結局クエリを実行したが、０件だからデータが吐かれていなかったということが原因だった。現在のクエリはこれでモロ該当する</p>

<div class="code-frame" data-lang="sql"><div class="highlight"><pre class="with-code"><code><span class="k">WITH</span> <span class="n">SelectPreviousEvent</span> <span class="k">AS</span>
<span class="p">(</span>
<span class="k">SELECT</span>
    <span class="n">TeamId</span><span class="p">,</span>
    <span class="k">System</span><span class="p">.</span><span class="nb">TimeStamp</span> <span class="k">As</span> <span class="nb">Time</span><span class="p">,</span>
    <span class="k">Count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="k">Count</span>
<span class="k">FROM</span>
    <span class="n">downtime</span> <span class="nb">TIMESTAMP</span> <span class="k">BY</span> <span class="nb">Date</span>
<span class="k">GROUP</span> <span class="k">BY</span>
  <span class="n">TeamId</span><span class="p">,</span>
  <span class="n">TumblingWindow</span><span class="p">(</span><span class="k">second</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">SELECT</span> 
  <span class="n">TeamId</span><span class="p">,</span>
  <span class="k">System</span><span class="p">.</span><span class="nb">Timestamp</span> <span class="k">As</span> <span class="nb">Time</span><span class="p">,</span>
  <span class="k">Count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">As</span> <span class="k">Count</span>
<span class="k">INTO</span>
    <span class="p">[</span><span class="n">cosmosdb</span><span class="p">]</span>
<span class="k">FROM</span> <span class="n">SelectPreviousEvent</span>
<span class="k">Group</span> <span class="k">BY</span>
  <span class="n">TeamId</span><span class="p">,</span>
  <span class="n">TumblingWindow</span><span class="p">(</span><span class="k">minute</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

</code></pre></div></div>

<h3>
<span id="シンプルなクエリにして設定が正しいか確認する" class="fragment"></span><a href="#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AB%E3%81%97%E3%81%A6%E8%A8%AD%E5%AE%9A%E3%81%8C%E6%AD%A3%E3%81%97%E3%81%84%E3%81%8B%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>シンプルなクエリにして、設定が正しいか確認する</h3>

<p>これはクエリを <code>SELECT * INTO cosmosdb FROM downtime</code> みたいな単純な全件検索にして気づいた。この場合問題なく全件がCosmosDB に書かれたということは、設定は間違っていない。 </p>

<ul>
<li><a href="https://docs.microsoft.com/ja-jp/azure/stream-analytics/stream-analytics-troubleshooting-guide" rel="nofollow noopener" target="_blank">Azure Stream Analytics のトラブルシューティング ガイド</a></li>
</ul>

<p>特に、<code>Timestamp By</code> を使用する場合は、イベントのタイムスタンプがジョブの開始時刻より後であることが必要です。また、Window 関数を使っているときに、 Window が終わっていなかったらデータが来ません。</p>

<h3>
<span id="データの時刻が現在時刻とはずれすぎているとクエリーが動かない" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%99%82%E5%88%BB%E3%81%8C%E7%8F%BE%E5%9C%A8%E6%99%82%E5%88%BB%E3%81%A8%E3%81%AF%E3%81%9A%E3%82%8C%E3%81%99%E3%81%8E%E3%81%A6%E3%81%84%E3%82%8B%E3%81%A8%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%BC%E3%81%8C%E5%8B%95%E3%81%8B%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>データの時刻が現在時刻とはずれすぎているとクエリーが動かない</h3>

<p>これはたぶん <code>Timestamp By</code> と思われるが、Stream Analytics 開始後であっても、タイムスタンプがデータが送られた時間と大幅にかけ離れていてもうまくクエリーできないみたいだ。</p>

<p>例えば、クエリー開始時間後の　5分、10分 15分　ぐらいのデータを一気に送信すると、5 分のデータは出力されたが、そのあとのは出力されなかった。このあたりの仕様はよくわからないし、ドキュメントでも見つけられないのでメーリングリストで聞くか、友人に聞いてみたい。(<strong>TODO</strong>) </p>

<p>つまり <strong>ほぼリアルタイムにデータを送信する必要がある</strong>。</p>

<h3>
<span id="collection-を再作成するとoutput-を作成しなおす必要がある" class="fragment"></span><a href="#collection-%E3%82%92%E5%86%8D%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E3%81%A8output-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%AA%E3%81%8A%E3%81%99%E5%BF%85%E8%A6%81%E3%81%8C%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>Collection を再作成すると、Output を作成しなおす必要がある</h3>

<p>最初は E2E テストを書いているときに、最初にアウトプットをするコレクションをクリアしたかったので、一旦コレクションを消して、作成するというオペレーションをしていた。すると、<code>アクティビティログ</code> で次のようなエラーに会う。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>        "Message": "First Occurred: 06/22/2018 08:22:07 | Resource Name: cosmosdb | Message: There was a problem writing to CosmosDB db:[leaderboard], and collection:[DowntimeRecord]. ",
        "Type": "DiagnosticMessage",

もしくは

Send Events: CosmosDB Output write Data failure
</code></pre></div></div>

<p>おそらく、アウトプットの設定時に、コネクションを始めているのかもしれない。だから、Stream Analytics の開始時点のコレクションがなくなったら書き込みができなくなるので、そういったことをしないのがポイント。</p>

<p><a href="https://camo.qiitausercontent.com/af85f5a5a76a2ace86ff05ab48d493f4babeb23a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64663636623035302d316234372d633331652d306165392d6333646232646263323030342e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fdf66b050-1b47-c31e-0ae9-c3db2dbc2004.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=eefa695ac4aad047f0d204e9e8df7b6e" alt="Output.JPG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/df66b050-1b47-c31e-0ae9-c3db2dbc2004.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fdf66b050-1b47-c31e-0ae9-c3db2dbc2004.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f1ccaf8b6095360086c25a31a391277f 1x" loading="lazy"></a></p>

<h1>
<span id="e2e-テストのノウハウ" class="fragment"></span><a href="#e2e-%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E3%83%8E%E3%82%A6%E3%83%8F%E3%82%A6"><i class="fa fa-link"></i></a>E2E テストのノウハウ</h1>

<h3>
<span id="document-の全件削除は工夫が必要" class="fragment"></span><a href="#document-%E3%81%AE%E5%85%A8%E4%BB%B6%E5%89%8A%E9%99%A4%E3%81%AF%E5%B7%A5%E5%A4%AB%E3%81%8C%E5%BF%85%E8%A6%81"><i class="fa fa-link"></i></a>Document の全件削除は工夫が必要</h3>

<p>コレクションを削除する代わりに、Document を全件削除するとよい。しかしこれが面倒だ。そいうったメソッドはないし、やろうとしたら、全件クエリーして、１件づつ削除なのだが、PartitionKey があるテーブルだと、それを設定しないといけない。Generic なメソッドを作ろうと思ったが、面倒になって、べたべたのコードを書いた。ここ以外で使うタイミングがないので、抽象化が割に合わない。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DowntimeRecord</span><span class="p">&gt;&gt;</span> <span class="nf">GetAllDowntimeRecordAsync</span><span class="p">(</span><span class="n">IDocumentService</span> <span class="n">service</span><span class="p">,</span> <span class="kt">string</span> <span class="n">teamId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">service</span><span class="p">.</span><span class="nf">GetClient</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">CreateDocumentQuery</span><span class="p">&lt;</span><span class="n">DowntimeRecord</span><span class="p">&gt;(</span>
                <span class="n">UriFactory</span><span class="p">.</span><span class="nf">CreateDocumentCollectionUri</span><span class="p">(</span><span class="s">"leaderboard"</span><span class="p">,</span> <span class="s">"DowntimeRecord"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">f</span> <span class="p">=&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">teamid</span> <span class="p">==</span> <span class="n">teamId</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">AsEnumerable</span><span class="p">();</span>
            <span class="k">return</span> <span class="n">query</span><span class="p">.</span><span class="n">ToList</span><span class="p">&lt;</span><span class="n">DowntimeRecord</span><span class="p">&gt;();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DeleteAllDocuments</span><span class="p">(</span><span class="n">IDocumentService</span> <span class="n">service</span><span class="p">,</span> <span class="kt">string</span> <span class="n">teamId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">service</span><span class="p">.</span><span class="nf">GetClient</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">records</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">GetAllDowntimeRecordAsync</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">teamId</span><span class="p">);</span>
            <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">record</span> <span class="k">in</span> <span class="n">records</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">DeleteDocumentAsync</span><span class="p">(</span><span class="n">UriFactory</span><span class="p">.</span><span class="nf">CreateDocumentUri</span><span class="p">(</span><span class="s">"leaderboard"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">DowntimeRecord</span><span class="p">).</span><span class="n">Name</span> <span class="p">,</span> <span class="n">record</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
                <span class="p">,</span> <span class="k">new</span> <span class="nf">RequestOptions</span><span class="p">()</span> <span class="p">{</span> <span class="n">PartitionKey</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PartitionKey</span><span class="p">(</span><span class="n">teamId</span><span class="p">)</span> <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="現在時刻を使ったテストデータ" class="fragment"></span><a href="#%E7%8F%BE%E5%9C%A8%E6%99%82%E5%88%BB%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%83%86%E3%82%B9%E3%83%88%E3%83%87%E3%83%BC%E3%82%BF"><i class="fa fa-link"></i></a>現在時刻を使ったテストデータ</h2>

<p>大変面倒だが、テストデータは、一気に投入できない。時間を必要とするパターンがある場合、該当の時間にデータを投入する必要がある。作戦としては、データパターンを作っておいて、そのデータパターンに現在時を入れて、その相対時間でテストデータを作るとよい。厳密にいうとタイミングによっては Fail して freaky なテストになるかもしれないが、発生するまではこれで。発生したら、もっとロジックで正しさを証明するように直すとよい。（例えば、Stream Analytics に期待するロジックをテストで書いておいて、インプットデータと、予想されるアウトプットを計算するロジックを書く。みなさんどうしているのだろう。もしもっといい方法があれば是非ご教授ください。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>        <span class="k">private</span> <span class="n">DowntimeReport</span><span class="p">[]</span> <span class="nf">GetPatternSample</span><span class="p">(</span><span class="kt">int</span> <span class="n">patternNumber</span><span class="p">,</span> <span class="n">DateTime</span> <span class="n">date</span><span class="p">)</span>
        <span class="p">{</span>

            <span class="k">switch</span><span class="p">(</span><span class="n">patternNumber</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="m">0</span><span class="p">:</span>
                    <span class="c1">// Normal case failure</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">DowntimeReport</span><span class="p">[]</span> <span class="p">{</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01POI"</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01POI"</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span> <span class="p">+</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01POI"</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span> <span class="p">+</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">2</span><span class="p">)))</span>
                    <span class="p">};</span>
                <span class="k">case</span> <span class="m">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">DowntimeReport</span><span class="p">[]</span>
                    <span class="p">{</span>
                    <span class="c1">// Multiple service failure at the same time</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01POI"</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01USER"</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01USER"</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span> <span class="p">+</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">)))</span>
                    <span class="p">};</span>
                <span class="k">case</span> <span class="m">2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">DowntimeReport</span><span class="p">[]</span>
                    <span class="p">{</span>
                        <span class="c1">// Multiple teams failure at the same time</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01TRIP"</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team02"</span><span class="p">,</span> <span class="s">"Team02POI"</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01TRIP"</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span> <span class="p">+</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team02"</span><span class="p">,</span> <span class="s">"Team02POI"</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span> <span class="p">+</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">2</span><span class="p">)))</span>
                    <span class="p">};</span>
                <span class="k">default</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">DowntimeReport</span><span class="p">[]</span>
                    <span class="p">{</span>
                        <span class="c1">// Multiple teams/services failure at the same time.</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01TRIP"</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01POI"</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team02"</span><span class="p">,</span> <span class="s">"Team02POI"</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team02"</span><span class="p">,</span> <span class="s">"Team02USER"</span><span class="p">,</span> <span class="n">date</span><span class="p">),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team01"</span><span class="p">,</span> <span class="s">"Team01TRIP"</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span> <span class="p">+</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))),</span>
                        <span class="nf">GetFailureDowntimeReport</span><span class="p">(</span><span class="s">"Team02"</span><span class="p">,</span> <span class="s">"Team02POI"</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span> <span class="p">+</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">2</span><span class="p">)))</span>

                    <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>

<ul>
<li><a href="https://stackoverflow.com/questions/42907631/stream-analytics-and-stream-postion" rel="nofollow noopener" target="_blank">Stream Analytics and stream postion</a></li>
</ul>

<h1>
<span id="デバッグ" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0"><i class="fa fa-link"></i></a>デバッグ</h1>

<p>デバッグに関しては、クライアントは、VS のデバッグ機能でステップ実行するのが王道。また、Stream Analytics の場合、Metrics を見ると、Input はあるのに、Output がない（ということは、クエリーの結果０件）とかがわかる。</p>

<p><a href="https://camo.qiitausercontent.com/0dc5a41e8ce27e9114d6b6d5564661e06a86222a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32316231353363352d646135392d353131652d363132332d3230653963363134306461322e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F21b153c5-da59-511e-6123-20e9c6140da2.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fd81ca12802f4d2e85dd04dcc3e9771d" alt="Metric.JPG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/21b153c5-da59-511e-6123-20e9c6140da2.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F21b153c5-da59-511e-6123-20e9c6140da2.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f75a8ed9658f5a09cfe98d095e5b2250 1x" loading="lazy"></a></p>

<p>他には アクティビティログはcosmosdbの接続問題を診断するのに役立った。、診断ログが設定できるので設定しておいたが、ストレージにイベントが吐かれているのがわかった。</p>

<h1>
<span id="その他" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96"><i class="fa fa-link"></i></a>その他</h1>

<p>小さな Tips だけど、上記にあるように、DateTime の演算をしたいときに、TimeSpan を渡せば演算できる</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>これで無事E2Eテストが実行されて動作が確認できた。次は Change Feed + CosmosDB Trigger を使って、最終的な集計を実施してそれも、E2Eテストに組み込んでみたい。</p>

<p>あと、これいい記事だった。Pluralsight は２時間半なので、ちゃんと見てみよう。</p>

<ul>
<li><a href="https://blog.okazuki.jp/entry/2015/08/31/220406" rel="nofollow noopener" target="_blank">Stream Analytics入門してみた #azurejp</a></li>
<li><a href="https://app.pluralsight.com/library/courses/azure-stream-analytics-understanding/table-of-contents" rel="nofollow noopener" target="_blank">Understanding Azure Stream Analytics</a></li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F6560f7323db7044a3a49&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F6560f7323db7044a3a49&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49/likers" class="css-1iupg5d">3</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">0</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/6560f7323db7044a3a49/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/6560f7323db7044a3a49.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-151be2d0-b9dc-4d91-9335-2010698db377">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-2a5a0d42-8a10-4007-9e33-54f21cd4d8ea"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-2a5a0d42-8a10-4007-9e33-54f21cd4d8ea">{}</script>
      
<div id="LoginModal-react-component-c4720ea6-5b1b-48ce-8aaa-69eb1abe52a8"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-c4720ea6-5b1b-48ce-8aaa-69eb1abe52a8">{}</script>
      
<div id="StockModal-react-component-fea5297a-28a0-409c-9c39-43ec80133b97"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-fea5297a-28a0-409c-9c39-43ec80133b97">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;5DgpHkRc+Xvif5sLZugYW49u1NrkitUL0dflbWXUzxjTUymHN2kBAePbisnQjL3CqmYGuyIQJ5ajxQgGUbft4w==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e前回の\u003ca href=\"https://qiita.com/TsuyoshiUshio@github/items/d046a8820ab8e528c9b2\" id=\"reference-1149e8204a2bfa09fc5c\"\u003eStream Analytics で 凝った集計処理を実装する\u003c/a\u003eで書いた通り、Stream Analytics でテストデータから、Portal 上で想定通りデータがサマリされるところまで確認した。次に、\u003ccode\u003eEventHub -\u0026gt; Stream Analytics -\u0026gt; CosmosDB\u003c/code\u003e の構成なので、それがちゃんと動作するかのE2Eのスモークテストを簡単に書いておこうと思った。ところが、これが早速うまくいかなかった。出てきた問題点を次にはまらないように整理しておく。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"課題\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題\u003c/h1\u003e\n\n\u003cp\u003e課題は前回の記事のSQL を作成して、ポータル上でテストも完成したので、まったく同じデータを使って、EventHubs のライブラリからポストすると CosmosDBに全くストアされない。なんでやねん。この問題を解決したいと思った。結構解決に時間がかかったが、様々な要因が絡み合っていたので、それを忘れないようにメモしておきたい。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"eventhubs-のクライアントライブラリ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#eventhubs-%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eEventHubs のクライアントライブラリ\u003c/h1\u003e\n\n\u003cp\u003eEventHubs のクライアントライブラリを使ったコードは、\u003ca href=\"https://docs.microsoft.com/ja-jp/azure/event-hubs/event-hubs-programming-guide\" rel=\"nofollow noopener\" target=\"_blank\"\u003eEvent Hubs のプログラミング ガイド\u003c/a\u003eというページがあるのだが、少なくとも .NetCore を使っている人はこの書き方はバージョンが古い上に、\u003ccode\u003eWindowsAzure.ServiceBus\u003c/code\u003e をインストールする必要がある。.NETCore 使いの人はこちら。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"net-standard-用のドキュメントを見る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#net-standard-%E7%94%A8%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%82%92%E8%A6%8B%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e.Net Standard 用のドキュメントを見る\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/azure/event-hubs/event-hubs-dotnet-standard-getstarted-send\" rel=\"nofollow noopener\" target=\"_blank\"\u003e.NET Standard で Azure Event Hubs へのメッセージ送信を開始する\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"azure-functions-で使うならextensions-を使う\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#azure-functions-%E3%81%A7%E4%BD%BF%E3%81%86%E3%81%AA%E3%82%89extensions-%E3%82%92%E4%BD%BF%E3%81%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eAzure Functions で使うなら、Extensions を使う\u003c/h2\u003e\n\n\u003cp\u003enuget パッケージも \u003ccode\u003eMicrosoft.Azure.EventHubs\u003c/code\u003e のみでよい。かなりすっきりする。私はAzure Functions で使うので、‘Microsoft.Azure.WebJobs.Extensions.EventHubs (v3.0.0-beta7-11351)` のパッケージを使っている。\u003c/p\u003e\n\n\u003cp\u003eこのバージョンでいくと、古いバージョンだと\u003ccode\u003eNameSpaceManager\u003c/code\u003e 等が必要だったのがもっとすっきり書ける。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e   \u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eeventHubsConnectionString\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econfigration\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"EvebtHubsConnectionString\"\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eeventHubsEntityPath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econfigration\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"EventHubsEntityPath\"\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econnectionStringBuilder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eEventHubsConnectionStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eeventHubsConnectionString\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e  \n    \u003cspan class=\"n\"\u003eEntityPath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eeventHubsEntityPath\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"n\"\u003eeventHubClient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEventHubClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateFromConnectionString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econnectionStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eeventHubClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eEventData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eぐらいの感じでかけて相当すっきりとかけていい感じ。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"stream-analytics-のクエリーから出力された結果の-json-が小文字になる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#stream-analytics-%E3%81%AE%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%BC%E3%81%8B%E3%82%89%E5%87%BA%E5%8A%9B%E3%81%95%E3%82%8C%E3%81%9F%E7%B5%90%E6%9E%9C%E3%81%AE-json-%E3%81%8C%E5%B0%8F%E6%96%87%E5%AD%97%E3%81%AB%E3%81%AA%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStream Analytics のクエリーから出力された結果の JSON が小文字になる\u003c/h1\u003e\n\n\u003cp\u003e現在の制限事項らしい。泣く泣く出力先のクラスの属性を小文字にした。(属性をつけてもよかったけど）\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://stackoverflow.com/questions/37008643/azure-stream-analytics-output-headers-case-sensitivity\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAzure stream analytics output headers case sensitivity?\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"cosmosdb-にデータが出力されなかった原因\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#cosmosdb-%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E5%87%BA%E5%8A%9B%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E5%8E%9F%E5%9B%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCosmosDB にデータが出力されなかった原因\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"stream-analytics-を開始していない\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#stream-analytics-%E3%82%92%E9%96%8B%E5%A7%8B%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStream Analytics を開始していない\u003c/h2\u003e\n\n\u003cp\u003eこれは、まず疑うべきところ。実際わすれていた。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"timestamp--window-を使ったクエリの場合データはstream-analytics-の開始時より後でないといけない\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#timestamp--window-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AE%E5%A0%B4%E5%90%88%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AFstream-analytics-%E3%81%AE%E9%96%8B%E5%A7%8B%E6%99%82%E3%82%88%E3%82%8A%E5%BE%8C%E3%81%A7%E3%81%AA%E3%81%84%E3%81%A8%E3%81%84%E3%81%91%E3%81%AA%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003etimestamp / window を使ったクエリの場合、データはStream Analytics の開始時より後でないといけない\u003c/h2\u003e\n\n\u003cp\u003e次のページが参考になった。結局クエリを実行したが、０件だからデータが吐かれていなかったということが原因だった。現在のクエリはこれでモロ該当する\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"sql\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eWITH\u003c/span\u003e \u003cspan class=\"n\"\u003eSelectPreviousEvent\u003c/span\u003e \u003cspan class=\"k\"\u003eAS\u003c/span\u003e\n\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eTeamId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003eTimeStamp\u003c/span\u003e \u003cspan class=\"k\"\u003eAs\u003c/span\u003e \u003cspan class=\"nb\"\u003eTime\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"k\"\u003eCount\u003c/span\u003e\n\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edowntime\u003c/span\u003e \u003cspan class=\"nb\"\u003eTIMESTAMP\u003c/span\u003e \u003cspan class=\"k\"\u003eBY\u003c/span\u003e \u003cspan class=\"nb\"\u003eDate\u003c/span\u003e\n\u003cspan class=\"k\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"k\"\u003eBY\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eTeamId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eTumblingWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esecond\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e \n  \u003cspan class=\"n\"\u003eTeamId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003eTimestamp\u003c/span\u003e \u003cspan class=\"k\"\u003eAs\u003c/span\u003e \u003cspan class=\"nb\"\u003eTime\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eAs\u003c/span\u003e \u003cspan class=\"k\"\u003eCount\u003c/span\u003e\n\u003cspan class=\"k\"\u003eINTO\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ecosmosdb\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003eSelectPreviousEvent\u003c/span\u003e\n\u003cspan class=\"k\"\u003eGroup\u003c/span\u003e \u003cspan class=\"k\"\u003eBY\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eTeamId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eTumblingWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eminute\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"シンプルなクエリにして設定が正しいか確認する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AB%E3%81%97%E3%81%A6%E8%A8%AD%E5%AE%9A%E3%81%8C%E6%AD%A3%E3%81%97%E3%81%84%E3%81%8B%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eシンプルなクエリにして、設定が正しいか確認する\u003c/h3\u003e\n\n\u003cp\u003eこれはクエリを \u003ccode\u003eSELECT * INTO cosmosdb FROM downtime\u003c/code\u003e みたいな単純な全件検索にして気づいた。この場合問題なく全件がCosmosDB に書かれたということは、設定は間違っていない。 \u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/azure/stream-analytics/stream-analytics-troubleshooting-guide\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAzure Stream Analytics のトラブルシューティング ガイド\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e特に、\u003ccode\u003eTimestamp By\u003c/code\u003e を使用する場合は、イベントのタイムスタンプがジョブの開始時刻より後であることが必要です。また、Window 関数を使っているときに、 Window が終わっていなかったらデータが来ません。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"データの時刻が現在時刻とはずれすぎているとクエリーが動かない\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%99%82%E5%88%BB%E3%81%8C%E7%8F%BE%E5%9C%A8%E6%99%82%E5%88%BB%E3%81%A8%E3%81%AF%E3%81%9A%E3%82%8C%E3%81%99%E3%81%8E%E3%81%A6%E3%81%84%E3%82%8B%E3%81%A8%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%BC%E3%81%8C%E5%8B%95%E3%81%8B%E3%81%AA%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデータの時刻が現在時刻とはずれすぎているとクエリーが動かない\u003c/h3\u003e\n\n\u003cp\u003eこれはたぶん \u003ccode\u003eTimestamp By\u003c/code\u003e と思われるが、Stream Analytics 開始後であっても、タイムスタンプがデータが送られた時間と大幅にかけ離れていてもうまくクエリーできないみたいだ。\u003c/p\u003e\n\n\u003cp\u003e例えば、クエリー開始時間後の　5分、10分 15分　ぐらいのデータを一気に送信すると、5 分のデータは出力されたが、そのあとのは出力されなかった。このあたりの仕様はよくわからないし、ドキュメントでも見つけられないのでメーリングリストで聞くか、友人に聞いてみたい。(\u003cstrong\u003eTODO\u003c/strong\u003e) \u003c/p\u003e\n\n\u003cp\u003eつまり \u003cstrong\u003eほぼリアルタイムにデータを送信する必要がある\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"collection-を再作成するとoutput-を作成しなおす必要がある\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#collection-%E3%82%92%E5%86%8D%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E3%81%A8output-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%AA%E3%81%8A%E3%81%99%E5%BF%85%E8%A6%81%E3%81%8C%E3%81%82%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCollection を再作成すると、Output を作成しなおす必要がある\u003c/h3\u003e\n\n\u003cp\u003e最初は E2E テストを書いているときに、最初にアウトプットをするコレクションをクリアしたかったので、一旦コレクションを消して、作成するというオペレーションをしていた。すると、\u003ccode\u003eアクティビティログ\u003c/code\u003e で次のようなエラーに会う。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \"Message\": \"First Occurred: 06/22/2018 08:22:07 | Resource Name: cosmosdb | Message: There was a problem writing to CosmosDB db:[leaderboard], and collection:[DowntimeRecord]. \",\n        \"Type\": \"DiagnosticMessage\",\n\nもしくは\n\nSend Events: CosmosDB Output write Data failure\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eおそらく、アウトプットの設定時に、コネクションを始めているのかもしれない。だから、Stream Analytics の開始時点のコレクションがなくなったら書き込みができなくなるので、そういったことをしないのがポイント。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/af85f5a5a76a2ace86ff05ab48d493f4babeb23a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f64663636623035302d316234372d633331652d306165392d6333646232646263323030342e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fdf66b050-1b47-c31e-0ae9-c3db2dbc2004.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=eefa695ac4aad047f0d204e9e8df7b6e\" alt=\"Output.JPG\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/df66b050-1b47-c31e-0ae9-c3db2dbc2004.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fdf66b050-1b47-c31e-0ae9-c3db2dbc2004.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f1ccaf8b6095360086c25a31a391277f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"e2e-テストのノウハウ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#e2e-%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E3%83%8E%E3%82%A6%E3%83%8F%E3%82%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eE2E テストのノウハウ\u003c/h1\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"document-の全件削除は工夫が必要\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#document-%E3%81%AE%E5%85%A8%E4%BB%B6%E5%89%8A%E9%99%A4%E3%81%AF%E5%B7%A5%E5%A4%AB%E3%81%8C%E5%BF%85%E8%A6%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDocument の全件削除は工夫が必要\u003c/h3\u003e\n\n\u003cp\u003eコレクションを削除する代わりに、Document を全件削除するとよい。しかしこれが面倒だ。そいうったメソッドはないし、やろうとしたら、全件クエリーして、１件づつ削除なのだが、PartitionKey があるテーブルだと、それを設定しないといけない。Generic なメソッドを作ろうと思ったが、面倒になって、べたべたのコードを書いた。ここ以外で使うタイミングがないので、抽象化が割に合わない。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDowntimeRecord\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllDowntimeRecordAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIDocumentService\u003c/span\u003e \u003cspan class=\"n\"\u003eservice\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eteamId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eservice\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetClient\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003equery\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateDocumentQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDowntimeRecord\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eUriFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateDocumentCollectionUri\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"leaderboard\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"DowntimeRecord\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eteamid\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eteamId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAsEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003equery\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDowntimeRecord\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eDeleteAllDocuments\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIDocumentService\u003c/span\u003e \u003cspan class=\"n\"\u003eservice\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eteamId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eservice\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetClient\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003erecords\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllDowntimeRecordAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eservice\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eteamId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003erecord\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003erecords\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDeleteDocumentAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUriFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateDocumentUri\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"leaderboard\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDowntimeRecord\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erecord\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRequestOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003ePartitionKey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePartitionKey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eteamId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"現在時刻を使ったテストデータ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%8F%BE%E5%9C%A8%E6%99%82%E5%88%BB%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%83%86%E3%82%B9%E3%83%88%E3%83%87%E3%83%BC%E3%82%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e現在時刻を使ったテストデータ\u003c/h2\u003e\n\n\u003cp\u003e大変面倒だが、テストデータは、一気に投入できない。時間を必要とするパターンがある場合、該当の時間にデータを投入する必要がある。作戦としては、データパターンを作っておいて、そのデータパターンに現在時を入れて、その相対時間でテストデータを作るとよい。厳密にいうとタイミングによっては Fail して freaky なテストになるかもしれないが、発生するまではこれで。発生したら、もっとロジックで正しさを証明するように直すとよい。（例えば、Stream Analytics に期待するロジックをテストで書いておいて、インプットデータと、予想されるアウトプットを計算するロジックを書く。みなさんどうしているのだろう。もしもっといい方法があれば是非ご教授ください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetPatternSample\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003epatternNumber\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epatternNumber\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// Normal case failure\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01POI\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01POI\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01POI\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// Multiple service failure at the same time\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01POI\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01USER\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01USER\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"c1\"\u003e// Multiple teams failure at the same time\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01TRIP\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team02\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team02POI\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01TRIP\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team02\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team02POI\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n                \u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"c1\"\u003e// Multiple teams/services failure at the same time.\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01TRIP\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01POI\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team02\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team02POI\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team02\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team02USER\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team01\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team01TRIP\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))),\u003c/span\u003e\n                        \u003cspan class=\"nf\"\u003eGetFailureDowntimeReport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Team02\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Team02POI\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\n                    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://stackoverflow.com/questions/42907631/stream-analytics-and-stream-postion\" rel=\"nofollow noopener\" target=\"_blank\"\u003eStream Analytics and stream postion\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"デバッグ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデバッグ\u003c/h1\u003e\n\n\u003cp\u003eデバッグに関しては、クライアントは、VS のデバッグ機能でステップ実行するのが王道。また、Stream Analytics の場合、Metrics を見ると、Input はあるのに、Output がない（ということは、クエリーの結果０件）とかがわかる。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/0dc5a41e8ce27e9114d6b6d5564661e06a86222a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32316231353363352d646135392d353131652d363132332d3230653963363134306461322e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F21b153c5-da59-511e-6123-20e9c6140da2.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=fd81ca12802f4d2e85dd04dcc3e9771d\" alt=\"Metric.JPG\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/21b153c5-da59-511e-6123-20e9c6140da2.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F21b153c5-da59-511e-6123-20e9c6140da2.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f75a8ed9658f5a09cfe98d095e5b2250 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e他には アクティビティログはcosmosdbの接続問題を診断するのに役立った。、診断ログが設定できるので設定しておいたが、ストレージにイベントが吐かれているのがわかった。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"その他\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eその他\u003c/h1\u003e\n\n\u003cp\u003e小さな Tips だけど、上記にあるように、DateTime の演算をしたいときに、TimeSpan を渡せば演算できる\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003eこれで無事E2Eテストが実行されて動作が確認できた。次は Change Feed + CosmosDB Trigger を使って、最終的な集計を実施してそれも、E2Eテストに組み込んでみたい。\u003c/p\u003e\n\n\u003cp\u003eあと、これいい記事だった。Pluralsight は２時間半なので、ちゃんと見てみよう。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://blog.okazuki.jp/entry/2015/08/31/220406\" rel=\"nofollow noopener\" target=\"_blank\"\u003eStream Analytics入門してみた #azurejp\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://app.pluralsight.com/library/courses/azure-stream-analytics-understanding/table-of-contents\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnderstanding Azure Stream Analytics\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2018-06-22T15:23:29Z","elapsedYearsFromLastModifiedAt":3,"encryptedId":"C9hhLPHTs2oIrimWlQp13XrvZPGTEAYk--aO4N9dCTpN3PiFJK--FBCXvJuENxddc1kMUz9+kw==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2018-06-22T15:28:41Z","likesCount":3,"linkUrl":"https://qiita.com/TsuyoshiUshio@github/items/6560f7323db7044a3a49","organization":null,"originalId":660510,"stockedCount":0,"title":"EventHub -\u003e Stream Analytics -\u003e CosmosDB で E2E テストをしようとしてハマったこと","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C\"\u003e課題\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#eventhubs-%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA\"\u003eEventHubs のクライアントライブラリ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#net-standard-%E7%94%A8%E3%81%AE%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%82%92%E8%A6%8B%E3%82%8B\"\u003e.Net Standard 用のドキュメントを見る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#azure-functions-%E3%81%A7%E4%BD%BF%E3%81%86%E3%81%AA%E3%82%89extensions-%E3%82%92%E4%BD%BF%E3%81%86\"\u003eAzure Functions で使うなら、Extensions を使う\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#stream-analytics-%E3%81%AE%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%BC%E3%81%8B%E3%82%89%E5%87%BA%E5%8A%9B%E3%81%95%E3%82%8C%E3%81%9F%E7%B5%90%E6%9E%9C%E3%81%AE-json-%E3%81%8C%E5%B0%8F%E6%96%87%E5%AD%97%E3%81%AB%E3%81%AA%E3%82%8B\"\u003eStream Analytics のクエリーから出力された結果の JSON が小文字になる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#cosmosdb-%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E5%87%BA%E5%8A%9B%E3%81%95%E3%82%8C%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E5%8E%9F%E5%9B%A0\"\u003eCosmosDB にデータが出力されなかった原因\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#stream-analytics-%E3%82%92%E9%96%8B%E5%A7%8B%E3%81%97%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84\"\u003eStream Analytics を開始していない\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#timestamp--window-%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AE%E5%A0%B4%E5%90%88%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AFstream-analytics-%E3%81%AE%E9%96%8B%E5%A7%8B%E6%99%82%E3%82%88%E3%82%8A%E5%BE%8C%E3%81%A7%E3%81%AA%E3%81%84%E3%81%A8%E3%81%84%E3%81%91%E3%81%AA%E3%81%84\"\u003etimestamp / window を使ったクエリの場合、データはStream Analytics の開始時より後でないといけない\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AA%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AB%E3%81%97%E3%81%A6%E8%A8%AD%E5%AE%9A%E3%81%8C%E6%AD%A3%E3%81%97%E3%81%84%E3%81%8B%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B\"\u003eシンプルなクエリにして、設定が正しいか確認する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%99%82%E5%88%BB%E3%81%8C%E7%8F%BE%E5%9C%A8%E6%99%82%E5%88%BB%E3%81%A8%E3%81%AF%E3%81%9A%E3%82%8C%E3%81%99%E3%81%8E%E3%81%A6%E3%81%84%E3%82%8B%E3%81%A8%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%BC%E3%81%8C%E5%8B%95%E3%81%8B%E3%81%AA%E3%81%84\"\u003eデータの時刻が現在時刻とはずれすぎているとクエリーが動かない\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#collection-%E3%82%92%E5%86%8D%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E3%81%A8output-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%AA%E3%81%8A%E3%81%99%E5%BF%85%E8%A6%81%E3%81%8C%E3%81%82%E3%82%8B\"\u003eCollection を再作成すると、Output を作成しなおす必要がある\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#e2e-%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E3%83%8E%E3%82%A6%E3%83%8F%E3%82%A6\"\u003eE2E テストのノウハウ\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#document-%E3%81%AE%E5%85%A8%E4%BB%B6%E5%89%8A%E9%99%A4%E3%81%AF%E5%B7%A5%E5%A4%AB%E3%81%8C%E5%BF%85%E8%A6%81\"\u003eDocument の全件削除は工夫が必要\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%8F%BE%E5%9C%A8%E6%99%82%E5%88%BB%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E3%83%86%E3%82%B9%E3%83%88%E3%83%87%E3%83%BC%E3%82%BF\"\u003e現在時刻を使ったテストデータ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\"\u003eデバッグ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96\"\u003eその他\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\n","totalPv":1752,"uuid":"6560f7323db7044a3a49","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"U0O7sLue74vJUk/Qf34XHcUBwg==--iZ5JWrNuJsP62cP5--xp/CJDHjKRu6S1YcSvHdiw==","originalId":3470,"description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","facebookUrl":null,"githubUrl":"https://github.com/TsuyoshiUshio","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"Ushio Tsuyoshi","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=f09fda0ad182a04e6357e901c2c45fb7","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","urlName":"TsuyoshiUshio@github","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"StreamAnalytics","urlName":"streamanalytics"},{"name":"EventHubs","urlName":"eventhubs"},{"name":"CosmosDB","urlName":"cosmosdb"}],"followingLikers":{"edges":[]},"comments":{"totalCount":2}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
