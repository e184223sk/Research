More than 1 year has passed since last update.SwitchBotで何かできない？と上司に言われ「C#から操作できればHoloLensで遊べるんじゃね？(ﾋﾟｺｰﾝ」ってなったはいいけど、世の中に情報がなくて辛かったのでまとめ。
最初はWPFでやってたのですが、限界を感じてUWPでやりました。
WPF編はこちら　→　WPF（C#）でSwitchBot（BLEデバイス）を操作する - Qiita公式のコードがラズパイ向けなので、まずは動かしてみる。が、動かない。
iOSアプリでデバイスのMACは取れたのでBLEスキャンしてるあたりを適当にデバッグ。
結果的にこれをに直したら動いた。BLEで調べるとアドバタイズだのサービスだのキャラクタリスティックだのUUIDだの出てくる。
よくわからない。
とりあえずスキャンしてみる。addLogはデバッグ用のTextBoxに追記する関数。嵐のように出てくる。
あとUUIDが取れない。なんでやねん。なるほど。なるほど？
単なるスキャンでは基本的な情報しか取れず、詳細情報をデバイスにリクエストする必要があるらしい。（初期スキャンにUUIDが載ってくる場合もあるらしい）
ので追記。
MS公式曰く、消費電力が増えるらしいが、情報取れないんじゃ何もできないんだから仕方ない。あとﾄﾞﾊﾞﾄﾞﾊﾞ出てくるのが心臓に悪いのでフィルタ。複数回受信して、内容が変わっているのが分かる。
Advertising(解説) - BLE Docs
の通り、UUIDがType=07に入っている。
でもってデコード前のバイト列をPythonのコードと比べてみるとなので、Pythonのコードはデコード前のUUIDを期待してたっぽい。サービスを取って、キャラクタリスティックを取って、というのがお作法っぽいのでとりあえず全部取って羅列してみる。サービスは一種の名前空間みたいなもので、その中に個別のコマンド＝キャラクタリスティックが入っていると理解。ｷｭｲｯｷｭｲｯ
うごいたー！
複数のSwitchBotがあるとどれかがランダムで動きますｗ
実際には裏にマスタを持って指定するのがよいでしょう。途中、コマンドを間違えたらSwitchBotがただの箱になって焦ったが、蓋を開けてリセットボタンを押すことで復旧。（電池のON/OFFでもいいらしい）アプリからは長押し時間を変更できるが、このコマンドが公開されていない？
「押す」と「スイッチ」の切り替え、パスワード設定も同様。
設定できそうなのは'cba20002-224d-11e6-9fb8-0002a5d5c51b'だけなので、ここに何らかのバイト列を送ればいいと思われる。公式のソースでは、5種類のコマンドがあるが、今の所呼べるのは「Press」のみ。。。C#から呼べるのは確定したので、HoloLensでバーチャルボタンを押したら現実のボタンが押される、みたいなことをしたい。
ホームオートメーション的なIoTデバイスが増えているものの、GoogleHome連携やAlexa連携しかインタフェースが無いものが大半なので、BLEで直接コントロールできるというのは嬉しいですね！
できれば他のコマンドも公開して欲しいところですが。。。


