More than 1 year has passed since last update.現在、Caputraというデスクトップキャプチャソフトに、AviUtlを使っている人ならおなじみの可逆圧縮codecである、Ut Video Codec Suiteを対応させる試みを行っています。その過程で、codecの設定をわざわざレジストリをいじるのは面倒だし、設定画面とか呼べないの？と思ったのですね。例えばAviUtlなら

この設定ボタンから呼べる

こういうやつです。このウィンドウはAviUtlに固有のものではなくて他のソフトからも同じものが出るということは、Ut Video Codec Suite側で生成しているものだと推測できます。幸いなことにソースコードはGitHubで公開されているので読んでいきます。https://github.com/umezawatakeshi/utvideoするとそういえばVFW pluginだったなと思い出してきました。VfwというのはVideo for Windowsの略で、Win32API触ったことある人ならわかるであろう、プロージャーを書いてメッセージを受け取っていくタイプの書き方で、動画のエンコードやデコードなどなどを実装したdllを登録することで、いろいろなソフトウェアからそれが呼べる仕組みのことです。Windows Media Playerなんかはこれをつかって再生していたと思います。Windows 10標準搭載の動画アプリはMicrosoft Media Foundationという別のものを使っていますが。なんか検索してると某有名ゲームエンジンの関連のVexe Frameworkのほうが引っかかってくるようですが・・・。いろいろ読んでいくと、次のような箇所を見つけました。つまりICM_CONFIGUREを受け取ったプロージャーは、DialogBoxParamによってWindowを生成しているではないですか。つまりVfw codecに対してICM_CONFIGUREメッセージを投げられれば良さそうです。ただししかし、その前にpCodecとかm_modeとかいう変数が見えます。これらはどうやって初期化されているのでしょうか？変数の定義を見るだけでは、プロージャーの引数から渡ってくるんだなとしかわかりません。もう少し下を見るとDRV_CLOSEを受け取ったときに、pCodecをdeleteしているところが見つかりました。さらにその上にDRV_OPENというそれっぽいのがあります。CVCMCodec::Openを見てみましょう。細かいところは読み飛ばすとして、まずicmode = icopen-&gt;dwFlags;が目に入ります。さっき言ってた変数ですね！さらにこの関数はreturn new CVCMCodec(fccHandler, icmode);してます。確かにDRV_OPENとDRV_CLOSEは対応関係にあることがわかります。つまり、どうにかしてコーデックのプロージャーにメッセージを投げられればいいわけです。ただ、検索の仕方が悪くてなかなかたどり着けず、のソースコードを読み漁ってました。結局使う関数はの3つだとわかりました。ICOpenは次のようなプロトタイプ宣言で定義されています。fccというのが見えますが、これはFOURCCのことです。FourCC - Wikipedia
FourCC (フォーシーシー) とは、データフォーマットを一意に識別するための4バイトの並びである（four-character code の意）。fccTypeにはVIDCという文字列をFourCCとして整数に変換したもの、wModeには先に述べたようにICMODE_COMPRESSを渡すとして、fccHandlerには何を渡せばいいのでしょうか？今回はUt Video Codec Suiteの設定画面を呼びたいので、早速FourCCを調べましょう。といっても公式で
Ut Video Codec Suite 21.2.0 readme （日本語）FourCC 一覧
にまとめられているのでそれを見るだけですね。とりあえず今回はULH2にしましょう。親ウィンドウがないといけないので、雑にWPFで作りましょう。まずはこれで全世界の人がまずは表示させるであろう恒例のarikitari na world!を表示させて動いたことを確認したら本実装に入りましょう。vfw.hをみつつ必要なものを取ってきましょう。DLLを読まないと関数が呼べないので読み込んでおきましょう。あとはclickイベントハンドラを書き換えて設定画面を呼びましょう。FourCCの計算が面倒だったのでSharpAviをNuGetでプロジェクトに追加しておきます。実行する前に忘れずにUt Video Codec Suiteをインストールしておきましょう。或るプログラマの一生 » Ut Video Codec Suite無事に呼び出せました。FourCCとcodecの関連付けはレジストリで行われている。例えばUt Video Codec Suiteの場合、次のような項目が登録される。ではコーデックのあるFourCCを列挙するにはどうすればいいのか。レジストリを自分で読みたくはない。どうやらICInfoという関数を使えばいいようだ。使い方のサンプルが
Locating and Opening Compressors and Decompressors - Win32 apps | Microsoft Docs
にあった。


