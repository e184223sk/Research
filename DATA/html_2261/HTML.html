<!DOCTYPE html><html><head><meta charset="utf-8" /><title>追記型ストレージFasterLogについて - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/skitoy4321/items/6a20bc277bc424385cc7" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="+PIhJ3S9O7/Bf2vTpmxuSILOxfKGWcYPU1DvY7pkKQTHibx3RoU8Q5t/mks3kANdFxruBwhNBriqp1tbTCenqQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@skitoy4321" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="追記型ストレージFasterLogについて - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND02TC05NktpWTVaNkw0NEs1NDRPSTQ0T3M0NE84NDRLNFJtRnpkR1Z5VEc5bjQ0R3I0NEdrNDRHRTQ0R20mdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YWNlZDY5MmMyMzU0ZDM3Zjk2M2JkZThjOTcxOGQyOTI&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=a50d9ba7f7363646f87e150fe2e79f60"><meta property="og:description" content="

始めに

Microsoftは、ローカルで使えるストレージライブラリのFASTERというものを開発している。
このFASTER、最初はキーバリューストアであるFasterKVのみ提供していた。しかし、バージョン2019.10.31..."><meta content="https://qiita.com/skitoy4321/items/6a20bc277bc424385cc7" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,FASTER" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-c678038f-3fe5-41ef-8b35-553be03f12ac"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fskitoy4321%2Fitems%2F6a20bc277bc424385cc7">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fskitoy4321%2Fitems%2F6a20bc277bc424385cc7">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-c678038f-3fe5-41ef-8b35-553be03f12ac">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-11-12T20:20:09.000+09:00","dateModified":"2021-06-17T09:19:52.000+09:00","headline":"追記型ストレージFasterLogについて","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND02TC05NktpWTVaNkw0NEs1NDRPSTQ0T3M0NE84NDRLNFJtRnpkR1Z5VEc5bjQ0R3I0NEdrNDRHRTQ0R20mdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YWNlZDY5MmMyMzU0ZDM3Zjk2M2JkZThjOTcxOGQyOTI\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=a50d9ba7f7363646f87e150fe2e79f60","mainEntityOfPage":"https://qiita.com/skitoy4321/items/6a20bc277bc424385cc7","author":{"@type":"Person","address":"","email":null,"identifier":"skitoy4321","name":"skitoy4321","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","url":"https://qiita.com/skitoy4321","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">自己組織化されたユーザベースSaaS Product Teamが面白い理由</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"6a20bc277bc424385cc7"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"自己組織化されたユーザベースSaaS Product Teamが面白い理由","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"6a20bc277bc424385cc7"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"自己組織化されたユーザベースSaaS Product Teamが面白い理由","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"6a20bc277bc424385cc7"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"自己組織化されたユーザベースSaaS Product Teamが面白い理由","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/skitoy4321/items/6a20bc277bc424385cc7","location":"/skitoy4321/items/6a20bc277bc424385cc7","scheme":"https","host":"qiita.com","port":null,"pathname":"/skitoy4321/items/6a20bc277bc424385cc7","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"OAPW2PcNYqkLU21Llhca3DL7krE89wfSsv7RLRqJW98HeEuIxTVlVVFTnNMH63fJpy+5RLLjx2VLCWUV7MrVcg==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-29747686-43dd-46b6-9e9f-bbd9cf310319"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/6a20bc277bc424385cc7/likers" class="css-1iupg5d">23</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">16</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/6a20bc277bc424385cc7/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/6a20bc277bc424385cc7/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/6a20bc277bc424385cc7/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/6a20bc277bc424385cc7/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/6a20bc277bc424385cc7.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2019/c-sharp" class="it-AdcalRibbon_title">C#<!-- --> Advent Calendar<!-- --> <!-- -->2019</a>Day 12</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/skitoy4321"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/skitoy4321" class="css-10ougpm">@<!-- -->skitoy4321</a><div class="css-1ay9vb9"><span><meta content="2019-11-12T11:20:09Z"/><time dateTime="2021-06-17T00:19:52Z" class="css-m19uds">updated at 2021-06-17</time></span></div></div></div></div></div><h1 class="css-cgzq40">追記型ストレージFasterLogについて</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/faster" class="css-4czcte">FASTER</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="始めに" class="fragment"></span><a href="#%E5%A7%8B%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>始めに</h1>

<p>Microsoftは、ローカルで使えるストレージライブラリの<a href="https://github.com/microsoft/FASTER" rel="nofollow noopener" target="_blank">FASTER</a>というものを開発している。<br>
このFASTER、最初はキーバリューストアであるFasterKVのみ提供していた。しかし、バージョン2019.10.31.1より、FasterLogという、データの追記に特化した機能が追加された。<br>
少し触ってみると、今自分が実現したい機能を丁度良くカバーしてそうなので、使い方や注意点を書いておく。</p>

<p>FasterKVは論文も発表されているので、特徴や理論的な裏付け等が知りたければそちらも参照のこと。</p>

<ul>
<li><a href="https://www.microsoft.com/en-us/research/uploads/prod/2018/03/faster-sigmod18.pdf" rel="nofollow noopener" target="_blank">論文(PDF)</a></li>
<li><a href="https://scrapbox.io/nikezono/FASTER" rel="nofollow noopener" target="_blank">日本語解説</a></li>
</ul>

<p>今回紹介するFasterLogは、FasterKVで使用しているストレージ機能のベース部分を利用した、追記と範囲検索に特化したものとなる。</p>

<p>なお、FasterLogは今もなおインターフェイスの更新が行われており、この記事で書かれていることと微妙に差異があるかもしれないので注意が必要。<br>
この記事では1.9.5をベースに解説を行う。</p>

<h1>
<span id="特徴" class="fragment"></span><a href="#%E7%89%B9%E5%BE%B4"><i class="fa fa-link"></i></a>特徴</h1>

<ul>
<li>データはディスクに保存される

<ul>
<li>ドライバを書けばローカルディスク以外にも対応可能

<ul>
<li>例: <a href="https://www.nuget.org/packages/Microsoft.FASTER.Devices.AzureStorage/" rel="nofollow noopener" target="_blank">Azure Blobをストレージとして使うライブラリ</a>
</li>
</ul>
</li>
</ul>
</li>
<li>扱えるデータ型はバイト配列のみ</li>
<li>以下の操作が可能

<ul>
<li>追記</li>
<li>データの範囲検索</li>
<li>過去のある時点までのレコード削除</li>
</ul>
</li>
<li>特定レコードの削除は不可</li>
<li>途中にデータを挿入することは不可</li>
</ul>

<h1>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h1>

<h2>
<span id="プロジェクトへの導入" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%B8%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>プロジェクトへの導入</h2>

<p>普通に<a href="https://www.nuget.org/packages/Microsoft.FASTER.Core/" rel="nofollow noopener" target="_blank">nugetパッケージ</a>として公開されているので、PackageReference等で追加すればOK。</p>

<p>他に、<a href="https://www.nuget.org/packages/Microsoft.FASTER.Server/" rel="nofollow noopener" target="_blank">Microsoft.FASTER.Server</a>や、<a href="https://www.nuget.org/packages/Microsoft.FASTER.Client/" rel="nofollow noopener" target="_blank">Microsoft.FASTER.Client</a>も存在するが、これは <a href="https://microsoft.github.io/FASTER/docs/remote-basics/" rel="nofollow noopener" target="_blank">FasterKVをクライアントサーバー形式で利用したい場合に使うフレームワーク</a> なので、今回は導入しない。</p>

<h2>
<span id="ストレージデバイスインスタンスを作成する" class="fragment"></span><a href="#%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ストレージデバイスインスタンスを作成する</h2>

<p>まず、以下のコードでログを格納するディスク領域を作成する。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="c1">// using FASTER.core;</span>
<span class="c1">// 独自ストレージを使用する場合、FASTER.core.IDeviceを実装したインスタンスを代わりに生成する</span>
<span class="c1">// ファイルパスのみ必須。</span>
<span class="c1">// 基本的に同じフォルダに複数ファイルを作る設計なので、複数のログファイルを扱いたい場合、別フォルダに分けるのが良い</span>
<span class="n">IDevice</span> <span class="n">logDevice</span> <span class="p">=</span> <span class="n">Devices</span><span class="p">.</span><span class="nf">CreateLogDevice</span><span class="p">(</span><span class="s">"[格納するファイルのパス]"</span><span class="p">);</span>
</code></pre></div></div>

<p>なお、<code>deleteOnClose</code>というオプション引数が使用可能だが、これを使用すると、後でデータを開こうとした時に挙動がおかしくなるので、検証またはテスト目的以外では設定しないこと。<br>
また、オプション引数で<code>preallocateFile=true</code>とすると、後でFasterLogを生成する時に最初から<code>2^SegmentSizeBits</code>のファイルを確保してから、そこに書き込むという動作になる。<br>
パフォーマンスを重視する場合はtrueにするのも手だが、その場合突然大きなファイルが作成されることになるため、注意が必要となる。</p>

<p>ここで生成した<code>IDevice</code>は、必ずプログラム終了時に<code>logDevice.Dispose()</code>するか、または<code>using</code>で囲むこと。</p>

<p>他のIDeviceの実装として、<code>LocalMemoryDevice</code>というものもあるが、<a href="https://github.com/microsoft/FASTER/blob/a31b52b29e952827b4ad464674df57d9e230020a/cs/src/core/Device/LocalMemoryDevice.cs#L46-L78" rel="nofollow noopener" target="_blank">コンストラクタにConsole.Write等が仕込まれている</a>等、テスト目的で作ったような印象なので、リファレンス実装あるいはテストのためのデバイスと思った方が良い。</p>

<p>また、<a href="https://www.nuget.org/packages/Microsoft.FASTER.Devices.AzureStorage/" rel="nofollow noopener" target="_blank">Azure Storage(page blob)を使うIDeviceの実装もある</a>。ただし、こちらの性能等は未検証</p>

<h2>
<span id="fasterlogインスタンスを生成する" class="fragment"></span><a href="#fasterlog%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>FasterLogインスタンスを生成する</h2>

<p>ストレージデバイスインスタンスを生成したら、以下のようにして、FasterLogインスタンスを生成する。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="c1">// using FASTER.core;</span>
<span class="c1">// LogDeviceのみ必須</span>
<span class="kt">var</span> <span class="n">fls</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FasterLogSettings</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">LogDevice</span> <span class="p">=</span> <span class="n">logDevice</span>
<span class="p">};</span>
<span class="k">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">fl</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FasterLog</span><span class="p">(</span><span class="n">fls</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// 処理</span>
    <span class="c1">// flインスタンスはプロセス内で使い回すこと</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="fasterlogsettingsのその他項目について" class="fragment"></span><a href="#fasterlogsettings%E3%81%AE%E3%81%9D%E3%81%AE%E4%BB%96%E9%A0%85%E7%9B%AE%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>FasterLogSettingsのその他項目について</h3>

<p>FasterLogSettingsのその他項目は以下のようになる。</p>

<ul>
<li>PageSizeBits

<ul>
<li>格納データページの基本単位</li>
<li>各レコードは、メタデータと実データが必ず同じページに収まるように格納される

<ul>
<li>つまり、一レコード当たりの最大サイズがこの値に依存して決定される</li>
<li>ファイルの空間効率にも影響するので、サイズ設定は慎重に</li>
</ul>
</li>
<li>単位は<strong>何ビット使用するか</strong>なので、例えば8を指定したら<code>2^8 = 256(bytes)</code>となる</li>
<li>初期値は22(<code>2^22 ≒ 4MB</code>)</li>
</ul>
</li>
<li>MemorySizeBits

<ul>
<li>オンメモリに乗せる最大データ容量</li>
<li>単位はPageSizeBitsと同じ</li>
<li>初期値は23(<code>2^23 ≒ 8MB</code>)</li>
<li>最低でもPageSizeBits+1必要で、下回るとFasterLogインスタンス生成時にエラーが出る</li>
</ul>
</li>
<li>SegmentSizeBits

<ul>
<li>オンメモリに乗らないデータを格納するファイルのサイズ</li>
<li>初期値は30(=1GB)</li>
</ul>
</li>
<li>LogCommitManager

<ul>
<li>トランザクションを管理する</li>
<li>リカバリ等も担当</li>
<li>以前は <a href="https://github.com/microsoft/FASTER/blob/v1.9.5/cs/src/core/Index/FasterLog/LocalLogCommitManager.cs" rel="nofollow noopener" target="_blank">LocalLogCommitManager</a> がデフォルトだったが、今は <a href="https://github.com/microsoft/FASTER/blob/v1.9.5/cs/src/core/Index/CheckpointManagement/DeviceLogCommitCheckpointManager.cs" rel="nofollow noopener" target="_blank">DeviceLogCommitCheckpointManager</a> が使われている(旧来のバージョンを使うことも可能)</li>
</ul>
</li>
<li>LogCommitFile

<ul>
<li><strong>1.9.5時点では使われていない</strong></li>
<li>出力先を変えたい場合、LogCommitManagerのインスタンスを作る必要がある</li>
</ul>
</li>
<li>GetMemory

<ul>
<li>データ読出しの時に呼ばれるコールバック関数</li>
</ul>
</li>
<li>LogChecksum

<ul>
<li>ログ整合性のためのチェックサムをどのように追加するか</li>
<li>ファイルが壊れた場合に検知ができるため、データの重要度に応じてオンにしておく</li>
<li><a href="https://github.com/microsoft/FASTER/blob/ff51d3c973634d043df08cd79e6ba5a0e1ffa6c1/cs/src/core/Index/FasterLog/FasterLog.cs#L1001-L1014" rel="nofollow noopener" target="_blank">本体データ+メタデータのXORを集計しているため、オーバーヘッドはそれなりに大きいと思われる</a></li>
<li>None=チェックサム追加をしない、PerEntry=レコードごとにチェックサムを取得する</li>
<li>デフォルト=None</li>
</ul>
</li>
</ul>

<h3>
<span id="生成されるファイル" class="fragment"></span><a href="#%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>生成されるファイル</h3>

<p>FasterLogをnewした時点で、以下のファイルが生成される</p>

<ul>
<li>ログセグメントデータ: <code>[CreateLogDeviceで指定したファイル].[0始まり数字]</code>

<ul>
<li>データ本体が格納される</li>
<li>
<code>preallocateFile=true</code>の場合、<code>2^[SegmentSizeBits]</code>bytesのサイズをアロケートしようとするので注意(デフォルト1GB)</li>
<li>ログデータが<code>2^[SegmentSizeBits]</code>を超えるたびに、新しくセグメントファイルを作成する</li>
</ul>
</li>
<li>トランザクションファイル: デフォルトは <code>log-commits/commit.0.0</code>

<ul>
<li>論理的なアドレスの開始点、終点が書き込まれる</li>
<li>サイズは概ね一定</li>
<li>複数のログデータで共有するとおかしなことになるので、同じディレクトリに複数ログデータを作成する場合は、デフォルト値から変更した方が良い</li>
<li>DeviceLogCommitCheckpointManager を作る場合、<code>log-commits</code>ディレクトリのベースパスを指定することができる</li>
</ul>
</li>
</ul>

<h2>
<span id="データを追加する" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>データを追加する</h2>

<p>データの追加は以下のように行う</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="c1">// FasterLog fl;</span>
<span class="c1">// byte[] data;</span>
<span class="c1">// ReadOnlySpan&lt;byte&gt;でも可</span>
<span class="c1">// Enqueueの時点ではまだ永続化はされない</span>
<span class="kt">long</span> <span class="n">recordAddress</span> <span class="p">=</span> <span class="n">fl</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="c1">// ここで返ってくるaddress値は、WaitForCommit系のAPIでuntilAddressとして使用する</span>
<span class="c1">// コミットデータの永続化</span>
<span class="n">fl</span><span class="p">.</span><span class="nf">Commit</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</code></pre></div></div>

<p><code>Commit</code>した時点でディスクに書き出される。<br>
戻り値として、追加したデータの論理アドレスが取得できる。</p>

<p>例ではEnqueueを使用したが、これは内部的にEnqueueを成功するまで繰り返すという挙動のため、タイミングが悪いと時間がかかる場合もある。<br>
一定回数追加を試みて、だめならエラーを出すか後でやり直すという挙動をしたい場合、<code>bool FasterLog.TryEnqueue(byte[] data, out var logicalAddress)</code>というAPIを使用する。<br>
<a href="https://github.com/microsoft/FASTER/blob/32b3f6e40aa500a11cc2f92f7df8ded5345c1d61/cs/src/core/Index/FasterLog/FasterLog.cs#L228-L234" rel="nofollow noopener" target="_blank">Enqueueも実は内部的にTryEnqueueを使っている</a>。</p>

<h2>
<span id="データを読み出す" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%AD%E3%81%BF%E5%87%BA%E3%81%99"><i class="fa fa-link"></i></a>データを読み出す</h2>

<p>データの読み出しは、C#8.0とそれより前でやり方が異なる。</p>

<h3>
<span id="共通事項" class="fragment"></span><a href="#%E5%85%B1%E9%80%9A%E4%BA%8B%E9%A0%85"><i class="fa fa-link"></i></a>共通事項</h3>

<p>下記のように、<code>FasterLog.Scan([開始アドレス], [終端アドレス])</code>を使用する。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="c1">// FasterLog fl;</span>
<span class="c1">// fl.Scan([論理開始アドレス], [論理終端アドレス])という風にして指定する</span>
<span class="k">using</span><span class="p">(</span><span class="n">FastLogScanIterator</span> <span class="n">iter</span> <span class="p">=</span> <span class="n">fl</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="n">fl</span><span class="p">.</span><span class="n">CommittedBeginAddress</span><span class="p">,</span> <span class="n">fl</span><span class="p">.</span><span class="n">CommittedUntilAddress</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// enumeratorで走査</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ここでいう開始アドレスと終端は、コミット済みの全てのログを見るなら<code>FasterLog.CommittedBeginAddress</code>と<code>FasterLog.CommittedUntilAddress</code>をそれぞれ指定すると良い。<br>
全てのログを見たくない場合は、終端アドレスに、<code>[開始アドレス] + [適当なバイト数]</code>を指定する。</p>

<p>走査中に、現在見ているログの論理アドレスを知りたい場合は、<code>FastLogScanIterator.CurrentAddress</code>、次のエントリのアドレスを知る場合は、<code>FastLogScanIterator.NextAddress</code>を使用する。</p>

<h3>
<span id="非同期c80" class="fragment"></span><a href="#%E9%9D%9E%E5%90%8C%E6%9C%9Fc80"><i class="fa fa-link"></i></a>非同期(C#8.0)</h3>

<p><code>IAsyncEnumerable</code>を使用する。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="c1">// FasterLog fl;</span>
<span class="c1">// fl.Scan([論理開始アドレス], [論理終端アドレス])という風にして指定する</span>
<span class="k">using</span><span class="p">(</span><span class="n">FastLogScanIterator</span> <span class="n">iter</span> <span class="p">=</span> <span class="n">fl</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="n">fl</span><span class="p">.</span><span class="n">CommittedBeginAddress</span><span class="p">,</span> <span class="n">fl</span><span class="p">.</span><span class="n">CommittedUntilAddress</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// dataの型はbyte[]</span>
    <span class="c1">// lenはデータ長(bytes)</span>
    <span class="c1">// 2019.11.18では二つだけだが、最新ソースでは更に long currentAddress も追加になる模様</span>
    <span class="c1">// https://github.com/microsoft/FASTER/commit/bf657635374873958d96b31db1299b58ef9a17b1</span>
    <span class="k">await</span> <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">currentAddress</span><span class="p">,</span> <span class="n">nextAddress</span><span class="p">)</span> <span class="k">in</span> <span class="n">iter</span><span class="p">.</span><span class="nf">GetAsyncEnumerable</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="c1">// データの参照</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code>FastLogScanIterator.GetAsyncEnumerable(CancellationToken ct = default)</code>では、foreachの要素に単純にnewされた<code>byte[]</code>を受け取るが、代わりに<code>System.Buffers.MemoryPool&lt;byte&gt;</code>のインスタンスを渡すと、メモリプール経由でバッファの確保を行うため、アロケーションが減らせる。<br>
ただし、<code>IMemoryOwner&lt;byte&gt;</code>自体のアロケーションは避けられないため、ゼロではない。<br>
また、使い終わった<code>IMemoryOwner&lt;byte&gt;</code>はDisposeを行わないと、メモリリークの原因になる。</p>

<h3>
<span id="非同期c7x以前" class="fragment"></span><a href="#%E9%9D%9E%E5%90%8C%E6%9C%9Fc7x%E4%BB%A5%E5%89%8D"><i class="fa fa-link"></i></a>非同期(C#7.x以前)</h3>

<p><code>FastLogScanIterator.[GetNext,NextAddress,WaitAsync]</code>等を駆使する</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="c1">// FasterLog fl;</span>
<span class="k">using</span><span class="p">(</span><span class="n">FastLogScanIterator</span> <span class="n">iter</span> <span class="p">=</span> <span class="n">fl</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="n">fl</span><span class="p">.</span><span class="n">CommittedBeginAddress</span><span class="p">,</span> <span class="n">fl</span><span class="p">.</span><span class="n">CommittedUntilAddress</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// 終端ではnextAddressが-1になる</span>
    <span class="k">while</span><span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="n">NextAddress</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">iter</span><span class="p">.</span><span class="nf">WaitAsync</span><span class="p">();</span>
        <span class="c1">// データを取り出すまでループと待機を行う</span>
        <span class="c1">// 引数は、データ本体、データ長、現在のアドレスの三つ</span>
        <span class="k">while</span><span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="nf">GetNext</span><span class="p">(</span><span class="k">out</span> <span class="kt">var</span> <span class="n">entry</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">length</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">currentAddress</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">nextAddress</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">// データの参照</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="データの削除" class="fragment"></span><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%89%8A%E9%99%A4"><i class="fa fa-link"></i></a>データの削除</h2>

<p>データの削除には、<code>FasterLog.TruncateUntil(long untilAddress)</code>または<code>FasterLog.TruncateUntilPageStart(long untilAddress)</code>を使用する。</p>

<h3>
<span id="truncateuntil" class="fragment"></span><a href="#truncateuntil"><i class="fa fa-link"></i></a>TruncateUntil</h3>

<p><code>TruncateUntil</code>は<strong>データの開始アドレス(BeginAddress)から、指定されたアドレス直前までのデータを削除する</strong>という挙動である。<br>
注意点として、<strong>レコード境界ではない中途半端なアドレスを指定すると、次回のScan時にエラーが出る</strong>という仕様がある。</p>

<ul>
<li><a href="https://github.com/microsoft/FASTER/issues/191#issuecomment-548833464" rel="nofollow noopener" target="_blank">関連github issue</a></li>
</ul>

<p>回避するには、末尾アドレス(FasterLog.TailAddress)を指定するか、下記のようにScanの途中で得たNextAddressで、正確なレコード境界を取得して指定するというやり方がある</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="c1">// FasterLog fl;</span>
<span class="kt">long</span> <span class="n">untilAddress</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="k">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">iter</span> <span class="p">=</span> <span class="n">fl</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="n">fl</span><span class="p">.</span><span class="n">BeginAddress</span><span class="p">,</span> <span class="p">[</span><span class="err">終端</span><span class="p">]))</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">x</span> <span class="k">in</span> <span class="n">iter</span><span class="p">.</span><span class="nf">GetAsyncEnumerable</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="c1">// 処理</span>
        <span class="n">untilAddress</span> <span class="p">=</span> <span class="n">iter</span><span class="p">.</span><span class="n">NextAddress</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">fl</span><span class="p">.</span><span class="nf">TruncateUntil</span><span class="p">(</span><span class="n">untilAddress</span><span class="p">);</span>
<span class="c1">// 最後にCommitすると変更が反映される</span>
<span class="n">fl</span><span class="p">.</span><span class="nf">Commit</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</code></pre></div></div>

<p>より安全に、かつ大雑把に消したい場合は、後述の<code>TruncateUntilPageStart</code>を使用する</p>

<h3>
<span id="truncateuntilpagestart" class="fragment"></span><a href="#truncateuntilpagestart"><i class="fa fa-link"></i></a>TruncateUntilPageStart</h3>

<p><code>TruncateUntilPageStart</code>は<strong>データの開始アドレスから、指定されたアドレスに紐づくページの直前までを消去する</strong>という挙動である。<br>
レコードはページをまたぐことは仕様上ないため、<code>TruncateUntil</code>で起こったような問題は起きない。<br>
ただし、正確な消去はできないため、大雑把にログローテーション等をしたい場合に使うと良いだろう</p>

<h1>
<span id="パフォーマンス上の注意点" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>パフォーマンス上の注意点</h1>

<p>追記、削除する時は、操作後にコミットを行い永続化する必要があるが、コミットはFasterLogの中で最もコストのかかる処理だという事を念頭に置いた方が良い。しかし、コミットしないとデータが永続化されないので、信頼性が下がる。悩ましいところである。<br>
つまり、より高速にデータを処理したい場合は、<strong>信頼性を下げずにいかにコミット回数を減らすか</strong>ということを考える。</p>

<p>ではどうすればいいか。以下のようなやり方を一例として示そうと思う。</p>

<h2>
<span id="commitタスクを独立させる" class="fragment"></span><a href="#commit%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%92%E7%8B%AC%E7%AB%8B%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>Commitタスクを独立させる</h2>

<p>箇条書きにすると以下のような動作になる</p>

<ul>
<li>追記タスクを並列化する</li>
<li>追記タスクは、自分の書き込みが完了するまでWaitForCommitAsyncで待機する

<ul>
<li>要件による</li>
</ul>
</li>
<li>追加で、一つだけひたすらコミットだけするタスクを作成する</li>
<li>追記タスクは、コミットタスクに自分が追記したレコードのアドレスを渡す</li>
<li>コミットタスクは、現在のコミット済み終端アドレスと受け取ったレコードアドレスを比較して、未コミットと判断したら、コミットを行う</li>
</ul>

<p>タスク間のデータ受け渡しは、<code>System.Threading.Channels</code>が使えると思う。</p>

<h3>
<span id="追加されたデータが永続化されるまで待機する" class="fragment"></span><a href="#%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E6%B0%B8%E7%B6%9A%E5%8C%96%E3%81%95%E3%82%8C%E3%82%8B%E3%81%BE%E3%81%A7%E5%BE%85%E6%A9%9F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>追加されたデータが永続化されるまで待機する</h3>

<p>さて、このやり方では、追記とコミットが別タスクで行われる状態になる。しかし、要件によっては、データ消失を可能な限り避けるため、自分で追加したデータが、確実に永続化されたかどうか確認する必要が出てくる。<br>
そこで、<code>FasterLog.WaitForCommitAsync(long address, CancellationToken ct)</code>を使用する。<br>
引数には<code>FasterLog.Enqueue</code>で得たアドレスを指定する。<br>
これを使うと、指定されたアドレスがコミットされたと判断されるまで(<code>address &lt;= CommittedUntilAddress</code>になるまで)待機が発生する。</p>

<h3>
<span id="コード例" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B"><i class="fa fa-link"></i></a>コード例</h3>

<p>具体的には、少々長くなるが以下のようなコードになる。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Channels</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">FASTER.core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">fasterlabs</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">class</span> <span class="nc">FasterLogCommitTest</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="kt">long</span> <span class="nf">EnqueueData</span><span class="p">(</span><span class="kt">long</span> <span class="k">value</span><span class="p">,</span> <span class="n">FasterLog</span> <span class="n">fl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Span</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;</span> <span class="n">data</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">long</span><span class="p">[</span><span class="m">1</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="p">.</span><span class="nf">TryEnqueue</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">InteropServices</span><span class="p">.</span><span class="n">MemoryMarshal</span><span class="p">.</span><span class="nf">AsBytes</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">logicalAddress</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">logicalAddress</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">ValueTask</span> <span class="nf">DoTest</span><span class="p">(</span><span class="kt">int</span> <span class="n">TaskNum</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="kt">long</span> <span class="n">TotalCount</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>
            <span class="c1">// ensure using cleared data </span>
            <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="s">"logcommittest.log.0"</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">File</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="s">"logcommittest.log.0"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="s">"log-commits"</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Directory</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="s">"log-commits"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="kt">var</span> <span class="n">log</span> <span class="p">=</span> <span class="n">Devices</span><span class="p">.</span><span class="nf">CreateLogDevice</span><span class="p">(</span><span class="s">"logcommittest.log"</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">channel</span> <span class="p">=</span> <span class="n">Channel</span><span class="p">.</span><span class="n">CreateUnbounded</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;();</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fl</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FasterLog</span><span class="p">(</span><span class="k">new</span> <span class="nf">FasterLogSettings</span><span class="p">()</span> <span class="p">{</span> <span class="n">LogDevice</span> <span class="p">=</span> <span class="n">log</span> <span class="p">}))</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">sw</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="nf">Stopwatch</span><span class="p">();</span>
                <span class="n">sw</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
                <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">csrc</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">(</span><span class="m">1000</span> <span class="p">*</span> <span class="m">240</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span>
                        <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">TaskNum</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="k">async</span> <span class="n">idx</span> <span class="p">=&gt;</span>
                        <span class="p">{</span>
                            <span class="c1">// データを追加するタスク</span>
                            <span class="kt">long</span> <span class="n">logicalAddress</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                            <span class="k">try</span>
                            <span class="p">{</span>
                                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">TotalCount</span> <span class="p">/</span> <span class="n">TaskNum</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                                <span class="p">{</span>
                                    <span class="n">logicalAddress</span> <span class="p">=</span> <span class="nf">EnqueueData</span><span class="p">(</span><span class="n">i</span> <span class="p">+</span> <span class="n">idx</span> <span class="p">*</span> <span class="n">TotalCount</span><span class="p">,</span> <span class="n">fl</span><span class="p">);</span>
                                    <span class="k">await</span> <span class="n">channel</span><span class="p">.</span><span class="n">Writer</span><span class="p">.</span><span class="nf">WriteAsync</span><span class="p">(</span><span class="n">logicalAddress</span><span class="p">,</span> <span class="n">csrc</span><span class="p">.</span><span class="n">Token</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
                                    <span class="k">await</span> <span class="n">fl</span><span class="p">.</span><span class="nf">WaitForCommitAsync</span><span class="p">(</span><span class="n">logicalAddress</span><span class="p">,</span> <span class="n">csrc</span><span class="p">.</span><span class="n">Token</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
                                    <span class="c1">// Console.WriteLine($"{idx}, {i}, {logicalAddress}");</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"producer error(</span><span class="p">{</span><span class="n">idx</span><span class="p">}</span><span class="s">, </span><span class="p">{</span><span class="n">logicalAddress</span><span class="p">}</span><span class="s">, </span><span class="p">{</span><span class="n">fl</span><span class="p">.</span><span class="n">CommittedUntilAddress</span><span class="p">}</span><span class="s">, </span><span class="p">{</span><span class="n">fl</span><span class="p">.</span><span class="n">TailAddress</span><span class="p">}</span><span class="s">): </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="c1">// Console.WriteLine($"exit producer({idx}, {sw.Elapsed})");</span>
                        <span class="p">})).</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">channel</span><span class="p">.</span><span class="n">Writer</span><span class="p">.</span><span class="nf">Complete</span><span class="p">()),</span>
                        <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
                        <span class="p">{</span>
                            <span class="c1">// コミットする方のタスク</span>
                            <span class="kt">int</span> <span class="n">commitCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                            <span class="k">try</span>
                            <span class="p">{</span>
                                <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
                                <span class="p">{</span>
                                    <span class="k">if</span> <span class="p">(!</span><span class="k">await</span> <span class="n">channel</span><span class="p">.</span><span class="n">Reader</span><span class="p">.</span><span class="nf">WaitToReadAsync</span><span class="p">(</span><span class="n">csrc</span><span class="p">.</span><span class="n">Token</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">))</span>
                                    <span class="p">{</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="p">}</span>
                                    <span class="k">while</span> <span class="p">(</span><span class="n">channel</span><span class="p">.</span><span class="n">Reader</span><span class="p">.</span><span class="nf">TryRead</span><span class="p">(</span><span class="k">out</span> <span class="kt">var</span> <span class="n">untiladdr</span><span class="p">))</span>
                                    <span class="p">{</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="p">.</span><span class="n">CommittedUntilAddress</span> <span class="p">!=</span> <span class="n">fl</span><span class="p">.</span><span class="n">TailAddress</span><span class="p">)</span>
                                        <span class="p">{</span>
                                            <span class="n">fl</span><span class="p">.</span><span class="nf">Commit</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
                                            <span class="c1">// await fl.CommitAsync(csrc.Token).ConfigureAwait(false);</span>
                                            <span class="n">commitCount</span><span class="p">++;</span>
                                        <span class="p">}</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"consumer error:</span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"exit consumer(</span><span class="p">{</span><span class="n">commitCount</span><span class="p">}</span><span class="s">)"</span><span class="p">);</span>
                        <span class="p">}).</span><span class="nf">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span>
                        <span class="p">{</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">fl</span><span class="p">.</span><span class="n">CommittedUntilAddress</span> <span class="p">!=</span> <span class="n">fl</span><span class="p">.</span><span class="n">TailAddress</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"last commit"</span><span class="p">);</span>
                                <span class="n">fl</span><span class="p">.</span><span class="nf">Commit</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">})</span>
                    <span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
                    <span class="n">sw</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Multi(</span><span class="p">{</span><span class="n">TotalCount</span><span class="p">}</span><span class="s">, </span><span class="p">{</span><span class="n">TaskNum</span><span class="p">}</span><span class="s">): </span><span class="p">{</span><span class="n">sw</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">}</span><span class="s">, iops = </span><span class="p">{(</span><span class="n">TotalCount</span> <span class="p">*</span> <span class="m">1000</span><span class="p">)</span> <span class="p">/</span> <span class="n">sw</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">log</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>バージョン2019.11.18.1より前のバージョンでは、<code>CommitAsync</code>すると<code>WaitForCommitAsync</code>とスレッドプールの消費が競合して、デッドロック状態になる場合があるので注意すること。(<a href="https://github.com/microsoft/FASTER/issues/199" rel="nofollow noopener" target="_blank">該当github issue</a>)</p>

<h1>
<span id="終りに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終りに</h1>

<p>今回はログ向けストレージ機能を持つFasterLogを紹介した。実際制約もあるので、あらゆる場面で使用できるわけではないが、それでも他には無い特徴を持っているため、役に立つ場面では役に立つと思われる。<br>
機会があれば、コミット回数や並列数を変えて性能テスト等を行ってみたい。</p>

<p>また、データ検索についてはComplete周り等、もう少し掘り下げられそうな所があるので、別記事にするか、あるいはこの記事に追記したい。</p>

<h2>
<span id="参考リンク" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF"><i class="fa fa-link"></i></a>参考リンク</h2>

<ul>
<li><a href="https://github.com/microsoft/FASTER" rel="nofollow noopener" target="_blank">githubプロジェクトページ</a></li>
<li><a href="https://microsoft.github.io/FASTER/" rel="nofollow noopener" target="_blank">github.ioページ</a></li>
<li><a href="https://www.microsoft.com/en-us/research/project/FASTER/" rel="nofollow noopener" target="_blank">MSによる調査報告ページ</a></li>
<li><a href="https://scrapbox.io/nikezono/FASTER" rel="nofollow noopener" target="_blank">FasterKV論文についての日本語解説</a></li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2F6a20bc277bc424385cc7&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2F6a20bc277bc424385cc7&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/6a20bc277bc424385cc7/likers" class="css-1iupg5d">23</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">16</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/6a20bc277bc424385cc7/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/6a20bc277bc424385cc7/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/6a20bc277bc424385cc7/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/6a20bc277bc424385cc7/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/6a20bc277bc424385cc7.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-29747686-43dd-46b6-9e9f-bbd9cf310319">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-721ce032-9524-41b9-882c-87287f466e61"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-721ce032-9524-41b9-882c-87287f466e61">{}</script>
      
<div id="LoginModal-react-component-51fe6eab-3117-413d-b473-05eab6ae6b78"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-51fe6eab-3117-413d-b473-05eab6ae6b78">{}</script>
      
<div id="StockModal-react-component-ac25184f-f1e0-4f0c-973e-f6af49c88ceb"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-ac25184f-f1e0-4f0c-973e-f6af49c88ceb">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;xrRNiLwmyEqvTZIz+x3EvgeQ/vZ5tmOAUhjEz3ErhSD5z9DYjh7PtvVNY6tq4amrkkTVA/eiozer73D3h2gLjQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"始めに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A7%8B%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e始めに\u003c/h1\u003e\n\n\u003cp\u003eMicrosoftは、ローカルで使えるストレージライブラリの\u003ca href=\"https://github.com/microsoft/FASTER\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFASTER\u003c/a\u003eというものを開発している。\u003cbr\u003e\nこのFASTER、最初はキーバリューストアであるFasterKVのみ提供していた。しかし、バージョン2019.10.31.1より、FasterLogという、データの追記に特化した機能が追加された。\u003cbr\u003e\n少し触ってみると、今自分が実現したい機能を丁度良くカバーしてそうなので、使い方や注意点を書いておく。\u003c/p\u003e\n\n\u003cp\u003eFasterKVは論文も発表されているので、特徴や理論的な裏付け等が知りたければそちらも参照のこと。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.microsoft.com/en-us/research/uploads/prod/2018/03/faster-sigmod18.pdf\" rel=\"nofollow noopener\" target=\"_blank\"\u003e論文(PDF)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://scrapbox.io/nikezono/FASTER\" rel=\"nofollow noopener\" target=\"_blank\"\u003e日本語解説\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e今回紹介するFasterLogは、FasterKVで使用しているストレージ機能のベース部分を利用した、追記と範囲検索に特化したものとなる。\u003c/p\u003e\n\n\u003cp\u003eなお、FasterLogは今もなおインターフェイスの更新が行われており、この記事で書かれていることと微妙に差異があるかもしれないので注意が必要。\u003cbr\u003e\nこの記事では1.9.5をベースに解説を行う。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"特徴\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%89%B9%E5%BE%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e特徴\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eデータはディスクに保存される\n\n\u003cul\u003e\n\u003cli\u003eドライバを書けばローカルディスク以外にも対応可能\n\n\u003cul\u003e\n\u003cli\u003e例: \u003ca href=\"https://www.nuget.org/packages/Microsoft.FASTER.Devices.AzureStorage/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAzure Blobをストレージとして使うライブラリ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e扱えるデータ型はバイト配列のみ\u003c/li\u003e\n\u003cli\u003e以下の操作が可能\n\n\u003cul\u003e\n\u003cli\u003e追記\u003c/li\u003e\n\u003cli\u003eデータの範囲検索\u003c/li\u003e\n\u003cli\u003e過去のある時点までのレコード削除\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e特定レコードの削除は不可\u003c/li\u003e\n\u003cli\u003e途中にデータを挿入することは不可\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"使い方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%BF%E3%81%84%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e使い方\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"プロジェクトへの導入\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%B8%E3%81%AE%E5%B0%8E%E5%85%A5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eプロジェクトへの導入\u003c/h2\u003e\n\n\u003cp\u003e普通に\u003ca href=\"https://www.nuget.org/packages/Microsoft.FASTER.Core/\" rel=\"nofollow noopener\" target=\"_blank\"\u003enugetパッケージ\u003c/a\u003eとして公開されているので、PackageReference等で追加すればOK。\u003c/p\u003e\n\n\u003cp\u003e他に、\u003ca href=\"https://www.nuget.org/packages/Microsoft.FASTER.Server/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMicrosoft.FASTER.Server\u003c/a\u003eや、\u003ca href=\"https://www.nuget.org/packages/Microsoft.FASTER.Client/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMicrosoft.FASTER.Client\u003c/a\u003eも存在するが、これは \u003ca href=\"https://microsoft.github.io/FASTER/docs/remote-basics/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFasterKVをクライアントサーバー形式で利用したい場合に使うフレームワーク\u003c/a\u003e なので、今回は導入しない。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ストレージデバイスインスタンスを作成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eストレージデバイスインスタンスを作成する\u003c/h2\u003e\n\n\u003cp\u003eまず、以下のコードでログを格納するディスク領域を作成する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// using FASTER.core;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 独自ストレージを使用する場合、FASTER.core.IDeviceを実装したインスタンスを代わりに生成する\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ファイルパスのみ必須。\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 基本的に同じフォルダに複数ファイルを作る設計なので、複数のログファイルを扱いたい場合、別フォルダに分けるのが良い\u003c/span\u003e\n\u003cspan class=\"n\"\u003eIDevice\u003c/span\u003e \u003cspan class=\"n\"\u003elogDevice\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDevices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateLogDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"[格納するファイルのパス]\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなお、\u003ccode\u003edeleteOnClose\u003c/code\u003eというオプション引数が使用可能だが、これを使用すると、後でデータを開こうとした時に挙動がおかしくなるので、検証またはテスト目的以外では設定しないこと。\u003cbr\u003e\nまた、オプション引数で\u003ccode\u003epreallocateFile=true\u003c/code\u003eとすると、後でFasterLogを生成する時に最初から\u003ccode\u003e2^SegmentSizeBits\u003c/code\u003eのファイルを確保してから、そこに書き込むという動作になる。\u003cbr\u003e\nパフォーマンスを重視する場合はtrueにするのも手だが、その場合突然大きなファイルが作成されることになるため、注意が必要となる。\u003c/p\u003e\n\n\u003cp\u003eここで生成した\u003ccode\u003eIDevice\u003c/code\u003eは、必ずプログラム終了時に\u003ccode\u003elogDevice.Dispose()\u003c/code\u003eするか、または\u003ccode\u003eusing\u003c/code\u003eで囲むこと。\u003c/p\u003e\n\n\u003cp\u003e他のIDeviceの実装として、\u003ccode\u003eLocalMemoryDevice\u003c/code\u003eというものもあるが、\u003ca href=\"https://github.com/microsoft/FASTER/blob/a31b52b29e952827b4ad464674df57d9e230020a/cs/src/core/Device/LocalMemoryDevice.cs#L46-L78\" rel=\"nofollow noopener\" target=\"_blank\"\u003eコンストラクタにConsole.Write等が仕込まれている\u003c/a\u003e等、テスト目的で作ったような印象なので、リファレンス実装あるいはテストのためのデバイスと思った方が良い。\u003c/p\u003e\n\n\u003cp\u003eまた、\u003ca href=\"https://www.nuget.org/packages/Microsoft.FASTER.Devices.AzureStorage/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAzure Storage(page blob)を使うIDeviceの実装もある\u003c/a\u003e。ただし、こちらの性能等は未検証\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"fasterlogインスタンスを生成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#fasterlog%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFasterLogインスタンスを生成する\u003c/h2\u003e\n\n\u003cp\u003eストレージデバイスインスタンスを生成したら、以下のようにして、FasterLogインスタンスを生成する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// using FASTER.core;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// LogDeviceのみ必須\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efls\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFasterLogSettings\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eLogDevice\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elogDevice\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFasterLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efls\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 処理\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// flインスタンスはプロセス内で使い回すこと\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"fasterlogsettingsのその他項目について\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#fasterlogsettings%E3%81%AE%E3%81%9D%E3%81%AE%E4%BB%96%E9%A0%85%E7%9B%AE%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFasterLogSettingsのその他項目について\u003c/h3\u003e\n\n\u003cp\u003eFasterLogSettingsのその他項目は以下のようになる。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003ePageSizeBits\n\n\u003cul\u003e\n\u003cli\u003e格納データページの基本単位\u003c/li\u003e\n\u003cli\u003e各レコードは、メタデータと実データが必ず同じページに収まるように格納される\n\n\u003cul\u003e\n\u003cli\u003eつまり、一レコード当たりの最大サイズがこの値に依存して決定される\u003c/li\u003e\n\u003cli\u003eファイルの空間効率にも影響するので、サイズ設定は慎重に\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e単位は\u003cstrong\u003e何ビット使用するか\u003c/strong\u003eなので、例えば8を指定したら\u003ccode\u003e2^8 = 256(bytes)\u003c/code\u003eとなる\u003c/li\u003e\n\u003cli\u003e初期値は22(\u003ccode\u003e2^22 ≒ 4MB\u003c/code\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eMemorySizeBits\n\n\u003cul\u003e\n\u003cli\u003eオンメモリに乗せる最大データ容量\u003c/li\u003e\n\u003cli\u003e単位はPageSizeBitsと同じ\u003c/li\u003e\n\u003cli\u003e初期値は23(\u003ccode\u003e2^23 ≒ 8MB\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003e最低でもPageSizeBits+1必要で、下回るとFasterLogインスタンス生成時にエラーが出る\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eSegmentSizeBits\n\n\u003cul\u003e\n\u003cli\u003eオンメモリに乗らないデータを格納するファイルのサイズ\u003c/li\u003e\n\u003cli\u003e初期値は30(=1GB)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eLogCommitManager\n\n\u003cul\u003e\n\u003cli\u003eトランザクションを管理する\u003c/li\u003e\n\u003cli\u003eリカバリ等も担当\u003c/li\u003e\n\u003cli\u003e以前は \u003ca href=\"https://github.com/microsoft/FASTER/blob/v1.9.5/cs/src/core/Index/FasterLog/LocalLogCommitManager.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eLocalLogCommitManager\u003c/a\u003e がデフォルトだったが、今は \u003ca href=\"https://github.com/microsoft/FASTER/blob/v1.9.5/cs/src/core/Index/CheckpointManagement/DeviceLogCommitCheckpointManager.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDeviceLogCommitCheckpointManager\u003c/a\u003e が使われている(旧来のバージョンを使うことも可能)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eLogCommitFile\n\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e1.9.5時点では使われていない\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e出力先を変えたい場合、LogCommitManagerのインスタンスを作る必要がある\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eGetMemory\n\n\u003cul\u003e\n\u003cli\u003eデータ読出しの時に呼ばれるコールバック関数\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eLogChecksum\n\n\u003cul\u003e\n\u003cli\u003eログ整合性のためのチェックサムをどのように追加するか\u003c/li\u003e\n\u003cli\u003eファイルが壊れた場合に検知ができるため、データの重要度に応じてオンにしておく\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/microsoft/FASTER/blob/ff51d3c973634d043df08cd79e6ba5a0e1ffa6c1/cs/src/core/Index/FasterLog/FasterLog.cs#L1001-L1014\" rel=\"nofollow noopener\" target=\"_blank\"\u003e本体データ+メタデータのXORを集計しているため、オーバーヘッドはそれなりに大きいと思われる\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eNone=チェックサム追加をしない、PerEntry=レコードごとにチェックサムを取得する\u003c/li\u003e\n\u003cli\u003eデフォルト=None\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"生成されるファイル\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e生成されるファイル\u003c/h3\u003e\n\n\u003cp\u003eFasterLogをnewした時点で、以下のファイルが生成される\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eログセグメントデータ: \u003ccode\u003e[CreateLogDeviceで指定したファイル].[0始まり数字]\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eデータ本体が格納される\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003epreallocateFile=true\u003c/code\u003eの場合、\u003ccode\u003e2^[SegmentSizeBits]\u003c/code\u003ebytesのサイズをアロケートしようとするので注意(デフォルト1GB)\u003c/li\u003e\n\u003cli\u003eログデータが\u003ccode\u003e2^[SegmentSizeBits]\u003c/code\u003eを超えるたびに、新しくセグメントファイルを作成する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eトランザクションファイル: デフォルトは \u003ccode\u003elog-commits/commit.0.0\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e論理的なアドレスの開始点、終点が書き込まれる\u003c/li\u003e\n\u003cli\u003eサイズは概ね一定\u003c/li\u003e\n\u003cli\u003e複数のログデータで共有するとおかしなことになるので、同じディレクトリに複数ログデータを作成する場合は、デフォルト値から変更した方が良い\u003c/li\u003e\n\u003cli\u003eDeviceLogCommitCheckpointManager を作る場合、\u003ccode\u003elog-commits\u003c/code\u003eディレクトリのベースパスを指定することができる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"データを追加する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデータを追加する\u003c/h2\u003e\n\n\u003cp\u003eデータの追加は以下のように行う\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// FasterLog fl;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// byte[] data;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ReadOnlySpan\u0026lt;byte\u0026gt;でも可\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// Enqueueの時点ではまだ永続化はされない\u003c/span\u003e\n\u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003erecordAddress\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ここで返ってくるaddress値は、WaitForCommit系のAPIでuntilAddressとして使用する\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// コミットデータの永続化\u003c/span\u003e\n\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCommit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eCommit\u003c/code\u003eした時点でディスクに書き出される。\u003cbr\u003e\n戻り値として、追加したデータの論理アドレスが取得できる。\u003c/p\u003e\n\n\u003cp\u003e例ではEnqueueを使用したが、これは内部的にEnqueueを成功するまで繰り返すという挙動のため、タイミングが悪いと時間がかかる場合もある。\u003cbr\u003e\n一定回数追加を試みて、だめならエラーを出すか後でやり直すという挙動をしたい場合、\u003ccode\u003ebool FasterLog.TryEnqueue(byte[] data, out var logicalAddress)\u003c/code\u003eというAPIを使用する。\u003cbr\u003e\n\u003ca href=\"https://github.com/microsoft/FASTER/blob/32b3f6e40aa500a11cc2f92f7df8ded5345c1d61/cs/src/core/Index/FasterLog/FasterLog.cs#L228-L234\" rel=\"nofollow noopener\" target=\"_blank\"\u003eEnqueueも実は内部的にTryEnqueueを使っている\u003c/a\u003e。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"データを読み出す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%AD%E3%81%BF%E5%87%BA%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデータを読み出す\u003c/h2\u003e\n\n\u003cp\u003eデータの読み出しは、C#8.0とそれより前でやり方が異なる。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"共通事項\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%85%B1%E9%80%9A%E4%BA%8B%E9%A0%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e共通事項\u003c/h3\u003e\n\n\u003cp\u003e下記のように、\u003ccode\u003eFasterLog.Scan([開始アドレス], [終端アドレス])\u003c/code\u003eを使用する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// FasterLog fl;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// fl.Scan([論理開始アドレス], [論理終端アドレス])という風にして指定する\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFastLogScanIterator\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eScan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommittedBeginAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommittedUntilAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// enumeratorで走査\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここでいう開始アドレスと終端は、コミット済みの全てのログを見るなら\u003ccode\u003eFasterLog.CommittedBeginAddress\u003c/code\u003eと\u003ccode\u003eFasterLog.CommittedUntilAddress\u003c/code\u003eをそれぞれ指定すると良い。\u003cbr\u003e\n全てのログを見たくない場合は、終端アドレスに、\u003ccode\u003e[開始アドレス] + [適当なバイト数]\u003c/code\u003eを指定する。\u003c/p\u003e\n\n\u003cp\u003e走査中に、現在見ているログの論理アドレスを知りたい場合は、\u003ccode\u003eFastLogScanIterator.CurrentAddress\u003c/code\u003e、次のエントリのアドレスを知る場合は、\u003ccode\u003eFastLogScanIterator.NextAddress\u003c/code\u003eを使用する。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"非同期c80\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9Fc80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e非同期(C#8.0)\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003eIAsyncEnumerable\u003c/code\u003eを使用する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// FasterLog fl;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// fl.Scan([論理開始アドレス], [論理終端アドレス])という風にして指定する\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFastLogScanIterator\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eScan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommittedBeginAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommittedUntilAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// dataの型はbyte[]\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// lenはデータ長(bytes)\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 2019.11.18では二つだけだが、最新ソースでは更に long currentAddress も追加になる模様\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// https://github.com/microsoft/FASTER/commit/bf657635374873958d96b31db1299b58ef9a17b1\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enextAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAsyncEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// データの参照\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eFastLogScanIterator.GetAsyncEnumerable(CancellationToken ct = default)\u003c/code\u003eでは、foreachの要素に単純にnewされた\u003ccode\u003ebyte[]\u003c/code\u003eを受け取るが、代わりに\u003ccode\u003eSystem.Buffers.MemoryPool\u0026lt;byte\u0026gt;\u003c/code\u003eのインスタンスを渡すと、メモリプール経由でバッファの確保を行うため、アロケーションが減らせる。\u003cbr\u003e\nただし、\u003ccode\u003eIMemoryOwner\u0026lt;byte\u0026gt;\u003c/code\u003e自体のアロケーションは避けられないため、ゼロではない。\u003cbr\u003e\nまた、使い終わった\u003ccode\u003eIMemoryOwner\u0026lt;byte\u0026gt;\u003c/code\u003eはDisposeを行わないと、メモリリークの原因になる。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"非同期c7x以前\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9Fc7x%E4%BB%A5%E5%89%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e非同期(C#7.x以前)\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003eFastLogScanIterator.[GetNext,NextAddress,WaitAsync]\u003c/code\u003e等を駆使する\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// FasterLog fl;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFastLogScanIterator\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eScan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommittedBeginAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommittedUntilAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 終端ではnextAddressが-1になる\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNextAddress\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// データを取り出すまでループと待機を行う\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 引数は、データ本体、データ長、現在のアドレスの三つ\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetNext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enextAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// データの参照\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"データの削除\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%89%8A%E9%99%A4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデータの削除\u003c/h2\u003e\n\n\u003cp\u003eデータの削除には、\u003ccode\u003eFasterLog.TruncateUntil(long untilAddress)\u003c/code\u003eまたは\u003ccode\u003eFasterLog.TruncateUntilPageStart(long untilAddress)\u003c/code\u003eを使用する。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"truncateuntil\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#truncateuntil\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTruncateUntil\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003eTruncateUntil\u003c/code\u003eは\u003cstrong\u003eデータの開始アドレス(BeginAddress)から、指定されたアドレス直前までのデータを削除する\u003c/strong\u003eという挙動である。\u003cbr\u003e\n注意点として、\u003cstrong\u003eレコード境界ではない中途半端なアドレスを指定すると、次回のScan時にエラーが出る\u003c/strong\u003eという仕様がある。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/microsoft/FASTER/issues/191#issuecomment-548833464\" rel=\"nofollow noopener\" target=\"_blank\"\u003e関連github issue\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e回避するには、末尾アドレス(FasterLog.TailAddress)を指定するか、下記のようにScanの途中で得たNextAddressで、正確なレコード境界を取得して指定するというやり方がある\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// FasterLog fl;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003euntilAddress\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eScan\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBeginAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"err\"\u003e終端\u003c/span\u003e\u003cspan class=\"p\"\u003e]))\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAsyncEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 処理\u003c/span\u003e\n        \u003cspan class=\"n\"\u003euntilAddress\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNextAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTruncateUntil\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euntilAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 最後にCommitすると変更が反映される\u003c/span\u003e\n\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCommit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eより安全に、かつ大雑把に消したい場合は、後述の\u003ccode\u003eTruncateUntilPageStart\u003c/code\u003eを使用する\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"truncateuntilpagestart\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#truncateuntilpagestart\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTruncateUntilPageStart\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003eTruncateUntilPageStart\u003c/code\u003eは\u003cstrong\u003eデータの開始アドレスから、指定されたアドレスに紐づくページの直前までを消去する\u003c/strong\u003eという挙動である。\u003cbr\u003e\nレコードはページをまたぐことは仕様上ないため、\u003ccode\u003eTruncateUntil\u003c/code\u003eで起こったような問題は起きない。\u003cbr\u003e\nただし、正確な消去はできないため、大雑把にログローテーション等をしたい場合に使うと良いだろう\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"パフォーマンス上の注意点\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eパフォーマンス上の注意点\u003c/h1\u003e\n\n\u003cp\u003e追記、削除する時は、操作後にコミットを行い永続化する必要があるが、コミットはFasterLogの中で最もコストのかかる処理だという事を念頭に置いた方が良い。しかし、コミットしないとデータが永続化されないので、信頼性が下がる。悩ましいところである。\u003cbr\u003e\nつまり、より高速にデータを処理したい場合は、\u003cstrong\u003e信頼性を下げずにいかにコミット回数を減らすか\u003c/strong\u003eということを考える。\u003c/p\u003e\n\n\u003cp\u003eではどうすればいいか。以下のようなやり方を一例として示そうと思う。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"commitタスクを独立させる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#commit%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%92%E7%8B%AC%E7%AB%8B%E3%81%95%E3%81%9B%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCommitタスクを独立させる\u003c/h2\u003e\n\n\u003cp\u003e箇条書きにすると以下のような動作になる\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e追記タスクを並列化する\u003c/li\u003e\n\u003cli\u003e追記タスクは、自分の書き込みが完了するまでWaitForCommitAsyncで待機する\n\n\u003cul\u003e\n\u003cli\u003e要件による\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e追加で、一つだけひたすらコミットだけするタスクを作成する\u003c/li\u003e\n\u003cli\u003e追記タスクは、コミットタスクに自分が追記したレコードのアドレスを渡す\u003c/li\u003e\n\u003cli\u003eコミットタスクは、現在のコミット済み終端アドレスと受け取ったレコードアドレスを比較して、未コミットと判断したら、コミットを行う\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eタスク間のデータ受け渡しは、\u003ccode\u003eSystem.Threading.Channels\u003c/code\u003eが使えると思う。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"追加されたデータが永続化されるまで待機する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E6%B0%B8%E7%B6%9A%E5%8C%96%E3%81%95%E3%82%8C%E3%82%8B%E3%81%BE%E3%81%A7%E5%BE%85%E6%A9%9F%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e追加されたデータが永続化されるまで待機する\u003c/h3\u003e\n\n\u003cp\u003eさて、このやり方では、追記とコミットが別タスクで行われる状態になる。しかし、要件によっては、データ消失を可能な限り避けるため、自分で追加したデータが、確実に永続化されたかどうか確認する必要が出てくる。\u003cbr\u003e\nそこで、\u003ccode\u003eFasterLog.WaitForCommitAsync(long address, CancellationToken ct)\u003c/code\u003eを使用する。\u003cbr\u003e\n引数には\u003ccode\u003eFasterLog.Enqueue\u003c/code\u003eで得たアドレスを指定する。\u003cbr\u003e\nこれを使うと、指定されたアドレスがコミットされたと判断されるまで(\u003ccode\u003eaddress \u0026lt;= CommittedUntilAddress\u003c/code\u003eになるまで)待機が発生する。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"コード例\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコード例\u003c/h3\u003e\n\n\u003cp\u003e具体的には、少々長くなるが以下のようなコードになる。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading.Tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading.Channels\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eFASTER.core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.IO\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Linq\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003efasterlabs\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFasterLogCommitTest\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnqueueData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFasterLog\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003estackalloc\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryEnqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRuntime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInteropServices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMemoryMarshal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAsBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elogicalAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elogicalAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eValueTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eDoTest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskNum\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003eTotalCount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e100000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// ensure using cleared data \u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExists\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"logcommittest.log.0\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"logcommittest.log.0\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExists\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"log-commits\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"log-commits\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elog\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDevices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateLogDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"logcommittest.log\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003echannel\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eChannel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateUnbounded\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFasterLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFasterLogSettings\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eLogDevice\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elog\u003c/span\u003e \u003cspan class=\"p\"\u003e}))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecsrc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e240\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhenAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhenAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskNum\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// データを追加するタスク\u003c/span\u003e\n                            \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003elogicalAddress\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eTotalCount\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskNum\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                    \u003cspan class=\"n\"\u003elogicalAddress\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnqueueData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eTotalCount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003echannel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elogicalAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecsrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitForCommitAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elogicalAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecsrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                    \u003cspan class=\"c1\"\u003e// Console.WriteLine($\"{idx}, {i}, {logicalAddress}\");\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"producer error(\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e, \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003elogicalAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e, \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommittedUntilAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e, \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTailAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e): \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// Console.WriteLine($\"exit producer({idx}, {sw.Elapsed})\");\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e})).\u003c/span\u003e\u003cspan class=\"nf\"\u003eContinueWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003echannel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e()),\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// コミットする方のタスク\u003c/span\u003e\n                            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecommitCount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003echannel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitToReadAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecsrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echannel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryRead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003euntiladdr\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommittedUntilAddress\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTailAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                                        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                            \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCommit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                            \u003cspan class=\"c1\"\u003e// await fl.CommitAsync(csrc.Token).ConfigureAwait(false);\u003c/span\u003e\n                                            \u003cspan class=\"n\"\u003ecommitCount\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n                                        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"consumer error:\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"exit consumer(\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ecommitCount\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nf\"\u003eContinueWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommittedUntilAddress\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTailAddress\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"last commit\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003efl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCommit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Multi(\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eTotalCount\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e, \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eTaskNum\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e): \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsed\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e, iops = \u003c/span\u003e\u003cspan class=\"p\"\u003e{(\u003c/span\u003e\u003cspan class=\"n\"\u003eTotalCount\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsed\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTotalMilliseconds\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eバージョン2019.11.18.1より前のバージョンでは、\u003ccode\u003eCommitAsync\u003c/code\u003eすると\u003ccode\u003eWaitForCommitAsync\u003c/code\u003eとスレッドプールの消費が競合して、デッドロック状態になる場合があるので注意すること。(\u003ca href=\"https://github.com/microsoft/FASTER/issues/199\" rel=\"nofollow noopener\" target=\"_blank\"\u003e該当github issue\u003c/a\u003e)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"終りに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%82%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e終りに\u003c/h1\u003e\n\n\u003cp\u003e今回はログ向けストレージ機能を持つFasterLogを紹介した。実際制約もあるので、あらゆる場面で使用できるわけではないが、それでも他には無い特徴を持っているため、役に立つ場面では役に立つと思われる。\u003cbr\u003e\n機会があれば、コミット回数や並列数を変えて性能テスト等を行ってみたい。\u003c/p\u003e\n\n\u003cp\u003eまた、データ検索についてはComplete周り等、もう少し掘り下げられそうな所があるので、別記事にするか、あるいはこの記事に追記したい。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"参考リンク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考リンク\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/microsoft/FASTER\" rel=\"nofollow noopener\" target=\"_blank\"\u003egithubプロジェクトページ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://microsoft.github.io/FASTER/\" rel=\"nofollow noopener\" target=\"_blank\"\u003egithub.ioページ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.microsoft.com/en-us/research/project/FASTER/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMSによる調査報告ページ\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://scrapbox.io/nikezono/FASTER\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFasterKV論文についての日本語解説\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2019-11-12T11:20:09Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"OUdfsAZl/j1+XijbVb3mT0eqPERIo0+gkQ==--q8u2+ImigmGzu7XF--z+RajXrhcQWJvdhwVX7rMQ==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-06-17T00:19:52Z","likesCount":23,"linkUrl":"https://qiita.com/skitoy4321/items/6a20bc277bc424385cc7","organization":null,"originalId":1076360,"stockedCount":16,"title":"追記型ストレージFasterLogについて","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A7%8B%E3%82%81%E3%81%AB\"\u003e始めに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%89%B9%E5%BE%B4\"\u003e特徴\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%BF%E3%81%84%E6%96%B9\"\u003e使い方\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%B8%E3%81%AE%E5%B0%8E%E5%85%A5\"\u003eプロジェクトへの導入\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003eストレージデバイスインスタンスを作成する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#fasterlog%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B\"\u003eFasterLogインスタンスを生成する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#fasterlogsettings%E3%81%AE%E3%81%9D%E3%81%AE%E4%BB%96%E9%A0%85%E7%9B%AE%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eFasterLogSettingsのその他項目について\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%94%9F%E6%88%90%E3%81%95%E3%82%8C%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\"\u003e生成されるファイル\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003eデータを追加する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%AD%E3%81%BF%E5%87%BA%E3%81%99\"\u003eデータを読み出す\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%85%B1%E9%80%9A%E4%BA%8B%E9%A0%85\"\u003e共通事項\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9Fc80\"\u003e非同期(C#8.0)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9Fc7x%E4%BB%A5%E5%89%8D\"\u003e非同期(C#7.x以前)\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%89%8A%E9%99%A4\"\u003eデータの削除\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#truncateuntil\"\u003eTruncateUntil\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#truncateuntilpagestart\"\u003eTruncateUntilPageStart\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003eパフォーマンス上の注意点\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#commit%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%92%E7%8B%AC%E7%AB%8B%E3%81%95%E3%81%9B%E3%82%8B\"\u003eCommitタスクを独立させる\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%BF%BD%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E6%B0%B8%E7%B6%9A%E5%8C%96%E3%81%95%E3%82%8C%E3%82%8B%E3%81%BE%E3%81%A7%E5%BE%85%E6%A9%9F%E3%81%99%E3%82%8B\"\u003e追加されたデータが永続化されるまで待機する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B\"\u003eコード例\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%82%E3%82%8A%E3%81%AB\"\u003e終りに\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF\"\u003e参考リンク\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":3182,"uuid":"6a20bc277bc424385cc7","banReason":null,"adventCalendarItem":{"day":12,"calendar":{"name":"C#","urlName":"c-sharp","year":2019,"organization":null}},"author":{"encryptedId":"7/H5R5xX8kzLi1xoq5mGZdy8UNb/--8lRj7jpbGmOvEQBX--m7ZguKrw8e7Nbrd80KErLQ==","originalId":103253,"description":"","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=a7dce827dc16582e1b8e9c7a52216638","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","urlName":"skitoy4321","websiteUrl":"","twitterUrl":"https://twitter.com/skitoy4321","twitterUrlName":"skitoy4321","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"FASTER","urlName":"faster"}],"followingLikers":{"edges":[]},"comments":{"totalCount":2}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
