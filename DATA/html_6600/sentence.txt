ログが想定されているものが出力されているか確認するテストを行ったところ以下のエラーが出た。
ここでは、テストを通すためにはどうすればよいのか検討する。LogWarningは拡張メソッドであり、Moqは拡張メソッドをモックできないのが原因であった。
拡張先のメソッドをモックする必要があった。Bot Builder v4.5 のユニットテスト : IBot を継承するクラスのテストを見てみるとILoggerを使ったテストをしている。
ただ、Logのverifyの仕方が異なっていた。それに倣ってみる。通った。
Log.Warningとやってること違うんだけど。ここで、LogWarningの型定義を見に行く。ついでにLogの型定義を見に行く。成功パターンのと何か違うな。こんどは、テストで使用したmockのLogの型を見てみる。...なにか違うな。テストの型の名前空間は、namespace Microsoft.Extensions.Logging
実際に使っている方の名前空間はnamespace Microsoft.Extensions.Loggingここは同じだが、、LoggerExtensions にいますね。
この辺踏まえて検索すると、以下のような文章が見つかった。問題は、拡張メソッドをモックできないことです。これは、定義上、静的メソッドの単なるシンタティックシュガーであるためです。したがって、あなたがしなければならないのは、拡張メソッドが拡張している「thing」の基礎となる呼び出しをモックすることです。
Mocking ILogger with Moqなるほど。上記のようにコードを修正して試してみる。
テストコードも合わせて書き直す。無事成功。
ちょっと心配になったので、失敗パターンも試してみる。ちゃんと以下のようにエラーになった。参考ページで、拡張メソッドを作っていたので試す。検証用テスト対象検証用テストメソッドmessageがnullのときは呼び出されることだけを確認するようにしてみた。Bot Builder v4.5 のユニットテスト : IBot を継承するクラスのテスト
Mocking ILogger with Moq
moq quick start
Moq : Mocking Framework for .NET
拡張メソッド
Moq 実装メモ


