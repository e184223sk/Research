<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Rustで実装したアルゴリズムをUnityから使う - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/hadashiA/items/3755786e95bbcd8f3b5d" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="ZgGd68ikN1HtgQhvU5zLvPjogMMN9tPXJFxEd1AD24WqdKaija1bhP/nm2fXmxMXvNC8BityYz00Vn9YiPhrQA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@hadashiA" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="Rustで実装したアルゴリズムをUnityから使う - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1VblZ6ZE9PQnAtV3VuLWlqaGVPQmwtT0JuLU9Db3VPRHEtT0N0T09EcXVPQ3V1T0RvT09Da2xWdWFYUjU0NEdMNDRLSjVMMl80NEdHJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTA3M2UwNTEyZDYyYzg1OTkzYmY5M2I3N2FmMzUwZDM4&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2hoWkdGemFHbEImdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz03YjI0YmJiYjVjMDQ5Y2JlMmEyNTgyNjRiMzkxNDlhZA&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=51a5ef247fe5f311c7159fc312b4dabc"><meta property="og:description" content="Unity (ゲームエンジン) から Rust で書いたネイティブバイナリを実行する、という行為を試してみました。
サンプルコードは こちら。


なぜRust ?

以前、Unity上で、C#でプログラマブルに任意の形状のメッシュを..."><meta content="https://qiita.com/hadashiA/items/3755786e95bbcd8f3b5d" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Rust,Unity" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-14d16729-a5b4-4cc5-b334-7fca13e714e0"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FhadashiA%2Fitems%2F3755786e95bbcd8f3b5d">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FhadashiA%2Fitems%2F3755786e95bbcd8f3b5d">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-14d16729-a5b4-4cc5-b334-7fca13e714e0">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-09-12T01:09:21.000+09:00","dateModified":"2019-09-16T01:42:07.000+09:00","headline":"Rustで実装したアルゴリズムをUnityから使う","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1VblZ6ZE9PQnAtV3VuLWlqaGVPQmwtT0JuLU9Db3VPRHEtT0N0T09EcXVPQ3V1T0RvT09Da2xWdWFYUjU0NEdMNDRLSjVMMl80NEdHJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTA3M2UwNTEyZDYyYzg1OTkzYmY5M2I3N2FmMzUwZDM4\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2hoWkdGemFHbEImdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz03YjI0YmJiYjVjMDQ5Y2JlMmEyNTgyNjRiMzkxNDlhZA\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=51a5ef247fe5f311c7159fc312b4dabc","mainEntityOfPage":"https://qiita.com/hadashiA/items/3755786e95bbcd8f3b5d","author":{"@type":"Person","address":"","email":null,"identifier":"hadashiA","name":"hadashiA","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F5859%2Fprofile-images%2F1473682324?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=b16e8286e5c3272bad99dc3238e293cd","url":"https://qiita.com/hadashiA","description":"フリーランスプログラマだよ","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"hadashiA","type":"items","id":"3755786e95bbcd8f3b5d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"hadashiA","type":"items","id":"3755786e95bbcd8f3b5d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"hadashiA","type":"items","id":"3755786e95bbcd8f3b5d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/hadashiA/items/3755786e95bbcd8f3b5d","location":"/hadashiA/items/3755786e95bbcd8f3b5d","scheme":"https","host":"qiita.com","port":null,"pathname":"/hadashiA/items/3755786e95bbcd8f3b5d","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"yg9EhwaT2CgJIZzp8fo31SzQVgNpAQkmrPrX/Bk1zHIGen/OQ5q0/RtHD+F1/e9+aOhqxk+Fucy88OzTwc58tw==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-039d367f-c918-49f0-a970-9259b1857e80"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/hadashiA/items/3755786e95bbcd8f3b5d/likers" class="css-1iupg5d">71</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">49</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/3755786e95bbcd8f3b5d/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/hadashiA/items/3755786e95bbcd8f3b5d/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/hadashiA/items/3755786e95bbcd8f3b5d/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/hadashiA/items/3755786e95bbcd8f3b5d/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/hadashiA/items/3755786e95bbcd8f3b5d.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/hadashiA"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/5859/profile-images/1473682324" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/hadashiA" class="css-10ougpm">@<!-- -->hadashiA</a><div class="css-1ay9vb9"><span><meta content="2019-09-11T16:09:21Z"/><time dateTime="2019-09-15T16:42:07Z" class="css-m19uds">updated at 2019-09-15</time></span></div></div></div></div></div><h1 class="css-cgzq40">Rustで実装したアルゴリズムをUnityから使う</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/rust" class="css-4czcte">Rust</a><a href="/tags/unity" class="css-4czcte">Unity</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>Unity (ゲームエンジン) から Rust で書いたネイティブバイナリを実行する、という行為を試してみました。<br>
サンプルコードは <a href="https://github.com/hadashiA/unigeo" rel="nofollow noopener" target="_blank">こちら</a>。</p>

<h2>
<span id="なぜrust-" class="fragment"></span><a href="#%E3%81%AA%E3%81%9Crust-"><i class="fa fa-link"></i></a>なぜRust ?</h2>

<p>以前、Unity上で、C#でプログラマブルに任意の形状のメッシュを生成するといったことをやってみました。</p>

<p><a href="https://camo.qiitausercontent.com/4f56cc5b53c650126f687760c7953e65e992ad54/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f353835392f36613338373937392d646539652d366138622d353335622d3461623964306563663535332e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F5859%2F6a387979-de9e-6a8b-535b-4ab9d0ecf553.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c82f819d0145a5f6c75dab3de9ff1bb3" alt="demo_small.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/5859/6a387979-de9e-6a8b-535b-4ab9d0ecf553.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F5859%2F6a387979-de9e-6a8b-535b-4ab9d0ecf553.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=56c7b89305b8c5bc413ded2d1de0e23c 1x" loading="lazy"></a></p>

<p>( たとえばこういうふうに、実行中に入力から任意の形状を生成して、メッシュにして描画できると楽しい )</p>

<p>しかし、三角形分割などの幾何アルゴリズムをC#で素朴に実装してみたところ、本に載っているような計算量少なめのアルゴリズムに則ったとしても、(むしろ則ったせいで)、GCゴミの発生を抑えることの難易度がかなり高いな、という感想を持ちました。</p>

<p>こういう類のアルゴリズムは、計算途中の辺や点、面の情報を参照として持ち、それらの空間的なつながりの情報を可変長のコレクションに入れて管理するといったことがどうしても頻出するのではないかと思います。<br>
ある種の向きや順番を表現できて、重複や循環も表現できるデータ構造もよく使われているようです。たとえば二重連結辺リスト (DCEL - Double Connected Edge List) と呼ばれるようなものがあります。</p>

<p>結果として、アルゴリズムを実行するある過程では必要なんだけど、終わったら必要なくなるような、外からは見えない一時的なヒープアロケーションを避けるのが難しい、あるいは避けるのが面倒なことになりがちでした。</p>

<p>C#では、GC管理対象のメモリ確保をぽんぽん毎フレームなどの高い頻度で実行しまくると、パフォーマンス劣化につながることは間違いないため、どうにか避けたいところ。</p>

<p>もちろん、オブジェクトをプーリングして使いまわすとか、一度確保したバッファは使いまわすとか、テクニックは色々考えられると思いますが、まず正しく動かすことも苦労する実装をしている局面だと、そいういう気遣いを見せるのはなかなか大変です。漏れやミスも出てきそうです。</p>

<p>そこで、実験というか半分遊びですが、メッシュ生成みたいなものは、Rust で実装してしまえば良いんちゃうか ? ということを思いつきました。</p>

<p>これは、Unity の UI のソースを読んでいたところ、メッシュ生成やレイアウト計算などの肝心な部分がほとんどネイティブコードに埋められてブラックボックスになっているのを見かけて得たアイデアです。</p>

<p>Unity の低レイヤは c++ で実装されているそうですが、現在の僕たちにはRustという選択肢もあります。</p>

<ul>
<li>Rust の実行速度は c++ と同等</li>
<li>主要なOSやスマホ向けのクロスコンパイルも標準ツールでサポート</li>
<li>プラットフォーム固有の微妙なAPI載違いをほとんど意識することがない</li>
<li>モダンなパッケージマネージャも搭載</li>
<li>GC がない

<ul>
<li>ヒープアロケーションそのものはもちろん安くはないはずですが、何も考えずに実装した場合、Rustにするだけで、GCによってたまに全スレッドが遅くなるといった類の問題は緩和しそうという期待がある (未検証)</li>
</ul>
</li>
</ul>

<p>そこで、実験的に、Rust でメモリの取得/解放を含めてアルゴリズムを実装して、 Unity から呼び出す、という行為を試してみました。</p>

<p>今回のサンプルは、とりあえず試しに、キャットムル-ロム曲線の計算をRustで実装してUnityから呼び出す、というだけの内容です。</p>

<p><a href="https://camo.qiitausercontent.com/4cf2a9741f0bb8e3f952db6d8f57843c1767d1cd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f353835392f33656131326434372d643236322d353239642d303032382d3665613231633062386532302e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F5859%2F3ea12d47-d262-529d-0028-6ea21c0b8e20.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=07d34295fbd10de9d87f3c7e818f4d05" alt="5cfe24463e793aff231ec40868fa22c5.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/5859/3ea12d47-d262-529d-0028-6ea21c0b8e20.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F5859%2F3ea12d47-d262-529d-0028-6ea21c0b8e20.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ba9276de494493b6aed5490354822ef2 1x" loading="lazy"></a></p>

<p>↑UnityからRustで実装したライブラリを呼び出し、Gizmoで可視化しているようすです。<br>
白い点=制御点を与えると、青い線=それらを通過する曲線 の座標を計算する、という部分がRustで動いています。</p>

<p>中身はこれだけけですがコードは <a href="https://github.com/hadashiA/unigeo" rel="nofollow noopener" target="_blank">これ</a> です。</p>

<h2>
<span id="rust-と-c-のバインディング" class="fragment"></span><a href="#rust-%E3%81%A8-c-%E3%81%AE%E3%83%90%E3%82%A4%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>Rust と C# のバインディング</h2>

<h3>
<span id="rust-側" class="fragment"></span><a href="#rust-%E5%81%B4"><i class="fa fa-link"></i></a>Rust 側</h3>

<h4>
<span id="cargotoml" class="fragment"></span><a href="#cargotoml"><i class="fa fa-link"></i></a>Cargo.toml</h4>

<p>Cargo.toml に以下の設定を足すことで、ビルドする対象をネイティブの動的リンクライブラリに変更します。</p>

<div class="code-frame" data-lang="toml">
<div class="code-lang"><span class="bold">Cargo.toml</span></div>
<div class="highlight"><pre class="with-code"><code><span class="py">crate-type</span> <span class="p">=</span> <span class="nn">["dylib"]</span>
</code></pre></div>
</div>

<h4>
<span id="外の世界から呼ぶための関数" class="fragment"></span><a href="#%E5%A4%96%E3%81%AE%E4%B8%96%E7%95%8C%E3%81%8B%E3%82%89%E5%91%BC%E3%81%B6%E3%81%9F%E3%82%81%E3%81%AE%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>外の世界から呼ぶための関数</h4>

<ul>
<li>Rust の関数に <code>pub extern</code> をつけてあげて、外からリンクできるインターフェイスの関数をつくります。</li>
<li>Rustを知らない別言語から参照できるように、<code>#[no_mangle]</code> 属性をつけます</li>
</ul>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre class="with-code"><code><span class="c">// 例</span>
<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="k">fn</span> <span class="nf">hoge</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i32</span> <span class="p">{</span>
    <span class="mi">100</span>
<span class="p">}</span>
</code></pre></div></div>

<p>この状態でビルドしてみると、<code>target/</code> 以下に <code>lib&lt;crate名&gt;.dylib</code> というバイナリができあがり、 <code>hoge</code> というシンボルが出力されていることが確認できました。(macOSの場合)</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>⟩ nm -gU target/debug/libunigeo.dylib | grep hoge
00000000000083c0 T hoge
</code></pre></div></div>

<h4>
<span id="rustの外へ構造体を渡す受け取る" class="fragment"></span><a href="#rust%E3%81%AE%E5%A4%96%E3%81%B8%E6%A7%8B%E9%80%A0%E4%BD%93%E3%82%92%E6%B8%A1%E3%81%99%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B"><i class="fa fa-link"></i></a>Rustの外へ構造体を渡す/受け取る</h4>

<p>Rustで定義した構造体を外とやりとりする場合は、 structの定義に <code>#[repr(C)]</code> 属性をつけておきます。<br>
こうすることで、メモリ上のレイアウトが C で書いた場合と同様になってくれるそうです。便利です。( c言語自体がもはや共通のバイナリのインターフェイスかのようなノリですね)</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre class="with-code"><code><span class="nd">#[repr(C)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">A</span> <span class="p">{</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">f32</span><span class="p">,</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">f32</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Rustの外の別の言語側でも、全く同じメモリレイアウトの構造体の定義さえあれば、Rust側で関数の引数として受け止ったり、返したりすることができます。</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre class="with-code"><code><span class="c">// 例。 上で定義したAという構造体をつかう</span>
<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="k">fn</span> <span class="nf">a_new</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">A</span> <span class="p">{</span>
    <span class="n">A</span> <span class="p">{</span> <span class="n">a</span><span class="p">:</span> <span class="n">v</span><span class="py">.a</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">v</span><span class="py">.b</span> <span class="o">*</span> <span class="mf">200.0</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4>
<span id="rust側で確保した変数のポインタを外へ返す" class="fragment"></span><a href="#rust%E5%81%B4%E3%81%A7%E7%A2%BA%E4%BF%9D%E3%81%97%E3%81%9F%E5%A4%89%E6%95%B0%E3%81%AE%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%82%92%E5%A4%96%E3%81%B8%E8%BF%94%E3%81%99"><i class="fa fa-link"></i></a>Rust側で確保した変数のポインタを外へ返す</h4>

<p>今回は、ヒープアロケーションをRust側へ持っていくというモチベーションがあったため、Rust側でヒープに確保した変数のポインタを外側へ渡したり、受けとったりするということもやってみました。</p>

<p>外側にポインタを返す場合、まず、寿命を任意の長さにするため、 <code>Box::new</code> でボクシングしてあげます。</p>

<p>次に、確保した Box に対して、<code>Box::into_raw</code> を呼び出すことによって、生ポインタをつくってあげます。<br>
ここで、into_raw によってBoxは消費され、このとき、できあがった生ポインタはRustのメモリ管理対象から外れています。 <code>Box::into_raw</code> したポインタに対しては、手動でメモリを解放する責任が生じることに、注意です。</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre class="with-code"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="k">fn</span> <span class="nf">catmull_rom_spline_new</span><span class="p">(</span><span class="n">closed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">mut</span> <span class="n">CatMullRomSpline</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">spline</span> <span class="o">=</span> <span class="nn">CatMullRomSpline</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">closed</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">spline</span> <span class="o">=</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">spline</span><span class="p">);</span>

    <span class="nn">Box</span><span class="p">::</span><span class="nf">into_raw</span><span class="p">(</span><span class="n">spline</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>というわけで、ポインタの破棄を外から叩けるように、用意しておきましょう。、</p>

<p><code>Box::from_raw</code> をすると、生ポインタをもう一度 Rustの管理対象のBox に変換します。<br>
これをdropすれば後片付けは完了です。<br>
( とくに明示的になにもしなくても、moveせずにスコープを抜けるとdropします。</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre class="with-code"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="k">fn</span> <span class="nf">catmull_rom_spline_drop</span><span class="p">(</span><span class="n">spline</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="n">CatMullRomSpline</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">unsafe</span> <span class="p">{</span> <span class="nn">Box</span><span class="p">::</span><span class="nf">from_raw</span><span class="p">(</span><span class="n">spline</span><span class="p">)</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>外からポインタを受けとり、それに対してメソッドを呼び出す例は以下のようなかんじになります。</p>

<div class="code-frame" data-lang="rust"><div class="highlight"><pre class="with-code"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="k">fn</span> <span class="nf">catmull_rom_spline_add_control_point</span><span class="p">(</span><span class="n">spline</span><span class="p">:</span> <span class="o">*</span><span class="k">const</span> <span class="n">CatMullRomSpline</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">Vec3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">spline</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;*</span><span class="n">spline</span> <span class="p">};</span>
    <span class="n">spline</span><span class="nf">.add_control_point</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これでだいたい外側からRustのコードをつかうことができそうです。</p>

<p>インターフェイスの定義が面倒なので、マクロとかにするのが良いかも</p>

<h3>
<span id="unity-側" class="fragment"></span><a href="#unity-%E5%81%B4"><i class="fa fa-link"></i></a>Unity 側</h3>

<h4>
<span id="ネイティブプラグイン" class="fragment"></span><a href="#%E3%83%8D%E3%82%A4%E3%83%86%E3%82%A3%E3%83%96%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3"><i class="fa fa-link"></i></a>ネイティブプラグイン</h4>

<p>Unity には、 ネイティブバイナリを動的リンクして呼び出す仕組みが搭載されているので、それをつかいます。</p>

<p><a href="https://docs.unity3d.com/Manual/NativePlugins.html" rel="nofollow noopener" target="_blank">Unity - Manual: Native plug-ins</a></p>

<ul>
<li>プロジェクトの任意の場所に <code>Plugins/</code> ディレクトリをつくるとその下は特別扱いされ、ネイティブバイナリをロードしてくれます</li>
<li>プラットフォームごと、たとえば macOSであれば、 <code>Plugins/macOS</code> ディレクトリをつくり、Rustでビルドしたバイナリを置きます。</li>
</ul>

<h4>
<span id="dllimport" class="fragment"></span><a href="#dllimport"><i class="fa fa-link"></i></a>DllImport</h4>

<p>c# 側では、<code>DllImport</code> 属性で c# としてのインターフェイス定義を書いてあげることで、ネイティブバイナリの中の関数を呼びだすことができます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"libunigeo"</span><span class="p">)]</span>
<span class="k">internal</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">catmull_rom_spline_new</span><span class="p">(</span><span class="kt">bool</span> <span class="n">closed</span><span class="p">);</span>
</code></pre></div></div>

<h4>
<span id="sturctのレイアウト" class="fragment"></span><a href="#sturct%E3%81%AE%E3%83%AC%E3%82%A4%E3%82%A2%E3%82%A6%E3%83%88"><i class="fa fa-link"></i></a>sturctのレイアウト</h4>

<p><code>[repr(C)]</code> な構造体と同じメモリレイアウトの型を C# 側で定義するためには、C#の <code>[StructLayout]</code> 属性を以下のようにするといけるようです。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>    <span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">struct</span> <span class="nc">A</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">a</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>ちなみに、Unity の<code>Vector3</code> も、Rust の <code>#[repr(C)]</code> をつけた float 3つの構造体と一致させることができました。Unityのこの辺の型は実装がc#ではなくc++側にあるらしいですが、必ず <code>#[repr(C)]</code> 相当になると考えて良いのかよくわかってません <img alt=":thinking:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f914.png" title=":thinking:" width="20" loading="lazy"> </p>

<h4>
<span id="disposable-pattern" class="fragment"></span><a href="#disposable-pattern"><i class="fa fa-link"></i></a>Disposable Pattern</h4>

<p>C#側では、IDisposableを実装して、非マネージドなリソースの解放が必要であることを明示するのが驚きがないとおもいます。さらに、メモリ解放を忘れないように Disposable パターン で 明示的な解放がない場合もファイナライザによって Dispose が呼ばれるようにしておくと安心です。</p>

<p><a href="https://docs.microsoft.com/ja-jp/dotnet/standard/garbage-collection/implementing-dispose" rel="nofollow noopener" target="_blank">Dispose メソッドの実装 | Microsoft Docs</a></p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">CatmullRomSplineRust</span> <span class="p">:</span> <span class="n">IDisposable</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>

        <span class="k">readonly</span> <span class="n">IntPtr</span> <span class="n">ptr</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">disposed</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">CatmullRomSplineRust</span><span class="p">(</span><span class="kt">bool</span> <span class="n">closed</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ptr</span> <span class="p">=</span> <span class="n">Bindings</span><span class="p">.</span><span class="nf">catmull_rom_spline_new</span><span class="p">(</span><span class="n">closed</span><span class="p">);</span>
        <span class="p">}</span>                   

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span> 
            <span class="nf">Dispose</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="n">GC</span><span class="p">.</span><span class="nf">SuppressFinalize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>           
        <span class="p">}</span>

        <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">disposed</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span> 

            <span class="n">Bindings</span><span class="p">.</span><span class="nf">catmull_rom_spline_drop</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
            <span class="n">disposed</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<h4>
<span id="実行時のエラー" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E6%99%82%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC"><i class="fa fa-link"></i></a>実行時のエラー</h4>

<p>Unity では、ネイティブプラグイン側がエラーになると、プロセスがクラッシュするというド派手な挙動をするようになっていて、どきどきしてしまいますが、ログファイルをみにいくと Rust のエラーをちゃんと読むことができます</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code> thread '&lt;unnamed&gt;' panicked at 'attempt to subtract with overflow', src/spline.rs:60:58
 note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.
 fatal runtime error: failed to initiate panic, error 5
 [Unity Package Manager (Upm)]
 Parent process [29918] was terminated
</code></pre></div></div>

<h4>
<span id="ネイティブプラグインのリロード" class="fragment"></span><a href="#%E3%83%8D%E3%82%A4%E3%83%86%E3%82%A3%E3%83%96%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%81%AE%E3%83%AA%E3%83%AD%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>ネイティブプラグインのリロード</h4>

<p>今回はじめて知ったのですがUnity では、エディタ再起動しないと、ネイティブプラグインが再読み込みされないという仕様(?)になっているようです。<br>
Rust側でビルドしなしているのに変更が反映されない、という現象にずいぶん嵌ってしまいました &gt;&lt;</p>

<h2>
<span id="感想" class="fragment"></span><a href="#%E6%84%9F%E6%83%B3"><i class="fa fa-link"></i></a>感想</h2>

<p>だいたいこんなかんじです。</p>

<p>やはり、多言語をまたいでしまうと、お互いにインターフェイスを定義するところが若干面倒です。<br>
( 機械的に生成するとかのアプローチは可能だと思いますが )</p>

<p>あとは、Rustだけだとアルゴリズムのビジュアライズができないので、とりあえず Unity で動いているようすを可視化してみよう、といったワークフローになったんですが、ネイティブプラグインの再読み込みのために、Unityの再起動が必要だったりする残念な仕様のせいでこのままだと効率が悪そう……。</p>

<p>ただ、やはりRustのcargoなどのツールは優れていて、ビルドまわりは楽なので、ネイティブプラグインの敷居がかなり下がったように感じました。用途によってはかなり可能性を感じます。</p>

<p>(思いつき)<br>
たとえば、シリアライザの実装をRustに持っていってしまうとかも、もしかしたら良いかもしれません。<br>
Rust には、実行時のリフレクション等を必要とせず、マクロによる事前のコード展開によって自動的に実装できる便利なシリアライザ (serde) があります。<br>
一方、C#でのシリアライザの実装は、実行時に初回だけリフレクションをつかい、ILコードを生成するといったスマートなテクニックが使われていますが、Unityではプラットフォームによってはリフレクションが動かなかったりするせいで、事前にC#コードを生成するといった借地がとられることがあり、ちょっとそういうのが煩雑ですし、パフォーマンスもRustのほうに優位さがありそうです(未検証)</p>

<p>そんなかんじです。気が向いたら引き続きRustとUnityで遊んでみようとおもいます。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FhadashiA%2Fitems%2F3755786e95bbcd8f3b5d&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FhadashiA%2Fitems%2F3755786e95bbcd8f3b5d&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/hadashiA/items/3755786e95bbcd8f3b5d/likers" class="css-1iupg5d">71</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">49</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/3755786e95bbcd8f3b5d/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/hadashiA/items/3755786e95bbcd8f3b5d/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/hadashiA/items/3755786e95bbcd8f3b5d/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/hadashiA/items/3755786e95bbcd8f3b5d/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/hadashiA/items/3755786e95bbcd8f3b5d.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-039d367f-c918-49f0-a970-9259b1857e80">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-fefd2020-5a64-43bd-b3b0-cab9ba21b74f"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-fefd2020-5a64-43bd-b3b0-cab9ba21b74f">{}</script>
      
<div id="LoginModal-react-component-b6b6ab6e-4c47-4061-97e7-18c2e192eab8"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-b6b6ab6e-4c47-4061-97e7-18c2e192eab8">{}</script>
      
<div id="StockModal-react-component-47c7bd37-2dd0-4d15-b97a-9a55493588e5"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-47c7bd37-2dd0-4d15-b97a-9a55493588e5">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;xzWB6/7NBpl1+dtlu8nRz7sWgaRQ+fhhLHJD79yOHAYLQLqiu8RqTGefSG0/zglk/y69YXZ9SIs8eHjABHWsww==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003eUnity (ゲームエンジン) から Rust で書いたネイティブバイナリを実行する、という行為を試してみました。\u003cbr\u003e\nサンプルコードは \u003ca href=\"https://github.com/hadashiA/unigeo\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこちら\u003c/a\u003e。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"なぜrust-\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AA%E3%81%9Crust-\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eなぜRust ?\u003c/h2\u003e\n\n\u003cp\u003e以前、Unity上で、C#でプログラマブルに任意の形状のメッシュを生成するといったことをやってみました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/4f56cc5b53c650126f687760c7953e65e992ad54/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f353835392f36613338373937392d646539652d366138622d353335622d3461623964306563663535332e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F5859%2F6a387979-de9e-6a8b-535b-4ab9d0ecf553.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c82f819d0145a5f6c75dab3de9ff1bb3\" alt=\"demo_small.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/5859/6a387979-de9e-6a8b-535b-4ab9d0ecf553.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F5859%2F6a387979-de9e-6a8b-535b-4ab9d0ecf553.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=56c7b89305b8c5bc413ded2d1de0e23c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e( たとえばこういうふうに、実行中に入力から任意の形状を生成して、メッシュにして描画できると楽しい )\u003c/p\u003e\n\n\u003cp\u003eしかし、三角形分割などの幾何アルゴリズムをC#で素朴に実装してみたところ、本に載っているような計算量少なめのアルゴリズムに則ったとしても、(むしろ則ったせいで)、GCゴミの発生を抑えることの難易度がかなり高いな、という感想を持ちました。\u003c/p\u003e\n\n\u003cp\u003eこういう類のアルゴリズムは、計算途中の辺や点、面の情報を参照として持ち、それらの空間的なつながりの情報を可変長のコレクションに入れて管理するといったことがどうしても頻出するのではないかと思います。\u003cbr\u003e\nある種の向きや順番を表現できて、重複や循環も表現できるデータ構造もよく使われているようです。たとえば二重連結辺リスト (DCEL - Double Connected Edge List) と呼ばれるようなものがあります。\u003c/p\u003e\n\n\u003cp\u003e結果として、アルゴリズムを実行するある過程では必要なんだけど、終わったら必要なくなるような、外からは見えない一時的なヒープアロケーションを避けるのが難しい、あるいは避けるのが面倒なことになりがちでした。\u003c/p\u003e\n\n\u003cp\u003eC#では、GC管理対象のメモリ確保をぽんぽん毎フレームなどの高い頻度で実行しまくると、パフォーマンス劣化につながることは間違いないため、どうにか避けたいところ。\u003c/p\u003e\n\n\u003cp\u003eもちろん、オブジェクトをプーリングして使いまわすとか、一度確保したバッファは使いまわすとか、テクニックは色々考えられると思いますが、まず正しく動かすことも苦労する実装をしている局面だと、そいういう気遣いを見せるのはなかなか大変です。漏れやミスも出てきそうです。\u003c/p\u003e\n\n\u003cp\u003eそこで、実験というか半分遊びですが、メッシュ生成みたいなものは、Rust で実装してしまえば良いんちゃうか ? ということを思いつきました。\u003c/p\u003e\n\n\u003cp\u003eこれは、Unity の UI のソースを読んでいたところ、メッシュ生成やレイアウト計算などの肝心な部分がほとんどネイティブコードに埋められてブラックボックスになっているのを見かけて得たアイデアです。\u003c/p\u003e\n\n\u003cp\u003eUnity の低レイヤは c++ で実装されているそうですが、現在の僕たちにはRustという選択肢もあります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eRust の実行速度は c++ と同等\u003c/li\u003e\n\u003cli\u003e主要なOSやスマホ向けのクロスコンパイルも標準ツールでサポート\u003c/li\u003e\n\u003cli\u003eプラットフォーム固有の微妙なAPI載違いをほとんど意識することがない\u003c/li\u003e\n\u003cli\u003eモダンなパッケージマネージャも搭載\u003c/li\u003e\n\u003cli\u003eGC がない\n\n\u003cul\u003e\n\u003cli\u003eヒープアロケーションそのものはもちろん安くはないはずですが、何も考えずに実装した場合、Rustにするだけで、GCによってたまに全スレッドが遅くなるといった類の問題は緩和しそうという期待がある (未検証)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eそこで、実験的に、Rust でメモリの取得/解放を含めてアルゴリズムを実装して、 Unity から呼び出す、という行為を試してみました。\u003c/p\u003e\n\n\u003cp\u003e今回のサンプルは、とりあえず試しに、キャットムル-ロム曲線の計算をRustで実装してUnityから呼び出す、というだけの内容です。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/4cf2a9741f0bb8e3f952db6d8f57843c1767d1cd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f353835392f33656131326434372d643236322d353239642d303032382d3665613231633062386532302e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F5859%2F3ea12d47-d262-529d-0028-6ea21c0b8e20.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=07d34295fbd10de9d87f3c7e818f4d05\" alt=\"5cfe24463e793aff231ec40868fa22c5.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/5859/3ea12d47-d262-529d-0028-6ea21c0b8e20.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F5859%2F3ea12d47-d262-529d-0028-6ea21c0b8e20.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=ba9276de494493b6aed5490354822ef2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e↑UnityからRustで実装したライブラリを呼び出し、Gizmoで可視化しているようすです。\u003cbr\u003e\n白い点=制御点を与えると、青い線=それらを通過する曲線 の座標を計算する、という部分がRustで動いています。\u003c/p\u003e\n\n\u003cp\u003e中身はこれだけけですがコードは \u003ca href=\"https://github.com/hadashiA/unigeo\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこれ\u003c/a\u003e です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"rust-と-c-のバインディング\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#rust-%E3%81%A8-c-%E3%81%AE%E3%83%90%E3%82%A4%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRust と C# のバインディング\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"rust-側\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#rust-%E5%81%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRust 側\u003c/h3\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"cargotoml\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#cargotoml\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCargo.toml\u003c/h4\u003e\n\n\u003cp\u003eCargo.toml に以下の設定を足すことで、ビルドする対象をネイティブの動的リンクライブラリに変更します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"toml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eCargo.toml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"py\"\u003ecrate-type\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nn\"\u003e[\"dylib\"]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"外の世界から呼ぶための関数\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A4%96%E3%81%AE%E4%B8%96%E7%95%8C%E3%81%8B%E3%82%89%E5%91%BC%E3%81%B6%E3%81%9F%E3%82%81%E3%81%AE%E9%96%A2%E6%95%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e外の世界から呼ぶための関数\u003c/h4\u003e\n\n\u003cul\u003e\n\u003cli\u003eRust の関数に \u003ccode\u003epub extern\u003c/code\u003e をつけてあげて、外からリンクできるインターフェイスの関数をつくります。\u003c/li\u003e\n\u003cli\u003eRustを知らない別言語から参照できるように、\u003ccode\u003e#[no_mangle]\u003c/code\u003e 属性をつけます\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"rust\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// 例\u003c/span\u003e\n\u003cspan class=\"nd\"\u003e#[no_mangle]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epub\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"k\"\u003efn\u003c/span\u003e \u003cspan class=\"nf\"\u003ehoge\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"nb\"\u003ei32\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"mi\"\u003e100\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこの状態でビルドしてみると、\u003ccode\u003etarget/\u003c/code\u003e 以下に \u003ccode\u003elib\u0026lt;crate名\u0026gt;.dylib\u003c/code\u003e というバイナリができあがり、 \u003ccode\u003ehoge\u003c/code\u003e というシンボルが出力されていることが確認できました。(macOSの場合)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e⟩ nm -gU target/debug/libunigeo.dylib | grep hoge\n00000000000083c0 T hoge\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"rustの外へ構造体を渡す受け取る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#rust%E3%81%AE%E5%A4%96%E3%81%B8%E6%A7%8B%E9%80%A0%E4%BD%93%E3%82%92%E6%B8%A1%E3%81%99%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRustの外へ構造体を渡す/受け取る\u003c/h4\u003e\n\n\u003cp\u003eRustで定義した構造体を外とやりとりする場合は、 structの定義に \u003ccode\u003e#[repr(C)]\u003c/code\u003e 属性をつけておきます。\u003cbr\u003e\nこうすることで、メモリ上のレイアウトが C で書いた場合と同様になってくれるそうです。便利です。( c言語自体がもはや共通のバイナリのインターフェイスかのようなノリですね)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"rust\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nd\"\u003e#[repr(C)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epub\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nb\"\u003ef32\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nb\"\u003ef32\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eRustの外の別の言語側でも、全く同じメモリレイアウトの構造体の定義さえあれば、Rust側で関数の引数として受け止ったり、返したりすることができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"rust\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// 例。 上で定義したAという構造体をつかう\u003c/span\u003e\n\u003cspan class=\"nd\"\u003e#[no_mangle]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epub\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"k\"\u003efn\u003c/span\u003e \u003cspan class=\"nf\"\u003ea_new\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"py\"\u003e.a\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mf\"\u003e100.0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"py\"\u003e.b\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mf\"\u003e200.0\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"rust側で確保した変数のポインタを外へ返す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#rust%E5%81%B4%E3%81%A7%E7%A2%BA%E4%BF%9D%E3%81%97%E3%81%9F%E5%A4%89%E6%95%B0%E3%81%AE%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%82%92%E5%A4%96%E3%81%B8%E8%BF%94%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRust側で確保した変数のポインタを外へ返す\u003c/h4\u003e\n\n\u003cp\u003e今回は、ヒープアロケーションをRust側へ持っていくというモチベーションがあったため、Rust側でヒープに確保した変数のポインタを外側へ渡したり、受けとったりするということもやってみました。\u003c/p\u003e\n\n\u003cp\u003e外側にポインタを返す場合、まず、寿命を任意の長さにするため、 \u003ccode\u003eBox::new\u003c/code\u003e でボクシングしてあげます。\u003c/p\u003e\n\n\u003cp\u003e次に、確保した Box に対して、\u003ccode\u003eBox::into_raw\u003c/code\u003e を呼び出すことによって、生ポインタをつくってあげます。\u003cbr\u003e\nここで、into_raw によってBoxは消費され、このとき、できあがった生ポインタはRustのメモリ管理対象から外れています。 \u003ccode\u003eBox::into_raw\u003c/code\u003e したポインタに対しては、手動でメモリを解放する責任が生じることに、注意です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"rust\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nd\"\u003e#[no_mangle]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epub\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"k\"\u003efn\u003c/span\u003e \u003cspan class=\"nf\"\u003ecatmull_rom_spline_new\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclosed\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nb\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"k\"\u003emut\u003c/span\u003e \u003cspan class=\"n\"\u003eCatMullRomSpline\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003espline\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nn\"\u003eCatMullRomSpline\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclosed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003espline\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nn\"\u003eBox\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espline\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"nn\"\u003eBox\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"nf\"\u003einto_raw\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eというわけで、ポインタの破棄を外から叩けるように、用意しておきましょう。、\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eBox::from_raw\u003c/code\u003e をすると、生ポインタをもう一度 Rustの管理対象のBox に変換します。\u003cbr\u003e\nこれをdropすれば後片付けは完了です。\u003cbr\u003e\n( とくに明示的になにもしなくても、moveせずにスコープを抜けるとdropします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"rust\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nd\"\u003e#[no_mangle]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epub\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"k\"\u003efn\u003c/span\u003e \u003cspan class=\"nf\"\u003ecatmull_rom_spline_drop\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espline\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"k\"\u003emut\u003c/span\u003e \u003cspan class=\"n\"\u003eCatMullRomSpline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nn\"\u003eBox\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"nf\"\u003efrom_raw\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e外からポインタを受けとり、それに対してメソッドを呼び出す例は以下のようなかんじになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"rust\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nd\"\u003e#[no_mangle]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epub\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"k\"\u003efn\u003c/span\u003e \u003cspan class=\"nf\"\u003ecatmull_rom_spline_add_control_point\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espline\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003eCatMullRomSpline\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eVec3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003espline\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;*\u003c/span\u003e\u003cspan class=\"n\"\u003espline\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n    \u003cspan class=\"n\"\u003espline\u003c/span\u003e\u003cspan class=\"nf\"\u003e.add_control_point\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれでだいたい外側からRustのコードをつかうことができそうです。\u003c/p\u003e\n\n\u003cp\u003eインターフェイスの定義が面倒なので、マクロとかにするのが良いかも\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"unity-側\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unity-%E5%81%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUnity 側\u003c/h3\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"ネイティブプラグイン\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%8D%E3%82%A4%E3%83%86%E3%82%A3%E3%83%96%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eネイティブプラグイン\u003c/h4\u003e\n\n\u003cp\u003eUnity には、 ネイティブバイナリを動的リンクして呼び出す仕組みが搭載されているので、それをつかいます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.unity3d.com/Manual/NativePlugins.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnity - Manual: Native plug-ins\u003c/a\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eプロジェクトの任意の場所に \u003ccode\u003ePlugins/\u003c/code\u003e ディレクトリをつくるとその下は特別扱いされ、ネイティブバイナリをロードしてくれます\u003c/li\u003e\n\u003cli\u003eプラットフォームごと、たとえば macOSであれば、 \u003ccode\u003ePlugins/macOS\u003c/code\u003e ディレクトリをつくり、Rustでビルドしたバイナリを置きます。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"dllimport\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dllimport\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDllImport\u003c/h4\u003e\n\n\u003cp\u003ec# 側では、\u003ccode\u003eDllImport\u003c/code\u003e 属性で c# としてのインターフェイス定義を書いてあげることで、ネイティブバイナリの中の関数を呼びだすことができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eDllImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"libunigeo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"nf\"\u003ecatmull_rom_spline_new\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eclosed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"sturctのレイアウト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#sturct%E3%81%AE%E3%83%AC%E3%82%A4%E3%82%A2%E3%82%A6%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003esturctのレイアウト\u003c/h4\u003e\n\n\u003cp\u003e\u003ccode\u003e[repr(C)]\u003c/code\u003e な構造体と同じメモリレイアウトの型を C# 側で定義するためには、C#の \u003ccode\u003e[StructLayout]\u003c/code\u003e 属性を以下のようにするといけるようです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eStructLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLayoutKind\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSequential\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eA\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eちなみに、Unity の\u003ccode\u003eVector3\u003c/code\u003e も、Rust の \u003ccode\u003e#[repr(C)]\u003c/code\u003e をつけた float 3つの構造体と一致させることができました。Unityのこの辺の型は実装がc#ではなくc++側にあるらしいですが、必ず \u003ccode\u003e#[repr(C)]\u003c/code\u003e 相当になると考えて良いのかよくわかってません \u003cimg alt=\":thinking:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/1f914.png\" title=\":thinking:\" width=\"20\" loading=\"lazy\"\u003e \u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"disposable-pattern\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#disposable-pattern\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDisposable Pattern\u003c/h4\u003e\n\n\u003cp\u003eC#側では、IDisposableを実装して、非マネージドなリソースの解放が必要であることを明示するのが驚きがないとおもいます。さらに、メモリ解放を忘れないように Disposable パターン で 明示的な解放がない場合もファイナライザによって Dispose が呼ばれるようにしておくと安心です。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/standard/garbage-collection/implementing-dispose\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDispose メソッドの実装 | Microsoft Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCatmullRomSplineRust\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ...\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003edisposed\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eCatmullRomSplineRust\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eclosed\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBindings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ecatmull_rom_spline_new\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclosed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e                   \n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e \n            \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSuppressFinalize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e           \n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003edisposing\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edisposed\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \n\n            \u003cspan class=\"n\"\u003eBindings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ecatmull_rom_spline_drop\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edisposed\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"実行時のエラー\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A1%8C%E6%99%82%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実行時のエラー\u003c/h4\u003e\n\n\u003cp\u003eUnity では、ネイティブプラグイン側がエラーになると、プロセスがクラッシュするというド派手な挙動をするようになっていて、どきどきしてしまいますが、ログファイルをみにいくと Rust のエラーをちゃんと読むことができます\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e thread '\u0026lt;unnamed\u0026gt;' panicked at 'attempt to subtract with overflow', src/spline.rs:60:58\n note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\n fatal runtime error: failed to initiate panic, error 5\n [Unity Package Manager (Upm)]\n Parent process [29918] was terminated\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"ネイティブプラグインのリロード\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%8D%E3%82%A4%E3%83%86%E3%82%A3%E3%83%96%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%81%AE%E3%83%AA%E3%83%AD%E3%83%BC%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eネイティブプラグインのリロード\u003c/h4\u003e\n\n\u003cp\u003e今回はじめて知ったのですがUnity では、エディタ再起動しないと、ネイティブプラグインが再読み込みされないという仕様(?)になっているようです。\u003cbr\u003e\nRust側でビルドしなしているのに変更が反映されない、という現象にずいぶん嵌ってしまいました \u0026gt;\u0026lt;\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"感想\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%84%9F%E6%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e感想\u003c/h2\u003e\n\n\u003cp\u003eだいたいこんなかんじです。\u003c/p\u003e\n\n\u003cp\u003eやはり、多言語をまたいでしまうと、お互いにインターフェイスを定義するところが若干面倒です。\u003cbr\u003e\n( 機械的に生成するとかのアプローチは可能だと思いますが )\u003c/p\u003e\n\n\u003cp\u003eあとは、Rustだけだとアルゴリズムのビジュアライズができないので、とりあえず Unity で動いているようすを可視化してみよう、といったワークフローになったんですが、ネイティブプラグインの再読み込みのために、Unityの再起動が必要だったりする残念な仕様のせいでこのままだと効率が悪そう……。\u003c/p\u003e\n\n\u003cp\u003eただ、やはりRustのcargoなどのツールは優れていて、ビルドまわりは楽なので、ネイティブプラグインの敷居がかなり下がったように感じました。用途によってはかなり可能性を感じます。\u003c/p\u003e\n\n\u003cp\u003e(思いつき)\u003cbr\u003e\nたとえば、シリアライザの実装をRustに持っていってしまうとかも、もしかしたら良いかもしれません。\u003cbr\u003e\nRust には、実行時のリフレクション等を必要とせず、マクロによる事前のコード展開によって自動的に実装できる便利なシリアライザ (serde) があります。\u003cbr\u003e\n一方、C#でのシリアライザの実装は、実行時に初回だけリフレクションをつかい、ILコードを生成するといったスマートなテクニックが使われていますが、Unityではプラットフォームによってはリフレクションが動かなかったりするせいで、事前にC#コードを生成するといった借地がとられることがあり、ちょっとそういうのが煩雑ですし、パフォーマンスもRustのほうに優位さがありそうです(未検証)\u003c/p\u003e\n\n\u003cp\u003eそんなかんじです。気が向いたら引き続きRustとUnityで遊んでみようとおもいます。\u003c/p\u003e\n","createdAt":"2019-09-11T16:09:21Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"wcW87v5MaTsnxrvaXl64XF+dFnCfOizy1Q==--R/iPocy+nR4rREJX--4URDK4ngnVC3DIELDIs3IA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-09-15T16:42:07Z","likesCount":71,"linkUrl":"https://qiita.com/hadashiA/items/3755786e95bbcd8f3b5d","organization":null,"originalId":1016710,"stockedCount":49,"title":"Rustで実装したアルゴリズムをUnityから使う","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AA%E3%81%9Crust-\"\u003eなぜRust ?\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#rust-%E3%81%A8-c-%E3%81%AE%E3%83%90%E3%82%A4%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0\"\u003eRust と C# のバインディング\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#rust-%E5%81%B4\"\u003eRust 側\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#cargotoml\"\u003eCargo.toml\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A4%96%E3%81%AE%E4%B8%96%E7%95%8C%E3%81%8B%E3%82%89%E5%91%BC%E3%81%B6%E3%81%9F%E3%82%81%E3%81%AE%E9%96%A2%E6%95%B0\"\u003e外の世界から呼ぶための関数\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#rust%E3%81%AE%E5%A4%96%E3%81%B8%E6%A7%8B%E9%80%A0%E4%BD%93%E3%82%92%E6%B8%A1%E3%81%99%E5%8F%97%E3%81%91%E5%8F%96%E3%82%8B\"\u003eRustの外へ構造体を渡す/受け取る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#rust%E5%81%B4%E3%81%A7%E7%A2%BA%E4%BF%9D%E3%81%97%E3%81%9F%E5%A4%89%E6%95%B0%E3%81%AE%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%82%92%E5%A4%96%E3%81%B8%E8%BF%94%E3%81%99\"\u003eRust側で確保した変数のポインタを外へ返す\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unity-%E5%81%B4\"\u003eUnity 側\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%8D%E3%82%A4%E3%83%86%E3%82%A3%E3%83%96%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3\"\u003eネイティブプラグイン\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#dllimport\"\u003eDllImport\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#sturct%E3%81%AE%E3%83%AC%E3%82%A4%E3%82%A2%E3%82%A6%E3%83%88\"\u003esturctのレイアウト\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#disposable-pattern\"\u003eDisposable Pattern\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A1%8C%E6%99%82%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC\"\u003e実行時のエラー\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%8D%E3%82%A4%E3%83%86%E3%82%A3%E3%83%96%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%81%AE%E3%83%AA%E3%83%AD%E3%83%BC%E3%83%89\"\u003eネイティブプラグインのリロード\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%84%9F%E6%83%B3\"\u003e感想\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":7530,"uuid":"3755786e95bbcd8f3b5d","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"0rWer8ph0ew/LFcWxHT1xZen5g==--Cp1UHJZjpyvigJAT--doLxit/I86fU3PlhMWA7mw==","originalId":5859,"description":"フリーランスプログラマだよ","facebookUrl":null,"githubUrl":"https://github.com/hadashiA","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/5859/profile-images/1473682324","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F5859%2Fprofile-images%2F1473682324?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=2628fcfe4e01546b4557ce34887fcfca","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F5859%2Fprofile-images%2F1473682324?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=b16e8286e5c3272bad99dc3238e293cd","urlName":"hadashiA","websiteUrl":"https://twitter.com/hadashiA","twitterUrl":"https://twitter.com/hadashiA","twitterUrlName":"hadashiA","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Rust","urlName":"rust"},{"name":"Unity","urlName":"unity"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
