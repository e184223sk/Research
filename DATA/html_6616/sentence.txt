More than 3 years have passed since last update.Livetを使ってWPFでファイルドロップする方法を示す。
一応LivetなのでMVVMというよりコードビハインドなしでやること。
livetの紹介
http://ugaya40.hateblo.jp/entry/LivetBehaviorとは何？って人にはわからない内容です。
ViewModelはVMと省略して記載します。4つの方法で実装できた。
1.Behaviorに依存プロパティをつけVMの変数とバインド
2.Behaviorに依存プロパティをつけVMにはLivetCallMethodActionで通知
3.Behaviorに依存プロパティをつけVMにはIntertfaceを使う
4.添付プロパティをつけVMにはIntertfaceを使うすべてDropされたファイル名をListBoxに表示するようにしています。
ListBoxのItemsSourceにObservableCollectionの変数をバインドしてます。VMにドロップされたファイル(string[])の変数を作って
Behaviorのドロップされたファイル(string[])の依存プロパティとバインドさせるまずはBehavior
PreviewDragEnterとDropのイベントを購読して
ドロップされたファイルを受け取る&amp;VMに渡す用の変数を依存プロパティで作る。(DropFilesProperty)続いてxaml
ポイントはDropFiles="{Binding DropFilesA1}" で
ここでVMのドロップされたファイルを保持する変数とバインドすることVMはドロップされたファイルを受け取るstring[]を持たせて
変更時にListにファイルを追加する感じに書くBehavior自体は1と同じです。
Behaviorにドロップされたファイル(string[])の依存プロパティを持ち
LivetCallMethodActionでそのファイルをVMに通知するBehavior自体は1と同じなので省略xaml
ポイントはl:LivetCallMethodActionのMethodParameterにドロップされたファイルを渡すこと。
MethodParameter="{Binding ElementName=FileDropBehaviorA, Path=DropFiles}"
↑を書くためにと
名前を付けるVM
ItemsA2はObservableCollectionで1.のやり方と一緒なので省略
l:LivetCallMethodActionで定義した名前のpublic関数の引数に(string[] files)を入れる
xamlでBehaviorに追加したプロパティをbindするファイルドロップされたときの処理用のInterfaceを作り
それを依存プロパティでもったBehaviorを作るまずはinterfaceBehavior
ポイントはFileDropHandlerPropertyを作り
Dropされたときに実行するようにすること
this.FileDropHandler?.Drop(e.Data.GetData(DataFormats.FileDrop) as string[]);
これはxamlでbindされていないときはnullで実行されない続いてxaml
FileDropHandler="{Binding}"がポイント最後にVM
VMに作ったinterfaceを継承させる
ドロップされた時の関数を実装する
ItemsBはObservableCollectionで1.のやり方と一緒なので省略3.の添付プロパティ版まずはinterface内容は3.のと一緒Behavior
ポイントはFileDropHandlerPropertyを作り
Dropされたときに実行するようにすること
GetFileDropHandler(sender as UIElement)?.Drop(e.Data.GetData(DataFormats.FileDrop) as string[]);
これはxamlでbindされていないときはnullで実行されない
イベントの購読自体は依存プロパティ作成時にコールバックを追加してそこの中でやること。
つまりOnFileDropHandlerChanged内でイベントの購読開始
でもこれってイベント購読解除はどこに書くんだ？続いてxaml
 v:FileDropBehaviorC.FileDropHandler="{Binding}" Header="FileDropC"がポイント
添付プロパティなので中に書く最後にVM
ここは3.と一緒依存プロパティと添付プロパティとかわけわからんだとイミフだと思うけど
Behaviorに変数をバインドさせるには依存プロパティが必要。ほかのプロパティではNG
独立させて作りたい場合は添付プロパティでやるって感じの感覚で使えば怖くない！一応ソースは↓
https://github.com/kskhsn/BehaviorSample


