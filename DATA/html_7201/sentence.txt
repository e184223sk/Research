More than 5 years have passed since last update.データベースのレコードにCreatedAt（作成日）やUpdatedAt（更新日）などのフィールドを持たせることがあるかと思います。NHibernateにはレコードの挿入や更新などのイベント発生時に指定した処理をさせる機構があるので、それを活用することでCreatedAtやUpdatedAtなどのフィールドを自動的に更新させることができます。挿入・更新などのイベントハンドラは、IPreInsertEventListenerやIPreUpdateEventListenerを継承したクラス内に記述します。
そのイベントハンドラクラスのインスタンスをNHibernateConfiguration.EventListenersの
PreInsertEventListenersやPreUpdateEventListenersに登録することで、イベントハンドラが呼ばれるようになります。作成日や更新日を保存するのに利用するプロパティは独自のCustom Attributeを設定することで指定します。挿入・更新時に自動的に値を設定するフィールドをマークアップするのに利用するCustom Attributeです。上で定義したAutofillCurrentDateTimeOnInsertAttribute AutofillCurrentDateTimeOnUpdateAttributeが設定されているプロパティで、かつ、DateTimeOffset型のプロパティだったとき、それらのプロパティの値を自動的に設定するように記述しています。Fluent NHibernateの場合、次のような形で登録することになると思います。モデル側では上で定義したAttributeを付与するだけです。
例えば、以下の例では、CreatedAtはレコードが作成されたとき、UpdatedAtはレコード作成と更新があったときにNHibernateによって自動的に現在時刻が設定されるようになります。今回はCustom Attributeでマークアップすることで対象のプロパティを特定していましたが、『ITimestampableなど独自インターフェイスを実装しているクラスだけ対象にする』『CreatedAtという名前のプロパティを対象にする』というような実装も可能です。


