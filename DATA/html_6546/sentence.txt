More than 3 years have passed since last update.「空のプロジェクトからASP.NET MVC5 EntityFramework6 for Oracleを試す(登録・更新・削除)」の続きで既にテーブルがある既存アプリケーションをASP.NET MVCで再構築する場合、どうやればいいのか。MVCの特徴の１つでもあるORマッパーは使用せずに、SQL文を直接実行したい。また、接続文字列を動的に変更したい。会社では運用チームに属していて、各県にある30近い工場の運用作業を行っている。導入作業などでは、稼働しているかどうかを実績データを参照し、しばらく実績データの更新状態が無いことを確認してから作業をしている。
各工場の接続文字列を動的に変更し、実績データの最終更新日時を取得を行いたい。よって、ORマッパーは不要でありSQL文でデータを取得する。【2018/03/25追記】
EntityFramework でスキーマが切り替わらない - MSDNフォーラムこの記事のサンプルは、ホストは違うもののスキーマ名は同一となっている。
上記質問でOnModelCreatingメソッドのHasDefaultSchemaでスキーマ名を動的に変えれば出来るのはと思ったけど、OnModelCreatingメソッドは派生コンテキストの最初のインスタンスの作成時に一度だけ呼び出されるので、そこで変更してもキャッシュ使用されて動的にスキーマを変更しても切り替わらない。質問がEF Core になっている中で回答にはEF6が含まれているので動的にスキーマを変更のヒントにはなるかと思います。Web.config に必要な分の接続文字列を記述する。
接続データとして、192.168.64.190と192.168.64.173の2つのホストを想定し、接続文字列(Context190とContext173)を2つ記述している。接続文字列を切り替えるために、StandardContext(string nameOrConnectionString)を追記します。new StandardContext(接続文字列)の引数に接続文字列(Context190とContext176)のいずれかを指定し、SQL文で更新日時を取得してDataTable型に格納する。
※本来はコントローラーにモデルの内容を入れるべきではないが、これはサンプルなので。Web.config は使用しない。接続文字列を動的生成した後の接続用にStandardContext(DbConnection connection) を追記します。接続文字列の違いは、ホストIPだけなので接続文字列を動的に生成して簡単に切り替えれるようにしておく。
※本来はコントローラーにモデルの内容を入れるべきではないが、これはサンプルなので。方法１のWeb.config に必要な分の接続文字列を設定した状態で作成していく。方法１のstandardContext.cs に下記のクラスを追加する。参照：ASP.NET MVC 5 でドロップダウンリストを使用する – ViewModel 編ドロップダウンリストのセットとPost後のアクションを設定する。今回は仕組みを理解しつつ簡易的に作成したものなので、実際には実績テーブル数も多くシステムごとにも振り分けたい。


