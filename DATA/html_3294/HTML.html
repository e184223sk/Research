<!DOCTYPE html><html><head><meta charset="utf-8" /><title>FluentMigratorでデータベースマイグレーションを行う(dotnet) - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/skitoy4321/items/ba294a3ae35b617d207f" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="qVqxQWViK9wavgzYJFkjw1m7MMS2AohQamqnQ7y4tjpzEXBPi/naUC/19prqICCZSlz7J5PDUCTKoFCE5+C1RQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@skitoy4321" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="FluentMigratorでデータベースマイグレーションを行う(dotnet) - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1SbXgxWlc1MFRXbG5jbUYwYjNMamdhZmpnNGZqZzd6amdyX2pnNW5qZzd6amdybmpnNTdqZ3FUamdyRGpnNnpqZzd6amdyZmpnNmZqZzdQamdwTG9vWXpqZ1lZb1pHOTBibVYwS1EmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZmM1MWRkNTYwYTZhZTc3MWNmNGM4YTk1NWRhMDg0NmU&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=a50f7fe90cac6bfa584ccfe36e9a3b4e"><meta property="og:description" content="

はじめに

まず、ここでいうデータベースマイグレーションとは、アプリケーションで使うためのデータベーススキーマとデータを
作成するという意味(Ruby on Railsのアレ)としておく。


dotnet系プロジェクトにおけるデ..."><meta content="https://qiita.com/skitoy4321/items/ba294a3ae35b617d207f" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,migration,Database,dotnet" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-6abb4519-13ee-41a9-9387-788ef770860a"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fskitoy4321%2Fitems%2Fba294a3ae35b617d207f">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fskitoy4321%2Fitems%2Fba294a3ae35b617d207f">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-6abb4519-13ee-41a9-9387-788ef770860a">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-05-31T23:42:11.000+09:00","dateModified":"2019-06-04T09:03:09.000+09:00","headline":"FluentMigratorでデータベースマイグレーションを行う(dotnet)","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1SbXgxWlc1MFRXbG5jbUYwYjNMamdhZmpnNGZqZzd6amdyX2pnNW5qZzd6amdybmpnNTdqZ3FUamdyRGpnNnpqZzd6amdyZmpnNmZqZzdQamdwTG9vWXpqZ1lZb1pHOTBibVYwS1EmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZmM1MWRkNTYwYTZhZTc3MWNmNGM4YTk1NWRhMDg0NmU\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=a50f7fe90cac6bfa584ccfe36e9a3b4e","mainEntityOfPage":"https://qiita.com/skitoy4321/items/ba294a3ae35b617d207f","author":{"@type":"Person","address":"","email":null,"identifier":"skitoy4321","name":"skitoy4321","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","url":"https://qiita.com/skitoy4321","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">自己組織化されたユーザベースSaaS Product Teamが面白い理由</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"ba294a3ae35b617d207f"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"自己組織化されたユーザベースSaaS Product Teamが面白い理由","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"ba294a3ae35b617d207f"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"自己組織化されたユーザベースSaaS Product Teamが面白い理由","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"ba294a3ae35b617d207f"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"自己組織化されたユーザベースSaaS Product Teamが面白い理由","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/skitoy4321/items/ba294a3ae35b617d207f","location":"/skitoy4321/items/ba294a3ae35b617d207f","scheme":"https","host":"qiita.com","port":null,"pathname":"/skitoy4321/items/ba294a3ae35b617d207f","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"TJUYHAShZg8T6gQ+qEAIub22Tazhs6UOw4BUQmQrXNqW3tkS6jqXgyah/nxmOQvjrlGGT8RyfXpjSqOFP3NfpQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-39065548-9b0a-4456-ba63-947a21237e32"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/ba294a3ae35b617d207f/likers" class="css-1iupg5d">9</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">8</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/ba294a3ae35b617d207f/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/ba294a3ae35b617d207f/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/ba294a3ae35b617d207f/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/ba294a3ae35b617d207f/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/ba294a3ae35b617d207f.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/skitoy4321"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/skitoy4321" class="css-10ougpm">@<!-- -->skitoy4321</a><div class="css-1ay9vb9"><span><meta content="2019-05-31T14:42:11Z"/><time dateTime="2019-06-04T00:03:09Z" class="css-m19uds">updated at 2019-06-04</time></span></div></div></div></div></div><h1 class="css-cgzq40">FluentMigratorでデータベースマイグレーションを行う(dotnet)</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/migration" class="css-4czcte">migration</a><a href="/tags/database" class="css-4czcte">Database</a><a href="/tags/dotnet" class="css-4czcte">dotnet</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>まず、ここでいうデータベースマイグレーションとは、アプリケーションで使うためのデータベーススキーマとデータを<br>
作成するという意味(Ruby on Railsのアレ)としておく。</p>

<h1>
<span id="dotnet系プロジェクトにおけるデータベースマイグレーション" class="fragment"></span><a href="#dotnet%E7%B3%BB%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>dotnet系プロジェクトにおけるデータベースマイグレーション</h1>

<p>dotnet系プロジェクトでのデータベースマイグレーションというと、真っ先に思いつくのが<a href="https://docs.microsoft.com/en-us/ef/core/" rel="nofollow noopener" target="_blank">Entity Framework Core(EFCore)</a>によるものだろう。<br>
実際多くの場合で、EFCoreを使えば問題は無い。<br>
だが、筆者の場合、クエリはほぼDapper経由で出しているため、クエリビルダ等は必要なく、欲しいものはマイグレーションのみとなる。<br>
マイグレーションのみの用途となると、EFCoreは大がかりに見えて、個人的にはちょっと扱いにくいなと思った。</p>

<p>そこで、よりマイグレーションのみに特化したライブラリは無いものかと探して、<a href="https://fluentmigrator.github.io/" rel="nofollow noopener" target="_blank">FluentMigrator</a>を見つけた。<br>
自分にとっては丁度良い規模感だったため、今回の記事で紹介する。</p>

<h1>
<span id="fluentmigratorとは" class="fragment"></span><a href="#fluentmigrator%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>FluentMigratorとは</h1>

<p>先にも述べた通り、C#でデータベースマイグレーションを行うためのライブラリとなる。特徴としては、</p>

<ul>
<li>バージョン番号によるスキーマ管理

<ul>
<li>バージョン番号は64bit整数で自分で管理する</li>
</ul>
</li>
<li>C#でマイグレーション記述

<ul>
<li>SQL直接発行も可能</li>
</ul>
</li>
<li>複数RDBMSに対応可能

<ul>
<li>特化処理を書くことも可能</li>
</ul>
</li>
<li>各RDBのSQL実行ランタイムを必要としない

<ul>
<li>SQLServerにおけるsqlcmd、PostgreSQLにおけるpsql等</li>
<li>dotnetランタイムは必要

<ul>
<li>publishすることで制約の緩和は可能</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>となる。</p>

<h1>
<span id="使用方法" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>使用方法</h1>

<p>最初のプロジェクトを作成して、実際にデータベースに適用するまでの流れを書く。なお、FluentMigratorは、記事執筆時点での最新版である3.2.1を基準に書く。<br>
FluentMigratorはメジャーバージョンごとの変化が割と大きいので、注意すること。</p>

<p>大きく分けると、</p>

<ul>
<li>マイグレーションの作成</li>
<li>マイグレーション実行アプリの作成</li>
</ul>

<p>に分けられる。</p>

<h2>
<span id="マイグレーションプロジェクトの作成" class="fragment"></span><a href="#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>マイグレーションプロジェクトの作成</h2>

<p>まず、どのようにデータベースを作成するか(テーブル定義等)、というプロジェクトを作成する。<br>
といっても、中身は通常のC#クラスライブラリプロジェクトである。</p>

<ol>
<li>
<code>dotnet new classlib --name [プロジェクト名]</code> で雛形を作成</li>
<li>
<code>FluentMigrator</code> NuGetパッケージを追加

<ul>
<li>各RDBに対する参照は、後述のマイグレーション実行プロジェクトで追加するので必要ない</li>
</ul>
</li>
<li>マイグレーションクラスを作成</li>
</ol>

<p>マイグレーションクラスは以下のように作る。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">FluentMigrator</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">fmlib1</span>
<span class="p">{</span>
    <span class="c1">// バージョン番号をプロジェクトで一意にする</span>
    <span class="c1">// 重複があるとエラーになる</span>
    <span class="c1">// 2回目以降は、同じ番号のマイグレーションはスキップする</span>
    <span class="c1">// カスタム属性を使うとより管理しやすい</span>
    <span class="c1">// https://fluentmigrator.github.io/articles/migration/migration-attribute-custom.html</span>
    <span class="p">[</span><span class="nf">Migration</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="s">"creating schema"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CreateSchema</span> <span class="p">:</span> <span class="n">Migration</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Down</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// バージョン番号を下げるときに実行される</span>
            <span class="n">Delete</span><span class="p">.</span><span class="nf">Table</span><span class="p">(</span><span class="s">"testtable"</span><span class="p">).</span><span class="nf">InSchema</span><span class="p">(</span><span class="s">"aa"</span><span class="p">);</span>
            <span class="n">Delete</span><span class="p">.</span><span class="nf">Schema</span><span class="p">(</span><span class="s">"aa"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Up</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// バージョン番号を上げるときに実行される</span>
            <span class="n">Create</span><span class="p">.</span><span class="nf">Schema</span><span class="p">(</span><span class="s">"aa"</span><span class="p">);</span>
            <span class="n">Create</span><span class="p">.</span><span class="nf">Table</span><span class="p">(</span><span class="s">"testtable"</span><span class="p">).</span><span class="nf">InSchema</span><span class="p">(</span><span class="s">"aa"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ポイントは、</p>

<ul>
<li>publicクラスにする</li>
<li>
<code>FluentMigrator.MigrationAttribute</code>をクラスに付与する

<ul>
<li>
<strong>一意になるバージョン番号を付ける</strong>

<ul>
<li>小さい値のものから実行される</li>
<li>管理が大変という場合は、<a href="https://fluentmigrator.github.io/articles/migration/migration-attribute-custom.html" rel="nofollow noopener" target="_blank">カスタム属性で一定の規則性を持たせるという手段がある</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<code>FluentMigrator.Migration</code>クラスを継承する

<ul>
<li>
<code>FluentMigrator.IMigration</code>でも認識されるが、実用上はこちらを使う方が良い</li>
</ul>
</li>
</ul>

<p>で、どれかが欠けると認識されなくなるので注意。<br>
各マイグレーションは番号で識別され、同じ番号のものは二度実行されないようになっている。</p>

<h3>
<span id="rdb種別ごとに特殊な処理を実行する" class="fragment"></span><a href="#rdb%E7%A8%AE%E5%88%A5%E3%81%94%E3%81%A8%E3%81%AB%E7%89%B9%E6%AE%8A%E3%81%AA%E5%87%A6%E7%90%86%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>RDB種別ごとに特殊な処理を実行する</h3>

<p>FluentMigratorでは、マイグレーション記述においては各RDBMSの違いを吸収できるように作られているが、ある特定のRDBの場合のみ特殊な処理をしたい(ストアドを登録したい等)時は、以下のようにする。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="c1">// SQLServer系列の場合だけ、デフォルトの文字列照合設定を変更する</span>
<span class="nf">IfDatabase</span><span class="p">(</span><span class="s">"SqlServer"</span><span class="p">)</span>
  <span class="p">.</span><span class="n">Execute</span><span class="p">.</span><span class="nf">Sql</span><span class="p">(</span><span class="s">"alter database CURRENT COLLATE Japanese_BIN"</span><span class="p">);</span>
</code></pre></div></div>

<p>ここで<code>IfDatabase()</code>の引数に何を指定できるかというと、<a href="https://fluentmigrator.github.io/" rel="nofollow noopener" target="_blank">公式ドキュメントのサポートデータベース一覧</a>の"Identifier"、または"Alternative identifier"が使える。</p>

<h3>
<span id="nullableに関する注意点" class="fragment"></span><a href="#nullable%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>Nullableに関する注意点</h3>

<p>テーブル列を作成する時、null許可を指定するには以下のようにする</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="c1">// null許可する場合</span>
<span class="n">Create</span><span class="p">.</span><span class="nf">Column</span><span class="p">(</span><span class="s">"col1"</span><span class="p">).</span><span class="nf">OnTable</span><span class="p">(</span><span class="s">"table1"</span><span class="p">).</span><span class="nf">AsString</span><span class="p">(</span><span class="m">128</span><span class="p">).</span><span class="nf">Nullable</span><span class="p">();</span>
<span class="c1">// null許可しない場合</span>
<span class="n">Create</span><span class="p">.</span><span class="nf">Column</span><span class="p">(</span><span class="s">"col2"</span><span class="p">).</span><span class="nf">OnTable</span><span class="p">(</span><span class="s">"table1"</span><span class="p">).</span><span class="nf">AsString</span><span class="p">(</span><span class="m">128</span><span class="p">).</span><span class="nf">NotNullable</span><span class="p">();</span>
</code></pre></div></div>

<p>ここで、 <strong>明示的にnull許可を指定しない場合、not null指定がついてしまう</strong> ので、必ずnull許可指定は入れること。</p>

<h2>
<span id="fluentmigrator公式のマイグレーション実行アプリを使用する" class="fragment"></span><a href="#fluentmigrator%E5%85%AC%E5%BC%8F%E3%81%AE%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>FluentMigrator公式のマイグレーション実行アプリを使用する</h2>

<p>とりあえず試してみたい場合、FluentMigrator公式のコンソールアプリが存在するので、そちらを使用する。<br>
3.2.1時点では、<a href="https://www.nuget.org/packages/FluentMigrator.Console/" rel="nofollow noopener" target="_blank">FluentMigrator.Console</a>と<a href="https://www.nuget.org/packages/FluentMigrator.DotNet.Cli/" rel="nofollow noopener" target="_blank">FluentMigrator.DotNet.Cli(dotnet-fm)</a>の2種類が存在している。<br>
前者が<code>nuget.exe install</code>でダウンロードして実行する用で、後者がdotnet global toolとなる。</p>

<p>詳しいオプションはそれぞれ公式ドキュメントが存在するのでそちらを参照。</p>

<ul>
<li><a href="https://fluentmigrator.github.io/articles/runners/runner-console.html" rel="nofollow noopener" target="_blank">FluentMigrator.Console</a></li>
<li><a href="https://fluentmigrator.github.io/articles/runners/dotnet-fm.html" rel="nofollow noopener" target="_blank">FluentMigrator.DotNet.Cli</a></li>
</ul>

<p>ただ、接続文字列の指定の方法など、不便な所も多いため、公式では自分で実行アプリを作成するのが推奨されている。</p>

<h2>
<span id="マイグレーション実行プロジェクトを作成する" class="fragment"></span><a href="#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>マイグレーション実行プロジェクトを作成する</h2>

<p>さて、前段では、どのようにマイグレーションが実行されるか定義しただけで、これ単体で実行ができるわけではない。<br>
記述した情報に基づいて、実際にマイグレーションを実行するためのアプリケーションを作成する。</p>

<h3>
<span id="パッケージの準備" class="fragment"></span><a href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>パッケージの準備</h3>

<p>中身としては、通常のdotnetアプリとなるが、以下の参照を追加する。</p>

<ul>
<li>FluentMigrator.Runner

<ul>
<li>執筆時点の開発版である4.0からは、対応DBごとに"FluentMigrator.Runner.[対応DB]"のNuGetパッケージを追加する必要がある</li>
</ul>
</li>
<li>RDBに対応するアセンブリを含むNuGetパッケージ

<ul>
<li>別途追加が必要なのは、リフレクションで実際の型情報を探しているため</li>
<li>SQLiteであればMicrosoft.Data.Sqlite等</li>
<li>対応アセンブリは後述</li>
</ul>
</li>
<li>Microsoft.Extensions.DependencyInjection

<ul>
<li>設定などはこのライブラリ前提で設定を行うため</li>
</ul>
</li>
<li>マイグレーションプロジェクトライブラリ

<ul>
<li>実行時に<code>typeof(T)</code>からAssemblyを簡単に引けるようにするため</li>
<li>決定できない場合は、<code>System.Reflection.Assembly.LoadFrom()</code>等で<code>Assembly</code>を取得してもOK</li>
</ul>
</li>
</ul>

<p>対応アセンブリは以下のようになる。</p>

<table>
<thead>
<tr>
<th>RDB</th>
<th>対応アセンブリ(どれか一つあればOK)</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQLServer</td>
<td>System.Data.SqlClient<br>(<a href="https://github.com/fluentmigrator/fluentmigrator/issues/1023" rel="nofollow noopener" target="_blank">Microsoft.Data.SqlClient追加予定</a>)</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>Npgsql</td>
</tr>
<tr>
<td>SQLite</td>
<td>System.Data.SQLite<br>Mono.Data.Sqlite<br>Microsoft.Data.Sqlite</td>
</tr>
<tr>
<td>DB2</td>
<td>IBM.Data.DB2.Core<br>IBM.Data.DB2</td>
</tr>
<tr>
<td>Firebird</td>
<td>FirebirdSql.Data.FirebirdClient</td>
</tr>
<tr>
<td>SAP Hana</td>
<td>Sap.Data.Hana<br>Sap.Data.Hana.v4.5</td>
</tr>
<tr>
<td>MySQL</td>
<td>MySql.Data</td>
</tr>
<tr>
<td>dotConnect for Oracle</td>
<td>DevArt.Data.Oracle</td>
</tr>
<tr>
<td>Redshift</td>
<td>Npgsql</td>
</tr>
<tr>
<td>SAP SQL Anywhere</td>
<td>Sap.Data.SQLAnywhere.v4.5 <br> Sap.Data.SQLAnywhere.EF6 <br> iAnywhere.Data.SQLAnywhere.v4.5 <br> iAnywhere.Data.SQLAnywhere.EF6</td>
</tr>
<tr>
<td>SQL Server CE</td>
<td>System.Data.SqlServerCe</td>
</tr>
<tr>
<td>Oracle</td>
<td>Oracle.DataAccess</td>
</tr>
<tr>
<td>Oracle(Managed)</td>
<td>Oracle.ManagedDataAccess</td>
</tr>
</tbody>
</table>

<h3>
<span id="マイグレーションの実行コード実装" class="fragment"></span><a href="#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9F%E8%A1%8C%E3%82%B3%E3%83%BC%E3%83%89%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>マイグレーションの実行コード実装</h3>

<p>プロジェクトの設定が終わったら、実際にコードを書く。<br>
大まかな手順としては、</p>

<ol>
<li>対象となるデータベースを作成

<ul>
<li>SQLite等、一部のRDBでは必要ない</li>
</ul>
</li>
<li>
<code>Microsoft.Extensions.DependencyInjection.ServiceCollection</code>のインスタンス作成</li>
<li>
<code>AddFluentMigratorCore(this IServiceCollection)</code>を実行</li>
<li>
<code>ConfigureRunner(this IServiceCollection, Action&lt;IMigrationRunnerBuilder&gt; configure)</code>で各種設定

<ul>
<li>
<code>Add*</code>(サポートDBの追加)、<code>ScanIn</code>(マイグレーションプロジェクトのアセンブリを追加)、<code>WithGlobalConnectionString</code>(接続情報の設定)辺りをしておく</li>
</ul>
</li>
<li>
<code>Configure&lt;SelectingProcessorAccessorOptions&gt;(this IServiceCollection, Action&lt;SelectingProcessorAccessorOptions&gt;)</code>で、どのRDBに対して実行するか決定</li>
<li>設定が終わったら<code>BuildServiceProvider()</code>でIServiceProviderを作成</li>
<li>
<code>IMigrationRunner</code>をサービスプロバイダから作成</li>
<li>各種マイグレーションの実行</li>
</ol>

<p>具体的なコードは<a href="https://github.com/itn3000/testfluentmigrator/blob/6b46a7d43f9d4b9b0dad3a4104a3eea2c9c5d577/fmapp1/Program.cs#L34-L50" rel="nofollow noopener" target="_blank">この辺り(github)</a>。<br>
<a href="https://fluentmigrator.github.io/articles/quickstart.html?tabs=runner-in-process" rel="nofollow noopener" target="_blank">また、公式ドキュメントにもサンプルコードがある。</a></p>

<h2>
<span id="マイグレーション時のパラメーター" class="fragment"></span><a href="#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%99%82%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%83%BC"><i class="fa fa-link"></i></a>マイグレーション時のパラメーター</h2>

<p>マイグレーション時に、何らかのパラメーターに基づいて動作させたい場合は、DIの仕組みを使うことになる。<br>
マイグレーションの性質上、頻繁に使用する機能でもないが、それでも必要な場所では役に立つと思う。<br>
具体的には以下のように行う</p>

<h3>
<span id="マイグレーション側の準備" class="fragment"></span><a href="#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%81%B4%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>マイグレーション側の準備</h3>

<p>まず、パラメーターのインターフェイスを定義する</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IMigrationParam</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">Data</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>次に、マイグレーション側で、コンストラクタにインターフェイスを受け取る処理を追加する</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="nf">Migration</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s">""</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Migration1</span> <span class="p">:</span> <span class="n">Migration</span>
<span class="p">{</span>
  <span class="n">IMigrationParam</span> <span class="n">_Param</span><span class="p">;</span>
  <span class="k">public</span> <span class="nf">Migration1</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// DIを設定していない場合にはこちらが呼ばれる</span>
    <span class="n">_Param</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">public</span> <span class="nf">Migration1</span><span class="p">(</span><span class="n">IMigrationParam</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">_Param</span> <span class="p">=</span> <span class="n">p</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 以下マイグレーションコード....</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="マイグレーション実行アプリ側の準備" class="fragment"></span><a href="#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%83%97%E3%83%AA%E5%81%B4%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>マイグレーション実行アプリ側の準備</h3>

<p>通常のDIと同じように、ServiceCollectionに対して設定を行う。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">MigrationParam1</span> <span class="p">:</span> <span class="n">IMigrationParam</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">Data</span> <span class="p">=&gt;</span> <span class="m">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// var services = new ServiceCollection();</span>
<span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IMigrationParam</span><span class="p">&gt;(</span><span class="k">new</span> <span class="nf">MigrationParam1</span><span class="p">());</span>
</code></pre></div></div>

<p>以上を行うと、実行時にServiceCollectionで設定したインスタンスが、マイグレーション側のコンストラクタに渡されるので、<br>
マイグレーション側は、それを元に動作を決定することが可能になる。</p>

<h3>
<span id="その他の設定" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>その他の設定</h3>

<p>基本的な使い方については以上になるが、FluentMigratorは実は結構細かいところまで設定出来たりする。<br>
ほとんどはあまり調整することのないパラメーターではあるが、知っておいて損は無い。<br>
内容的にボリュームがあるので割愛するが、 <a href="https://github.com/fluentmigrator/fluentmigrator/blob/6d9aaa79dedda882bd44c77dbb2e99d3cacf1f6f/src/FluentMigrator.Console/MigratorConsole.cs#L381-L464" rel="nofollow noopener" target="_blank">FluentMigrator公式コンソールアプリ</a>が何をやっているのか見れば、参考になると思う。</p>

<h1>
<span id="終りに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終りに</h1>

<p>今回紹介したFluentMigratorは、主流であるEntity Framework Coreを使用している場合にはほとんどの場合不要なものとなる。<br>
しかし、結構細かいところまで制御が可能で、かつ規模感が動作を把握するのにちょうどいい感じなので、気に入った人は使ってみるのも良いかと思う。</p>

<p>今回使用した実験コード等は、 <a href="https://github.com/itn3000/testfluentmigrator" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/itn3000/testfluentmigrator</a> に置いておいた。気が向いたら更新するかもしれない。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2Fba294a3ae35b617d207f&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2Fba294a3ae35b617d207f&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/ba294a3ae35b617d207f/likers" class="css-1iupg5d">9</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">8</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/ba294a3ae35b617d207f/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/ba294a3ae35b617d207f/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/ba294a3ae35b617d207f/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/ba294a3ae35b617d207f/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/ba294a3ae35b617d207f.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-39065548-9b0a-4456-ba63-947a21237e32">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-8da1b552-a96e-49a6-b444-a617112623a4"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-8da1b552-a96e-49a6-b444-a617112623a4">{}</script>
      
<div id="LoginModal-react-component-2d6e2b5c-b24b-4ff0-afb3-9499deb0ff94"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-2d6e2b5c-b24b-4ff0-afb3-9499deb0ff94">{}</script>
      
<div id="StockModal-react-component-c14efa59-e749-43b5-9788-0ac2f5fb746e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-c14efa59-e749-43b5-9788-0ac2f5fb746e">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;Cnsuq9pHCMd/yC+zjoqH0wZwx/niTvCpQCIKyjZ0xt7QMO+lNNz5S0qD1fFA84SJFZcMGsePKN3g6P0NbSzFoQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003eまず、ここでいうデータベースマイグレーションとは、アプリケーションで使うためのデータベーススキーマとデータを\u003cbr\u003e\n作成するという意味(Ruby on Railsのアレ)としておく。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"dotnet系プロジェクトにおけるデータベースマイグレーション\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dotnet%E7%B3%BB%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003edotnet系プロジェクトにおけるデータベースマイグレーション\u003c/h1\u003e\n\n\u003cp\u003edotnet系プロジェクトでのデータベースマイグレーションというと、真っ先に思いつくのが\u003ca href=\"https://docs.microsoft.com/en-us/ef/core/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eEntity Framework Core(EFCore)\u003c/a\u003eによるものだろう。\u003cbr\u003e\n実際多くの場合で、EFCoreを使えば問題は無い。\u003cbr\u003e\nだが、筆者の場合、クエリはほぼDapper経由で出しているため、クエリビルダ等は必要なく、欲しいものはマイグレーションのみとなる。\u003cbr\u003e\nマイグレーションのみの用途となると、EFCoreは大がかりに見えて、個人的にはちょっと扱いにくいなと思った。\u003c/p\u003e\n\n\u003cp\u003eそこで、よりマイグレーションのみに特化したライブラリは無いものかと探して、\u003ca href=\"https://fluentmigrator.github.io/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFluentMigrator\u003c/a\u003eを見つけた。\u003cbr\u003e\n自分にとっては丁度良い規模感だったため、今回の記事で紹介する。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"fluentmigratorとは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#fluentmigrator%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFluentMigratorとは\u003c/h1\u003e\n\n\u003cp\u003e先にも述べた通り、C#でデータベースマイグレーションを行うためのライブラリとなる。特徴としては、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eバージョン番号によるスキーマ管理\n\n\u003cul\u003e\n\u003cli\u003eバージョン番号は64bit整数で自分で管理する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eC#でマイグレーション記述\n\n\u003cul\u003e\n\u003cli\u003eSQL直接発行も可能\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e複数RDBMSに対応可能\n\n\u003cul\u003e\n\u003cli\u003e特化処理を書くことも可能\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e各RDBのSQL実行ランタイムを必要としない\n\n\u003cul\u003e\n\u003cli\u003eSQLServerにおけるsqlcmd、PostgreSQLにおけるpsql等\u003c/li\u003e\n\u003cli\u003edotnetランタイムは必要\n\n\u003cul\u003e\n\u003cli\u003epublishすることで制約の緩和は可能\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eとなる。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"使用方法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e使用方法\u003c/h1\u003e\n\n\u003cp\u003e最初のプロジェクトを作成して、実際にデータベースに適用するまでの流れを書く。なお、FluentMigratorは、記事執筆時点での最新版である3.2.1を基準に書く。\u003cbr\u003e\nFluentMigratorはメジャーバージョンごとの変化が割と大きいので、注意すること。\u003c/p\u003e\n\n\u003cp\u003e大きく分けると、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eマイグレーションの作成\u003c/li\u003e\n\u003cli\u003eマイグレーション実行アプリの作成\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eに分けられる。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"マイグレーションプロジェクトの作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eマイグレーションプロジェクトの作成\u003c/h2\u003e\n\n\u003cp\u003eまず、どのようにデータベースを作成するか(テーブル定義等)、というプロジェクトを作成する。\u003cbr\u003e\nといっても、中身は通常のC#クラスライブラリプロジェクトである。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\n\u003ccode\u003edotnet new classlib --name [プロジェクト名]\u003c/code\u003e で雛形を作成\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eFluentMigrator\u003c/code\u003e NuGetパッケージを追加\n\n\u003cul\u003e\n\u003cli\u003e各RDBに対する参照は、後述のマイグレーション実行プロジェクトで追加するので必要ない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eマイグレーションクラスを作成\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eマイグレーションクラスは以下のように作る。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eFluentMigrator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003efmlib1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// バージョン番号をプロジェクトで一意にする\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 重複があるとエラーになる\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 2回目以降は、同じ番号のマイグレーションはスキップする\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// カスタム属性を使うとより管理しやすい\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// https://fluentmigrator.github.io/articles/migration/migration-attribute-custom.html\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eMigration\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"creating schema\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCreateSchema\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMigration\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDown\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// バージョン番号を下げるときに実行される\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDelete\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"testtable\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eInSchema\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"aa\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDelete\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSchema\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"aa\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUp\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// バージョン番号を上げるときに実行される\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSchema\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"aa\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"testtable\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eInSchema\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"aa\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eポイントは、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003epublicクラスにする\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eFluentMigrator.MigrationAttribute\u003c/code\u003eをクラスに付与する\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e一意になるバージョン番号を付ける\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e小さい値のものから実行される\u003c/li\u003e\n\u003cli\u003e管理が大変という場合は、\u003ca href=\"https://fluentmigrator.github.io/articles/migration/migration-attribute-custom.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eカスタム属性で一定の規則性を持たせるという手段がある\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eFluentMigrator.Migration\u003c/code\u003eクラスを継承する\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eFluentMigrator.IMigration\u003c/code\u003eでも認識されるが、実用上はこちらを使う方が良い\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eで、どれかが欠けると認識されなくなるので注意。\u003cbr\u003e\n各マイグレーションは番号で識別され、同じ番号のものは二度実行されないようになっている。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"rdb種別ごとに特殊な処理を実行する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#rdb%E7%A8%AE%E5%88%A5%E3%81%94%E3%81%A8%E3%81%AB%E7%89%B9%E6%AE%8A%E3%81%AA%E5%87%A6%E7%90%86%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRDB種別ごとに特殊な処理を実行する\u003c/h3\u003e\n\n\u003cp\u003eFluentMigratorでは、マイグレーション記述においては各RDBMSの違いを吸収できるように作られているが、ある特定のRDBの場合のみ特殊な処理をしたい(ストアドを登録したい等)時は、以下のようにする。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// SQLServer系列の場合だけ、デフォルトの文字列照合設定を変更する\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eIfDatabase\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"SqlServer\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSql\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"alter database CURRENT COLLATE Japanese_BIN\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここで\u003ccode\u003eIfDatabase()\u003c/code\u003eの引数に何を指定できるかというと、\u003ca href=\"https://fluentmigrator.github.io/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式ドキュメントのサポートデータベース一覧\u003c/a\u003eの\"Identifier\"、または\"Alternative identifier\"が使える。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"nullableに関する注意点\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#nullable%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNullableに関する注意点\u003c/h3\u003e\n\n\u003cp\u003eテーブル列を作成する時、null許可を指定するには以下のようにする\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// null許可する場合\u003c/span\u003e\n\u003cspan class=\"n\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eColumn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"col1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnTable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"table1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eAsString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e128\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eNullable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// null許可しない場合\u003c/span\u003e\n\u003cspan class=\"n\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eColumn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"col2\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnTable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"table1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eAsString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e128\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eNotNullable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここで、 \u003cstrong\u003e明示的にnull許可を指定しない場合、not null指定がついてしまう\u003c/strong\u003e ので、必ずnull許可指定は入れること。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"fluentmigrator公式のマイグレーション実行アプリを使用する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#fluentmigrator%E5%85%AC%E5%BC%8F%E3%81%AE%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFluentMigrator公式のマイグレーション実行アプリを使用する\u003c/h2\u003e\n\n\u003cp\u003eとりあえず試してみたい場合、FluentMigrator公式のコンソールアプリが存在するので、そちらを使用する。\u003cbr\u003e\n3.2.1時点では、\u003ca href=\"https://www.nuget.org/packages/FluentMigrator.Console/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFluentMigrator.Console\u003c/a\u003eと\u003ca href=\"https://www.nuget.org/packages/FluentMigrator.DotNet.Cli/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFluentMigrator.DotNet.Cli(dotnet-fm)\u003c/a\u003eの2種類が存在している。\u003cbr\u003e\n前者が\u003ccode\u003enuget.exe install\u003c/code\u003eでダウンロードして実行する用で、後者がdotnet global toolとなる。\u003c/p\u003e\n\n\u003cp\u003e詳しいオプションはそれぞれ公式ドキュメントが存在するのでそちらを参照。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://fluentmigrator.github.io/articles/runners/runner-console.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFluentMigrator.Console\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://fluentmigrator.github.io/articles/runners/dotnet-fm.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFluentMigrator.DotNet.Cli\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eただ、接続文字列の指定の方法など、不便な所も多いため、公式では自分で実行アプリを作成するのが推奨されている。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"マイグレーション実行プロジェクトを作成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eマイグレーション実行プロジェクトを作成する\u003c/h2\u003e\n\n\u003cp\u003eさて、前段では、どのようにマイグレーションが実行されるか定義しただけで、これ単体で実行ができるわけではない。\u003cbr\u003e\n記述した情報に基づいて、実際にマイグレーションを実行するためのアプリケーションを作成する。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"パッケージの準備\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E6%BA%96%E5%82%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eパッケージの準備\u003c/h3\u003e\n\n\u003cp\u003e中身としては、通常のdotnetアプリとなるが、以下の参照を追加する。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eFluentMigrator.Runner\n\n\u003cul\u003e\n\u003cli\u003e執筆時点の開発版である4.0からは、対応DBごとに\"FluentMigrator.Runner.[対応DB]\"のNuGetパッケージを追加する必要がある\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eRDBに対応するアセンブリを含むNuGetパッケージ\n\n\u003cul\u003e\n\u003cli\u003e別途追加が必要なのは、リフレクションで実際の型情報を探しているため\u003c/li\u003e\n\u003cli\u003eSQLiteであればMicrosoft.Data.Sqlite等\u003c/li\u003e\n\u003cli\u003e対応アセンブリは後述\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eMicrosoft.Extensions.DependencyInjection\n\n\u003cul\u003e\n\u003cli\u003e設定などはこのライブラリ前提で設定を行うため\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eマイグレーションプロジェクトライブラリ\n\n\u003cul\u003e\n\u003cli\u003e実行時に\u003ccode\u003etypeof(T)\u003c/code\u003eからAssemblyを簡単に引けるようにするため\u003c/li\u003e\n\u003cli\u003e決定できない場合は、\u003ccode\u003eSystem.Reflection.Assembly.LoadFrom()\u003c/code\u003e等で\u003ccode\u003eAssembly\u003c/code\u003eを取得してもOK\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e対応アセンブリは以下のようになる。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eRDB\u003c/th\u003e\n\u003cth\u003e対応アセンブリ(どれか一つあればOK)\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eSQLServer\u003c/td\u003e\n\u003ctd\u003eSystem.Data.SqlClient\u003cbr\u003e(\u003ca href=\"https://github.com/fluentmigrator/fluentmigrator/issues/1023\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMicrosoft.Data.SqlClient追加予定\u003c/a\u003e)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ePostgreSQL\u003c/td\u003e\n\u003ctd\u003eNpgsql\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eSQLite\u003c/td\u003e\n\u003ctd\u003eSystem.Data.SQLite\u003cbr\u003eMono.Data.Sqlite\u003cbr\u003eMicrosoft.Data.Sqlite\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eDB2\u003c/td\u003e\n\u003ctd\u003eIBM.Data.DB2.Core\u003cbr\u003eIBM.Data.DB2\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eFirebird\u003c/td\u003e\n\u003ctd\u003eFirebirdSql.Data.FirebirdClient\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eSAP Hana\u003c/td\u003e\n\u003ctd\u003eSap.Data.Hana\u003cbr\u003eSap.Data.Hana.v4.5\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eMySQL\u003c/td\u003e\n\u003ctd\u003eMySql.Data\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003edotConnect for Oracle\u003c/td\u003e\n\u003ctd\u003eDevArt.Data.Oracle\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRedshift\u003c/td\u003e\n\u003ctd\u003eNpgsql\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eSAP SQL Anywhere\u003c/td\u003e\n\u003ctd\u003eSap.Data.SQLAnywhere.v4.5 \u003cbr\u003e Sap.Data.SQLAnywhere.EF6 \u003cbr\u003e iAnywhere.Data.SQLAnywhere.v4.5 \u003cbr\u003e iAnywhere.Data.SQLAnywhere.EF6\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eSQL Server CE\u003c/td\u003e\n\u003ctd\u003eSystem.Data.SqlServerCe\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eOracle\u003c/td\u003e\n\u003ctd\u003eOracle.DataAccess\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eOracle(Managed)\u003c/td\u003e\n\u003ctd\u003eOracle.ManagedDataAccess\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"マイグレーションの実行コード実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9F%E8%A1%8C%E3%82%B3%E3%83%BC%E3%83%89%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eマイグレーションの実行コード実装\u003c/h3\u003e\n\n\u003cp\u003eプロジェクトの設定が終わったら、実際にコードを書く。\u003cbr\u003e\n大まかな手順としては、\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e対象となるデータベースを作成\n\n\u003cul\u003e\n\u003cli\u003eSQLite等、一部のRDBでは必要ない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eMicrosoft.Extensions.DependencyInjection.ServiceCollection\u003c/code\u003eのインスタンス作成\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eAddFluentMigratorCore(this IServiceCollection)\u003c/code\u003eを実行\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eConfigureRunner(this IServiceCollection, Action\u0026lt;IMigrationRunnerBuilder\u0026gt; configure)\u003c/code\u003eで各種設定\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eAdd*\u003c/code\u003e(サポートDBの追加)、\u003ccode\u003eScanIn\u003c/code\u003e(マイグレーションプロジェクトのアセンブリを追加)、\u003ccode\u003eWithGlobalConnectionString\u003c/code\u003e(接続情報の設定)辺りをしておく\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eConfigure\u0026lt;SelectingProcessorAccessorOptions\u0026gt;(this IServiceCollection, Action\u0026lt;SelectingProcessorAccessorOptions\u0026gt;)\u003c/code\u003eで、どのRDBに対して実行するか決定\u003c/li\u003e\n\u003cli\u003e設定が終わったら\u003ccode\u003eBuildServiceProvider()\u003c/code\u003eでIServiceProviderを作成\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eIMigrationRunner\u003c/code\u003eをサービスプロバイダから作成\u003c/li\u003e\n\u003cli\u003e各種マイグレーションの実行\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e具体的なコードは\u003ca href=\"https://github.com/itn3000/testfluentmigrator/blob/6b46a7d43f9d4b9b0dad3a4104a3eea2c9c5d577/fmapp1/Program.cs#L34-L50\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこの辺り(github)\u003c/a\u003e。\u003cbr\u003e\n\u003ca href=\"https://fluentmigrator.github.io/articles/quickstart.html?tabs=runner-in-process\" rel=\"nofollow noopener\" target=\"_blank\"\u003eまた、公式ドキュメントにもサンプルコードがある。\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"マイグレーション時のパラメーター\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%99%82%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%83%BC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eマイグレーション時のパラメーター\u003c/h2\u003e\n\n\u003cp\u003eマイグレーション時に、何らかのパラメーターに基づいて動作させたい場合は、DIの仕組みを使うことになる。\u003cbr\u003e\nマイグレーションの性質上、頻繁に使用する機能でもないが、それでも必要な場所では役に立つと思う。\u003cbr\u003e\n具体的には以下のように行う\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"マイグレーション側の準備\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%81%B4%E3%81%AE%E6%BA%96%E5%82%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eマイグレーション側の準備\u003c/h3\u003e\n\n\u003cp\u003eまず、パラメーターのインターフェイスを定義する\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eIMigrationParam\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eData\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e次に、マイグレーション側で、コンストラクタにインターフェイスを受け取る処理を追加する\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eMigration\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMigration1\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMigration\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eIMigrationParam\u003c/span\u003e \u003cspan class=\"n\"\u003e_Param\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eMigration1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// DIを設定していない場合にはこちらが呼ばれる\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_Param\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eMigration1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIMigrationParam\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_Param\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 以下マイグレーションコード....\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"マイグレーション実行アプリ側の準備\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%83%97%E3%83%AA%E5%81%B4%E3%81%AE%E6%BA%96%E5%82%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eマイグレーション実行アプリ側の準備\u003c/h3\u003e\n\n\u003cp\u003e通常のDIと同じように、ServiceCollectionに対して設定を行う。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMigrationParam1\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIMigrationParam\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// var services = new ServiceCollection();\u003c/span\u003e\n\u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddSingleton\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIMigrationParam\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMigrationParam1\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e以上を行うと、実行時にServiceCollectionで設定したインスタンスが、マイグレーション側のコンストラクタに渡されるので、\u003cbr\u003e\nマイグレーション側は、それを元に動作を決定することが可能になる。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"その他の設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eその他の設定\u003c/h3\u003e\n\n\u003cp\u003e基本的な使い方については以上になるが、FluentMigratorは実は結構細かいところまで設定出来たりする。\u003cbr\u003e\nほとんどはあまり調整することのないパラメーターではあるが、知っておいて損は無い。\u003cbr\u003e\n内容的にボリュームがあるので割愛するが、 \u003ca href=\"https://github.com/fluentmigrator/fluentmigrator/blob/6d9aaa79dedda882bd44c77dbb2e99d3cacf1f6f/src/FluentMigrator.Console/MigratorConsole.cs#L381-L464\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFluentMigrator公式コンソールアプリ\u003c/a\u003eが何をやっているのか見れば、参考になると思う。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"終りに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%82%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e終りに\u003c/h1\u003e\n\n\u003cp\u003e今回紹介したFluentMigratorは、主流であるEntity Framework Coreを使用している場合にはほとんどの場合不要なものとなる。\u003cbr\u003e\nしかし、結構細かいところまで制御が可能で、かつ規模感が動作を把握するのにちょうどいい感じなので、気に入った人は使ってみるのも良いかと思う。\u003c/p\u003e\n\n\u003cp\u003e今回使用した実験コード等は、 \u003ca href=\"https://github.com/itn3000/testfluentmigrator\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/itn3000/testfluentmigrator\u003c/a\u003e に置いておいた。気が向いたら更新するかもしれない。\u003c/p\u003e\n","createdAt":"2019-05-31T14:42:11Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"6RBXVNmJY7CWTu/YsOnO1fR62JQwlUye--hSH7ozMhVtUr9FII--F9tP9JaSSN+y3G+fmBnsQQ==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-06-04T00:03:09Z","likesCount":9,"linkUrl":"https://qiita.com/skitoy4321/items/ba294a3ae35b617d207f","organization":null,"originalId":912075,"stockedCount":8,"title":"FluentMigratorでデータベースマイグレーションを行う(dotnet)","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#dotnet%E7%B3%BB%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\"\u003edotnet系プロジェクトにおけるデータベースマイグレーション\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#fluentmigrator%E3%81%A8%E3%81%AF\"\u003eFluentMigratorとは\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\"\u003e使用方法\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90\"\u003eマイグレーションプロジェクトの作成\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#rdb%E7%A8%AE%E5%88%A5%E3%81%94%E3%81%A8%E3%81%AB%E7%89%B9%E6%AE%8A%E3%81%AA%E5%87%A6%E7%90%86%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B\"\u003eRDB種別ごとに特殊な処理を実行する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#nullable%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003eNullableに関する注意点\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#fluentmigrator%E5%85%AC%E5%BC%8F%E3%81%AE%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B\"\u003eFluentMigrator公式のマイグレーション実行アプリを使用する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003eマイグレーション実行プロジェクトを作成する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E6%BA%96%E5%82%99\"\u003eパッケージの準備\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9F%E8%A1%8C%E3%82%B3%E3%83%BC%E3%83%89%E5%AE%9F%E8%A3%85\"\u003eマイグレーションの実行コード実装\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%99%82%E3%81%AE%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%83%BC\"\u003eマイグレーション時のパラメーター\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%81%B4%E3%81%AE%E6%BA%96%E5%82%99\"\u003eマイグレーション側の準備\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9E%E3%82%A4%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%9F%E8%A1%8C%E3%82%A2%E3%83%97%E3%83%AA%E5%81%B4%E3%81%AE%E6%BA%96%E5%82%99\"\u003eマイグレーション実行アプリ側の準備\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003eその他の設定\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%82%E3%82%8A%E3%81%AB\"\u003e終りに\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":2449,"uuid":"ba294a3ae35b617d207f","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"k5CPBjT/McPmq5TN32jRjcLsLEBJ--Uly2r89CBgONK+YB--/OnzfjH5xU29Xx33gKkPjQ==","originalId":103253,"description":"","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=a7dce827dc16582e1b8e9c7a52216638","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","urlName":"skitoy4321","websiteUrl":"","twitterUrl":"https://twitter.com/skitoy4321","twitterUrlName":"skitoy4321","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"migration","urlName":"migration"},{"name":"Database","urlName":"database"},{"name":"dotnet","urlName":"dotnet"}],"followingLikers":{"edges":[]},"comments":{"totalCount":1}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
