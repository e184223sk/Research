<!DOCTYPE html><html><head><meta charset="utf-8" /><title>NLogを使ってAzure Table Storageにログを書きこむ - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/uezo/items/4a21d547cca3a2da5fd4" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="doXjZKQqSft9V4KN3hvzVRElzrUdn3ZjDmypismhYFvty8cAJSzA5WBxtcgUQp+jEQ81AKVpCO2r+thMtws/Ug==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@uezochan" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="NLogを使ってAzure Table Storageにログを書きこむ - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1Ua3h2Wi1PQ2t1Uzl2LU9Cby1PQnBrRjZkWEpsSUZSaFlteGxJRk4wYjNKaFoyWGpnYXZqZzYzamdyRGpncExtbTdqamdZM2pnWlBqZ29BJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPWY0YjM4MmM2NzBlOTgzZDg0OWI1Y2QzM2Q5NjMyNmI1&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSFZsZW04JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9ZDlkZWE0ZjhjYTQ3YTE3YmMzMjdlZTgwNGJmNTU2NDE&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=edd29251d64c9e214aa314e3cf78ee6d"><meta property="og:description" content="NuGetを検索するとAzure Table Storage用のTargetをいくつか見かけますが、.NET Coreへの対応状況や依存ライブラリの最新化状況などの制約があって微妙です。
また、Azure Table Storageま..."><meta content="https://qiita.com/uezo/items/4a21d547cca3a2da5fd4" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Azure,Unity,NLog" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-dc9187c3-f079-4979-bc87-8f0b713f6583"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fuezo%2Fitems%2F4a21d547cca3a2da5fd4">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fuezo%2Fitems%2F4a21d547cca3a2da5fd4">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-dc9187c3-f079-4979-bc87-8f0b713f6583">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-01-04T21:36:18.000+09:00","dateModified":"2020-01-04T21:36:18.000+09:00","headline":"NLogを使ってAzure Table Storageにログを書きこむ","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1Ua3h2Wi1PQ2t1Uzl2LU9Cby1PQnBrRjZkWEpsSUZSaFlteGxJRk4wYjNKaFoyWGpnYXZqZzYzamdyRGpncExtbTdqamdZM2pnWlBqZ29BJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPWY0YjM4MmM2NzBlOTgzZDg0OWI1Y2QzM2Q5NjMyNmI1\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSFZsZW04JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9ZDlkZWE0ZjhjYTQ3YTE3YmMzMjdlZTgwNGJmNTU2NDE\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=edd29251d64c9e214aa314e3cf78ee6d","mainEntityOfPage":"https://qiita.com/uezo/items/4a21d547cca3a2da5fd4","author":{"@type":"Person","address":"東京","email":null,"identifier":"uezo","name":"uezo","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F53296%2Fprofile-images%2F1597841671?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=054f1773c9568af2ec8446d98b2281ab","url":"https://qiita.com/uezo","description":"理想の妹を追い求め、最近はチャットボットとGateboxアプリを中心に開発しているホビープログラマー。\r\n高校卒業後に単身上京し、バリスタの見習いをしながら独学でプログラミングを習得。損害保険会社にスカウトされたのをきっかけに、以後複数の金融機関でDX戦略のテックリードを担当。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">日立の研究者が、2年間ドイツ人工知能研究センターで学んだこと</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"uezo","type":"items","id":"4a21d547cca3a2da5fd4"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"日立の研究者が、2年間ドイツ人工知能研究センターで学んだこと","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"uezo","type":"items","id":"4a21d547cca3a2da5fd4"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"日立の研究者が、2年間ドイツ人工知能研究センターで学んだこと","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"uezo","type":"items","id":"4a21d547cca3a2da5fd4"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"日立の研究者が、2年間ドイツ人工知能研究センターで学んだこと","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/uezo/items/4a21d547cca3a2da5fd4","location":"/uezo/items/4a21d547cca3a2da5fd4","scheme":"https","host":"qiita.com","port":null,"pathname":"/uezo/items/4a21d547cca3a2da5fd4","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"wyr5VQi7vVk7nzEhHZuBVaSU/yBbiCSE6UqFwYmZayJYZN0xib00Rya5BmTXwu2jpL4EleN+WgpM3PQH9zM0Kw==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-6ed6d8d1-f855-4b8e-a1d2-6539b8b9540b"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/uezo/items/4a21d547cca3a2da5fd4/likers" class="css-1iupg5d">1</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">0</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/4a21d547cca3a2da5fd4/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/uezo/items/4a21d547cca3a2da5fd4/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/uezo/items/4a21d547cca3a2da5fd4/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/uezo/items/4a21d547cca3a2da5fd4/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/uezo/items/4a21d547cca3a2da5fd4.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/uezo"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/53296/profile-images/1597841671" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/uezo" class="css-10ougpm">@<!-- -->uezo</a><div class="css-1ay9vb9"><time dateTime="2020-01-04T12:36:18Z" class="css-m19uds">posted at 2020-01-04</time></div></div></div></div></div><h1 class="css-cgzq40">NLogを使ってAzure Table Storageにログを書きこむ</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/azure" class="css-4czcte">Azure</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/nlog" class="css-4czcte">NLog</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>NuGetを検索するとAzure Table Storage用のTargetをいくつか見かけますが、.NET Coreへの対応状況や依存ライブラリの最新化状況などの制約があって微妙です。<br>
また、Azure Table StorageまわりのSDKはCosmosDBに切り出されたりしてややこしいので、たかがEntityの追加のみで依存関係を増やしたくありません。<br>
そんなわけで、NLog標準の<code>WebServiceTarget</code>を使った書き込みを試したら結構ハマりどころがあったので共有します。</p>

<h1>
<span id="事前準備" class="fragment"></span><a href="#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>事前準備</h1>

<h2>
<span id="コンソールアプリのプロジェクトを作成" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>コンソールアプリのプロジェクトを作成</h2>

<p>ターゲットフレームワークはNLogがサポートするものであれば何でも良いですが、.NET Core 2.0〜3.0までで動作確認をしました。</p>

<h2>
<span id="nlogのインストール" class="fragment"></span><a href="#nlog%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>NLogのインストール</h2>

<p>NuGetからインストールします。この記事では4.6.8の利用を前提としていますが、多少前後しても問題ないと思います。</p>

<h2>
<span id="azure-storageのsas-urlの作成" class="fragment"></span><a href="#azure-storage%E3%81%AEsas-url%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>Azure StorageのSAS URLの作成</h2>

<p>SASとはShared Access Signatureの略で、あらかじめリソースやそれに対するアクション（参照、書き込みなど）、利用可能期間を制限したトークンです。これを含むURLを使うことで、リクエスト都度署名をするといった手間も省けるためWebServiceTargetで利用する上では好都合というわけです。</p>

<p>作成は簡単で、Azure Portalで対象ストレージアカウントを選択し、メニューの「Shared Access Signature」に移動します。対象リソースなどを選んで「SASと接続文字列を作成する」ボタンを押下後、表示された「Table service の SAS URL」を控えておいてください。<br>
<a href="https://camo.qiitausercontent.com/1fe92b995824726fd4aa1985411c5b91d8216996/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f35333239362f63383138353961322d313365312d376338352d623631332d6465313863663966326333642e706e67" target="_blank" rel="nofollow noopener"><img width="1440" alt="azureportal.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F53296%2Fc81859a2-13e1-7c85-b613-de18cf9f2c3d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=dc15be04b6c06954f5168c8d20229723" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/53296/c81859a2-13e1-7c85-b613-de18cf9f2c3d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F53296%2Fc81859a2-13e1-7c85-b613-de18cf9f2c3d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b596c893099605296c017a13db1703f6 1x" loading="lazy"></a></p>

<h1>
<span id="nlogの設定" class="fragment"></span><a href="#nlog%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>NLogの設定</h1>

<p>まずは以下の通り<code>WebServiceTarget</code>を設定します。名前は何でもいいですが、ここでは<code>AZTBLTarget</code>としてみました。</p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">NLog.config</span></div>
<div class="highlight"><pre class="with-code"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;nlog</span> <span class="na">xmlns=</span><span class="s">"http://www.nlog-project.org/schemas/NLog.xsd"</span>
      <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
      <span class="na">throwExceptions=</span><span class="s">"true"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;targets&gt;</span>
        <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">"AZTBLTarget"</span> <span class="na">xsi:type=</span><span class="s">"WebService"</span> <span class="na">protocol=</span><span class="s">"JsonPost"</span> <span class="na">url=</span><span class="s">"&lt;SAS URL&gt;"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"PartitionKey"</span> <span class="na">layout=</span><span class="s">"${callsite}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"RowKey"</span> <span class="na">layout=</span><span class="s">"${ticks}.${sequenceid:padCharacter=0:padding=6}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"LocalTimestamp"</span> <span class="na">layout=</span><span class="s">"${date:format=yyyy-MM-ddTHH\:mm\:ss.fffffff}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"Level"</span> <span class="na">layout=</span><span class="s">"${level:uppercase=true}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"Callsite"</span> <span class="na">layout=</span><span class="s">"${callsite}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"Message"</span> <span class="na">layout=</span><span class="s">"${message}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"Error"</span> <span class="na">layout=</span><span class="s">"${exception:format=Message, ToString:separator=\n}"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/target&gt;</span>
    <span class="nt">&lt;/targets&gt;</span>

    <span class="nt">&lt;rules&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"*"</span> <span class="na">minlevel=</span><span class="s">"Trace"</span> <span class="na">writeTo=</span><span class="s">"AZTBLTarget"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/rules&gt;</span>
<span class="nt">&lt;/nlog&gt;</span>
</code></pre></div>
</div>

<p>簡単に説明すると、ターゲットの種類として<code>WebService</code>のものを定義していて、その通信手続きとしてJSONデータのPOST、そのJSONのパラメータとして<code>PartitionKey</code>や<code>RowKey</code>を含む7項目を送信するようにしています。なお<code>PartitionKey</code>と<code>RowKey</code>はTable Storageとして必須の項目です。</p>

<p>さて、説明の中で<code>url</code>アトリビュートの説明を飛ばしていましたが、ここがハマりポイントです。コピペして<code>url</code>に貼り付けるだけではうまくいきません。先の手順で取得したSAS URLを、以下の通り修正する必要があります。</p>

<div class="code-frame" data-lang="">
<div class="code-lang"><span class="bold">生成されたもの</span></div>
<div class="highlight"><pre class="with-code"><code>https://accountname.table.core.windows.net/?&amp;sv=2019-02-02&amp;ss=t&amp;srt=sco&amp;sp=wau&amp;se=2030-01-04T08:21:42Z&amp;st=2020-01-04T00:21:42Z&amp;spr=https&amp;sig=xxxxxxxxx%3D
</code></pre></div>
</div>

<div class="code-frame" data-lang="">
<div class="code-lang"><span class="bold">修正後</span></div>
<div class="highlight"><pre class="with-code"><code>https://accountname.table.core.windows.net/nlogtable?$format=application/json&amp;amp;sv=2019-02-02&amp;amp;ss=t&amp;amp;srt=sco&amp;amp;sp=wau&amp;amp;se=2030-01-04T08:21:42Z&amp;amp;st=2020-01-04T00:21:42Z&amp;amp;spr=https&amp;amp;sig=xxxxxxxxx%3D
</code></pre></div>
</div>

<p>修正内容は以下の通り。</p>

<ul>
<li>URIの末尾に<code>/&lt;テーブル名&gt;</code>をつける。当たり前ですが、コピペでは動かず一瞬「ウッ」てなります。修正後の例は、テーブル名を<code>nlogtable</code>のケースです。</li>
<li>
<code>&amp;</code>を<code>&amp;amp;</code>に置換。これもXMLに一般的な話だと思いますが、エラーになるので小心者の私は「えっえっ」てなりました。</li>
<li>
<code>$format=application/json</code>をつける。<a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/insert-entity" rel="nofollow noopener" target="_blank">Insert Entityの仕様</a>を見る限り<code>Accept</code>ヘッダーは任意なのですが、なぜかこれを渡さないと<code>415</code>エラーとなります。しかしながらNLogのWebServiceTargetではなぜかHTTPヘッダーに<code>Accept</code>を設定することができませんでした。諦めかけていたところ、<a href="https://docs.microsoft.com/en-us/rest/api/storageservices/payload-format-for-table-service-operations" rel="nofollow noopener" target="_blank">Payload format for Table service operations</a>を読んだら<code>$format</code>で指定できることを発見したため、これをURLに含んでやります。</li>
</ul>

<h1>
<span id="ログの書き込み" class="fragment"></span><a href="#%E3%83%AD%E3%82%B0%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>ログの書き込み</h1>

<p>それでは実際に書き込んでみましょう。本記事のポイントは設定方法ですので、書き込み自体は一般的な手順に従えばOKかと思います。ちょっとハマるかもしれないポイントとしては、最終行の<code>LogManager.Shutdown();</code>を実行しないと、ログ送信前にプロセスが終了してしまいTable Storgeに書き込まれない場合があるところでしょうか。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">NLog</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NLogToAzureTable</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// NLog.configを出力ディレクトリにコピーするように設定してください。</span>
            <span class="c1">// もしくは、以下の通り明示的にパスを指定することもできます。2つめの引数falseはエラーを無視するか否かの設定です（false=無視しない）</span>
            <span class="c1">// LogManager.Configuration = new XmlLoggingConfiguration("/path/to/NLog.config", false);</span>

            <span class="c1">// ロガーの初期化・取得</span>
            <span class="kt">var</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">LogManager</span><span class="p">.</span><span class="nf">GetCurrentClassLogger</span><span class="p">();</span>

            <span class="c1">// ログの書き込み</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">"test message for info"</span><span class="p">);</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">"test message for warn"</span><span class="p">);</span>

            <span class="c1">// ロガーの終了。プロセスを終了する前にログを送信するために必要</span>
            <span class="n">LogManager</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1>
<span id="非同期書き込みの利用" class="fragment"></span><a href="#%E9%9D%9E%E5%90%8C%E6%9C%9F%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E3%81%AE%E5%88%A9%E7%94%A8"><i class="fa fa-link"></i></a>非同期書き込みの利用</h1>

<p>NLogには便利な非同期処理の仕組み<code>AsyncWrapper</code>ターゲットがあります。ログメッセージをキューに貯めてバッチ的に別スレッドで処理してくれるといった便利なものです。<br>
使い方は超簡単で、<code>targets</code>の<code>async</code>アトリビュートに<code>true</code>を設定するだけで全てのターゲットへの書き込みが非同期に行われます。</p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">NLog.config</span></div>
<div class="highlight"><pre class="with-code"><code>：中略
<span class="nt">&lt;targets</span> <span class="na">async=</span><span class="s">"true"</span><span class="nt">&gt;</span>
：中略
</code></pre></div>
</div>

<p>一部の書き込みのみを非同期にしたい場合は、ラッパーの名の通り非同期にしたいターゲットを<code>AsyncWrapper</code>で囲みます。このとき、<code>rule</code>に設定する<code>name</code>もラッパーのものにすることに注意です。</p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">NLog.config</span></div>
<div class="highlight"><pre class="with-code"><code>    <span class="nt">&lt;targets&gt;</span>
        <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">"AZTBLTargetAsync"</span> <span class="na">xsi:type=</span><span class="s">"AsyncWrapper"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">"AZTBLTarget"</span> <span class="na">xsi:type=</span><span class="s">"WebService"</span> <span class="na">protocol=</span><span class="s">"JsonPost"</span> <span class="na">url=</span><span class="s">"&lt;SAS URL&gt;"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"PartitionKey"</span> <span class="na">layout=</span><span class="s">"${callsite}"</span> <span class="nt">/&gt;</span>
                 ：中略
            <span class="nt">&lt;/target&gt;</span>
        <span class="nt">&lt;/target&gt;</span>
    <span class="nt">&lt;/targets&gt;</span>

    <span class="nt">&lt;rules&gt;</span>
        <span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"*"</span> <span class="na">minlevel=</span><span class="s">"Trace"</span> <span class="na">writeTo=</span><span class="s">"AZTBLTargetAsync"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/rules&gt;</span>
</code></pre></div>
</div>

<p>詳細は公式Wikiを読んでみてください。<br>
<a href="https://github.com/nlog/NLog/wiki/AsyncWrapper-target" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/nlog/NLog/wiki/AsyncWrapper-target</a></p>

<h1>
<span id="補足" class="fragment"></span><a href="#%E8%A3%9C%E8%B6%B3"><i class="fa fa-link"></i></a>補足</h1>

<ul>
<li>
<code>PartitionKey</code>に設定する値。記事では便宜上出力元メソッドの名前を指定していますが、ユーザーとかデバイスとかを一意に特定できるものを設定した方が調査しやすいと思います・</li>
<li>パフォーマンスや負荷は未知数。<code>AsyncWrapper</code>を使うことでメイン処理への影響はないと思いますが、書き込み速度や負荷は計測していません。WebServiceTargetに一般的な議論かと思います。詳しい方アドバイスください！！</li>
<li>出力レベル。そもそもリモートでログを取る時点で常にデバッグ情報が欲しいわけではないと思いますので、<code>minlevel</code>をエラーに設定するなど最適化が必要です。</li>
<li>Logging Frameworkについて。実装ライブラリを自由に変更できるようにDIなフレームワークが.NET Coreでは用意されていますが、今回は未考慮です。</li>
</ul>

<h1>
<span id="おまけunityでnlogを使ってazure-table-storageに書き込み" class="fragment"></span><a href="#%E3%81%8A%E3%81%BE%E3%81%91unity%E3%81%A7nlog%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6azure-table-storage%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>おまけ：UnityでNLogを使ってAzure Table Storageに書き込み</h1>

<p>そもそも何でAzure Table Storageにログを書き込もうと思ったかというと、<a href="https://www.gatebox.ai/" rel="nofollow noopener" target="_blank">Gatebox</a>というデバイス向けのアプリ開発をはじめたことがきっかけです。実機デバッグする際にコンソール出力やファイルファイルを選択できないことから、リモートにログ出力をする方法を探ることにしました。ログのためにサーバーを用意するのもアレなのでAzureに・・・という経緯です。</p>

<p>UnityのConsoleへのログ出力用ターゲットも同梱したファクトリーぽいものを作りましたのでよかったら使ってみてください。</p>

<p>NLogFactoryForUnity<br>
<a href="https://github.com/uezo/NLogFactoryForUnity" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/uezo/NLogFactoryForUnity</a></p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fuezo%2Fitems%2F4a21d547cca3a2da5fd4&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fuezo%2Fitems%2F4a21d547cca3a2da5fd4&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/uezo/items/4a21d547cca3a2da5fd4/likers" class="css-1iupg5d">1</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">0</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/4a21d547cca3a2da5fd4/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/uezo/items/4a21d547cca3a2da5fd4/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/uezo/items/4a21d547cca3a2da5fd4/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/uezo/items/4a21d547cca3a2da5fd4/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/uezo/items/4a21d547cca3a2da5fd4.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-6ed6d8d1-f855-4b8e-a1d2-6539b8b9540b">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-238fc73a-a809-489d-8b8f-27aabb3c9e07"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-238fc73a-a809-489d-8b8f-27aabb3c9e07">{}</script>
      
<div id="LoginModal-react-component-1165a434-3ce7-46da-a728-ca81664eb087"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-1165a434-3ce7-46da-a728-ca81664eb087">{}</script>
      
<div id="StockModal-react-component-2b04ac30-9a7d-4638-9476-712fdca8cf3b"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-2b04ac30-9a7d-4638-9476-712fdca8cf3b">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;swMcnARa6szstZM0Qci4DXg2B9uAmss7J16VhEsuLnIoTTj4hVxj0vGTpHGLkdT7eBz8bjhstbWCyORCNYRxew==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003eNuGetを検索するとAzure Table Storage用のTargetをいくつか見かけますが、.NET Coreへの対応状況や依存ライブラリの最新化状況などの制約があって微妙です。\u003cbr\u003e\nまた、Azure Table StorageまわりのSDKはCosmosDBに切り出されたりしてややこしいので、たかがEntityの追加のみで依存関係を増やしたくありません。\u003cbr\u003e\nそんなわけで、NLog標準の\u003ccode\u003eWebServiceTarget\u003c/code\u003eを使った書き込みを試したら結構ハマりどころがあったので共有します。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"事前準備\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e事前準備\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"コンソールアプリのプロジェクトを作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコンソールアプリのプロジェクトを作成\u003c/h2\u003e\n\n\u003cp\u003eターゲットフレームワークはNLogがサポートするものであれば何でも良いですが、.NET Core 2.0〜3.0までで動作確認をしました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"nlogのインストール\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#nlog%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNLogのインストール\u003c/h2\u003e\n\n\u003cp\u003eNuGetからインストールします。この記事では4.6.8の利用を前提としていますが、多少前後しても問題ないと思います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"azure-storageのsas-urlの作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#azure-storage%E3%81%AEsas-url%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eAzure StorageのSAS URLの作成\u003c/h2\u003e\n\n\u003cp\u003eSASとはShared Access Signatureの略で、あらかじめリソースやそれに対するアクション（参照、書き込みなど）、利用可能期間を制限したトークンです。これを含むURLを使うことで、リクエスト都度署名をするといった手間も省けるためWebServiceTargetで利用する上では好都合というわけです。\u003c/p\u003e\n\n\u003cp\u003e作成は簡単で、Azure Portalで対象ストレージアカウントを選択し、メニューの「Shared Access Signature」に移動します。対象リソースなどを選んで「SASと接続文字列を作成する」ボタンを押下後、表示された「Table service の SAS URL」を控えておいてください。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/1fe92b995824726fd4aa1985411c5b91d8216996/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f35333239362f63383138353961322d313365312d376338352d623631332d6465313863663966326333642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"1440\" alt=\"azureportal.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F53296%2Fc81859a2-13e1-7c85-b613-de18cf9f2c3d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=dc15be04b6c06954f5168c8d20229723\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/53296/c81859a2-13e1-7c85-b613-de18cf9f2c3d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F53296%2Fc81859a2-13e1-7c85-b613-de18cf9f2c3d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b596c893099605296c017a13db1703f6 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"nlogの設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#nlog%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNLogの設定\u003c/h1\u003e\n\n\u003cp\u003eまずは以下の通り\u003ccode\u003eWebServiceTarget\u003c/code\u003eを設定します。名前は何でもいいですが、ここでは\u003ccode\u003eAZTBLTarget\u003c/code\u003eとしてみました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eNLog.config\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?xml version=\"1.0\" encoding=\"utf-8\" ?\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;nlog\u003c/span\u003e \u003cspan class=\"na\"\u003exmlns=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://www.nlog-project.org/schemas/NLog.xsd\"\u003c/span\u003e\n      \u003cspan class=\"na\"\u003exmlns:xsi=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://www.w3.org/2001/XMLSchema-instance\"\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ethrowExceptions=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"true\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n\n    \u003cspan class=\"nt\"\u003e\u0026lt;targets\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;target\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"AZTBLTarget\"\u003c/span\u003e \u003cspan class=\"na\"\u003exsi:type=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"WebService\"\u003c/span\u003e \u003cspan class=\"na\"\u003eprotocol=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"JsonPost\"\u003c/span\u003e \u003cspan class=\"na\"\u003eurl=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u0026lt;SAS URL\u0026gt;\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;parameter\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"PartitionKey\"\u003c/span\u003e \u003cspan class=\"na\"\u003elayout=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"${callsite}\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;parameter\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"RowKey\"\u003c/span\u003e \u003cspan class=\"na\"\u003elayout=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"${ticks}.${sequenceid:padCharacter=0:padding=6}\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;parameter\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"LocalTimestamp\"\u003c/span\u003e \u003cspan class=\"na\"\u003elayout=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"${date:format=yyyy-MM-ddTHH\\:mm\\:ss.fffffff}\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;parameter\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Level\"\u003c/span\u003e \u003cspan class=\"na\"\u003elayout=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"${level:uppercase=true}\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;parameter\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Callsite\"\u003c/span\u003e \u003cspan class=\"na\"\u003elayout=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"${callsite}\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;parameter\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Message\"\u003c/span\u003e \u003cspan class=\"na\"\u003elayout=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"${message}\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;parameter\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Error\"\u003c/span\u003e \u003cspan class=\"na\"\u003elayout=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"${exception:format=Message, ToString:separator=\\n}\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/target\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/targets\u0026gt;\u003c/span\u003e\n\n    \u003cspan class=\"nt\"\u003e\u0026lt;rules\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;logger\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"*\"\u003c/span\u003e \u003cspan class=\"na\"\u003eminlevel=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Trace\"\u003c/span\u003e \u003cspan class=\"na\"\u003ewriteTo=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"AZTBLTarget\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/rules\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/nlog\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e簡単に説明すると、ターゲットの種類として\u003ccode\u003eWebService\u003c/code\u003eのものを定義していて、その通信手続きとしてJSONデータのPOST、そのJSONのパラメータとして\u003ccode\u003ePartitionKey\u003c/code\u003eや\u003ccode\u003eRowKey\u003c/code\u003eを含む7項目を送信するようにしています。なお\u003ccode\u003ePartitionKey\u003c/code\u003eと\u003ccode\u003eRowKey\u003c/code\u003eはTable Storageとして必須の項目です。\u003c/p\u003e\n\n\u003cp\u003eさて、説明の中で\u003ccode\u003eurl\u003c/code\u003eアトリビュートの説明を飛ばしていましたが、ここがハマりポイントです。コピペして\u003ccode\u003eurl\u003c/code\u003eに貼り付けるだけではうまくいきません。先の手順で取得したSAS URLを、以下の通り修正する必要があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e生成されたもの\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ehttps://accountname.table.core.windows.net/?\u0026amp;sv=2019-02-02\u0026amp;ss=t\u0026amp;srt=sco\u0026amp;sp=wau\u0026amp;se=2030-01-04T08:21:42Z\u0026amp;st=2020-01-04T00:21:42Z\u0026amp;spr=https\u0026amp;sig=xxxxxxxxx%3D\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e修正後\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ehttps://accountname.table.core.windows.net/nlogtable?$format=application/json\u0026amp;amp;sv=2019-02-02\u0026amp;amp;ss=t\u0026amp;amp;srt=sco\u0026amp;amp;sp=wau\u0026amp;amp;se=2030-01-04T08:21:42Z\u0026amp;amp;st=2020-01-04T00:21:42Z\u0026amp;amp;spr=https\u0026amp;amp;sig=xxxxxxxxx%3D\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e修正内容は以下の通り。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eURIの末尾に\u003ccode\u003e/\u0026lt;テーブル名\u0026gt;\u003c/code\u003eをつける。当たり前ですが、コピペでは動かず一瞬「ウッ」てなります。修正後の例は、テーブル名を\u003ccode\u003enlogtable\u003c/code\u003eのケースです。\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003e\u0026amp;\u003c/code\u003eを\u003ccode\u003e\u0026amp;amp;\u003c/code\u003eに置換。これもXMLに一般的な話だと思いますが、エラーになるので小心者の私は「えっえっ」てなりました。\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003e$format=application/json\u003c/code\u003eをつける。\u003ca href=\"https://docs.microsoft.com/ja-jp/rest/api/storageservices/insert-entity\" rel=\"nofollow noopener\" target=\"_blank\"\u003eInsert Entityの仕様\u003c/a\u003eを見る限り\u003ccode\u003eAccept\u003c/code\u003eヘッダーは任意なのですが、なぜかこれを渡さないと\u003ccode\u003e415\u003c/code\u003eエラーとなります。しかしながらNLogのWebServiceTargetではなぜかHTTPヘッダーに\u003ccode\u003eAccept\u003c/code\u003eを設定することができませんでした。諦めかけていたところ、\u003ca href=\"https://docs.microsoft.com/en-us/rest/api/storageservices/payload-format-for-table-service-operations\" rel=\"nofollow noopener\" target=\"_blank\"\u003ePayload format for Table service operations\u003c/a\u003eを読んだら\u003ccode\u003e$format\u003c/code\u003eで指定できることを発見したため、これをURLに含んでやります。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ログの書き込み\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%AD%E3%82%B0%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eログの書き込み\u003c/h1\u003e\n\n\u003cp\u003eそれでは実際に書き込んでみましょう。本記事のポイントは設定方法ですので、書き込み自体は一般的な手順に従えばOKかと思います。ちょっとハマるかもしれないポイントとしては、最終行の\u003ccode\u003eLogManager.Shutdown();\u003c/code\u003eを実行しないと、ログ送信前にプロセスが終了してしまいTable Storgeに書き込まれない場合があるところでしょうか。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNLog\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eNLogToAzureTable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// NLog.configを出力ディレクトリにコピーするように設定してください。\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// もしくは、以下の通り明示的にパスを指定することもできます。2つめの引数falseはエラーを無視するか否かの設定です（false=無視しない）\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// LogManager.Configuration = new XmlLoggingConfiguration(\"/path/to/NLog.config\", false);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// ロガーの初期化・取得\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elogger\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLogManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCurrentClassLogger\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// ログの書き込み\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elogger\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"test message for info\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elogger\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWarn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"test message for warn\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// ロガーの終了。プロセスを終了する前にログを送信するために必要\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eLogManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eShutdown\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"非同期書き込みの利用\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9F%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E3%81%AE%E5%88%A9%E7%94%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e非同期書き込みの利用\u003c/h1\u003e\n\n\u003cp\u003eNLogには便利な非同期処理の仕組み\u003ccode\u003eAsyncWrapper\u003c/code\u003eターゲットがあります。ログメッセージをキューに貯めてバッチ的に別スレッドで処理してくれるといった便利なものです。\u003cbr\u003e\n使い方は超簡単で、\u003ccode\u003etargets\u003c/code\u003eの\u003ccode\u003easync\u003c/code\u003eアトリビュートに\u003ccode\u003etrue\u003c/code\u003eを設定するだけで全てのターゲットへの書き込みが非同期に行われます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eNLog.config\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e：中略\n\u003cspan class=\"nt\"\u003e\u0026lt;targets\u003c/span\u003e \u003cspan class=\"na\"\u003easync=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"true\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n：中略\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e一部の書き込みのみを非同期にしたい場合は、ラッパーの名の通り非同期にしたいターゲットを\u003ccode\u003eAsyncWrapper\u003c/code\u003eで囲みます。このとき、\u003ccode\u003erule\u003c/code\u003eに設定する\u003ccode\u003ename\u003c/code\u003eもラッパーのものにすることに注意です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eNLog.config\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"nt\"\u003e\u0026lt;targets\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;target\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"AZTBLTargetAsync\"\u003c/span\u003e \u003cspan class=\"na\"\u003exsi:type=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"AsyncWrapper\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;target\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"AZTBLTarget\"\u003c/span\u003e \u003cspan class=\"na\"\u003exsi:type=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"WebService\"\u003c/span\u003e \u003cspan class=\"na\"\u003eprotocol=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"JsonPost\"\u003c/span\u003e \u003cspan class=\"na\"\u003eurl=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u0026lt;SAS URL\u0026gt;\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"nt\"\u003e\u0026lt;parameter\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"PartitionKey\"\u003c/span\u003e \u003cspan class=\"na\"\u003elayout=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"${callsite}\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n                 ：中略\n            \u003cspan class=\"nt\"\u003e\u0026lt;/target\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/target\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/targets\u0026gt;\u003c/span\u003e\n\n    \u003cspan class=\"nt\"\u003e\u0026lt;rules\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;logger\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"*\"\u003c/span\u003e \u003cspan class=\"na\"\u003eminlevel=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Trace\"\u003c/span\u003e \u003cspan class=\"na\"\u003ewriteTo=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"AZTBLTargetAsync\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/rules\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e詳細は公式Wikiを読んでみてください。\u003cbr\u003e\n\u003ca href=\"https://github.com/nlog/NLog/wiki/AsyncWrapper-target\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/nlog/NLog/wiki/AsyncWrapper-target\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"補足\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A3%9C%E8%B6%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e補足\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003ePartitionKey\u003c/code\u003eに設定する値。記事では便宜上出力元メソッドの名前を指定していますが、ユーザーとかデバイスとかを一意に特定できるものを設定した方が調査しやすいと思います・\u003c/li\u003e\n\u003cli\u003eパフォーマンスや負荷は未知数。\u003ccode\u003eAsyncWrapper\u003c/code\u003eを使うことでメイン処理への影響はないと思いますが、書き込み速度や負荷は計測していません。WebServiceTargetに一般的な議論かと思います。詳しい方アドバイスください！！\u003c/li\u003e\n\u003cli\u003e出力レベル。そもそもリモートでログを取る時点で常にデバッグ情報が欲しいわけではないと思いますので、\u003ccode\u003eminlevel\u003c/code\u003eをエラーに設定するなど最適化が必要です。\u003c/li\u003e\n\u003cli\u003eLogging Frameworkについて。実装ライブラリを自由に変更できるようにDIなフレームワークが.NET Coreでは用意されていますが、今回は未考慮です。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おまけunityでnlogを使ってazure-table-storageに書き込み\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%81%BE%E3%81%91unity%E3%81%A7nlog%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6azure-table-storage%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおまけ：UnityでNLogを使ってAzure Table Storageに書き込み\u003c/h1\u003e\n\n\u003cp\u003eそもそも何でAzure Table Storageにログを書き込もうと思ったかというと、\u003ca href=\"https://www.gatebox.ai/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGatebox\u003c/a\u003eというデバイス向けのアプリ開発をはじめたことがきっかけです。実機デバッグする際にコンソール出力やファイルファイルを選択できないことから、リモートにログ出力をする方法を探ることにしました。ログのためにサーバーを用意するのもアレなのでAzureに・・・という経緯です。\u003c/p\u003e\n\n\u003cp\u003eUnityのConsoleへのログ出力用ターゲットも同梱したファクトリーぽいものを作りましたのでよかったら使ってみてください。\u003c/p\u003e\n\n\u003cp\u003eNLogFactoryForUnity\u003cbr\u003e\n\u003ca href=\"https://github.com/uezo/NLogFactoryForUnity\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/uezo/NLogFactoryForUnity\u003c/a\u003e\u003c/p\u003e\n","createdAt":"2020-01-04T12:36:18Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"xfE3u/bwnQeGkie7ztA+gucnKYGowQumCA==--ZIE8s9FL9ZxwRCnD--37pnUXXmnzJugMk4xvfzDQ==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2020-01-04T12:36:18Z","likesCount":1,"linkUrl":"https://qiita.com/uezo/items/4a21d547cca3a2da5fd4","organization":null,"originalId":1130101,"stockedCount":0,"title":"NLogを使ってAzure Table Storageにログを書きこむ","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99\"\u003e事前準備\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90\"\u003eコンソールアプリのプロジェクトを作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#nlog%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\"\u003eNLogのインストール\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#azure-storage%E3%81%AEsas-url%E3%81%AE%E4%BD%9C%E6%88%90\"\u003eAzure StorageのSAS URLの作成\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#nlog%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003eNLogの設定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%AD%E3%82%B0%E3%81%AE%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\"\u003eログの書き込み\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9F%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E3%81%AE%E5%88%A9%E7%94%A8\"\u003e非同期書き込みの利用\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A3%9C%E8%B6%B3\"\u003e補足\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%81%BE%E3%81%91unity%E3%81%A7nlog%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6azure-table-storage%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\"\u003eおまけ：UnityでNLogを使ってAzure Table Storageに書き込み\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":1839,"uuid":"4a21d547cca3a2da5fd4","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"zXxaDBee+i/Oiwyzh+OnSEfH9gY=--rQBgn12t00mdy4po--Uc0Z8JQMabNVmdhJMq2yzQ==","originalId":53296,"description":"理想の妹を追い求め、最近はチャットボットとGateboxアプリを中心に開発しているホビープログラマー。\r\n高校卒業後に単身上京し、バリスタの見習いをしながら独学でプログラミングを習得。損害保険会社にスカウトされたのをきっかけに、以後複数の金融機関でDX戦略のテックリードを担当。","facebookUrl":null,"githubUrl":"https://github.com/uezo","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/53296/profile-images/1597841671","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F53296%2Fprofile-images%2F1597841671?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=d2faa76469f977de3f1d4bb08893b185","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F53296%2Fprofile-images%2F1597841671?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=054f1773c9568af2ec8446d98b2281ab","urlName":"uezo","websiteUrl":"http://uezo.net","twitterUrl":"https://twitter.com/uezochan","twitterUrlName":"uezochan","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Azure","urlName":"azure"},{"name":"Unity","urlName":"unity"},{"name":"NLog","urlName":"nlog"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
