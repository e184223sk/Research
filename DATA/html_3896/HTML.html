<!DOCTYPE html><html><head><meta charset="utf-8" /><title>【C#】Cドライブ以下にある全てのファイルパスを非同期かつIEnumerableに取得してみた - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/OXamarin/items/51c0d713910895a9ccba" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="oiTFD0bZli7hDOH0VAm4SVulyWJEOKwYXG2WWhD5/BhweE5tGJ1CCm9Ow04jJ0HNJ1q6jbz0nDqoLHeVroIpAQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@OXamarin" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="【C#】Cドライブ以下にある全てのファイルパスを非同期かつIEnumerableに取得してみた - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRUXlQamdKRkQ0NE9KNDRPcDQ0S2s0NE9XNUx1bDVMaUw0NEdyNDRHQzQ0S0w1WVdvNDRHbTQ0R3U0NE9WNDRLaDQ0S2s0NE9yNDRPUjQ0SzU0NEtTNloyZTVaQ001cHlmNDRHTDQ0R2tTVVZ1ZFcxbGNtRmliR1hqZ2F2bGo1Ymx2cGZqZ1pmamdhYmpnYl9qZ1o4JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTA5OGJmMDE0ZTc5NGM1MzY5ZGQxOTc1NGVjMTQyMmIy&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRTlZWVcxaGNtbHUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1kMmJiNDhiMWE1YzNhZTE2MTQzMTllMDk2ODVmYWFhNw&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=2704c7590c552e50881c592cdf6f2ab8"><meta property="og:description" content="(2019/02/09 更新)
C# 8.0を試してみましたが上手くいきませんでした(´･ω･｀)

(2019/02/10 更新)
tangoさんよりアドバイス頂き、async/await で非同期的にCドラ以下のファイルを取得にボ..."><meta content="https://qiita.com/OXamarin/items/51c0d713910895a9ccba" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,WPF,task,async,await" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-4d5ece89-aeab-40c9-98d5-1b86301c06b4"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FOXamarin%2Fitems%2F51c0d713910895a9ccba">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FOXamarin%2Fitems%2F51c0d713910895a9ccba">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-4d5ece89-aeab-40c9-98d5-1b86301c06b4">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-02-08T00:07:56.000+09:00","dateModified":"2019-02-15T00:51:53.000+09:00","headline":"【C#】Cドライブ以下にある全てのファイルパスを非同期かつIEnumerableに取得してみた","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRUXlQamdKRkQ0NE9KNDRPcDQ0S2s0NE9XNUx1bDVMaUw0NEdyNDRHQzQ0S0w1WVdvNDRHbTQ0R3U0NE9WNDRLaDQ0S2s0NE9yNDRPUjQ0SzU0NEtTNloyZTVaQ001cHlmNDRHTDQ0R2tTVVZ1ZFcxbGNtRmliR1hqZ2F2bGo1Ymx2cGZqZ1pmamdhYmpnYl9qZ1o4JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTA5OGJmMDE0ZTc5NGM1MzY5ZGQxOTc1NGVjMTQyMmIy\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRTlZWVcxaGNtbHUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1kMmJiNDhiMWE1YzNhZTE2MTQzMTllMDk2ODVmYWFhNw\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=2704c7590c552e50881c592cdf6f2ab8","mainEntityOfPage":"https://qiita.com/OXamarin/items/51c0d713910895a9ccba","author":{"@type":"Person","address":"","email":null,"identifier":"OXamarin","name":"OXamarin","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fpbs.twimg.com%2Fprofile_images%2F812609627082792961%2FQC9U4qVV_normal.jpg?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=d8dafa4a0e71caf83d0faa285fffbbc5","url":"https://qiita.com/OXamarin","description":"Xamarin(ザマリン と読みます)の情報を超入門的な所から扱っています。\r\n「Xamarinでぐぐれ」と言えるようになりたいです。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202106-uzabase-3/">社員の行動の基盤となるユーザベースのミッション・バリュー</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202106-uzabase-3/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"OXamarin","type":"items","id":"51c0d713910895a9ccba"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"社員の行動の基盤となるユーザベースのミッション・バリュー","url":"https://zine.qiita.com/interview/202106-uzabase-3/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"OXamarin","type":"items","id":"51c0d713910895a9ccba"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"社員の行動の基盤となるユーザベースのミッション・バリュー","url":"https://zine.qiita.com/interview/202106-uzabase-3/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"OXamarin","type":"items","id":"51c0d713910895a9ccba"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"社員の行動の基盤となるユーザベースのミッション・バリュー","url":"https://zine.qiita.com/interview/202106-uzabase-3/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/OXamarin/items/51c0d713910895a9ccba","location":"/OXamarin/items/51c0d713910895a9ccba","scheme":"https","host":"qiita.com","port":null,"pathname":"/OXamarin/items/51c0d713910895a9ccba","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"h8266HZKj29/yRyi5bYakF24xBsi4r5SDKz0k2CwOH5VkTGKKA5bS/GLPhiSmOMUIUe39NoujnD47RVc3svtZw==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-b0580e84-c547-4038-ada1-e88ee1e2e7c1"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/OXamarin/items/51c0d713910895a9ccba/likers" class="css-1iupg5d">47</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">45</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/51c0d713910895a9ccba/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/OXamarin/items/51c0d713910895a9ccba/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/OXamarin/items/51c0d713910895a9ccba/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/OXamarin/items/51c0d713910895a9ccba/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/OXamarin/items/51c0d713910895a9ccba.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/OXamarin"><img class="css-100alwu eyfquo10" src="https://pbs.twimg.com/profile_images/812609627082792961/QC9U4qVV_normal.jpg" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/OXamarin" class="css-10ougpm">@<!-- -->OXamarin</a><div class="css-1ay9vb9"><span><meta content="2019-02-07T15:07:56Z"/><time dateTime="2019-02-14T15:51:53Z" class="css-m19uds">updated at 2019-02-14</time></span></div></div></div></div></div><h1 class="css-cgzq40">【C#】Cドライブ以下にある全てのファイルパスを非同期かつIEnumerableに取得してみた</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/wpf" class="css-4czcte">WPF</a><a href="/tags/task" class="css-4czcte">task</a><a href="/tags/async" class="css-4czcte">async</a><a href="/tags/await" class="css-4czcte">await</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p><strong>(2019/02/09 更新)</strong><br>
<code>C# 8.0</code>を試してみましたが上手くいきませんでした(´･ω･｀)</p>

<p><strong>(2019/02/10 更新)</strong><br>
tangoさんよりアドバイス頂き、<a href="https://qiita.com/OXamarin/items/51c0d713910895a9ccba#asyncawait-%E3%81%A7%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%ABc%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97">async/await で非同期的にCドラ以下のファイルを取得</a>にボタンがマウスホバーでない場合にボタンが非ブロッキング状態になるように教えて頂きましたので追記しました。ありがとうございます！</p>

<p><strong>(2019/02/14 更新)</strong><br>
<a href="https://qiita.com/OXamarin/items/51c0d713910895a9ccba#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%94%B9%E5%96%84">パフォーマンス改善</a>を追記しました。</p>

<h1>
<span id="背景" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>背景</h1>

<p>(自称)最強のファイル検索ソフトである<code>EveryThing</code>を愛用しているわけですが、このソフトだとネットワークドライブのファイルまで見に行きたいいけない！！</p>

<p>そうだ！ネットワークドライブまで見に行けるファイル検索をつくろう！！！<br>
んでもって、<strong>画面が固まらないように！！そして途中キャンセルできるようにしよう！！！！</strong></p>

<p>そう考えて作ってみると思ったよりも格段に難しかったのでメモとして残しておきます。マサカリ大歓迎！</p>

<p>そしてツール完成間近、EveryThing がネットワークドライブのファイルまで見に行けることを知る事となるとはこの時、知る由もなかった。。。</p>

<h1>
<span id="こういうことがやりたい" class="fragment"></span><a href="#%E3%81%93%E3%81%86%E3%81%84%E3%81%86%E3%81%93%E3%81%A8%E3%81%8C%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>こういうことがやりたい</h1>

<p>書いてみたら意外と長くなってしまったので、最初に結論というか最終成果物。<br>
<a href="https://camo.qiitausercontent.com/4e962a468358debca5331ba60f06b4a28e740c2e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f63666364636362302d333332332d303865362d383034352d6637386530643633663331652e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fcfcdccb0-3323-08e6-8045-f78e0d63f31e.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=15030ef6145b1b70e7f0b422f041ede2" alt="非同期7.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/cfcdccb0-3323-08e6-8045-f78e0d63f31e.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fcfcdccb0-3323-08e6-8045-f78e0d63f31e.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b6ef1536d66def6c2039fbe8da037d09 1x" loading="lazy"></a></p>

<ul>
<li>Cドライブ以下にあるファイルを全取得出来るようにする</li>
<li>画面が固まらないように非同期で処理する</li>
<li>ファイル数が膨大なのでキャンセル可能にする</li>
</ul>

<p>同期処理での記述から始めて、最終的にこれらの条件を満たしていくようにしていきます。</p>

<h1>
<span id="directoryenumeratefiles-がcドラ直下だと役に立たない件" class="fragment"></span><a href="#directoryenumeratefiles-%E3%81%8Cc%E3%83%89%E3%83%A9%E7%9B%B4%E4%B8%8B%E3%81%A0%E3%81%A8%E5%BD%B9%E3%81%AB%E7%AB%8B%E3%81%9F%E3%81%AA%E3%81%84%E4%BB%B6"><i class="fa fa-link"></i></a>Directory.EnumerateFiles がCドラ直下だと役に立たない件</h1>

<p><code>C#</code>では<code>Directoryクラス</code>にファイル列挙メソッドが用意されています。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">folderPath</span> <span class="p">=</span> <span class="s">@"C:\"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">files</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">,</span> <span class="s">"*"</span><span class="p">,</span> <span class="n">SearchOption</span><span class="p">.</span><span class="n">AllDirectories</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>
</code></pre></div>
</div>

<p>え、これだけでネットワークパスまでファイル取りに行ける！楽勝じゃん！<br>
<a href="https://camo.qiitausercontent.com/84fd75d2c7133895b36056c06f5f757f5d80950d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f37396665326666392d633930322d626639392d626438322d3531313431366463386363302e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F79fe2ff9-c902-bf99-bd82-511416dc8cc0.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c49ea782a693d016184847e0f9788468" alt="maxresdefault.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/79fe2ff9-c902-bf99-bd82-511416dc8cc0.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F79fe2ff9-c902-bf99-bd82-511416dc8cc0.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a4e1b6d56312ae3f2c938b24f37f35e5 1x" loading="lazy"></a></p>

<p>実際に上記を実行してみると<br>
<a href="https://camo.qiitausercontent.com/3fc5275b6b84e765383898f09207b514741d2660/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f35346239663732382d613231312d306564322d626162392d6163306263386336623035372e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F54b9f728-a211-0ed2-bab9-ac0bc8c6b057.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b4056f006de41a899b32ad6ff54871a5" alt="キャプチャ.JPG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/54b9f728-a211-0ed2-bab9-ac0bc8c6b057.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F54b9f728-a211-0ed2-bab9-ac0bc8c6b057.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=13082fee9129ba463e8a5832de0a79a5 1x" loading="lazy"></a></p>

<p><strong>「C:\$Recycle.Bin\S-1-5-18」</strong>てなんぞ。<br>
なんか知らんけど、存在しないフォルダにアクセスしようとしてみただけなのか？<br>
<a href="https://camo.qiitausercontent.com/38f011ebb5d1de9be2aceb8db1eb77bb305049c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f34356566393561642d346431612d303562362d386535332d6434636665306362336135312e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F45ef95ad-4d1a-05b6-8e53-d4cfe0cb3a51.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7133854dcc428e5dac634335fae93af2" alt="キャプチャ.JPG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/45ef95ad-4d1a-05b6-8e53-d4cfe0cb3a51.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F45ef95ad-4d1a-05b6-8e53-d4cfe0cb3a51.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f85f32311f325f251145ab5c6ebd28f2 1x" loading="lazy"></a><br>
ほう？<br>
<a href="https://camo.qiitausercontent.com/da6431b1efe348848d675283708f8a4751ca3726/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f61353835633364302d653365632d396537302d356233622d3831333163356532353461662e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fa585c3d0-e3ec-9e70-5b3b-8131c5e254af.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2dfd693cf2dd761acee7ce3e26b8eed1" alt="キャプチャ.JPG" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/a585c3d0-e3ec-9e70-5b3b-8131c5e254af.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fa585c3d0-e3ec-9e70-5b3b-8131c5e254af.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=fe5ac11723df6dc036894aac414d1003 1x" loading="lazy"></a><br>
ほうほう…。<br>
なにやら、<code>Directory.EnumerateFilesメソッド</code>でアクセス権限のないシステムフォルダなどを覗き見ようとした際にこのようになってしまうようだ。どうしたものか。</p>

<h1>
<span id="try-catch-で全てを握りつぶしてcドラ以下のファイルを取得する" class="fragment"></span><a href="#try-catch-%E3%81%A7%E5%85%A8%E3%81%A6%E3%82%92%E6%8F%A1%E3%82%8A%E3%81%A4%E3%81%B6%E3%81%97%E3%81%A6c%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>try catch で全てを握りつぶしてCドラ以下のファイルを取得する</h1>

<p>キータ内でそれっぽい記事があったので拝借します。<br>
<a href="https://qiita.com/OneK/items/8b0d02817a9f2a2fbeb0" id="reference-6aa3c6508ae5143e251e">【C#】ドライブ直下からのファイルリスト取得について</a></p>

<blockquote>
<p>検索元のディレクトリの指定「C:\」や「D:\」といったドライブ直下にした時、プログラムがコケるケースがあった。<br>
原因は隠しフォルダの「RECYCLE.BIN」で、要は操作しているユーザのアクセス権が無いゴミ箱（他のユーザのゴミ箱だったりとか）を読み取ることができずに例外を吐いて死んでしまうことに気がついた。<br>
これを回避するためには、再帰処理に読み取れなかった場合を考慮してちゃんとtry~catchしてあげればいいという単純なもの。</p>
</blockquote>

<p>ふむふむ、なるほどなるほど。<br>
確かに再帰的にアクセスして例外が発生したものだけを無視すればよさそう。実際に測ってみた。</p>

<p>また、計測にあたって明らかに不要かつどのPCにもありそうなフォルダに関しては検索段階で弾くようにする。<br>
具体的には、以下のフィールド内のどれかにフォルダパスの接頭辞が該当した場合には検索対象外とした。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// 検索フォルダから除外する</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">HashSet</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_exceptFolder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="s">@"C:\Windows"</span><span class="p">,</span> <span class="c1">//システムファイルが多すぎる</span>
    <span class="s">@"C:\Users\All Users"</span><span class="p">,</span>
    <span class="s">@"C:\$Recycle.Bin"</span><span class="p">,</span> <span class="c1">//ゴミ箱</span>
    <span class="s">@"C:\Recovery"</span><span class="p">,</span>
    <span class="s">@"C:\Config.Msi"</span><span class="p">,</span> <span class="c1">//起動して最初に実行されるらしい</span>
    <span class="s">@"C:\Documents and Settings"</span><span class="p">,</span> <span class="c1">//デスクトップとかマイドキュメントなど</span>
    <span class="s">@"C:\System Volume Information"</span><span class="p">,</span>
    <span class="s">@"C:\Program Files\windows nt\アクセサリ"</span><span class="p">,</span>
    <span class="s">@"C:\ProgramData\Application Data"</span><span class="p">,</span> <span class="c1">//よくある隠しフォルダ</span>
<span class="p">};</span>
</code></pre></div>
</div>

<table>
<thead>
<tr>
<th style="text-align: left">ファイル件数</th>
<th style="text-align: left">掛かった時間</th>
<th style="text-align: left">プロセスメモリ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">648,721件</td>
<td style="text-align: left">46秒</td>
<td style="text-align: left">214MB</td>
</tr>
</tbody>
</table>

<h1>
<span id="ienumerable型でcドラ以下のファイルを取得する" class="fragment"></span><a href="#ienumerable%E5%9E%8B%E3%81%A7c%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>IEnumerable型でCドラ以下のファイルを取得する</h1>

<p>Cドラ以下のファイルが無事に取得できる事は確認できました。<br>
ただ私が作りたいのは、<strong>画面が固まらず、キャンセル可能</strong>なファイル取得です。<br>
つまりこういういめーじ。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="n">CancellationTokenSource</span> <span class="n">_cancellationTokenSource</span><span class="p">;</span>
<span class="k">private</span> <span class="n">CancellationToken</span> <span class="n">_cancellationToken</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">bool</span> <span class="n">_isExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

<span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">Button_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//実行中にもう一度押されたらタスクのキャンセルを行う</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_isExecute</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_isExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">_isExecute</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="n">_cancellationTokenSource</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
    <span class="n">_cancellationToken</span> <span class="p">=</span> <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">;</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">//スレッドプールさん、処理をお願いします何でもしますから</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="c1">//ファイル取得</span>
            <span class="kt">var</span> <span class="n">filePaths</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="s">@"C:\"</span><span class="p">);</span>

            <span class="c1">//一回でList型で取得するのではなく</span>
            <span class="c1">//1ファイル読み込み毎に何らかの処理をしたいからIEnumerable型で取得したい</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">filePath</span> <span class="k">in</span> <span class="n">filePaths</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//タスクのキャンセルがされていたら例外を投げる</span>
                <span class="n">_cancellationToken</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>

                <span class="c1">//1ファイル読み込み毎に何らかの処理</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="n">_cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="c1">//ignore</span>
    <span class="p">}</span>
    <span class="k">finally</span>
    <span class="p">{</span>
        <span class="n">_isExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>上記のソースコードでいう、「1ファイル毎の～～」の部分を実現する為に<code>IEnumerable型</code>で取得してみました。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// ファイルパスの全取得(同期処理でならこれでよい)</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="c1">/// &lt;param name="folderPath"&gt;&lt;/param&gt;</span>
<span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="k">private</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetAllFiles</span><span class="p">(</span><span class="kt">string</span> <span class="n">folderPath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">directories</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">directories</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateDirectories</span><span class="p">(</span><span class="n">folderPath</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">_exceptFolder</span><span class="p">.</span><span class="nf">All</span><span class="p">(</span><span class="n">y</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">x</span><span class="p">.</span><span class="nf">StartsWith</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">)))</span>
            <span class="p">.</span><span class="nf">SelectMany</span><span class="p">(</span><span class="n">GetAllFiles</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">directories</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//同階層のファイル取得をして再帰的に同階層のフォルダを検索しに行く</span>
    <span class="k">return</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">).</span><span class="nf">Concat</span><span class="p">(</span><span class="n">directories</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>また、計測するにあたって、以下の2パターンで計測してみます。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">//パターン1</span>
<span class="c1">//IEnumerable型で取得した後にList化して初めからListで返すパターンとの比較を行う</span>
<span class="kt">var</span> <span class="n">files</span> <span class="p">=</span> <span class="nf">GetAllFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>

<span class="c1">//パターン2</span>
<span class="c1">//IEnumerableで取得したものをforeachで展開させる</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="nf">GetAllFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">//ignore</span>
<span class="p">}</span>
</code></pre></div>
</div>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">ファイル件数</th>
<th style="text-align: left">掛かった時間</th>
<th style="text-align: left">プロセスメモリ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">パターン1</td>
<td style="text-align: left">648,772件</td>
<td style="text-align: left">46秒</td>
<td style="text-align: left">208MB</td>
</tr>
<tr>
<td style="text-align: left">パターン2</td>
<td style="text-align: left">648,772件</td>
<td style="text-align: left">52秒</td>
<td style="text-align: left">38MB</td>
</tr>
</tbody>
</table>

<p>まぁこんなもんだよね。<br>
完全に蛇足だとは思いますが、念の為このメソッドを使ってUIを更新してみます。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">Button_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">folderPath</span> <span class="p">=</span> <span class="s">@"C:\"</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="nf">GetAllFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">).</span><span class="nf">Select</span><span class="p">((</span><span class="k">value</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="p">{</span> <span class="k">value</span><span class="p">,</span> <span class="n">index</span> <span class="p">}))</span>
    <span class="p">{</span>
        <span class="c1">//Dispatcher.InvokeでUIスレッドに処理をさせる</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">txtFileCount</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="n">index</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span> <span class="p">+</span> <span class="n">file</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/85640cdbc66f787345997097febec5f660180ac4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f33356438656130612d663235352d306433392d346362652d3234653039383765656230622e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F35d8ea0a-f255-0d39-4cbe-24e0987eeb0b.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e804531ea2cf2a92846cd8bbea4ec395" alt="同期処理.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/35d8ea0a-f255-0d39-4cbe-24e0987eeb0b.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F35d8ea0a-f255-0d39-4cbe-24e0987eeb0b.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=bd3a04a70e8fa7dbeff930e8d56fe38e 1x" loading="lazy"></a><br>
はい、まあそらそうですね、、って感じの結果です。<br>
全ての処理をシングルスレッドで行っているので画面は固まったまんまです。<br>
Cドラ以下のファイルを全取得し終わるまでボタンも押せない。<br>
ふつーに書いてたらまあこうなるよね。</p>

<h1>
<span id="asyncawait-で非同期的にcドラ以下のファイルを取得" class="fragment"></span><a href="#asyncawait-%E3%81%A7%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%ABc%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>async/await で非同期的にCドラ以下のファイルを取得</h1>

<p>ここからようやく本題、非同期処理で画面を更新させていきます。<br>
サクッと非同期にする。<code>async void</code>はイベントハンドラにだけ許された特権( ˘ω˘)</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">Button_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">folderPath</span> <span class="p">=</span> <span class="s">@"C:\"</span><span class="p">;</span>

    <span class="c1">//スレッドプールに処理を任せといた</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="nf">GetAllFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">).</span><span class="nf">Select</span><span class="p">((</span><span class="k">value</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="p">{</span> <span class="k">value</span><span class="p">,</span> <span class="n">index</span> <span class="p">}))</span>
        <span class="p">{</span>
            <span class="c1">//UIスレッドに戻ってきてUIを更新させる</span>
            <span class="k">this</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">txtFileCount</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="n">index</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span> <span class="p">+</span> <span class="n">file</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/5f699be3e65fbffa6519d7ab4ff16e9968390f94/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f33636331626132312d356163652d613830372d306261662d6361646132346138366234392e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F3cc1ba21-5ace-a807-0baf-cada24a86b49.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0bb9e6c690a0258fc3e3893a02776658" alt="非同期.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/3cc1ba21-5ace-a807-0baf-cada24a86b49.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F3cc1ba21-5ace-a807-0baf-cada24a86b49.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=bd492fd1561c8fb1e64c831502d8065e 1x" loading="lazy"></a><br>
やったー＼(^o^)／<br>
これで非同期的にCドラ以下のファイルが取得出来たミッションコンプリート＼(^o^)／<br>
…………<br>
……………………<br>
………………………<br>
<a href="https://camo.qiitausercontent.com/bb36d111ab0e86effff7c814e3b17219cfa8ccb1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f32363936633831652d613266322d313831382d383733642d3463666463386133396537362e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F2696c81e-a2f2-1818-873d-4cfdc8a39e76.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e8733b73cdfe9ebc6c818c11b624f7db" alt="ざわざわ.jpg" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/2696c81e-a2f2-1818-873d-4cfdc8a39e76.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F2696c81e-a2f2-1818-873d-4cfdc8a39e76.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=09f074946087bca7a1bd02a8b8678850 1x" loading="lazy"></a></p>

<p>お気付きだろうか。<br>
マウスカーソルがボタンから離れていてもマウスオーバー状態と変わらない事に……！<br>
<code>Task.Run</code>内の処理は確かにスレッドプールに処理が投げられて晴れて非ブロッキング状態となりましたが、なぜかボタンがおせねぇ。</p>

<p>ちょっと正直なところ、なんでこうなるのかは詳しくわかってないんですが非同期処理内で同期処理をしてしまっているので</p>

<ul>
<li>メインの画面(ボタン以外)は非ブロッキング状態</li>
<li>ボタン内では同期処理が走っている為ブロッキング状態</li>
</ul>

<p>になっているのだと考えています。</p>

<h2>
<span id="dispatcherpriorityを使用して非ブロッキングにできる" class="fragment"></span><a href="#dispatcherpriority%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E9%9D%9E%E3%83%96%E3%83%AD%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>Dispatcher.Priorityを使用して非ブロッキングにできる</h2>

<blockquote>
<p><code>Dispatcher.Invoke</code>のオーバーロードに<code>Dispatcher.Priority</code>を受け取るものがありまして、これ、省略した場合は<code>DispatcherPriority.Send(最高優先度)</code>で実行されるんですよ。<br>
なので、引数を明示的に指定してあげて</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">this</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
   <span class="k">this</span><span class="p">.</span><span class="n">txtFileCount</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="n">index</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span> <span class="p">+</span> <span class="n">file</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
<span class="p">},</span><span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">DispatcherPriority</span><span class="p">.</span><span class="n">Background</span><span class="p">);</span>
</code></pre></div>
</div>

<p>テキストボックスのレンダリングの優先度をBackground(4)にしてボタン入力(Input:5)よりも優先度を下げてやるとボタンが押せるようになるかも。</p>
</blockquote>

<p>というコメントを頂きました。<br>
実際にこの通りでしたので、これ以降の非同期的に<code>foreach</code>をしてやらなくても大丈夫そうですね( ˘ω˘)</p>

<h1>
<span id="ボタンを非ブロッキング状態にする" class="fragment"></span><a href="#%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E9%9D%9E%E3%83%96%E3%83%AD%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E7%8A%B6%E6%85%8B%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ボタンを非ブロッキング状態にする</h1>

<p>非同期処理内で同期処理をしてしまっていることが原因だとすれば、どうすれば非ブロッキング状態にできるのか明白ですね。<br>
非同期処理内で非同期処理をしてやればいいじゃん！！</p>

<p>ということで、ファイル取得メソッドを非同期にしてみました。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">folderPath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">directories</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">directories</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateDirectories</span><span class="p">(</span><span class="n">folderPath</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">AsParallel</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">_exceptFolder</span><span class="p">.</span><span class="nf">All</span><span class="p">(</span><span class="n">y</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">x</span><span class="p">.</span><span class="nf">StartsWith</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">)));</span>

        <span class="c1">//同階層にフォルダが存在しなければ同階層のファイルを取得するタスクを返す</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">directories</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">)).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//再帰的にフォルダを探し続ける</span>
        <span class="kt">var</span> <span class="n">filePaths</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">directories</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="k">async</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="k">await</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                                  <span class="p">.</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="n">directories</span> <span class="p">=</span> <span class="n">filePaths</span><span class="p">.</span><span class="nf">SelectMany</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">directories</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//タスクを作成する</span>
    <span class="kt">var</span> <span class="n">tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;();</span>
    <span class="n">tcs</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">).</span><span class="nf">Concat</span><span class="p">(</span><span class="n">directories</span><span class="p">));</span>

    <span class="k">return</span> <span class="k">await</span> <span class="n">tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">.</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>非同期処理内で非同期処理をさせる事でこれで思い通りの処理になるはずだぜﾋｬｯﾊｰ＼(＾o＾)／<br>
<a href="https://camo.qiitausercontent.com/945ea06a946a42dc54de809bf667a2f9681b38db/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f63633861316231322d623935332d633963632d346631362d6263306164656364353461622e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fcc8a1b12-b953-c9cc-4f16-bc0adecd54ab.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=990782d2c98aeb15f6b5b09365f6df53" alt="非同期2.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/cc8a1b12-b953-c9cc-4f16-bc0adecd54ab.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fcc8a1b12-b953-c9cc-4f16-bc0adecd54ab.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=391c7dd129da022dae59d7d3f081dfcc 1x" loading="lazy"></a><br>
なんてこったい／(^o^)＼<br>
確かにボタンは非ブロッキング状態になったけど、ボタンを押しても何もおきねぇ／(^o^)＼</p>

<p><strong>～ 2分後 ～</strong><br>
<a href="https://camo.qiitausercontent.com/fd914535bde1ba6beb8d756aa0231a7c96a56877/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f34323534656638312d643034372d383335342d323361652d3138666564393962653164612e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F4254ef81-d047-8354-23ae-18fed99be1da.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=adf08ddf724ca08f8b88fc56d16fde1e" alt="非同期3.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/4254ef81-d047-8354-23ae-18fed99be1da.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F4254ef81-d047-8354-23ae-18fed99be1da.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=83b582f76b5074594b49d34807024fb1 1x" loading="lazy"></a><br>
動き出したけどこんどは画面全体がブロッキング状態になってる／(^o^)＼<br>
これ、非同期処理内で同期処理させた時よりも状況がひどくなってる／(^o^)＼</p>

<h1>
<span id="新ステージforeachasyncで更なる高みへ" class="fragment"></span><a href="#%E6%96%B0%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8foreachasync%E3%81%A7%E6%9B%B4%E3%81%AA%E3%82%8B%E9%AB%98%E3%81%BF%E3%81%B8"><i class="fa fa-link"></i></a>新ステージ、ForeachAsyncで更なる高みへ</h1>

<p>これまでの流れを整理する。</p>

<ul>
<li>ファイル取得を同期処理で行う。ただこれだと画面が固まってしまう。</li>
<li>スレッドプールでファイル取得を同期処理で行う。ただこれだとボタンがブロッキング状態になってしまう。</li>
<li>スレッドプールでファイル取得を非同期処理で行う。ただこれだと<code>foreach</code>で展開された後に全体がブロッキング状態に。</li>
</ul>

<p>このことから考えてもうこれしかないと思った。<br>
<strong>Foreachは非同期処理を同期的にしか展開してくれねぇ説！！！！！！！</strong></p>

<p>じゃあやってやろうじゃないの、<code>ForeachAsync</code>ってやつをよ。<br>
いつもお世話になってます、neueさん、拝借させて頂きます。<br>
<a href="http://neue.cc/2014/03/14_448.html" rel="nofollow noopener" target="_blank">ForEachAsync - 非同期の列挙の方法 Part2</a></p>

<p>さて、ここで書かれてある拡張メソッドをコピっとペッで作ります。<br>
作ったうえで、この<code>ForeachAsync</code>を使えるようにファイル取得メソッドを作り変えます。それがコチラ。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ConfiguredTaskAwaitable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;&gt;</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">folderPath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">directories</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">directories</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateDirectories</span><span class="p">(</span><span class="n">folderPath</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">AsParallel</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">_exceptFolder</span><span class="p">.</span><span class="nf">All</span><span class="p">(</span><span class="n">y</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">x</span><span class="p">.</span><span class="nf">StartsWith</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">)));</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="c1">//ディレクトリにアクセスできないならファイルはない</span>
        <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//同階層にフォルダが存在しなければ同階層のファイルを取得するタスクを返す</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">directories</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">)).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="k">yield</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//再帰的にフォルダを探し続ける</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">task</span> <span class="k">in</span> <span class="n">directories</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">GetAllFilesAsync</span><span class="p">).</span><span class="nf">SelectMany</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="n">task</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//タスクを作成</span>
    <span class="kt">var</span> <span class="n">tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;();</span>
    <span class="n">tcs</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">));</span>
    <span class="k">yield</span> <span class="k">return</span> <span class="n">tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">.</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><code>ForeachAsync</code>は<code>IEnumerable&lt;T&gt;</code>の拡張メソッドなので、元々<code>Task&lt;IEnumerable&lt;string&gt;&gt;</code>だったところを<br>
更に<code>IEnumerable</code>で包んであげて <code>IEnumerable&lt;ConfiguredTaskAwaitable&lt;IEnumerable&lt;string&gt;&gt;&gt;型</code>へと進化しました！！！！</p>

<p>はい、じゃあ後は実行するだけ。<br>
ちゃんとタスクに<code>CancellationToken</code>を渡して<code>ThrowIfCancellationRequestedメソッド</code>使って例外投げるだけでおｋ。おけまる。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">Button_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ThreadPool</span><span class="p">.</span><span class="nf">SetMinThreads</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">200</span><span class="p">);</span>

    <span class="c1">//実行中にもう一度押されたらタスクをキャンセル</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_isExecute</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_isExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">btnGetFile</span><span class="p">.</span><span class="n">Content</span> <span class="p">=</span> <span class="s">"実行中"</span><span class="p">;</span>
    <span class="n">_isExecute</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="n">_cancellationTokenSource</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
    <span class="n">_cancellationToken</span> <span class="p">=</span> <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">count</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">//スレッドプールさん、処理をお願いします何でもしますから</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">enumerateFilesCollection</span> <span class="p">=</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="s">@"C:\"</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">enumerateFilesCollection</span><span class="p">.</span><span class="nf">ForEachAsync</span><span class="p">(</span><span class="k">async</span> <span class="n">enumerateFiles</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="k">await</span> <span class="n">enumerateFiles</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">//キャンセルされれば例外で止める</span>
                    <span class="n">_cancellationToken</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>

                    <span class="k">this</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(()</span> <span class="p">=&gt;</span>
                    <span class="p">{</span>
                        <span class="p">++</span><span class="n">count</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="n">txtFileCount</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">count</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span> <span class="p">+</span> <span class="n">file</span><span class="p">;</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="m">200</span><span class="p">,</span> <span class="n">_cancellationToken</span><span class="p">);</span>
        <span class="p">},</span> <span class="n">_cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="c1">//ignore</span>
    <span class="p">}</span>
    <span class="k">finally</span>
    <span class="p">{</span>
        <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="n">_isExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">btnGetFile</span><span class="p">.</span><span class="n">Content</span> <span class="p">=</span> <span class="s">"ファイル取得"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><a href="https://camo.qiitausercontent.com/4d966e1f2071a5a3d1cc3533ae04a06c7c8decfb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f66636362303865312d613765662d306333302d326136372d3532623730643532623733332e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Ffccb08e1-a7ef-0c30-2a67-52b70d52b733.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=68b3532b4acaf0d956ab9715ff12da49" alt="非同期4.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/fccb08e1-a7ef-0c30-2a67-52b70d52b733.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Ffccb08e1-a7ef-0c30-2a67-52b70d52b733.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f78abad6ba073e4731ce181da8dd6a01 1x" loading="lazy"></a></p>

<p><a href="https://camo.qiitausercontent.com/0e2d332011c0dd2e58f35fb70a70fadc93b82e6c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f63396237393062332d656132302d323239652d303639652d3564376136353630616431362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fc9b790b3-ea20-229e-069e-5d7a6560ad16.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=bfe585d2b1e349f1ba2265333fe4e267" alt="圧倒的感謝.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/c9b790b3-ea20-229e-069e-5d7a6560ad16.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fc9b790b3-ea20-229e-069e-5d7a6560ad16.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6dcd0696d4387fd8019a0ea2afad966a 1x" loading="lazy"></a><br>
これが……これが、やりたかった！！！！！<br>
ということで、予想していた<code>Foreach</code>は非同期処理を同期的にしか展開してくれねぇ説！はまあ大方合っていたのかな？<br>
多分。</p>

<h1>
<span id="パフォーマンス改善" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%94%B9%E5%96%84"><i class="fa fa-link"></i></a>パフォーマンス改善</h1>

<p>さてさてさーて、欲しいものはできた。が、実際に上記のコードを動かしてみた方は分かると思いますが、<strong>パフォーマンスが死ぬ程わるい！！！！</strong><br>
比較してみた。</p>

<h2>
<span id="パフォーマンスの比較" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>パフォーマンスの比較</h2>

<p><strong>比較条件</strong></p>

<ul>
<li>
<code>IEnumerable&lt;T&gt;</code>でファイル取得をするだけ</li>
<li>Cドライブ以下を対象とする</li>
</ul>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">//パターン1に関しては省略</span>

<span class="c1">//パターン2の計測の仕方</span>
<span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">enumerateFilesCollection</span> <span class="p">=</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="s">@"C:\"</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">enumerateFilesCollection</span><span class="p">.</span><span class="nf">ForEachAsync</span><span class="p">(</span><span class="k">async</span> <span class="n">enumerateFiles</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="k">await</span> <span class="n">enumerateFiles</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//キャンセルされれば例外で止める</span>
            <span class="n">_cancellationToken</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>

            <span class="c1">//念の為スレッドセーフにインクリメントを行う</span>
            <span class="n">Interlocked</span><span class="p">.</span><span class="nf">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">count</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&gt;=</span> <span class="m">50000</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="m">200</span><span class="p">,</span> <span class="n">_cancellationToken</span><span class="p">);</span>
<span class="p">},</span> <span class="n">_cancellationToken</span><span class="p">);</span>
</code></pre></div>
</div>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">ファイル件数</th>
<th style="text-align: left">掛かった時間</th>
<th style="text-align: left">プロセスメモリ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">パターン1<br> GetAllFilesメソッド</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">6.64秒</td>
<td style="text-align: left">57MB</td>
</tr>
<tr>
<td style="text-align: left">パターン2<br> GetAllFilesAsyncメソッド</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">1分10秒</td>
<td style="text-align: left">60MB</td>
</tr>
</tbody>
</table>

<p>ね、遅いよね。<br>
この遅くなり方は何か致命的なミスをしているはず…。</p>

<h2>
<span id="並列クエリを付けたりなくしたりしてみる" class="fragment"></span><a href="#%E4%B8%A6%E5%88%97%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E4%BB%98%E3%81%91%E3%81%9F%E3%82%8A%E3%81%AA%E3%81%8F%E3%81%97%E3%81%9F%E3%82%8A%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>並列クエリを付けたりなくしたりしてみる</h2>

<p>色々試していたら一個気付いた。<br>
<code>AsParallel</code>邪魔なんじゃね！！！！！？？？？？</p>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">ファイル件数</th>
<th style="text-align: left">掛かった時間</th>
<th style="text-align: left">プロセスメモリ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">パターン1<br> GetAllFilesメソッド</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">6.64秒</td>
<td style="text-align: left">57MB</td>
</tr>
<tr>
<td style="text-align: left">パターン2<br> GetAllFilesAsyncメソッド</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">1分10秒</td>
<td style="text-align: left">60MB</td>
</tr>
<tr>
<td style="text-align: left">パターン3<br> GetAllFilesメソッドにAsParallelを追加して並列処理</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">終わらない…</td>
<td style="text-align: left">-</td>
</tr>
<tr>
<td style="text-align: left">パターン4<br> GetAllFilesAsyncメソッドからAsParallelを削除</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">7.06秒</td>
<td style="text-align: left">60MB</td>
</tr>
</tbody>
</table>

<p><code>AsParallelメソッド</code>を使用した場合がどちらも遅い。というか絶望的に遅い。<br>
もしかして、並列処理実行時に例外が発生した場合ってかなりコストがかかってる感じですか…？<br>
とりあえず一つは<code>AsParallelメソッドを使用しない</code>事で大幅に上がりそう。（前に計測した時は倍速だった気が…。）</p>

<h2>
<span id="taskcreationoptionslongrunning-を設定してみる" class="fragment"></span><a href="#taskcreationoptionslongrunning-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>TaskCreationOptions.LongRunning を設定してみる</h2>

<p>幾つかのサイトを流し見していると何回かチラ見するこの<code>TaskCreationOptions.LongRunning</code>というやつ。<br>
なんか明らかに長い時間タスクを実行するときに付けたほうがよさそうな名前。</p>

<blockquote>
<p>TaskCreationOptions<br>
タスクの作成および実行に関するオプションの動作を制御するフラグ</p>
</blockquote>

<p>ふむ。</p>

<table>
<thead>
<tr>
<th style="text-align: left">フラグ</th>
<th style="text-align: left">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">None</td>
<td style="text-align: left">既定の動作を適用します</td>
</tr>
<tr>
<td style="text-align: left">PreferFairness</td>
<td style="text-align: left">TaskScheduler に対し、できる限り公平にタスクをスケジュールするように指示します</td>
</tr>
<tr>
<td style="text-align: left"><strong>LongRunning</strong></td>
<td style="text-align: left"><strong>粒度の細かいシステムではなく、タスクが長時間実行され、少量の大きなコンポーネントを含む粒度の粗い操作とすることを指定します</strong></td>
</tr>
<tr>
<td style="text-align: left">AttachedToParent</td>
<td style="text-align: left">タスクがタスク階層の親にアタッチされることを指定します</td>
</tr>
<tr>
<td style="text-align: left">DenyChildAttach</td>
<td style="text-align: left">アタッチされた子タスクとして実行を試みるすべての子タスクが、親タスクにアタッチされるのではなく、デタッチされた子タスクとして実行されるように指定します</td>
</tr>
<tr>
<td style="text-align: left">HideScheduler</td>
<td style="text-align: left">アンビエント スケジューラが作成されたタスクの現在のスケジューラと見なされることを防止します</td>
</tr>
<tr>
<td style="text-align: left">RunContinuationsAsynchronously</td>
<td style="text-align: left">現在のタスクに追加される継続処理を強制的に非同期実行します</td>
</tr>
</tbody>
</table>

<p>詳しくは<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.threading.tasks.taskcreationoptions?redirectedfrom=MSDN&amp;view=netframework-4.7.2" rel="nofollow noopener" target="_blank">TaskCreationOptions Enum </a>を参照してください。</p>

<p>とりあえずやってみた。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">//Task.RunではTaskCreationOptionsを設定できないのでTask.Factoryを使用する</span>
<span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">enumerateFilesCollection</span> <span class="p">=</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="s">@"C:\"</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">enumerateFilesCollection</span><span class="p">.</span><span class="nf">ForEachAsync</span><span class="p">(</span><span class="k">async</span> <span class="n">enumerateFiles</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="k">await</span> <span class="n">enumerateFiles</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//キャンセルされれば例外で止める</span>
            <span class="n">_cancellationToken</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>

            <span class="c1">//念の為スレッドセーフにインクリメントを行う</span>
            <span class="n">Interlocked</span><span class="p">.</span><span class="nf">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">count</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&gt;=</span> <span class="m">50000</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="m">200</span><span class="p">,</span> <span class="n">_cancellationToken</span><span class="p">);</span>
<span class="p">},</span> <span class="n">_cancellationToken</span><span class="p">,</span> <span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">LongRunning</span><span class="p">,</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">Default</span><span class="p">);</span>

</code></pre></div>
</div>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">ファイル件数</th>
<th style="text-align: left">掛かった時間</th>
<th style="text-align: left">プロセスメモリ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">GetAllFilesメソッド</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">6.64秒</td>
<td style="text-align: left">57MB</td>
</tr>
<tr>
<td style="text-align: left">GetAllFilesAsyncメソッドからAsParallelを削除</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">7.06秒</td>
<td style="text-align: left">60MB</td>
</tr>
<tr>
<td style="text-align: left">GetAllFilesAsyncメソッドからAsParallelを削除 +<br>TaskCreationOptions.LongRunning を設定</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">5.97秒</td>
<td style="text-align: left">59MB</td>
</tr>
</tbody>
</table>

<p>ほぼ誤差の範囲っぽい。このサイトに少し詳しく書いてあります。<br>
<a href="https://devlights.hatenablog.com/entry/2014/01/15/010832" rel="nofollow noopener" target="_blank">タスク並列ライブラリ入門記-006 (TaskCreationOptions.LongRunning, 長時間実行されるタスクであることを示すオプション, オーバーサブスクリプション) </a><br>
スレッドの切り替えにかかる時間が若干軽減する、かも！？ぐらいな感じでしょうか。</p>

<h2>
<span id="foreachasync-の排他制御を外す" class="fragment"></span><a href="#foreachasync-%E3%81%AE%E6%8E%92%E4%BB%96%E5%88%B6%E5%BE%A1%E3%82%92%E5%A4%96%E3%81%99"><i class="fa fa-link"></i></a>ForeachAsync の排他制御を外す</h2>

<p><a href="https://qiita.com/OXamarin/items/51c0d713910895a9ccba#%E6%96%B0%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8foreachasync%E3%81%A7%E6%9B%B4%E3%81%AA%E3%82%8B%E9%AB%98%E3%81%BF%E3%81%B8">新ステージ、ForeachAsyncで更なる高みへ</a>で<code>非同期なforeach</code>を作った訳ですが、中身をちゃんと見ると<code>SemaphoreSlim</code>が使用されています。<code>SemaphoreSlim</code>については以下の記事がとてもわかりやすいです。<br>
<a href="http://blog.awagat.com/?p=701" rel="nofollow noopener" target="_blank">たがわ製作所ブログ - 非同期処理におけるセマフォを用いた排他制御</a></p>

<p>まあ要は、<code>Task</code>の最大同時実行数に制限を掛けているわけなんですが、今回はCドライブ以下のファイルパスを根こそぎ持ってくるだけなので特に処理順序なんて必要ないですし求められているのはメモリをぶん殴ってでも速度が欲しい訳です。じゃあどうするか？</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">ForEachAsyncNoLock</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Task</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">CancellationToken</span><span class="p">),</span> <span class="kt">bool</span> <span class="n">configureAwait</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">"source"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">"action"</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">tasks</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">source</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cancellationToken</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="nf">action</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
        <span class="n">tasks</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="n">configureAwait</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><code>SemaphoreSlim</code>を消し去ってやればいいじゃない。</p>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">ファイル件数</th>
<th style="text-align: left">掛かった時間</th>
<th style="text-align: left">プロセスメモリ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">GetAllFilesメソッド</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">6.64秒</td>
<td style="text-align: left">57MB</td>
</tr>
<tr>
<td style="text-align: left">GetAllFilesAsyncメソッドからAsParallelを削除</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">7.06秒</td>
<td style="text-align: left">60MB</td>
</tr>
<tr>
<td style="text-align: left">GetAllFilesAsyncメソッドからAsParallelを削除 +<br>ForEachAsyncNoLock</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">5.97秒</td>
<td style="text-align: left">59MB</td>
</tr>
</tbody>
</table>

<p>1割程度は改善した感じ？<br>
ちな、<code>ForEachAsyncNoLock</code>は後述するUI描画時のパフォーマンスにめちゃ役に立ちます。</p>

<h2>
<span id="ファイルパス取得--ui描画のパフォーマンス比較" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%91%E3%82%B9%E5%8F%96%E5%BE%97--ui%E6%8F%8F%E7%94%BB%E3%81%AE%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>ファイルパス取得 + UI描画のパフォーマンス比較</h2>

<p>ロジック面で思いつくことは粗方やれたかな、と思います。<br>
なので次は<code>ファイルパス取得 + UIへの描画</code>に掛かる時間を図ります。<br>
んで今更なんですが、非同期処理実行時には<code>DispatcherPriority.Background</code>を指定してあげないとフォームの移動とかさせられないですね。。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">this</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">txtFileCount</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">count</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span> <span class="p">+</span> <span class="n">file</span><span class="p">;</span>
<span class="c1">//}, _cancellationToken); こうじゃない</span>
<span class="p">},</span> <span class="n">DispatcherPriority</span><span class="p">.</span><span class="n">Background</span><span class="p">,</span> <span class="n">_cancellationToken</span><span class="p">);</span> <span class="c1">//こっち</span>
</code></pre></div>
</div>

<p>さっそく計測してみる。</p>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">ファイル件数</th>
<th style="text-align: left">掛かった時間</th>
<th style="text-align: left">プロセスメモリ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">ForEachAsync</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">1分58秒</td>
<td style="text-align: left">57MB</td>
</tr>
<tr>
<td style="text-align: left">ForEachAsyncNoLock</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">2分02秒</td>
<td style="text-align: left">60MB</td>
</tr>
</tbody>
</table>

<p>えっ<br>
実行上限数が設定されてない<code>ForEachAsyncNoLock</code>の方が遅い。</p>

<h2>
<span id="非同期的にuiを更新する" class="fragment"></span><a href="#%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%ABui%E3%82%92%E6%9B%B4%E6%96%B0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>非同期的にUIを更新する</h2>

<p>この結果を受けて考えました。なぜ、<code>ForEachAsyncNoLock</code>の方が遅いのか、と。<br>
そこで一つの可能性として、<code>UIスレッド</code>の実行権限取得時に競合的な何かが起きているのでは？と考えました。</p>

<p>どういうことかというと<code>ForEachAsync</code>に対して<code>ForEachAsyncNoLock</code>の方が同時実行タスク数が多くなる可能性があり、<code>UI</code>を更新できるのは<code>UIスレッド</code>からのみ、という前提から考えれば<code>UIスレッド</code>を奪い合う頻度の高い<code>ForEachAsyncNoLock</code>の方が遅くなって当然なのかなと一旦理解しました。</p>

<p>そこでふと、<code>InvokeAsyncメソッド</code>があることを思い出し、これを使えば競合なくきちんと待ってから<code>UIスレッド</code>を効率的にタスクスケジュールしてくれるのでは？と考えて計測してみました。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">enumerateFilesCollection</span> <span class="p">=</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="s">@"C:\"</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">enumerateFilesCollection</span><span class="p">.</span><span class="nf">ForEachAsyncNoLock</span><span class="p">(</span><span class="k">async</span> <span class="n">enumerateFiles</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="k">await</span> <span class="n">enumerateFiles</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//キャンセルされれば例外で止める</span>
            <span class="n">_cancellationToken</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>

            <span class="c1">//念の為スレッドセーフにインクリメントを行う</span>
            <span class="n">Interlocked</span><span class="p">.</span><span class="nf">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">count</span><span class="p">);</span>

            <span class="c1">//意図的にawaitを付けない</span>
            <span class="k">this</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">InvokeAsync</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">txtFileCount</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">count</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span> <span class="p">+</span> <span class="n">file</span><span class="p">;</span>
            <span class="p">},</span> <span class="n">DispatcherPriority</span><span class="p">.</span><span class="n">Background</span><span class="p">,</span> <span class="n">_cancellationToken</span><span class="p">);</span>

            <span class="c1">//50000件の計測用</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&gt;=</span> <span class="m">50000</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="n">_cancellationToken</span><span class="p">);</span>
<span class="p">},</span> <span class="n">_cancellationToken</span><span class="p">);</span>
</code></pre></div>
</div>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">ファイル件数</th>
<th style="text-align: left">掛かった時間</th>
<th style="text-align: left">プロセスメモリ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">ForEachAsync</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">1分58秒</td>
<td style="text-align: left">83MB</td>
</tr>
<tr>
<td style="text-align: left">ForEachAsyncNoLock</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">2分02秒</td>
<td style="text-align: left">83MB</td>
</tr>
<tr>
<td style="text-align: left">ForEachAsync +<br> InvokeAsync</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">8.42秒</td>
<td style="text-align: left">123MB</td>
</tr>
<tr>
<td style="text-align: left">ForEachAsyncNoLock +<br> InvokeAsync</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">7.07秒</td>
<td style="text-align: left">121MB</td>
</tr>
</tbody>
</table>

<p>正直、草生えました。<br>
<a href="https://camo.qiitausercontent.com/0af98d7b7a3fc704c8932418ecd4020cf708ced2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f39376534356437392d623764332d356261612d383662382d3939623130313535313534382e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F97e45d79-b7d3-5baa-86b8-99b101551548.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2cae5cc79cf5f8b7d6414eccbc68089b" alt="非同期6.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/97e45d79-b7d3-5baa-86b8-99b101551548.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F97e45d79-b7d3-5baa-86b8-99b101551548.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=c9dc4f185cab01a4784523d5135dc921 1x" loading="lazy"></a><br>
結局、非同期処理をやりたいのって「ちゃんと処理してるんだぜなう」みたいなアピールが出来てればよくて、進捗状況まで律義に待ってやる必要なんてないですね。そういう理由で<code>InvokeAsync</code>を意図的に同期処理させています。</p>

<h2>
<span id="パフォーマンス改善後" class="fragment"></span><a href="#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%94%B9%E5%96%84%E5%BE%8C"><i class="fa fa-link"></i></a>パフォーマンス改善後</h2>

<p>実行時間に若干のムラはありますが、思ったより納得いく所までパフォーマンスを上げられました。</p>

<table>
<thead>
<tr>
<th style="text-align: left">ファイル取得 + UIの更新までの時間</th>
<th style="text-align: left">ファイル件数</th>
<th style="text-align: left">掛かった時間</th>
<th style="text-align: left">プロセスメモリ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">パフォーマンス改善前</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">2分29秒</td>
<td style="text-align: left">83MB</td>
</tr>
<tr>
<td style="text-align: left">パフォーマンス改善後</td>
<td style="text-align: left">50,000件</td>
<td style="text-align: left">7秒</td>
<td style="text-align: left">121MB</td>
</tr>
</tbody>
</table>

<p>暫定版。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">folderPath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">directories</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">directories</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateDirectories</span><span class="p">(</span><span class="n">folderPath</span><span class="p">)</span>
            <span class="c1">//.AsParallel() 悪夢の元凶</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">_exceptFolder</span><span class="p">.</span><span class="nf">All</span><span class="p">(</span><span class="n">y</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">x</span><span class="p">.</span><span class="nf">StartsWith</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">)));</span>

        <span class="c1">//同階層にフォルダが存在しなければ同階層のファイルを取得するタスクを返す</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">directories</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">)).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//再帰的にフォルダを探し続ける</span>
        <span class="kt">var</span> <span class="n">filePaths</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">directories</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="k">async</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="k">await</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                                  <span class="p">.</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="n">directories</span> <span class="p">=</span> <span class="n">filePaths</span><span class="p">.</span><span class="nf">SelectMany</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">directories</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//タスクを作成する</span>
    <span class="kt">var</span> <span class="n">tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;();</span>
    <span class="n">tcs</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateFiles</span><span class="p">(</span><span class="n">folderPath</span><span class="p">).</span><span class="nf">Concat</span><span class="p">(</span><span class="n">directories</span><span class="p">));</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">.</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">BtnGetFile_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//省略</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">enumerateFilesCollection</span> <span class="p">=</span> <span class="nf">GetAllFilesAsync</span><span class="p">(</span><span class="s">@"C:\"</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">enumerateFilesCollection</span><span class="p">.</span><span class="nf">ForEachAsyncNoLock</span><span class="p">(</span><span class="k">async</span> <span class="n">enumerateFiles</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="k">await</span> <span class="n">enumerateFiles</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">//キャンセルされれば例外で止める</span>
                    <span class="n">_cancellationToken</span><span class="p">.</span><span class="nf">ThrowIfCancellationRequested</span><span class="p">();</span>

                    <span class="c1">//念の為スレッドセーフにインクリメントを行う</span>
                    <span class="n">Interlocked</span><span class="p">.</span><span class="nf">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">count</span><span class="p">);</span>

                    <span class="c1">//意図的にawaitを付けない</span>
                    <span class="k">this</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">InvokeAsync</span><span class="p">(()</span> <span class="p">=&gt;</span>
                    <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="n">txtFileCount</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">count</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span> <span class="p">+</span> <span class="n">file</span><span class="p">;</span>
                    <span class="p">},</span> <span class="n">DispatcherPriority</span><span class="p">.</span><span class="n">Background</span><span class="p">,</span> <span class="n">_cancellationToken</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="n">_cancellationToken</span><span class="p">);</span>
        <span class="p">},</span> <span class="n">_cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//省略</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h1>
<span id="c-80で実装予定の非同期-foreach" class="fragment"></span><a href="#c-80%E3%81%A7%E5%AE%9F%E8%A3%85%E4%BA%88%E5%AE%9A%E3%81%AE%E9%9D%9E%E5%90%8C%E6%9C%9F-foreach"><i class="fa fa-link"></i></a>C# 8.0で実装予定の非同期 foreach</h1>

<p><a href="https://ufcpp.net/blog/2018/12/cs8asyncstreams/" rel="nofollow noopener" target="_blank">C# 8.0 Async streams</a><br>
実装されるみたいです！！</p>

<p>気が向けば、VS2019をインストールして、追記しますね( ˘ω˘)</p>

<p><strong>追記 (2019/02/09)</strong><br>
非同期foreachを試してみましたが…。<br>
<a href="https://camo.qiitausercontent.com/82694a80caa3a2d40f88ecf4ee274bc56066367c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f39336235393636382d303433392d313564362d353836612d3731383938653763393835312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F93b59668-0439-15d6-586a-71898e7c9851.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=940bda4f4dd65f2b9644ff1fe84dec4e" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/172223/93b59668-0439-15d6-586a-71898e7c9851.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F93b59668-0439-15d6-586a-71898e7c9851.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=9e2920a603d8128160350689429b7e16 1x" loading="lazy"></a></p>

<ul>
<li>VS2019で実行</li>
<li>プロジェクトの詳細設定から<code>C# 8.0</code>を選択</li>
<li>
<a href="https://ufcpp.net/blog/2018/12/cs8asyncstreams/" rel="nofollow noopener" target="_blank">C# 8.0 Async streams</a>からコピペ</li>
</ul>

<p>うん、動かん。( ˘ω˘)<br>
正式リリースを待つとします…。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>Cドラ以下のファイルパスを取得したかったというよりも、その過程での非同期処理の勉強の為にこういうことをやっていました。<br>
なんとなくで非同期処理を書けてしまう、、それはそれでよい事ですがちゃんと理解してコーディングしたいですよね。<br>
今回の記事を書くにあたって、非常に参考にさせて頂いたサイトを紹介して〆たいと思います。</p>

<ul>
<li><a href="https://ufcpp.net/study/csharp/sp5_async.html" rel="nofollow noopener" target="_blank">未確認飛行 - 非同期メソッド</a></li>
<li><a href="https://ufcpp.wordpress.com/2012/11/12/asyncawait%E3%81%A8%E5%90%8C%E6%99%82%E5%AE%9F%E8%A1%8C%E5%88%B6%E5%BE%A1/" rel="nofollow noopener" target="_blank">未確認飛行 - async/awaitと同時実行制御</a></li>
<li><a href="https://qiita.com/acple@github/items/8f63aacb13de9954c5da" id="reference-b08ea53b997d3996bb99">Qiita - Taskを極めろ！async/await完全攻略</a></li>
<li><a href="https://qiita.com/chocolamint/items/ed4999cccf011653cb78" id="reference-2bc7f6d34b09f71fd8af">Qiita - TAP (Task-based Asynchronous Pattern) 非同期メソッドのガイドライン</a></li>
<li><a href="http://qwerty2501.hatenablog.com/entry/2014/04/24/235849" rel="nofollow noopener" target="_blank">飽きっぽい人のブログ - async/await ～非同期なライブラリは楽じゃない～</a></li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FOXamarin%2Fitems%2F51c0d713910895a9ccba&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FOXamarin%2Fitems%2F51c0d713910895a9ccba&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/OXamarin/items/51c0d713910895a9ccba/likers" class="css-1iupg5d">47</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">45</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/51c0d713910895a9ccba/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/OXamarin/items/51c0d713910895a9ccba/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/OXamarin/items/51c0d713910895a9ccba/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/OXamarin/items/51c0d713910895a9ccba/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/OXamarin/items/51c0d713910895a9ccba.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-b0580e84-c547-4038-ada1-e88ee1e2e7c1">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-851a88a7-42b7-4594-b89e-43f35299ef16"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-851a88a7-42b7-4594-b89e-43f35299ef16">{}</script>
      
<div id="LoginModal-react-component-3b27afd0-af01-4d6a-a939-14fba7b2b7b9"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-3b27afd0-af01-4d6a-a939-14fba7b2b7b9">{}</script>
      
<div id="StockModal-react-component-15597a18-32fc-4cc8-96fa-f7c7542d8bd8"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-15597a18-32fc-4cc8-96fa-f7c7542d8bd8">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;u9W2U24c1AkLLfKJTNGFp3ainiaSm4boTH21bVBV4/NpiT0xMFgALYVv0DM7/3wjCl3tyWpXtsq4PFSi7i426g==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e\u003cstrong\u003e(2019/02/09 更新)\u003c/strong\u003e\u003cbr\u003e\n\u003ccode\u003eC# 8.0\u003c/code\u003eを試してみましたが上手くいきませんでした(´･ω･｀)\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e(2019/02/10 更新)\u003c/strong\u003e\u003cbr\u003e\ntangoさんよりアドバイス頂き、\u003ca href=\"https://qiita.com/OXamarin/items/51c0d713910895a9ccba#asyncawait-%E3%81%A7%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%ABc%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97\"\u003easync/await で非同期的にCドラ以下のファイルを取得\u003c/a\u003eにボタンがマウスホバーでない場合にボタンが非ブロッキング状態になるように教えて頂きましたので追記しました。ありがとうございます！\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e(2019/02/14 更新)\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/OXamarin/items/51c0d713910895a9ccba#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%94%B9%E5%96%84\"\u003eパフォーマンス改善\u003c/a\u003eを追記しました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"背景\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%83%8C%E6%99%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e背景\u003c/h1\u003e\n\n\u003cp\u003e(自称)最強のファイル検索ソフトである\u003ccode\u003eEveryThing\u003c/code\u003eを愛用しているわけですが、このソフトだとネットワークドライブのファイルまで見に行きたいいけない！！\u003c/p\u003e\n\n\u003cp\u003eそうだ！ネットワークドライブまで見に行けるファイル検索をつくろう！！！\u003cbr\u003e\nんでもって、\u003cstrong\u003e画面が固まらないように！！そして途中キャンセルできるようにしよう！！！！\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eそう考えて作ってみると思ったよりも格段に難しかったのでメモとして残しておきます。マサカリ大歓迎！\u003c/p\u003e\n\n\u003cp\u003eそしてツール完成間近、EveryThing がネットワークドライブのファイルまで見に行けることを知る事となるとはこの時、知る由もなかった。。。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"こういうことがやりたい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%81%86%E3%81%84%E3%81%86%E3%81%93%E3%81%A8%E3%81%8C%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこういうことがやりたい\u003c/h1\u003e\n\n\u003cp\u003e書いてみたら意外と長くなってしまったので、最初に結論というか最終成果物。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/4e962a468358debca5331ba60f06b4a28e740c2e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f63666364636362302d333332332d303865362d383034352d6637386530643633663331652e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fcfcdccb0-3323-08e6-8045-f78e0d63f31e.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=15030ef6145b1b70e7f0b422f041ede2\" alt=\"非同期7.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/cfcdccb0-3323-08e6-8045-f78e0d63f31e.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fcfcdccb0-3323-08e6-8045-f78e0d63f31e.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b6ef1536d66def6c2039fbe8da037d09 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eCドライブ以下にあるファイルを全取得出来るようにする\u003c/li\u003e\n\u003cli\u003e画面が固まらないように非同期で処理する\u003c/li\u003e\n\u003cli\u003eファイル数が膨大なのでキャンセル可能にする\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e同期処理での記述から始めて、最終的にこれらの条件を満たしていくようにしていきます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"directoryenumeratefiles-がcドラ直下だと役に立たない件\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#directoryenumeratefiles-%E3%81%8Cc%E3%83%89%E3%83%A9%E7%9B%B4%E4%B8%8B%E3%81%A0%E3%81%A8%E5%BD%B9%E3%81%AB%E7%AB%8B%E3%81%9F%E3%81%AA%E3%81%84%E4%BB%B6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDirectory.EnumerateFiles がCドラ直下だと役に立たない件\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode\u003eC#\u003c/code\u003eでは\u003ccode\u003eDirectoryクラス\u003c/code\u003eにファイル列挙メソッドが用意されています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"C:\\\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efiles\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"*\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSearchOption\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAllDirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eえ、これだけでネットワークパスまでファイル取りに行ける！楽勝じゃん！\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/84fd75d2c7133895b36056c06f5f757f5d80950d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f37396665326666392d633930322d626639392d626438322d3531313431366463386363302e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F79fe2ff9-c902-bf99-bd82-511416dc8cc0.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c49ea782a693d016184847e0f9788468\" alt=\"maxresdefault.jpg\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/79fe2ff9-c902-bf99-bd82-511416dc8cc0.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F79fe2ff9-c902-bf99-bd82-511416dc8cc0.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a4e1b6d56312ae3f2c938b24f37f35e5 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e実際に上記を実行してみると\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/3fc5275b6b84e765383898f09207b514741d2660/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f35346239663732382d613231312d306564322d626162392d6163306263386336623035372e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F54b9f728-a211-0ed2-bab9-ac0bc8c6b057.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b4056f006de41a899b32ad6ff54871a5\" alt=\"キャプチャ.JPG\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/54b9f728-a211-0ed2-bab9-ac0bc8c6b057.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F54b9f728-a211-0ed2-bab9-ac0bc8c6b057.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=13082fee9129ba463e8a5832de0a79a5 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e「C:\\$Recycle.Bin\\S-1-5-18」\u003c/strong\u003eてなんぞ。\u003cbr\u003e\nなんか知らんけど、存在しないフォルダにアクセスしようとしてみただけなのか？\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/38f011ebb5d1de9be2aceb8db1eb77bb305049c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f34356566393561642d346431612d303562362d386535332d6434636665306362336135312e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F45ef95ad-4d1a-05b6-8e53-d4cfe0cb3a51.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7133854dcc428e5dac634335fae93af2\" alt=\"キャプチャ.JPG\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/45ef95ad-4d1a-05b6-8e53-d4cfe0cb3a51.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F45ef95ad-4d1a-05b6-8e53-d4cfe0cb3a51.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f85f32311f325f251145ab5c6ebd28f2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nほう？\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/da6431b1efe348848d675283708f8a4751ca3726/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f61353835633364302d653365632d396537302d356233622d3831333163356532353461662e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fa585c3d0-e3ec-9e70-5b3b-8131c5e254af.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2dfd693cf2dd761acee7ce3e26b8eed1\" alt=\"キャプチャ.JPG\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/a585c3d0-e3ec-9e70-5b3b-8131c5e254af.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fa585c3d0-e3ec-9e70-5b3b-8131c5e254af.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=fe5ac11723df6dc036894aac414d1003 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nほうほう…。\u003cbr\u003e\nなにやら、\u003ccode\u003eDirectory.EnumerateFilesメソッド\u003c/code\u003eでアクセス権限のないシステムフォルダなどを覗き見ようとした際にこのようになってしまうようだ。どうしたものか。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"try-catch-で全てを握りつぶしてcドラ以下のファイルを取得する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#try-catch-%E3%81%A7%E5%85%A8%E3%81%A6%E3%82%92%E6%8F%A1%E3%82%8A%E3%81%A4%E3%81%B6%E3%81%97%E3%81%A6c%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003etry catch で全てを握りつぶしてCドラ以下のファイルを取得する\u003c/h1\u003e\n\n\u003cp\u003eキータ内でそれっぽい記事があったので拝借します。\u003cbr\u003e\n\u003ca href=\"https://qiita.com/OneK/items/8b0d02817a9f2a2fbeb0\" id=\"reference-6aa3c6508ae5143e251e\"\u003e【C#】ドライブ直下からのファイルリスト取得について\u003c/a\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003e検索元のディレクトリの指定「C:\\」や「D:\\」といったドライブ直下にした時、プログラムがコケるケースがあった。\u003cbr\u003e\n原因は隠しフォルダの「RECYCLE.BIN」で、要は操作しているユーザのアクセス権が無いゴミ箱（他のユーザのゴミ箱だったりとか）を読み取ることができずに例外を吐いて死んでしまうことに気がついた。\u003cbr\u003e\nこれを回避するためには、再帰処理に読み取れなかった場合を考慮してちゃんとtry~catchしてあげればいいという単純なもの。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eふむふむ、なるほどなるほど。\u003cbr\u003e\n確かに再帰的にアクセスして例外が発生したものだけを無視すればよさそう。実際に測ってみた。\u003c/p\u003e\n\n\u003cp\u003eまた、計測にあたって明らかに不要かつどのPCにもありそうなフォルダに関しては検索段階で弾くようにする。\u003cbr\u003e\n具体的には、以下のフィールド内のどれかにフォルダパスの接頭辞が該当した場合には検索対象外とした。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// 検索フォルダから除外する\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_exceptFolder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eHashSet\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"s\"\u003e@\"C:\\Windows\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e//システムファイルが多すぎる\u003c/span\u003e\n    \u003cspan class=\"s\"\u003e@\"C:\\Users\\All Users\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"s\"\u003e@\"C:\\$Recycle.Bin\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e//ゴミ箱\u003c/span\u003e\n    \u003cspan class=\"s\"\u003e@\"C:\\Recovery\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"s\"\u003e@\"C:\\Config.Msi\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e//起動して最初に実行されるらしい\u003c/span\u003e\n    \u003cspan class=\"s\"\u003e@\"C:\\Documents and Settings\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e//デスクトップとかマイドキュメントなど\u003c/span\u003e\n    \u003cspan class=\"s\"\u003e@\"C:\\System Volume Information\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"s\"\u003e@\"C:\\Program Files\\windows nt\\アクセサリ\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"s\"\u003e@\"C:\\ProgramData\\Application Data\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e//よくある隠しフォルダ\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003eファイル件数\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e掛かった時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eプロセスメモリ\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e648,721件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e46秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e214MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ienumerable型でcドラ以下のファイルを取得する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ienumerable%E5%9E%8B%E3%81%A7c%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eIEnumerable型でCドラ以下のファイルを取得する\u003c/h1\u003e\n\n\u003cp\u003eCドラ以下のファイルが無事に取得できる事は確認できました。\u003cbr\u003e\nただ私が作りたいのは、\u003cstrong\u003e画面が固まらず、キャンセル可能\u003c/strong\u003eなファイル取得です。\u003cbr\u003e\nつまりこういういめーじ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eCancellationTokenSource\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003e_isExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eButton_Click\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRoutedEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//実行中にもう一度押されたらタスクのキャンセルを行う\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_isExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_isExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCancel\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003e_isExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToken\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//スレッドプールさん、処理をお願いします何でもしますから\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//ファイル取得\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efilePaths\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e@\"C:\\\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//一回でList型で取得するのではなく\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//1ファイル読み込み毎に何らかの処理をしたいからIEnumerable型で取得したい\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efilePath\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003efilePaths\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//タスクのキャンセルがされていたら例外を投げる\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eThrowIfCancellationRequested\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//1ファイル読み込み毎に何らかの処理\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//ignore\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efinally\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_isExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e上記のソースコードでいう、「1ファイル毎の～～」の部分を実現する為に\u003ccode\u003eIEnumerable型\u003c/code\u003eで取得してみました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// ファイルパスの全取得(同期処理でならこれでよい)\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"folderPath\"\u0026gt;\u0026lt;/param\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;\u0026lt;/returns\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateDirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_exceptFolder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartsWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStringComparison\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentCultureIgnoreCase\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelectMany\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eGetAllFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//同階層のファイル取得をして再帰的に同階層のフォルダを検索しに行く\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eまた、計測するにあたって、以下の2パターンで計測してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e//パターン1\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//IEnumerable型で取得した後にList化して初めからListで返すパターンとの比較を行う\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efiles\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//パターン2\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//IEnumerableで取得したものをforeachで展開させる\u003c/span\u003e\n\u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//ignore\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eファイル件数\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e掛かった時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eプロセスメモリ\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパターン1\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e648,772件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e46秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e208MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパターン2\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e648,772件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e52秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e38MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eまぁこんなもんだよね。\u003cbr\u003e\n完全に蛇足だとは思いますが、念の為このメソッドを使ってUIを更新してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eButton_Click\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRoutedEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"C:\\\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e}))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//Dispatcher.InvokeでUIスレッドに処理をさせる\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etxtFileCount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/85640cdbc66f787345997097febec5f660180ac4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f33356438656130612d663235352d306433392d346362652d3234653039383765656230622e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F35d8ea0a-f255-0d39-4cbe-24e0987eeb0b.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e804531ea2cf2a92846cd8bbea4ec395\" alt=\"同期処理.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/35d8ea0a-f255-0d39-4cbe-24e0987eeb0b.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F35d8ea0a-f255-0d39-4cbe-24e0987eeb0b.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=bd3a04a70e8fa7dbeff930e8d56fe38e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nはい、まあそらそうですね、、って感じの結果です。\u003cbr\u003e\n全ての処理をシングルスレッドで行っているので画面は固まったまんまです。\u003cbr\u003e\nCドラ以下のファイルを全取得し終わるまでボタンも押せない。\u003cbr\u003e\nふつーに書いてたらまあこうなるよね。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"asyncawait-で非同期的にcドラ以下のファイルを取得\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#asyncawait-%E3%81%A7%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%ABc%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003easync/await で非同期的にCドラ以下のファイルを取得\u003c/h1\u003e\n\n\u003cp\u003eここからようやく本題、非同期処理で画面を更新させていきます。\u003cbr\u003e\nサクッと非同期にする。\u003ccode\u003easync void\u003c/code\u003eはイベントハンドラにだけ許された特権( ˘ω˘)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eButton_Click\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRoutedEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"C:\\\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//スレッドプールに処理を任せといた\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e}))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//UIスレッドに戻ってきてUIを更新させる\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etxtFileCount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/5f699be3e65fbffa6519d7ab4ff16e9968390f94/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f33636331626132312d356163652d613830372d306261662d6361646132346138366234392e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F3cc1ba21-5ace-a807-0baf-cada24a86b49.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=0bb9e6c690a0258fc3e3893a02776658\" alt=\"非同期.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/3cc1ba21-5ace-a807-0baf-cada24a86b49.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F3cc1ba21-5ace-a807-0baf-cada24a86b49.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=bd492fd1561c8fb1e64c831502d8065e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nやったー＼(^o^)／\u003cbr\u003e\nこれで非同期的にCドラ以下のファイルが取得出来たミッションコンプリート＼(^o^)／\u003cbr\u003e\n…………\u003cbr\u003e\n……………………\u003cbr\u003e\n………………………\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/bb36d111ab0e86effff7c814e3b17219cfa8ccb1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f32363936633831652d613266322d313831382d383733642d3463666463386133396537362e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F2696c81e-a2f2-1818-873d-4cfdc8a39e76.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e8733b73cdfe9ebc6c818c11b624f7db\" alt=\"ざわざわ.jpg\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/2696c81e-a2f2-1818-873d-4cfdc8a39e76.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F2696c81e-a2f2-1818-873d-4cfdc8a39e76.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=09f074946087bca7a1bd02a8b8678850 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eお気付きだろうか。\u003cbr\u003e\nマウスカーソルがボタンから離れていてもマウスオーバー状態と変わらない事に……！\u003cbr\u003e\n\u003ccode\u003eTask.Run\u003c/code\u003e内の処理は確かにスレッドプールに処理が投げられて晴れて非ブロッキング状態となりましたが、なぜかボタンがおせねぇ。\u003c/p\u003e\n\n\u003cp\u003eちょっと正直なところ、なんでこうなるのかは詳しくわかってないんですが非同期処理内で同期処理をしてしまっているので\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eメインの画面(ボタン以外)は非ブロッキング状態\u003c/li\u003e\n\u003cli\u003eボタン内では同期処理が走っている為ブロッキング状態\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eになっているのだと考えています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"dispatcherpriorityを使用して非ブロッキングにできる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dispatcherpriority%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E9%9D%9E%E3%83%96%E3%83%AD%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A7%E3%81%8D%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDispatcher.Priorityを使用して非ブロッキングにできる\u003c/h2\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003e\u003ccode\u003eDispatcher.Invoke\u003c/code\u003eのオーバーロードに\u003ccode\u003eDispatcher.Priority\u003c/code\u003eを受け取るものがありまして、これ、省略した場合は\u003ccode\u003eDispatcherPriority.Send(最高優先度)\u003c/code\u003eで実行されるんですよ。\u003cbr\u003e\nなので、引数を明示的に指定してあげて\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etxtFileCount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eThreading\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatcherPriority\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBackground\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eテキストボックスのレンダリングの優先度をBackground(4)にしてボタン入力(Input:5)よりも優先度を下げてやるとボタンが押せるようになるかも。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eというコメントを頂きました。\u003cbr\u003e\n実際にこの通りでしたので、これ以降の非同期的に\u003ccode\u003eforeach\u003c/code\u003eをしてやらなくても大丈夫そうですね( ˘ω˘)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ボタンを非ブロッキング状態にする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E9%9D%9E%E3%83%96%E3%83%AD%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E7%8A%B6%E6%85%8B%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eボタンを非ブロッキング状態にする\u003c/h1\u003e\n\n\u003cp\u003e非同期処理内で同期処理をしてしまっていることが原因だとすれば、どうすれば非ブロッキング状態にできるのか明白ですね。\u003cbr\u003e\n非同期処理内で非同期処理をしてやればいいじゃん！！\u003c/p\u003e\n\n\u003cp\u003eということで、ファイル取得メソッドを非同期にしてみました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateDirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAsParallel\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_exceptFolder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartsWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStringComparison\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentCultureIgnoreCase\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//同階層にフォルダが存在しなければ同階層のファイルを取得するタスクを返す\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAny\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//再帰的にフォルダを探し続ける\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efilePaths\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhenAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n                                  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efilePaths\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelectMany\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//タスクを作成する\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etcs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskCompletionSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003etcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e非同期処理内で非同期処理をさせる事でこれで思い通りの処理になるはずだぜﾋｬｯﾊｰ＼(＾o＾)／\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/945ea06a946a42dc54de809bf667a2f9681b38db/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f63633861316231322d623935332d633963632d346631362d6263306164656364353461622e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fcc8a1b12-b953-c9cc-4f16-bc0adecd54ab.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=990782d2c98aeb15f6b5b09365f6df53\" alt=\"非同期2.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/cc8a1b12-b953-c9cc-4f16-bc0adecd54ab.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fcc8a1b12-b953-c9cc-4f16-bc0adecd54ab.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=391c7dd129da022dae59d7d3f081dfcc 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nなんてこったい／(^o^)＼\u003cbr\u003e\n確かにボタンは非ブロッキング状態になったけど、ボタンを押しても何もおきねぇ／(^o^)＼\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e～ 2分後 ～\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/fd914535bde1ba6beb8d756aa0231a7c96a56877/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f34323534656638312d643034372d383335342d323361652d3138666564393962653164612e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F4254ef81-d047-8354-23ae-18fed99be1da.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=adf08ddf724ca08f8b88fc56d16fde1e\" alt=\"非同期3.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/4254ef81-d047-8354-23ae-18fed99be1da.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F4254ef81-d047-8354-23ae-18fed99be1da.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=83b582f76b5074594b49d34807024fb1 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n動き出したけどこんどは画面全体がブロッキング状態になってる／(^o^)＼\u003cbr\u003e\nこれ、非同期処理内で同期処理させた時よりも状況がひどくなってる／(^o^)＼\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"新ステージforeachasyncで更なる高みへ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%96%B0%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8foreachasync%E3%81%A7%E6%9B%B4%E3%81%AA%E3%82%8B%E9%AB%98%E3%81%BF%E3%81%B8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e新ステージ、ForeachAsyncで更なる高みへ\u003c/h1\u003e\n\n\u003cp\u003eこれまでの流れを整理する。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eファイル取得を同期処理で行う。ただこれだと画面が固まってしまう。\u003c/li\u003e\n\u003cli\u003eスレッドプールでファイル取得を同期処理で行う。ただこれだとボタンがブロッキング状態になってしまう。\u003c/li\u003e\n\u003cli\u003eスレッドプールでファイル取得を非同期処理で行う。ただこれだと\u003ccode\u003eforeach\u003c/code\u003eで展開された後に全体がブロッキング状態に。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこのことから考えてもうこれしかないと思った。\u003cbr\u003e\n\u003cstrong\u003eForeachは非同期処理を同期的にしか展開してくれねぇ説！！！！！！！\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eじゃあやってやろうじゃないの、\u003ccode\u003eForeachAsync\u003c/code\u003eってやつをよ。\u003cbr\u003e\nいつもお世話になってます、neueさん、拝借させて頂きます。\u003cbr\u003e\n\u003ca href=\"http://neue.cc/2014/03/14_448.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eForEachAsync - 非同期の列挙の方法 Part2\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eさて、ここで書かれてある拡張メソッドをコピっとペッで作ります。\u003cbr\u003e\n作ったうえで、この\u003ccode\u003eForeachAsync\u003c/code\u003eを使えるようにファイル取得メソッドを作り変えます。それがコチラ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eConfiguredTaskAwaitable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateDirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAsParallel\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_exceptFolder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartsWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStringComparison\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentCultureIgnoreCase\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//ディレクトリにアクセスできないならファイルはない\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//同階層にフォルダが存在しなければ同階層のファイルを取得するタスクを返す\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAny\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//再帰的にフォルダを探し続ける\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelectMany\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//タスクを作成\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etcs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskCompletionSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003etcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eForeachAsync\u003c/code\u003eは\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eの拡張メソッドなので、元々\u003ccode\u003eTask\u0026lt;IEnumerable\u0026lt;string\u0026gt;\u0026gt;\u003c/code\u003eだったところを\u003cbr\u003e\n更に\u003ccode\u003eIEnumerable\u003c/code\u003eで包んであげて \u003ccode\u003eIEnumerable\u0026lt;ConfiguredTaskAwaitable\u0026lt;IEnumerable\u0026lt;string\u0026gt;\u0026gt;\u0026gt;型\u003c/code\u003eへと進化しました！！！！\u003c/p\u003e\n\n\u003cp\u003eはい、じゃあ後は実行するだけ。\u003cbr\u003e\nちゃんとタスクに\u003ccode\u003eCancellationToken\u003c/code\u003eを渡して\u003ccode\u003eThrowIfCancellationRequestedメソッド\u003c/code\u003e使って例外投げるだけでおｋ。おけまる。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eButton_Click\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRoutedEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eThreadPool\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetMinThreads\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//実行中にもう一度押されたらタスクをキャンセル\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_isExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_isExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCancel\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ebtnGetFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"実行中\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_isExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToken\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//スレッドプールさん、処理をお願いします何でもしますから\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e@\"C:\\\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eForEachAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//キャンセルされれば例外で止める\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eThrowIfCancellationRequested\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etxtFileCount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//ignore\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efinally\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_isExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebtnGetFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"ファイル取得\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/4d966e1f2071a5a3d1cc3533ae04a06c7c8decfb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f66636362303865312d613765662d306333302d326136372d3532623730643532623733332e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Ffccb08e1-a7ef-0c30-2a67-52b70d52b733.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=68b3532b4acaf0d956ab9715ff12da49\" alt=\"非同期4.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/fccb08e1-a7ef-0c30-2a67-52b70d52b733.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Ffccb08e1-a7ef-0c30-2a67-52b70d52b733.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f78abad6ba073e4731ce181da8dd6a01 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/0e2d332011c0dd2e58f35fb70a70fadc93b82e6c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f63396237393062332d656132302d323239652d303639652d3564376136353630616431362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fc9b790b3-ea20-229e-069e-5d7a6560ad16.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=bfe585d2b1e349f1ba2265333fe4e267\" alt=\"圧倒的感謝.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/c9b790b3-ea20-229e-069e-5d7a6560ad16.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2Fc9b790b3-ea20-229e-069e-5d7a6560ad16.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6dcd0696d4387fd8019a0ea2afad966a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれが……これが、やりたかった！！！！！\u003cbr\u003e\nということで、予想していた\u003ccode\u003eForeach\u003c/code\u003eは非同期処理を同期的にしか展開してくれねぇ説！はまあ大方合っていたのかな？\u003cbr\u003e\n多分。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"パフォーマンス改善\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%94%B9%E5%96%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eパフォーマンス改善\u003c/h1\u003e\n\n\u003cp\u003eさてさてさーて、欲しいものはできた。が、実際に上記のコードを動かしてみた方は分かると思いますが、\u003cstrong\u003eパフォーマンスが死ぬ程わるい！！！！\u003c/strong\u003e\u003cbr\u003e\n比較してみた。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"パフォーマンスの比較\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AE%E6%AF%94%E8%BC%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eパフォーマンスの比較\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003e比較条件\u003c/strong\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eでファイル取得をするだけ\u003c/li\u003e\n\u003cli\u003eCドライブ以下を対象とする\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e//パターン1に関しては省略\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//パターン2の計測の仕方\u003c/span\u003e\n\u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e@\"C:\\\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eForEachAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//キャンセルされれば例外で止める\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eThrowIfCancellationRequested\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//念の為スレッドセーフにインクリメントを行う\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eInterlocked\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIncrement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e50000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCancel\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eファイル件数\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e掛かった時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eプロセスメモリ\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパターン1\u003cbr\u003e GetAllFilesメソッド\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e6.64秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e57MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパターン2\u003cbr\u003e GetAllFilesAsyncメソッド\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e1分10秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e60MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eね、遅いよね。\u003cbr\u003e\nこの遅くなり方は何か致命的なミスをしているはず…。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"並列クエリを付けたりなくしたりしてみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%A6%E5%88%97%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E4%BB%98%E3%81%91%E3%81%9F%E3%82%8A%E3%81%AA%E3%81%8F%E3%81%97%E3%81%9F%E3%82%8A%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e並列クエリを付けたりなくしたりしてみる\u003c/h2\u003e\n\n\u003cp\u003e色々試していたら一個気付いた。\u003cbr\u003e\n\u003ccode\u003eAsParallel\u003c/code\u003e邪魔なんじゃね！！！！！？？？？？\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eファイル件数\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e掛かった時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eプロセスメモリ\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパターン1\u003cbr\u003e GetAllFilesメソッド\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e6.64秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e57MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパターン2\u003cbr\u003e GetAllFilesAsyncメソッド\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e1分10秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e60MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパターン3\u003cbr\u003e GetAllFilesメソッドにAsParallelを追加して並列処理\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e終わらない…\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e-\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパターン4\u003cbr\u003e GetAllFilesAsyncメソッドからAsParallelを削除\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e7.06秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e60MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e\u003ccode\u003eAsParallelメソッド\u003c/code\u003eを使用した場合がどちらも遅い。というか絶望的に遅い。\u003cbr\u003e\nもしかして、並列処理実行時に例外が発生した場合ってかなりコストがかかってる感じですか…？\u003cbr\u003e\nとりあえず一つは\u003ccode\u003eAsParallelメソッドを使用しない\u003c/code\u003e事で大幅に上がりそう。（前に計測した時は倍速だった気が…。）\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"taskcreationoptionslongrunning-を設定してみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#taskcreationoptionslongrunning-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTaskCreationOptions.LongRunning を設定してみる\u003c/h2\u003e\n\n\u003cp\u003e幾つかのサイトを流し見していると何回かチラ見するこの\u003ccode\u003eTaskCreationOptions.LongRunning\u003c/code\u003eというやつ。\u003cbr\u003e\nなんか明らかに長い時間タスクを実行するときに付けたほうがよさそうな名前。\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eTaskCreationOptions\u003cbr\u003e\nタスクの作成および実行に関するオプションの動作を制御するフラグ\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eふむ。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003eフラグ\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e説明\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eNone\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e既定の動作を適用します\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003ePreferFairness\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eTaskScheduler に対し、できる限り公平にタスクをスケジュールするように指示します\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e\u003cstrong\u003eLongRunning\u003c/strong\u003e\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e\u003cstrong\u003e粒度の細かいシステムではなく、タスクが長時間実行され、少量の大きなコンポーネントを含む粒度の粗い操作とすることを指定します\u003c/strong\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eAttachedToParent\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eタスクがタスク階層の親にアタッチされることを指定します\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eDenyChildAttach\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eアタッチされた子タスクとして実行を試みるすべての子タスクが、親タスクにアタッチされるのではなく、デタッチされた子タスクとして実行されるように指定します\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eHideScheduler\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eアンビエント スケジューラが作成されたタスクの現在のスケジューラと見なされることを防止します\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eRunContinuationsAsynchronously\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e現在のタスクに追加される継続処理を強制的に非同期実行します\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e詳しくは\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/api/system.threading.tasks.taskcreationoptions?redirectedfrom=MSDN\u0026amp;view=netframework-4.7.2\" rel=\"nofollow noopener\" target=\"_blank\"\u003eTaskCreationOptions Enum \u003c/a\u003eを参照してください。\u003c/p\u003e\n\n\u003cp\u003eとりあえずやってみた。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e//Task.RunではTaskCreationOptionsを設定できないのでTask.Factoryを使用する\u003c/span\u003e\n\u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartNew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e@\"C:\\\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eForEachAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//キャンセルされれば例外で止める\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eThrowIfCancellationRequested\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//念の為スレッドセーフにインクリメントを行う\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eInterlocked\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIncrement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e50000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCancel\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskCreationOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLongRunning\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskScheduler\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDefault\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eファイル件数\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e掛かった時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eプロセスメモリ\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eGetAllFilesメソッド\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e6.64秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e57MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eGetAllFilesAsyncメソッドからAsParallelを削除\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e7.06秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e60MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eGetAllFilesAsyncメソッドからAsParallelを削除 +\u003cbr\u003eTaskCreationOptions.LongRunning を設定\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e5.97秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e59MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eほぼ誤差の範囲っぽい。このサイトに少し詳しく書いてあります。\u003cbr\u003e\n\u003ca href=\"https://devlights.hatenablog.com/entry/2014/01/15/010832\" rel=\"nofollow noopener\" target=\"_blank\"\u003eタスク並列ライブラリ入門記-006 (TaskCreationOptions.LongRunning, 長時間実行されるタスクであることを示すオプション, オーバーサブスクリプション) \u003c/a\u003e\u003cbr\u003e\nスレッドの切り替えにかかる時間が若干軽減する、かも！？ぐらいな感じでしょうか。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"foreachasync-の排他制御を外す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#foreachasync-%E3%81%AE%E6%8E%92%E4%BB%96%E5%88%B6%E5%BE%A1%E3%82%92%E5%A4%96%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eForeachAsync の排他制御を外す\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/OXamarin/items/51c0d713910895a9ccba#%E6%96%B0%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8foreachasync%E3%81%A7%E6%9B%B4%E3%81%AA%E3%82%8B%E9%AB%98%E3%81%BF%E3%81%B8\"\u003e新ステージ、ForeachAsyncで更なる高みへ\u003c/a\u003eで\u003ccode\u003e非同期なforeach\u003c/code\u003eを作った訳ですが、中身をちゃんと見ると\u003ccode\u003eSemaphoreSlim\u003c/code\u003eが使用されています。\u003ccode\u003eSemaphoreSlim\u003c/code\u003eについては以下の記事がとてもわかりやすいです。\u003cbr\u003e\n\u003ca href=\"http://blog.awagat.com/?p=701\" rel=\"nofollow noopener\" target=\"_blank\"\u003eたがわ製作所ブログ - 非同期処理におけるセマフォを用いた排他制御\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eまあ要は、\u003ccode\u003eTask\u003c/code\u003eの最大同時実行数に制限を掛けているわけなんですが、今回はCドライブ以下のファイルパスを根こそぎ持ってくるだけなので特に処理順序なんて必要ないですし求められているのはメモリをぶん殴ってでも速度が欲しい訳です。じゃあどうするか？\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"n\"\u003eForEachAsyncNoLock\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eaction\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003econfigureAwait\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentNullException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"source\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaction\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentNullException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"action\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etasks\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eThrowIfCancellationRequested\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eaction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etasks\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhenAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etasks\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eSemaphoreSlim\u003c/code\u003eを消し去ってやればいいじゃない。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eファイル件数\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e掛かった時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eプロセスメモリ\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eGetAllFilesメソッド\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e6.64秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e57MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eGetAllFilesAsyncメソッドからAsParallelを削除\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e7.06秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e60MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eGetAllFilesAsyncメソッドからAsParallelを削除 +\u003cbr\u003eForEachAsyncNoLock\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e5.97秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e59MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e1割程度は改善した感じ？\u003cbr\u003e\nちな、\u003ccode\u003eForEachAsyncNoLock\u003c/code\u003eは後述するUI描画時のパフォーマンスにめちゃ役に立ちます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ファイルパス取得--ui描画のパフォーマンス比較\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%91%E3%82%B9%E5%8F%96%E5%BE%97--ui%E6%8F%8F%E7%94%BB%E3%81%AE%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%AF%94%E8%BC%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eファイルパス取得 + UI描画のパフォーマンス比較\u003c/h2\u003e\n\n\u003cp\u003eロジック面で思いつくことは粗方やれたかな、と思います。\u003cbr\u003e\nなので次は\u003ccode\u003eファイルパス取得 + UIへの描画\u003c/code\u003eに掛かる時間を図ります。\u003cbr\u003e\nんで今更なんですが、非同期処理実行時には\u003ccode\u003eDispatcherPriority.Background\u003c/code\u003eを指定してあげないとフォームの移動とかさせられないですね。。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etxtFileCount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//}, _cancellationToken); こうじゃない\u003c/span\u003e\n\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003eDispatcherPriority\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBackground\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e//こっち\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eさっそく計測してみる。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eファイル件数\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e掛かった時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eプロセスメモリ\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eForEachAsync\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e1分58秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e57MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eForEachAsyncNoLock\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e2分02秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e60MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eえっ\u003cbr\u003e\n実行上限数が設定されてない\u003ccode\u003eForEachAsyncNoLock\u003c/code\u003eの方が遅い。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"非同期的にuiを更新する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%ABui%E3%82%92%E6%9B%B4%E6%96%B0%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e非同期的にUIを更新する\u003c/h2\u003e\n\n\u003cp\u003eこの結果を受けて考えました。なぜ、\u003ccode\u003eForEachAsyncNoLock\u003c/code\u003eの方が遅いのか、と。\u003cbr\u003e\nそこで一つの可能性として、\u003ccode\u003eUIスレッド\u003c/code\u003eの実行権限取得時に競合的な何かが起きているのでは？と考えました。\u003c/p\u003e\n\n\u003cp\u003eどういうことかというと\u003ccode\u003eForEachAsync\u003c/code\u003eに対して\u003ccode\u003eForEachAsyncNoLock\u003c/code\u003eの方が同時実行タスク数が多くなる可能性があり、\u003ccode\u003eUI\u003c/code\u003eを更新できるのは\u003ccode\u003eUIスレッド\u003c/code\u003eからのみ、という前提から考えれば\u003ccode\u003eUIスレッド\u003c/code\u003eを奪い合う頻度の高い\u003ccode\u003eForEachAsyncNoLock\u003c/code\u003eの方が遅くなって当然なのかなと一旦理解しました。\u003c/p\u003e\n\n\u003cp\u003eそこでふと、\u003ccode\u003eInvokeAsyncメソッド\u003c/code\u003eがあることを思い出し、これを使えば競合なくきちんと待ってから\u003ccode\u003eUIスレッド\u003c/code\u003eを効率的にタスクスケジュールしてくれるのでは？と考えて計測してみました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e@\"C:\\\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eForEachAsyncNoLock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//キャンセルされれば例外で止める\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eThrowIfCancellationRequested\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//念の為スレッドセーフにインクリメントを行う\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eInterlocked\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIncrement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//意図的にawaitを付けない\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvokeAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etxtFileCount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003eDispatcherPriority\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBackground\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//50000件の計測用\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e50000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCancel\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eファイル件数\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e掛かった時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eプロセスメモリ\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eForEachAsync\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e1分58秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e83MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eForEachAsyncNoLock\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e2分02秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e83MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eForEachAsync +\u003cbr\u003e InvokeAsync\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e8.42秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e123MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eForEachAsyncNoLock +\u003cbr\u003e InvokeAsync\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e7.07秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e121MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e正直、草生えました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/0af98d7b7a3fc704c8932418ecd4020cf708ced2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f39376534356437392d623764332d356261612d383662382d3939623130313535313534382e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F97e45d79-b7d3-5baa-86b8-99b101551548.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2cae5cc79cf5f8b7d6414eccbc68089b\" alt=\"非同期6.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/97e45d79-b7d3-5baa-86b8-99b101551548.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F97e45d79-b7d3-5baa-86b8-99b101551548.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=c9dc4f185cab01a4784523d5135dc921 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n結局、非同期処理をやりたいのって「ちゃんと処理してるんだぜなう」みたいなアピールが出来てればよくて、進捗状況まで律義に待ってやる必要なんてないですね。そういう理由で\u003ccode\u003eInvokeAsync\u003c/code\u003eを意図的に同期処理させています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"パフォーマンス改善後\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%94%B9%E5%96%84%E5%BE%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eパフォーマンス改善後\u003c/h2\u003e\n\n\u003cp\u003e実行時間に若干のムラはありますが、思ったより納得いく所までパフォーマンスを上げられました。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003eファイル取得 + UIの更新までの時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eファイル件数\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e掛かった時間\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eプロセスメモリ\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパフォーマンス改善前\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e2分29秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e83MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eパフォーマンス改善後\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e50,000件\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e7秒\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e121MB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e暫定版。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateDirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//.AsParallel() 悪夢の元凶\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_exceptFolder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartsWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStringComparison\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentCultureIgnoreCase\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//同階層にフォルダが存在しなければ同階層のファイルを取得するタスクを返す\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAny\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e)).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//再帰的にフォルダを探し続ける\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efilePaths\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhenAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n                                  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efilePaths\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelectMany\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//タスクを作成する\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etcs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskCompletionSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edirectories\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003etcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eBtnGetFile_Click\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRoutedEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//省略\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetAllFilesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e@\"C:\\\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFilesCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eForEachAsyncNoLock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerateFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//キャンセルされれば例外で止める\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eThrowIfCancellationRequested\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//念の為スレッドセーフにインクリメントを行う\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eInterlocked\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIncrement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//意図的にawaitを付けない\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvokeAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etxtFileCount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003eDispatcherPriority\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBackground\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//省略\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"c-80で実装予定の非同期-foreach\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#c-80%E3%81%A7%E5%AE%9F%E8%A3%85%E4%BA%88%E5%AE%9A%E3%81%AE%E9%9D%9E%E5%90%8C%E6%9C%9F-foreach\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eC# 8.0で実装予定の非同期 foreach\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://ufcpp.net/blog/2018/12/cs8asyncstreams/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC# 8.0 Async streams\u003c/a\u003e\u003cbr\u003e\n実装されるみたいです！！\u003c/p\u003e\n\n\u003cp\u003e気が向けば、VS2019をインストールして、追記しますね( ˘ω˘)\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e追記 (2019/02/09)\u003c/strong\u003e\u003cbr\u003e\n非同期foreachを試してみましたが…。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/82694a80caa3a2d40f88ecf4ee274bc56066367c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3137323232332f39336235393636382d303433392d313564362d353836612d3731383938653763393835312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F93b59668-0439-15d6-586a-71898e7c9851.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=940bda4f4dd65f2b9644ff1fe84dec4e\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/172223/93b59668-0439-15d6-586a-71898e7c9851.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F172223%2F93b59668-0439-15d6-586a-71898e7c9851.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=9e2920a603d8128160350689429b7e16 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eVS2019で実行\u003c/li\u003e\n\u003cli\u003eプロジェクトの詳細設定から\u003ccode\u003eC# 8.0\u003c/code\u003eを選択\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://ufcpp.net/blog/2018/12/cs8asyncstreams/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC# 8.0 Async streams\u003c/a\u003eからコピペ\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eうん、動かん。( ˘ω˘)\u003cbr\u003e\n正式リリースを待つとします…。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003eCドラ以下のファイルパスを取得したかったというよりも、その過程での非同期処理の勉強の為にこういうことをやっていました。\u003cbr\u003e\nなんとなくで非同期処理を書けてしまう、、それはそれでよい事ですがちゃんと理解してコーディングしたいですよね。\u003cbr\u003e\n今回の記事を書くにあたって、非常に参考にさせて頂いたサイトを紹介して〆たいと思います。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://ufcpp.net/study/csharp/sp5_async.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e未確認飛行 - 非同期メソッド\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://ufcpp.wordpress.com/2012/11/12/asyncawait%E3%81%A8%E5%90%8C%E6%99%82%E5%AE%9F%E8%A1%8C%E5%88%B6%E5%BE%A1/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e未確認飛行 - async/awaitと同時実行制御\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/acple@github/items/8f63aacb13de9954c5da\" id=\"reference-b08ea53b997d3996bb99\"\u003eQiita - Taskを極めろ！async/await完全攻略\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/chocolamint/items/ed4999cccf011653cb78\" id=\"reference-2bc7f6d34b09f71fd8af\"\u003eQiita - TAP (Task-based Asynchronous Pattern) 非同期メソッドのガイドライン\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://qwerty2501.hatenablog.com/entry/2014/04/24/235849\" rel=\"nofollow noopener\" target=\"_blank\"\u003e飽きっぽい人のブログ - async/await ～非同期なライブラリは楽じゃない～\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2019-02-07T15:07:56Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"43KWZwoT00GhwfL6lL8f3JviA6mPFVvz--+zVpMNYMthK9xiCB--8OwjfoA259qCIL9MoNM7fw==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-02-14T15:51:53Z","likesCount":47,"linkUrl":"https://qiita.com/OXamarin/items/51c0d713910895a9ccba","organization":null,"originalId":783037,"stockedCount":45,"title":"【C#】Cドライブ以下にある全てのファイルパスを非同期かつIEnumerableに取得してみた","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%83%8C%E6%99%AF\"\u003e背景\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%81%86%E3%81%84%E3%81%86%E3%81%93%E3%81%A8%E3%81%8C%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84\"\u003eこういうことがやりたい\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#directoryenumeratefiles-%E3%81%8Cc%E3%83%89%E3%83%A9%E7%9B%B4%E4%B8%8B%E3%81%A0%E3%81%A8%E5%BD%B9%E3%81%AB%E7%AB%8B%E3%81%9F%E3%81%AA%E3%81%84%E4%BB%B6\"\u003eDirectory.EnumerateFiles がCドラ直下だと役に立たない件\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#try-catch-%E3%81%A7%E5%85%A8%E3%81%A6%E3%82%92%E6%8F%A1%E3%82%8A%E3%81%A4%E3%81%B6%E3%81%97%E3%81%A6c%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\"\u003etry catch で全てを握りつぶしてCドラ以下のファイルを取得する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ienumerable%E5%9E%8B%E3%81%A7c%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\"\u003eIEnumerable型でCドラ以下のファイルを取得する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#asyncawait-%E3%81%A7%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%ABc%E3%83%89%E3%83%A9%E4%BB%A5%E4%B8%8B%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97\"\u003easync/await で非同期的にCドラ以下のファイルを取得\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#dispatcherpriority%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E9%9D%9E%E3%83%96%E3%83%AD%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A7%E3%81%8D%E3%82%8B\"\u003eDispatcher.Priorityを使用して非ブロッキングにできる\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9C%E3%82%BF%E3%83%B3%E3%82%92%E9%9D%9E%E3%83%96%E3%83%AD%E3%83%83%E3%82%AD%E3%83%B3%E3%82%B0%E7%8A%B6%E6%85%8B%E3%81%AB%E3%81%99%E3%82%8B\"\u003eボタンを非ブロッキング状態にする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%96%B0%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8foreachasync%E3%81%A7%E6%9B%B4%E3%81%AA%E3%82%8B%E9%AB%98%E3%81%BF%E3%81%B8\"\u003e新ステージ、ForeachAsyncで更なる高みへ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%94%B9%E5%96%84\"\u003eパフォーマンス改善\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%AE%E6%AF%94%E8%BC%83\"\u003eパフォーマンスの比較\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%A6%E5%88%97%E3%82%AF%E3%82%A8%E3%83%AA%E3%82%92%E4%BB%98%E3%81%91%E3%81%9F%E3%82%8A%E3%81%AA%E3%81%8F%E3%81%97%E3%81%9F%E3%82%8A%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e並列クエリを付けたりなくしたりしてみる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#taskcreationoptionslongrunning-%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003eTaskCreationOptions.LongRunning を設定してみる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#foreachasync-%E3%81%AE%E6%8E%92%E4%BB%96%E5%88%B6%E5%BE%A1%E3%82%92%E5%A4%96%E3%81%99\"\u003eForeachAsync の排他制御を外す\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%91%E3%82%B9%E5%8F%96%E5%BE%97--ui%E6%8F%8F%E7%94%BB%E3%81%AE%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%AF%94%E8%BC%83\"\u003eファイルパス取得 + UI描画のパフォーマンス比較\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%ABui%E3%82%92%E6%9B%B4%E6%96%B0%E3%81%99%E3%82%8B\"\u003e非同期的にUIを更新する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%94%B9%E5%96%84%E5%BE%8C\"\u003eパフォーマンス改善後\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#c-80%E3%81%A7%E5%AE%9F%E8%A3%85%E4%BA%88%E5%AE%9A%E3%81%AE%E9%9D%9E%E5%90%8C%E6%9C%9F-foreach\"\u003eC# 8.0で実装予定の非同期 foreach\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":8321,"uuid":"51c0d713910895a9ccba","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"CP2svQb2u/WN+ROqc9WyAO0Y9hRE--hoWPHq0Nu9UEbkQa--SQnD3gSWkTD/bsO7WNBbLA==","originalId":172223,"description":"Xamarin(ザマリン と読みます)の情報を超入門的な所から扱っています。\r\n「Xamarinでぐぐれ」と言えるようになりたいです。","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"また かり","profileImageUrl":"https://pbs.twimg.com/profile_images/812609627082792961/QC9U4qVV_normal.jpg","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fpbs.twimg.com%2Fprofile_images%2F812609627082792961%2FQC9U4qVV_normal.jpg?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=1c2f09ecb1af9203a497dab0e530ea17","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fpbs.twimg.com%2Fprofile_images%2F812609627082792961%2FQC9U4qVV_normal.jpg?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=d8dafa4a0e71caf83d0faa285fffbbc5","urlName":"OXamarin","websiteUrl":"http://oxamarin.com/","twitterUrl":"https://twitter.com/OXamarin","twitterUrlName":"OXamarin","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"WPF","urlName":"wpf"},{"name":"task","urlName":"task"},{"name":"async","urlName":"async"},{"name":"await","urlName":"await"}],"followingLikers":{"edges":[]},"comments":{"totalCount":6}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
