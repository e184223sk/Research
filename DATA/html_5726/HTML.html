<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Windows 10のウィンドウキャプチャAPIをC#のデスクトップアプリから呼び出す - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/everylittle/items/c80de379e644397ceabc" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="txkUcdBBKuN7DFMogXMbgPBUkmqUq9z/BUtZLd4XjJI+/sVuI3DRzcldYYyfikmJU1F/OTgdL8RfyRyBofOi4A==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@hira_elt" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="Windows 10のウィンドウキャプチャAPIをC#のデスクトップアプリから呼び出す - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WMmx1Wkc5M2N5QXhNT09CcnVPQ3B1T0NvLU9Ecy1PRGllT0NwdU9DcmVPRG8tT0RsLU9EZ2VPRG8wRlFTZU9Da2tNajQ0R3U0NE9INDRLNTQ0S3Y0NE9JNDRPRDQ0T1g0NEtpNDRPWDQ0T3E0NEdMNDRLSjVaRzg0NEd6NVllNjQ0R1omdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YmNlNjcwNTY2OTBiNTZmZTJjODEyNGM2MDRkOWEzNGI&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR1YyWlhKNWJHbDBkR3hsJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9MjY4ZWJmMjM2ZmMxYzQyZjc5ZDQ3ZjhhM2E2MjZkY2Q&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=87275a521d5c3d3245ffd782c18b131e"><meta property="og:description" content="

はじめに

Windows 10のウィンドウキャプチャAPI (Windows.Graphics.Capture) を使うと、指定したウィンドウのキャプチャイメージを取得することができます。
画面の取り込み - UWP appli..."><meta content="https://qiita.com/everylittle/items/c80de379e644397ceabc" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C++,C#,WinRT" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-5a5c7f9d-0672-4fd4-969d-1ab6cc9eb369"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Feverylittle%2Fitems%2Fc80de379e644397ceabc">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Feverylittle%2Fitems%2Fc80de379e644397ceabc">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-5a5c7f9d-0672-4fd4-969d-1ab6cc9eb369">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/cpp","name":"C++"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2021-03-13T18:44:38.000+09:00","dateModified":"2021-03-13T21:08:58.000+09:00","headline":"Windows 10のウィンドウキャプチャAPIをC#のデスクトップアプリから呼び出す","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WMmx1Wkc5M2N5QXhNT09CcnVPQ3B1T0NvLU9Ecy1PRGllT0NwdU9DcmVPRG8tT0RsLU9EZ2VPRG8wRlFTZU9Da2tNajQ0R3U0NE9INDRLNTQ0S3Y0NE9JNDRPRDQ0T1g0NEtpNDRPWDQ0T3E0NEdMNDRLSjVaRzg0NEd6NVllNjQ0R1omdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YmNlNjcwNTY2OTBiNTZmZTJjODEyNGM2MDRkOWEzNGI\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR1YyWlhKNWJHbDBkR3hsJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9MjY4ZWJmMjM2ZmMxYzQyZjc5ZDQ3ZjhhM2E2MjZkY2Q\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=87275a521d5c3d3245ffd782c18b131e","mainEntityOfPage":"https://qiita.com/everylittle/items/c80de379e644397ceabc","author":{"@type":"Person","address":"","email":null,"identifier":"everylittle","name":"everylittle","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F204084%2Fprofile-images%2F1544604030?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=ca805aa914ba8d1c5bf5ab7a497a739f","url":"https://qiita.com/everylittle","description":"PythonやWebプログラミングなどのTipsをメモ代わりに投稿しています。たまに機械学習の話題もあります。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita&amp;utm_medium=header-banner">「不動産取引をワンクリックで完結する」世界観へ。GA technologiesの取り組み</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"everylittle","type":"items","id":"c80de379e644397ceabc"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「不動産取引をワンクリックで完結する」世界観へ。GA technologiesの取り組み","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"everylittle","type":"items","id":"c80de379e644397ceabc"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「不動産取引をワンクリックで完結する」世界観へ。GA technologiesの取り組み","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"everylittle","type":"items","id":"c80de379e644397ceabc"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「不動産取引をワンクリックで完結する」世界観へ。GA technologiesの取り組み","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/everylittle/items/c80de379e644397ceabc","location":"/everylittle/items/c80de379e644397ceabc","scheme":"https","host":"qiita.com","port":null,"pathname":"/everylittle/items/c80de379e644397ceabc","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"Fsub7dpPNcUxpdAOA3rvfszp83yX4cM0C8SRvT3794ifLEryKX7O64P04qodg713b+weLztXMA9RRtQRQh/Z+g==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-00ea0560-ec3c-454f-9fe7-20ce01006916"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/everylittle/items/c80de379e644397ceabc/likers" class="css-1iupg5d">3</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">3</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/c80de379e644397ceabc/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/everylittle/items/c80de379e644397ceabc/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/everylittle/items/c80de379e644397ceabc/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/everylittle/items/c80de379e644397ceabc/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/everylittle/items/c80de379e644397ceabc.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/everylittle"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/204084/profile-images/1544604030" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/everylittle" class="css-10ougpm">@<!-- -->everylittle</a><div class="css-1ay9vb9"><span><meta content="2021-03-13T09:44:38Z"/><time dateTime="2021-03-13T12:08:58Z" class="css-m19uds">updated at 2021-03-13</time></span></div></div></div></div></div><h1 class="css-cgzq40">Windows 10のウィンドウキャプチャAPIをC#のデスクトップアプリから呼び出す</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/cpp" class="css-4czcte">C++</a><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/winrt" class="css-4czcte">WinRT</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>Windows 10のウィンドウキャプチャAPI (<code>Windows.Graphics.Capture</code>) を使うと、指定したウィンドウのキャプチャイメージを取得することができます。<br>
<a href="https://docs.microsoft.com/ja-jp/windows/uwp/audio-video-camera/screen-capture" rel="nofollow noopener" target="_blank">画面の取り込み - UWP applications | Microsoft Docs</a></p>

<p>最小化されていない限り、他のウィンドウが上から重なっていたりしても問題なし。こんな感じで。<br>
<a href="https://camo.qiitausercontent.com/f0d55302f1aaa9f6785534c52bdfb391a73dceb8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f35623835353130382d316465352d326537612d653238332d3932343161613639333132662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F5b855108-1de5-2e7a-e283-9241aa69312f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=54797a9e5c92149dd47e6298d5bced35" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/5b855108-1de5-2e7a-e283-9241aa69312f.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F5b855108-1de5-2e7a-e283-9241aa69312f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a9e4b7bfdf8ab36f32636f7e1e71f004 1x" loading="lazy"></a></p>

<p>しかしC++からは使えるっぽいけど、C#の方が書きやすいんだよな。<br>
UWPアプリだとセットアップが面倒なので、<strong>デスクトップアプリから使いたい。</strong>無理なのかな？<br>
<strong>いえいえ、大丈夫。</strong>このサンプル、実はC#のデスクトップアプリだよ！（マジで？）</p>

<p>正確に言えば、WinRTを呼び出すためのラッパーライブラリをC++で書き、C#側から呼び出しています。<br>
概要は以前の記事をどうぞ。<br>
<a href="https://qiita.com/everylittle/items/cb95b24eb9462ddb3cfc" id="reference-f0cd8a6a6aefced7362d">[C#] C++/WinRTのブリッジを作ってC#から呼び出す方法 - Qiita</a></p>

<p>これを応用して、Windows 10のウィンドウキャプチャAPIをラッパーライブラリ化してみましょう。</p>

<h1>
<span id="検証環境" class="fragment"></span><a href="#%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>検証環境</h1>

<ul>
<li>Windows 10 Home (20H2)</li>
<li>Visual Studio 2019 Community</li>
</ul>

<p>Visual Studio Installerからコンポーネントを追加インストールします。</p>

<ul>
<li>ワークロード: 以下の3つにチェック

<ul>
<li>.NETデスクトップ開発</li>
<li>C++によるデスクトップ開発</li>
<li>ユニバーサルWindowsプラットフォーム開発</li>
</ul>
</li>
<li>個別のコンポーネント

<ul>
<li>Windows 10 SDK (10.0.18362.0以降を1つ以上)</li>
<li>（他にもあったかどうか忘れました…）</li>
</ul>
</li>
</ul>

<p>さらに、C++/WinRT開発のためのVSIXをインストールしておきます。<br>
<a href="https://marketplace.visualstudio.com/items?itemName=CppWinRTTeam.cppwinrt101804264" rel="nofollow noopener" target="_blank">C++/WinRT - Visual Studio Marketplace</a></p>

<h1>
<span id="githubにコードを置いています" class="fragment"></span><a href="#github%E3%81%AB%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E7%BD%AE%E3%81%84%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99"><i class="fa fa-link"></i></a>GitHubにコードを置いています</h1>

<p>以下の内容を実行したソースコード一式をGitHubに置いておきます。手っ取り早く動作確認したい方はそちらをどうぞ。<br>
<a href="https://github.com/build1024/GraphicsCaptureCSharp" rel="nofollow noopener" target="_blank">build1024/GraphicsCaptureCSharp: Sample of C# project using features of Windows.Graphics.Capture through a C++/WinRT bridge library</a></p>

<h1>
<span id="ラッパーライブラリ-cwinrt-の開発" class="fragment"></span><a href="#%E3%83%A9%E3%83%83%E3%83%91%E3%83%BC%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA-cwinrt-%E3%81%AE%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a>ラッパーライブラリ (C++/WinRT) の開発</h1>

<h2>
<span id="プロジェクトの作成" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>プロジェクトの作成</h2>

<p>まずは、Windows Runtime Component (C++/WinRT) プロジェクトを以下の設定で作ります。</p>

<ul>
<li>プロジェクト名は <code>GraphicsCaptureBridge</code>
</li>
<li>ソリューション: 新しいソリューションを作成する</li>
<li>ソリューション名 <code>GraphicsCaptureCSharp</code>
</li>
<li>Windowsのターゲットバージョンは1903以降で。</li>
</ul>

<p>こうなっています。<br>
<a href="https://camo.qiitausercontent.com/8a4d2acf01afdc008aadd84bb13919ee0d2a604a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f31343635633738652d386666642d343731662d373839352d3535653764353361303039612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F1465c78e-8ffd-471f-7895-55e7d53a009a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a2f1ce4dbc43295fe7e48f833b5872fd" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/1465c78e-8ffd-471f-7895-55e7d53a009a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F1465c78e-8ffd-471f-7895-55e7d53a009a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=35a76450534f8a66026a460729daf040 1x" loading="lazy"></a></p>

<p>ラッパークラスの名前、<code>Class</code> ではあんまりなので、<code>Capture</code> に変えておきます。<br>
<a href="https://camo.qiitausercontent.com/cdc83c6cef6c3dc7ee78a115688fa1143a77731a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f34616163656332382d656161322d303866622d353362302d3232633839306464646235372e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F4aacec28-eaa2-08fb-53b0-22c890dddb57.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=415e6aed93604c1b6b4272cfe336ea6c" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/4aacec28-eaa2-08fb-53b0-22c890dddb57.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F4aacec28-eaa2-08fb-53b0-22c890dddb57.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b8f8a1a44f2f80fd97c4ee284b0dc12e 1x" loading="lazy"></a><br>
<code>Capture.idl</code>, <code>Capture.cpp</code>, <code>Capture.h</code> の中で、 <code>Class</code> と書いてあるところを全部 <code>Capture</code> に変えます。<code>ClassT</code> も <code>CaptureT</code> に変えます。<br>
そのままプロジェクトをビルドすると <code>Capture.g.cpp</code> が見つからない、といったエラーが出ますが、一度Visual Studioを終了し、再度このソリューションを開いて、プロジェクトをリビルドすると成功します。</p>

<p>さらに、プロジェクトのプロパティ「構成プロパティ」→「C/C++」→「プリプロセッサ」と進み、「プリプロセッサの定義」に以下の2つを追加します（順番も大事です）。これを書かないと後々ハマることになります。DebugとReleaseの両方に追加するのをお忘れなく。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>%(PreprocessorDefinitions)
WINAPI_FAMILY=WINAPI_FAMILY_DESKTOP_APP
</code></pre></div></div>

<p><a href="https://camo.qiitausercontent.com/0b3e602995d5442dbd0f7ba00469a2b83a9dd6ea/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f63376162343264322d373936652d313164642d366163652d6462393065303863613663332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2Fc7ab42d2-796e-11dd-6ace-db90e08ca6c3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3c1e7169b86ecd6f29a1192393b25ccd" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/c7ab42d2-796e-11dd-6ace-db90e08ca6c3.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2Fc7ab42d2-796e-11dd-6ace-db90e08ca6c3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0c73c2cd5921036001052a2e648db5f3 1x" loading="lazy"></a></p>

<h2>
<span id="参照の追加" class="fragment"></span><a href="#%E5%8F%82%E7%85%A7%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>参照の追加</h2>

<p>必要なパッケージを追加します。<br>
プロジェクト名を右クリック→「NuGet パッケージの管理」から以下の2つを追加します。</p>

<ul>
<li>directxtk_desktop_2017 (v2021.1.10.1)</li>
<li>wtl (v10.0.10320)</li>
</ul>

<h2>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h2>

<p>ここからの実装は↓の記事をかなり参考にしています。<br>
<a href="https://qiita.com/eguo/items/90604787a6098af404d9" id="reference-e179b13abe37067e54b1">Windows 10のウィンドウキャプチャAPI - Qiita</a></p>

<h3>
<span id="pchh" class="fragment"></span><a href="#pchh"><i class="fa fa-link"></i></a>pch.h</h3>

<p>↓を参考に、実装に必要なヘッダファイルを書いていきます。<br>
<a href="https://github.com/opysky/examples/blob/master/winrt/GraphicsCapture/CapturePreview/stdafx.h" rel="nofollow noopener" target="_blank">examples/stdafx.h at master · opysky/examples · GitHub</a></p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">pch.h</span></div>
<div class="highlight"><pre class="with-code"><code><span class="cp">#pragma once
</span>
<span class="cp">#define NOMINMAX
</span>
<span class="cp">#include &lt;ppltasks.h&gt;
</span>
<span class="cp">#include &lt;atlbase.h&gt;
#include &lt;atlapp.h&gt;
</span><span class="k">extern</span> <span class="n">CAppModule</span> <span class="n">_Module</span><span class="p">;</span>
<span class="cp">#include &lt;atlwin.h&gt;
#include &lt;atldlgs.h&gt;
#include &lt;atlcrack.h&gt;
#include &lt;atlmisc.h&gt;
</span>
<span class="cp">#include &lt;winrt/Windows.Foundation.h&gt;
#include &lt;winrt/Windows.System.h&gt;
#include &lt;winrt/Windows.Graphics.Capture.h&gt;
#include &lt;winrt/Windows.Graphics.DirectX.h&gt;
#include &lt;winrt/Windows.Graphics.DirectX.Direct3d11.h&gt;
</span>
<span class="cp">#include &lt;shcore.h&gt;
#include &lt;dwmapi.h&gt;
#include &lt;DispatcherQueue.h&gt;
#include &lt;d3d11_4.h&gt;
#include &lt;dxgi1_6.h&gt;
#include &lt;d2d1_3.h&gt;
#include &lt;d2d1_3helper.h&gt;
#include &lt;windows.ui.composition.interop.h&gt;
#include &lt;windows.graphics.directx.direct3d11.interop.h&gt;
#include &lt;Windows.Graphics.Capture.Interop.h&gt;
</span>
<span class="cp">#include &lt;SpriteBatch.h&gt;
</span></code></pre></div>
</div>

<h3>
<span id="direct3dhelperh" class="fragment"></span><a href="#direct3dhelperh"><i class="fa fa-link"></i></a>Direct3DHelper.h</h3>

<p>新しくヘッダファイルを追加します。中身は↓のコードをそのまま使います。<br>
<a href="https://github.com/opysky/examples/blob/master/winrt/GraphicsCapture/CapturePreview/Direct3DHelper.h" rel="nofollow noopener" target="_blank">examples/Direct3DHelper.h at master · opysky/examples · GitHub</a></p>

<h3>
<span id="captureh" class="fragment"></span><a href="#captureh"><i class="fa fa-link"></i></a>Capture.h</h3>

<p>ベースは↓です。<br>
<a href="https://github.com/opysky/examples/blob/master/winrt/GraphicsCapture/CapturePreview/CaptureView.h" rel="nofollow noopener" target="_blank">examples/CaptureView.h at master · opysky/examples · GitHub</a></p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">Capture.h</span></div>
<div class="highlight"><pre class="with-code"><code><span class="cp">#pragma once
</span>
<span class="cp">#include "Capture.g.h"
</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">winrt</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Foundation</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">System</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">DirectX</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">DirectX</span><span class="o">::</span><span class="n">Direct3D11</span><span class="p">;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">Capture</span><span class="p">;</span>

<span class="n">namespace</span> <span class="n">winrt</span><span class="o">::</span><span class="n">GraphicsCaptureBridge</span><span class="o">::</span><span class="n">implementation</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">Capture</span> <span class="o">:</span> <span class="n">CaptureT</span><span class="o">&lt;</span><span class="n">Capture</span><span class="o">&gt;</span>
    <span class="p">{</span>
        <span class="n">Capture</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">ownerHwnd</span><span class="p">);</span>
        <span class="n">IAsyncOperation</span><span class="o">&lt;</span><span class="n">bool</span><span class="o">&gt;</span> <span class="n">StartCaptureForPickedWindowAsync</span><span class="p">();</span>
        <span class="kt">void</span> <span class="n">StopCapture</span><span class="p">();</span>
        <span class="kt">void</span> <span class="n">Resize</span><span class="p">();</span>
        <span class="n">bool</span> <span class="n">IsCapturing</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_framePool</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="p">;</span> <span class="p">}</span>
    <span class="nl">private:</span>
        <span class="n">HRESULT</span> <span class="n">CreateDevice</span><span class="p">();</span>
        <span class="kt">void</span> <span class="n">StartCapture</span><span class="p">(</span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">Capture</span><span class="o">::</span><span class="n">GraphicsCaptureItem</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">item</span><span class="p">);</span>
        <span class="kt">void</span> <span class="n">OnFrameArrived</span><span class="p">(</span>
            <span class="n">Direct3D11CaptureFramePool</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">sender</span><span class="p">,</span>
            <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Foundation</span><span class="o">::</span><span class="n">IInspectable</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">);</span>

        <span class="n">HWND</span> <span class="n">_ownerHwnd</span><span class="p">;</span>

        <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">DirectX</span><span class="o">::</span><span class="n">Direct3D11</span><span class="o">::</span><span class="n">IDirect3DDevice</span> <span class="n">_device</span><span class="p">{</span> <span class="n">nullptr</span> <span class="p">};</span>
        <span class="n">winrt</span><span class="o">::</span><span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">ID3D11Device</span><span class="o">&gt;</span> <span class="n">_d3dDevice</span><span class="p">;</span>
        <span class="n">winrt</span><span class="o">::</span><span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">IDXGISwapChain1</span><span class="o">&gt;</span> <span class="n">_dxgiSwapChain</span><span class="p">;</span>
        <span class="n">winrt</span><span class="o">::</span><span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">ID3D11RenderTargetView</span><span class="o">&gt;</span> <span class="n">_chainedBufferRTV</span><span class="p">;</span>

        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;::</span><span class="n">DirectX</span><span class="o">::</span><span class="n">SpriteBatch</span><span class="o">&gt;</span> <span class="n">_spriteBatch</span><span class="p">;</span>

        <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">Capture</span><span class="o">::</span><span class="n">Direct3D11CaptureFramePool</span> <span class="n">_framePool</span><span class="p">{</span> <span class="n">nullptr</span> <span class="p">};</span>
        <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">Capture</span><span class="o">::</span><span class="n">GraphicsCaptureItem</span> <span class="n">_captureItem</span><span class="p">{</span> <span class="n">nullptr</span> <span class="p">};</span>
        <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">Capture</span><span class="o">::</span><span class="n">GraphicsCaptureSession</span> <span class="n">_captureSession</span><span class="p">{</span> <span class="n">nullptr</span> <span class="p">};</span>
        <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">Capture</span><span class="o">::</span><span class="n">Direct3D11CaptureFramePool</span><span class="o">::</span><span class="n">FrameArrived_revoker</span> <span class="n">_frameArrived</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="n">namespace</span> <span class="n">winrt</span><span class="o">::</span><span class="n">GraphicsCaptureBridge</span><span class="o">::</span><span class="n">factory_implementation</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">Capture</span> <span class="o">:</span> <span class="n">CaptureT</span><span class="o">&lt;</span><span class="n">Capture</span><span class="p">,</span> <span class="n">implementation</span><span class="o">::</span><span class="n">Capture</span><span class="o">&gt;</span>
    <span class="p">{</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>元記事では <code>CWindowImpl</code> を継承してウィンドウのサブクラスとして実装し、そのウィンドウにキャプチャされた画像が描画されるようになっています。しかしこれではC#から使いにくいので、代わりにキャプチャ出力先のウィンドウハンドルをコンストラクタで受け取るようにします。</p>

<p>キャプチャ対象のウィンドウ指定について、ピッカーを使用する点は同じですが、<code>GraphicsCapturePicker</code> や <code>GraphicsCaptureItem</code> オブジェクトをC#側に見せる必要はないので、<strong>「ピッカーを表示し、選択されたらそのウィンドウに対してキャプチャを開始する」</strong>というメソッドとして公開します。それが以下の部分です。</p>

<div class="code-frame" data-lang="c++"><div class="highlight"><pre class="with-code"><code><span class="n">IAsyncOperation</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">StartCaptureForPickedWindowAsync</span><span class="p">();</span>
</code></pre></div></div>

<p><code>IAsyncOperation</code> 型のオブジェクトは、C#側では <code>.AsTask()</code> メソッドで <code>Task</code> オブジェクトに変換することにより <code>await</code> で待機できるようになります。</p>

<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.windowsruntimesystemextensions.astask?view=dotnet-uwp-10.0&amp;preserve-view=true" rel="nofollow noopener" target="_blank">WindowsRuntimeSystemExtensions.AsTask Method (System) | Microsoft Docs</a></p>

<p>あとは、ウィンドウサイズの変更時に拡大率を再計算できるように <code>Resize()</code> メソッドを追加しました（これは今回の本筋からは若干外れます）。</p>

<h3>
<span id="capturecpp" class="fragment"></span><a href="#capturecpp"><i class="fa fa-link"></i></a>Capture.cpp</h3>

<p>クラスの実装です。ベースは↓です。<br>
<a href="https://github.com/opysky/examples/blob/master/winrt/GraphicsCapture/CapturePreview/CaptureView.cpp" rel="nofollow noopener" target="_blank">examples/CaptureView.cpp at master · opysky/examples · GitHub</a></p>

<div class="code-frame" data-lang="c++">
<div class="code-lang"><span class="bold">Capture.cpp</span></div>
<div class="highlight"><pre class="with-code"><code><span class="cp">#include "pch.h"
#include "Capture.h"
#if __has_include("Capture.g.cpp")
#include "Capture.g.cpp"
#endif
</span>
<span class="cp">#include "Direct3DHelper.h"
</span><span class="k">using</span> <span class="k">namespace</span> <span class="o">::</span><span class="n">DirectX</span><span class="p">;</span>

<span class="c1">// Ref: https://github.com/opysky/examples/tree/master/winrt/GraphicsCapture/CapturePreview</span>
<span class="k">namespace</span> <span class="p">{</span>
    <span class="c1">// 今回はキャプチャ対象をPickerで指定するようにする</span>
    <span class="k">auto</span> <span class="n">ShowWindowPickerAsync</span><span class="p">(</span><span class="n">HWND</span> <span class="n">ownerHwnd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">picker</span> <span class="o">=</span> <span class="n">GraphicsCapturePicker</span><span class="p">();</span>
        <span class="n">picker</span><span class="p">.</span><span class="n">as</span><span class="o">&lt;</span><span class="n">IInitializeWithWindow</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Initialize</span><span class="p">(</span><span class="n">ownerHwnd</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">picker</span><span class="p">.</span><span class="n">PickSingleItemAsync</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">auto</span> <span class="n">FitInBox</span><span class="p">(</span><span class="n">Size</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">source</span><span class="p">,</span> <span class="n">Size</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">destination</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// アスペクト比を保持したままボックスに収まる矩形を計算</span>
        <span class="n">Rect</span> <span class="n">box</span><span class="p">;</span>

        <span class="n">box</span><span class="p">.</span><span class="n">Width</span> <span class="o">=</span> <span class="n">destination</span><span class="p">.</span><span class="n">Width</span><span class="p">;</span>
        <span class="n">box</span><span class="p">.</span><span class="n">Height</span> <span class="o">=</span> <span class="n">destination</span><span class="p">.</span><span class="n">Height</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">aspect</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">Width</span> <span class="o">/</span> <span class="n">source</span><span class="p">.</span><span class="n">Height</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">Width</span> <span class="o">&gt;=</span> <span class="n">box</span><span class="p">.</span><span class="n">Height</span> <span class="o">*</span> <span class="n">aspect</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">box</span><span class="p">.</span><span class="n">Width</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">Height</span> <span class="o">*</span> <span class="n">aspect</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">aspect</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">Height</span> <span class="o">/</span> <span class="n">source</span><span class="p">.</span><span class="n">Width</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">Height</span> <span class="o">&gt;=</span> <span class="n">box</span><span class="p">.</span><span class="n">Width</span> <span class="o">*</span> <span class="n">aspect</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">box</span><span class="p">.</span><span class="n">Height</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">Width</span> <span class="o">*</span> <span class="n">aspect</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">box</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">destination</span><span class="p">.</span><span class="n">Width</span> <span class="o">-</span> <span class="n">box</span><span class="p">.</span><span class="n">Width</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="n">f</span><span class="p">;</span>
        <span class="n">box</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">destination</span><span class="p">.</span><span class="n">Height</span> <span class="o">-</span> <span class="n">box</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="n">f</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">CRect</span><span class="p">(</span>
            <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">X</span><span class="p">),</span>
            <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">Y</span><span class="p">),</span>
            <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">X</span> <span class="o">+</span> <span class="n">box</span><span class="p">.</span><span class="n">Width</span><span class="p">),</span>
            <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">Y</span> <span class="o">+</span> <span class="n">box</span><span class="p">.</span><span class="n">Height</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">namespace</span> <span class="n">winrt</span><span class="o">::</span><span class="n">GraphicsCaptureBridge</span><span class="o">::</span><span class="n">implementation</span>
<span class="p">{</span>
    <span class="n">Capture</span><span class="o">::</span><span class="n">Capture</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">ownerHwnd</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_ownerHwnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">HWND</span><span class="p">)</span><span class="n">ownerHwnd</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">CreateDevice</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">HRESULT</span> <span class="n">Capture</span><span class="o">::</span><span class="n">CreateDevice</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">WINRT_VERIFY</span><span class="p">(</span><span class="n">IsWindow</span><span class="p">(</span><span class="n">_ownerHwnd</span><span class="p">));</span>

        <span class="n">_device</span> <span class="o">=</span> <span class="n">CreateDirect3DDevice</span><span class="p">();</span>
        <span class="n">_d3dDevice</span> <span class="o">=</span> <span class="n">GetDXGIInterfaceFromObject</span><span class="o">&lt;</span><span class="n">ID3D11Device</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_device</span><span class="p">);</span>

        <span class="k">auto</span> <span class="n">dxgiDevice</span> <span class="o">=</span> <span class="n">_d3dDevice</span><span class="p">.</span><span class="n">as</span><span class="o">&lt;</span><span class="n">IDXGIDevice2</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">IDXGIAdapter</span><span class="o">&gt;</span> <span class="n">dxgiAdapter</span><span class="p">;</span>
        <span class="n">check_hresult</span><span class="p">(</span><span class="n">dxgiDevice</span><span class="o">-&gt;</span><span class="n">GetParent</span><span class="p">(</span><span class="n">guid_of</span><span class="o">&lt;</span><span class="n">IDXGIAdapter</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">dxgiAdapter</span><span class="p">.</span><span class="n">put_void</span><span class="p">()));</span>
        <span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">IDXGIFactory2</span><span class="o">&gt;</span> <span class="n">dxgiFactory</span><span class="p">;</span>
        <span class="n">check_hresult</span><span class="p">(</span><span class="n">dxgiAdapter</span><span class="o">-&gt;</span><span class="n">GetParent</span><span class="p">(</span><span class="n">guid_of</span><span class="o">&lt;</span><span class="n">IDXGIFactory2</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">dxgiFactory</span><span class="p">.</span><span class="n">put_void</span><span class="p">()));</span>

        <span class="n">CRect</span> <span class="n">clientRect</span><span class="p">;</span>
        <span class="n">GetWindowRect</span><span class="p">(</span><span class="n">_ownerHwnd</span><span class="p">,</span> <span class="n">clientRect</span><span class="p">);</span>

        <span class="n">DXGI_SWAP_CHAIN_DESC1</span> <span class="n">scd</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="n">scd</span><span class="p">.</span><span class="n">Width</span> <span class="o">=</span> <span class="n">clientRect</span><span class="p">.</span><span class="n">Width</span><span class="p">();</span>
        <span class="n">scd</span><span class="p">.</span><span class="n">Height</span> <span class="o">=</span> <span class="n">clientRect</span><span class="p">.</span><span class="n">Height</span><span class="p">();</span>
        <span class="n">scd</span><span class="p">.</span><span class="n">Format</span> <span class="o">=</span> <span class="n">DXGI_FORMAT_B8G8R8A8_UNORM</span><span class="p">;</span>
        <span class="n">scd</span><span class="p">.</span><span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">DXGI_USAGE_RENDER_TARGET_OUTPUT</span><span class="p">;</span>
        <span class="n">scd</span><span class="p">.</span><span class="n">BufferCount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">scd</span><span class="p">.</span><span class="n">SampleDesc</span><span class="p">.</span><span class="n">Count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">scd</span><span class="p">.</span><span class="n">SwapEffect</span> <span class="o">=</span> <span class="n">DXGI_SWAP_EFFECT_FLIP_SEQUENTIAL</span><span class="p">;</span>
        <span class="n">scd</span><span class="p">.</span><span class="n">AlphaMode</span> <span class="o">=</span> <span class="n">DXGI_ALPHA_MODE_IGNORE</span><span class="p">;</span>

        <span class="n">check_hresult</span><span class="p">(</span><span class="n">dxgiFactory</span><span class="o">-&gt;</span><span class="n">CreateSwapChainForHwnd</span><span class="p">(</span>
            <span class="n">_d3dDevice</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span>
            <span class="n">_ownerHwnd</span><span class="p">,</span> <span class="c1">// *this,</span>
            <span class="o">&amp;</span><span class="n">scd</span><span class="p">,</span>
            <span class="nb">nullptr</span><span class="p">,</span>
            <span class="nb">nullptr</span><span class="p">,</span>
            <span class="n">_dxgiSwapChain</span><span class="p">.</span><span class="n">put</span><span class="p">()));</span>

        <span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">ID3D11Texture2D</span><span class="o">&gt;</span> <span class="n">chainedBuffer</span><span class="p">;</span>
        <span class="n">check_hresult</span><span class="p">(</span><span class="n">_dxgiSwapChain</span><span class="o">-&gt;</span><span class="n">GetBuffer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">guid_of</span><span class="o">&lt;</span><span class="n">ID3D11Texture2D</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">chainedBuffer</span><span class="p">.</span><span class="n">put_void</span><span class="p">()));</span>
        <span class="n">check_hresult</span><span class="p">(</span><span class="n">_d3dDevice</span><span class="o">-&gt;</span><span class="n">CreateRenderTargetView</span><span class="p">(</span><span class="n">chainedBuffer</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="n">_chainedBufferRTV</span><span class="p">.</span><span class="n">put</span><span class="p">()));</span>

        <span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">ID3D11DeviceContext</span><span class="o">&gt;</span> <span class="n">context</span><span class="p">;</span>
        <span class="n">_d3dDevice</span><span class="o">-&gt;</span><span class="n">GetImmediateContext</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">put</span><span class="p">());</span>
        <span class="n">_spriteBatch</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">SpriteBatch</span><span class="o">&gt;</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>

        <span class="k">return</span> <span class="n">S_OK</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">Capture</span><span class="o">::</span><span class="n">StartCapture</span><span class="p">(</span><span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Graphics</span><span class="o">::</span><span class="n">Capture</span><span class="o">::</span><span class="n">GraphicsCaptureItem</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Direct3D11CaptureFramePool は使いまわせても良さそうな気がするけど</span>
        <span class="c1">// GraphicsCaptureSession と一緒に破棄しないとダメっぽ</span>
        <span class="n">StopCapture</span><span class="p">();</span>

        <span class="n">_captureItem</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

        <span class="n">_framePool</span> <span class="o">=</span> <span class="n">Direct3D11CaptureFramePool</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span>
            <span class="n">_device</span><span class="p">,</span>
            <span class="n">DirectXPixelFormat</span><span class="o">::</span><span class="n">B8G8R8A8UIntNormalized</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">_captureItem</span><span class="p">.</span><span class="n">Size</span><span class="p">());</span>
        <span class="n">_frameArrived</span> <span class="o">=</span> <span class="n">_framePool</span><span class="p">.</span><span class="n">FrameArrived</span><span class="p">(</span><span class="n">auto_revoke</span><span class="p">,</span> <span class="p">{</span> <span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Capture</span><span class="o">::</span><span class="n">OnFrameArrived</span> <span class="p">});</span>

        <span class="n">_captureSession</span> <span class="o">=</span> <span class="n">_framePool</span><span class="p">.</span><span class="n">CreateCaptureSession</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
        <span class="n">_captureSession</span><span class="p">.</span><span class="n">StartCapture</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">IAsyncOperation</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">Capture</span><span class="o">::</span><span class="n">StartCaptureForPickedWindowAsync</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">op</span> <span class="o">=</span> <span class="n">ShowWindowPickerAsync</span><span class="p">(</span><span class="n">_ownerHwnd</span><span class="p">);</span>
        <span class="n">GraphicsCaptureItem</span> <span class="n">item</span> <span class="p">{</span> <span class="n">co_await</span> <span class="n">op</span> <span class="p">};</span>
        <span class="kt">bool</span> <span class="n">successful</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">successful</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">StartCapture</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">co_return</span> <span class="n">successful</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">Capture</span><span class="o">::</span><span class="n">StopCapture</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IsCapturing</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">_frameArrived</span><span class="p">.</span><span class="n">revoke</span><span class="p">();</span>

            <span class="n">_captureSession</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

            <span class="c1">// 何故か Direct3DCaptureFramePool は Close を手動で呼び出さないと</span>
            <span class="c1">// 参照カウンタが残ってるというレポートが吐かれる？</span>
            <span class="n">_framePool</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
            <span class="n">_framePool</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

            <span class="n">_captureItem</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">Capture</span><span class="o">::</span><span class="n">Resize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_dxgiSwapChain</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">CRect</span> <span class="n">clientRect</span><span class="p">;</span>
        <span class="n">GetWindowRect</span><span class="p">(</span><span class="n">_ownerHwnd</span><span class="p">,</span> <span class="n">clientRect</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsIconic</span><span class="p">(</span><span class="n">_ownerHwnd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">clientRect</span><span class="p">.</span><span class="n">Width</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">clientRect</span><span class="p">.</span><span class="n">Height</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_chainedBufferRTV</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
            <span class="n">_dxgiSwapChain</span><span class="o">-&gt;</span><span class="n">ResizeBuffers</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">clientRect</span><span class="p">.</span><span class="n">Width</span><span class="p">(),</span> <span class="n">clientRect</span><span class="p">.</span><span class="n">Height</span><span class="p">(),</span> <span class="n">DXGI_FORMAT_B8G8R8A8_UNORM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

            <span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">ID3D11Texture2D</span><span class="o">&gt;</span> <span class="n">chainedBuffer</span><span class="p">;</span>
            <span class="n">check_hresult</span><span class="p">(</span><span class="n">_dxgiSwapChain</span><span class="o">-&gt;</span><span class="n">GetBuffer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">guid_of</span><span class="o">&lt;</span><span class="n">ID3D11Texture2D</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">chainedBuffer</span><span class="p">.</span><span class="n">put_void</span><span class="p">()));</span>
            <span class="n">check_hresult</span><span class="p">(</span><span class="n">_d3dDevice</span><span class="o">-&gt;</span><span class="n">CreateRenderTargetView</span><span class="p">(</span><span class="n">chainedBuffer</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="n">_chainedBufferRTV</span><span class="p">.</span><span class="n">put</span><span class="p">()));</span>

            <span class="n">InvalidateRect</span><span class="p">(</span><span class="n">_ownerHwnd</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">Capture</span><span class="o">::</span><span class="n">OnFrameArrived</span><span class="p">(</span>
        <span class="n">Direct3D11CaptureFramePool</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">sender</span><span class="p">,</span>
        <span class="n">winrt</span><span class="o">::</span><span class="n">Windows</span><span class="o">::</span><span class="n">Foundation</span><span class="o">::</span><span class="n">IInspectable</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">){</span>
        <span class="k">auto</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">sender</span><span class="p">.</span><span class="n">TryGetNextFrame</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">frameSurface</span> <span class="o">=</span> <span class="n">GetDXGIInterfaceFromObject</span><span class="o">&lt;</span><span class="n">ID3D11Texture2D</span><span class="o">&gt;</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">Surface</span><span class="p">());</span>

        <span class="c1">// なんでか知らんが CaptureItem::Size と CaptureFrame::ContentSize が異なる場合が多い</span>
        <span class="c1">// レンダリングは ContentSize を基準にするべき</span>
        <span class="k">auto</span> <span class="n">contentSize</span> <span class="o">=</span> <span class="n">frame</span><span class="p">.</span><span class="n">ContentSize</span><span class="p">();</span>

        <span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">ID3D11ShaderResourceView</span><span class="o">&gt;</span> <span class="n">frameSurfaceSRV</span><span class="p">;</span>
        <span class="n">check_hresult</span><span class="p">(</span><span class="n">_d3dDevice</span><span class="o">-&gt;</span><span class="n">CreateShaderResourceView</span><span class="p">(</span><span class="n">frameSurface</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="n">frameSurfaceSRV</span><span class="p">.</span><span class="n">put</span><span class="p">()));</span>

        <span class="n">com_ptr</span><span class="o">&lt;</span><span class="n">ID3D11DeviceContext</span><span class="o">&gt;</span> <span class="n">context</span><span class="p">;</span>
        <span class="n">_d3dDevice</span><span class="o">-&gt;</span><span class="n">GetImmediateContext</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">put</span><span class="p">());</span>

        <span class="n">ID3D11RenderTargetView</span><span class="o">*</span> <span class="n">pRTVs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">pRTVs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_chainedBufferRTV</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
        <span class="n">context</span><span class="o">-&gt;</span><span class="n">OMSetRenderTargets</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pRTVs</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>

        <span class="n">D3D11_VIEWPORT</span> <span class="n">vp</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="n">DXGI_SWAP_CHAIN_DESC1</span> <span class="n">scd</span><span class="p">;</span>
        <span class="n">_dxgiSwapChain</span><span class="o">-&gt;</span><span class="n">GetDesc1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scd</span><span class="p">);</span>
        <span class="n">vp</span><span class="p">.</span><span class="n">Width</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">scd</span><span class="p">.</span><span class="n">Width</span><span class="p">);</span>
        <span class="n">vp</span><span class="p">.</span><span class="n">Height</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">scd</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span>
        <span class="n">context</span><span class="o">-&gt;</span><span class="n">RSSetViewports</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vp</span><span class="p">);</span>

        <span class="k">auto</span> <span class="n">clearColor</span> <span class="o">=</span> <span class="n">D2D1</span><span class="o">::</span><span class="n">ColorF</span><span class="p">(</span><span class="n">D2D1</span><span class="o">::</span><span class="n">ColorF</span><span class="o">::</span><span class="n">CornflowerBlue</span><span class="p">);</span>
        <span class="n">context</span><span class="o">-&gt;</span><span class="n">ClearRenderTargetView</span><span class="p">(</span><span class="n">_chainedBufferRTV</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">clearColor</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>

        <span class="n">_spriteBatch</span><span class="o">-&gt;</span><span class="n">Begin</span><span class="p">();</span>

        <span class="n">CRect</span> <span class="n">sourceRect</span><span class="p">,</span> <span class="n">destinationRect</span><span class="p">;</span>

        <span class="n">sourceRect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sourceRect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sourceRect</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">contentSize</span><span class="p">.</span><span class="n">Width</span><span class="p">;</span>
        <span class="n">sourceRect</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">contentSize</span><span class="p">.</span><span class="n">Height</span><span class="p">;</span>

        <span class="n">destinationRect</span> <span class="o">=</span> <span class="n">FitInBox</span><span class="p">(</span>
            <span class="p">{</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">contentSize</span><span class="p">.</span><span class="n">Width</span><span class="p">),</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">contentSize</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span> <span class="p">},</span>
            <span class="p">{</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">scd</span><span class="p">.</span><span class="n">Width</span><span class="p">),</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">scd</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span> <span class="p">});</span>

        <span class="n">_spriteBatch</span><span class="o">-&gt;</span><span class="n">Draw</span><span class="p">(</span><span class="n">frameSurfaceSRV</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">destinationRect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sourceRect</span><span class="p">);</span>

        <span class="n">_spriteBatch</span><span class="o">-&gt;</span><span class="n">End</span><span class="p">();</span>

        <span class="n">DXGI_PRESENT_PARAMETERS</span> <span class="n">pp</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="n">_dxgiSwapChain</span><span class="o">-&gt;</span><span class="n">Present1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pp</span><span class="p">);</span>

        <span class="c1">// Surface のサイズはおそらく FramePool 作成時のバッファサイズ。</span>
        <span class="c1">// CaptureItem のサイズはウィンドウのサイズに追従するので</span>
        <span class="c1">// 差異があるなら FramePool を再作成する</span>
        <span class="k">auto</span> <span class="n">surfaceDesc</span> <span class="o">=</span> <span class="n">frame</span><span class="p">.</span><span class="n">Surface</span><span class="p">().</span><span class="n">Description</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">itemSize</span> <span class="o">=</span> <span class="n">_captureItem</span><span class="p">.</span><span class="n">Size</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">itemSize</span><span class="p">.</span><span class="n">Width</span> <span class="o">!=</span> <span class="n">surfaceDesc</span><span class="p">.</span><span class="n">Width</span> <span class="o">||</span> <span class="n">itemSize</span><span class="p">.</span><span class="n">Height</span> <span class="o">!=</span> <span class="n">surfaceDesc</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// GraphicsCaptureItem::Closed は参照しているウィンドウが破棄されたら</span>
            <span class="c1">// 発行されるイベントかと思ったけどそういうわけでも無さそう…</span>
            <span class="c1">// Size が 0 なら破棄されたと見做すしかないかな？</span>
            <span class="n">SizeInt32</span> <span class="n">size</span><span class="p">;</span>
            <span class="n">size</span><span class="p">.</span><span class="n">Width</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">itemSize</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">size</span><span class="p">.</span><span class="n">Height</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">itemSize</span><span class="p">.</span><span class="n">Height</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">_framePool</span><span class="p">.</span><span class="n">Recreate</span><span class="p">(</span><span class="n">_device</span><span class="p">,</span> <span class="n">DirectXPixelFormat</span><span class="o">::</span><span class="n">B8G8R8A8UIntNormalized</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><code>Capture::Capture(int64_t ownerHwnd)</code> はキャプチャ内容の描画先ウィンドウを引数に取りますが、後述のidlファイルとの関係で <code>int64_t</code> にしてあります（内部では <code>HWND</code> などにキャストして用います）。</p>

<p>先ほどの <code>StartCaptureForPickedWindowAsync</code> について、<code>co_return</code> で値を返すように書くことで、戻り値は <code>IAsyncOperation&lt;T&gt;</code> 型になります。このオブジェクトは前述のように、C#側で <code>Task</code> を介して <code>await</code> することができます。以下に例が載っています。<br>
<a href="https://docs.microsoft.com/ja-jp/windows/uwp/cpp-and-winrt-apis/concurrency#write-a-coroutine" rel="nofollow noopener" target="_blank">C++/WinRT を使用した同時実行操作と非同期操作 - UWP applications | Microsoft Docs</a></p>

<h3>
<span id="captureidl" class="fragment"></span><a href="#captureidl"><i class="fa fa-link"></i></a>Capture.idl</h3>

<p>C#側から見えるインタフェースになります。もともと入っている内容を消して、以下のように書きます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">Capture.idl</span></div>
<div class="highlight"><pre class="with-code"><code>namespace GraphicsCaptureBridge
{
    [default_interface]
    runtimeclass Capture 
    {
        Capture(Int64 ownerHwnd);
        Windows.Foundation.IAsyncOperation&lt;Boolean&gt; StartCaptureForPickedWindowAsync();
        void StopCapture();
        void Resize();
        Boolean IsCapturing();
    }
}
</code></pre></div>
</div>

<p><code>int64_t</code> 型は <code>Int64</code> になり、<code>bool</code> 型は <code>Boolean</code> になります。</p>

<p>ここまで来たら、プロジェクトをビルドしておきましょう。ビルドが通ればC++側はクリアです。</p>

<h1>
<span id="メインプログラム-c" class="fragment"></span><a href="#%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0-c"><i class="fa fa-link"></i></a>メインプログラム (C#)</h1>

<h2>
<span id="プロジェクトの作成-1" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90-1"><i class="fa fa-link"></i></a>プロジェクトの作成</h2>

<p>今あるソリューション <code>GraphicsCaptureCSharp</code> に、新しいプロジェクトを追加します。「Windows フォーム アプリケーション (.NET Framework)」プロジェクトを作ります。「WPF アプリ」でもよいのですが、ウィンドウハンドルを得るのがちょっと面倒なので。</p>

<ul>
<li>プロジェクト名は <code>CapturePreviewCSharp</code>
</li>
<li>フレームワークは .NET Framework 4.7.2 で。</li>
</ul>

<p>このプロジェクト名を右クリック→「スタートアップ プロジェクトに設定」をしておきます。</p>

<h2>
<span id="プラットフォーム設定" class="fragment"></span><a href="#%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>プラットフォーム設定</h2>

<p>まず、ソリューションの構成マネージャから、C#側プロジェクトのプラットフォームを設定します。<code>Any CPU</code> のままだと動きません。32ビット向けの設定はこんな感じで追加します（x64も同様）。<br>
<a href="https://camo.qiitausercontent.com/21043c4c402c70a76f2aca20e1c107b64ee58d0f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f65346134663764302d663439332d616432622d643434632d3439636631663430633539322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2Fe4a4f7d0-f493-ad2b-d44c-49cf1f40c592.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=395e58d7bc135eb4993a9cad3d2942b1" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/e4a4f7d0-f493-ad2b-d44c-49cf1f40c592.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2Fe4a4f7d0-f493-ad2b-d44c-49cf1f40c592.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=bca72139edf046fd8f80924d170ee9fd 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/9ff14bd5bd70563a82d0555f79a7e04654b1c662/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f35383439666165662d643731352d633239612d346461352d3361396262353063353138622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F5849faef-d715-c29a-4da5-3a9bb50c518b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3b744a14d9312528709fcac197b27eea" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/5849faef-d715-c29a-4da5-3a9bb50c518b.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F5849faef-d715-c29a-4da5-3a9bb50c518b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=98d75c161a841d055f36f09fe67731ad 1x" loading="lazy"></a></p>

<h2>
<span id="参照の追加-1" class="fragment"></span><a href="#%E5%8F%82%E7%85%A7%E3%81%AE%E8%BF%BD%E5%8A%A0-1"><i class="fa fa-link"></i></a>参照の追加</h2>

<p>プロジェクトの「参照」を右クリック→「参照の追加」で「参照マネージャ」を開き、画面左側「プロジェクト」を選び、ブリッジライブラリである <code>GraphicsCaptureBridge</code> にチェックを入れます。<br>
また、画面下側の「参照」ボタンから、以下の3ファイルを順に追加します。</p>

<ul>
<li><code>C:\Program Files (x86)\Windows Kits\10\UnionMetadata\10.0.18362.0\Facade\windows.winmd</code></li>
<li><code>C:\Program Files (x86)\Windows Kits\10\References\10.0.18362.0\Windows.Foundation.UniversalApiContract\8.0.0.0\Windows.Foundation.UniversalApiContract.winmd</code></li>
<li><code>C:\Program Files (x86)\Windows Kits\10\References\10.0.18362.0\Windows.Foundation.FoundationContract\3.0.0.0\Windows.Foundation.FoundationContract.winmd</code></li>
</ul>

<h2>
<span id="nugetパッケージの追加" class="fragment"></span><a href="#nuget%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>NuGetパッケージの追加</h2>

<p>次に、プロジェクト名を右クリック→「NuGet パッケージの管理」から以下のパッケージを追加します。<br>
パッケージを追加する時に「Packages.config」か「PackageReference」を選ぶ画面が出たら、<strong>「Packages.config」</strong>にしておきます。</p>

<ul>
<li>Microsoft.VCRTForwarders.140 (v1.0.7)</li>
<li>System.Runtime.WindowsRuntime (v4.7.0)</li>
<li>System.Runtime.WindowsRuntime.UI.Xaml (v4.7.0)</li>
</ul>

<h2>
<span id="uiの作成" class="fragment"></span><a href="#ui%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>UIの作成</h2>

<p><code>Form1</code> に <code>Button</code> と <code>PictureBox</code> を配置します。この <code>PictureBox</code> にキャプチャした画像を描画します。<br>
<a href="https://camo.qiitausercontent.com/9902182c03f9f2bcb7ecdd097b4c6cc7306691c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f39656639313631342d663238642d656139362d643165652d3265326635626263366632642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F9ef91614-f28d-ea96-d1ee-2e2f5bbc6f2d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=73d59f1ae9749ab4fd0bd38a51a0d86d" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/9ef91614-f28d-ea96-d1ee-2e2f5bbc6f2d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F9ef91614-f28d-ea96-d1ee-2e2f5bbc6f2d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=577df80d04616de5e715b9f511514fea 1x" loading="lazy"></a></p>

<p><code>PitureBox</code> の <code>Anchor</code> プロパティに <code>Right</code> と <code>Bottom</code> を追加して、ウィンドウサイズ変更時に自動的にリサイズさせるようにするとよいです。</p>

<h2>
<span id="イベントの実装" class="fragment"></span><a href="#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>イベントの実装</h2>

<p><code>Form1</code> の中身は以下のようになります。コードをコピペする場合は、先にデザイナでイベントハンドラを追加してから行ってください。<br>
コメントにも書いていますが、<code>GraphicsCaptureBridge.Capture(pictureBox1.Handle.ToInt64());</code> はウィンドウハンドルを使うため <code>Load</code> イベントに書いています。コンストラクタに書くと動きません。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">Form1.cs（一部）</span></div>
<div class="highlight"><pre class="with-code"><code>    <span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Form1</span> <span class="p">:</span> <span class="n">Form</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">GraphicsCaptureBridge</span><span class="p">.</span><span class="n">Capture</span> <span class="n">capture</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span> <span class="c1">// この行を追加</span>

        <span class="k">public</span> <span class="nf">Form1</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">InitializeComponent</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">button1_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">capture</span><span class="p">.</span><span class="nf">StartCaptureForPickedWindowAsync</span><span class="p">().</span><span class="nf">AsTask</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Form1_Load</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// コンストラクタの段階ではウィンドウハンドルが生成されていないのでダメ</span>
            <span class="n">capture</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GraphicsCaptureBridge</span><span class="p">.</span><span class="nf">Capture</span><span class="p">(</span><span class="n">pictureBox1</span><span class="p">.</span><span class="n">Handle</span><span class="p">.</span><span class="nf">ToInt64</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Form1_FormClosing</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">FormClosingEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">capture</span><span class="p">?.</span><span class="nf">StopCapture</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">pictureBox1_Resize</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">capture</span><span class="p">?.</span><span class="nf">Resize</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</div>

<h2>
<span id="appmanifest" class="fragment"></span><a href="#appmanifest"><i class="fa fa-link"></i></a>app.manifest</h2>

<p>過去の記事でも書いたのですが、クラスの実装がどのDLLに入っているかを、C#側で明示的に指定しなければなりません。<br>
<a href="https://qiita.com/everylittle/items/cb95b24eb9462ddb3cfc">[C#] C++/WinRTのブリッジを作ってC#から呼び出す方法 - Qiita</a></p>

<p>プロジェクト名を右クリック→「追加」から、「アプリケーション マニフェスト ファイル (Windows のみ)」を追加します。<br>
<a href="https://camo.qiitausercontent.com/1396aa0c278334602a4431399195e6d82985b27d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f32373063653566392d313962342d373166652d653235352d6438353233646531353039302e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F270ce5f9-19b4-71fe-e255-d8523de15090.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=29efb479dda32e59571b5c9ac91b18ad" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/270ce5f9-19b4-71fe-e255-d8523de15090.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F270ce5f9-19b4-71fe-e255-d8523de15090.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4282d6a139215e86ed6af912c4af11d3 1x" loading="lazy"></a></p>

<p>追加した <code>app.manifest</code> の最後の方に以下の記述を追加します。</p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">app.manifest</span></div>
<div class="highlight"><pre class="with-code"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;assembly</span> <span class="na">manifestVersion=</span><span class="s">"1.0"</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:asm.v1"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;assemblyIdentity</span> <span class="na">version=</span><span class="s">"1.0.0.0"</span> <span class="na">name=</span><span class="s">"MyApplication.app"</span><span class="nt">/&gt;</span>
  （略）
  <span class="nt">&lt;file</span> <span class="na">name=</span><span class="s">"GraphicsCaptureBridge.dll"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;activatableClass</span>
      <span class="na">name=</span><span class="s">"GraphicsCaptureBridge.Capture"</span>
      <span class="na">threadingModel=</span><span class="s">"both"</span>
      <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:winrt.v1"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/file&gt;</span>
<span class="nt">&lt;/assembly&gt;</span>
</code></pre></div>
</div>

<h1>
<span id="いざ実行" class="fragment"></span><a href="#%E3%81%84%E3%81%96%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>いざ実行</h1>

<p>C#プロジェクトをF5キーで実行してみましょう。動きましたか？</p>

<h1>
<span id="トラブルシューティング" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>トラブルシューティング</h1>

<p><a href="https://qiita.com/everylittle/items/cb95b24eb9462ddb3cfc#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0" id="reference-f0cd8a6a6aefced7362d">[C#] C++/WinRTのブリッジを作ってC#から呼び出す方法 - Qiita</a> もあわせてご覧ください。</p>

<h2>
<span id="エラー-e0266stdiunknown-があいまいです" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC-e0266stdiunknown-%E3%81%8C%E3%81%82%E3%81%84%E3%81%BE%E3%81%84%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>エラー E0266「"std::IUnknown" があいまいです」</h2>

<p><strong>C#側</strong> プロジェクトに追加すべき参照のどれかが足りないみたいです。IntelliSenseのエラーは <strong>C++側</strong> のエラーとして出るので分かりにくい。</p>

<h2>
<span id="エラー-cs0012型-iasyncoperation-は参照されていないアセンブリに定義されています以下略" class="fragment"></span><a href="#%E3%82%A8%E3%83%A9%E3%83%BC-cs0012%E5%9E%8B-iasyncoperation-%E3%81%AF%E5%8F%82%E7%85%A7%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AA%E3%81%AB%E5%AE%9A%E7%BE%A9%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E4%BB%A5%E4%B8%8B%E7%95%A5"><i class="fa fa-link"></i></a>エラー CS0012「型 'IAsyncOperation&lt;&gt;' は、参照されていないアセンブリに定義されています。（以下略）」</h2>

<p>C#側プロジェクトで、winmdファイルの参照が足りないみたいです。</p>

<h2>
<span id="ウィンドウのキャプチャが取れないことがある" class="fragment"></span><a href="#%E3%82%A6%E3%82%A3%E3%83%B3%E3%83%89%E3%82%A6%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E3%81%8C%E5%8F%96%E3%82%8C%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>ウィンドウのキャプチャが取れないことがある</h2>

<p>最小化されているウィンドウのキャプチャは取ることができません（他ウィンドウの後ろに隠れているだけなら問題なく取れます）。これはAPIの仕様なので、C++で開発している場合も同じ制約を受けます。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Feverylittle%2Fitems%2Fc80de379e644397ceabc&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Feverylittle%2Fitems%2Fc80de379e644397ceabc&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/everylittle/items/c80de379e644397ceabc/likers" class="css-1iupg5d">3</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">3</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/c80de379e644397ceabc/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/everylittle/items/c80de379e644397ceabc/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/everylittle/items/c80de379e644397ceabc/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/everylittle/items/c80de379e644397ceabc/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/everylittle/items/c80de379e644397ceabc.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-00ea0560-ec3c-454f-9fe7-20ce01006916">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-89e092c6-a4ec-4df5-84cd-de20a5e3489d"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-89e092c6-a4ec-4df5-84cd-de20a5e3489d">{}</script>
      
<div id="LoginModal-react-component-74e4f923-628b-4e85-b419-2f5561392ed1"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-74e4f923-628b-4e85-b419-2f5561392ed1">{}</script>
      
<div id="StockModal-react-component-c2f2d5d0-e5e4-4b7b-8a23-833614a6a7c6"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-c2f2d5d0-e5e4-4b7b-8a23-833614a6a7c6">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;x4dkD+/BSy0sVgTfT72SmccmN525XEZiH+ugsU5k4t1OYLUQHPCwA54HNntRRMCQZCPazhXqtVlFaeUdMYDMrw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003eWindows 10のウィンドウキャプチャAPI (\u003ccode\u003eWindows.Graphics.Capture\u003c/code\u003e) を使うと、指定したウィンドウのキャプチャイメージを取得することができます。\u003cbr\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/windows/uwp/audio-video-camera/screen-capture\" rel=\"nofollow noopener\" target=\"_blank\"\u003e画面の取り込み - UWP applications | Microsoft Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e最小化されていない限り、他のウィンドウが上から重なっていたりしても問題なし。こんな感じで。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f0d55302f1aaa9f6785534c52bdfb391a73dceb8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f35623835353130382d316465352d326537612d653238332d3932343161613639333132662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F5b855108-1de5-2e7a-e283-9241aa69312f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=54797a9e5c92149dd47e6298d5bced35\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/5b855108-1de5-2e7a-e283-9241aa69312f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F5b855108-1de5-2e7a-e283-9241aa69312f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a9e4b7bfdf8ab36f32636f7e1e71f004 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eしかしC++からは使えるっぽいけど、C#の方が書きやすいんだよな。\u003cbr\u003e\nUWPアプリだとセットアップが面倒なので、\u003cstrong\u003eデスクトップアプリから使いたい。\u003c/strong\u003e無理なのかな？\u003cbr\u003e\n\u003cstrong\u003eいえいえ、大丈夫。\u003c/strong\u003eこのサンプル、実はC#のデスクトップアプリだよ！（マジで？）\u003c/p\u003e\n\n\u003cp\u003e正確に言えば、WinRTを呼び出すためのラッパーライブラリをC++で書き、C#側から呼び出しています。\u003cbr\u003e\n概要は以前の記事をどうぞ。\u003cbr\u003e\n\u003ca href=\"https://qiita.com/everylittle/items/cb95b24eb9462ddb3cfc\" id=\"reference-f0cd8a6a6aefced7362d\"\u003e[C#] C++/WinRTのブリッジを作ってC#から呼び出す方法 - Qiita\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれを応用して、Windows 10のウィンドウキャプチャAPIをラッパーライブラリ化してみましょう。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"検証環境\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e検証環境\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eWindows 10 Home (20H2)\u003c/li\u003e\n\u003cli\u003eVisual Studio 2019 Community\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eVisual Studio Installerからコンポーネントを追加インストールします。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eワークロード: 以下の3つにチェック\n\n\u003cul\u003e\n\u003cli\u003e.NETデスクトップ開発\u003c/li\u003e\n\u003cli\u003eC++によるデスクトップ開発\u003c/li\u003e\n\u003cli\u003eユニバーサルWindowsプラットフォーム開発\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e個別のコンポーネント\n\n\u003cul\u003e\n\u003cli\u003eWindows 10 SDK (10.0.18362.0以降を1つ以上)\u003c/li\u003e\n\u003cli\u003e（他にもあったかどうか忘れました…）\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eさらに、C++/WinRT開発のためのVSIXをインストールしておきます。\u003cbr\u003e\n\u003ca href=\"https://marketplace.visualstudio.com/items?itemName=CppWinRTTeam.cppwinrt101804264\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC++/WinRT - Visual Studio Marketplace\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"githubにコードを置いています\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#github%E3%81%AB%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E7%BD%AE%E3%81%84%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eGitHubにコードを置いています\u003c/h1\u003e\n\n\u003cp\u003e以下の内容を実行したソースコード一式をGitHubに置いておきます。手っ取り早く動作確認したい方はそちらをどうぞ。\u003cbr\u003e\n\u003ca href=\"https://github.com/build1024/GraphicsCaptureCSharp\" rel=\"nofollow noopener\" target=\"_blank\"\u003ebuild1024/GraphicsCaptureCSharp: Sample of C# project using features of Windows.Graphics.Capture through a C++/WinRT bridge library\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ラッパーライブラリ-cwinrt-の開発\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%A9%E3%83%83%E3%83%91%E3%83%BC%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA-cwinrt-%E3%81%AE%E9%96%8B%E7%99%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eラッパーライブラリ (C++/WinRT) の開発\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"プロジェクトの作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eプロジェクトの作成\u003c/h2\u003e\n\n\u003cp\u003eまずは、Windows Runtime Component (C++/WinRT) プロジェクトを以下の設定で作ります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eプロジェクト名は \u003ccode\u003eGraphicsCaptureBridge\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eソリューション: 新しいソリューションを作成する\u003c/li\u003e\n\u003cli\u003eソリューション名 \u003ccode\u003eGraphicsCaptureCSharp\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eWindowsのターゲットバージョンは1903以降で。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこうなっています。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/8a4d2acf01afdc008aadd84bb13919ee0d2a604a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f31343635633738652d386666642d343731662d373839352d3535653764353361303039612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F1465c78e-8ffd-471f-7895-55e7d53a009a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=a2f1ce4dbc43295fe7e48f833b5872fd\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/1465c78e-8ffd-471f-7895-55e7d53a009a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F1465c78e-8ffd-471f-7895-55e7d53a009a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=35a76450534f8a66026a460729daf040 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eラッパークラスの名前、\u003ccode\u003eClass\u003c/code\u003e ではあんまりなので、\u003ccode\u003eCapture\u003c/code\u003e に変えておきます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/cdc83c6cef6c3dc7ee78a115688fa1143a77731a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f34616163656332382d656161322d303866622d353362302d3232633839306464646235372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F4aacec28-eaa2-08fb-53b0-22c890dddb57.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=415e6aed93604c1b6b4272cfe336ea6c\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/4aacec28-eaa2-08fb-53b0-22c890dddb57.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F4aacec28-eaa2-08fb-53b0-22c890dddb57.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b8f8a1a44f2f80fd97c4ee284b0dc12e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ccode\u003eCapture.idl\u003c/code\u003e, \u003ccode\u003eCapture.cpp\u003c/code\u003e, \u003ccode\u003eCapture.h\u003c/code\u003e の中で、 \u003ccode\u003eClass\u003c/code\u003e と書いてあるところを全部 \u003ccode\u003eCapture\u003c/code\u003e に変えます。\u003ccode\u003eClassT\u003c/code\u003e も \u003ccode\u003eCaptureT\u003c/code\u003e に変えます。\u003cbr\u003e\nそのままプロジェクトをビルドすると \u003ccode\u003eCapture.g.cpp\u003c/code\u003e が見つからない、といったエラーが出ますが、一度Visual Studioを終了し、再度このソリューションを開いて、プロジェクトをリビルドすると成功します。\u003c/p\u003e\n\n\u003cp\u003eさらに、プロジェクトのプロパティ「構成プロパティ」→「C/C++」→「プリプロセッサ」と進み、「プリプロセッサの定義」に以下の2つを追加します（順番も大事です）。これを書かないと後々ハマることになります。DebugとReleaseの両方に追加するのをお忘れなく。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e%(PreprocessorDefinitions)\nWINAPI_FAMILY=WINAPI_FAMILY_DESKTOP_APP\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/0b3e602995d5442dbd0f7ba00469a2b83a9dd6ea/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f63376162343264322d373936652d313164642d366163652d6462393065303863613663332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2Fc7ab42d2-796e-11dd-6ace-db90e08ca6c3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3c1e7169b86ecd6f29a1192393b25ccd\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/c7ab42d2-796e-11dd-6ace-db90e08ca6c3.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2Fc7ab42d2-796e-11dd-6ace-db90e08ca6c3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0c73c2cd5921036001052a2e648db5f3 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"参照の追加\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E7%85%A7%E3%81%AE%E8%BF%BD%E5%8A%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参照の追加\u003c/h2\u003e\n\n\u003cp\u003e必要なパッケージを追加します。\u003cbr\u003e\nプロジェクト名を右クリック→「NuGet パッケージの管理」から以下の2つを追加します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003edirectxtk_desktop_2017 (v2021.1.10.1)\u003c/li\u003e\n\u003cli\u003ewtl (v10.0.10320)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h2\u003e\n\n\u003cp\u003eここからの実装は↓の記事をかなり参考にしています。\u003cbr\u003e\n\u003ca href=\"https://qiita.com/eguo/items/90604787a6098af404d9\" id=\"reference-e179b13abe37067e54b1\"\u003eWindows 10のウィンドウキャプチャAPI - Qiita\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"pchh\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#pchh\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epch.h\u003c/h3\u003e\n\n\u003cp\u003e↓を参考に、実装に必要なヘッダファイルを書いていきます。\u003cbr\u003e\n\u003ca href=\"https://github.com/opysky/examples/blob/master/winrt/GraphicsCapture/CapturePreview/stdafx.h\" rel=\"nofollow noopener\" target=\"_blank\"\u003eexamples/stdafx.h at master · opysky/examples · GitHub\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003epch.h\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#pragma once\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#define NOMINMAX\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include \u0026lt;ppltasks.h\u0026gt;\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include \u0026lt;atlbase.h\u0026gt;\n#include \u0026lt;atlapp.h\u0026gt;\n\u003c/span\u003e\u003cspan class=\"k\"\u003eextern\u003c/span\u003e \u003cspan class=\"n\"\u003eCAppModule\u003c/span\u003e \u003cspan class=\"n\"\u003e_Module\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include \u0026lt;atlwin.h\u0026gt;\n#include \u0026lt;atldlgs.h\u0026gt;\n#include \u0026lt;atlcrack.h\u0026gt;\n#include \u0026lt;atlmisc.h\u0026gt;\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include \u0026lt;winrt/Windows.Foundation.h\u0026gt;\n#include \u0026lt;winrt/Windows.System.h\u0026gt;\n#include \u0026lt;winrt/Windows.Graphics.Capture.h\u0026gt;\n#include \u0026lt;winrt/Windows.Graphics.DirectX.h\u0026gt;\n#include \u0026lt;winrt/Windows.Graphics.DirectX.Direct3d11.h\u0026gt;\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include \u0026lt;shcore.h\u0026gt;\n#include \u0026lt;dwmapi.h\u0026gt;\n#include \u0026lt;DispatcherQueue.h\u0026gt;\n#include \u0026lt;d3d11_4.h\u0026gt;\n#include \u0026lt;dxgi1_6.h\u0026gt;\n#include \u0026lt;d2d1_3.h\u0026gt;\n#include \u0026lt;d2d1_3helper.h\u0026gt;\n#include \u0026lt;windows.ui.composition.interop.h\u0026gt;\n#include \u0026lt;windows.graphics.directx.direct3d11.interop.h\u0026gt;\n#include \u0026lt;Windows.Graphics.Capture.Interop.h\u0026gt;\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include \u0026lt;SpriteBatch.h\u0026gt;\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"direct3dhelperh\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#direct3dhelperh\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDirect3DHelper.h\u003c/h3\u003e\n\n\u003cp\u003e新しくヘッダファイルを追加します。中身は↓のコードをそのまま使います。\u003cbr\u003e\n\u003ca href=\"https://github.com/opysky/examples/blob/master/winrt/GraphicsCapture/CapturePreview/Direct3DHelper.h\" rel=\"nofollow noopener\" target=\"_blank\"\u003eexamples/Direct3DHelper.h at master · opysky/examples · GitHub\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"captureh\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#captureh\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCapture.h\u003c/h3\u003e\n\n\u003cp\u003eベースは↓です。\u003cbr\u003e\n\u003ca href=\"https://github.com/opysky/examples/blob/master/winrt/GraphicsCapture/CapturePreview/CaptureView.h\" rel=\"nofollow noopener\" target=\"_blank\"\u003eexamples/CaptureView.h at master · opysky/examples · GitHub\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eCapture.h\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#pragma once\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include \"Capture.g.h\"\n\u003c/span\u003e\n\u003cspan class=\"n\"\u003eusing\u003c/span\u003e \u003cspan class=\"n\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eusing\u003c/span\u003e \u003cspan class=\"n\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eFoundation\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eusing\u003c/span\u003e \u003cspan class=\"n\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eusing\u003c/span\u003e \u003cspan class=\"n\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eusing\u003c/span\u003e \u003cspan class=\"n\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectX\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eusing\u003c/span\u003e \u003cspan class=\"n\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectX\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eDirect3D11\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eusing\u003c/span\u003e \u003cspan class=\"n\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphicsCaptureBridge\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eimplementation\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eCaptureT\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint64_t\u003c/span\u003e \u003cspan class=\"n\"\u003eownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eIAsyncOperation\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebool\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eStartCaptureForPickedWindowAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eStopCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eResize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eIsCapturing\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_framePool\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003eprivate:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eHRESULT\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eStartCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphicsCaptureItem\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eOnFrameArrived\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDirect3D11CaptureFramePool\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eFoundation\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eIInspectable\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eHWND\u003c/span\u003e \u003cspan class=\"n\"\u003e_ownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectX\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eDirect3D11\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eIDirect3DDevice\u003c/span\u003e \u003cspan class=\"n\"\u003e_device\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003enullptr\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11Device\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_d3dDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIDXGISwapChain1\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_dxgiSwapChain\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11RenderTargetView\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_chainedBufferRTV\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eunique_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;::\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectX\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eSpriteBatch\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_spriteBatch\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eDirect3D11CaptureFramePool\u003c/span\u003e \u003cspan class=\"n\"\u003e_framePool\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003enullptr\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphicsCaptureItem\u003c/span\u003e \u003cspan class=\"n\"\u003e_captureItem\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003enullptr\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphicsCaptureSession\u003c/span\u003e \u003cspan class=\"n\"\u003e_captureSession\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003enullptr\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eDirect3D11CaptureFramePool\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eFrameArrived_revoker\u003c/span\u003e \u003cspan class=\"n\"\u003e_frameArrived\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphicsCaptureBridge\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003efactory_implementation\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eCaptureT\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimplementation\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e元記事では \u003ccode\u003eCWindowImpl\u003c/code\u003e を継承してウィンドウのサブクラスとして実装し、そのウィンドウにキャプチャされた画像が描画されるようになっています。しかしこれではC#から使いにくいので、代わりにキャプチャ出力先のウィンドウハンドルをコンストラクタで受け取るようにします。\u003c/p\u003e\n\n\u003cp\u003eキャプチャ対象のウィンドウ指定について、ピッカーを使用する点は同じですが、\u003ccode\u003eGraphicsCapturePicker\u003c/code\u003e や \u003ccode\u003eGraphicsCaptureItem\u003c/code\u003e オブジェクトをC#側に見せる必要はないので、\u003cstrong\u003e「ピッカーを表示し、選択されたらそのウィンドウに対してキャプチャを開始する」\u003c/strong\u003eというメソッドとして公開します。それが以下の部分です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eIAsyncOperation\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eStartCaptureForPickedWindowAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eIAsyncOperation\u003c/code\u003e 型のオブジェクトは、C#側では \u003ccode\u003e.AsTask()\u003c/code\u003e メソッドで \u003ccode\u003eTask\u003c/code\u003e オブジェクトに変換することにより \u003ccode\u003eawait\u003c/code\u003e で待機できるようになります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/en-us/dotnet/api/system.windowsruntimesystemextensions.astask?view=dotnet-uwp-10.0\u0026amp;preserve-view=true\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWindowsRuntimeSystemExtensions.AsTask Method (System) | Microsoft Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eあとは、ウィンドウサイズの変更時に拡大率を再計算できるように \u003ccode\u003eResize()\u003c/code\u003e メソッドを追加しました（これは今回の本筋からは若干外れます）。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"capturecpp\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#capturecpp\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCapture.cpp\u003c/h3\u003e\n\n\u003cp\u003eクラスの実装です。ベースは↓です。\u003cbr\u003e\n\u003ca href=\"https://github.com/opysky/examples/blob/master/winrt/GraphicsCapture/CapturePreview/CaptureView.cpp\" rel=\"nofollow noopener\" target=\"_blank\"\u003eexamples/CaptureView.cpp at master · opysky/examples · GitHub\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c++\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eCapture.cpp\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#include \"pch.h\"\n#include \"Capture.h\"\n#if __has_include(\"Capture.g.cpp\")\n#include \"Capture.g.cpp\"\n#endif\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include \"Direct3DHelper.h\"\n\u003c/span\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectX\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// Ref: https://github.com/opysky/examples/tree/master/winrt/GraphicsCapture/CapturePreview\u003c/span\u003e\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 今回はキャプチャ対象をPickerで指定するようにする\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eShowWindowPickerAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHWND\u003c/span\u003e \u003cspan class=\"n\"\u003eownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003epicker\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGraphicsCapturePicker\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epicker\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eas\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIInitializeWithWindow\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eInitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003epicker\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePickSingleItemAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eFitInBox\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSize\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSize\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003edestination\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// アスペクト比を保持したままボックスに収まる矩形を計算\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRect\u003c/span\u003e \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edestination\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edestination\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003easpect\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003easpect\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003easpect\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003easpect\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003easpect\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003easpect\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edestination\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edestination\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mf\"\u003e0.5\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eCRect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n            \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n            \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n            \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ebox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphicsCaptureBridge\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eimplementation\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint64_t\u003c/span\u003e \u003cspan class=\"n\"\u003eownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_ownerHwnd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHWND\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eHRESULT\u003c/span\u003e \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eWINRT_VERIFY\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIsWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_device\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateDirect3DDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_d3dDevice\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGetDXGIInterfaceFromObject\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11Device\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_device\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003edxgiDevice\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_d3dDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eas\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIDXGIDevice2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIDXGIAdapter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edxgiAdapter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003echeck_hresult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edxgiDevice\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGetParent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eguid_of\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIDXGIAdapter\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003edxgiAdapter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput_void\u003c/span\u003e\u003cspan class=\"p\"\u003e()));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIDXGIFactory2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edxgiFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003echeck_hresult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edxgiAdapter\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGetParent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eguid_of\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIDXGIFactory2\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003edxgiFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput_void\u003c/span\u003e\u003cspan class=\"p\"\u003e()));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eCRect\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGetWindowRect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eDXGI_SWAP_CHAIN_DESC1\u003c/span\u003e \u003cspan class=\"n\"\u003escd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFormat\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDXGI_FORMAT_B8G8R8A8_UNORM\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBufferUsage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDXGI_USAGE_RENDER_TARGET_OUTPUT\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBufferCount\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSampleDesc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSwapEffect\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDXGI_SWAP_EFFECT_FLIP_SEQUENTIAL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlphaMode\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDXGI_ALPHA_MODE_IGNORE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003echeck_hresult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edxgiFactory\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateSwapChainForHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_d3dDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_ownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e// *this,\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_dxgiSwapChain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e()));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11Texture2D\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003echainedBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003echeck_hresult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_dxgiSwapChain\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eguid_of\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11Texture2D\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003echainedBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput_void\u003c/span\u003e\u003cspan class=\"p\"\u003e()));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003echeck_hresult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_d3dDevice\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateRenderTargetView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echainedBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_chainedBufferRTV\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e()));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11DeviceContext\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_d3dDevice\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGetImmediateContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_spriteBatch\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003emake_unique\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSpriteBatch\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eS_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eStartCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphics\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphicsCaptureItem\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// Direct3D11CaptureFramePool は使いまわせても良さそうな気がするけど\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// GraphicsCaptureSession と一緒に破棄しないとダメっぽ\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eStopCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_captureItem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_framePool\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDirect3D11CaptureFramePool\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_device\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDirectXPixelFormat\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eB8G8R8A8UIntNormalized\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_captureItem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSize\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_frameArrived\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_framePool\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrameArrived\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eauto_revoke\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eOnFrameArrived\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_captureSession\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_framePool\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateCaptureSession\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_captureSession\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStartCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eIAsyncOperation\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eStartCaptureForPickedWindowAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eop\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eShowWindowPickerAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGraphicsCaptureItem\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eco_await\u003c/span\u003e \u003cspan class=\"n\"\u003eop\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003esuccessful\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esuccessful\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eStartCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eco_return\u003c/span\u003e \u003cspan class=\"n\"\u003esuccessful\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eStopCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIsCapturing\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_frameArrived\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erevoke\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003e_captureSession\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 何故か Direct3DCaptureFramePool は Close を手動で呼び出さないと\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 参照カウンタが残ってるというレポートが吐かれる？\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_framePool\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_framePool\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003e_captureItem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eResize\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_dxgiSwapChain\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eCRect\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGetWindowRect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eIsIconic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_chainedBufferRTV\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_dxgiSwapChain\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eResizeBuffers\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eclientRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eDXGI_FORMAT_B8G8R8A8_UNORM\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11Texture2D\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003echainedBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003echeck_hresult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_dxgiSwapChain\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGetBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eguid_of\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11Texture2D\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003echainedBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput_void\u003c/span\u003e\u003cspan class=\"p\"\u003e()));\u003c/span\u003e\n            \u003cspan class=\"n\"\u003echeck_hresult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_d3dDevice\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateRenderTargetView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echainedBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_chainedBufferRTV\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e()));\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eInvalidateRect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ownerHwnd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eCapture\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eOnFrameArrived\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDirect3D11CaptureFramePool\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewinrt\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWindows\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eFoundation\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eIInspectable\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eframe\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTryGetNextFrame\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eframeSurface\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGetDXGIInterfaceFromObject\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11Texture2D\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSurface\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// なんでか知らんが CaptureItem::Size と CaptureFrame::ContentSize が異なる場合が多い\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// レンダリングは ContentSize を基準にするべき\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003econtentSize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContentSize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11ShaderResourceView\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eframeSurfaceSRV\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003echeck_hresult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_d3dDevice\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateShaderResourceView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eframeSurface\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eframeSurfaceSRV\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e()));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ecom_ptr\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eID3D11DeviceContext\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_d3dDevice\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGetImmediateContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eput\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eID3D11RenderTargetView\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003epRTVs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epRTVs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_chainedBufferRTV\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOMSetRenderTargets\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epRTVs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eD3D11_VIEWPORT\u003c/span\u003e \u003cspan class=\"n\"\u003evp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDXGI_SWAP_CHAIN_DESC1\u003c/span\u003e \u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_dxgiSwapChain\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGetDesc1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003evp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003evp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRSSetViewports\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003evp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eclearColor\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eD2D1\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eColorF\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eD2D1\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eColorF\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCornflowerBlue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eClearRenderTargetView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_chainedBufferRTV\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eclearColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_spriteBatch\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBegin\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eCRect\u003c/span\u003e \u003cspan class=\"n\"\u003esourceRect\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edestinationRect\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003esourceRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eleft\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esourceRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etop\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esourceRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eright\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econtentSize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esourceRect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebottom\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econtentSize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003edestinationRect\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eFitInBox\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtentSize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtentSize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"k\"\u003estatic_cast\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003escd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_spriteBatch\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDraw\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eframeSurfaceSRV\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003edestinationRect\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esourceRect\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_spriteBatch\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eEnd\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eDXGI_PRESENT_PARAMETERS\u003c/span\u003e \u003cspan class=\"n\"\u003epp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_dxgiSwapChain\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePresent1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// Surface のサイズはおそらく FramePool 作成時のバッファサイズ。\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// CaptureItem のサイズはウィンドウのサイズに追従するので\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 差異があるなら FramePool を再作成する\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003esurfaceDesc\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSurface\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eDescription\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eitemSize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_captureItem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitemSize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003esurfaceDesc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eitemSize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003esurfaceDesc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// GraphicsCaptureItem::Closed は参照しているウィンドウが破棄されたら\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 発行されるイベントかと思ったけどそういうわけでも無さそう…\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// Size が 0 なら破棄されたと見做すしかないかな？\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eSizeInt32\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitemSize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitemSize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_framePool\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRecreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_device\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eDirectXPixelFormat\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eB8G8R8A8UIntNormalized\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eCapture::Capture(int64_t ownerHwnd)\u003c/code\u003e はキャプチャ内容の描画先ウィンドウを引数に取りますが、後述のidlファイルとの関係で \u003ccode\u003eint64_t\u003c/code\u003e にしてあります（内部では \u003ccode\u003eHWND\u003c/code\u003e などにキャストして用います）。\u003c/p\u003e\n\n\u003cp\u003e先ほどの \u003ccode\u003eStartCaptureForPickedWindowAsync\u003c/code\u003e について、\u003ccode\u003eco_return\u003c/code\u003e で値を返すように書くことで、戻り値は \u003ccode\u003eIAsyncOperation\u0026lt;T\u0026gt;\u003c/code\u003e 型になります。このオブジェクトは前述のように、C#側で \u003ccode\u003eTask\u003c/code\u003e を介して \u003ccode\u003eawait\u003c/code\u003e することができます。以下に例が載っています。\u003cbr\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/windows/uwp/cpp-and-winrt-apis/concurrency#write-a-coroutine\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC++/WinRT を使用した同時実行操作と非同期操作 - UWP applications | Microsoft Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"captureidl\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#captureidl\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCapture.idl\u003c/h3\u003e\n\n\u003cp\u003eC#側から見えるインタフェースになります。もともと入っている内容を消して、以下のように書きます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eCapture.idl\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003enamespace GraphicsCaptureBridge\n{\n    [default_interface]\n    runtimeclass Capture \n    {\n        Capture(Int64 ownerHwnd);\n        Windows.Foundation.IAsyncOperation\u0026lt;Boolean\u0026gt; StartCaptureForPickedWindowAsync();\n        void StopCapture();\n        void Resize();\n        Boolean IsCapturing();\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eint64_t\u003c/code\u003e 型は \u003ccode\u003eInt64\u003c/code\u003e になり、\u003ccode\u003ebool\u003c/code\u003e 型は \u003ccode\u003eBoolean\u003c/code\u003e になります。\u003c/p\u003e\n\n\u003cp\u003eここまで来たら、プロジェクトをビルドしておきましょう。ビルドが通ればC++側はクリアです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"メインプログラム-c\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0-c\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eメインプログラム (C#)\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"プロジェクトの作成-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eプロジェクトの作成\u003c/h2\u003e\n\n\u003cp\u003e今あるソリューション \u003ccode\u003eGraphicsCaptureCSharp\u003c/code\u003e に、新しいプロジェクトを追加します。「Windows フォーム アプリケーション (.NET Framework)」プロジェクトを作ります。「WPF アプリ」でもよいのですが、ウィンドウハンドルを得るのがちょっと面倒なので。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eプロジェクト名は \u003ccode\u003eCapturePreviewCSharp\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eフレームワークは .NET Framework 4.7.2 で。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこのプロジェクト名を右クリック→「スタートアップ プロジェクトに設定」をしておきます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"プラットフォーム設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eプラットフォーム設定\u003c/h2\u003e\n\n\u003cp\u003eまず、ソリューションの構成マネージャから、C#側プロジェクトのプラットフォームを設定します。\u003ccode\u003eAny CPU\u003c/code\u003e のままだと動きません。32ビット向けの設定はこんな感じで追加します（x64も同様）。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/21043c4c402c70a76f2aca20e1c107b64ee58d0f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f65346134663764302d663439332d616432622d643434632d3439636631663430633539322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2Fe4a4f7d0-f493-ad2b-d44c-49cf1f40c592.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=395e58d7bc135eb4993a9cad3d2942b1\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/e4a4f7d0-f493-ad2b-d44c-49cf1f40c592.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2Fe4a4f7d0-f493-ad2b-d44c-49cf1f40c592.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=bca72139edf046fd8f80924d170ee9fd 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/9ff14bd5bd70563a82d0555f79a7e04654b1c662/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f35383439666165662d643731352d633239612d346461352d3361396262353063353138622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F5849faef-d715-c29a-4da5-3a9bb50c518b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3b744a14d9312528709fcac197b27eea\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/5849faef-d715-c29a-4da5-3a9bb50c518b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F5849faef-d715-c29a-4da5-3a9bb50c518b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=98d75c161a841d055f36f09fe67731ad 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"参照の追加-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E7%85%A7%E3%81%AE%E8%BF%BD%E5%8A%A0-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参照の追加\u003c/h2\u003e\n\n\u003cp\u003eプロジェクトの「参照」を右クリック→「参照の追加」で「参照マネージャ」を開き、画面左側「プロジェクト」を選び、ブリッジライブラリである \u003ccode\u003eGraphicsCaptureBridge\u003c/code\u003e にチェックを入れます。\u003cbr\u003e\nまた、画面下側の「参照」ボタンから、以下の3ファイルを順に追加します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eC:\\Program Files (x86)\\Windows Kits\\10\\UnionMetadata\\10.0.18362.0\\Facade\\windows.winmd\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eC:\\Program Files (x86)\\Windows Kits\\10\\References\\10.0.18362.0\\Windows.Foundation.UniversalApiContract\\8.0.0.0\\Windows.Foundation.UniversalApiContract.winmd\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eC:\\Program Files (x86)\\Windows Kits\\10\\References\\10.0.18362.0\\Windows.Foundation.FoundationContract\\3.0.0.0\\Windows.Foundation.FoundationContract.winmd\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"nugetパッケージの追加\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#nuget%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%BF%BD%E5%8A%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNuGetパッケージの追加\u003c/h2\u003e\n\n\u003cp\u003e次に、プロジェクト名を右クリック→「NuGet パッケージの管理」から以下のパッケージを追加します。\u003cbr\u003e\nパッケージを追加する時に「Packages.config」か「PackageReference」を選ぶ画面が出たら、\u003cstrong\u003e「Packages.config」\u003c/strong\u003eにしておきます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eMicrosoft.VCRTForwarders.140 (v1.0.7)\u003c/li\u003e\n\u003cli\u003eSystem.Runtime.WindowsRuntime (v4.7.0)\u003c/li\u003e\n\u003cli\u003eSystem.Runtime.WindowsRuntime.UI.Xaml (v4.7.0)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"uiの作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ui%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUIの作成\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eForm1\u003c/code\u003e に \u003ccode\u003eButton\u003c/code\u003e と \u003ccode\u003ePictureBox\u003c/code\u003e を配置します。この \u003ccode\u003ePictureBox\u003c/code\u003e にキャプチャした画像を描画します。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/9902182c03f9f2bcb7ecdd097b4c6cc7306691c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f39656639313631342d663238642d656139362d643165652d3265326635626263366632642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F9ef91614-f28d-ea96-d1ee-2e2f5bbc6f2d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=73d59f1ae9749ab4fd0bd38a51a0d86d\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/9ef91614-f28d-ea96-d1ee-2e2f5bbc6f2d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F9ef91614-f28d-ea96-d1ee-2e2f5bbc6f2d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=577df80d04616de5e715b9f511514fea 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ePitureBox\u003c/code\u003e の \u003ccode\u003eAnchor\u003c/code\u003e プロパティに \u003ccode\u003eRight\u003c/code\u003e と \u003ccode\u003eBottom\u003c/code\u003e を追加して、ウィンドウサイズ変更時に自動的にリサイズさせるようにするとよいです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"イベントの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eイベントの実装\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eForm1\u003c/code\u003e の中身は以下のようになります。コードをコピペする場合は、先にデザイナでイベントハンドラを追加してから行ってください。\u003cbr\u003e\nコメントにも書いていますが、\u003ccode\u003eGraphicsCaptureBridge.Capture(pictureBox1.Handle.ToInt64());\u003c/code\u003e はウィンドウハンドルを使うため \u003ccode\u003eLoad\u003c/code\u003e イベントに書いています。コンストラクタに書くと動きません。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eForm1.cs（一部）\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eForm1\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eForm\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eGraphicsCaptureBridge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCapture\u003c/span\u003e \u003cspan class=\"n\"\u003ecapture\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// この行を追加\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eForm1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eInitializeComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003ebutton1_Click\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ecapture\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartCaptureForPickedWindowAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eAsTask\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eForm1_Load\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// コンストラクタの段階ではウィンドウハンドルが生成されていないのでダメ\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecapture\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eGraphicsCaptureBridge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epictureBox1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt64\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eForm1_FormClosing\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFormClosingEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecapture\u003c/span\u003e\u003cspan class=\"p\"\u003e?.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStopCapture\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003epictureBox1_Resize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecapture\u003c/span\u003e\u003cspan class=\"p\"\u003e?.\u003c/span\u003e\u003cspan class=\"nf\"\u003eResize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"appmanifest\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#appmanifest\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eapp.manifest\u003c/h2\u003e\n\n\u003cp\u003e過去の記事でも書いたのですが、クラスの実装がどのDLLに入っているかを、C#側で明示的に指定しなければなりません。\u003cbr\u003e\n\u003ca href=\"https://qiita.com/everylittle/items/cb95b24eb9462ddb3cfc\"\u003e[C#] C++/WinRTのブリッジを作ってC#から呼び出す方法 - Qiita\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eプロジェクト名を右クリック→「追加」から、「アプリケーション マニフェスト ファイル (Windows のみ)」を追加します。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/1396aa0c278334602a4431399195e6d82985b27d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3230343038342f32373063653566392d313962342d373166652d653235352d6438353233646531353039302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F270ce5f9-19b4-71fe-e255-d8523de15090.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=29efb479dda32e59571b5c9ac91b18ad\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/204084/270ce5f9-19b4-71fe-e255-d8523de15090.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F204084%2F270ce5f9-19b4-71fe-e255-d8523de15090.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=4282d6a139215e86ed6af912c4af11d3 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e追加した \u003ccode\u003eapp.manifest\u003c/code\u003e の最後の方に以下の記述を追加します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eapp.manifest\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?xml version=\"1.0\" encoding=\"utf-8\"?\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;assembly\u003c/span\u003e \u003cspan class=\"na\"\u003emanifestVersion=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"1.0\"\u003c/span\u003e \u003cspan class=\"na\"\u003exmlns=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"urn:schemas-microsoft-com:asm.v1\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;assemblyIdentity\u003c/span\u003e \u003cspan class=\"na\"\u003eversion=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"1.0.0.0\"\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"MyApplication.app\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n  （略）\n  \u003cspan class=\"nt\"\u003e\u0026lt;file\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"GraphicsCaptureBridge.dll\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;activatableClass\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"GraphicsCaptureBridge.Capture\"\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ethreadingModel=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"both\"\u003c/span\u003e\n      \u003cspan class=\"na\"\u003exmlns=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"urn:schemas-microsoft-com:winrt.v1\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;/file\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/assembly\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"いざ実行\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%84%E3%81%96%E5%AE%9F%E8%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eいざ実行\u003c/h1\u003e\n\n\u003cp\u003eC#プロジェクトをF5キーで実行してみましょう。動きましたか？\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"トラブルシューティング\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eトラブルシューティング\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/everylittle/items/cb95b24eb9462ddb3cfc#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0\" id=\"reference-f0cd8a6a6aefced7362d\"\u003e[C#] C++/WinRTのブリッジを作ってC#から呼び出す方法 - Qiita\u003c/a\u003e もあわせてご覧ください。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"エラー-e0266stdiunknown-があいまいです\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A8%E3%83%A9%E3%83%BC-e0266stdiunknown-%E3%81%8C%E3%81%82%E3%81%84%E3%81%BE%E3%81%84%E3%81%A7%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eエラー E0266「\"std::IUnknown\" があいまいです」\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003eC#側\u003c/strong\u003e プロジェクトに追加すべき参照のどれかが足りないみたいです。IntelliSenseのエラーは \u003cstrong\u003eC++側\u003c/strong\u003e のエラーとして出るので分かりにくい。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"エラー-cs0012型-iasyncoperation-は参照されていないアセンブリに定義されています以下略\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A8%E3%83%A9%E3%83%BC-cs0012%E5%9E%8B-iasyncoperation-%E3%81%AF%E5%8F%82%E7%85%A7%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AA%E3%81%AB%E5%AE%9A%E7%BE%A9%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E4%BB%A5%E4%B8%8B%E7%95%A5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eエラー CS0012「型 'IAsyncOperation\u0026lt;\u0026gt;' は、参照されていないアセンブリに定義されています。（以下略）」\u003c/h2\u003e\n\n\u003cp\u003eC#側プロジェクトで、winmdファイルの参照が足りないみたいです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ウィンドウのキャプチャが取れないことがある\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A6%E3%82%A3%E3%83%B3%E3%83%89%E3%82%A6%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E3%81%8C%E5%8F%96%E3%82%8C%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eウィンドウのキャプチャが取れないことがある\u003c/h2\u003e\n\n\u003cp\u003e最小化されているウィンドウのキャプチャは取ることができません（他ウィンドウの後ろに隠れているだけなら問題なく取れます）。これはAPIの仕様なので、C++で開発している場合も同じ制約を受けます。\u003c/p\u003e\n","createdAt":"2021-03-13T09:44:38Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"Uifhm42+zL2XbohFVV1GU3vxZ0hee5jsXA==--Mzk4MHVlpZ9F8PpW--wp1awB3/+VNCmO5h7gLdHg==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-03-13T12:08:58Z","likesCount":3,"linkUrl":"https://qiita.com/everylittle/items/c80de379e644397ceabc","organization":null,"originalId":1405683,"stockedCount":3,"title":"Windows 10のウィンドウキャプチャAPIをC#のデスクトップアプリから呼び出す","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A4%9C%E8%A8%BC%E7%92%B0%E5%A2%83\"\u003e検証環境\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#github%E3%81%AB%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E7%BD%AE%E3%81%84%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99\"\u003eGitHubにコードを置いています\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%A9%E3%83%83%E3%83%91%E3%83%BC%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA-cwinrt-%E3%81%AE%E9%96%8B%E7%99%BA\"\u003eラッパーライブラリ (C++/WinRT) の開発\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90\"\u003eプロジェクトの作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E7%85%A7%E3%81%AE%E8%BF%BD%E5%8A%A0\"\u003e参照の追加\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#pchh\"\u003epch.h\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#direct3dhelperh\"\u003eDirect3DHelper.h\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#captureh\"\u003eCapture.h\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#capturecpp\"\u003eCapture.cpp\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#captureidl\"\u003eCapture.idl\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0-c\"\u003eメインプログラム (C#)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90-1\"\u003eプロジェクトの作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E8%A8%AD%E5%AE%9A\"\u003eプラットフォーム設定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E7%85%A7%E3%81%AE%E8%BF%BD%E5%8A%A0-1\"\u003e参照の追加\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#nuget%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%BF%BD%E5%8A%A0\"\u003eNuGetパッケージの追加\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ui%E3%81%AE%E4%BD%9C%E6%88%90\"\u003eUIの作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eイベントの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#appmanifest\"\u003eapp.manifest\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%84%E3%81%96%E5%AE%9F%E8%A1%8C\"\u003eいざ実行\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0\"\u003eトラブルシューティング\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A8%E3%83%A9%E3%83%BC-e0266stdiunknown-%E3%81%8C%E3%81%82%E3%81%84%E3%81%BE%E3%81%84%E3%81%A7%E3%81%99\"\u003eエラー E0266「\"std::IUnknown\" があいまいです」\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A8%E3%83%A9%E3%83%BC-cs0012%E5%9E%8B-iasyncoperation-%E3%81%AF%E5%8F%82%E7%85%A7%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%AA%E3%81%84%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AA%E3%81%AB%E5%AE%9A%E7%BE%A9%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%81%BE%E3%81%99%E4%BB%A5%E4%B8%8B%E7%95%A5\"\u003eエラー CS0012「型 'IAsyncOperation\u0026lt;\u0026gt;' は、参照されていないアセンブリに定義されています。（以下略）」\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A6%E3%82%A3%E3%83%B3%E3%83%89%E3%82%A6%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E3%81%8C%E5%8F%96%E3%82%8C%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B\"\u003eウィンドウのキャプチャが取れないことがある\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":1982,"uuid":"c80de379e644397ceabc","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"XIKGHfBmBbi2jDMkM9/9uMK8kHTp--JuiD5W9dKP2nLHWL--IpfEppwsdRly28OjNlC7Kg==","originalId":204084,"description":"PythonやWebプログラミングなどのTipsをメモ代わりに投稿しています。たまに機械学習の話題もあります。","facebookUrl":null,"githubUrl":"https://github.com/build1024","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/204084/profile-images/1544604030","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F204084%2Fprofile-images%2F1544604030?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=09d12ee189ba32bac935afcf9b8ca435","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F204084%2Fprofile-images%2F1544604030?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=ca805aa914ba8d1c5bf5ab7a497a739f","urlName":"everylittle","websiteUrl":"https://www.every-little.com/","twitterUrl":"https://twitter.com/hira_elt","twitterUrlName":"hira_elt","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C++","urlName":"cpp"},{"name":"C#","urlName":"csharp"},{"name":"WinRT","urlName":"winrt"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
