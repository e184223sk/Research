<!DOCTYPE html><html><head><meta charset="utf-8" /><title>FIDO2セキュリティキーで電子署名をする試み - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/gebo/items/0a08bc0e1aea6bc12c96" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="QrJa/MO1m0gFHs6W1Bjuxl+HCjU0TQQBZOdyCC8lIH3myWtKDF4QB7kIumcbNavnz7n0/LKtVtEFW6/JIZB4Dw==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@gebogebogeboge" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="FIDO2セキュリティキーで電子署名をする試み - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1Sa2xFVHpMamdydmpncTNqZzZYamc2cmpnNGJqZ3FQamdxM2pnN3pqZ2FmcG03dmxyWkRudmJMbGtJM2pncExqZ1puamdvdm9xYWJqZ2I4JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPWM3ZDQ1YWEzZGRjYzIwOWJlY2Y0YTNhNWRlMTk0OGYw&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2RsWW04JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9ZTBmMDZhMGJmNmUzYjI2ZmZlMzllOGNhMzkzZDI0ZGQ&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=4214a5558d3b31a7ccd01fc0e210b3a2"><meta property="og:description" content="

はじめに

世界のパスワード問題を解決し、パスワードのない世界 を目指して策定されたFIDO規格。
FIDO2のWebAuthn-JavaScriptを各社のウェブブラウザが実装したことでWeb認証はもはやFIDOがスタンダードで..."><meta content="https://qiita.com/gebo/items/0a08bc0e1aea6bc12c96" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,電子署名,FIDO,CTAP" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-bd3069a3-e342-4a67-a799-eba48f035799"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fgebo%2Fitems%2F0a08bc0e1aea6bc12c96">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fgebo%2Fitems%2F0a08bc0e1aea6bc12c96">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-bd3069a3-e342-4a67-a799-eba48f035799">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-03-02T16:03:17.000+09:00","dateModified":"2020-05-24T20:42:45.000+09:00","headline":"FIDO2セキュリティキーで電子署名をする試み","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1Sa2xFVHpMamdydmpncTNqZzZYamc2cmpnNGJqZ3FQamdxM2pnN3pqZ2FmcG03dmxyWkRudmJMbGtJM2pncExqZ1puamdvdm9xYWJqZ2I4JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPWM3ZDQ1YWEzZGRjYzIwOWJlY2Y0YTNhNWRlMTk0OGYw\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2RsWW04JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9ZTBmMDZhMGJmNmUzYjI2ZmZlMzllOGNhMzkzZDI0ZGQ\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=4214a5558d3b31a7ccd01fc0e210b3a2","mainEntityOfPage":"https://qiita.com/gebo/items/0a08bc0e1aea6bc12c96","author":{"@type":"Person","address":"","email":null,"identifier":"gebo","name":"gebo","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F252291%2F259049ef3da2854c57fc30166d776b5ac272df00%2Fx_large.png%3F1614046902?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=5099eac7ef4c965d458c7a95649b4f8d","url":"https://qiita.com/gebo","description":"認証,認可,FIDO,CTAP,NFC,BLE,c,c++,c#,Rust,ねこのげぼく","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"gebo","type":"items","id":"0a08bc0e1aea6bc12c96"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"gebo","type":"items","id":"0a08bc0e1aea6bc12c96"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"gebo","type":"items","id":"0a08bc0e1aea6bc12c96"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/gebo/items/0a08bc0e1aea6bc12c96","location":"/gebo/items/0a08bc0e1aea6bc12c96","scheme":"https","host":"qiita.com","port":null,"pathname":"/gebo/items/0a08bc0e1aea6bc12c96","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"u6DUxlM63l+uXfMf5aA2vmA7Rl8x8YnyVoxofSuW1c8f2+VwnNFVEBJLh+4qjXOf8AW4lrcR2yI3MLW8JSONvQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-59f130e7-e44a-4f1b-b53c-874c5322c844"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/gebo/items/0a08bc0e1aea6bc12c96/likers" class="css-1iupg5d">13</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">13</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/0a08bc0e1aea6bc12c96/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/gebo/items/0a08bc0e1aea6bc12c96/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/gebo/items/0a08bc0e1aea6bc12c96/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/gebo/items/0a08bc0e1aea6bc12c96/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/gebo/items/0a08bc0e1aea6bc12c96.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/gebo"><img class="css-100alwu eyfquo10" src="https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/252291/259049ef3da2854c57fc30166d776b5ac272df00/x_large.png?1614046902" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/gebo" class="css-10ougpm">@<!-- -->gebo</a><div class="css-1ay9vb9"><span><meta content="2019-03-02T07:03:17Z"/><time dateTime="2020-05-24T11:42:45Z" class="css-m19uds">updated at 2020-05-24</time></span></div></div></div></div></div><h1 class="css-cgzq40">FIDO2セキュリティキーで電子署名をする試み</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/%e9%9b%bb%e5%ad%90%e7%bd%b2%e5%90%8d" class="css-4czcte">電子署名</a><a href="/tags/fido" class="css-4czcte">FIDO</a><a href="/tags/ctap" class="css-4czcte">CTAP</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>世界のパスワード問題を解決し、パスワードのない世界 を目指して策定されたFIDO規格。<br>
FIDO2のWebAuthn-JavaScriptを各社のウェブブラウザが実装したことでWeb認証はもはやFIDOがスタンダードです。<br>
FIDO2のセキュリティキーは 堅牢 かつ パスワードがいらないシンプルな操作 でログインすることができます。</p>

<p>一方で　デジタルガバメント を目指して策定されたGPKI、JPKI。<br>
マイナンバーカードは券面に個人情報印刷しまくりで、人に見せてはいけない、という意味不明のアナウンスで絶賛普及推進中。<br>
・・・何やっても全く普及せず、ひたすら残念な状況のマイナンバーカードですが、ICカードの中の仕組みはちゃんとしていて、認証だけでなく<code>電子署名</code>の機能も備えています。つまりログインだけでなく、電子文書へのデジタル署名（電子的な実印）を作成することができます。カード中の秘密鍵はセキュアに保護されており、外に出すことのできる公開鍵はスキャンされても問題ない、マイナンバーカードの機能は携帯する個人認証デバイスとしてはとってもいいものなのです。</p>

<p>こうやって見ると</p>

<table>
<thead>
<tr>
<th style="text-align: center">デバイス</th>
<th style="text-align: center">認証</th>
<th style="text-align: center">電子署名</th>
<th style="text-align: center">状況</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">FIDO2セキュリティーキー</td>
<td style="text-align: center">〇</td>
<td style="text-align: center"></td>
<td style="text-align: center">イケイケ</td>
</tr>
<tr>
<td style="text-align: center">マイナンバーカード</td>
<td style="text-align: center">〇</td>
<td style="text-align: center">〇</td>
<td style="text-align: center">残念</td>
</tr>
</tbody>
</table>

<p><strong>FIDO2セキュリティキーで電子署名ができれば最強では。</strong></p>

<p>というわけで、この投稿ではFIDO2セキュリティキーで電子署名をする、というツッコミどころ満載な試みにトライしてみました。</p>

<h1>
<span id="環境" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>環境</h1>

<p>要はFIDO2セキュリティキーを使った電子署名のプログラムを作成する、ということです。<br>
セキュリティキーは指紋スキャナの付いたBioPassを使いますが、BioPassでないといけない、ということはありません。YubikeyなどFIDO2のAuthenticatorであればOKです。</p>

<p><a href="https://camo.qiitausercontent.com/310d068bc58812dc2410fab0fa83bc7f6d80e67c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3235323239312f65333639393730642d353439302d353466632d343037382d6662326638623038366131352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fe369970d-5490-54fc-4078-fb2f8b086a15.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=15641aeac76278a10c30aeba7e1efa4e" width="60%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/252291/e369970d-5490-54fc-4078-fb2f8b086a15.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fe369970d-5490-54fc-4078-fb2f8b086a15.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=9a2f1cdafeef4a98d4b79cc8ee8a579d 1x" loading="lazy"></a></p>

<p>OSはWindows、言語はC#、暗号化ライブラリはBouncy Castle、セキュリティキーの制御はWebAuthnModokiDesktopを使います。</p>

<ul>
<li>FIDO2セキュリティキー <a href="https://www.ftsafe.com/Products/FIDO2" rel="nofollow noopener" target="_blank">BioPass</a>
</li>
<li>Windows10 1809</li>
<li>.Net Framework 4.6.1</li>
<li>Visual Studio 2017 C#</li>
<li><a href="https://www.bouncycastle.org/csharp/index.html" rel="nofollow noopener" target="_blank">Bouncy Castle 1.8.5</a></li>
<li><a href="https://github.com/gebogebogebo/WebAuthnModokiDesktop" rel="nofollow noopener" target="_blank">WebAuthnModokiDesktop</a></li>
<li>ソース <a href="https://github.com/gebogebogebo/GeboSig" rel="nofollow noopener" target="_blank">GitHub</a>
</li>
</ul>

<h1>
<span id="ユースケース" class="fragment"></span><a href="#%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>ユースケース</h1>

<p>おおざっぱに以下の構成です。</p>

<p>Phase<br>
- Administrator-Register<br>
- User-Register<br>
- Signature<br>
- Veriy</p>

<p>Actor<br>
- システム管理者<br>
- ユーザー<br>
- マネージャ</p>

<p><a href="https://camo.qiitausercontent.com/bcdd48e52cf0ea888bb44e9f87522adfd81ebf06/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3235323239312f38353132643535372d383831382d313137632d366463342d3635316265356465323537632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2F8512d557-8818-117c-6dc4-651be5de257c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=81133a35f64ec444502a503c77998c22" alt="01.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/252291/8512d557-8818-117c-6dc4-651be5de257c.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2F8512d557-8818-117c-6dc4-651be5de257c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3d9a7213aeee530a74d88b498462b841 1x" loading="lazy"></a></p>

<hr>

<p>株式会社GEBOは三文判による紙の社内文書の運用から電子署名運用に切り替えました。という体で。<br>
- システム管理者＝社内システム担当：下暮田<br>
- ユーザー＝新入社員：ゲボ子<br>
- マネージャ＝ゲボ子の上司：毛保川</p>

<h1>
<span id="administrator-register" class="fragment"></span><a href="#administrator-register"><i class="fa fa-link"></i></a>◆Administrator-Register</h1>

<p>情報処理室の社内システム担当：下暮田さんは本日入社する社員のゲボ子さんに渡すセキュリティキーを作成します。<br>
セキュリティキー(BioPass）は新品のものを使いますが、念のために初期化しておきましょう。<br>
初期化はBio Pass FIDO2 Managerというメーカー提供のツールでリセットしておきます。(Microsoft StoreからGETできます）<br>
<a href="https://camo.qiitausercontent.com/b55280e4190b49c376cfb0f5e9fb5e9c349dd27a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3235323239312f64393336303866372d313434652d356335302d636633382d3839393330633962333931642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fd93608f7-144e-5c50-cf38-89930c9b391d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7ac2c0084db266511513fedeb0a99c88" width="50%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/252291/d93608f7-144e-5c50-cf38-89930c9b391d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fd93608f7-144e-5c50-cf38-89930c9b391d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d917fbf40eab209425e9298275f779e0 1x" loading="lazy"></a></p>

<p>登録は<a href="https://github.com/gebogebogebo/GeboSig/tree/master/Source/GeboSigRegister" rel="nofollow noopener" target="_blank">GeboSigRegister</a>というアプリで行います。</p>

<h3>
<span id="登録アプリ処理" class="fragment"></span><a href="#%E7%99%BB%E9%8C%B2%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>登録アプリ処理</h3>

<ul>
<li>RSA1024キーペア生成</li>
<li>秘密鍵をPEM形式でGET</li>
<li>PEM形式の秘密鍵をDER形式に変換する</li>
<li>DER形式の秘密鍵をAES256で暗号化する</li>
<li>セキュリティキーにPINを設定する</li>
<li>セキュリティキーに秘密鍵を書き込む</li>
<li>証明書を作成する</li>
</ul>

<h4>
<span id="rsa1024キーペア生成" class="fragment"></span><a href="#rsa1024%E3%82%AD%E3%83%BC%E3%83%9A%E3%82%A2%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>RSA1024キーペア生成</h4>

<p>RSA-1024bitキーペアを生成します。<br>
Bouncy CastleのAPIを使います。<br>
※Bouncy Castleはusingの追加がたくさん必要なので、Alt+Enterでどんどん追加していきましょう。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">RSA-1024bitキーペアを生成</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="n">AsymmetricCipherKeyPair</span> <span class="nf">createKeyPair</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">randGen</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CryptoApiRandomGenerator</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">rand</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SecureRandom</span><span class="p">(</span><span class="n">randGen</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">param</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">KeyGenerationParameters</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="m">1024</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">keyGen</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RsaKeyPairGenerator</span><span class="p">();</span>
    <span class="n">keyGen</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">keyPair</span> <span class="p">=</span> <span class="n">keyGen</span><span class="p">.</span><span class="nf">GenerateKeyPair</span><span class="p">();</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">keyPair</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="秘密鍵をpem形式でget" class="fragment"></span><a href="#%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92pem%E5%BD%A2%E5%BC%8F%E3%81%A7get"><i class="fa fa-link"></i></a>秘密鍵をPEM形式でGET</h4>

<p>Bouncy CastleのPemWriterを使えば簡単です。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">秘密鍵をPEM形式でGET</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="kt">string</span> <span class="nf">getPrivatekyPEM</span><span class="p">(</span><span class="n">AsymmetricCipherKeyPair</span> <span class="n">keyPair</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">mem</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">();</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">writer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamWriter</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">pemWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PemWriter</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
        <span class="n">pemWriter</span><span class="p">.</span><span class="nf">WriteObject</span><span class="p">(</span><span class="n">keyPair</span><span class="p">.</span><span class="n">Private</span><span class="p">);</span>
        <span class="n">pemWriter</span><span class="p">.</span><span class="n">Writer</span><span class="p">.</span><span class="nf">Flush</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kt">var</span> <span class="n">pem</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">());</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">pem</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="pem形式の秘密鍵をder形式に変換する" class="fragment"></span><a href="#pem%E5%BD%A2%E5%BC%8F%E3%81%AE%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92der%E5%BD%A2%E5%BC%8F%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>PEM形式の秘密鍵をDER形式に変換する</h4>

<p>少しでもサイズを小さくしたいのでDERにします。これはBouncy CastleのAPIが見つからず、定番の方法(?)でやります。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">PEMからDERにする</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">ConvertPEMtoDER</span><span class="p">(</span><span class="kt">string</span> <span class="n">pem</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">pems</span> <span class="p">=</span> <span class="n">pem</span><span class="p">.</span><span class="nf">Trim</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">).</span><span class="nf">Split</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>

    <span class="c1">// ヘッダとフッダは飛ばす</span>
    <span class="n">pems</span><span class="p">.</span><span class="nf">RemoveAt</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
    <span class="n">pems</span><span class="p">.</span><span class="nf">RemoveAt</span><span class="p">(</span><span class="n">pems</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>

    <span class="c1">// つなげる</span>
    <span class="kt">var</span> <span class="n">base64</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">pems</span><span class="p">);</span>

    <span class="c1">// もどす</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">FromBase64String</span><span class="p">(</span><span class="n">base64</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="der形式の秘密鍵をaes256で暗号化する" class="fragment"></span><a href="#der%E5%BD%A2%E5%BC%8F%E3%81%AE%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92aes256%E3%81%A7%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>DER形式の秘密鍵をAES256で暗号化する</h4>

<p>Bouncy Castleを使います。<br>
こちらの素晴らしいサンプルをコピペさせていただきました<br>
<a href="https://kagasu.hatenablog.com/entry/2017/01/04/213533" class="autolink" rel="nofollow noopener" target="_blank">https://kagasu.hatenablog.com/entry/2017/01/04/213533</a></p>

<p>keyとivは普通はオープンにしてはいけませんよ。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">AES256</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">// inDataがDER形式の秘密鍵です</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">Encrypt</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">inData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">key</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"ygmh8zudlw5u0a9w4vc29whc4b8wuech"</span><span class="p">);</span>
    <span class="n">iv</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span> <span class="s">"o10wi1q3x2f98cobfkyisnwy9s9wxop7"</span><span class="p">);</span>

    <span class="c1">// Rijndael</span>
    <span class="c1">// Mode = CBC</span>
    <span class="c1">// BlockSize = 256bit</span>
    <span class="c1">// PaddingMode = Zero</span>
    <span class="kt">var</span> <span class="n">cbcBlockCipher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CbcBlockCipher</span><span class="p">(</span><span class="k">new</span> <span class="nf">RijndaelEngine</span><span class="p">(</span><span class="m">256</span><span class="p">));</span>
    <span class="n">cipher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PaddedBufferedBlockCipher</span><span class="p">(</span><span class="n">cbcBlockCipher</span><span class="p">,</span> <span class="k">new</span> <span class="nf">ZeroBytePadding</span><span class="p">());</span>
    <span class="n">parametersWithIV</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ParametersWithIV</span><span class="p">(</span><span class="k">new</span> <span class="nf">KeyParameter</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">iv</span><span class="p">);</span>

    <span class="n">cipher</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="n">parametersWithIV</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">cipher</span><span class="p">.</span><span class="nf">GetOutputSize</span><span class="p">(</span><span class="n">inData</span><span class="p">.</span><span class="n">Length</span><span class="p">)];</span>
    <span class="kt">var</span> <span class="n">length</span> <span class="p">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">ProcessBytes</span><span class="p">(</span><span class="n">inData</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="n">cipher</span><span class="p">.</span><span class="nf">DoFinal</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="セキュリティキーにpinを設定する" class="fragment"></span><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%AD%E3%83%BC%E3%81%ABpin%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>セキュリティキーにPINを設定する</h4>

<p>初期PINをセットします。<br>
USBにセキュリティキーを挿してから、WebAuthnModokiDesktopのAPIで一発です。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">PIN設定</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">// PINは1234</span>
<span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">setNewPIN</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">status</span> <span class="p">=</span> <span class="k">await</span> <span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">WebAuthnModokiDesktop</span><span class="p">.</span><span class="n">Credentials</span><span class="p">.</span><span class="nf">SetPin</span><span class="p">(</span><span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">DevParam</span><span class="p">.</span><span class="nf">GetDefaultParams</span><span class="p">(),</span> <span class="s">"1234"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">status</span><span class="p">.</span><span class="n">isSuccess</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Error</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div>
</div>

<h4>
<span id="セキュリティキーに秘密鍵を書き込む" class="fragment"></span><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%AD%E3%83%BC%E3%81%AB%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>セキュリティキーに秘密鍵を書き込む</h4>

<p>さて、登録のヤマ場です。<br>
FIDO2セキュリティキーにどうやって秘密鍵を書き込むのか、ですが、ResidentKeyの機能を利用します。<br>
<strong>ResidentKeyはRPのユーザー情報を書き込むための機能で、秘密鍵などというものを書き込むための機能ではありません。</strong> なのですが、やってみましょう。</p>

<p><strong>※注意※</strong><br>
<strong>この制限はFIDOとかCTAPの仕様によるものではないと思われますので、モノによってこの通りでないと思われます。</strong></p>

<p>実際に試したところ、1回で書き込める情報は以下の通りでした。<br>
- UserID領域に64byte（byte型）<br>
- UserName領域に64文字（string型）<br>
- DisplayName領域に64文字（string型）</p>

<p>これ以上のデータを書き込もうするとエラーになります。</p>

<p>string型は1byteを2文字のHEXにすればいいか、ということで、64byte+32byte(64文字)+32byte(64文字)の合計128byteを1回で書き込むことができます。<br>
でありますため、何回かに分けて書き込むことにします。</p>

<p>1回に書き込むデータを1レコードとして、レコードの構造は以下の通り。</p>

<table>
<thead>
<tr>
<th style="text-align: center">Area</th>
<th style="text-align: center">DataType</th>
<th style="text-align: center">Size</th>
<th style="text-align: left">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">UserID領域</td>
<td style="text-align: center">レコードNo</td>
<td style="text-align: center">1byte</td>
<td style="text-align: left">0から始まるレコード番号</td>
</tr>
<tr>
<td style="text-align: center">UserID領域</td>
<td style="text-align: center">予備</td>
<td style="text-align: center">1byte</td>
<td style="text-align: left">0xFF固定</td>
</tr>
<tr>
<td style="text-align: center">UserID領域</td>
<td style="text-align: center">データ</td>
<td style="text-align: center">62byte</td>
<td style="text-align: left">書き込むデータ</td>
</tr>
<tr>
<td style="text-align: center">UserName領域</td>
<td style="text-align: center">データ</td>
<td style="text-align: center">64文字</td>
<td style="text-align: left">32byteのデータをHEX64文字にする</td>
</tr>
<tr>
<td style="text-align: center">DisplayName領域</td>
<td style="text-align: center">データ</td>
<td style="text-align: center">64文字</td>
<td style="text-align: left">32byteのデータをHEX64文字にする</td>
</tr>
</tbody>
</table>

<p>先ほど作成した秘密鍵(AES256で暗号化したもの）は640byteでした。<br>
これだと6レコードになります。<br>
6回に分けて書き込みます。</p>

<p>書き込み自体はWebAuthnModokiDesktopのAPIを使えば簡単です。<br>
- 引数pinはさっき設定した初期PINを指定します。<br>
- 引数recは<a href="https://github.com/gebogebogebo/GeboSig/blob/master/Source/GeboSigCommon/WriteData.cs" rel="nofollow noopener" target="_blank">こんなかんじ</a><br>
- BioBassだと1回の書き込みにつきUser Presenceのチェックが走るのでキーがピカピカ光ってタッチが必要です、つまり、6回タッチしないいけないです。<br>
- これがNFCタイプ(例えばYubikey5）だとUser Presenceがされないのでいちいちタッチする必要がなく快適です。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">1レコードの書き込み</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">writeRec</span><span class="p">(</span><span class="kt">string</span> <span class="n">pin</span><span class="p">,</span><span class="n">WriteData</span> <span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">challenge</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"this is challenge"</span><span class="p">);</span>

            <span class="kt">byte</span><span class="p">[]</span> <span class="n">userid</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[]</span> <span class="p">{</span> <span class="n">rec</span><span class="p">.</span><span class="n">recno</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">filler</span> <span class="p">};</span>
            <span class="n">userid</span> <span class="p">=</span> <span class="n">userid</span><span class="p">.</span><span class="nf">ToList</span><span class="p">().</span><span class="nf">Concat</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">data1</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">();</span>

            <span class="kt">string</span> <span class="n">username</span> <span class="p">=</span> <span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">data2</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">?</span> <span class="s">""</span> <span class="p">:</span> <span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="nf">BytesToHexString</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">data2</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">userdisplayname</span> <span class="p">=</span> <span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">data3</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">?</span> <span class="s">""</span> <span class="p">:</span> <span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">Common</span><span class="p">.</span><span class="nf">BytesToHexString</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">data3</span><span class="p">);</span>

            <span class="kt">string</span> <span class="n">json</span> <span class="p">=</span>
                    <span class="s">"{"</span> <span class="p">+</span>
                        <span class="s">@"rp : {"</span> <span class="p">+</span>
                            <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"id : 'GeboSig.gebo.com',"</span><span class="p">)</span> <span class="p">+</span>
                        <span class="s">@"},"</span> <span class="p">+</span>
                        <span class="s">@"user : {"</span> <span class="p">+</span>
                            <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"id_bytearray:[</span><span class="p">{</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">","</span><span class="p">,</span> <span class="n">userid</span><span class="p">)}</span><span class="s">],"</span><span class="p">)</span> <span class="p">+</span>
                            <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"name :'</span><span class="p">{</span><span class="n">username</span><span class="p">}</span><span class="s">',"</span><span class="p">)</span> <span class="p">+</span>
                            <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"displayName :'</span><span class="p">{</span><span class="n">userdisplayname</span><span class="p">}</span><span class="s">',"</span><span class="p">)</span> <span class="p">+</span>
                        <span class="s">@"},"</span> <span class="p">+</span>
                        <span class="s">@"pubKeyCredParams: [{type: 'public-key',alg: -7}],"</span> <span class="p">+</span>
                        <span class="s">@"attestation: 'direct',"</span> <span class="p">+</span>
                        <span class="s">@"timeout: 60000,"</span> <span class="p">+</span>
                        <span class="s">@"authenticatorSelection : {"</span> <span class="p">+</span>
                            <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"requireResidentKey : true,"</span><span class="p">)</span> <span class="p">+</span>
                            <span class="s">@"authenticatorAttachment : 'cross-platform',"</span> <span class="p">+</span>
                            <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"userVerification : 'discouraged'"</span><span class="p">)</span> <span class="p">+</span>
                        <span class="s">@"},"</span> <span class="p">+</span>
                        <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"challenge:[</span><span class="p">{</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">","</span><span class="p">,</span> <span class="n">challenge</span><span class="p">)}</span><span class="s">],"</span><span class="p">)</span> <span class="p">+</span>
                    <span class="s">"}"</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">ret</span> <span class="p">=</span> <span class="k">await</span> <span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">WebAuthnModokiDesktop</span><span class="p">.</span><span class="n">Credentials</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">DevParam</span><span class="p">.</span><span class="nf">GetDefaultParams</span><span class="p">(),</span> <span class="n">json</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">isSuccess</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">.</span><span class="n">msg</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">"Success"</span><span class="p">);</span>
        <span class="p">});</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">result</span> <span class="p">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>

    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div>
</div>

<h4>
<span id="証明書を作成する" class="fragment"></span><a href="#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>証明書を作成する</h4>

<p>最後に秘密鍵のペアとなる公開鍵の処理です。<br>
公開鍵のままでも別にいいんですけど、せっかくなので(?)X.509形式の証明書にしておきましょう。<br>
Bouncy CastleのAPIなら簡単です。<br>
※自己署名なんで、証明書の意味はないです。<br>
- 証明書のCNには対象者のゲボ子さんの情報を入れておきます。<br>
- 証明書は本日より10年間有効です。<br>
- 証明書に今作成したキーペアの公開鍵を格納し、自分自身の秘密鍵で署名します。<br>
- 証明書はPEM形式で作成します。<br>
- 作成した証明書は保管しておきます。本ユースケースでは社内のRepositoryで保管することにします。</p>

<div class="code-frame" data-lang="CS"><div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="kt">string</span> <span class="nf">createCertificate</span><span class="p">(</span><span class="n">AsymmetricCipherKeyPair</span> <span class="n">keyPair</span><span class="p">)</span>
<span class="p">{</span>

    <span class="c1">// 証明書の属性</span>
    <span class="kt">var</span> <span class="n">attr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">DerObjectIdentifier</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="p">{</span> <span class="n">X509Name</span><span class="p">.</span><span class="n">CN</span><span class="p">,</span> <span class="n">geboko@gebo</span><span class="p">.</span><span class="n">com</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">X509Name</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="s">"Japan"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">X509Name</span><span class="p">.</span><span class="n">ST</span><span class="p">,</span> <span class="s">"None"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">X509Name</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="s">"None"</span> <span class="p">}</span>
        <span class="p">{</span> <span class="n">X509Name</span><span class="p">.</span><span class="n">O</span><span class="p">,</span> <span class="s">"gebo"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">X509Name</span><span class="p">.</span><span class="n">OU</span><span class="p">,</span> <span class="s">"None"</span> <span class="p">},</span>
    <span class="p">};</span>
    <span class="kt">var</span> <span class="n">ord</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DerObjectIdentifier</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="n">X509Name</span><span class="p">.</span><span class="n">CN</span><span class="p">,</span>
        <span class="n">X509Name</span><span class="p">.</span><span class="n">C</span><span class="p">,</span>
        <span class="n">X509Name</span><span class="p">.</span><span class="n">ST</span><span class="p">,</span>
        <span class="n">X509Name</span><span class="p">.</span><span class="n">L</span><span class="p">,</span>
        <span class="n">X509Name</span><span class="p">.</span><span class="n">O</span><span class="p">,</span>
        <span class="n">X509Name</span><span class="p">.</span><span class="n">OU</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="c1">// 証明書の生成</span>
    <span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509Name</span><span class="p">(</span><span class="n">ord</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">certGen</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509V3CertificateGenerator</span><span class="p">();</span>
    <span class="n">certGen</span><span class="p">.</span><span class="nf">SetSerialNumber</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">.</span><span class="n">One</span><span class="p">);</span>
    <span class="n">certGen</span><span class="p">.</span><span class="nf">SetIssuerDN</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="n">certGen</span><span class="p">.</span><span class="nf">SetSubjectDN</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="n">certGen</span><span class="p">.</span><span class="nf">SetNotBefore</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
    <span class="n">certGen</span><span class="p">.</span><span class="nf">SetNotAfter</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">AddYears</span><span class="p">(</span><span class="m">10</span><span class="p">));</span>
    <span class="n">certGen</span><span class="p">.</span><span class="nf">SetPublicKey</span><span class="p">(</span><span class="n">keyPair</span><span class="p">.</span><span class="n">Public</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">cert</span> <span class="p">=</span> <span class="n">certGen</span><span class="p">.</span><span class="nf">Generate</span><span class="p">(</span><span class="k">new</span> <span class="nf">Asn1SignatureFactory</span><span class="p">(</span><span class="n">PkcsObjectIdentifiers</span><span class="p">.</span><span class="n">Sha256WithRsaEncryption</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">keyPair</span><span class="p">.</span><span class="n">Private</span><span class="p">));</span>

    <span class="c1">// 証明書の出力</span>
    <span class="kt">var</span> <span class="n">mem</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">();</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">writer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamWriter</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">pemWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PemWriter</span><span class="p">(</span><span class="n">writer</span><span class="p">);</span>
        <span class="n">pemWriter</span><span class="p">.</span><span class="nf">WriteObject</span><span class="p">(</span><span class="n">cert</span><span class="p">);</span>
        <span class="n">pemWriter</span><span class="p">.</span><span class="n">Writer</span><span class="p">.</span><span class="nf">Flush</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kt">var</span> <span class="n">pem</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">());</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">pem</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="登録後の運用" class="fragment"></span><a href="#%E7%99%BB%E9%8C%B2%E5%BE%8C%E3%81%AE%E9%81%8B%E7%94%A8"><i class="fa fa-link"></i></a>登録後の運用</h3>

<p>下暮田さんの作業です。<br>
- 生成されたゲボ子さん用の証明書(geboko.crt）は社内のRepositoryにしまいます。<br>
- 初期化が済んだセキュリティキーをゲボ子さんに渡します。</p>

<hr>

<h1>
<span id="user-register" class="fragment"></span><a href="#user-register"><i class="fa fa-link"></i></a>◆User-Register</h1>

<p>システム管理者：下暮田さんから自分用のセキュリティキーを受け取ったゲボ子さんは自分用の初期設定をします。<br>
- PINの変更<br>
- 指紋登録</p>

<p>PINの変更は<a href="https://github.com/gebogebogebo/GeboSig/tree/master/Source/GeboSigChangePIN" rel="nofollow noopener" target="_blank">GeboSigChangePIN</a>というアプリで行います。</p>

<h3>
<span id="pin変更アプリ処理" class="fragment"></span><a href="#pin%E5%A4%89%E6%9B%B4%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>PIN変更アプリ処理</h3>

<p>WebAuthnMODOKIDesktopのAPIで一発です。</p>

<div class="code-frame" data-lang="CS"><div class="highlight"><pre class="with-code"><code><span class="c1">// newpin=新しいPIN、currentpin=現在のPIN</span>
<span class="kt">var</span> <span class="n">devParam</span> <span class="p">=</span> <span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">DevParam</span><span class="p">.</span><span class="nf">GetDefaultParams</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">ret</span> <span class="p">=</span> <span class="k">await</span> <span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">WebAuthnModokiDesktop</span><span class="p">.</span><span class="n">Credentials</span><span class="p">.</span><span class="nf">ChangePin</span><span class="p">(</span><span class="n">devParam</span><span class="p">,</span> <span class="n">newpin</span><span class="p">,</span> <span class="n">currentpin</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">isSuccess</span> <span class="p">==</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// OK</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// NG</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="指紋登録" class="fragment"></span><a href="#%E6%8C%87%E7%B4%8B%E7%99%BB%E9%8C%B2"><i class="fa fa-link"></i></a>指紋登録</h3>

<p>指紋登録はBio Pass FIDO2 Managerというメーカー提供のツールで行います。(Microsoft StoreからGETできます）<br>
<a href="https://camo.qiitausercontent.com/b55280e4190b49c376cfb0f5e9fb5e9c349dd27a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3235323239312f64393336303866372d313434652d356335302d636633382d3839393330633962333931642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fd93608f7-144e-5c50-cf38-89930c9b391d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7ac2c0084db266511513fedeb0a99c88" width="50%" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/252291/d93608f7-144e-5c50-cf38-89930c9b391d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fd93608f7-144e-5c50-cf38-89930c9b391d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d917fbf40eab209425e9298275f779e0 1x" loading="lazy"></a></p>

<p>これでこのセキュリティキーのPINを知っているのはゲボ子さんだけす。指紋もゲボ子さんのものを登録しているので、<strong>セキュリティキーを使えるのはゲボ子さんだけ、ということになります</strong>。</p>

<hr>

<h1>
<span id="signature" class="fragment"></span><a href="#signature"><i class="fa fa-link"></i></a>◆Signature</h1>

<p>ここからが通常運用です。<br>
ゲボ子さんは社内用の報告書を作成しました。上司に電子署名付きのファイル（報告書）を送ります。</p>

<p>署名は<a href="https://github.com/gebogebogebo/GeboSig/tree/master/Source/GeboSigSignature" rel="nofollow noopener" target="_blank">GeboSigSignature</a>というアプリで行います。</p>

<h3>
<span id="署名アプリ処理" class="fragment"></span><a href="#%E7%BD%B2%E5%90%8D%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>署名アプリ処理</h3>

<ul>
<li>暗号化された秘密鍵を取り出す</li>
<li>復号する</li>
<li>復号データからパディングデータを除去する</li>
<li>DERからPEMに変換する</li>
<li>電子署名を作成する</li>
<li>署名の付いた文書を作成する</li>
</ul>

<h4>
<span id="暗号化された秘密鍵を取り出す" class="fragment"></span><a href="#%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%95%E3%82%8C%E3%81%9F%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92%E5%8F%96%E3%82%8A%E5%87%BA%E3%81%99"><i class="fa fa-link"></i></a>暗号化された秘密鍵を取り出す</h4>

<p>セキュリティキーの中から(暗号化された)秘密鍵を取り出します。<br>
<strong>セキュリティキーのアクセスはUV-指紋認証です。つまり ゲボ子さん本人 しかアクセスできません。</strong><br>
非常用でPINでのアクセスもできるようにしとかないといけないですが、PINも本人しか知らないはずです。</p>

<p>秘密鍵はセキュリティキーの中に複数レコードに分割して書き込みました。<br>
セキュリティキーからレコード情報を取りだすのはWebAuthnModokiDesktopのAPIで一発です。<br>
取り出したデータのUserID、UserName、DisplayNameを格納時と逆の方法でつなぎ合わせてbyte配列にします。<br>
- 戻り値ReadDataは<a href="https://github.com/gebogebogebo/GeboSig/blob/master/Source/GeboSigSignature/ReadData.cs" rel="nofollow noopener" target="_blank">こんなかんじ</a><br>
- credentialid は使わないので空です。<br>
- 指紋認証なのでuserVerification : 'preferred'にします</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">データ取り出し</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ReadData</span><span class="p">&gt;</span> <span class="nf">readRecs</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ReadData</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ReadData</span><span class="p">&gt;.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">readData</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ReadData</span><span class="p">();</span>

            <span class="kt">byte</span><span class="p">[]</span> <span class="n">challenge</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"this is challenge"</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">credentialid</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>

            <span class="kt">string</span> <span class="n">json</span> <span class="p">=</span>
               <span class="s">"{"</span> <span class="p">+</span>
                    <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"timeout : 60000,"</span><span class="p">)</span> <span class="p">+</span>
                    <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"challenge:[</span><span class="p">{</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">","</span><span class="p">,</span> <span class="n">challenge</span><span class="p">)}</span><span class="s">],"</span><span class="p">)</span> <span class="p">+</span>
                    <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"rpId : 'GeboSig.gebo.com',"</span><span class="p">)</span> <span class="p">+</span>
                   <span class="s">@"allowCredentials : [{"</span> <span class="p">+</span>
                       <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"id : [</span><span class="p">{</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">","</span><span class="p">,</span> <span class="n">credentialid</span><span class="p">)}</span><span class="s">],"</span><span class="p">)</span> <span class="p">+</span>
                       <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"type : 'public-key',"</span><span class="p">)</span> <span class="p">+</span>
                   <span class="s">@"}],"</span> <span class="p">+</span>
                   <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"requireUserPresence : 'false',"</span><span class="p">)</span> <span class="p">+</span>
                   <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">$"userVerification : 'preferred',"</span><span class="p">)</span> <span class="p">+</span>
                <span class="s">"}"</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">ret</span> <span class="p">=</span> <span class="k">await</span> <span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">WebAuthnModokiDesktop</span><span class="p">.</span><span class="n">Credentials</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">gebo</span><span class="p">.</span><span class="n">CTAP2</span><span class="p">.</span><span class="n">DevParam</span><span class="p">.</span><span class="nf">GetDefaultParams</span><span class="p">(),</span> <span class="n">json</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">isSuccess</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">readData</span><span class="p">.</span><span class="n">isSuccess</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="n">readData</span><span class="p">.</span><span class="n">msg</span> <span class="p">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">msg</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">readData</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// dataList</span>
            <span class="kt">var</span> <span class="n">dataList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">WriteData</span><span class="p">&gt;();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">assertion</span> <span class="k">in</span> <span class="n">ret</span><span class="p">.</span><span class="n">assertions</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">dataList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">WriteData</span><span class="p">(</span><span class="n">assertion</span><span class="p">.</span><span class="n">User_Id</span><span class="p">,</span> <span class="n">assertion</span><span class="p">.</span><span class="n">User_Name</span><span class="p">,</span> <span class="n">assertion</span><span class="p">.</span><span class="n">User_DisplayName</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="n">dataList</span> <span class="p">=</span> <span class="n">dataList</span><span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">recno</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>

            <span class="c1">// data</span>
            <span class="n">readData</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">data</span> <span class="k">in</span> <span class="n">dataList</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">var</span> <span class="n">tmp</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="n">data1</span><span class="p">.</span><span class="nf">ToList</span><span class="p">().</span><span class="nf">Concat</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data2</span><span class="p">).</span><span class="nf">Concat</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data3</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>
                <span class="n">readData</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="n">readData</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nf">ToList</span><span class="p">().</span><span class="nf">Concat</span><span class="p">(</span><span class="n">tmp</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">readData</span><span class="p">.</span><span class="n">isSuccess</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">readData</span><span class="p">.</span><span class="n">msg</span> <span class="p">=</span> <span class="s">"Success"</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">readData</span><span class="p">;</span>
        <span class="p">});</span>

    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>

    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div>
</div>

<h4>
<span id="復号する" class="fragment"></span><a href="#%E5%BE%A9%E5%8F%B7%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>復号する</h4>

<p>さて、取り出した秘密鍵はAES256で暗号化されているので復号します。<br>
復号するときのkeyとivは暗号化するときと同じものを指定しましょう。</p>

<p>keyとivは普通はオープンにしてはいけませんよ。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">復号する</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">// inDataが暗号化されているデータです</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">Decrypt</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">inData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// AES-256</span>
    <span class="n">key</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">"ygmh8zudlw5u0a9w4vc29whc4b8wuech"</span><span class="p">);</span>
    <span class="n">iv</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span> <span class="s">"o10wi1q3x2f98cobfkyisnwy9s9wxop7"</span><span class="p">);</span>

    <span class="c1">// Rijndael</span>
    <span class="c1">// Mode = CBC</span>
    <span class="c1">// BlockSize = 256bit</span>
    <span class="c1">// PaddingMode = Zero</span>
    <span class="kt">var</span> <span class="n">cbcBlockCipher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CbcBlockCipher</span><span class="p">(</span><span class="k">new</span> <span class="nf">RijndaelEngine</span><span class="p">(</span><span class="m">256</span><span class="p">));</span>
    <span class="n">cipher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PaddedBufferedBlockCipher</span><span class="p">(</span><span class="n">cbcBlockCipher</span><span class="p">,</span> <span class="k">new</span> <span class="nf">ZeroBytePadding</span><span class="p">());</span>
    <span class="n">parametersWithIV</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ParametersWithIV</span><span class="p">(</span><span class="k">new</span> <span class="nf">KeyParameter</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">iv</span><span class="p">);</span>

    <span class="n">cipher</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="n">parametersWithIV</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">cipher</span><span class="p">.</span><span class="nf">GetOutputSize</span><span class="p">(</span><span class="n">inData</span><span class="p">.</span><span class="n">Length</span><span class="p">)];</span>
    <span class="kt">var</span> <span class="n">length</span> <span class="p">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">ProcessBytes</span><span class="p">(</span><span class="n">inData</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">ret</span> <span class="p">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">DoFinal</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="復号データからパディングデータを除去する" class="fragment"></span><a href="#%E5%BE%A9%E5%8F%B7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8B%E3%82%89%E3%83%91%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E9%99%A4%E5%8E%BB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>復号データからパディングデータを除去する</h4>

<p>ここが今一つわからなかったのですが、AESの復号ではパティングデータが付いたままでモドされるようです。PaddingMode = Zeroなので後ろに0x00が何個かひっついてきます。<br>
これがあると非常に具合が悪いので除去します。<br>
幸いなことにDERは先頭SEQにデータレングスがあるので、その情報をもとにパディングデータをとっぱらいます。<br>
これでちゃんとしたDERになります。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">パディングデータを除去する</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">getPrivateKey</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">decData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">decData</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">!=</span> <span class="m">0x30</span><span class="p">){</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">null</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">decData</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">!=</span> <span class="m">0x82</span><span class="p">){</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">null</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">datasize</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ChangeEndian</span><span class="p">.</span><span class="nf">Reverse</span><span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToUInt16</span><span class="p">(</span><span class="n">decData</span><span class="p">,</span> <span class="m">2</span><span class="p">));</span>

    <span class="c1">// add header-4byte</span>
    <span class="n">datasize</span> <span class="p">=</span> <span class="n">datasize</span> <span class="p">+</span> <span class="m">4</span><span class="p">;</span>

    <span class="k">return</span><span class="p">(</span><span class="n">decData</span><span class="p">.</span><span class="nf">ToList</span><span class="p">().</span><span class="nf">Take</span><span class="p">(</span><span class="n">datasize</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="derからpemに変換する" class="fragment"></span><a href="#der%E3%81%8B%E3%82%89pem%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>DERからPEMに変換する</h4>

<p>さてさて、Bouncy Castleで署名するためにPEMにしないといけないです。<br>
<em>めんどくさいなぁ、Bouncy CastleってほんとにDERつかえないのかなぁ</em></p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">DERからPEMに変換する</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">// 1.Base64エンコード</span>
<span class="c1">// 2.64文字ごとに改行コードをいれる</span>
<span class="c1">// 3.ヘッダとフッタを入れる</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ConvertPrivateKeyDERtoPEM</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">der</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">pemdata</span> <span class="p">=</span> <span class="s">"-----BEGIN RSA PRIVATE KEY-----\n"</span> <span class="p">+</span> <span class="nf">ConvertDERtoPEM</span><span class="p">(</span><span class="n">der</span><span class="p">)</span> <span class="p">+</span> <span class="s">"-----END RSA PRIVATE KEY-----\n"</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">pemdata</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ConvertDERtoPEM</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">der</span><span class="p">)</span>
<span class="p">{</span>

    <span class="kt">var</span> <span class="n">b64cert</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToBase64String</span><span class="p">(</span><span class="n">der</span><span class="p">);</span>

    <span class="kt">string</span> <span class="n">pemdata</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">roopcount</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Ceiling</span><span class="p">(</span><span class="n">b64cert</span><span class="p">.</span><span class="n">Length</span> <span class="p">/</span> <span class="m">64.0f</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">intIc</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">intIc</span> <span class="p">&lt;</span> <span class="n">roopcount</span><span class="p">;</span> <span class="n">intIc</span><span class="p">++)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">start</span> <span class="p">=</span> <span class="m">64</span> <span class="p">*</span> <span class="n">intIc</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">intIc</span> <span class="p">==</span> <span class="n">roopcount</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pemdata</span> <span class="p">=</span> <span class="n">pemdata</span> <span class="p">+</span> <span class="n">b64cert</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">+</span> <span class="s">"\n"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">pemdata</span> <span class="p">=</span> <span class="n">pemdata</span> <span class="p">+</span> <span class="n">b64cert</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="m">64</span><span class="p">)</span> <span class="p">+</span> <span class="s">"\n"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">pemdata</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div>
</div>

<h4>
<span id="電子署名を作成する" class="fragment"></span><a href="#%E9%9B%BB%E5%AD%90%E7%BD%B2%E5%90%8D%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>電子署名を作成する</h4>

<p>ついにこのときが来ました。ファイルの署名を作成します。<br>
Bouncy Castleで署名を作成します。<br>
なにやら色々手順がありますが、思考停止のおまじないということで。<br>
- pemPrivateKeyはPEM形式の秘密鍵。<br>
- targetfilepathは署名対象のファイルのパスとファイル名です。<br>
- ReadAllBytesしているんでファイルを一回全部取り込むっぽいです。巨大なファイルだとヤバいです。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">電子署名を作成する！</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">createSign</span><span class="p">(</span><span class="kt">string</span> <span class="n">pemPrivateKey</span><span class="p">,</span> <span class="kt">string</span> <span class="n">targetfilepath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="nf">ReadAllBytes</span><span class="p">(</span><span class="n">targetfilepath</span><span class="p">);</span>

    <span class="c1">// PEMフォーマットの秘密鍵を読み込んで KeyPair オブジェクトを生成</span>
    <span class="kt">var</span> <span class="n">privateKeyReader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PemReader</span><span class="p">(</span><span class="k">new</span> <span class="nf">StringReader</span><span class="p">(</span><span class="n">pemPrivateKey</span><span class="p">));</span>
    <span class="kt">var</span> <span class="n">keyPair</span> <span class="p">=</span> <span class="p">(</span><span class="n">AsymmetricCipherKeyPair</span><span class="p">)</span><span class="n">privateKeyReader</span><span class="p">.</span><span class="nf">ReadObject</span><span class="p">();</span>

    <span class="n">RsaKeyParameters</span> <span class="n">key</span> <span class="p">=</span> <span class="p">(</span><span class="n">RsaKeyParameters</span><span class="p">)</span><span class="n">keyPair</span><span class="p">.</span><span class="n">Private</span><span class="p">;</span>
    <span class="n">ISigner</span> <span class="n">sig</span> <span class="p">=</span> <span class="n">SignerUtilities</span><span class="p">.</span><span class="nf">GetSigner</span><span class="p">(</span><span class="s">"SHA1withRSA"</span><span class="p">);</span>
    <span class="n">sig</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">sig</span><span class="p">.</span><span class="nf">BlockUpdate</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">bytes</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">signature</span> <span class="p">=</span> <span class="n">sig</span><span class="p">.</span><span class="nf">GenerateSignature</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">signature</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="署名の付いた文書を作成する" class="fragment"></span><a href="#%E7%BD%B2%E5%90%8D%E3%81%AE%E4%BB%98%E3%81%84%E3%81%9F%E6%96%87%E6%9B%B8%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>署名の付いた文書を作成する</h4>

<p>ターゲットファイルと署名を一つのzipにして固めてデスクトップに吐き出すだけです。<br>
- .netFrameworkのSystem.IO.Compressionで簡単です。<br>
- 署名はsig.sigというファイル名にします。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">zipに固める</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.IO.Compression</span><span class="p">;</span>
<span class="k">private</span> <span class="kt">bool</span> <span class="nf">createZip</span><span class="p">(</span><span class="kt">string</span> <span class="n">targetFile</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">rootDir</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetFolderPath</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="n">SpecialFolder</span><span class="p">.</span><span class="n">DesktopDirectory</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">targetFileTitle</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="nf">GetFileNameWithoutExtension</span><span class="p">(</span><span class="n">targetFile</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">targetFileName</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">targetFile</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">zipFile</span> <span class="p">=</span> <span class="s">$@"</span><span class="p">{</span><span class="n">rootDir</span><span class="p">}</span><span class="s">\</span><span class="p">{</span><span class="n">targetFileTitle</span><span class="p">}</span><span class="s">.zip"</span><span class="p">;</span>

    <span class="c1">// zipに固める</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">z</span> <span class="p">=</span> <span class="n">ZipFile</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">zipFile</span><span class="p">,</span> <span class="n">ZipArchiveMode</span><span class="p">.</span><span class="n">Update</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">z</span><span class="p">.</span><span class="nf">CreateEntryFromFile</span><span class="p">(</span><span class="n">targetFile</span><span class="p">,</span> <span class="n">targetFileName</span><span class="p">,</span> <span class="n">CompressionLevel</span><span class="p">.</span><span class="n">Optimal</span><span class="p">);</span>

        <span class="n">ZipArchiveEntry</span> <span class="n">item</span> <span class="p">=</span> <span class="n">z</span><span class="p">.</span><span class="nf">CreateEntry</span><span class="p">(</span><span class="s">"sig.sig"</span><span class="p">,</span><span class="n">CompressionLevel</span><span class="p">.</span><span class="n">Optimal</span><span class="p">);</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">Stream</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="nf">Open</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">stream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sig</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">stream</span><span class="p">.</span><span class="nf">Flush</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="署名後の運用" class="fragment"></span><a href="#%E7%BD%B2%E5%90%8D%E5%BE%8C%E3%81%AE%E9%81%8B%E7%94%A8"><i class="fa fa-link"></i></a>署名後の運用</h3>

<p>ゲボ子さんの作業です。<br>
- デスクトップに署名付き報告書ファイル(zip)ができるので、それを上司に送り付けます。</p>

<hr>

<h1>
<span id="verify" class="fragment"></span><a href="#verify"><i class="fa fa-link"></i></a>◆Verify</h1>

<p><strong>このフェーズではセキュリティキーは使いません</strong></p>

<p>ゲボ子さんの上司：毛保川はゲボ子さんからメールを受け取りました。添付を見ると署名付きzipです。これが本当に本物かどうか検証アプリでチェックします。</p>

<p>とあるデータのVerifyには<br>
- 署名<br>
- 署名した人の公開鍵<br>
が必要になります。</p>

<p>検証は<a href="https://github.com/gebogebogebo/GeboSig/tree/master/Source/GeboSigVerify" rel="nofollow noopener" target="_blank">GeboSigVerify</a>というアプリで行います。</p>

<h3>
<span id="検証アプリ処理" class="fragment"></span><a href="#%E6%A4%9C%E8%A8%BC%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>検証アプリ処理</h3>

<ul>
<li>zipからファイルと署名データを取り出す</li>
<li>証明書から公開鍵をGETする</li>
<li>Verifyする</li>
<li>memo:OpenSSLでVerify</li>
</ul>

<h4>
<span id="zipからファイルと署名データを取り出す" class="fragment"></span><a href="#zip%E3%81%8B%E3%82%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E7%BD%B2%E5%90%8D%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E3%82%8A%E5%87%BA%E3%81%99"><i class="fa fa-link"></i></a>zipからファイルと署名データを取り出す</h4>

<p>.netFrameworkのSystem.IO.Compressionで簡単です。<br>
- ディスクにワークファイルを残したくないのでstreamでやってます。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">zipからデータを取り出す</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="kt">bool</span> <span class="nf">getVerifyFileandSig</span><span class="p">(</span><span class="kt">string</span> <span class="n">zip</span><span class="p">,</span><span class="k">out</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">target</span><span class="p">,</span> <span class="k">out</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">target</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="n">sig</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">ZipArchive</span> <span class="n">archive</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">.</span><span class="nf">OpenRead</span><span class="p">(</span><span class="n">zip</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">archive</span><span class="p">.</span><span class="n">Entries</span><span class="p">.</span><span class="n">Count</span> <span class="p">!=</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Compression</span><span class="p">.</span><span class="n">ZipArchiveEntry</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">archive</span><span class="p">.</span><span class="n">Entries</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"sig.sig"</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sig</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">entry</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">Stream</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">Open</span><span class="p">())</span> <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">entry</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">target</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">entry</span><span class="p">.</span><span class="n">Length</span><span class="p">];</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">Stream</span> <span class="n">stream</span> <span class="p">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">Open</span><span class="p">())</span> <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">stream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">entry</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div>
</div>

<h4>
<span id="証明書から公開鍵をgetする" class="fragment"></span><a href="#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%8B%E3%82%89%E5%85%AC%E9%96%8B%E9%8D%B5%E3%82%92get%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>証明書から公開鍵をGETする</h4>

<p>ここで、<a href="">Administrator-Registerフェーズ</a>で作成したゲボ子さんの証明書が必要になります。<br>
社内のRepositoryからゲボ子さんの証明書を探してきてその中から公開鍵をGETします。</p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">証明書から公開鍵をGETする</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">// certFileは証明書のパスファイル名です</span>
<span class="k">private</span> <span class="n">AsymmetricKeyParameter</span> <span class="nf">readPublicKeyfromCert</span><span class="p">(</span><span class="kt">string</span> <span class="n">certFile</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Org</span><span class="p">.</span><span class="n">BouncyCastle</span><span class="p">.</span><span class="n">X509</span><span class="p">.</span><span class="n">X509Certificate</span> <span class="n">readedCert</span><span class="p">;</span>

    <span class="c1">// 証明書の読み込み</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamReader</span><span class="p">(</span><span class="n">certFile</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">))</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">pemReader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PemReader</span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
        <span class="n">readedCert</span> <span class="p">=</span> <span class="p">(</span><span class="n">Org</span><span class="p">.</span><span class="n">BouncyCastle</span><span class="p">.</span><span class="n">X509</span><span class="p">.</span><span class="n">X509Certificate</span><span class="p">)</span><span class="n">pemReader</span><span class="p">.</span><span class="nf">ReadObject</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">publicKey</span> <span class="p">=</span> <span class="n">readedCert</span><span class="p">.</span><span class="nf">GetPublicKey</span><span class="p">();</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">publicKey</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="verifyする" class="fragment"></span><a href="#verify%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>Verifyする</h4>

<p>いよいよVerifyです、署名は検証するためにあります。<br>
VerifyはBouncy Castleでやります。<br>
以下のメソッドでtrueとなれば検証OKです。<br>
<strong>Verifyによって間違いなくゲボ子さんが書いたものであり、改ざんされていないということが確認できるのです。</strong></p>

<p><em>Bouncy Castleめちゃ楽</em></p>

<div class="code-frame" data-lang="CS">
<div class="code-lang"><span class="bold">Verify</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="kt">bool</span> <span class="nf">verify</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">target</span><span class="p">,</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">sig</span><span class="p">,</span><span class="n">AsymmetricKeyParameter</span> <span class="n">publicKey</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ISigner</span> <span class="n">signer</span> <span class="p">=</span> <span class="n">SignerUtilities</span><span class="p">.</span><span class="nf">GetSigner</span><span class="p">(</span><span class="s">"SHA1withRSA"</span><span class="p">);</span>
    <span class="n">signer</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="n">publicKey</span><span class="p">);</span>

    <span class="n">signer</span><span class="p">.</span><span class="nf">BlockUpdate</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">signer</span><span class="p">.</span><span class="nf">VerifySignature</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h4>
<span id="memoopensslでverify" class="fragment"></span><a href="#memoopenssl%E3%81%A7verify"><i class="fa fa-link"></i></a>memo:OpenSSLでVerify</h4>

<p>ちなみにVerifyはこのアプリでなくともできます。<br>
openSSLでやる場合は以下のコマンドでVerifyできます。</p>

<div class="code-frame" data-lang="cmd">
<div class="code-lang"><span class="bold">OpenSSLでVerify</span></div>
<div class="highlight"><pre class="with-code"><code>openssl x509 -in TestUser.crt -pubkey -noout&gt;public-key.pem
openssl dgst -sha1 -verify public-key.pem -signature sig.sig とっても大事な文書.pdf
</code></pre></div>
</div>

<h3>
<span id="検証後の運用" class="fragment"></span><a href="#%E6%A4%9C%E8%A8%BC%E5%BE%8C%E3%81%AE%E9%81%8B%E7%94%A8"><i class="fa fa-link"></i></a>検証後の運用</h3>

<p>毛保川の作業です。<br>
- ゲボ子さんから送られてきた報告書を確認し、保管します。<br>
- 電子署名がついているzipのまま保管すればOK</p>

<hr>

<h1>
<span id="おつかれさまでした" class="fragment"></span><a href="#%E3%81%8A%E3%81%A4%E3%81%8B%E3%82%8C%E3%81%95%E3%81%BE%E3%81%A7%E3%81%97%E3%81%9F"><i class="fa fa-link"></i></a>おつかれさまでした</h1>

<p>FIDO2セキュリティキーに署名の機能を追加することによって、認証と署名ができるようになります。<br>
認証の機能で社内への入退室をしたり、システムにログインし、署名の機能を使って社内文書の署名したりすることができますね。<br>
生体認証もできるのでいい感じでは。</p>

<p>今回はかなり簡易的なやり方でやっているので、このような方法で作られた電子署名がどの程度信頼できるものなのか、ちょっとわかんないんですけど。<br>
しかし署名まわりのいい勉強になりました。</p>

<p>おわり。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fgebo%2Fitems%2F0a08bc0e1aea6bc12c96&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fgebo%2Fitems%2F0a08bc0e1aea6bc12c96&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/gebo/items/0a08bc0e1aea6bc12c96/likers" class="css-1iupg5d">13</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">13</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/0a08bc0e1aea6bc12c96/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/gebo/items/0a08bc0e1aea6bc12c96/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/gebo/items/0a08bc0e1aea6bc12c96/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/gebo/items/0a08bc0e1aea6bc12c96/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/gebo/items/0a08bc0e1aea6bc12c96.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-59f130e7-e44a-4f1b-b53c-874c5322c844">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-d02d85c6-c98c-4353-b4b0-48678a23a062"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-d02d85c6-c98c-4353-b4b0-48678a23a062">{}</script>
      
<div id="LoginModal-react-component-f150a494-7897-4869-ad18-881ffa17f007"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-f150a494-7897-4869-ad18-881ffa17f007">{}</script>
      
<div id="StockModal-react-component-2e6b58c4-3e65-4d8b-a948-fae5865bf4e8"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-2e6b58c4-3e65-4d8b-a948-fae5865bf4e8">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;4KtsAvQu2pIFoxHaqES2RaZ7nlQsNA77Cq5BYEOXQ19E0F20O8VR3bm1ZStnafNkNkVgnarUXCtrEpyhTSIbLQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003e世界のパスワード問題を解決し、パスワードのない世界 を目指して策定されたFIDO規格。\u003cbr\u003e\nFIDO2のWebAuthn-JavaScriptを各社のウェブブラウザが実装したことでWeb認証はもはやFIDOがスタンダードです。\u003cbr\u003e\nFIDO2のセキュリティキーは 堅牢 かつ パスワードがいらないシンプルな操作 でログインすることができます。\u003c/p\u003e\n\n\u003cp\u003e一方で　デジタルガバメント を目指して策定されたGPKI、JPKI。\u003cbr\u003e\nマイナンバーカードは券面に個人情報印刷しまくりで、人に見せてはいけない、という意味不明のアナウンスで絶賛普及推進中。\u003cbr\u003e\n・・・何やっても全く普及せず、ひたすら残念な状況のマイナンバーカードですが、ICカードの中の仕組みはちゃんとしていて、認証だけでなく\u003ccode\u003e電子署名\u003c/code\u003eの機能も備えています。つまりログインだけでなく、電子文書へのデジタル署名（電子的な実印）を作成することができます。カード中の秘密鍵はセキュアに保護されており、外に出すことのできる公開鍵はスキャンされても問題ない、マイナンバーカードの機能は携帯する個人認証デバイスとしてはとってもいいものなのです。\u003c/p\u003e\n\n\u003cp\u003eこうやって見ると\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eデバイス\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e認証\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e電子署名\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e状況\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eFIDO2セキュリティーキー\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e〇\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eイケイケ\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eマイナンバーカード\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e〇\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e〇\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e残念\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e\u003cstrong\u003eFIDO2セキュリティキーで電子署名ができれば最強では。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eというわけで、この投稿ではFIDO2セキュリティキーで電子署名をする、というツッコミどころ満載な試みにトライしてみました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"環境\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%92%B0%E5%A2%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e環境\u003c/h1\u003e\n\n\u003cp\u003e要はFIDO2セキュリティキーを使った電子署名のプログラムを作成する、ということです。\u003cbr\u003e\nセキュリティキーは指紋スキャナの付いたBioPassを使いますが、BioPassでないといけない、ということはありません。YubikeyなどFIDO2のAuthenticatorであればOKです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/310d068bc58812dc2410fab0fa83bc7f6d80e67c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3235323239312f65333639393730642d353439302d353466632d343037382d6662326638623038366131352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fe369970d-5490-54fc-4078-fb2f8b086a15.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=15641aeac76278a10c30aeba7e1efa4e\" width=\"60%\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/252291/e369970d-5490-54fc-4078-fb2f8b086a15.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fe369970d-5490-54fc-4078-fb2f8b086a15.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=9a2f1cdafeef4a98d4b79cc8ee8a579d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eOSはWindows、言語はC#、暗号化ライブラリはBouncy Castle、セキュリティキーの制御はWebAuthnModokiDesktopを使います。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eFIDO2セキュリティキー \u003ca href=\"https://www.ftsafe.com/Products/FIDO2\" rel=\"nofollow noopener\" target=\"_blank\"\u003eBioPass\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003eWindows10 1809\u003c/li\u003e\n\u003cli\u003e.Net Framework 4.6.1\u003c/li\u003e\n\u003cli\u003eVisual Studio 2017 C#\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.bouncycastle.org/csharp/index.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eBouncy Castle 1.8.5\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/gebogebogebo/WebAuthnModokiDesktop\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWebAuthnModokiDesktop\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eソース \u003ca href=\"https://github.com/gebogebogebo/GeboSig\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGitHub\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ユースケース\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eユースケース\u003c/h1\u003e\n\n\u003cp\u003eおおざっぱに以下の構成です。\u003c/p\u003e\n\n\u003cp\u003ePhase\u003cbr\u003e\n- Administrator-Register\u003cbr\u003e\n- User-Register\u003cbr\u003e\n- Signature\u003cbr\u003e\n- Veriy\u003c/p\u003e\n\n\u003cp\u003eActor\u003cbr\u003e\n- システム管理者\u003cbr\u003e\n- ユーザー\u003cbr\u003e\n- マネージャ\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/bcdd48e52cf0ea888bb44e9f87522adfd81ebf06/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3235323239312f38353132643535372d383831382d313137632d366463342d3635316265356465323537632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2F8512d557-8818-117c-6dc4-651be5de257c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=81133a35f64ec444502a503c77998c22\" alt=\"01.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/252291/8512d557-8818-117c-6dc4-651be5de257c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2F8512d557-8818-117c-6dc4-651be5de257c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=3d9a7213aeee530a74d88b498462b841 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003e株式会社GEBOは三文判による紙の社内文書の運用から電子署名運用に切り替えました。という体で。\u003cbr\u003e\n- システム管理者＝社内システム担当：下暮田\u003cbr\u003e\n- ユーザー＝新入社員：ゲボ子\u003cbr\u003e\n- マネージャ＝ゲボ子の上司：毛保川\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"administrator-register\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#administrator-register\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆Administrator-Register\u003c/h1\u003e\n\n\u003cp\u003e情報処理室の社内システム担当：下暮田さんは本日入社する社員のゲボ子さんに渡すセキュリティキーを作成します。\u003cbr\u003e\nセキュリティキー(BioPass）は新品のものを使いますが、念のために初期化しておきましょう。\u003cbr\u003e\n初期化はBio Pass FIDO2 Managerというメーカー提供のツールでリセットしておきます。(Microsoft StoreからGETできます）\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/b55280e4190b49c376cfb0f5e9fb5e9c349dd27a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3235323239312f64393336303866372d313434652d356335302d636633382d3839393330633962333931642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fd93608f7-144e-5c50-cf38-89930c9b391d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7ac2c0084db266511513fedeb0a99c88\" width=\"50%\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/252291/d93608f7-144e-5c50-cf38-89930c9b391d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fd93608f7-144e-5c50-cf38-89930c9b391d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d917fbf40eab209425e9298275f779e0 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e登録は\u003ca href=\"https://github.com/gebogebogebo/GeboSig/tree/master/Source/GeboSigRegister\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGeboSigRegister\u003c/a\u003eというアプリで行います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"登録アプリ処理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%99%BB%E9%8C%B2%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e登録アプリ処理\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eRSA1024キーペア生成\u003c/li\u003e\n\u003cli\u003e秘密鍵をPEM形式でGET\u003c/li\u003e\n\u003cli\u003ePEM形式の秘密鍵をDER形式に変換する\u003c/li\u003e\n\u003cli\u003eDER形式の秘密鍵をAES256で暗号化する\u003c/li\u003e\n\u003cli\u003eセキュリティキーにPINを設定する\u003c/li\u003e\n\u003cli\u003eセキュリティキーに秘密鍵を書き込む\u003c/li\u003e\n\u003cli\u003e証明書を作成する\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"rsa1024キーペア生成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#rsa1024%E3%82%AD%E3%83%BC%E3%83%9A%E3%82%A2%E7%94%9F%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRSA1024キーペア生成\u003c/h4\u003e\n\n\u003cp\u003eRSA-1024bitキーペアを生成します。\u003cbr\u003e\nBouncy CastleのAPIを使います。\u003cbr\u003e\n※Bouncy Castleはusingの追加がたくさん必要なので、Alt+Enterでどんどん追加していきましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eRSA-1024bitキーペアを生成\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAsymmetricCipherKeyPair\u003c/span\u003e \u003cspan class=\"nf\"\u003ecreateKeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003erandGen\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCryptoApiRandomGenerator\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003erand\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSecureRandom\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erandGen\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eparam\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eKeyGenerationParameters\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erand\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyGen\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRsaKeyPairGenerator\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ekeyGen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparam\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyPair\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyGen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGenerateKeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"秘密鍵をpem形式でget\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92pem%E5%BD%A2%E5%BC%8F%E3%81%A7get\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e秘密鍵をPEM形式でGET\u003c/h4\u003e\n\n\u003cp\u003eBouncy CastleのPemWriterを使えば簡単です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e秘密鍵をPEM形式でGET\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003egetPrivatekyPEM\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAsymmetricCipherKeyPair\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003emem\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMemoryStream\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStreamWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eASCII\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epemWriter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePemWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epemWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteObject\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePrivate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epemWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFlush\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epem\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"pem形式の秘密鍵をder形式に変換する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#pem%E5%BD%A2%E5%BC%8F%E3%81%AE%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92der%E5%BD%A2%E5%BC%8F%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ePEM形式の秘密鍵をDER形式に変換する\u003c/h4\u003e\n\n\u003cp\u003e少しでもサイズを小さくしたいのでDERにします。これはBouncy CastleのAPIが見つからず、定番の方法(?)でやります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ePEMからDERにする\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003eConvertPEMtoDER\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epems\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTrim\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'\\n'\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eSplit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'\\n'\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// ヘッダとフッダは飛ばす\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveAt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveAt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// つなげる\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebase64\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eJoin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epems\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// もどす\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eConvert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromBase64String\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebase64\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"der形式の秘密鍵をaes256で暗号化する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#der%E5%BD%A2%E5%BC%8F%E3%81%AE%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92aes256%E3%81%A7%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDER形式の秘密鍵をAES256で暗号化する\u003c/h4\u003e\n\n\u003cp\u003eBouncy Castleを使います。\u003cbr\u003e\nこちらの素晴らしいサンプルをコピペさせていただきました\u003cbr\u003e\n\u003ca href=\"https://kagasu.hatenablog.com/entry/2017/01/04/213533\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://kagasu.hatenablog.com/entry/2017/01/04/213533\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003ekeyとivは普通はオープンにしてはいけませんよ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eAES256\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// inDataがDER形式の秘密鍵です\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003eEncrypt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003einData\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ygmh8zudlw5u0a9w4vc29whc4b8wuech\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eiv\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"s\"\u003e\"o10wi1q3x2f98cobfkyisnwy9s9wxop7\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Rijndael\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Mode = CBC\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// BlockSize = 256bit\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// PaddingMode = Zero\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecbcBlockCipher\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCbcBlockCipher\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRijndaelEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecipher\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePaddedBufferedBlockCipher\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecbcBlockCipher\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eZeroBytePadding\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eparametersWithIV\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eParametersWithIV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eKeyParameter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eiv\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ecipher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eparametersWithIV\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ecipher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetOutputSize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)];\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecipher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eProcessBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einData\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecipher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDoFinal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"セキュリティキーにpinを設定する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%AD%E3%83%BC%E3%81%ABpin%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eセキュリティキーにPINを設定する\u003c/h4\u003e\n\n\u003cp\u003e初期PINをセットします。\u003cbr\u003e\nUSBにセキュリティキーを挿してから、WebAuthnModokiDesktopのAPIで一発です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ePIN設定\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// PINは1234\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003esetNewPIN\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estatus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWebAuthnModokiDesktop\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCredentials\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetPin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDevParam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetDefaultParams\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"s\"\u003e\"1234\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisSuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// Error\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"セキュリティキーに秘密鍵を書き込む\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%AD%E3%83%BC%E3%81%AB%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eセキュリティキーに秘密鍵を書き込む\u003c/h4\u003e\n\n\u003cp\u003eさて、登録のヤマ場です。\u003cbr\u003e\nFIDO2セキュリティキーにどうやって秘密鍵を書き込むのか、ですが、ResidentKeyの機能を利用します。\u003cbr\u003e\n\u003cstrong\u003eResidentKeyはRPのユーザー情報を書き込むための機能で、秘密鍵などというものを書き込むための機能ではありません。\u003c/strong\u003e なのですが、やってみましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e※注意※\u003c/strong\u003e\u003cbr\u003e\n\u003cstrong\u003eこの制限はFIDOとかCTAPの仕様によるものではないと思われますので、モノによってこの通りでないと思われます。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e実際に試したところ、1回で書き込める情報は以下の通りでした。\u003cbr\u003e\n- UserID領域に64byte（byte型）\u003cbr\u003e\n- UserName領域に64文字（string型）\u003cbr\u003e\n- DisplayName領域に64文字（string型）\u003c/p\u003e\n\n\u003cp\u003eこれ以上のデータを書き込もうするとエラーになります。\u003c/p\u003e\n\n\u003cp\u003estring型は1byteを2文字のHEXにすればいいか、ということで、64byte+32byte(64文字)+32byte(64文字)の合計128byteを1回で書き込むことができます。\u003cbr\u003e\nでありますため、何回かに分けて書き込むことにします。\u003c/p\u003e\n\n\u003cp\u003e1回に書き込むデータを1レコードとして、レコードの構造は以下の通り。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eArea\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eDataType\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eSize\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e内容\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eUserID領域\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eレコードNo\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e1byte\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e0から始まるレコード番号\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eUserID領域\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e予備\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e1byte\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e0xFF固定\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eUserID領域\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eデータ\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e62byte\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e書き込むデータ\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eUserName領域\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eデータ\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e64文字\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e32byteのデータをHEX64文字にする\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eDisplayName領域\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eデータ\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e64文字\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e32byteのデータをHEX64文字にする\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e先ほど作成した秘密鍵(AES256で暗号化したもの）は640byteでした。\u003cbr\u003e\nこれだと6レコードになります。\u003cbr\u003e\n6回に分けて書き込みます。\u003c/p\u003e\n\n\u003cp\u003e書き込み自体はWebAuthnModokiDesktopのAPIを使えば簡単です。\u003cbr\u003e\n- 引数pinはさっき設定した初期PINを指定します。\u003cbr\u003e\n- 引数recは\u003ca href=\"https://github.com/gebogebogebo/GeboSig/blob/master/Source/GeboSigCommon/WriteData.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこんなかんじ\u003c/a\u003e\u003cbr\u003e\n- BioBassだと1回の書き込みにつきUser Presenceのチェックが走るのでキーがピカピカ光ってタッチが必要です、つまり、6回タッチしないいけないです。\u003cbr\u003e\n- これがNFCタイプ(例えばYubikey5）だとUser Presenceがされないのでいちいちタッチする必要がなく快適です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e1レコードの書き込み\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003ewriteRec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epin\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eWriteData\u003c/span\u003e \u003cspan class=\"n\"\u003erec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003echallenge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eASCII\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"this is challenge\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003euserid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003erec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erecno\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efiller\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"n\"\u003euserid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003euserid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata1\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eusername\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata2\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommon\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBytesToHexString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003euserdisplayname\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata3\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommon\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBytesToHexString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata3\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ejson\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\n                    \u003cspan class=\"s\"\u003e\"{\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"s\"\u003e@\"rp : {\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"id : 'GeboSig.gebo.com',\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"s\"\u003e@\"},\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"s\"\u003e@\"user : {\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"id_bytearray:[\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eJoin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\",\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003euserid\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e],\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"name :'\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eusername\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e',\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"displayName :'\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003euserdisplayname\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e',\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"s\"\u003e@\"},\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"s\"\u003e@\"pubKeyCredParams: [{type: 'public-key',alg: -7}],\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"s\"\u003e@\"attestation: 'direct',\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"s\"\u003e@\"timeout: 60000,\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"s\"\u003e@\"authenticatorSelection : {\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"requireResidentKey : true,\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                            \u003cspan class=\"s\"\u003e@\"authenticatorAttachment : 'cross-platform',\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"userVerification : 'discouraged'\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"s\"\u003e@\"},\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                        \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"challenge:[\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eJoin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\",\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003echallenge\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e],\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                    \u003cspan class=\"s\"\u003e\"}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWebAuthnModokiDesktop\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCredentials\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDevParam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetDefaultParams\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epin\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisSuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Success\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003eex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003efinally\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"証明書を作成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e証明書を作成する\u003c/h4\u003e\n\n\u003cp\u003e最後に秘密鍵のペアとなる公開鍵の処理です。\u003cbr\u003e\n公開鍵のままでも別にいいんですけど、せっかくなので(?)X.509形式の証明書にしておきましょう。\u003cbr\u003e\nBouncy CastleのAPIなら簡単です。\u003cbr\u003e\n※自己署名なんで、証明書の意味はないです。\u003cbr\u003e\n- 証明書のCNには対象者のゲボ子さんの情報を入れておきます。\u003cbr\u003e\n- 証明書は本日より10年間有効です。\u003cbr\u003e\n- 証明書に今作成したキーペアの公開鍵を格納し、自分自身の秘密鍵で署名します。\u003cbr\u003e\n- 証明書はPEM形式で作成します。\u003cbr\u003e\n- 作成した証明書は保管しておきます。本ユースケースでは社内のRepositoryで保管することにします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003ecreateCertificate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAsymmetricCipherKeyPair\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 証明書の属性\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eattr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDerObjectIdentifier\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCN\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003egeboko@gebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecom\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Japan\"\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eST\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"None\"\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"None\"\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eO\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"gebo\"\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOU\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"None\"\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eord\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDerObjectIdentifier\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCN\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eST\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eO\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOU\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 証明書の生成\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eX509Name\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eord\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eattr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecertGen\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eX509V3CertificateGenerator\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecertGen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetSerialNumber\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBigInteger\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOne\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecertGen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetIssuerDN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecertGen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetSubjectDN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecertGen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetNotBefore\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNow\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecertGen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetNotAfter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddYears\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecertGen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetPublicKey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePublic\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecert\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecertGen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGenerate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAsn1SignatureFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePkcsObjectIdentifiers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSha256WithRsaEncryption\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePrivate\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 証明書の出力\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003emem\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMemoryStream\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStreamWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eASCII\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epemWriter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePemWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epemWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteObject\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecert\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epemWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFlush\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epem\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"登録後の運用\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%99%BB%E9%8C%B2%E5%BE%8C%E3%81%AE%E9%81%8B%E7%94%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e登録後の運用\u003c/h3\u003e\n\n\u003cp\u003e下暮田さんの作業です。\u003cbr\u003e\n- 生成されたゲボ子さん用の証明書(geboko.crt）は社内のRepositoryにしまいます。\u003cbr\u003e\n- 初期化が済んだセキュリティキーをゲボ子さんに渡します。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"user-register\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#user-register\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆User-Register\u003c/h1\u003e\n\n\u003cp\u003eシステム管理者：下暮田さんから自分用のセキュリティキーを受け取ったゲボ子さんは自分用の初期設定をします。\u003cbr\u003e\n- PINの変更\u003cbr\u003e\n- 指紋登録\u003c/p\u003e\n\n\u003cp\u003ePINの変更は\u003ca href=\"https://github.com/gebogebogebo/GeboSig/tree/master/Source/GeboSigChangePIN\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGeboSigChangePIN\u003c/a\u003eというアプリで行います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"pin変更アプリ処理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#pin%E5%A4%89%E6%9B%B4%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ePIN変更アプリ処理\u003c/h3\u003e\n\n\u003cp\u003eWebAuthnMODOKIDesktopのAPIで一発です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// newpin=新しいPIN、currentpin=現在のPIN\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edevParam\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDevParam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetDefaultParams\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWebAuthnModokiDesktop\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCredentials\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eChangePin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edevParam\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enewpin\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentpin\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisSuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// OK\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// NG\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"指紋登録\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%8C%87%E7%B4%8B%E7%99%BB%E9%8C%B2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e指紋登録\u003c/h3\u003e\n\n\u003cp\u003e指紋登録はBio Pass FIDO2 Managerというメーカー提供のツールで行います。(Microsoft StoreからGETできます）\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/b55280e4190b49c376cfb0f5e9fb5e9c349dd27a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3235323239312f64393336303866372d313434652d356335302d636633382d3839393330633962333931642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fd93608f7-144e-5c50-cf38-89930c9b391d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7ac2c0084db266511513fedeb0a99c88\" width=\"50%\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/252291/d93608f7-144e-5c50-cf38-89930c9b391d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F252291%2Fd93608f7-144e-5c50-cf38-89930c9b391d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d917fbf40eab209425e9298275f779e0 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれでこのセキュリティキーのPINを知っているのはゲボ子さんだけす。指紋もゲボ子さんのものを登録しているので、\u003cstrong\u003eセキュリティキーを使えるのはゲボ子さんだけ、ということになります\u003c/strong\u003e。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"signature\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#signature\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆Signature\u003c/h1\u003e\n\n\u003cp\u003eここからが通常運用です。\u003cbr\u003e\nゲボ子さんは社内用の報告書を作成しました。上司に電子署名付きのファイル（報告書）を送ります。\u003c/p\u003e\n\n\u003cp\u003e署名は\u003ca href=\"https://github.com/gebogebogebo/GeboSig/tree/master/Source/GeboSigSignature\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGeboSigSignature\u003c/a\u003eというアプリで行います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"署名アプリ処理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%BD%B2%E5%90%8D%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e署名アプリ処理\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003e暗号化された秘密鍵を取り出す\u003c/li\u003e\n\u003cli\u003e復号する\u003c/li\u003e\n\u003cli\u003e復号データからパディングデータを除去する\u003c/li\u003e\n\u003cli\u003eDERからPEMに変換する\u003c/li\u003e\n\u003cli\u003e電子署名を作成する\u003c/li\u003e\n\u003cli\u003e署名の付いた文書を作成する\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"暗号化された秘密鍵を取り出す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%95%E3%82%8C%E3%81%9F%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92%E5%8F%96%E3%82%8A%E5%87%BA%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e暗号化された秘密鍵を取り出す\u003c/h4\u003e\n\n\u003cp\u003eセキュリティキーの中から(暗号化された)秘密鍵を取り出します。\u003cbr\u003e\n\u003cstrong\u003eセキュリティキーのアクセスはUV-指紋認証です。つまり ゲボ子さん本人 しかアクセスできません。\u003c/strong\u003e\u003cbr\u003e\n非常用でPINでのアクセスもできるようにしとかないといけないですが、PINも本人しか知らないはずです。\u003c/p\u003e\n\n\u003cp\u003e秘密鍵はセキュリティキーの中に複数レコードに分割して書き込みました。\u003cbr\u003e\nセキュリティキーからレコード情報を取りだすのはWebAuthnModokiDesktopのAPIで一発です。\u003cbr\u003e\n取り出したデータのUserID、UserName、DisplayNameを格納時と逆の方法でつなぎ合わせてbyte配列にします。\u003cbr\u003e\n- 戻り値ReadDataは\u003ca href=\"https://github.com/gebogebogebo/GeboSig/blob/master/Source/GeboSigSignature/ReadData.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこんなかんじ\u003c/a\u003e\u003cbr\u003e\n- credentialid は使わないので空です。\u003cbr\u003e\n- 指紋認証なのでuserVerification : 'preferred'にします\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eデータ取り出し\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003ereadRecs\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eReadData\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eReadData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003echallenge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eASCII\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"this is challenge\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecredentialid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ejson\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\n               \u003cspan class=\"s\"\u003e\"{\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"timeout : 60000,\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"challenge:[\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eJoin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\",\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003echallenge\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e],\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"rpId : 'GeboSig.gebo.com',\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                   \u003cspan class=\"s\"\u003e@\"allowCredentials : [{\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                       \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"id : [\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eJoin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\",\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecredentialid\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e],\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                       \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"type : 'public-key',\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                   \u003cspan class=\"s\"\u003e@\"}],\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                   \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"requireUserPresence : 'false',\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                   \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"userVerification : 'preferred',\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                \u003cspan class=\"s\"\u003e\"}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWebAuthnModokiDesktop\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCredentials\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egebo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCTAP2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDevParam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetDefaultParams\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisSuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisSuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emsg\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// dataList\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edataList\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eWriteData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eassertion\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eassertions\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003edataList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eWriteData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eassertion\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUser_Id\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eassertion\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUser_Name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eassertion\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUser_DisplayName\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edataList\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edataList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOrderBy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erecno\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// data\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003edataList\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata2\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata3\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisSuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emsg\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Success\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ereadData\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003efinally\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"復号する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%BE%A9%E5%8F%B7%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e復号する\u003c/h4\u003e\n\n\u003cp\u003eさて、取り出した秘密鍵はAES256で暗号化されているので復号します。\u003cbr\u003e\n復号するときのkeyとivは暗号化するときと同じものを指定しましょう。\u003c/p\u003e\n\n\u003cp\u003ekeyとivは普通はオープンにしてはいけませんよ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e復号する\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// inDataが暗号化されているデータです\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003eDecrypt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003einData\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// AES-256\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ygmh8zudlw5u0a9w4vc29whc4b8wuech\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eiv\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"s\"\u003e\"o10wi1q3x2f98cobfkyisnwy9s9wxop7\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Rijndael\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Mode = CBC\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// BlockSize = 256bit\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// PaddingMode = Zero\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecbcBlockCipher\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCbcBlockCipher\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRijndaelEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecipher\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePaddedBufferedBlockCipher\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecbcBlockCipher\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eZeroBytePadding\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eparametersWithIV\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eParametersWithIV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eKeyParameter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eiv\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ecipher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eparametersWithIV\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ecipher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetOutputSize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)];\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecipher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eProcessBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einData\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecipher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDoFinal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"復号データからパディングデータを除去する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%BE%A9%E5%8F%B7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8B%E3%82%89%E3%83%91%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E9%99%A4%E5%8E%BB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e復号データからパディングデータを除去する\u003c/h4\u003e\n\n\u003cp\u003eここが今一つわからなかったのですが、AESの復号ではパティングデータが付いたままでモドされるようです。PaddingMode = Zeroなので後ろに0x00が何個かひっついてきます。\u003cbr\u003e\nこれがあると非常に具合が悪いので除去します。\u003cbr\u003e\n幸いなことにDERは先頭SEQにデータレングスがあるので、その情報をもとにパディングデータをとっぱらいます。\u003cbr\u003e\nこれでちゃんとしたDERになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eパディングデータを除去する\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003egetPrivateKey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003edecData\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edecData\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"m\"\u003e0x30\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edecData\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"m\"\u003e0x82\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edatasize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eChangeEndian\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReverse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToUInt16\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edecData\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// add header-4byte\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edatasize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edatasize\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edecData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eTake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edatasize\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"derからpemに変換する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#der%E3%81%8B%E3%82%89pem%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDERからPEMに変換する\u003c/h4\u003e\n\n\u003cp\u003eさてさて、Bouncy Castleで署名するためにPEMにしないといけないです。\u003cbr\u003e\n\u003cem\u003eめんどくさいなぁ、Bouncy CastleってほんとにDERつかえないのかなぁ\u003c/em\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDERからPEMに変換する\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 1.Base64エンコード\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 2.64文字ごとに改行コードをいれる\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 3.ヘッダとフッタを入れる\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eConvertPrivateKeyDERtoPEM\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eder\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epemdata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"-----BEGIN RSA PRIVATE KEY-----\\n\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"nf\"\u003eConvertDERtoPEM\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eder\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\"-----END RSA PRIVATE KEY-----\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003epemdata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eConvertDERtoPEM\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eder\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eb64cert\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToBase64String\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eder\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epemdata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eroopcount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCeiling\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb64cert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e64.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eintIc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003eintIc\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eroopcount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003eintIc\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estart\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e64\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eintIc\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eintIc\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eroopcount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003epemdata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epemdata\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eb64cert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubstring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003epemdata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epemdata\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eb64cert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubstring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003epemdata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"電子署名を作成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9B%BB%E5%AD%90%E7%BD%B2%E5%90%8D%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e電子署名を作成する\u003c/h4\u003e\n\n\u003cp\u003eついにこのときが来ました。ファイルの署名を作成します。\u003cbr\u003e\nBouncy Castleで署名を作成します。\u003cbr\u003e\nなにやら色々手順がありますが、思考停止のおまじないということで。\u003cbr\u003e\n- pemPrivateKeyはPEM形式の秘密鍵。\u003cbr\u003e\n- targetfilepathは署名対象のファイルのパスとファイル名です。\u003cbr\u003e\n- ReadAllBytesしているんでファイルを一回全部取り込むっぽいです。巨大なファイルだとヤバいです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e電子署名を作成する！\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003ecreateSign\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epemPrivateKey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003etargetfilepath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAllBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etargetfilepath\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// PEMフォーマットの秘密鍵を読み込んで KeyPair オブジェクトを生成\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eprivateKeyReader\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePemReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStringReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epemPrivateKey\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyPair\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAsymmetricCipherKeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eprivateKeyReader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadObject\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eRsaKeyParameters\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eRsaKeyParameters\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ekeyPair\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePrivate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eISigner\u003c/span\u003e \u003cspan class=\"n\"\u003esig\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSignerUtilities\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSigner\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"SHA1withRSA\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBlockUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esignature\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGenerateSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esignature\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"署名の付いた文書を作成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%BD%B2%E5%90%8D%E3%81%AE%E4%BB%98%E3%81%84%E3%81%9F%E6%96%87%E6%9B%B8%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e署名の付いた文書を作成する\u003c/h4\u003e\n\n\u003cp\u003eターゲットファイルと署名を一つのzipにして固めてデスクトップに吐き出すだけです。\u003cbr\u003e\n- .netFrameworkのSystem.IO.Compressionで簡単です。\u003cbr\u003e\n- 署名はsig.sigというファイル名にします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ezipに固める\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.IO.Compression\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003ecreateZip\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003etargetFile\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003erootDir\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetFolderPath\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSpecialFolder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDesktopDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etargetFileTitle\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetFileNameWithoutExtension\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etargetFile\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etargetFileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetFileName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etargetFile\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ezipFile\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$@\"\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003erootDir\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\\\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003etargetFileTitle\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e.zip\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// zipに固める\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eZipFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ezipFile\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eZipArchiveMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ez\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateEntryFromFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etargetFile\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etargetFileName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCompressionLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOptimal\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eZipArchiveEntry\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ez\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"sig.sig\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eCompressionLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOptimal\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStream\u003c/span\u003e \u003cspan class=\"n\"\u003estream\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFlush\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"署名後の運用\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%BD%B2%E5%90%8D%E5%BE%8C%E3%81%AE%E9%81%8B%E7%94%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e署名後の運用\u003c/h3\u003e\n\n\u003cp\u003eゲボ子さんの作業です。\u003cbr\u003e\n- デスクトップに署名付き報告書ファイル(zip)ができるので、それを上司に送り付けます。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"verify\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#verify\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆Verify\u003c/h1\u003e\n\n\u003cp\u003e\u003cstrong\u003eこのフェーズではセキュリティキーは使いません\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eゲボ子さんの上司：毛保川はゲボ子さんからメールを受け取りました。添付を見ると署名付きzipです。これが本当に本物かどうか検証アプリでチェックします。\u003c/p\u003e\n\n\u003cp\u003eとあるデータのVerifyには\u003cbr\u003e\n- 署名\u003cbr\u003e\n- 署名した人の公開鍵\u003cbr\u003e\nが必要になります。\u003c/p\u003e\n\n\u003cp\u003e検証は\u003ca href=\"https://github.com/gebogebogebo/GeboSig/tree/master/Source/GeboSigVerify\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGeboSigVerify\u003c/a\u003eというアプリで行います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"検証アプリ処理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A4%9C%E8%A8%BC%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e検証アプリ処理\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003ezipからファイルと署名データを取り出す\u003c/li\u003e\n\u003cli\u003e証明書から公開鍵をGETする\u003c/li\u003e\n\u003cli\u003eVerifyする\u003c/li\u003e\n\u003cli\u003ememo:OpenSSLでVerify\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"zipからファイルと署名データを取り出す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#zip%E3%81%8B%E3%82%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E7%BD%B2%E5%90%8D%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E3%82%8A%E5%87%BA%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ezipからファイルと署名データを取り出す\u003c/h4\u003e\n\n\u003cp\u003e.netFrameworkのSystem.IO.Compressionで簡単です。\u003cbr\u003e\n- ディスクにワークファイルを残したくないのでstreamでやってます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ezipからデータを取り出す\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003egetVerifyFileandSig\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ezip\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esig\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompression\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eZipArchive\u003c/span\u003e \u003cspan class=\"n\"\u003earchive\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompression\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eZipFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpenRead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ezip\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"n\"\u003earchive\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEntries\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompression\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eZipArchiveEntry\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003earchive\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEntries\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"s\"\u003e\"sig.sig\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esig\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStream\u003c/span\u003e \u003cspan class=\"n\"\u003estream\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStream\u003c/span\u003e \u003cspan class=\"n\"\u003estream\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"証明書から公開鍵をgetする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%8B%E3%82%89%E5%85%AC%E9%96%8B%E9%8D%B5%E3%82%92get%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e証明書から公開鍵をGETする\u003c/h4\u003e\n\n\u003cp\u003eここで、\u003ca href=\"\"\u003eAdministrator-Registerフェーズ\u003c/a\u003eで作成したゲボ子さんの証明書が必要になります。\u003cbr\u003e\n社内のRepositoryからゲボ子さんの証明書を探してきてその中から公開鍵をGETします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e証明書から公開鍵をGETする\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// certFileは証明書のパスファイル名です\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAsymmetricKeyParameter\u003c/span\u003e \u003cspan class=\"nf\"\u003ereadPublicKeyfromCert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecertFile\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eOrg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBouncyCastle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX509\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX509Certificate\u003c/span\u003e \u003cspan class=\"n\"\u003ereadedCert\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 証明書の読み込み\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStreamReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecertFile\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eASCII\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epemReader\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePemReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ereadedCert\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOrg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBouncyCastle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX509\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX509Certificate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003epemReader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadObject\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epublicKey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereadedCert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetPublicKey\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epublicKey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"verifyする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#verify%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eVerifyする\u003c/h4\u003e\n\n\u003cp\u003eいよいよVerifyです、署名は検証するためにあります。\u003cbr\u003e\nVerifyはBouncy Castleでやります。\u003cbr\u003e\n以下のメソッドでtrueとなれば検証OKです。\u003cbr\u003e\n\u003cstrong\u003eVerifyによって間違いなくゲボ子さんが書いたものであり、改ざんされていないということが確認できるのです。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cem\u003eBouncy Castleめちゃ楽\u003c/em\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"CS\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eVerify\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003everify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eAsymmetricKeyParameter\u003c/span\u003e \u003cspan class=\"n\"\u003epublicKey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eISigner\u003c/span\u003e \u003cspan class=\"n\"\u003esigner\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSignerUtilities\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSigner\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"SHA1withRSA\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esigner\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epublicKey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esigner\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBlockUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esigner\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eVerifySignature\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"memoopensslでverify\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#memoopenssl%E3%81%A7verify\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ememo:OpenSSLでVerify\u003c/h4\u003e\n\n\u003cp\u003eちなみにVerifyはこのアプリでなくともできます。\u003cbr\u003e\nopenSSLでやる場合は以下のコマンドでVerifyできます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cmd\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eOpenSSLでVerify\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eopenssl x509 -in TestUser.crt -pubkey -noout\u0026gt;public-key.pem\nopenssl dgst -sha1 -verify public-key.pem -signature sig.sig とっても大事な文書.pdf\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"検証後の運用\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A4%9C%E8%A8%BC%E5%BE%8C%E3%81%AE%E9%81%8B%E7%94%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e検証後の運用\u003c/h3\u003e\n\n\u003cp\u003e毛保川の作業です。\u003cbr\u003e\n- ゲボ子さんから送られてきた報告書を確認し、保管します。\u003cbr\u003e\n- 電子署名がついているzipのまま保管すればOK\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おつかれさまでした\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%81%A4%E3%81%8B%E3%82%8C%E3%81%95%E3%81%BE%E3%81%A7%E3%81%97%E3%81%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおつかれさまでした\u003c/h1\u003e\n\n\u003cp\u003eFIDO2セキュリティキーに署名の機能を追加することによって、認証と署名ができるようになります。\u003cbr\u003e\n認証の機能で社内への入退室をしたり、システムにログインし、署名の機能を使って社内文書の署名したりすることができますね。\u003cbr\u003e\n生体認証もできるのでいい感じでは。\u003c/p\u003e\n\n\u003cp\u003e今回はかなり簡易的なやり方でやっているので、このような方法で作られた電子署名がどの程度信頼できるものなのか、ちょっとわかんないんですけど。\u003cbr\u003e\nしかし署名まわりのいい勉強になりました。\u003c/p\u003e\n\n\u003cp\u003eおわり。\u003c/p\u003e\n","createdAt":"2019-03-02T07:03:17Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"PE5oX0rZ51aaNFInWriuQrAJysUejXfB--qL4mG9TFd1vS3LFI--ElDJ+6Mr0I2yRJkQADAJqA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-05-24T11:42:45Z","likesCount":13,"linkUrl":"https://qiita.com/gebo/items/0a08bc0e1aea6bc12c96","organization":null,"originalId":810051,"stockedCount":13,"title":"FIDO2セキュリティキーで電子署名をする試み","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%92%B0%E5%A2%83\"\u003e環境\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9\"\u003eユースケース\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#administrator-register\"\u003e◆Administrator-Register\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%99%BB%E9%8C%B2%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86\"\u003e登録アプリ処理\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#rsa1024%E3%82%AD%E3%83%BC%E3%83%9A%E3%82%A2%E7%94%9F%E6%88%90\"\u003eRSA1024キーペア生成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92pem%E5%BD%A2%E5%BC%8F%E3%81%A7get\"\u003e秘密鍵をPEM形式でGET\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#pem%E5%BD%A2%E5%BC%8F%E3%81%AE%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92der%E5%BD%A2%E5%BC%8F%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B\"\u003ePEM形式の秘密鍵をDER形式に変換する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#der%E5%BD%A2%E5%BC%8F%E3%81%AE%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92aes256%E3%81%A7%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%99%E3%82%8B\"\u003eDER形式の秘密鍵をAES256で暗号化する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%AD%E3%83%BC%E3%81%ABpin%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\"\u003eセキュリティキーにPINを設定する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%AD%E3%83%BC%E3%81%AB%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80\"\u003eセキュリティキーに秘密鍵を書き込む\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e証明書を作成する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%99%BB%E9%8C%B2%E5%BE%8C%E3%81%AE%E9%81%8B%E7%94%A8\"\u003e登録後の運用\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cli\u003e\n\u003ca href=\"#user-register\"\u003e◆User-Register\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#pin%E5%A4%89%E6%9B%B4%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86\"\u003ePIN変更アプリ処理\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%8C%87%E7%B4%8B%E7%99%BB%E9%8C%B2\"\u003e指紋登録\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\n\n\u003cli\u003e\n\u003ca href=\"#signature\"\u003e◆Signature\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%BD%B2%E5%90%8D%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86\"\u003e署名アプリ処理\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9A%97%E5%8F%B7%E5%8C%96%E3%81%95%E3%82%8C%E3%81%9F%E7%A7%98%E5%AF%86%E9%8D%B5%E3%82%92%E5%8F%96%E3%82%8A%E5%87%BA%E3%81%99\"\u003e暗号化された秘密鍵を取り出す\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%BE%A9%E5%8F%B7%E3%81%99%E3%82%8B\"\u003e復号する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%BE%A9%E5%8F%B7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8B%E3%82%89%E3%83%91%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E9%99%A4%E5%8E%BB%E3%81%99%E3%82%8B\"\u003e復号データからパディングデータを除去する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#der%E3%81%8B%E3%82%89pem%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B\"\u003eDERからPEMに変換する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9B%BB%E5%AD%90%E7%BD%B2%E5%90%8D%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e電子署名を作成する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%BD%B2%E5%90%8D%E3%81%AE%E4%BB%98%E3%81%84%E3%81%9F%E6%96%87%E6%9B%B8%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e署名の付いた文書を作成する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%BD%B2%E5%90%8D%E5%BE%8C%E3%81%AE%E9%81%8B%E7%94%A8\"\u003e署名後の運用\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\n\n\u003cli\u003e\n\u003ca href=\"#verify\"\u003e◆Verify\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A4%9C%E8%A8%BC%E3%82%A2%E3%83%97%E3%83%AA%E5%87%A6%E7%90%86\"\u003e検証アプリ処理\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#zip%E3%81%8B%E3%82%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E7%BD%B2%E5%90%8D%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E3%82%8A%E5%87%BA%E3%81%99\"\u003ezipからファイルと署名データを取り出す\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%8B%E3%82%89%E5%85%AC%E9%96%8B%E9%8D%B5%E3%82%92get%E3%81%99%E3%82%8B\"\u003e証明書から公開鍵をGETする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#verify%E3%81%99%E3%82%8B\"\u003eVerifyする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#memoopenssl%E3%81%A7verify\"\u003ememo:OpenSSLでVerify\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A4%9C%E8%A8%BC%E5%BE%8C%E3%81%AE%E9%81%8B%E7%94%A8\"\u003e検証後の運用\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\n\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%81%A4%E3%81%8B%E3%82%8C%E3%81%95%E3%81%BE%E3%81%A7%E3%81%97%E3%81%9F\"\u003eおつかれさまでした\u003c/a\u003e\n\u003c/li\u003e\n\n","totalPv":2908,"uuid":"0a08bc0e1aea6bc12c96","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"vth/nrCArek+Z7ofex0vmsAW1cJN--3MMO8b1VFB3rsRIN--JxXWbGPyxrNcl7iY8DoEyQ==","originalId":252291,"description":"認証,認可,FIDO,CTAP,NFC,BLE,c,c++,c#,Rust,ねこのげぼく","facebookUrl":null,"githubUrl":"https://github.com/gebogebogebo","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"Satoshi Suzuki","profileImageUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/252291/259049ef3da2854c57fc30166d776b5ac272df00/x_large.png?1614046902","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F252291%2F259049ef3da2854c57fc30166d776b5ac272df00%2Fx_large.png%3F1614046902?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=da68ce3463d091cbdf102f2918d35763","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F252291%2F259049ef3da2854c57fc30166d776b5ac272df00%2Fx_large.png%3F1614046902?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=5099eac7ef4c965d458c7a95649b4f8d","urlName":"gebo","websiteUrl":"https://zenn.dev/gebo","twitterUrl":"https://twitter.com/gebogebogeboge","twitterUrlName":"gebogebogeboge","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"電子署名","urlName":"%e9%9b%bb%e5%ad%90%e7%bd%b2%e5%90%8d"},{"name":"FIDO","urlName":"fido"},{"name":"CTAP","urlName":"ctap"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
