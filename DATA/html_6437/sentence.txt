More than 3 years have passed since last update.AzureのAppService上でファイルを追記したいだけの人生だった。という素晴らしく手抜きな関数を使っていたところ、リクエストが重なったときに競合であっさり死亡。PHP脳はマルチスレッドに弱いのだ。で、これをどうにかしたいと思ったのだが、キューに投げておけば後で勝手に書き込んでくれる、みたいな機能はどうやら用意されていないみたいだ。
ちなみにAppendAllTextのサンプルは、そもそもcatchすらしてないものが大半だった。しかたないのでTextWriter.Synchronized()を使うことにする。どうやらファイルをStreamWriterで開くだけで死ぬらしい。
Synchronizedとかする以前の問題だった。
ドキュメントには「ファイル名、ディレクトリ名が正しくないときに出る」としか書いてないのだが、どう見てもロック失敗である。えっこれどうすんの？
newしただけでExceptionとか聞いてないよ。
WriteをcatchするとかSynchronizedするとかのソリューションはよく見かけるけど、実は解決になっていないということがわかった。その後もなんか色々調べたりしたんだけどそのあたりは省略して、最終的にできあがったのがこんな。例外は発生せず、動作も安定しているように見えるのだが、本当にこれで合ってるのか？？？


