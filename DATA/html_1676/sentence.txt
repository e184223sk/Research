More than 1 year has passed since last update.途中で無くなったり、歯抜けになってもいいけど、素早くデータを送りたい場合に必要なUDPをNAT越しでクライアントに送る場合のお話。.NetCore3.1NATをどうしたら外側から超えられるか。
NATはクライアントのアドレスおよびポート番号を変換しサーバに転送するので、サーバからクライアントに向けて(IPアドレス）パケットを送っても到達しません（そもそもクライアントはプライベートIPの場合も）。
そこでネットを漁るとUDP Hole Punchingなるキーワードが。
NATの変換の癖を利用した方法で、一度クライアントからサーバにパケットを送るとNATに変換テーブルが作成され穴が開いた状態になるので、
その穴に向かってパケットを発射するとクライアントに転送されるといった技だそうです。ネットを探すといろいろ情報があるけど、サンプルを実行しても動かない。
一番近いサンプルでした。
調査すると、どうやらサーバ側のUDPにソースアドレスが設定されていないため、NATが変換できないことが判明。
簡単なコアサンプルを作成しましたので、ご自身のプログラムに組み込んではいかがでしょうか。
コアサンプルソースのプロパティを変更してみてください。
1. クライアントは実行時にサーバのIPアドレスをしてくしてください
以上です。
コアサンプルにコメントを書いておいたのでそちらを参照してください。うまくクライアントを制御すれば、サーバを返さずP2Pでクライアント同士がおしゃべりできるかも。いろいろな環境(NAT)で試したわけではないので、動かない環境もあるやもしれません。


