<!DOCTYPE html><html><head><meta charset="utf-8" /><title>C#(.NET系)からPostgreSQLへ接続(TransactionScopeや分散トランザクションについて) - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/mimitaro/items/fde451da2f722fe12072" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="b9j9kphyHbU4itmJ6aQ8MesebUcTHzbLyESDICWk4455aIGHhMvL+0fSsEOVCCXDVOu9f0KOVLH7nU7SW83ElA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="C#(.NET系)からPostgreSQLへ接続(TransactionScopeや分散トランザクションについて) - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReU1vTGs1RlZPZXp1eW5qZ1l2amdvbFFiM04wWjNKbFUxRk00NEc0NW82bDU3YWFLRlJ5WVc1ellXTjBhVzl1VTJOdmNHWGpnb1RsaUlibWxhUGpnNGpqZzZuamc3UGpncmJqZ3FfamdyZmpnNmZqZzdQamdhdmpnYVRqZ1lUamdhWXAmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9NTlhNGQ0NDg1NDM2YWYxNzM2NTY5NTdiYzllYjdlMTM&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzFwYldsMFlYSnYmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz0yZTRlOGIxMWYxMTRhMDVlMjgxZWJmYWViNDRjZDAyZg&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=1d4e1288e0ffe6390a066d3869fc0598"><meta property="og:description" content="

はじめに

今更ながらJavaに引き続き、色んな言語からPostgreSQLへ接続するシリーズです。
今回はC#(.NET系)です。C#はODBC接続などの方法もありますが、今回はNpgsqlによる接続を説明します。


Npgs..."><meta content="https://qiita.com/mimitaro/items/fde451da2f722fe12072" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,.NET,PostgreSQL,Npgsql" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-0126fb98-5c81-4d58-86b7-a20e0d777a26"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fmimitaro%2Fitems%2Ffde451da2f722fe12072">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fmimitaro%2Fitems%2Ffde451da2f722fe12072">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-0126fb98-5c81-4d58-86b7-a20e0d777a26">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-11-20T11:25:33.000+09:00","dateModified":"2018-11-20T11:25:33.000+09:00","headline":"C#(.NET系)からPostgreSQLへ接続(TransactionScopeや分散トランザクションについて)","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReU1vTGs1RlZPZXp1eW5qZ1l2amdvbFFiM04wWjNKbFUxRk00NEc0NW82bDU3YWFLRlJ5WVc1ellXTjBhVzl1VTJOdmNHWGpnb1RsaUlibWxhUGpnNGpqZzZuamc3UGpncmJqZ3FfamdyZmpnNmZqZzdQamdhdmpnYVRqZ1lUamdhWXAmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9NTlhNGQ0NDg1NDM2YWYxNzM2NTY5NTdiYzllYjdlMTM\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzFwYldsMFlYSnYmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz0yZTRlOGIxMWYxMTRhMDVlMjgxZWJmYWViNDRjZDAyZg\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=1d4e1288e0ffe6390a066d3869fc0598","mainEntityOfPage":"https://qiita.com/mimitaro/items/fde451da2f722fe12072","author":{"@type":"Person","address":"","email":null,"identifier":"mimitaro","name":"mimitaro","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F224034%2Fprofile-images%2F1513333619?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cf49a1e83b54fde8f7d4403aa7840ae9","url":"https://qiita.com/mimitaro","description":"PostgreSQL大好き人間です。\r\n他にも趣味でpythonやらJavaやらをいじっています。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mimitaro","type":"items","id":"fde451da2f722fe12072"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mimitaro","type":"items","id":"fde451da2f722fe12072"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mimitaro","type":"items","id":"fde451da2f722fe12072"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/mimitaro/items/fde451da2f722fe12072","location":"/mimitaro/items/fde451da2f722fe12072","scheme":"https","host":"qiita.com","port":null,"pathname":"/mimitaro/items/fde451da2f722fe12072","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"r4Enp7LJR1tylmN/kQBeFTwfxLB0xc/bRZWNhZaDWVe5MVuyrnCRFQ3OCrXtrEfng+oUiCVUraF2TEB36Op+TQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-4d777a1a-0ee5-4b6f-868e-8b35a16b8551"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mimitaro/items/fde451da2f722fe12072/likers" class="css-1iupg5d">27</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">38</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/fde451da2f722fe12072/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mimitaro/items/fde451da2f722fe12072/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mimitaro/items/fde451da2f722fe12072/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mimitaro/items/fde451da2f722fe12072/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mimitaro/items/fde451da2f722fe12072.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/mimitaro"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/224034/profile-images/1513333619" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/mimitaro" class="css-10ougpm">@<!-- -->mimitaro</a><div class="css-1ay9vb9"><time dateTime="2018-11-20T02:25:33Z" class="css-m19uds">posted at 2018-11-20</time></div></div></div></div></div><h1 class="css-cgzq40">C#(.NET系)からPostgreSQLへ接続(TransactionScopeや分散トランザクションについて)</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/.net" class="css-4czcte">.NET</a><a href="/tags/postgresql" class="css-4czcte">PostgreSQL</a><a href="/tags/npgsql" class="css-4czcte">Npgsql</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>今更ながら<a href="https://qiita.com/mimitaro/items/7628c86ad8c69dfd3f03" id="reference-9f290b49228af4272039">Java</a>に引き続き、色んな言語からPostgreSQLへ接続するシリーズです。<br>
今回はC#(.NET系)です。C#はODBC接続などの方法もありますが、今回はNpgsqlによる接続を説明します。</p>

<h1>
<span id="npgsqlとは" class="fragment"></span><a href="#npgsql%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Npgsqlとは</h1>

<p>.NET環境からPostgreSQLへ接続するためのツールです。<br>
今回は以下の環境でNpgsqlの導入と検証をしました。</p>

<table>
<thead>
<tr>
<th>環境</th>
<th>バージョン</th>
</tr>
</thead>
<tbody>
<tr>
<td>OS</td>
<td>Windows 10</td>
</tr>
<tr>
<td>.NET Framework</td>
<td>4.5</td>
</tr>
<tr>
<td>Visual Studio</td>
<td>2013</td>
</tr>
<tr>
<td>Npgsql</td>
<td>4.0.3</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>10.0</td>
</tr>
</tbody>
</table>

<p>実際に使用する場合、.NET、Visual Studio、Npgsqlのバージョンを各々考慮する必要があります。<br>
ただ結論を述べると注意すべき点は以下の通りです。</p>

<ul>
<li>
<strong>Visual Studio 2013(特に.NET 4.5.X)を使っている場合、サポートが切れている上に、古いNpgsqlだとバグがあるため注意する。</strong><br>(該当する.NET 4.5.Xに対応した最新のNpgsqlを必ず用いる)</li>
<li><strong>次期バージョンのNpgsql 4.1からは、.NET 4.5.2と.NET Standard 2.0がサポートされる最低バージョンとなる。</strong></li>
<li>
<strong>最新版のVisual Studio上で、最新の.NET Frameworkを選択し、最新のNpgsqlを用いれば問題ない</strong>。</li>
</ul>

<p>そもそも.NET Frameworkと.NET Standardって何? となった方(私はなった)や、詳細な各環境の対応を知りたい方は<a href="#net%E9%96%A2%E9%80%A3">参考にしたサイトの.NET関連</a>をご参照ください。</p>

<h2>
<span id="npgsqlの導入" class="fragment"></span><a href="#npgsql%E3%81%AE%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>Npgsqlの導入</h2>

<p>NpgsqlはNuGetを用いて導入可能です。以下のサイトから最新版を確認し、インストール用のコマンドをコピーします。</p>

<ul>
<li>Npgsql<br>
<a href="https://www.nuget.org/packages/Npgsql/" class="autolink" rel="nofollow noopener" target="_blank">https://www.nuget.org/packages/Npgsql/</a>
</li>
</ul>

<p>その後、Visual Studioを開き、メニューバーの[ツール]→[NuGetパッケージマネージャ]→[パッケージマネージャコンソール]を選択する。<br>
するとVisual Studioの下部に、PM(パッケージマネージャ)コンソールが開くため、先程コピーしたコマンドを入力し、結果を確認する。</p>

<div class="code-frame" data-lang="">
<div class="code-lang"><span class="bold">NuGetによるNpgsqlの導入(失敗)</span></div>
<div class="highlight"><pre class="with-code"><code>PM&gt; Install-Package Npgsql -Version 4.0.3
依存関係 'System.Runtime.CompilerServices.Unsafe (≥ 4.5.0)' の解決を試みています。
Install-Package : 'System.Runtime.CompilerServices.Unsafe 4.5.0' パッケージには NuGet クライアント バージョン '2.12' 以降が必要ですが、現在の NuGet バージョンは '2.8.60610.756' です。
発生場所 行:1 文字:1
+ Install-Package Npgsql -Version 4.0.3
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [Install-Package], NuGetVersionNotSatisfiedException
    + FullyQualifiedErrorId : NuGetCmdletUnhandledException,NuGet.PowerShell.Commands.InstallPackageCommand
</code></pre></div>
</div>

<p>今回はNuGetのバージョンが古いため失敗しました。<br>
そのためNuGetをバージョンアップします。<br>
メニューバーの[ツール]→[拡張機能と更新プログラム]→左メニューから[更新プログラム]の[Visutal Studioギャラリー]を選択します。<br>
NuGetの[更新]をクリックし、インストール後、案内されるままVisutal Studioを再起動します。</p>

<p>バージョンアップ完了後、再びNpgsqlを入手するコマンドを実行すると以下の通り、Npgsqlの導入に成功します。</p>

<div class="code-frame" data-lang="">
<div class="code-lang"><span class="bold">NuGetによるNpgsqlの導入(失敗)</span></div>
<div class="highlight"><pre class="with-code"><code>PM&gt; Install-Package Npgsql -Version 4.0.3
依存関係 'System.Runtime.CompilerServices.Unsafe (≥ 4.5.0)' の解決を試みています。
依存関係 'System.Threading.Tasks.Extensions (≥ 4.5.0)' の解決を試みています。
依存関係 'System.ValueTuple (≥ 4.5.0)' の解決を試みています。
'System.Runtime.CompilerServices.Unsafe 4.5.0' をインストールしています。
'System.Runtime.CompilerServices.Unsafe 4.5.0' が正常にインストールされました。
'System.Threading.Tasks.Extensions 4.5.0' をインストールしています。
'System.Threading.Tasks.Extensions 4.5.0' が正常にインストールされました。
'System.ValueTuple 4.5.0' をインストールしています。
'System.ValueTuple 4.5.0' が正常にインストールされました。
'Npgsql 4.0.3' をインストールしています。
'Npgsql 4.0.3' が正常にインストールされました。
'System.Runtime.CompilerServices.Unsafe 4.5.0' を npgsql_test に追加しています。
'System.Runtime.CompilerServices.Unsafe 4.5.0' が npgsql_test に正常に追加されました。
'System.Threading.Tasks.Extensions 4.5.0' を npgsql_test に追加しています。
'System.Threading.Tasks.Extensions 4.5.0' が npgsql_test に正常に追加されました。
'System.ValueTuple 4.5.0' を npgsql_test に追加しています。
'System.ValueTuple 4.5.0' が npgsql_test に正常に追加されました。
'Npgsql 4.0.3' を npgsql_test に追加しています。
'Npgsql 4.0.3' が npgsql_test に正常に追加されました。
</code></pre></div>
</div>

<h1>
<span id="npgsqlによる単純な接続" class="fragment"></span><a href="#npgsql%E3%81%AB%E3%82%88%E3%82%8B%E5%8D%98%E7%B4%94%E3%81%AA%E6%8E%A5%E7%B6%9A"><i class="fa fa-link"></i></a>Npgsqlによる単純な接続</h1>

<p>まずは単純にPostgreSQLへ接続できるかを確認します。<br>
Visual StudioからC#の空のプロジェクトを作り、コードを書き込んでいきます。</p>

<h2>
<span id="下準備" class="fragment"></span><a href="#%E4%B8%8B%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>下準備</h2>

<p>C#のプロジェクトを生成後、下準備として参照の追加とPostgreSQL側の設定変更をします。</p>

<h3>
<span id="参照の追加" class="fragment"></span><a href="#%E5%8F%82%E7%85%A7%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>参照の追加</h3>

<p>デフォルトの参照設定ではNpgsqlの機能を使うことはできません。そのため参照を追加します。<br>
まずVisual Studioのメニューバーの[プロジェクト]→[参照の追加]を選択します。 その後、左メニューの[アセンブリ]→[フレームワーク]を選択し、"System.Data"と"System.Transaction"にチェックし、参照へ追加します。<br>
また単純な接続では必要ありませんが、SELECT結果取得の際に使用するDataTableのために"System.Xml"もチェックします。</p>

<h3>
<span id="postgresql側の設定" class="fragment"></span><a href="#postgresql%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>PostgreSQL側の設定</h3>

<p>C#アプリ側とPostgreSQLサーバ側が接続可能であるか、ping等で確かめます。<br>
(pingが通らない場合、ファイアウォールやOSのネットワーク設定を見直してください)</p>

<p>サーバ同士の通信が可能であることが判明した後は、PostgreSQLのネットワーク設定を調整します。<br>
PostgreSQLのデータディレクトリ(環境変数PGDATA配下)のpostgresql.confとpg_hba.confの2つの設定ファイルを次のように編集します。</p>

<div class="code-frame" data-lang="conf">
<div class="code-lang"><span class="bold">postgresql.conf</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">listen_addresses</span> = <span class="s1">'*'</span>
</code></pre></div>
</div>

<p>上記はPostgreSQL側の接続を受け付けるIPアドレスです。<br>
デフォルトでは"localhost"のみなため、"localhost, "または全てのIPで受け付ける"*"(アスタリスク)を設定します。<br>
詳細はマニュアルをご参照ください。</p>

<ul>
<li>19.3.1. 接続設定<br>
<a href="https://www.postgresql.jp/document/10/html/runtime-config-connection.html#GUC-LISTEN-ADDRESSES" class="autolink" rel="nofollow noopener" target="_blank">https://www.postgresql.jp/document/10/html/runtime-config-connection.html#GUC-LISTEN-ADDRESSES</a>
</li>
</ul>

<div class="code-frame" data-lang="conf">
<div class="code-lang"><span class="bold">pg_hba.conf</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c"># TYPE  DATABASE        USER            ADDRESS                 METHOD
</span><span class="n">host</span>    <span class="n">all</span>             <span class="n">all</span>             &lt;<span class="n">C</span><span class="c">#側のIP&gt;/32           md5
</span></code></pre></div>
</div>

<p>接続を許可するクライアント側(今回の場合はC#プログラム側)の設定です。<br>
接続先DB名や接続に用いるユーザ名も限定可能です。<br>
また「METHOD」に"md5"を指定することでパスワード入力のみ受け付けます。<br>
詳細はマニュアルをご参照ください。</p>

<ul>
<li>20.1. pg_hba.confファイル<br>
<a href="https://www.postgresql.jp/document/10/html/auth-pg-hba-conf.html" class="autolink" rel="nofollow noopener" target="_blank">https://www.postgresql.jp/document/10/html/auth-pg-hba-conf.html</a>
</li>
</ul>

<p>上記設定後、PostgreSQLの設定変更を反映するためにPostgreSQLを再起動します。<br>
※listen_addressesパラメータの反映には再起動が必要なためです。<br>
※pg_hba.confの変更反映はreloadのみで可能です。</p>

<h2>
<span id="npgsqlによる単純な接続の実行" class="fragment"></span><a href="#npgsql%E3%81%AB%E3%82%88%E3%82%8B%E5%8D%98%E7%B4%94%E3%81%AA%E6%8E%A5%E7%B6%9A%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>Npgsqlによる単純な接続の実行</h2>

<p>準備が完了したため、早速接続を試行します。<br>
今回作成するソースコードは次の通りです。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">Class1.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Npgsql</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">npgsql_test</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Class1</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//接続文字列</span>
            <span class="kt">string</span> <span class="n">conn_str</span> <span class="p">=</span> <span class="s">"Server=123.45.67.89;Port=5432;User ID=postgres;Database=postgres;Password=password;Enlist=true"</span><span class="p">;</span>

            <span class="k">using</span> <span class="p">(</span><span class="n">NpgsqlConnection</span> <span class="n">conn</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">conn_str</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">//PostgreSQLへ接続</span>
                <span class="n">conn</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Connection success!"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>※namespaceやclassは環境ごとに適切な名前にしてください。</p>

<p>接続文字列は以下の値を入力する必要があります。接続先の環境に合わせて設定下さい。</p>

<table>
<thead>
<tr>
<th>値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Server</td>
<td>接続先サーバのIP or ホスト名</td>
</tr>
<tr>
<td>Port</td>
<td>接続先DBのポート番号</td>
</tr>
<tr>
<td>User ID</td>
<td>DBへの接続ユーザ名</td>
</tr>
<tr>
<td>Database</td>
<td>接続先DB名</td>
</tr>
<tr>
<td>Password</td>
<td>DB接続のパスワード</td>
</tr>
<tr>
<td>Enlist</td>
<td>既存のトランザクションへの自動参加の有効/無効を設定(Ttue/False)</td>
</tr>
</tbody>
</table>

<p>上記を[ビルド]→[デバッグなしで開始]をすると、「Connection success!」の文字が標準出力されます。<br>
エラーが発生する場合、そのエラー内容を確認し、PostgreSQLやOSの接続設定に誤りがないか確認してください。</p>

<div class="code-frame" data-lang="">
<div class="code-lang"><span class="bold">成功時の標準出力</span></div>
<div class="highlight"><pre class="with-code"><code>Connection success!
</code></pre></div>
</div>

<h1>
<span id="transactionscopeの利用" class="fragment"></span><a href="#transactionscope%E3%81%AE%E5%88%A9%E7%94%A8"><i class="fa fa-link"></i></a>TransactionScopeの利用</h1>

<p>C#(.NET系)にはTransactionScopeという、トランザクションを一括管理する頼もしい機能があります。<br>
昔、Npgsql 3.0で検証した頃は、自身の環境のせいもありエラーが発生しましたが、最新版では問題なく使用できます。<br>
C#でSQL処理をする際は頻繁に使うため、Npgsqlでも適切に利用できることを確認します。</p>

<h2>
<span id="transactionscopeによるトランザクション管理" class="fragment"></span><a href="#transactionscope%E3%81%AB%E3%82%88%E3%82%8B%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86"><i class="fa fa-link"></i></a>TransactionScopeによるトランザクション管理</h2>

<p>今回はINSERT、DELETE、SELECT処理を1つのトランザクション内で実施します。<br>
検証に使用するテーブルは次の通りです。</p>

<div class="code-frame" data-lang="sql">
<div class="code-lang"><span class="bold">検証用テーブル</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">postgres</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">test</span> <span class="p">(</span><span class="n">col1</span> <span class="nb">INTEGER</span><span class="p">,</span> <span class="n">col2</span> <span class="nb">VARCHAR</span><span class="p">);</span>
<span class="n">postgres</span><span class="o">=#</span> <span class="err">\</span><span class="n">d</span> <span class="n">test</span>
                      <span class="err">テーブル</span> <span class="nv">"public.test"</span>
  <span class="err">列</span>  <span class="o">|</span>        <span class="err">型</span>         <span class="o">|</span> <span class="err">照合順序</span> <span class="o">|</span> <span class="k">Null</span> <span class="err">値を許容</span> <span class="o">|</span> <span class="err">デフォルト</span>
<span class="c1">------+-------------------+----------+---------------+------------</span>
 <span class="n">col1</span> <span class="o">|</span> <span class="nb">integer</span>           <span class="o">|</span>          <span class="o">|</span>               <span class="o">|</span>
 <span class="n">col2</span> <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span> <span class="o">|</span>          <span class="o">|</span>               <span class="o">|</span>
</code></pre></div>
</div>

<p>実際に上記のtestテーブルにSQLを実行したソースコードが以下です。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">Class1.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Npgsql</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Transactions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>


<span class="k">namespace</span> <span class="nn">npgsql_test</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Class1</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//SQL処理で用いる変数を予め宣言</span>
            <span class="n">NpgsqlCommand</span> <span class="n">cmd</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">cmd_str</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">DataTable</span> <span class="n">dt</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">NpgsqlDataAdapter</span> <span class="n">da</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

            <span class="c1">//接続文字列</span>
            <span class="kt">string</span> <span class="n">conn_str</span> <span class="p">=</span> <span class="s">"Server=123.45.67.89;Port=5432;User ID=postgres;Database=postgres;Password=password;Enlist=true"</span><span class="p">;</span>

            <span class="c1">//TransactionScopeの利用</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">TransactionScope</span> <span class="n">ts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TransactionScope</span><span class="p">())</span> 
            <span class="p">{</span>
                <span class="c1">//接続その1</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">NpgsqlConnection</span> <span class="n">conn</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">conn_str</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">//PostgreSQLへ接続後、INSERT、DELETE処理を実施し、SELECT結果を取得</span>
                    <span class="n">conn</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>

                    <span class="c1">//test対象のテーブルをリセット(全データDELETE)</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"DELETE FROM test"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>

                    <span class="c1">//INSERT処理</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"INSERT INTO test VALUES(1, 'AAA'), (2, 'BBB'), (3, 'CCC')"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>

                    <span class="c1">//DELETE処理</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"DELETE FROM test WHERE col1 % 2 = 0"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>

                    <span class="c1">//SELECT処理</span>
                    <span class="n">dt</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataTable</span><span class="p">();</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"SELECT * FROM test"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span>
                    <span class="n">da</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlDataAdapter</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
                    <span class="n">da</span><span class="p">.</span><span class="nf">Fill</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>

                    <span class="c1">//SELECT結果表示</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> 
                    <span class="p">{</span>
                        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"(col1, col2) = ("</span> <span class="p">+</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="m">0</span><span class="p">]</span> <span class="p">+</span> <span class="s">", "</span> <span class="p">+</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="m">1</span><span class="p">]</span> <span class="p">+</span> <span class="s">")"</span><span class="p">);</span>
                    <span class="p">}</span>

                <span class="p">}</span>
                <span class="c1">//トランザクション完了</span>
                <span class="n">ts</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>実行結果は以下の通りです。</p>

<div class="code-frame" data-lang="">
<div class="code-lang"><span class="bold">成功時の標準出力</span></div>
<div class="highlight"><pre class="with-code"><code>(col1, col2) = (1, AAA)
(col1, col2) = (3, CCC)
</code></pre></div>
</div>

<p>col1が1～3である行のINSERT後、偶数値の行だけ削除したため上記結果となります。<br>
PostgreSQLのパラメータを「log_statement = 'all'」した状態で上記のC#プログラムの実行ログを見ると以下のようになります。</p>

<div class="code-frame" data-lang="sql">
<div class="code-lang"><span class="bold">トランザクション処理の実行ログ</span></div>
<div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="mi">3830</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">BEGIN</span>
<span class="p">[</span><span class="mi">3830</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">SET</span> <span class="n">TRANSACTION</span> <span class="k">ISOLATION</span> <span class="k">LEVEL</span> <span class="k">SERIALIZABLE</span>
<span class="p">[</span><span class="mi">3830</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">test</span>
<span class="p">[</span><span class="mi">3830</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">test</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'AAA'</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'BBB'</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'CCC'</span><span class="p">)</span>
<span class="p">[</span><span class="mi">3830</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">test</span> <span class="k">WHERE</span> <span class="n">col1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span><span class="mi">3830</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test</span>
<span class="p">[</span><span class="mi">3830</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">COMMIT</span>
<span class="p">[</span><span class="mi">3830</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="n">DISCARD</span> <span class="k">ALL</span>
</code></pre></div>
</div>

<p>TransactionScopeにより「BEGIN」～「COMMIT」が実行され、暗黙的にトランザクションが管理されていることが分かります。</p>

<h2>
<span id="transactionscopeによる分散トランザクション" class="fragment"></span><a href="#transactionscope%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>TransactionScopeによる分散トランザクション</h2>

<p>TransactionScopeを用いることで分散トランザクションが容易に実行可能です。<br>
分散トランザクションは、複数のデータベースに対する処理を1つのトランザクションとして扱う技術です。</p>

<p>C#ではTransactionScopeを使うことで、意識することなく分散トランザクションを利用できます。<br>
今回の検証では</p>

<ul>
<li>test_db1データベースのtest1テーブルへのINSERT処理</li>
<li>test_db2データベースのtest2テーブルへのINSERT処理</li>
</ul>

<p>を分散トランザクションとして実施します。</p>

<h3>
<span id="分散トランザクションのための下準備" class="fragment"></span><a href="#%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E4%B8%8B%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>分散トランザクションのための下準備</h3>

<p>下準備としてPostgreSQL側の「max_prepared_transactions」パラメータを0より大きくする必要があります。<br>
(本パラメータは分散トランザクションにおける最大接続数を設定します。0の場合無効です)</p>

<div class="code-frame" data-lang="conf">
<div class="code-lang"><span class="bold">postgresql.conf</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">max_prepared_transactions</span> = <span class="m">10</span>
</code></pre></div>
</div>

<p>設定変更を反映するために、その後、PostgreSQLを再起動します。<br>
本パラメータの詳細はマニュアルをご参照ください。</p>

<ul>
<li>19.4.1. メモリ<br>
<a href="https://www.postgresql.jp/document/10/html/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS" class="autolink" rel="nofollow noopener" target="_blank">https://www.postgresql.jp/document/10/html/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS</a>
</li>
</ul>

<h3>
<span id="分散トランザクションの実施" class="fragment"></span><a href="#%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9F%E6%96%BD"><i class="fa fa-link"></i></a>分散トランザクションの実施</h3>

<p>準備が完了したため、以下のソースコードを記述し分散トランザクションを実行します。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">Class1.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Npgsql</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Transactions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>


<span class="k">namespace</span> <span class="nn">npgsql_test</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Class1</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//SQL処理で用いる変数を予め宣言</span>
            <span class="n">NpgsqlCommand</span> <span class="n">cmd</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">cmd_str</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">DataTable</span> <span class="n">dt</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">NpgsqlDataAdapter</span> <span class="n">da</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

            <span class="c1">//接続文字列</span>
            <span class="kt">string</span> <span class="n">conn_str1</span> <span class="p">=</span> <span class="s">"Server=192.168.56.111;Port=5432;User ID=postgres;Database=tes_db1;Password=password;Enlist=true"</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">conn_str2</span> <span class="p">=</span> <span class="s">"Server=192.168.56.111;Port=5432;User ID=postgres;Database=tes_db2;Password=password;Enlist=true"</span><span class="p">;</span>

            <span class="c1">//TransactionScopeの利用(分散トランザクション)</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">TransactionScope</span> <span class="n">ts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TransactionScope</span><span class="p">())</span> 
            <span class="p">{</span>
                <span class="c1">//接続その1(tes_db1へ接続)</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">NpgsqlConnection</span> <span class="n">conn1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">conn_str1</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">//PostgreSQLへ接続後、INSERT処理を実施し、SELECT結果を取得</span>
                    <span class="n">conn1</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>

                    <span class="c1">//test対象のテーブルをリセット(全データDELETE)</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"DELETE FROM test1"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn1</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>

                    <span class="c1">//INSERT処理</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"INSERT INTO test1 VALUES(1, 'AAA'), (2, 'BBB')"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn1</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>

                    <span class="c1">//SELECT処理</span>
                    <span class="n">dt</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataTable</span><span class="p">();</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"SELECT * FROM test1"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn1</span><span class="p">);</span>
                    <span class="n">da</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlDataAdapter</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
                    <span class="n">da</span><span class="p">.</span><span class="nf">Fill</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>

                    <span class="c1">//SELECT結果表示</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"tes_db1:"</span><span class="p">);</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                    <span class="p">{</span>
                        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"(col1, col2) = ("</span> <span class="p">+</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="m">0</span><span class="p">]</span> <span class="p">+</span> <span class="s">", "</span> <span class="p">+</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="m">1</span><span class="p">]</span> <span class="p">+</span> <span class="s">")"</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="c1">//接続その2(tes_db2へ接続)</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">NpgsqlConnection</span> <span class="n">conn2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">conn_str2</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">//PostgreSQLへ接続後、INSERT処理を実施し、SELECT結果を取得</span>
                    <span class="n">conn2</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>

                    <span class="c1">//test対象のテーブルをリセット(全データDELETE)</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"DELETE FROM test2"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn2</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>

                    <span class="c1">//INSERT処理</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"INSERT INTO test2 VALUES(3, 'ccc'), (4, 'ddd')"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn2</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>

                    <span class="c1">//SELECT処理</span>
                    <span class="n">dt</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataTable</span><span class="p">();</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"SELECT * FROM test2"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn2</span><span class="p">);</span>
                    <span class="n">da</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlDataAdapter</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
                    <span class="n">da</span><span class="p">.</span><span class="nf">Fill</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>

                    <span class="c1">//SELECT結果表示</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"tes_db2:"</span><span class="p">);</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> 
                    <span class="p">{</span>
                        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"(col1, col2) = ("</span> <span class="p">+</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="m">0</span><span class="p">]</span> <span class="p">+</span> <span class="s">", "</span> <span class="p">+</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="m">1</span><span class="p">]</span> <span class="p">+</span> <span class="s">")"</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="c1">//トランザクション完了</span>
                <span class="n">ts</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>実行結果は以下の通りです。</p>

<div class="code-frame" data-lang="">
<div class="code-lang"><span class="bold">成功時の標準出力</span></div>
<div class="highlight"><pre class="with-code"><code>tes_db1:
(col1, col2) = (1, AAA)
(col1, col2) = (2, BBB)
tes_db2:
(col1, col2) = (3, ccc)
(col1, col2) = (4, ddd)
</code></pre></div>
</div>

<p>また実行ログは以下の通りです。</p>

<div class="code-frame" data-lang="sql">
<div class="code-lang"><span class="bold">分散トランザクション処理の実行ログ</span></div>
<div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="mi">5368</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">BEGIN</span>
<span class="p">[</span><span class="mi">5368</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">SET</span> <span class="n">TRANSACTION</span> <span class="k">ISOLATION</span> <span class="k">LEVEL</span> <span class="k">SERIALIZABLE</span>
<span class="p">[</span><span class="mi">5368</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">test1</span>
<span class="p">[</span><span class="mi">5368</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">test1</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'AAA'</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'BBB'</span><span class="p">)</span>
<span class="p">[</span><span class="mi">5368</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test1</span>
<span class="err">…</span><span class="p">(</span><span class="err">中略</span><span class="p">)</span><span class="err">…</span>
<span class="p">[</span><span class="mi">5369</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">BEGIN</span>
<span class="p">[</span><span class="mi">5369</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">SET</span> <span class="n">TRANSACTION</span> <span class="k">ISOLATION</span> <span class="k">LEVEL</span> <span class="k">SERIALIZABLE</span>
<span class="p">[</span><span class="mi">5369</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">test2</span>
<span class="p">[</span><span class="mi">5369</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">test2</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'ccc'</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'ddd'</span><span class="p">)</span>
<span class="p">[</span><span class="mi">5369</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test2</span>
<span class="p">[</span><span class="mi">5368</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">PREPARE</span> <span class="n">TRANSACTION</span> <span class="s1">'00000000-0000-0000-0000-000000000000/5368'</span>
<span class="p">[</span><span class="mi">5369</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">PREPARE</span> <span class="n">TRANSACTION</span> <span class="s1">'00000000-0000-0000-0000-000000000000/5369'</span>
<span class="p">[</span><span class="mi">5368</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">COMMIT</span> <span class="n">PREPARED</span> <span class="s1">'00000000-0000-0000-0000-000000000000/5368'</span>
<span class="p">[</span><span class="mi">5369</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">COMMIT</span> <span class="n">PREPARED</span> <span class="s1">'00000000-0000-0000-0000-000000000000/5369'</span>
<span class="p">[</span><span class="mi">5368</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="n">DISCARD</span> <span class="k">ALL</span>
<span class="p">[</span><span class="mi">5369</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="n">DISCARD</span> <span class="k">ALL</span>
</code></pre></div>
</div>

<p>接続その1(tes_db1)はプロセス[5368]で、接続その2(tes_db2)はプロセス[5369]で処理され、分散トランザクションが実施されています。</p>

<h2>
<span id="同一dbへ複数回接続する場合のtransactionscopeの動き" class="fragment"></span><a href="#%E5%90%8C%E4%B8%80db%E3%81%B8%E8%A4%87%E6%95%B0%E5%9B%9E%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AEtransactionscope%E3%81%AE%E5%8B%95%E3%81%8D"><i class="fa fa-link"></i></a>同一DBへ複数回接続する場合のTransactionScopeの動き</h2>

<p>上記の通りTransacrionScopeは自動的に分散トランザクションを扱うことが可能です。<br>
しかし、1つのトランザクション内で同一のデータベースに対して、複数回接続した場合どうなるでしょうか。</p>

<p>コネクタやNpgsqlのバージョンによっては、分散トランザクションに昇格してしまいますが、最近のNpgsqlではちゃんと同一接続として扱ってくれます。</p>

<p>実際のソースコードは次の通りです。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">Class1.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">Npgsql</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Transactions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>


<span class="k">namespace</span> <span class="nn">npgsql_test</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Class1</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//SQL処理で用いる変数を予め宣言</span>
            <span class="n">NpgsqlCommand</span> <span class="n">cmd</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">cmd_str</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">DataTable</span> <span class="n">dt</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">NpgsqlDataAdapter</span> <span class="n">da</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

            <span class="c1">//接続文字列</span>
            <span class="kt">string</span> <span class="n">conn_str</span> <span class="p">=</span> <span class="s">"Server=123.45.67.89;Port=5432;User ID=postgres;Database=postgres;Password=password;Enlist=true"</span><span class="p">;</span>

            <span class="c1">//TransactionScopeの利用</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">TransactionScope</span> <span class="n">ts</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TransactionScope</span><span class="p">())</span> 
            <span class="p">{</span>
                <span class="c1">//接続その1</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">NpgsqlConnection</span> <span class="n">conn1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">conn_str</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">//PostgreSQLへ接続後、INSERT処理を実施</span>
                    <span class="n">conn1</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>

                    <span class="c1">//test対象のテーブルをリセット(全データDELETE)</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"DELETE FROM test"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn1</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>

                    <span class="c1">//INSERT処理</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"INSERT INTO test VALUES(1, 'AAA'), (2, 'BBB'), (3, 'CCC')"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn1</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="c1">//接続その2</span>
                <span class="k">using</span> <span class="p">(</span><span class="n">NpgsqlConnection</span> <span class="n">conn2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">conn_str</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="c1">//PostgreSQLへ接続後、DELETE処理を実施し、SELECT結果を取得</span>
                    <span class="n">conn2</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>

                    <span class="c1">//DELETE処理</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"DELETE FROM test WHERE col1 % 2 = 0"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn2</span><span class="p">);</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>

                    <span class="c1">//SELECT処理</span>
                    <span class="n">dt</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataTable</span><span class="p">();</span>
                    <span class="n">cmd_str</span> <span class="p">=</span> <span class="s">"SELECT * FROM test"</span><span class="p">;</span>
                    <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">conn2</span><span class="p">);</span>
                    <span class="n">da</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlDataAdapter</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
                    <span class="n">da</span><span class="p">.</span><span class="nf">Fill</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>

                    <span class="c1">//SELECT結果表示</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> 
                    <span class="p">{</span>
                        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"(col1, col2) = ("</span> <span class="p">+</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="m">0</span><span class="p">]</span> <span class="p">+</span> <span class="s">", "</span> <span class="p">+</span> <span class="n">dt</span><span class="p">.</span><span class="n">Rows</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="m">1</span><span class="p">]</span> <span class="p">+</span> <span class="s">")"</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="c1">//トランザクション完了</span>
                <span class="n">ts</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>上記のプログラムは、接続その1,2で同じDBへ接続しています(接続文字列が同一なため)。<br>
Npgsqlは賢いため、ログを見れば分かる通り、ログインしたまま一貫したトランザクション処理をしています。<br>
※古いNpgsql(3.2より古いバージョン?)では勝手に分散トランザクション扱いにし、エラーが発生する場合があります。</p>

<div class="code-frame" data-lang="sql">
<div class="code-lang"><span class="bold">同一データベースへの複数回接続のログ</span></div>
<div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="mi">5112</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">BEGIN</span>
<span class="p">[</span><span class="mi">5112</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">SET</span> <span class="n">TRANSACTION</span> <span class="k">ISOLATION</span> <span class="k">LEVEL</span> <span class="k">SERIALIZABLE</span>
<span class="p">[</span><span class="mi">5112</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">test</span>
<span class="p">[</span><span class="mi">5112</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">test</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'AAA'</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'BBB'</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'CCC'</span><span class="p">)</span>
<span class="p">[</span><span class="mi">5112</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">test</span> <span class="k">WHERE</span> <span class="n">col1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span><span class="mi">5112</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="o">&lt;</span><span class="k">unnamed</span><span class="o">&gt;</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">test</span>
<span class="p">[</span><span class="mi">5112</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="k">COMMIT</span>
<span class="p">[</span><span class="mi">5112</span><span class="p">]</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">statement</span><span class="p">:</span> <span class="n">DISCARD</span> <span class="k">ALL</span>
</code></pre></div>
</div>

<p>接続1,2の処理においてプロセス番号が共に[5112]であることから分かる通り、1回の接続でそのまま処理を実行しています。<br>
接続1,2でどちらもconnX.Open();を実行していますが、内部的には接続を使いまわしているようです。</p>

<h1>
<span id="参考にしたサイト" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%97%E3%81%9F%E3%82%B5%E3%82%A4%E3%83%88"><i class="fa fa-link"></i></a>参考にしたサイト</h1>

<h2>
<span id="net関連" class="fragment"></span><a href="#net%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>.NET関連</h2>

<ul>
<li><p><strong>.NET Blog</strong> Introducing .NET Standard<br>
<a href="https://blogs.msdn.microsoft.com/dotnet/2016/09/26/introducing-net-standard/" class="autolink" rel="nofollow noopener" target="_blank">https://blogs.msdn.microsoft.com/dotnet/2016/09/26/introducing-net-standard/</a><br>
.NET Standard、.NET Framework、.NET Core、Xamarinの関係性について図を交えて説明しています。<br>
MicrosoftのBlogなため、公式情報として重宝しました。</p></li>
<li><p><strong>.NET Standardとは</strong><br>
<a href="http://www.atmarkit.co.jp/ait/articles/1707/28/news033.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.atmarkit.co.jp/ait/articles/1707/28/news033.html</a><br>
.NET Standardについて分かりやすく解説された＠ITの記事です。<br>
.NET関連の情報を知る際にとても重宝しました。</p></li>
<li><p><strong>.NET Standard</strong><br>
<a href="https://docs.microsoft.com/ja-jp/dotnet/standard/net-standard" class="autolink" rel="nofollow noopener" target="_blank">https://docs.microsoft.com/ja-jp/dotnet/standard/net-standard</a><br>
Microsoftによる.NET Standardのバージョン毎にサポートする.NET関連の最小バージョンについて記載されています。</p></li>
<li><p><strong>.NET Frameworkのバージョンを整理する</strong><br>
<a href="http://www.atmarkit.co.jp/ait/articles/1211/16/news093.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.atmarkit.co.jp/ait/articles/1211/16/news093.html</a><br>
.NET Frameworkのバージョンと.NET Standardとの対応について分かりやすく解説された＠ITの記事です。<br>
環境対応について調査する際は、こちらの情報をよく参照しています。</p></li>
<li><p><strong>さいきんの.NETのこととかNuGetとかCoreとかよく分からないよねーって話</strong><br>
<a href="https://qiita.com/acple@github/items/e80bef939583fc2b0e5e" class="autolink" id="reference-8af8b86bf09725615d3a">https://qiita.com/acple@github/items/e80bef939583fc2b0e5e</a><br>
.NET関連の用語を整理し、分かりやすく解説されたQiitaの記事です。<br>
各種.NETの概要と関係性について理解する上で非常に役立ちました。</p></li>
</ul>

<h2>
<span id="npgsql関連" class="fragment"></span><a href="#npgsql%E9%96%A2%E9%80%A3"><i class="fa fa-link"></i></a>Npgsql関連</h2>

<ul>
<li><p><strong>Npgsql - .NET Access to PostgreSQL</strong><br>
<a href="https://www.npgsql.org/index.html" class="autolink" rel="nofollow noopener" target="_blank">https://www.npgsql.org/index.html</a><br>
Npgsqlの公式サイトです。Npgsqlの詳細を知りたい場合はまずはこちらから。</p></li>
<li><p><strong>System.Transactionsサポート</strong><br>
<a href="http://vdlz.xyz/Csharp/Database/Postgre/Npgsql/Doc/Npgsql_Doc_020.html" class="autolink" rel="nofollow noopener" target="_blank">http://vdlz.xyz/Csharp/Database/Postgre/Npgsql/Doc/Npgsql_Doc_020.html</a><br>
少し古い情報ですが、TransactionScopeを使ったNpgsqlのソースコード例が載っています。<br>
今回のソースコード作成の際に、参考にさせていただきました。</p></li>
<li><p><strong>トランザクション スコープを使用した暗黙的なトランザクションの実装</strong><br>
<a href="https://docs.microsoft.com/ja-jp/dotnet/framework/data/transactions/implementing-an-implicit-transaction-using-transaction-scope" class="autolink" rel="nofollow noopener" target="_blank">https://docs.microsoft.com/ja-jp/dotnet/framework/data/transactions/implementing-an-implicit-transaction-using-transaction-scope</a><br>
Npgsqlの情報ではないですが参考として。<br>
MicrosoftのTransactionScopeによる暗黙的なトランザクションの解説とソースコードの例が載っています。<br>
こちらもソースコード作成の際に、参考にさせていただきました。</p></li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fmimitaro%2Fitems%2Ffde451da2f722fe12072&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fmimitaro%2Fitems%2Ffde451da2f722fe12072&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mimitaro/items/fde451da2f722fe12072/likers" class="css-1iupg5d">27</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">38</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/fde451da2f722fe12072/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mimitaro/items/fde451da2f722fe12072/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mimitaro/items/fde451da2f722fe12072/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mimitaro/items/fde451da2f722fe12072/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mimitaro/items/fde451da2f722fe12072.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-4d777a1a-0ee5-4b6f-868e-8b35a16b8551">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-603069b3-b7c8-4a33-8008-25232d883a39"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-603069b3-b7c8-4a33-8008-25232d883a39">{}</script>
      
<div id="LoginModal-react-component-8d403715-5b7b-49fb-a9b6-001b13992717"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-8d403715-5b7b-49fb-a9b6-001b13992717">{}</script>
      
<div id="StockModal-react-component-fe64ab89-7809-45ff-ba23-b4a4bd31e069"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-fe64ab89-7809-45ff-ba23-b4a4bd31e069">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;1zE0n2bUinQLA4H0Hly1QAeafpRqYGqGTeEJhwQ0SBTBgUiKem1cOnRb6D5i8KyyuG+urDvxCPx+OMR1el1vDg==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003e今更ながら\u003ca href=\"https://qiita.com/mimitaro/items/7628c86ad8c69dfd3f03\" id=\"reference-9f290b49228af4272039\"\u003eJava\u003c/a\u003eに引き続き、色んな言語からPostgreSQLへ接続するシリーズです。\u003cbr\u003e\n今回はC#(.NET系)です。C#はODBC接続などの方法もありますが、今回はNpgsqlによる接続を説明します。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"npgsqlとは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#npgsql%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNpgsqlとは\u003c/h1\u003e\n\n\u003cp\u003e.NET環境からPostgreSQLへ接続するためのツールです。\u003cbr\u003e\n今回は以下の環境でNpgsqlの導入と検証をしました。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e環境\u003c/th\u003e\n\u003cth\u003eバージョン\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eOS\u003c/td\u003e\n\u003ctd\u003eWindows 10\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e.NET Framework\u003c/td\u003e\n\u003ctd\u003e4.5\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eVisual Studio\u003c/td\u003e\n\u003ctd\u003e2013\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eNpgsql\u003c/td\u003e\n\u003ctd\u003e4.0.3\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ePostgreSQL\u003c/td\u003e\n\u003ctd\u003e10.0\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e実際に使用する場合、.NET、Visual Studio、Npgsqlのバージョンを各々考慮する必要があります。\u003cbr\u003e\nただ結論を述べると注意すべき点は以下の通りです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eVisual Studio 2013(特に.NET 4.5.X)を使っている場合、サポートが切れている上に、古いNpgsqlだとバグがあるため注意する。\u003c/strong\u003e\u003cbr\u003e(該当する.NET 4.5.Xに対応した最新のNpgsqlを必ず用いる)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e次期バージョンのNpgsql 4.1からは、.NET 4.5.2と.NET Standard 2.0がサポートされる最低バージョンとなる。\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e最新版のVisual Studio上で、最新の.NET Frameworkを選択し、最新のNpgsqlを用いれば問題ない\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eそもそも.NET Frameworkと.NET Standardって何? となった方(私はなった)や、詳細な各環境の対応を知りたい方は\u003ca href=\"#net%E9%96%A2%E9%80%A3\"\u003e参考にしたサイトの.NET関連\u003c/a\u003eをご参照ください。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"npgsqlの導入\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#npgsql%E3%81%AE%E5%B0%8E%E5%85%A5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNpgsqlの導入\u003c/h2\u003e\n\n\u003cp\u003eNpgsqlはNuGetを用いて導入可能です。以下のサイトから最新版を確認し、インストール用のコマンドをコピーします。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eNpgsql\u003cbr\u003e\n\u003ca href=\"https://www.nuget.org/packages/Npgsql/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.nuget.org/packages/Npgsql/\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eその後、Visual Studioを開き、メニューバーの[ツール]→[NuGetパッケージマネージャ]→[パッケージマネージャコンソール]を選択する。\u003cbr\u003e\nするとVisual Studioの下部に、PM(パッケージマネージャ)コンソールが開くため、先程コピーしたコマンドを入力し、結果を確認する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eNuGetによるNpgsqlの導入(失敗)\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ePM\u0026gt; Install-Package Npgsql -Version 4.0.3\n依存関係 'System.Runtime.CompilerServices.Unsafe (≥ 4.5.0)' の解決を試みています。\nInstall-Package : 'System.Runtime.CompilerServices.Unsafe 4.5.0' パッケージには NuGet クライアント バージョン '2.12' 以降が必要ですが、現在の NuGet バージョンは '2.8.60610.756' です。\n発生場所 行:1 文字:1\n+ Install-Package Npgsql -Version 4.0.3\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n    + CategoryInfo          : NotSpecified: (:) [Install-Package], NuGetVersionNotSatisfiedException\n    + FullyQualifiedErrorId : NuGetCmdletUnhandledException,NuGet.PowerShell.Commands.InstallPackageCommand\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e今回はNuGetのバージョンが古いため失敗しました。\u003cbr\u003e\nそのためNuGetをバージョンアップします。\u003cbr\u003e\nメニューバーの[ツール]→[拡張機能と更新プログラム]→左メニューから[更新プログラム]の[Visutal Studioギャラリー]を選択します。\u003cbr\u003e\nNuGetの[更新]をクリックし、インストール後、案内されるままVisutal Studioを再起動します。\u003c/p\u003e\n\n\u003cp\u003eバージョンアップ完了後、再びNpgsqlを入手するコマンドを実行すると以下の通り、Npgsqlの導入に成功します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eNuGetによるNpgsqlの導入(失敗)\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ePM\u0026gt; Install-Package Npgsql -Version 4.0.3\n依存関係 'System.Runtime.CompilerServices.Unsafe (≥ 4.5.0)' の解決を試みています。\n依存関係 'System.Threading.Tasks.Extensions (≥ 4.5.0)' の解決を試みています。\n依存関係 'System.ValueTuple (≥ 4.5.0)' の解決を試みています。\n'System.Runtime.CompilerServices.Unsafe 4.5.0' をインストールしています。\n'System.Runtime.CompilerServices.Unsafe 4.5.0' が正常にインストールされました。\n'System.Threading.Tasks.Extensions 4.5.0' をインストールしています。\n'System.Threading.Tasks.Extensions 4.5.0' が正常にインストールされました。\n'System.ValueTuple 4.5.0' をインストールしています。\n'System.ValueTuple 4.5.0' が正常にインストールされました。\n'Npgsql 4.0.3' をインストールしています。\n'Npgsql 4.0.3' が正常にインストールされました。\n'System.Runtime.CompilerServices.Unsafe 4.5.0' を npgsql_test に追加しています。\n'System.Runtime.CompilerServices.Unsafe 4.5.0' が npgsql_test に正常に追加されました。\n'System.Threading.Tasks.Extensions 4.5.0' を npgsql_test に追加しています。\n'System.Threading.Tasks.Extensions 4.5.0' が npgsql_test に正常に追加されました。\n'System.ValueTuple 4.5.0' を npgsql_test に追加しています。\n'System.ValueTuple 4.5.0' が npgsql_test に正常に追加されました。\n'Npgsql 4.0.3' を npgsql_test に追加しています。\n'Npgsql 4.0.3' が npgsql_test に正常に追加されました。\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"npgsqlによる単純な接続\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#npgsql%E3%81%AB%E3%82%88%E3%82%8B%E5%8D%98%E7%B4%94%E3%81%AA%E6%8E%A5%E7%B6%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNpgsqlによる単純な接続\u003c/h1\u003e\n\n\u003cp\u003eまずは単純にPostgreSQLへ接続できるかを確認します。\u003cbr\u003e\nVisual StudioからC#の空のプロジェクトを作り、コードを書き込んでいきます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"下準備\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%8B%E6%BA%96%E5%82%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e下準備\u003c/h2\u003e\n\n\u003cp\u003eC#のプロジェクトを生成後、下準備として参照の追加とPostgreSQL側の設定変更をします。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"参照の追加\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E7%85%A7%E3%81%AE%E8%BF%BD%E5%8A%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参照の追加\u003c/h3\u003e\n\n\u003cp\u003eデフォルトの参照設定ではNpgsqlの機能を使うことはできません。そのため参照を追加します。\u003cbr\u003e\nまずVisual Studioのメニューバーの[プロジェクト]→[参照の追加]を選択します。 その後、左メニューの[アセンブリ]→[フレームワーク]を選択し、\"System.Data\"と\"System.Transaction\"にチェックし、参照へ追加します。\u003cbr\u003e\nまた単純な接続では必要ありませんが、SELECT結果取得の際に使用するDataTableのために\"System.Xml\"もチェックします。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"postgresql側の設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#postgresql%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ePostgreSQL側の設定\u003c/h3\u003e\n\n\u003cp\u003eC#アプリ側とPostgreSQLサーバ側が接続可能であるか、ping等で確かめます。\u003cbr\u003e\n(pingが通らない場合、ファイアウォールやOSのネットワーク設定を見直してください)\u003c/p\u003e\n\n\u003cp\u003eサーバ同士の通信が可能であることが判明した後は、PostgreSQLのネットワーク設定を調整します。\u003cbr\u003e\nPostgreSQLのデータディレクトリ(環境変数PGDATA配下)のpostgresql.confとpg_hba.confの2つの設定ファイルを次のように編集します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"conf\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003epostgresql.conf\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003elisten_addresses\u003c/span\u003e = \u003cspan class=\"s1\"\u003e'*'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e上記はPostgreSQL側の接続を受け付けるIPアドレスです。\u003cbr\u003e\nデフォルトでは\"localhost\"のみなため、\"localhost, \"または全てのIPで受け付ける\"*\"(アスタリスク)を設定します。\u003cbr\u003e\n詳細はマニュアルをご参照ください。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e19.3.1. 接続設定\u003cbr\u003e\n\u003ca href=\"https://www.postgresql.jp/document/10/html/runtime-config-connection.html#GUC-LISTEN-ADDRESSES\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.postgresql.jp/document/10/html/runtime-config-connection.html#GUC-LISTEN-ADDRESSES\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"conf\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003epg_hba.conf\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# TYPE  DATABASE        USER            ADDRESS                 METHOD\n\u003c/span\u003e\u003cspan class=\"n\"\u003ehost\u003c/span\u003e    \u003cspan class=\"n\"\u003eall\u003c/span\u003e             \u003cspan class=\"n\"\u003eall\u003c/span\u003e             \u0026lt;\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"c\"\u003e#側のIP\u0026gt;/32           md5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e接続を許可するクライアント側(今回の場合はC#プログラム側)の設定です。\u003cbr\u003e\n接続先DB名や接続に用いるユーザ名も限定可能です。\u003cbr\u003e\nまた「METHOD」に\"md5\"を指定することでパスワード入力のみ受け付けます。\u003cbr\u003e\n詳細はマニュアルをご参照ください。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e20.1. pg_hba.confファイル\u003cbr\u003e\n\u003ca href=\"https://www.postgresql.jp/document/10/html/auth-pg-hba-conf.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.postgresql.jp/document/10/html/auth-pg-hba-conf.html\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e上記設定後、PostgreSQLの設定変更を反映するためにPostgreSQLを再起動します。\u003cbr\u003e\n※listen_addressesパラメータの反映には再起動が必要なためです。\u003cbr\u003e\n※pg_hba.confの変更反映はreloadのみで可能です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"npgsqlによる単純な接続の実行\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#npgsql%E3%81%AB%E3%82%88%E3%82%8B%E5%8D%98%E7%B4%94%E3%81%AA%E6%8E%A5%E7%B6%9A%E3%81%AE%E5%AE%9F%E8%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNpgsqlによる単純な接続の実行\u003c/h2\u003e\n\n\u003cp\u003e準備が完了したため、早速接続を試行します。\u003cbr\u003e\n今回作成するソースコードは次の通りです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eClass1.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNpgsql\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003enpgsql_test\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eClass1\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//接続文字列\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003econn_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Server=123.45.67.89;Port=5432;User ID=postgres;Database=postgres;Password=password;Enlist=true\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn_str\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//PostgreSQLへ接続\u003c/span\u003e\n                \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Connection success!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e※namespaceやclassは環境ごとに適切な名前にしてください。\u003c/p\u003e\n\n\u003cp\u003e接続文字列は以下の値を入力する必要があります。接続先の環境に合わせて設定下さい。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e値\u003c/th\u003e\n\u003cth\u003e説明\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eServer\u003c/td\u003e\n\u003ctd\u003e接続先サーバのIP or ホスト名\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ePort\u003c/td\u003e\n\u003ctd\u003e接続先DBのポート番号\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eUser ID\u003c/td\u003e\n\u003ctd\u003eDBへの接続ユーザ名\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eDatabase\u003c/td\u003e\n\u003ctd\u003e接続先DB名\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ePassword\u003c/td\u003e\n\u003ctd\u003eDB接続のパスワード\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eEnlist\u003c/td\u003e\n\u003ctd\u003e既存のトランザクションへの自動参加の有効/無効を設定(Ttue/False)\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e上記を[ビルド]→[デバッグなしで開始]をすると、「Connection success!」の文字が標準出力されます。\u003cbr\u003e\nエラーが発生する場合、そのエラー内容を確認し、PostgreSQLやOSの接続設定に誤りがないか確認してください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e成功時の標準出力\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eConnection success!\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"transactionscopeの利用\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#transactionscope%E3%81%AE%E5%88%A9%E7%94%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTransactionScopeの利用\u003c/h1\u003e\n\n\u003cp\u003eC#(.NET系)にはTransactionScopeという、トランザクションを一括管理する頼もしい機能があります。\u003cbr\u003e\n昔、Npgsql 3.0で検証した頃は、自身の環境のせいもありエラーが発生しましたが、最新版では問題なく使用できます。\u003cbr\u003e\nC#でSQL処理をする際は頻繁に使うため、Npgsqlでも適切に利用できることを確認します。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"transactionscopeによるトランザクション管理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#transactionscope%E3%81%AB%E3%82%88%E3%82%8B%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTransactionScopeによるトランザクション管理\u003c/h2\u003e\n\n\u003cp\u003e今回はINSERT、DELETE、SELECT処理を1つのトランザクション内で実施します。\u003cbr\u003e\n検証に使用するテーブルは次の通りです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"sql\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e検証用テーブル\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003epostgres\u003c/span\u003e\u003cspan class=\"o\"\u003e=#\u003c/span\u003e \u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecol1\u003c/span\u003e \u003cspan class=\"nb\"\u003eINTEGER\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecol2\u003c/span\u003e \u003cspan class=\"nb\"\u003eVARCHAR\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003epostgres\u003c/span\u003e\u003cspan class=\"o\"\u003e=#\u003c/span\u003e \u003cspan class=\"err\"\u003e\\\u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e\n                      \u003cspan class=\"err\"\u003eテーブル\u003c/span\u003e \u003cspan class=\"nv\"\u003e\"public.test\"\u003c/span\u003e\n  \u003cspan class=\"err\"\u003e列\u003c/span\u003e  \u003cspan class=\"o\"\u003e|\u003c/span\u003e        \u003cspan class=\"err\"\u003e型\u003c/span\u003e         \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"err\"\u003e照合順序\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"k\"\u003eNull\u003c/span\u003e \u003cspan class=\"err\"\u003e値を許容\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"err\"\u003eデフォルト\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e------+-------------------+----------+---------------+------------\u003c/span\u003e\n \u003cspan class=\"n\"\u003ecol1\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"nb\"\u003einteger\u003c/span\u003e           \u003cspan class=\"o\"\u003e|\u003c/span\u003e          \u003cspan class=\"o\"\u003e|\u003c/span\u003e               \u003cspan class=\"o\"\u003e|\u003c/span\u003e\n \u003cspan class=\"n\"\u003ecol2\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"nb\"\u003echaracter\u003c/span\u003e \u003cspan class=\"nb\"\u003evarying\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e          \u003cspan class=\"o\"\u003e|\u003c/span\u003e               \u003cspan class=\"o\"\u003e|\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e実際に上記のtestテーブルにSQLを実行したソースコードが以下です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eClass1.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNpgsql\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Transactions\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Data\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003enpgsql_test\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eClass1\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//SQL処理で用いる変数を予め宣言\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNpgsqlCommand\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDataTable\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNpgsqlDataAdapter\u003c/span\u003e \u003cspan class=\"n\"\u003eda\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//接続文字列\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003econn_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Server=123.45.67.89;Port=5432;User ID=postgres;Database=postgres;Password=password;Enlist=true\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//TransactionScopeの利用\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTransactionScope\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eTransactionScope\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//接続その1\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn_str\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//PostgreSQLへ接続後、INSERT、DELETE処理を実施し、SELECT結果を取得\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//test対象のテーブルをリセット(全データDELETE)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"DELETE FROM test\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//INSERT処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"INSERT INTO test VALUES(1, 'AAA'), (2, 'BBB'), (3, 'CCC')\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//DELETE処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"DELETE FROM test WHERE col1 % 2 = 0\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//SELECT処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003edt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDataTable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"SELECT * FROM test\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eda\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlDataAdapter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eda\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFill\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//SELECT結果表示\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"(col1, col2) = (\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\", \"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\")\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//トランザクション完了\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e実行結果は以下の通りです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e成功時の標準出力\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e(col1, col2) = (1, AAA)\n(col1, col2) = (3, CCC)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003ecol1が1～3である行のINSERT後、偶数値の行だけ削除したため上記結果となります。\u003cbr\u003e\nPostgreSQLのパラメータを「log_statement = 'all'」した状態で上記のC#プログラムの実行ログを見ると以下のようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"sql\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eトランザクション処理の実行ログ\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3830\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eBEGIN\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3830\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eSET\u003c/span\u003e \u003cspan class=\"n\"\u003eTRANSACTION\u003c/span\u003e \u003cspan class=\"k\"\u003eISOLATION\u003c/span\u003e \u003cspan class=\"k\"\u003eLEVEL\u003c/span\u003e \u003cspan class=\"k\"\u003eSERIALIZABLE\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3830\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eDELETE\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3830\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"k\"\u003eINTO\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e \u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'AAA'\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'BBB'\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'CCC'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3830\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eDELETE\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e \u003cspan class=\"k\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"n\"\u003ecol1\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3830\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3830\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eCOMMIT\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3830\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eDISCARD\u003c/span\u003e \u003cspan class=\"k\"\u003eALL\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eTransactionScopeにより「BEGIN」～「COMMIT」が実行され、暗黙的にトランザクションが管理されていることが分かります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"transactionscopeによる分散トランザクション\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#transactionscope%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTransactionScopeによる分散トランザクション\u003c/h2\u003e\n\n\u003cp\u003eTransactionScopeを用いることで分散トランザクションが容易に実行可能です。\u003cbr\u003e\n分散トランザクションは、複数のデータベースに対する処理を1つのトランザクションとして扱う技術です。\u003c/p\u003e\n\n\u003cp\u003eC#ではTransactionScopeを使うことで、意識することなく分散トランザクションを利用できます。\u003cbr\u003e\n今回の検証では\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003etest_db1データベースのtest1テーブルへのINSERT処理\u003c/li\u003e\n\u003cli\u003etest_db2データベースのtest2テーブルへのINSERT処理\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eを分散トランザクションとして実施します。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"分散トランザクションのための下準備\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E4%B8%8B%E6%BA%96%E5%82%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e分散トランザクションのための下準備\u003c/h3\u003e\n\n\u003cp\u003e下準備としてPostgreSQL側の「max_prepared_transactions」パラメータを0より大きくする必要があります。\u003cbr\u003e\n(本パラメータは分散トランザクションにおける最大接続数を設定します。0の場合無効です)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"conf\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003epostgresql.conf\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003emax_prepared_transactions\u003c/span\u003e = \u003cspan class=\"m\"\u003e10\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e設定変更を反映するために、その後、PostgreSQLを再起動します。\u003cbr\u003e\n本パラメータの詳細はマニュアルをご参照ください。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e19.4.1. メモリ\u003cbr\u003e\n\u003ca href=\"https://www.postgresql.jp/document/10/html/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.postgresql.jp/document/10/html/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"分散トランザクションの実施\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9F%E6%96%BD\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e分散トランザクションの実施\u003c/h3\u003e\n\n\u003cp\u003e準備が完了したため、以下のソースコードを記述し分散トランザクションを実行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eClass1.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNpgsql\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Transactions\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Data\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003enpgsql_test\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eClass1\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//SQL処理で用いる変数を予め宣言\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNpgsqlCommand\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDataTable\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNpgsqlDataAdapter\u003c/span\u003e \u003cspan class=\"n\"\u003eda\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//接続文字列\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003econn_str1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Server=192.168.56.111;Port=5432;User ID=postgres;Database=tes_db1;Password=password;Enlist=true\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003econn_str2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Server=192.168.56.111;Port=5432;User ID=postgres;Database=tes_db2;Password=password;Enlist=true\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//TransactionScopeの利用(分散トランザクション)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTransactionScope\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eTransactionScope\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//接続その1(tes_db1へ接続)\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn_str1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//PostgreSQLへ接続後、INSERT処理を実施し、SELECT結果を取得\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003econn1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//test対象のテーブルをリセット(全データDELETE)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"DELETE FROM test1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//INSERT処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"INSERT INTO test1 VALUES(1, 'AAA'), (2, 'BBB')\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//SELECT処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003edt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDataTable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"SELECT * FROM test1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eda\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlDataAdapter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eda\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFill\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//SELECT結果表示\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"tes_db1:\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"(col1, col2) = (\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\", \"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\")\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//接続その2(tes_db2へ接続)\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn_str2\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//PostgreSQLへ接続後、INSERT処理を実施し、SELECT結果を取得\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003econn2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//test対象のテーブルをリセット(全データDELETE)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"DELETE FROM test2\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//INSERT処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"INSERT INTO test2 VALUES(3, 'ccc'), (4, 'ddd')\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//SELECT処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003edt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDataTable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"SELECT * FROM test2\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eda\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlDataAdapter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eda\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFill\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//SELECT結果表示\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"tes_db2:\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"(col1, col2) = (\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\", \"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\")\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//トランザクション完了\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e実行結果は以下の通りです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e成功時の標準出力\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003etes_db1:\n(col1, col2) = (1, AAA)\n(col1, col2) = (2, BBB)\ntes_db2:\n(col1, col2) = (3, ccc)\n(col1, col2) = (4, ddd)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eまた実行ログは以下の通りです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"sql\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e分散トランザクション処理の実行ログ\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5368\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eBEGIN\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5368\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eSET\u003c/span\u003e \u003cspan class=\"n\"\u003eTRANSACTION\u003c/span\u003e \u003cspan class=\"k\"\u003eISOLATION\u003c/span\u003e \u003cspan class=\"k\"\u003eLEVEL\u003c/span\u003e \u003cspan class=\"k\"\u003eSERIALIZABLE\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5368\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eDELETE\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5368\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"k\"\u003eINTO\u003c/span\u003e \u003cspan class=\"n\"\u003etest1\u003c/span\u003e \u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'AAA'\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'BBB'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5368\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest1\u003c/span\u003e\n\u003cspan class=\"err\"\u003e…\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"err\"\u003e中略\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"err\"\u003e…\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5369\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eBEGIN\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5369\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eSET\u003c/span\u003e \u003cspan class=\"n\"\u003eTRANSACTION\u003c/span\u003e \u003cspan class=\"k\"\u003eISOLATION\u003c/span\u003e \u003cspan class=\"k\"\u003eLEVEL\u003c/span\u003e \u003cspan class=\"k\"\u003eSERIALIZABLE\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5369\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eDELETE\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest2\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5369\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"k\"\u003eINTO\u003c/span\u003e \u003cspan class=\"n\"\u003etest2\u003c/span\u003e \u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'ccc'\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'ddd'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5369\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest2\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5368\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ePREPARE\u003c/span\u003e \u003cspan class=\"n\"\u003eTRANSACTION\u003c/span\u003e \u003cspan class=\"s1\"\u003e'00000000-0000-0000-0000-000000000000/5368'\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5369\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ePREPARE\u003c/span\u003e \u003cspan class=\"n\"\u003eTRANSACTION\u003c/span\u003e \u003cspan class=\"s1\"\u003e'00000000-0000-0000-0000-000000000000/5369'\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5368\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eCOMMIT\u003c/span\u003e \u003cspan class=\"n\"\u003ePREPARED\u003c/span\u003e \u003cspan class=\"s1\"\u003e'00000000-0000-0000-0000-000000000000/5368'\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5369\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eCOMMIT\u003c/span\u003e \u003cspan class=\"n\"\u003ePREPARED\u003c/span\u003e \u003cspan class=\"s1\"\u003e'00000000-0000-0000-0000-000000000000/5369'\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5368\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eDISCARD\u003c/span\u003e \u003cspan class=\"k\"\u003eALL\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5369\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eDISCARD\u003c/span\u003e \u003cspan class=\"k\"\u003eALL\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e接続その1(tes_db1)はプロセス[5368]で、接続その2(tes_db2)はプロセス[5369]で処理され、分散トランザクションが実施されています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"同一dbへ複数回接続する場合のtransactionscopeの動き\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%90%8C%E4%B8%80db%E3%81%B8%E8%A4%87%E6%95%B0%E5%9B%9E%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AEtransactionscope%E3%81%AE%E5%8B%95%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e同一DBへ複数回接続する場合のTransactionScopeの動き\u003c/h2\u003e\n\n\u003cp\u003e上記の通りTransacrionScopeは自動的に分散トランザクションを扱うことが可能です。\u003cbr\u003e\nしかし、1つのトランザクション内で同一のデータベースに対して、複数回接続した場合どうなるでしょうか。\u003c/p\u003e\n\n\u003cp\u003eコネクタやNpgsqlのバージョンによっては、分散トランザクションに昇格してしまいますが、最近のNpgsqlではちゃんと同一接続として扱ってくれます。\u003c/p\u003e\n\n\u003cp\u003e実際のソースコードは次の通りです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eClass1.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNpgsql\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Transactions\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Data\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003enpgsql_test\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eClass1\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//SQL処理で用いる変数を予め宣言\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNpgsqlCommand\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDataTable\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNpgsqlDataAdapter\u003c/span\u003e \u003cspan class=\"n\"\u003eda\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//接続文字列\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003econn_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Server=123.45.67.89;Port=5432;User ID=postgres;Database=postgres;Password=password;Enlist=true\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//TransactionScopeの利用\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTransactionScope\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eTransactionScope\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//接続その1\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn_str\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//PostgreSQLへ接続後、INSERT処理を実施\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003econn1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//test対象のテーブルをリセット(全データDELETE)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"DELETE FROM test\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//INSERT処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"INSERT INTO test VALUES(1, 'AAA'), (2, 'BBB'), (3, 'CCC')\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//接続その2\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn_str\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//PostgreSQLへ接続後、DELETE処理を実施し、SELECT結果を取得\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003econn2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//DELETE処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"DELETE FROM test WHERE col1 % 2 = 0\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//SELECT処理\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003edt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDataTable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"SELECT * FROM test\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd_str\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econn2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eda\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlDataAdapter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eda\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFill\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//SELECT結果表示\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"(col1, col2) = (\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\", \"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003edt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRows\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\")\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//トランザクション完了\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e上記のプログラムは、接続その1,2で同じDBへ接続しています(接続文字列が同一なため)。\u003cbr\u003e\nNpgsqlは賢いため、ログを見れば分かる通り、ログインしたまま一貫したトランザクション処理をしています。\u003cbr\u003e\n※古いNpgsql(3.2より古いバージョン?)では勝手に分散トランザクション扱いにし、エラーが発生する場合があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"sql\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e同一データベースへの複数回接続のログ\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5112\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eBEGIN\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5112\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eSET\u003c/span\u003e \u003cspan class=\"n\"\u003eTRANSACTION\u003c/span\u003e \u003cspan class=\"k\"\u003eISOLATION\u003c/span\u003e \u003cspan class=\"k\"\u003eLEVEL\u003c/span\u003e \u003cspan class=\"k\"\u003eSERIALIZABLE\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5112\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eDELETE\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5112\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eINSERT\u003c/span\u003e \u003cspan class=\"k\"\u003eINTO\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e \u003cspan class=\"k\"\u003eVALUES\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'AAA'\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'BBB'\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e'CCC'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5112\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eDELETE\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e \u003cspan class=\"k\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"n\"\u003ecol1\u003c/span\u003e \u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5112\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003eexecute\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003eunnamed\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003etest\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5112\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eCOMMIT\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5112\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"k\"\u003estatement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eDISCARD\u003c/span\u003e \u003cspan class=\"k\"\u003eALL\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e接続1,2の処理においてプロセス番号が共に[5112]であることから分かる通り、1回の接続でそのまま処理を実行しています。\u003cbr\u003e\n接続1,2でどちらもconnX.Open();を実行していますが、内部的には接続を使いまわしているようです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"参考にしたサイト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%97%E3%81%9F%E3%82%B5%E3%82%A4%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考にしたサイト\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"net関連\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#net%E9%96%A2%E9%80%A3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e.NET関連\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003e.NET Blog\u003c/strong\u003e Introducing .NET Standard\u003cbr\u003e\n\u003ca href=\"https://blogs.msdn.microsoft.com/dotnet/2016/09/26/introducing-net-standard/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://blogs.msdn.microsoft.com/dotnet/2016/09/26/introducing-net-standard/\u003c/a\u003e\u003cbr\u003e\n.NET Standard、.NET Framework、.NET Core、Xamarinの関係性について図を交えて説明しています。\u003cbr\u003e\nMicrosoftのBlogなため、公式情報として重宝しました。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003e.NET Standardとは\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"http://www.atmarkit.co.jp/ait/articles/1707/28/news033.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://www.atmarkit.co.jp/ait/articles/1707/28/news033.html\u003c/a\u003e\u003cbr\u003e\n.NET Standardについて分かりやすく解説された＠ITの記事です。\u003cbr\u003e\n.NET関連の情報を知る際にとても重宝しました。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003e.NET Standard\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/standard/net-standard\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.microsoft.com/ja-jp/dotnet/standard/net-standard\u003c/a\u003e\u003cbr\u003e\nMicrosoftによる.NET Standardのバージョン毎にサポートする.NET関連の最小バージョンについて記載されています。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003e.NET Frameworkのバージョンを整理する\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"http://www.atmarkit.co.jp/ait/articles/1211/16/news093.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://www.atmarkit.co.jp/ait/articles/1211/16/news093.html\u003c/a\u003e\u003cbr\u003e\n.NET Frameworkのバージョンと.NET Standardとの対応について分かりやすく解説された＠ITの記事です。\u003cbr\u003e\n環境対応について調査する際は、こちらの情報をよく参照しています。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003eさいきんの.NETのこととかNuGetとかCoreとかよく分からないよねーって話\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/acple@github/items/e80bef939583fc2b0e5e\" class=\"autolink\" id=\"reference-8af8b86bf09725615d3a\"\u003ehttps://qiita.com/acple@github/items/e80bef939583fc2b0e5e\u003c/a\u003e\u003cbr\u003e\n.NET関連の用語を整理し、分かりやすく解説されたQiitaの記事です。\u003cbr\u003e\n各種.NETの概要と関係性について理解する上で非常に役立ちました。\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"npgsql関連\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#npgsql%E9%96%A2%E9%80%A3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNpgsql関連\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003eNpgsql - .NET Access to PostgreSQL\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"https://www.npgsql.org/index.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.npgsql.org/index.html\u003c/a\u003e\u003cbr\u003e\nNpgsqlの公式サイトです。Npgsqlの詳細を知りたい場合はまずはこちらから。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003eSystem.Transactionsサポート\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"http://vdlz.xyz/Csharp/Database/Postgre/Npgsql/Doc/Npgsql_Doc_020.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://vdlz.xyz/Csharp/Database/Postgre/Npgsql/Doc/Npgsql_Doc_020.html\u003c/a\u003e\u003cbr\u003e\n少し古い情報ですが、TransactionScopeを使ったNpgsqlのソースコード例が載っています。\u003cbr\u003e\n今回のソースコード作成の際に、参考にさせていただきました。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003cstrong\u003eトランザクション スコープを使用した暗黙的なトランザクションの実装\u003c/strong\u003e\u003cbr\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/framework/data/transactions/implementing-an-implicit-transaction-using-transaction-scope\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.microsoft.com/ja-jp/dotnet/framework/data/transactions/implementing-an-implicit-transaction-using-transaction-scope\u003c/a\u003e\u003cbr\u003e\nNpgsqlの情報ではないですが参考として。\u003cbr\u003e\nMicrosoftのTransactionScopeによる暗黙的なトランザクションの解説とソースコードの例が載っています。\u003cbr\u003e\nこちらもソースコード作成の際に、参考にさせていただきました。\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2018-11-20T02:25:33Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"5GhscZkRirLBjNcHOo/q0aEM+ZrdXOkF--S2XJdYHl9pDS0QLD--QAmWjN2QcRbWEZUnR133+A==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2018-11-20T02:25:33Z","likesCount":27,"linkUrl":"https://qiita.com/mimitaro/items/fde451da2f722fe12072","organization":null,"originalId":725261,"stockedCount":38,"title":"C#(.NET系)からPostgreSQLへ接続(TransactionScopeや分散トランザクションについて)","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#npgsql%E3%81%A8%E3%81%AF\"\u003eNpgsqlとは\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#npgsql%E3%81%AE%E5%B0%8E%E5%85%A5\"\u003eNpgsqlの導入\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#npgsql%E3%81%AB%E3%82%88%E3%82%8B%E5%8D%98%E7%B4%94%E3%81%AA%E6%8E%A5%E7%B6%9A\"\u003eNpgsqlによる単純な接続\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%8B%E6%BA%96%E5%82%99\"\u003e下準備\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E7%85%A7%E3%81%AE%E8%BF%BD%E5%8A%A0\"\u003e参照の追加\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#postgresql%E5%81%B4%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003ePostgreSQL側の設定\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#npgsql%E3%81%AB%E3%82%88%E3%82%8B%E5%8D%98%E7%B4%94%E3%81%AA%E6%8E%A5%E7%B6%9A%E3%81%AE%E5%AE%9F%E8%A1%8C\"\u003eNpgsqlによる単純な接続の実行\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#transactionscope%E3%81%AE%E5%88%A9%E7%94%A8\"\u003eTransactionScopeの利用\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#transactionscope%E3%81%AB%E3%82%88%E3%82%8B%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86\"\u003eTransactionScopeによるトランザクション管理\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#transactionscope%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\"\u003eTransactionScopeによる分散トランザクション\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E4%B8%8B%E6%BA%96%E5%82%99\"\u003e分散トランザクションのための下準備\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%AE%9F%E6%96%BD\"\u003e分散トランザクションの実施\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%90%8C%E4%B8%80db%E3%81%B8%E8%A4%87%E6%95%B0%E5%9B%9E%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88%E3%81%AEtransactionscope%E3%81%AE%E5%8B%95%E3%81%8D\"\u003e同一DBへ複数回接続する場合のTransactionScopeの動き\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%97%E3%81%9F%E3%82%B5%E3%82%A4%E3%83%88\"\u003e参考にしたサイト\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#net%E9%96%A2%E9%80%A3\"\u003e.NET関連\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#npgsql%E9%96%A2%E9%80%A3\"\u003eNpgsql関連\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":58442,"uuid":"fde451da2f722fe12072","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"532H0mXJNL5z6dCqHV9D9usShJ3a--NwB/LVIG29mnTg1y--uJgVigMaS21BenoihOXTxw==","originalId":224034,"description":"PostgreSQL大好き人間です。\r\n他にも趣味でpythonやらJavaやらをいじっています。","facebookUrl":null,"githubUrl":"https://github.com/33taro","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/224034/profile-images/1513333619","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F224034%2Fprofile-images%2F1513333619?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=81ca2d42335eb443591df9baab2e2061","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F224034%2Fprofile-images%2F1513333619?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cf49a1e83b54fde8f7d4403aa7840ae9","urlName":"mimitaro","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":".NET","urlName":".net"},{"name":"PostgreSQL","urlName":"postgresql"},{"name":"Npgsql","urlName":"npgsql"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
