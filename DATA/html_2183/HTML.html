<!DOCTYPE html><html><head><meta charset="utf-8" /><title>(C#) 同期コンテキストと Task, async/await - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/ikorin24/items/92ea46374642a0b59011" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="swJWOe9fEH66QxlxnRvUMmOxresKrHlJXy+BfRml9qvG0F5bthVr4mceLNs4WAPbRdYZO52+mzClCLlFx/5UCA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@ikorin24" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="(C#) 同期コンテキストと Task, async/await - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1LRU1qS1NEbGtJem1uSl9qZ3JQamc3UGpnNGJqZ3EzamdybmpnNGpqZ2FnZ1ZHRnpheXdnWVhONWJtTXZZWGRoYVhRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTIyOTMyZDAxYjllODRjODdmMWQ4M2M4YzQ2MjJmMTdh&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2xyYjNKcGJqSTAmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz0zZjViNGVlZjZjMDc1NzE3YmFhZDRjOTE3NDFkOGZlNg&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=4b4b487925899c4fbf868fdf5134547b"><meta property="og:description" content=".NET framework 4 で追加されたTaskおよび .NET framework 4.5 で追加されたasync, awaitキーワードによって、C# の非同期処理は非常にに簡単になりました。

Windows Form, ..."><meta content="https://qiita.com/ikorin24/items/92ea46374642a0b59011" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,.NET" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-212f0eaa-9e06-4a58-874e-7cbb87b983b3"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fikorin24%2Fitems%2F92ea46374642a0b59011">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fikorin24%2Fitems%2F92ea46374642a0b59011">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-212f0eaa-9e06-4a58-874e-7cbb87b983b3">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-12-20T19:21:04.000+09:00","dateModified":"2019-12-20T21:49:09.000+09:00","headline":"(C#) 同期コンテキストと Task, async/await","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1LRU1qS1NEbGtJem1uSl9qZ3JQamc3UGpnNGJqZ3EzamdybmpnNGpqZ2FnZ1ZHRnpheXdnWVhONWJtTXZZWGRoYVhRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTIyOTMyZDAxYjllODRjODdmMWQ4M2M4YzQ2MjJmMTdh\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2xyYjNKcGJqSTAmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz0zZjViNGVlZjZjMDc1NzE3YmFhZDRjOTE3NDFkOGZlNg\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=4b4b487925899c4fbf868fdf5134547b","mainEntityOfPage":"https://qiita.com/ikorin24/items/92ea46374642a0b59011","author":{"@type":"Person","address":"","email":null,"identifier":"ikorin24","name":"ikorin24","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F323111%2Fcf5cb53c76525d7d786088112ab30d6e284725fa%2Flarge.png%3F1576827415?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=3535eb68fc570b2edf8724d235d49fbb","url":"https://qiita.com/ikorin24","description":"C#/.NET周りの技術が好きです (Twitter: @ikorin24)","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"ikorin24","type":"items","id":"92ea46374642a0b59011"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"ikorin24","type":"items","id":"92ea46374642a0b59011"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"ikorin24","type":"items","id":"92ea46374642a0b59011"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/ikorin24/items/92ea46374642a0b59011","location":"/ikorin24/items/92ea46374642a0b59011","scheme":"https","host":"qiita.com","port":null,"pathname":"/ikorin24/items/92ea46374642a0b59011","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"oG4twrU2u+LyNZgCP8QXAHGvgZTNCE+jx3DC7a/WoX3VvCWg7HzAfi9oraiah8DpV8g1RFoardo9V/rVcY0D3g==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-43148c71-bfab-47c8-b255-7b1d2e786b02"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/ikorin24/items/92ea46374642a0b59011/likers" class="css-1iupg5d">11</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">13</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/92ea46374642a0b59011/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/ikorin24/items/92ea46374642a0b59011/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/ikorin24/items/92ea46374642a0b59011/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/ikorin24/items/92ea46374642a0b59011/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/ikorin24/items/92ea46374642a0b59011.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/ikorin24"><img class="css-100alwu eyfquo10" src="https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/323111/cf5cb53c76525d7d786088112ab30d6e284725fa/large.png?1576827415" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/ikorin24" class="css-10ougpm">@<!-- -->ikorin24</a><div class="css-1ay9vb9"><span><meta content="2019-12-20T10:21:04Z"/><time dateTime="2019-12-20T12:49:09Z" class="css-m19uds">updated at 2019-12-20</time></span></div></div></div></div></div><h1 class="css-cgzq40">(C#) 同期コンテキストと Task, async/await</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/.net" class="css-4czcte">.NET</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>.NET framework 4 で追加された<code>Task</code>および .NET framework 4.5 で追加された<code>async</code>, <code>await</code>キーワードによって、C# の非同期処理は非常にに簡単になりました。</p>

<p>Windows Form, WPF, UWP, Unity など各種フレームワーク上の場合、非同期処理はスレッドやコールバック処理など面倒なことはほぼ完璧に隠蔽され、難しいことを意識することなく直感的に記述できるようになりました。</p>

<p>　</p>

<p>しかし、例えば上記のような既存のフレームワークを使わず、独自の GUI フレームワークを作りたいような場合、同期コンテキストについて知っておく必要があります。</p>

<p>(GUIフレームワークを自分で作る人がいるのかという疑問はひとまず置いておいて……)</p>

<p>なお、ここでいうフレームワークとは、開発者がその上でアプリケーションを作成することを目的としているような、基盤となるようなライブラリ群のことを指しています。</p>

<h1>
<span id="gui-とスレッド" class="fragment"></span><a href="#gui-%E3%81%A8%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>GUI とスレッド</h1>

<p>C# に限らず、GUI のアプリケーションは基本的に UI の操作はシングルスレッドから行うことを前提とし、UI スレッドは特別視されます。理由は、スレッドセーフにGUI フレームワークを作ることは実装面のコストが大きく、実行速度面から見ても不利であるためです。それなら初めから GUI はシングルスレッド前提の設計をしてしまおう、というのが定石です。</p>

<p>しかし、UI スレッドで時間のかかる処理を実行することは、UI のフリーズを意味します。そこで、重い処理は非同期に実行し、実行結果を UI スレッドにコールバックするのが普通です。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">void</span> <span class="nf">SyncMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 同期的に計算処理を行う</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="nf">HeavyCalculation</span><span class="p">();</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">async</span> <span class="n">Task</span> <span class="nf">AsyncMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 非同期に計算処理を行う</span>
    <span class="c1">// ここは UI スレッド</span>
    <span class="c1">// 別スレッドに重い処理を実行させる</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(</span><span class="n">HeavyCalculation</span><span class="p">);</span>
    <span class="c1">// ここは UI スレッドに戻ってきている</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">HeavyCalculation</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

    <span class="c1">// ここで重い計算処理をおこなう</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>上の<code>SyncMethod()</code>と<code>AsyncMethod()</code>はともに同じ<code>result</code>を得ますが、<code>SyncMethod()</code>は同期的に実行されるため、例えば計算処理に10秒かかる場合、10秒間 UI がフリーズします。</p>

<p>一方、<code>AsyncMethod()</code>は計算処理部分を別スレッドに投げ、結果が出た時に再び UI スレッドに処理が戻ってくるため、計算中に UI がフリーズしません。</p>

<p>　</p>

<p>実際に別スレッドで実行され、実行後にUIスレッドに戻ってきているのか確認してみましょう</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">CheckThreadID</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ここは UI スレッド</span>
    <span class="kt">var</span> <span class="n">uiThread</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">;</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"UI Thread : </span><span class="p">{</span><span class="n">uiThread</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>        <span class="c1">// 1</span>
    <span class="c1">// 別スレッドに重い処理を実行させる</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(</span><span class="n">AnotherThread</span><span class="p">);</span>
    <span class="c1">// ここは UI スレッドに戻ってきている</span>
    <span class="kt">var</span> <span class="n">callbackThread</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">;</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Callback Thread : </span><span class="p">{</span><span class="n">callbackThread</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>        <span class="c1">// 1</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">void</span> <span class="nf">AnotherThread</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">anotherThread</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">;</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Another Thread : </span><span class="p">{</span><span class="n">anotherThread</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>        <span class="c1">// 2</span>
<span class="p">}</span>
</code></pre></div></div>

<p>この<code>CheckThreadID()</code>実行すると、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>UI Thread : 1
Another Thread : 2
Callback Thread : 1
</code></pre></div></div>

<p>のように出力されます。(スレッド ID の数字は実行環境によって変わります)</p>

<p>非同期処理を呼び出した後、呼び出し元のスレッドに処理が戻ってきていることが確認できます。</p>

<h1>
<span id="コンソールアプリケーションの場合" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>コンソールアプリケーションの場合</h1>

<p>では、GUI フレームワークを使わない環境、つまりコンソールアプリケーションの場合どうなるのでしょうか。</p>

<p>　</p>

<p>なお、コンソールアプリケーションで<code>Task</code>を使う場合、非同期処理が終了する前に<code>Main</code>メソッドを抜けてしまうとアプリケーションが終了してしまうため、以下のように書きます。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nf">MainAsync</span><span class="p">(</span><span class="n">args</span><span class="p">).</span><span class="nf">Wait</span><span class="p">();</span>

    <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">MainAsync</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ここに普通にMain関数の中身を書く</span>
        <span class="k">await</span> <span class="nf">CheckThreadID</span><span class="p">();</span>    <span class="c1">// スレッドIDを確認する</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ここに先ほどの非同期スレッドのスレッド ID を確認するプログラムを書いてみた場合、結果は以下のようになります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>UI Thread : 1
Another Thread : 2
Callback Thread : 2
</code></pre></div></div>

<p>(スレッド ID の数字は実行環境によって変わります)</p>

<p>UI スレッド (この場合<code>Main</code>関数が走っているメインスレッド) の ID が <code>1</code>なのに対し、非同期処理から戻ってきたときのスレッドは、元のスレッドとは別のスレッドになっています。</p>

<p>これはどうしてなのでしょうか。</p>

<h1>
<span id="同期コンテキスト-synchronizationcontext" class="fragment"></span><a href="#%E5%90%8C%E6%9C%9F%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88-synchronizationcontext"><i class="fa fa-link"></i></a>同期コンテキスト (<code>SynchronizationContext</code>)</h1>

<p><code>System.Threading</code>名前空間に<code>SynchronizationContext</code>というクラスがあります。これが同期コンテキストです。</p>

<p>実は<code>Task</code>が非同期処理からどのスレッドに帰ってくるかはこの同期コンテキストが関係しています。</p>

<p>　</p>

<p><code>System.ComponentModel</code>名前空間に<code>AsyncOperationManager</code>という<code>static</code>クラスがあり、これが<code>SynchronizationContext</code>という<code>static</code>プロパティを持っています。</p>

<p>このプロパティは、このプロパティを呼び出したスレッドに紐づいている同期コンテキストを取得することができます。</p>

<p>この同期コンテキストというのは各スレッドごとに1つあり、<code>null</code>または<code>SynchronizationContext</code>クラスのインスタンスです。</p>

<p>(以降、スレッドに紐づいている同期コンテキストが<code>null</code>または<code>SynchronizationContext</code>インスタンスの状態のことを、デフォルトの同期コンテキストと呼ぶことにします)</p>

<p>　</p>

<p>デフォルトの同期コンテキストは、実質何も処理をしないため、<code>Task</code>による非同期処理のコールバックは元のスレッドに戻ってくることはありません。</p>

<p>では Windows Form や WPF などのフレームワークではどうして元のスレッドに戻ってくるのでしょうか。</p>

<h1>
<span id="gui-フレームワークの同期コンテキスト" class="fragment"></span><a href="#gui-%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AE%E5%90%8C%E6%9C%9F%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>GUI フレームワークの同期コンテキスト</h1>

<p>Win Form の場合の同期コンテキストを見てみましょう。</p>

<p>Win Form の場合、<code>System.Windows.Forms</code>名前空間に<code>WindowsFormsSynchronizationContext</code>というクラスが定義されており、このクラスは<code>SynchronizationContext</code>を継承しています。</p>

<p>Win Form の UI スレッドは、デフォルトの同期コンテキストではなくこの<code>WindowsFormsSynchronizationContext</code>のインスタンスを同期コンテキストとして持っています。</p>

<p>この Win Form 用の同期コンテキストによって、UI スレッドから<code>Task</code>で非同期処理を実行した場合、コールバックがUIスレッドに戻ってきます。</p>

<h1>
<span id="gui-のループと同期コンテキスト" class="fragment"></span><a href="#gui-%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%97%E3%81%A8%E5%90%8C%E6%9C%9F%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>GUI のループと同期コンテキスト</h1>

<p>GUI アプリケーションは大きく見れば常にループすることによって成り立っています。例えばゲームなどの場合、1フレームが1回のループと考えていいでしょう。</p>

<p>GUI のフレームワークを使ってアプリケーションを作る場合、多くの場合このループ部分がフレームワークとして隠蔽されているため特にループについて意識することはありませんが、同期コンテキストはこの部分で処理されています。</p>

<p>以下に簡単なループの図を示します。</p>

<p><a href="https://camo.qiitausercontent.com/0e3f4c578cae724e5cf3ad27059e4bce429647d6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332333131312f66663836353434302d356336322d396437382d376634342d3666363834306233386232372e706e67" target="_blank" rel="nofollow noopener"><img width="972" alt="スクリーンショット 2019-12-20 18.54.47.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F323111%2Fff865440-5c62-9d78-7f44-6f6840b38b27.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=addfd2d1a977eeb0dbbe495f5f9f7469" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/323111/ff865440-5c62-9d78-7f44-6f6840b38b27.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F323111%2Fff865440-5c62-9d78-7f44-6f6840b38b27.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0a3e6749e3fcdab8de5ffeffb0d8216d 1x" loading="lazy"></a></p>

<p>図のユーザー処理の部分で<code>Task</code>による非同期処理が実行されたとします。</p>

<p>図の黄色の部分は UI スレッドで実行され、青色の部分が別スレッドで非同期に開始されます。</p>

<p>UI スレッドは<code>await</code>の時点でこのメソッドを打ち切って抜け、あとは通常通りに実行が続きます。(GUIのループがUIスレッドで回り続けます)</p>

<p>一方、ワーカースレッドは処理が終わった時点で、元スレッド (UI スレッド) の同期コンテキストにコールバック処理 (<code>await</code>後のこのメソッドの未実行の処理、つまり赤色の部分) を<code>Post</code>し、キューにコールバックが登録されます。</p>

<p>その後、ループ中でキューを見張っている UI スレッドによって、コールバックが実行され、まるで<code>Task</code>を<code>await</code>した続きの部分から UI スレッド再開されたように実行されます。</p>

<p><b>小ネタ</b></p>

<p>図の右側は、ボタンをクリックした時に非同期処理が走るようなコードですが、<code>await</code>による中断は、その部分でメソッドを打ち切って残りをコールバックとしているだけなので、UI スレッドはそのまま GUI ループに戻っていきます。つまり、非同期処理 (青の部分) がまだ終わっていない状態で、次回以降のループでもう一度ボタンがクリックされた場合、また別の非同期処理を走らせてしまうことになります。(いわゆる再入)</p>

<p>再入を防ぎたい場合は、図のように<code>isRunning</code>のようなフラグを用意しておくことで再入を防げます。</p>

<hr>

<p>　<br>
このループは GUI フレームワークによって実装されるため、<code>Post</code>されたコールバック処理をためておくキューは当然フレームワークによって異なります。そのため、各 GUI フレームワークごとに専用の同期コンテキストを実装する必要があります。</p>

<p>とはいえ、基本的にはコールバック処理をポストする場所が異なるだけです。</p>

<p><code>SynchronizationContext.Post</code>メソッドは<code>virtual</code>で定義されており、<code>override</code>することで専用の実装をすることができます。</p>

<p>これによって、Win Form には Win Form 用の同期コンテキスト、WPF には WPF 用の同期コンテキストクラスが定義されています。</p>

<p>例えば Win Form の同期コンテキスト<code>WindowsFormsSynchronizationContext</code>の実装はこれです。</p>

<p><qiita-embed-ogp src="https://referencesource.microsoft.com/#system.windows.forms/winforms/managed/system/winforms/WindowsFormsSynchronizationContext.cs"></qiita-embed-ogp></p>

<p>　</p>

<p>つまり、自分でこの GUI ループ処理を書いて、<code>Task</code>のコールバックが UI スレッドになるような同期コンテキストクラスを定義すれば、WPF などと同じように<code>Task</code>が使えるようになります。</p>

<p>もちろん、ループが開始する前に UI スレッドに対してこの同期コンテキストを紐づけておく必要があります。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// 現在のスレッドの同期コンテキストとして、自作の同期コンテキストを設定</span>
<span class="n">AsyncOperationManager</span><span class="p">.</span><span class="nf">SetSynchronizationContext</span><span class="p">(</span><span class="k">new</span> <span class="nf">MySynchronizationContext</span><span class="p">());</span>
<span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// GUI スレッドのループ</span>
<span class="p">}</span>
</code></pre></div></div>

<h1>
<span id="非-ui-スレッドでのawait" class="fragment"></span><a href="#%E9%9D%9E-ui-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%A7%E3%81%AEawait"><i class="fa fa-link"></i></a>非 UI スレッドでの<code>await</code>
</h1>

<p>前述したように、各種 GUI フレームワークの UI スレッドの同期コンテキストは、そのフレームワーク専用の同期コンテキストとなっていますが、非 UI スレッドの同期コンテキストはデフォルトの同期コンテキストです。</p>

<p>そのため、<code>await</code>後に元のスレッドに戻ってくるのは UI スレッド上の <code>await</code>のみです。</p>

<p>ワーカースレッド上での<code>await</code>後のコールバックは、元と同じワーカスレッドには戻ってきません。(しかし、UI スレッド以外で元と同じスレッドでないと困るようなことは基本的にないため、問題にはなりませんが)</p>

<h1>
<span id="ui-スレッドへの復帰コスト" class="fragment"></span><a href="#ui-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%B8%E3%81%AE%E5%BE%A9%E5%B8%B0%E3%82%B3%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>UI スレッドへの復帰コスト</h1>

<p>GUI ループでのキューの監視は、ループごとにキューにコールバックが<code>Post</code>されていないか確認しています。</p>

<p>しかし、GUIのループは基本的に描画速度に依存し、60FPSを前提とする環境では1ループ最短で 16ms かかります。つまり、キューを確認した直後に非同期からコールバックを<code>Post</code>された場合、UI スレッドがきちんと回っている場合でも、コールバックを拾うまでに最長 16ms 遅れます。</p>

<p>これは、わざわざコールバックで UI スレッド復帰する必要がない場合、不要なコストです。</p>

<h1>
<span id="ui-スレッド復帰しないawait" class="fragment"></span><a href="#ui-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E5%BE%A9%E5%B8%B0%E3%81%97%E3%81%AA%E3%81%84await"><i class="fa fa-link"></i></a>UI スレッド復帰しない<code>await</code>
</h1>

<p><code>Task</code>の<code>await</code>のコールバックを UI スレッドに戻す必要がない場合、<code>Task.ConfigureAwait</code>メソッドを使うことで、UI スレッドに復帰せずにそのままコールバックを実行できます。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// ここは UI スレッド</span>
<span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Start"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> 
<span class="p">{</span>
    <span class="c1">// ここはワーカースレッド</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Worker Thread"</span><span class="p">);</span>
<span class="p">}).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>    <span class="c1">// スレッド復帰しない</span>
<span class="c1">// ここは同じワーカースレッド</span>
<span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Callback"</span><span class="p">);</span>
</code></pre></div></div>

<p><code>Task</code>のデフォルトでは<code>ConfigureAwait</code>は<code>true</code>に設定されており、この場合、同期コンテキストによる通知は<code>SynchronizationContext.Post</code>メソッドによって行われます。</p>

<p><code>Task.ConfigureAwait(false)</code>にした場合、通知は<code>SynchronizationContext.Send</code>によって行われ、同期的に実行されます。混乱しそうですが、ワーカースレッドから見て同期的ということは、コールバックは同じワーカースレッドで実行されるということです。</p>

<p>つまり、<code>Task</code>中の処理の続きで連続して行われるため、UI スレッド復帰によるコストは発生しません。</p>

<h1>
<span id="ありがちな罠" class="fragment"></span><a href="#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E7%BD%A0"><i class="fa fa-link"></i></a>ありがちな罠</h1>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// ここは UI スレッド</span>
<span class="kt">var</span> <span class="n">task1</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> 
<span class="p">{</span>
    <span class="c1">// ここはワーカースレッド1</span>
<span class="p">}).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

<span class="c1">// ここはワーカースレッド1</span>
<span class="kt">var</span> <span class="n">task2</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> 
<span class="p">{</span>
    <span class="c1">// ここはワーカースレッド2</span>
<span class="p">}).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="c1">// ***注意***</span>
<span class="c1">// ここはワーカースレッド2</span>
</code></pre></div></div>

<p>上記のコードの場合、一番下の部分は<code>ConfigureAwait(true)</code>の後なので UI スレッドのように見えますが、<b>UI スレッドではありません</b>。</p>

<p>ならば、<code>task2</code>を呼び出したのはワーカースレッド1なのだから、ここはスレッド復帰してワーカースレッド1なのかというと、それも違います。正解はワーカースレッド2です。</p>

<p>そもそも 非 UI スレッドの同期コンテキストはスレッド復帰を行わないので最後の部分はワーカースレッド2で実行されます。</p>

<p>　</p>

<p>最後の部分で UI スレッドに復帰したい場合は<code>Task.ContinueWith</code>メソッドを使います。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// ここは UI スレッド</span>
<span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> 
<span class="p">{</span>
    <span class="c1">// ここはワーカースレッド1</span>
<span class="p">}).</span><span class="nf">ContinueWith</span><span class="p">(()</span> <span class="p">=&gt;</span> 
<span class="p">{</span>
    <span class="c1">// ここはワーカースレッド1</span>
<span class="p">}).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="c1">// ここは UI スレッド</span>
</code></pre></div></div>

<p>説明のため<code>ConfigureAwait(true)</code>をつけていますが、もともと<code>true</code>なのでなくても動作は同じです。</p>

<h1>
<span id="ライブラリ作成時の注意点" class="fragment"></span><a href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E4%BD%9C%E6%88%90%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>ライブラリ作成時の注意点</h1>

<p><code>Task</code>を内部で使って非同期処理を行うようなライブラリを作る場合、<code>await</code>を使う場合原則として<code>ConfigureAwait(false)</code>を必ず付ける必要があります。</p>

<p>つけ忘れると、意図しない部分でスレッドが UI スレッドに復帰してしまう上、コンパイルされたライブラリ dll の利用者から見ると、そのライブラリが中で<code>await</code>をつかったスレッド復帰をしているかどうかを確認する術がありません。</p>

<p>なので、基本的にライブラリとして他者に使ってもらう前提のコード中の<code>Task</code>には<code>ConfigureAwait(false)</code>を必ず付ける必要があります。</p>

<h1>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h1>

<ul>
<li><p><a href="https://devlights.hatenablog.com/entry/20110317/p1" rel="nofollow noopener" target="_blank">.NET クラスライブラリ探訪-040 (System.Windows.Forms.WindowsFormsSynchronizationContext)(SynchronizationContext, 同期コンテキスト, Send, Post)</a></p></li>
<li><p><a href="https://tech.blog.aerie.jp/entry/2015/09/17/110258" rel="nofollow noopener" target="_blank">async/await と SynchronizationContext (1)</a></p></li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fikorin24%2Fitems%2F92ea46374642a0b59011&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fikorin24%2Fitems%2F92ea46374642a0b59011&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/ikorin24/items/92ea46374642a0b59011/likers" class="css-1iupg5d">11</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">13</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/92ea46374642a0b59011/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/ikorin24/items/92ea46374642a0b59011/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/ikorin24/items/92ea46374642a0b59011/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/ikorin24/items/92ea46374642a0b59011/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/ikorin24/items/92ea46374642a0b59011.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-43148c71-bfab-47c8-b255-7b1d2e786b02">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-9e9695c2-2e93-43f0-bc71-f6860070f85c"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-9e9695c2-2e93-43f0-bc71-f6860070f85c">{}</script>
      
<div id="LoginModal-react-component-70980983-b7ca-44b7-893f-ee8cf8cd59f7"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-70980983-b7ca-44b7-893f-ee8cf8cd59f7">{}</script>
      
<div id="StockModal-react-component-3b9d4563-59a0-44ba-ae6a-6a8edfb01276"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-3b9d4563-59a0-44ba-ae6a-6a8edfb01276">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;cXF6mB3mHJFPp6fvb6VpdoGEf88h0x/2ofysqj1/kT4Eo3L6RKxnDZL6kkXK5r6fp+PLH7bB/Y9b25SS4yQznQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e.NET framework 4 で追加された\u003ccode\u003eTask\u003c/code\u003eおよび .NET framework 4.5 で追加された\u003ccode\u003easync\u003c/code\u003e, \u003ccode\u003eawait\u003c/code\u003eキーワードによって、C# の非同期処理は非常にに簡単になりました。\u003c/p\u003e\n\n\u003cp\u003eWindows Form, WPF, UWP, Unity など各種フレームワーク上の場合、非同期処理はスレッドやコールバック処理など面倒なことはほぼ完璧に隠蔽され、難しいことを意識することなく直感的に記述できるようになりました。\u003c/p\u003e\n\n\u003cp\u003e　\u003c/p\u003e\n\n\u003cp\u003eしかし、例えば上記のような既存のフレームワークを使わず、独自の GUI フレームワークを作りたいような場合、同期コンテキストについて知っておく必要があります。\u003c/p\u003e\n\n\u003cp\u003e(GUIフレームワークを自分で作る人がいるのかという疑問はひとまず置いておいて……)\u003c/p\u003e\n\n\u003cp\u003eなお、ここでいうフレームワークとは、開発者がその上でアプリケーションを作成することを目的としているような、基盤となるようなライブラリ群のことを指しています。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"gui-とスレッド\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#gui-%E3%81%A8%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eGUI とスレッド\u003c/h1\u003e\n\n\u003cp\u003eC# に限らず、GUI のアプリケーションは基本的に UI の操作はシングルスレッドから行うことを前提とし、UI スレッドは特別視されます。理由は、スレッドセーフにGUI フレームワークを作ることは実装面のコストが大きく、実行速度面から見ても不利であるためです。それなら初めから GUI はシングルスレッド前提の設計をしてしまおう、というのが定石です。\u003c/p\u003e\n\n\u003cp\u003eしかし、UI スレッドで時間のかかる処理を実行することは、UI のフリーズを意味します。そこで、重い処理は非同期に実行し、実行結果を UI スレッドにコールバックするのが普通です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eSyncMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 同期的に計算処理を行う\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eHeavyCalculation\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eAsyncMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 非同期に計算処理を行う\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここは UI スレッド\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 別スレッドに重い処理を実行させる\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartNew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHeavyCalculation\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここは UI スレッドに戻ってきている\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eHeavyCalculation\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// ここで重い計算処理をおこなう\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e上の\u003ccode\u003eSyncMethod()\u003c/code\u003eと\u003ccode\u003eAsyncMethod()\u003c/code\u003eはともに同じ\u003ccode\u003eresult\u003c/code\u003eを得ますが、\u003ccode\u003eSyncMethod()\u003c/code\u003eは同期的に実行されるため、例えば計算処理に10秒かかる場合、10秒間 UI がフリーズします。\u003c/p\u003e\n\n\u003cp\u003e一方、\u003ccode\u003eAsyncMethod()\u003c/code\u003eは計算処理部分を別スレッドに投げ、結果が出た時に再び UI スレッドに処理が戻ってくるため、計算中に UI がフリーズしません。\u003c/p\u003e\n\n\u003cp\u003e　\u003c/p\u003e\n\n\u003cp\u003e実際に別スレッドで実行され、実行後にUIスレッドに戻ってきているのか確認してみましょう\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eCheckThreadID\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここは UI スレッド\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003euiThread\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eManagedThreadId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"UI Thread : \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003euiThread\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 1\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 別スレッドに重い処理を実行させる\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFactory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartNew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAnotherThread\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここは UI スレッドに戻ってきている\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecallbackThread\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eManagedThreadId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Callback Thread : \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ecallbackThread\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAnotherThread\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eanotherThread\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eManagedThreadId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Another Thread : \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eanotherThread\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 2\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこの\u003ccode\u003eCheckThreadID()\u003c/code\u003e実行すると、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eUI Thread : 1\nAnother Thread : 2\nCallback Thread : 1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eのように出力されます。(スレッド ID の数字は実行環境によって変わります)\u003c/p\u003e\n\n\u003cp\u003e非同期処理を呼び出した後、呼び出し元のスレッドに処理が戻ってきていることが確認できます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"コンソールアプリケーションの場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコンソールアプリケーションの場合\u003c/h1\u003e\n\n\u003cp\u003eでは、GUI フレームワークを使わない環境、つまりコンソールアプリケーションの場合どうなるのでしょうか。\u003c/p\u003e\n\n\u003cp\u003e　\u003c/p\u003e\n\n\u003cp\u003eなお、コンソールアプリケーションで\u003ccode\u003eTask\u003c/code\u003eを使う場合、非同期処理が終了する前に\u003ccode\u003eMain\u003c/code\u003eメソッドを抜けてしまうとアプリケーションが終了してしまうため、以下のように書きます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eMainAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eMainAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ここに普通にMain関数の中身を書く\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eCheckThreadID\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// スレッドIDを確認する\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここに先ほどの非同期スレッドのスレッド ID を確認するプログラムを書いてみた場合、結果は以下のようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eUI Thread : 1\nAnother Thread : 2\nCallback Thread : 2\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e(スレッド ID の数字は実行環境によって変わります)\u003c/p\u003e\n\n\u003cp\u003eUI スレッド (この場合\u003ccode\u003eMain\u003c/code\u003e関数が走っているメインスレッド) の ID が \u003ccode\u003e1\u003c/code\u003eなのに対し、非同期処理から戻ってきたときのスレッドは、元のスレッドとは別のスレッドになっています。\u003c/p\u003e\n\n\u003cp\u003eこれはどうしてなのでしょうか。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"同期コンテキスト-synchronizationcontext\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%90%8C%E6%9C%9F%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88-synchronizationcontext\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e同期コンテキスト (\u003ccode\u003eSynchronizationContext\u003c/code\u003e)\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode\u003eSystem.Threading\u003c/code\u003e名前空間に\u003ccode\u003eSynchronizationContext\u003c/code\u003eというクラスがあります。これが同期コンテキストです。\u003c/p\u003e\n\n\u003cp\u003e実は\u003ccode\u003eTask\u003c/code\u003eが非同期処理からどのスレッドに帰ってくるかはこの同期コンテキストが関係しています。\u003c/p\u003e\n\n\u003cp\u003e　\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eSystem.ComponentModel\u003c/code\u003e名前空間に\u003ccode\u003eAsyncOperationManager\u003c/code\u003eという\u003ccode\u003estatic\u003c/code\u003eクラスがあり、これが\u003ccode\u003eSynchronizationContext\u003c/code\u003eという\u003ccode\u003estatic\u003c/code\u003eプロパティを持っています。\u003c/p\u003e\n\n\u003cp\u003eこのプロパティは、このプロパティを呼び出したスレッドに紐づいている同期コンテキストを取得することができます。\u003c/p\u003e\n\n\u003cp\u003eこの同期コンテキストというのは各スレッドごとに1つあり、\u003ccode\u003enull\u003c/code\u003eまたは\u003ccode\u003eSynchronizationContext\u003c/code\u003eクラスのインスタンスです。\u003c/p\u003e\n\n\u003cp\u003e(以降、スレッドに紐づいている同期コンテキストが\u003ccode\u003enull\u003c/code\u003eまたは\u003ccode\u003eSynchronizationContext\u003c/code\u003eインスタンスの状態のことを、デフォルトの同期コンテキストと呼ぶことにします)\u003c/p\u003e\n\n\u003cp\u003e　\u003c/p\u003e\n\n\u003cp\u003eデフォルトの同期コンテキストは、実質何も処理をしないため、\u003ccode\u003eTask\u003c/code\u003eによる非同期処理のコールバックは元のスレッドに戻ってくることはありません。\u003c/p\u003e\n\n\u003cp\u003eでは Windows Form や WPF などのフレームワークではどうして元のスレッドに戻ってくるのでしょうか。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"gui-フレームワークの同期コンテキスト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#gui-%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AE%E5%90%8C%E6%9C%9F%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eGUI フレームワークの同期コンテキスト\u003c/h1\u003e\n\n\u003cp\u003eWin Form の場合の同期コンテキストを見てみましょう。\u003c/p\u003e\n\n\u003cp\u003eWin Form の場合、\u003ccode\u003eSystem.Windows.Forms\u003c/code\u003e名前空間に\u003ccode\u003eWindowsFormsSynchronizationContext\u003c/code\u003eというクラスが定義されており、このクラスは\u003ccode\u003eSynchronizationContext\u003c/code\u003eを継承しています。\u003c/p\u003e\n\n\u003cp\u003eWin Form の UI スレッドは、デフォルトの同期コンテキストではなくこの\u003ccode\u003eWindowsFormsSynchronizationContext\u003c/code\u003eのインスタンスを同期コンテキストとして持っています。\u003c/p\u003e\n\n\u003cp\u003eこの Win Form 用の同期コンテキストによって、UI スレッドから\u003ccode\u003eTask\u003c/code\u003eで非同期処理を実行した場合、コールバックがUIスレッドに戻ってきます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"gui-のループと同期コンテキスト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#gui-%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%97%E3%81%A8%E5%90%8C%E6%9C%9F%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eGUI のループと同期コンテキスト\u003c/h1\u003e\n\n\u003cp\u003eGUI アプリケーションは大きく見れば常にループすることによって成り立っています。例えばゲームなどの場合、1フレームが1回のループと考えていいでしょう。\u003c/p\u003e\n\n\u003cp\u003eGUI のフレームワークを使ってアプリケーションを作る場合、多くの場合このループ部分がフレームワークとして隠蔽されているため特にループについて意識することはありませんが、同期コンテキストはこの部分で処理されています。\u003c/p\u003e\n\n\u003cp\u003e以下に簡単なループの図を示します。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/0e3f4c578cae724e5cf3ad27059e4bce429647d6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332333131312f66663836353434302d356336322d396437382d376634342d3666363834306233386232372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"972\" alt=\"スクリーンショット 2019-12-20 18.54.47.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F323111%2Fff865440-5c62-9d78-7f44-6f6840b38b27.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=addfd2d1a977eeb0dbbe495f5f9f7469\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/323111/ff865440-5c62-9d78-7f44-6f6840b38b27.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F323111%2Fff865440-5c62-9d78-7f44-6f6840b38b27.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0a3e6749e3fcdab8de5ffeffb0d8216d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e図のユーザー処理の部分で\u003ccode\u003eTask\u003c/code\u003eによる非同期処理が実行されたとします。\u003c/p\u003e\n\n\u003cp\u003e図の黄色の部分は UI スレッドで実行され、青色の部分が別スレッドで非同期に開始されます。\u003c/p\u003e\n\n\u003cp\u003eUI スレッドは\u003ccode\u003eawait\u003c/code\u003eの時点でこのメソッドを打ち切って抜け、あとは通常通りに実行が続きます。(GUIのループがUIスレッドで回り続けます)\u003c/p\u003e\n\n\u003cp\u003e一方、ワーカースレッドは処理が終わった時点で、元スレッド (UI スレッド) の同期コンテキストにコールバック処理 (\u003ccode\u003eawait\u003c/code\u003e後のこのメソッドの未実行の処理、つまり赤色の部分) を\u003ccode\u003ePost\u003c/code\u003eし、キューにコールバックが登録されます。\u003c/p\u003e\n\n\u003cp\u003eその後、ループ中でキューを見張っている UI スレッドによって、コールバックが実行され、まるで\u003ccode\u003eTask\u003c/code\u003eを\u003ccode\u003eawait\u003c/code\u003eした続きの部分から UI スレッド再開されたように実行されます。\u003c/p\u003e\n\n\u003cp\u003e\u003cb\u003e小ネタ\u003c/b\u003e\u003c/p\u003e\n\n\u003cp\u003e図の右側は、ボタンをクリックした時に非同期処理が走るようなコードですが、\u003ccode\u003eawait\u003c/code\u003eによる中断は、その部分でメソッドを打ち切って残りをコールバックとしているだけなので、UI スレッドはそのまま GUI ループに戻っていきます。つまり、非同期処理 (青の部分) がまだ終わっていない状態で、次回以降のループでもう一度ボタンがクリックされた場合、また別の非同期処理を走らせてしまうことになります。(いわゆる再入)\u003c/p\u003e\n\n\u003cp\u003e再入を防ぎたい場合は、図のように\u003ccode\u003eisRunning\u003c/code\u003eのようなフラグを用意しておくことで再入を防げます。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003e　\u003cbr\u003e\nこのループは GUI フレームワークによって実装されるため、\u003ccode\u003ePost\u003c/code\u003eされたコールバック処理をためておくキューは当然フレームワークによって異なります。そのため、各 GUI フレームワークごとに専用の同期コンテキストを実装する必要があります。\u003c/p\u003e\n\n\u003cp\u003eとはいえ、基本的にはコールバック処理をポストする場所が異なるだけです。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eSynchronizationContext.Post\u003c/code\u003eメソッドは\u003ccode\u003evirtual\u003c/code\u003eで定義されており、\u003ccode\u003eoverride\u003c/code\u003eすることで専用の実装をすることができます。\u003c/p\u003e\n\n\u003cp\u003eこれによって、Win Form には Win Form 用の同期コンテキスト、WPF には WPF 用の同期コンテキストクラスが定義されています。\u003c/p\u003e\n\n\u003cp\u003e例えば Win Form の同期コンテキスト\u003ccode\u003eWindowsFormsSynchronizationContext\u003c/code\u003eの実装はこれです。\u003c/p\u003e\n\n\u003cp\u003e\u003cqiita-embed-ogp src=\"https://referencesource.microsoft.com/#system.windows.forms/winforms/managed/system/winforms/WindowsFormsSynchronizationContext.cs\"\u003e\u003c/qiita-embed-ogp\u003e\u003c/p\u003e\n\n\u003cp\u003e　\u003c/p\u003e\n\n\u003cp\u003eつまり、自分でこの GUI ループ処理を書いて、\u003ccode\u003eTask\u003c/code\u003eのコールバックが UI スレッドになるような同期コンテキストクラスを定義すれば、WPF などと同じように\u003ccode\u003eTask\u003c/code\u003eが使えるようになります。\u003c/p\u003e\n\n\u003cp\u003eもちろん、ループが開始する前に UI スレッドに対してこの同期コンテキストを紐づけておく必要があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 現在のスレッドの同期コンテキストとして、自作の同期コンテキストを設定\u003c/span\u003e\n\u003cspan class=\"n\"\u003eAsyncOperationManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetSynchronizationContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMySynchronizationContext\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// GUI スレッドのループ\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"非-ui-スレッドでのawait\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%9D%9E-ui-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%A7%E3%81%AEawait\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e非 UI スレッドでの\u003ccode\u003eawait\u003c/code\u003e\n\u003c/h1\u003e\n\n\u003cp\u003e前述したように、各種 GUI フレームワークの UI スレッドの同期コンテキストは、そのフレームワーク専用の同期コンテキストとなっていますが、非 UI スレッドの同期コンテキストはデフォルトの同期コンテキストです。\u003c/p\u003e\n\n\u003cp\u003eそのため、\u003ccode\u003eawait\u003c/code\u003e後に元のスレッドに戻ってくるのは UI スレッド上の \u003ccode\u003eawait\u003c/code\u003eのみです。\u003c/p\u003e\n\n\u003cp\u003eワーカースレッド上での\u003ccode\u003eawait\u003c/code\u003e後のコールバックは、元と同じワーカスレッドには戻ってきません。(しかし、UI スレッド以外で元と同じスレッドでないと困るようなことは基本的にないため、問題にはなりませんが)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ui-スレッドへの復帰コスト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ui-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%B8%E3%81%AE%E5%BE%A9%E5%B8%B0%E3%82%B3%E3%82%B9%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUI スレッドへの復帰コスト\u003c/h1\u003e\n\n\u003cp\u003eGUI ループでのキューの監視は、ループごとにキューにコールバックが\u003ccode\u003ePost\u003c/code\u003eされていないか確認しています。\u003c/p\u003e\n\n\u003cp\u003eしかし、GUIのループは基本的に描画速度に依存し、60FPSを前提とする環境では1ループ最短で 16ms かかります。つまり、キューを確認した直後に非同期からコールバックを\u003ccode\u003ePost\u003c/code\u003eされた場合、UI スレッドがきちんと回っている場合でも、コールバックを拾うまでに最長 16ms 遅れます。\u003c/p\u003e\n\n\u003cp\u003eこれは、わざわざコールバックで UI スレッド復帰する必要がない場合、不要なコストです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ui-スレッド復帰しないawait\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ui-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E5%BE%A9%E5%B8%B0%E3%81%97%E3%81%AA%E3%81%84await\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUI スレッド復帰しない\u003ccode\u003eawait\u003c/code\u003e\n\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode\u003eTask\u003c/code\u003eの\u003ccode\u003eawait\u003c/code\u003eのコールバックを UI スレッドに戻す必要がない場合、\u003ccode\u003eTask.ConfigureAwait\u003c/code\u003eメソッドを使うことで、UI スレッドに復帰せずにそのままコールバックを実行できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// ここは UI スレッド\u003c/span\u003e\n\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Start\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここはワーカースレッド\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Worker Thread\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// スレッド復帰しない\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ここは同じワーカースレッド\u003c/span\u003e\n\u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Callback\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eTask\u003c/code\u003eのデフォルトでは\u003ccode\u003eConfigureAwait\u003c/code\u003eは\u003ccode\u003etrue\u003c/code\u003eに設定されており、この場合、同期コンテキストによる通知は\u003ccode\u003eSynchronizationContext.Post\u003c/code\u003eメソッドによって行われます。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eTask.ConfigureAwait(false)\u003c/code\u003eにした場合、通知は\u003ccode\u003eSynchronizationContext.Send\u003c/code\u003eによって行われ、同期的に実行されます。混乱しそうですが、ワーカースレッドから見て同期的ということは、コールバックは同じワーカースレッドで実行されるということです。\u003c/p\u003e\n\n\u003cp\u003eつまり、\u003ccode\u003eTask\u003c/code\u003e中の処理の続きで連続して行われるため、UI スレッド復帰によるコストは発生しません。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ありがちな罠\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E7%BD%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eありがちな罠\u003c/h1\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// ここは UI スレッド\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここはワーカースレッド1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// ここはワーカースレッド1\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここはワーカースレッド2\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// ***注意***\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ここはワーカースレッド2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e上記のコードの場合、一番下の部分は\u003ccode\u003eConfigureAwait(true)\u003c/code\u003eの後なので UI スレッドのように見えますが、\u003cb\u003eUI スレッドではありません\u003c/b\u003e。\u003c/p\u003e\n\n\u003cp\u003eならば、\u003ccode\u003etask2\u003c/code\u003eを呼び出したのはワーカースレッド1なのだから、ここはスレッド復帰してワーカースレッド1なのかというと、それも違います。正解はワーカースレッド2です。\u003c/p\u003e\n\n\u003cp\u003eそもそも 非 UI スレッドの同期コンテキストはスレッド復帰を行わないので最後の部分はワーカースレッド2で実行されます。\u003c/p\u003e\n\n\u003cp\u003e　\u003c/p\u003e\n\n\u003cp\u003e最後の部分で UI スレッドに復帰したい場合は\u003ccode\u003eTask.ContinueWith\u003c/code\u003eメソッドを使います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// ここは UI スレッド\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここはワーカースレッド1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nf\"\u003eContinueWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ここはワーカースレッド1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// ここは UI スレッド\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e説明のため\u003ccode\u003eConfigureAwait(true)\u003c/code\u003eをつけていますが、もともと\u003ccode\u003etrue\u003c/code\u003eなのでなくても動作は同じです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ライブラリ作成時の注意点\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E4%BD%9C%E6%88%90%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eライブラリ作成時の注意点\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode\u003eTask\u003c/code\u003eを内部で使って非同期処理を行うようなライブラリを作る場合、\u003ccode\u003eawait\u003c/code\u003eを使う場合原則として\u003ccode\u003eConfigureAwait(false)\u003c/code\u003eを必ず付ける必要があります。\u003c/p\u003e\n\n\u003cp\u003eつけ忘れると、意図しない部分でスレッドが UI スレッドに復帰してしまう上、コンパイルされたライブラリ dll の利用者から見ると、そのライブラリが中で\u003ccode\u003eawait\u003c/code\u003eをつかったスレッド復帰をしているかどうかを確認する術がありません。\u003c/p\u003e\n\n\u003cp\u003eなので、基本的にライブラリとして他者に使ってもらう前提のコード中の\u003ccode\u003eTask\u003c/code\u003eには\u003ccode\u003eConfigureAwait(false)\u003c/code\u003eを必ず付ける必要があります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"参考文献\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考文献\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"https://devlights.hatenablog.com/entry/20110317/p1\" rel=\"nofollow noopener\" target=\"_blank\"\u003e.NET クラスライブラリ探訪-040 (System.Windows.Forms.WindowsFormsSynchronizationContext)(SynchronizationContext, 同期コンテキスト, Send, Post)\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"https://tech.blog.aerie.jp/entry/2015/09/17/110258\" rel=\"nofollow noopener\" target=\"_blank\"\u003easync/await と SynchronizationContext (1)\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2019-12-20T10:21:04Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"N1y/GyxYKnrInUKmCBgEMCGhF7PA20pVCA==--YePCvK75E8329aRR--EqU//o6zsTRe8LlRDZzJYA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-12-20T12:49:09Z","likesCount":11,"linkUrl":"https://qiita.com/ikorin24/items/92ea46374642a0b59011","organization":null,"originalId":1118155,"stockedCount":13,"title":"(C#) 同期コンテキストと Task, async/await","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#gui-%E3%81%A8%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89\"\u003eGUI とスレッド\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%A0%B4%E5%90%88\"\u003eコンソールアプリケーションの場合\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%90%8C%E6%9C%9F%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88-synchronizationcontext\"\u003e同期コンテキスト (SynchronizationContext)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#gui-%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%83%AF%E3%83%BC%E3%82%AF%E3%81%AE%E5%90%8C%E6%9C%9F%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88\"\u003eGUI フレームワークの同期コンテキスト\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#gui-%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%97%E3%81%A8%E5%90%8C%E6%9C%9F%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88\"\u003eGUI のループと同期コンテキスト\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%9D%9E-ui-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%A7%E3%81%AEawait\"\u003e非 UI スレッドでのawait\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ui-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%B8%E3%81%AE%E5%BE%A9%E5%B8%B0%E3%82%B3%E3%82%B9%E3%83%88\"\u003eUI スレッドへの復帰コスト\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ui-%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E5%BE%A9%E5%B8%B0%E3%81%97%E3%81%AA%E3%81%84await\"\u003eUI スレッド復帰しないawait\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A1%E3%81%AA%E7%BD%A0\"\u003eありがちな罠\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E4%BD%9C%E6%88%90%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003eライブラリ作成時の注意点\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"\u003e参考文献\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":2099,"uuid":"92ea46374642a0b59011","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"sK5ZDdrrNZ3Zdgc1bohSskKXSUqC--pVFzjHX6+YUEAtGd--xjwVrROLDL6/B7aS/QeSqQ==","originalId":323111,"description":"C#/.NET周りの技術が好きです (Twitter: @ikorin24)","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/323111/cf5cb53c76525d7d786088112ab30d6e284725fa/large.png?1576827415","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F323111%2Fcf5cb53c76525d7d786088112ab30d6e284725fa%2Flarge.png%3F1576827415?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=7a85027608ebd7a723f9743e688a1a36","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F323111%2Fcf5cb53c76525d7d786088112ab30d6e284725fa%2Flarge.png%3F1576827415?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=3535eb68fc570b2edf8724d235d49fbb","urlName":"ikorin24","websiteUrl":"http://ikorin2.hatenablog.jp/","twitterUrl":"https://twitter.com/ikorin24","twitterUrlName":"ikorin24","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":".NET","urlName":".net"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
