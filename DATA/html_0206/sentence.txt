IAM認証を使っているAWSのAPI Gatewayは、APIリクエスト時にSigV4署名が必要です。以前に同様の記事を書きましたが、EC2のインスタンスプロファイルからIAMロールにスイッチしてからリクエスト署名する処理になっていました。スイッチせずにインスタンスプロファイルで直接署名すればいいことがわかりましたので、そのコードをここに残しておきます。IAMロールのアタッチされているEC2インスタンスでC#のコードを実行します。 ~/.aws/config は不要です。※前回の記事では、EC2にIAMロールがアタッチされているだけではなく、インスタンスプロファイルからIAMロールにスイッチする権限が必要でした。このような権限が必要なケースが前回の記事のコード以外の場面であるのかよくわからず、おそらく前回の記事はミスリードでした。API GatewayのリソースポリシーにはこのIAMロールからのAPIアクセスを許可してあるものとします。動作確認した環境はUbuntu 20.04です。C#の環境は以下の通り。本記事でのライブラリ等は2020/12/21時点のものです。SigV4署名するC#のサンプルコードはAWS公式サイトにありますので、それをダウンロードし、必要なディレクトリのみ残します。この手順の詳細は前々回の記事を参照。dotnetコマンドでプロジェクトを作成します。以下のようなディレクトリ構成になります。sample.csprojに以下のように RootNamespace の項目を追加します。サンプルダウンロード後に全置換したnamespaceを指定します。必要なパッケージをダウンロードします。 Program.cs は以下です。uriはAPI GatewayのAPIのURLを入れます。以下のコマンドで実行できます。ダウンロードしたサンプルコードのSignersとUtilにデバッグ用出力があるので、いろいろ表示されますが、最後にAPI Gatewayからのレスポンスが表示されます。前回は InstanceProfileAWSCredentials からassumeRoleしていたのが、今回は InstanceProfileAWSCredentials をそのまま使っている点です。diffを見たほうが早いか。SigV4署名に関する私の記事最近API Gatewayの記事ばかり続いています。


