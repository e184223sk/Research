<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Androidの画面をPCにミラーリングするソフトを作る２　リアルタイムタッチ編 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/siy1121/items/9e96cb1eb14d9090a2b6" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="HwRTU1Ekh+U25EabvcauOWHRrGPzRbcfZVYmNsib/B0BpttoMRNXZmrYCq4nEpkAnT+VPtD/7qBL5WlqO48v+A==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@SIY1121" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="Androidの画面をPCにミラーリングするソフトを作る２　リアルタイムタッチ編 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RVzVrY205cFpPT0JydWVVdS1tZG91T0NrbEJENDRHcjQ0T2Y0NE9wNDRPODQ0T3E0NE96NDRLdzQ0R1o0NEtMNDRLOTQ0T1Y0NE9JNDRLUzVMMmM0NEtMNzd5UzQ0Q0E0NE9xNDRLaTQ0T3I0NEtfNDRLazQ0T2c0NEtfNDRPRDQ0T0I1N2VvJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPWFkNDFmMjcyOGYzMWFiYThhNjBjNTEwODNjY2U4Y2U5&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5wZVRFeE1qRSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTRjNmZhNjY0OTRhZWRjMTUwZmIxZTg3MGNlMzM0NzRl&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=bccd46eb5e8e00bb9e918d4eaf6c96c3"><meta property="og:description" content="

はじめに

この記事はAndroidの画面をPCにミラーリングするソフトを作る１の続きです。
Androidの画面をミラーリングする機能の作り方は、そちらで解説しています。


こんなものをつくります



マウスでAndroid..."><meta content="https://qiita.com/siy1121/items/9e96cb1eb14d9090a2b6" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="Java,Android,Linux,C#,ffmpeg" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-29b92f41-cf8e-44c0-b860-040f13c8e81b"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fsiy1121%2Fitems%2F9e96cb1eb14d9090a2b6">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fsiy1121%2Fitems%2F9e96cb1eb14d9090a2b6">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-29b92f41-cf8e-44c0-b860-040f13c8e81b">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/java","name":"Java"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-01-28T16:30:04.000+09:00","dateModified":"2018-01-28T16:30:04.000+09:00","headline":"Androidの画面をPCにミラーリングするソフトを作る２　リアルタイムタッチ編","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RVzVrY205cFpPT0JydWVVdS1tZG91T0NrbEJENDRHcjQ0T2Y0NE9wNDRPODQ0T3E0NE96NDRLdzQ0R1o0NEtMNDRLOTQ0T1Y0NE9JNDRLUzVMMmM0NEtMNzd5UzQ0Q0E0NE9xNDRLaTQ0T3I0NEtfNDRLazQ0T2c0NEtfNDRPRDQ0T0I1N2VvJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPWFkNDFmMjcyOGYzMWFiYThhNjBjNTEwODNjY2U4Y2U5\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5wZVRFeE1qRSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTRjNmZhNjY0OTRhZWRjMTUwZmIxZTg3MGNlMzM0NzRl\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=bccd46eb5e8e00bb9e918d4eaf6c96c3","mainEntityOfPage":"https://qiita.com/siy1121/items/9e96cb1eb14d9090a2b6","author":{"@type":"Person","address":"","email":null,"identifier":"siy1121","name":"siy1121","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fprofile-images%2F1527769802?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=48bde3e9e95f68591f493be066cb5e43","url":"https://qiita.com/siy1121","description":"情報系の学部に通う大学３年生 / \r\nプログラミングしたり、CG(動画)作ったり、作曲したり色々してます / \r\n動画や音声を扱うプログラムを書くのが好き / \r\nKotlinが好きですが、js/tsの偉大さも感じている今日このごろです","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita&amp;utm_medium=header-banner">クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"siy1121","type":"items","id":"9e96cb1eb14d9090a2b6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい","url":"https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"siy1121","type":"items","id":"9e96cb1eb14d9090a2b6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい","url":"https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"siy1121","type":"items","id":"9e96cb1eb14d9090a2b6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい","url":"https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/siy1121/items/9e96cb1eb14d9090a2b6","location":"/siy1121/items/9e96cb1eb14d9090a2b6","scheme":"https","host":"qiita.com","port":null,"pathname":"/siy1121/items/9e96cb1eb14d9090a2b6","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"K+zu4D61jEME2LBrZbSU1CfT4jgcU+9cjNTuuNKCTAg1TmbbXoJcwFjk/F7/YKPt2z3bZT/ptuOiZ6HkIZaf7Q==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-aecfc603-0e92-40dd-95af-89a7838ebb40"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/siy1121/items/9e96cb1eb14d9090a2b6/likers" class="css-1iupg5d">52</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">42</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/9e96cb1eb14d9090a2b6/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/siy1121/items/9e96cb1eb14d9090a2b6/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/siy1121/items/9e96cb1eb14d9090a2b6/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/siy1121/items/9e96cb1eb14d9090a2b6/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/siy1121/items/9e96cb1eb14d9090a2b6.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/siy1121"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/89220/profile-images/1527769802" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/siy1121" class="css-10ougpm">@<!-- -->siy1121</a><div class="css-1ay9vb9"><time dateTime="2018-01-28T07:30:04Z" class="css-m19uds">posted at 2018-01-28</time></div></div></div></div></div><h1 class="css-cgzq40">Androidの画面をPCにミラーリングするソフトを作る２　リアルタイムタッチ編</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/java" class="css-4czcte">Java</a><a href="/tags/android" class="css-4czcte">Android</a><a href="/tags/linux" class="css-4czcte">Linux</a><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/ffmpeg" class="css-4czcte">ffmpeg</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>この記事は<a href="https://qiita.com/siy1121/items/71fadad0c3a1aa085867" id="reference-b8aeb45819bc0fbd6342">Androidの画面をPCにミラーリングするソフトを作る１</a>の続きです。<br>
Androidの画面をミラーリングする機能の作り方は、そちらで解説しています。</p>

<h1>
<span id="こんなものをつくります" class="fragment"></span><a href="#%E3%81%93%E3%82%93%E3%81%AA%E3%82%82%E3%81%AE%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%BE%E3%81%99"><i class="fa fa-link"></i></a>こんなものをつくります</h1>

<p><a href="https://camo.qiitausercontent.com/9e5f5fc9d2e984e2f586dd00d4d360c1f0d01b51/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f31366635616631332d613062622d303532642d616531302d3664653163393839333236342e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F16f5af13-a0bb-052d-ae10-6de1c9893264.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=42b70384884e178fa6247abb06b4ac4f" alt="capture5.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/89220/16f5af13-a0bb-052d-ae10-6de1c9893264.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F16f5af13-a0bb-052d-ae10-6de1c9893264.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=27398c76b5797599749a9c188a2c3a0d 1x" loading="lazy"></a></p>

<p>マウスでAndroid端末を操作できるようにします。</p>

<h1>
<span id="仕様" class="fragment"></span><a href="#%E4%BB%95%E6%A7%98"><i class="fa fa-link"></i></a>仕様</h1>

<p><a href="https://camo.qiitausercontent.com/45adf79c25874367909a08ce2f81dd947e6acbd4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f64313031306165612d656164332d366165322d653439312d3866653461313230306139332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fd1010aea-ead3-6ae2-e491-8fe4a1200a93.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1fe3bdfd399ea4efc60aa2939e75c23e" alt="fig7.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/89220/d1010aea-ead3-6ae2-e491-8fe4a1200a93.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fd1010aea-ead3-6ae2-e491-8fe4a1200a93.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5bd0ecee2b5051b8fd4a97c36fc88ada 1x" loading="lazy"></a><br>
AndroidとPC間のコネクションは１本にしたいところですが、プログラムが複雑になりそうだったので妥協しました。</p>

<h2>
<span id="クライアントソフトですること" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%BD%E3%83%95%E3%83%88%E3%81%A7%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>クライアントソフトですること</h2>

<p>FFmpegから流れてくるデータを表示します。<br>
また、マウス操作をスクリーンのタッチ操作に変換して端末側に投げます。</p>

<h2>
<span id="android側ですること" class="fragment"></span><a href="#android%E5%81%B4%E3%81%A7%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>Android側ですること</h2>

<p>前回同様、画面の内容をエンコードし、PC側に流します。<br>
また、PC側からタッチイベントを受取り、それをシステムに介入させます。</p>

<h1>
<span id="pcからandroid端末を操作する" class="fragment"></span><a href="#pc%E3%81%8B%E3%82%89android%E7%AB%AF%E6%9C%AB%E3%82%92%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>PCからAndroid端末を操作する</h1>

<p>このセクションでは、Android端末がどのようにタッチやキー操作を扱っているかについての説明をします。<br>
知らなくてもリアルタイムタッチの実装はできますので、興味がなければ「いざ、実装」まで飛ばしてください。</p>

<p>PCからAndroidを操作するにはどうすればいいのでしょうか？<br>
簡単な例から見てみます。</p>

<h2>
<span id="端末のシェルに入ってコマンドを叩く" class="fragment"></span><a href="#%E7%AB%AF%E6%9C%AB%E3%81%AE%E3%82%B7%E3%82%A7%E3%83%AB%E3%81%AB%E5%85%A5%E3%81%A3%E3%81%A6%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E5%8F%A9%E3%81%8F"><i class="fa fa-link"></i></a>端末のシェルに入ってコマンドを叩く</h2>

<p>AndroidはLinuxベースのOSです。ですから、機能限定版であるものの、Linuxのターミナルを使用できます。</p>

<div class="code-frame" data-lang="shell"><div class="highlight"><pre class="with-code"><code>adb shell
</code></pre></div></div>

<p>とすることで対話に入ることができます。<br>
そして、タッチ操作やキー操作などを送る<strong>input</strong>というコマンドが用意されているのでそれを使用します。<br>
以下に例を出します。</p>

<div class="code-frame" data-lang="shell"><div class="highlight"><pre class="with-code"><code>input touchscreen tap x y
input touchscreen swipe x1 y1 x2 y2
input keyevent Key
input text Text
</code></pre></div></div>

<p>これらを実行することで手軽に端末にイベントを送ることができます。<br>
しかし実行してみると、イベントが発行されるまで<strong>時間がかかります</strong>。<br>
これではリアルタイムな操作に向きません。<br>
また、タップやスワイプ以外の複雑な操作をしたい場合はどうすればよいのでしょうか。</p>

<h2>
<span id="getevent-sendeventを使う" class="fragment"></span><a href="#getevent-sendevent%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>getEvent sendEventを使う</h2>

<p><strong>getevent</strong>コマンドは端末のタッチパネルや物理キーから送られてくるデータを出力してくれるコマンドです。<br>
以下のコマンドを実行してからタッチパネルを操作してみてください。</p>

<div class="code-frame" data-lang="shell"><div class="highlight"><pre class="with-code"><code>getevent
</code></pre></div></div>

<p>すると以下の画像のように数値がズラッと表示されると思います。<br>
<a href="https://camo.qiitausercontent.com/4b24e4954698ca13ca3589144b0efb335ae052fe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f62353964326235352d303862322d376431302d313532342d6434323664343837313336322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fb59d2b55-08b2-7d10-1524-d426d4871362.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=88b6db5ea56641dad69aa2973a6f9c69" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/89220/b59d2b55-08b2-7d10-1524-d426d4871362.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fb59d2b55-08b2-7d10-1524-d426d4871362.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=583ef2084fbce72c7e6e41d8c19436f1 1x" loading="lazy"></a><br>
これはタッチパネルから送られてくるデータです。<br>
OSはこのデータを解釈し、反映させます。<br>
実際にどのように解釈されているかについては<a href="https://dev.classmethod.jp/smartphone/adb-attach-device/" rel="nofollow noopener" target="_blank">【Android】プログラムから端末をタッチする【ADB】</a>で説明されているのでご覧ください。</p>

<p><strong>sendevent</strong>はあたかもタッチパネルなどから送られてきたデータのように、任意のデータを送ることができるコマンドです。<br>
つまり、<strong>getevent</strong>で得たデータを<strong>sendevent</strong>で送り直すことでタッチ操作を再現することができます。<br>
しかし、このコマンドも実行速度が遅く、完全再現とは行きません。</p>

<h2>
<span id="デバイスファイルを直接操作する" class="fragment"></span><a href="#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%9B%B4%E6%8E%A5%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>デバイスファイルを直接操作する</h2>

<p>AndroidはLinuxベースのため、デバイスファイルを使用しています。<br>
WindowsといったUnix系でないOSを使っている方には馴染みが無いかもしれませんが、<br>
デバイスファイルとは、接続されている様々なデバイスとやり取りを行うのに使用する特殊なファイルのことです。<br>
例えば、タッチパネルのデバイスファイルを開くと、geteventで得たようなタッチパネルの操作に関するデータを読み出すことができます。<br>
逆に、デバイスファイルに書き込むとsendeventと同じように、書き込んだデータはそのデバイスから送られてきたものとして処理されます。<br>
<a href="http://wa3.i-3-i.info/word11689.html" rel="nofollow noopener" target="_blank">デバイスファイル (device file)</a><br>
<a href="https://uc2.h2np.net/index.php/%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%B9%E3%83%9A%E3%82%B7%E3%83%A3%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB" rel="nofollow noopener" target="_blank">デバイススペシャルファイル</a><br>
このあたりが参考になると思います。</p>

<p>では実際にデバイスファイルを開いてみましょう。<br>
先程の画像に/dev/input/event4というパスが記載されていると思います。<br>
これがデバイスファイルの場所になります。<br>
/dev/inputディレクトリにはevent0、event1....といくつかのデバイスファイルが存在しており、それがタッチパネルや物理キー、センサーなどと対応しています。<strong>対応する番号は端末によって違うので、注意してください。</strong></p>

<div class="code-frame" data-lang="shell"><div class="highlight"><pre class="with-code"><code><span class="nb">cat</span> /dev/input/event●
</code></pre></div></div>

<p>このコマンドを実行するとそのデバイスからのデータが流れてきます。が、こうなります。</p>

<p><a href="https://camo.qiitausercontent.com/ea481bc1aa6cf23d5c7574838dda2b9154b68605/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f34636538373937332d393861332d376638352d646261312d6561383465626332303432642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F4ce87973-98a3-7f85-dba1-ea84ebc2042d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=08a081ce7e1c83a68aa73dc4791f9ddf" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/89220/4ce87973-98a3-7f85-dba1-ea84ebc2042d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F4ce87973-98a3-7f85-dba1-ea84ebc2042d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=68165bada82616aade36ee784badae48 1x" loading="lazy"></a><br>
デバイスファイルから得られる生データはバイナリデータであり、文字で表示するものではないのです。<br>
getEventやsendEvent、冒頭で紹介したinputコマンドは、バイナリ⇔文字(数値)の変換を行ってくれているのです。</p>

<p>ちなみに、</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>cat /dev/input/event● &gt; /sdcard/event.bin
</code></pre></div></div>

<p>と、することで生データをファイルに保存することができるので</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>cat /sdcard/event.bin &gt; /dev/input/event●
</code></pre></div></div>

<p>とすると、タッチデータを再現することができますが、ここにも罠があります。<br>
それは、実行速度が早すぎることです（苦笑）。<br>
数秒間で記録したイベントデータが一瞬で流れてしまうので、早すぎてうまく操作できないと思います。<br>
操作を再現するにはsleepを挟むなどして、適切なタイミングでデータが送られるようにしなければいけません。</p>

<h2>
<span id="結局どうするのか" class="fragment"></span><a href="#%E7%B5%90%E5%B1%80%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>結局どうするのか</h2>

<p>要はPC側から送られてくるタッチイベントをデバイスファイルに流せれば良いわけです。<br>
シェルスクリプトでも書けるかもしれませんが、せっかくAndroid Studioで開発を行っているので<br>
Java/Kotlinで書ければ楽ですよね。しかし、今まで好き勝手にデバイスファイルにアクセスしていましたが、shell権限があってこそ成せた技なのです。つまり、通常のアプリにシステムファイルをいじる権限はないのです。（Root化されていれば別ですが）<br>
自分も諦めかけていましたがこんな質問を見つけました。<br>
<a href="https://stackoverflow.com/questions/32954720/how-does-vysor-create-touch-events-on-a-non-rooted-device" rel="nofollow noopener" target="_blank">How does vysor create touch events on a non rooted device?<br>
</a>VysorはRootを取っていない端末でどうやってリアルタイムのタッチイベントを実行しているのか？という質問です。<br>
そして解答は</p>

<blockquote>
<p>What he does is, he then starts his Main class as a separate process using this shell user. Now, the Java code inside that Main class has the same privileges as the shell user (because duh, it's linux).</p>

<p>彼が何をしているのかというと、Shellユーザーの権限を使用してMainクラスを別プロセスで起動しているんだよ。これでMainクラス内のJavaコードはShellユーザーと同じ権限を持っているわけさ（だってAndroidはLinuxだからね）</p>
</blockquote>

<p>つまり、shellからapkパッケージに含まれるクラスを実行するとその起動されたプログラムもshell権限を使用できるのです。<br>
言われてみれば、不思議な事ではありませんが、思いつきませんでした。<br>
今回はこの手法でリアルタイムタッチを実装しようと思います。</p>

<h1>
<span id="いざ実装" class="fragment"></span><a href="#%E3%81%84%E3%81%96%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>いざ、実装</h1>

<p>前述のようにアプリからシステム領域に介入するにはshellの力が必要です。<br>
まず、apkパッケージに含まれるクラスをshell権限で起動するには以下のようにします。</p>

<div class="code-frame" data-lang="shell"><div class="highlight"><pre class="with-code"><code>sh <span class="nt">-c</span> <span class="s2">"CLASSPATH=[apkファイルへのパス] /system/bin/app_process /system/bin [パッケージ名].[mainメソッドを含むクラスの名前]"</span>
</code></pre></div></div>

<p>apkファイルへのパスは</p>

<div class="code-frame" data-lang="shell"><div class="highlight"><pre class="with-code"><code>pm path <span class="o">[</span>パッケージ名]
</code></pre></div></div>

<p>で取得できますが、ここで普通にAndroid Studioでデバッグをしていると複数のパスが表示されます。<br>
これはInstant Runという、ビルド時間を短縮したりプログラムの変更をリアルタイムで反映させる機能を使っている際に起こる現象です。<br>
apkを複数に分割することで、変更時に差分のみをビルド、インストールして時短を図っているものと思われます。<br>
しかし、分割されてしまっては上記のコマンドが正しく動かないので、Instant Runを無効にする必要があります。<br>
設定の場所は以下のとおりです。<br>
<a href="https://camo.qiitausercontent.com/c0eccdd17097f4171c715b6e0e27967904f8dd1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f34623938653832312d373264322d393237372d393437662d6533373939323936356163642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F4b98e821-72d2-9277-947f-e37992965acd.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4237ebe24e29701a574d5d4181124deb" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/89220/4b98e821-72d2-9277-947f-e37992965acd.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F4b98e821-72d2-9277-947f-e37992965acd.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8b294f481e00d7668601c7f4c70b837e 1x" loading="lazy"></a></p>

<p>さらに注意なのが、ユーザーが起動するアプリ本体とshell権限で起動するプログラムは、同じパッケージに属するものの、プロセスが違うため、staticの共有などは一切できません。<br>
その為、やり取りをしたい場合はsocketなどを通して行うことになります。</p>

<h2>
<span id="プログラムからイベントをシステムに介入させる" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%8B%E3%82%89%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E4%BB%8B%E5%85%A5%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>プログラムからイベントをシステムに介入させる</h2>

<p>まずは以下のコードを見てください。</p>

<div class="code-frame" data-lang="java">
<div class="code-lang"><span class="bold">InputService.java</span></div>
<div class="highlight"><pre class="with-code"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InputService</span> <span class="o">{</span>
    <span class="nc">InputManager</span> <span class="n">im</span><span class="o">;</span>
    <span class="nc">Method</span> <span class="n">injectInputEventMethod</span><span class="o">;</span>


    <span class="kd">public</span> <span class="nf">InputService</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="c1">//InputManagerのインスタンスを取得</span>
        <span class="n">im</span> <span class="o">=</span> <span class="o">(</span><span class="nc">InputManager</span><span class="o">)</span> <span class="nc">InputManager</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"getInstance"</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>

        <span class="c1">//MotionEventを生成するstaticメソッドを呼べるようにする</span>
        <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span>
                <span class="s">"obtain"</span><span class="o">,</span>
                <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">PointerProperties</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">PointerCoords</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span>
                <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span>
        <span class="o">).</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="c1">//システムにイベントを介入させるメソッドを取得</span>
        <span class="n">injectInputEventMethod</span> <span class="o">=</span> <span class="nc">InputManager</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"injectInputEvent"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]{</span><span class="nc">InputEvent</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">});</span>

    <span class="o">}</span>

    <span class="c1">//タッチイベントを生成</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">injectMotionEvent</span><span class="o">(</span><span class="kt">int</span> <span class="n">inputSource</span><span class="o">,</span> <span class="kt">int</span> <span class="n">action</span><span class="o">,</span> <span class="kt">float</span> <span class="n">x</span><span class="o">,</span> <span class="kt">float</span> <span class="n">y</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InvocationTargetException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span> <span class="o">{</span>

        <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">PointerProperties</span><span class="o">[]</span> <span class="n">pointerProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">PointerProperties</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
        <span class="n">pointerProperties</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">PointerProperties</span><span class="o">();</span>
        <span class="n">pointerProperties</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">id</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>


        <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">PointerCoords</span><span class="o">[]</span> <span class="n">pointerCoords</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">PointerCoords</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
        <span class="n">pointerCoords</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">PointerCoords</span><span class="o">();</span>
        <span class="n">pointerCoords</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">pressure</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">pointerCoords</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">size</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">pointerCoords</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">touchMajor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">pointerCoords</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">touchMinor</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">pointerCoords</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
        <span class="n">pointerCoords</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>

        <span class="nc">MotionEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">(),</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">(),</span> <span class="n">action</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">pointerProperties</span><span class="o">,</span> <span class="n">pointerCoords</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">inputSource</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">injectInputEventMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">im</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">event</span><span class="o">,</span> <span class="mi">0</span><span class="o">});</span>
    <span class="o">}</span>

    <span class="c1">//キーイベントを生成</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">injectKeyEvent</span><span class="o">(</span><span class="nc">KeyEvent</span> <span class="n">event</span><span class="o">)</span><span class="kd">throws</span> <span class="nc">InvocationTargetException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span><span class="o">{</span>
        <span class="n">injectInputEventMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">im</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">event</span><span class="o">,</span> <span class="mi">0</span><span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>
</div>

<p>このコードは<a href="https://github.com/omerjerk/RemoteDroid/blob/master/app/src/main/java/in/omerjerk/remotedroid/app/EventInput.java" rel="nofollow noopener" target="_blank">ここ</a>を参考に、新しいAPIを使用するように多少変更しています。</p>

<p>通常はアクセスできないシステムのメソッドやインスタンスに、shell権限を利用してリフレクションでアクセスするという力技を行っています。<br>
「injectInputEvent」というのがそうで、そのメソッドにイベントデータを渡すとイベントが実行されます。<br>
そのメソッドは実際どこにあるのか、AOSPのソースを見てみたところ、<a href="http://tools.oesf.biz/android-8.1.0_r1.0/xref/frameworks/base/core/java/android/hardware/input/InputManager.java" rel="nofollow noopener" target="_blank">ここ</a>の914行目にありました。<br>
Hideアノテーションで普通はアクセス出来ないようになっています。<br>
リフレクション？という方は<a href="http://fantastic-works.com/archives/192" rel="nofollow noopener" target="_blank">この記事</a>が参考になるかと思います。</p>

<h2>
<span id="input-host-serverの実装" class="fragment"></span><a href="#input-host-server%E3%81%AE%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>Input Host Serverの実装</h2>

<p>パソコンから送られてくるイベントを上記のInputServiceクラスを使用して実行します。</p>

<div class="code-frame" data-lang="java">
<div class="code-lang"><span class="bold">InputHost.java</span></div>
<div class="highlight"><pre class="with-code"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InputHost</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="nc">InputService</span> <span class="n">inputService</span><span class="o">;</span>

    <span class="kd">static</span> <span class="nc">ServerSocket</span> <span class="n">listener</span><span class="o">;</span><span class="c1">//サーバーソケット</span>

    <span class="kd">static</span> <span class="nc">Socket</span> <span class="n">clientSocket</span><span class="o">;</span><span class="c1">//クライアント側へのソケット</span>
    <span class="kd">static</span> <span class="nc">InputStream</span> <span class="n">inputStream</span><span class="o">;</span><span class="c1">//クライアントからのメッセージ受信用</span>
    <span class="kd">static</span> <span class="nc">OutputStream</span> <span class="n">outputStream</span><span class="o">;</span><span class="c1">//クライアントへのデータ送信用ストリーム</span>


    <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">runnning</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">inputService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputService</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">listener</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">();</span>
            <span class="n">listener</span><span class="o">.</span><span class="na">setReuseAddress</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">listener</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8081</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server listening on port 8081..."</span><span class="o">);</span>

            <span class="n">clientSocket</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span><span class="c1">//接続まで待機</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Connected"</span><span class="o">);</span>

            <span class="n">inputStream</span> <span class="o">=</span> <span class="n">clientSocket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="n">clientSocket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>

            <span class="n">runnning</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

            <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>

            <span class="k">while</span> <span class="o">(</span><span class="n">runnning</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
                <span class="nc">String</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="s">"screen"</span><span class="o">))</span> <span class="o">{</span><span class="c1">//タッチデータの場合</span>
                        <span class="n">inputService</span><span class="o">.</span><span class="na">injectMotionEvent</span><span class="o">(</span><span class="nc">InputDeviceCompat</span><span class="o">.</span><span class="na">SOURCE_TOUCHSCREEN</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="mi">1</span><span class="o">]),</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="mi">2</span><span class="o">]),</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="mi">3</span><span class="o">]));</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="s">"key"</span><span class="o">))</span> <span class="o">{</span><span class="c1">//キーの場合</span>
                        <span class="n">inputService</span><span class="o">.</span><span class="na">injectKeyEvent</span><span class="o">(</span><span class="k">new</span> <span class="nc">KeyEvent</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="mi">1</span><span class="o">]),</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="mi">2</span><span class="o">])));</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="s">"exit"</span><span class="o">))</span> <span class="o">{</span><span class="c1">//終了コール</span>
                        <span class="nc">Disconnect</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="nc">Disconnect</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="c1">//切断処理</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">Disconnect</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">runnning</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>

            <span class="n">listener</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">clientSocket</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">clientSocket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Disconnected"</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
</div>

<p>単純なサーバープログラムです。<br>
PCとのデータのやり取りをjsonを使ってモダンにすることも考えたのですが、<br>
大したことはしないので、空白を区切りとしたcsvのような形式で送ることにしました。</p>

<p>Android側の実装はこれだけです。<br>
<strong>全体のコードは<a href="https://github.com/SIY1121/ScreenCastSample" rel="nofollow noopener" target="_blank">こちら</a></strong></p>

<p>次にPC側の実装を行います。</p>

<h2>
<span id="クライアントの作成" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>クライアントの作成</h2>

<p>C# &amp; WPFで作成しようと思います。<br>
WinFormsを選ばなかった理由は、仕様的？に画像を60FPSで表示することが困難だったからです。<br>
実装してみたら体感30FPSくらいでした。<br>
DoubleBufferedを無効にすると60FPSになりましたがチラツキがすごく、実用的ではありませんでした。</p>

<p>WPFも微妙な感じがしますが、GPUを描画に使っている分WinFormsよりはマシです。<br>
本気でやるならOpenGL(C#ならOpenTK)などのグラフィックAPIを使うことになりますね...<br>
まさか、送信側より受信側がボトルネックになるとは思いませんでした^^;</p>

<p><strong>クライアントの全体のコードは<a href="https://github.com/SIY1121/ScreenCastClient" rel="nofollow noopener" target="_blank">こちら</a></strong></p>

<h3>
<span id="ui" class="fragment"></span><a href="#ui"><i class="fa fa-link"></i></a>UI</h3>

<p><a href="https://camo.qiitausercontent.com/4e465e64bf6386f2e6fafaa3be749731ac7a2e23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f37623538356666312d663061372d363736632d303664312d3531316665333064313136662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F7b585ff1-f0a7-676c-06d1-511fe30d116f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=177218aba29d025596f21f0379a77acf" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/89220/7b585ff1-f0a7-676c-06d1-511fe30d116f.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F7b585ff1-f0a7-676c-06d1-511fe30d116f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5dd0df1e08d011d3c592b945b7722812 1x" loading="lazy"></a></p>

<div class="code-frame" data-lang="xml">
<div class="code-lang"><span class="bold">MainWindow.xaml</span></div>
<div class="highlight"><pre class="with-code"><code><span class="nt">&lt;Window</span> <span class="na">x:Class=</span><span class="s">"ScreenCastClient.MainWindow"</span>
        <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
        <span class="na">xmlns:x=</span><span class="s">"http://schemas.microsoft.com/winfx/2006/xaml"</span>
        <span class="na">xmlns:d=</span><span class="s">"http://schemas.microsoft.com/expression/blend/2008"</span>
        <span class="na">xmlns:mc=</span><span class="s">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span>
        <span class="na">xmlns:local=</span><span class="s">"clr-namespace:ScreenCastClient"</span>
        <span class="na">mc:Ignorable=</span><span class="s">"d"</span>
        <span class="na">Title=</span><span class="s">"ScreenCastClient"</span> <span class="na">Height=</span><span class="s">"819.649"</span> <span class="na">Width=</span><span class="s">"420.611"</span> <span class="na">Loaded=</span><span class="s">"Window_Loaded"</span> <span class="na">Closing=</span><span class="s">"Window_Closing"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Grid&gt;</span>
        <span class="nt">&lt;Grid.RowDefinitions&gt;</span>
            <span class="nt">&lt;RowDefinition/&gt;</span>
            <span class="nt">&lt;RowDefinition</span> <span class="na">Height=</span><span class="s">"60"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Grid.RowDefinitions&gt;</span>
        <span class="nt">&lt;Image</span> <span class="na">x:Name=</span><span class="s">"image"</span> <span class="na">MouseDown=</span><span class="s">"image_MouseDown"</span> <span class="na">MouseUp=</span><span class="s">"image_MouseUp"</span> <span class="na">MouseMove=</span><span class="s">"image_MouseMove"</span><span class="nt">/&gt;</span>

        <span class="nt">&lt;Grid</span> <span class="na">Grid.Row=</span><span class="s">"1"</span> <span class="na">Background=</span><span class="s">"#FF008BFF"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;Grid.ColumnDefinitions&gt;</span>
                <span class="nt">&lt;ColumnDefinition</span> <span class="na">Width=</span><span class="s">"204*"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;ColumnDefinition</span> <span class="na">Width=</span><span class="s">"193*"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/Grid.ColumnDefinitions&gt;</span>
            <span class="nt">&lt;Polygon</span> <span class="na">Points=</span><span class="s">"0,15 25,0 25,30"</span> <span class="na">Fill=</span><span class="s">"White"</span> <span class="na">Margin=</span><span class="s">"30,17,0,0"</span> <span class="na">HorizontalAlignment=</span><span class="s">"Left"</span> <span class="na">Width=</span><span class="s">"36"</span> <span class="na">MouseDown=</span><span class="s">"Polygon_MouseDown"</span> <span class="na">MouseUp=</span><span class="s">"Polygon_MouseUp"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;Ellipse</span> <span class="na">Fill=</span><span class="s">"White"</span> <span class="na">Margin=</span><span class="s">"186,18,181,12"</span> <span class="na">Width=</span><span class="s">"30"</span> <span class="na">HorizontalAlignment=</span><span class="s">"Center"</span> <span class="na">MouseDown=</span><span class="s">"Ellipse_MouseDown"</span> <span class="na">MouseUp=</span><span class="s">"Ellipse_MouseUp"</span> <span class="na">Grid.ColumnSpan=</span><span class="s">"2"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;Rectangle</span> <span class="na">Fill=</span><span class="s">"White"</span> <span class="na">Margin=</span><span class="s">"0,17,30,10"</span> <span class="na">HorizontalAlignment=</span><span class="s">"Right"</span> <span class="na">Width=</span><span class="s">"30"</span> <span class="na">MouseDown=</span><span class="s">"Rectangle_MouseDown"</span> <span class="na">MouseUp=</span><span class="s">"Rectangle_MouseUp"</span> <span class="na">Grid.Column=</span><span class="s">"1"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Grid&gt;</span>
    <span class="nt">&lt;/Grid&gt;</span>
<span class="nt">&lt;/Window&gt;</span>
</code></pre></div>
</div>

<h3>
<span id="この先使うメソッド" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E5%85%88%E4%BD%BF%E3%81%86%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>この先使うメソッド</h3>

<p>この先頻繁に使う機能をまとめておきます。<br>
あるデータから必要な数値のみを取り出す、といった場合正規表現がかなり便利です。<br>
さらにその検証に<a href="https://regex101.com/" rel="nofollow noopener" target="_blank">Online regex tester and debugger: PHP, PCRE, Python, Golang and JavaScript</a><br>
こういったサイトがとても便利です。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code>        <span class="c1">//コマンド実行して標準出力を返すだけ</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="nf">Exec</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Process</span> <span class="n">process</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Process</span>
            <span class="p">{</span>
                <span class="n">StartInfo</span> <span class="p">=</span>
                 <span class="p">{</span>
                    <span class="n">FileName</span> <span class="p">=</span>  <span class="s">"cmd"</span><span class="p">,</span>
                    <span class="n">Arguments</span> <span class="p">=</span> <span class="s">@"/c "</span> <span class="p">+</span> <span class="n">str</span><span class="p">,</span>
                    <span class="n">UseShellExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
                    <span class="n">CreateNoWindow</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                    <span class="n">RedirectStandardInput</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                    <span class="n">RedirectStandardError</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                    <span class="n">RedirectStandardOutput</span> <span class="p">=</span> <span class="k">true</span>
                 <span class="p">},</span>
                <span class="n">EnableRaisingEvents</span> <span class="p">=</span> <span class="k">true</span>
            <span class="p">};</span>
            <span class="n">process</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
            <span class="kt">string</span> <span class="n">results</span> <span class="p">=</span> <span class="n">process</span><span class="p">.</span><span class="n">StandardOutput</span><span class="p">.</span><span class="nf">ReadToEnd</span><span class="p">();</span>
            <span class="n">process</span><span class="p">.</span><span class="nf">WaitForExit</span><span class="p">();</span>
            <span class="n">process</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//正規表現でマッチしたデータを配列で返す</span>
        <span class="k">private</span> <span class="kt">string</span><span class="p">[]</span> <span class="nf">GetRegexResult</span><span class="p">(</span><span class="kt">string</span> <span class="n">src</span><span class="p">,</span> <span class="kt">string</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Regex</span> <span class="n">regex</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="n">pattern</span><span class="p">);</span>
            <span class="n">Match</span> <span class="n">match</span> <span class="p">=</span> <span class="n">regex</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
            <span class="kt">string</span><span class="p">[]</span> <span class="n">res</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="n">res</span><span class="p">[</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="ffmpegと連携して動画をデコード表示する" class="fragment"></span><a href="#ffmpeg%E3%81%A8%E9%80%A3%E6%90%BA%E3%81%97%E3%81%A6%E5%8B%95%E7%94%BB%E3%82%92%E3%83%87%E3%82%B3%E3%83%BC%E3%83%89%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>FFmpegと連携して動画をデコード、表示する</h3>

<p>どんなOSのアプリケーションにも標準で入力、出力する機能が備わっています。<br>
<a href="https://camo.qiitausercontent.com/dc51726891df24226d56c337bedcd06e247cde78/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f64396335363237362d313366652d363263662d623134612d6463356635373163303730362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fd9c56276-13fe-62cf-b14a-dc5f571c0706.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f602bf7ab471ee0b1d06c3e76af61b8c" alt="fig8-2.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/89220/d9c56276-13fe-62cf-b14a-dc5f571c0706.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fd9c56276-13fe-62cf-b14a-dc5f571c0706.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4ca85b5cf8ce37f667c0cb4f51241962 1x" loading="lazy"></a></p>

<p>一般的な動画変換ソフトでは入出力をファイルで行いますが、FFmpegは標準入出力が使えるので出力先をstdoutにすることで、プログラムからデコードされたデータを読むことができます。また、FFmpegの場合、stderrからログが出力される仕様になっています。<br>
以下のプログラムはFFmpegを起動し、stdout、stderrとのコネクションを確立するものです。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code>        <span class="k">private</span> <span class="k">void</span> <span class="nf">StartFFmpeg</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">//ポートの設定</span>
            <span class="nf">Exec</span><span class="p">(</span><span class="s">"adb forward tcp:8080 tcp:8080"</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">inputArgs</span> <span class="p">=</span> <span class="s">"-framerate 60  -analyzeduration 100 -i tcp://127.0.0.1:8080"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">outputArgs</span> <span class="p">=</span> <span class="s">"-f rawvideo -pix_fmt bgr24 -r 60 -flags +global_header - "</span><span class="p">;</span>
            <span class="n">Process</span> <span class="n">process</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Process</span>
            <span class="p">{</span>
                <span class="n">StartInfo</span> <span class="p">=</span>
                 <span class="p">{</span>
                    <span class="n">FileName</span> <span class="p">=</span> <span class="s">"ffmpeg.exe"</span><span class="p">,</span>
                    <span class="n">Arguments</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">inputArgs</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">outputArgs</span><span class="p">}</span><span class="s">"</span><span class="p">,</span>
                    <span class="n">UseShellExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
                    <span class="n">CreateNoWindow</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                    <span class="n">RedirectStandardInput</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                    <span class="n">RedirectStandardError</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span><span class="c1">//stderrを読めるようにする</span>
                    <span class="n">RedirectStandardOutput</span><span class="p">=</span><span class="k">true</span><span class="c1">//stdoutを読めるようにする</span>
                 <span class="p">},</span>
                <span class="n">EnableRaisingEvents</span> <span class="p">=</span> <span class="k">true</span>
            <span class="p">};</span>
            <span class="n">process</span><span class="p">.</span><span class="n">ErrorDataReceived</span> <span class="p">+=</span> <span class="n">Process_ErrorDataReceived</span><span class="p">;</span><span class="c1">//stderrからはログが流れてくるので別途処理する</span>
            <span class="n">process</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
            <span class="n">rawStream</span> <span class="p">=</span> <span class="n">process</span><span class="p">.</span><span class="n">StandardOutput</span><span class="p">.</span><span class="n">BaseStream</span><span class="p">;</span><span class="c1">//stdoutからはデータが流れてくるのでストリームを取得しておく</span>
            <span class="n">process</span><span class="p">.</span><span class="nf">BeginErrorReadLine</span><span class="p">();</span>
            <span class="n">running</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="c1">//別スレッドで読み取り開始</span>
                <span class="nf">ReadRawData</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">}</span>
</code></pre></div>
</div>

<p>必要な引数を設定しFFmpegを起動します。<br>
出力からデータを取得する方法には２つの方法があり、１つ目がイベントに登録する方法、２つ目がストリームを取得し自分で読む方法です。<br>
前者は手軽に取得することができますが、文字データに変換されるのでバイナリデータのやり取りには使用できません。<br>
後者はストリームを扱うので少々面倒ですが細かい制御が可能です。<br>
今回、stderrからはログが流れてくるので前者を、stdoutからは画像のバイナリデータが流れてくるので後者の方法でデータを読み出します。</p>

<h3>
<span id="ffmpegから送られてくるログを処理する" class="fragment"></span><a href="#ffmpeg%E3%81%8B%E3%82%89%E9%80%81%E3%82%89%E3%82%8C%E3%81%A6%E3%81%8F%E3%82%8B%E3%83%AD%E3%82%B0%E3%82%92%E5%87%A6%E7%90%86%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>FFmpegから送られてくるログを処理する</h3>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code>        <span class="c1">//FFmpegからの標準エラー出力を読む</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">Process_ErrorDataReceived</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">DataReceivedEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Data</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Data</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">imageWidth</span> <span class="p">==</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">imageHeight</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span><span class="c1">//送られてくるサイズがまだ確定していないとき</span>
            <span class="p">{</span>
                <span class="c1">//FFmpegの出力からサイズを抜き取る荒業</span>
                <span class="kt">string</span><span class="p">[]</span> <span class="n">res</span> <span class="p">=</span> <span class="nf">GetRegexResult</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Data</span><span class="p">,</span> <span class="s">@"([0-9]*?)x([0-9]*?), [0-9]*? fps"</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">2</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">imageWidth</span> <span class="p">=</span> <span class="kt">int</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
                    <span class="n">imageHeight</span> <span class="p">=</span> <span class="kt">int</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
                    <span class="n">bytePerframe</span> <span class="p">=</span> <span class="n">imageWidth</span> <span class="p">*</span> <span class="n">imageHeight</span> <span class="p">*</span> <span class="m">3</span><span class="p">;</span>

                    <span class="k">if</span><span class="p">(</span><span class="n">imageWidth</span><span class="p">&gt;</span><span class="n">imageHeight</span><span class="p">)</span><span class="c1">//横向き画面の場合</span>
                    <span class="p">{</span>
                        <span class="c1">//タッチ座標の最大値と最小値を入れ替える</span>
                        <span class="kt">int</span> <span class="n">tmp</span> <span class="p">=</span> <span class="n">displayWidth</span><span class="p">;</span>
                        <span class="n">displayWidth</span> <span class="p">=</span> <span class="n">displayHeight</span><span class="p">;</span>
                        <span class="n">displayHeight</span> <span class="p">=</span> <span class="n">tmp</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="n">Dispatcher</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="c1">//UIスレッドでBitmapを作成しないと、UIに反映できない</span>
                        <span class="n">writeableBitmap</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WriteableBitmap</span><span class="p">(</span><span class="n">imageWidth</span><span class="p">,</span> <span class="n">imageHeight</span><span class="p">,</span> <span class="m">96</span><span class="p">,</span> <span class="m">96</span><span class="p">,</span> <span class="n">PixelFormats</span><span class="p">.</span><span class="n">Bgr24</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
                        <span class="n">image</span><span class="p">.</span><span class="n">Source</span> <span class="p">=</span> <span class="n">writeableBitmap</span><span class="p">;</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="p">}</span>
</code></pre></div>
</div>

<p>今後送られてくる生データを復元するには画像のサイズが必須です。<br>
FFmpegは変換を開始する時に、これから出力するストリームの情報をログに出力するのでそこから画像のサイズを抜き取る荒業を行います。<br>
またbytePerFrameという変数は1フレームの画像の生成に必要なバイト数です。<br>
画像の縦x横x1ピクセルに使用するバイト数で算出できます。<br>
今回はFFmpegにrgb24で出力するよう設定している(rgbにそれぞれ8bitで24bit)ので1ピクセルに使用するバイト数は3です。<br>
画像の仕組みの知識に不安がある方は、<a href="http://www.cg-ya.net/2dcg/aboutimage/basic-knowledge-degitalimage/" rel="nofollow noopener" target="_blank">意外と知らない？画像の基礎知識とファイルの構造。</a>を読んでみてください。</p>

<h3>
<span id="ffmpegから送られてくるデータを画像に戻す" class="fragment"></span><a href="#ffmpeg%E3%81%8B%E3%82%89%E9%80%81%E3%82%89%E3%82%8C%E3%81%A6%E3%81%8F%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%94%BB%E5%83%8F%E3%81%AB%E6%88%BB%E3%81%99"><i class="fa fa-link"></i></a>FFmpegから送られてくるデータを画像に戻す</h3>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code>        <span class="c1">//FFmpegからのrawStreamを読んでBitmapに書き込む</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">ReadRawData</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">MemoryStream</span> <span class="n">ms</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">();</span>

            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buf</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">10240</span><span class="p">];</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">resSize</span> <span class="p">=</span> <span class="n">rawStream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">ms</span><span class="p">.</span><span class="n">Length</span> <span class="p">+</span> <span class="n">resSize</span> <span class="p">&gt;=</span> <span class="n">bytePerframe</span><span class="p">)</span><span class="c1">//今回読んだデータで1フレーム分のデータに達したか、上回った場合</span>
                <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">needSize</span> <span class="p">=</span> <span class="n">bytePerframe</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ms</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span><span class="c1">//1フレームに必要な残りのデータのサイズ</span>
                    <span class="kt">int</span> <span class="n">remainSize</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ms</span><span class="p">.</span><span class="n">Length</span> <span class="p">+</span> <span class="n">resSize</span> <span class="p">-</span> <span class="n">bytePerframe</span><span class="p">;</span><span class="c1">//余ったデータのサイズ</span>

                    <span class="n">ms</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">bytePerframe</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ms</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span><span class="c1">//1フレームに必要な残りのデータを読む</span>

                    <span class="n">Dispatcher</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(()</span> <span class="p">=&gt;</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">writeableBitmap</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span><span class="c1">//データを書き込む</span>
                            <span class="n">writeableBitmap</span><span class="p">.</span><span class="nf">WritePixels</span><span class="p">(</span><span class="k">new</span> <span class="nf">Int32Rect</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">imageWidth</span><span class="p">,</span> <span class="n">imageHeight</span><span class="p">),</span> <span class="n">ms</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">(),</span> <span class="m">3</span> <span class="p">*</span> <span class="n">imageWidth</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                    <span class="p">});</span>

                    <span class="n">ms</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
                    <span class="n">ms</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">();</span>
                    <span class="n">ms</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">needSize</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">remainSize</span><span class="p">);</span><span class="c1">//余ったデータを書き込む</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">ms</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">resSize</span><span class="p">);</span><span class="c1">//データを蓄積</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>
</div>

<p>ストリームからデータを取得し、MemoryStreamに蓄積していきます。<br>
1フレーム分のデータが確保できた場合、MemoryStream内のデータを画像に復元します。<br>
WritableBitmapに配列から復元してくれるメソッドがあるのでそれを使用します。<br>
また、WritableBitmapへのアクセスはUIスレッドで行う必要があります。</p>

<h3>
<span id="inputhostを起動し接続する" class="fragment"></span><a href="#inputhost%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%97%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>InputHostを起動し、接続する</h3>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindows.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code>        <span class="c1">//InputHostを起動し、接続する</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">StartInputHost</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">inputInfo</span> <span class="p">=</span> <span class="nf">Exec</span><span class="p">(</span><span class="s">"adb shell getevent -i"</span><span class="p">);</span><span class="c1">//Android端末の入力に関わるデータを取得</span>
            <span class="c1">//中からタッチ座標の最大値を抜き取る</span>
            <span class="kt">string</span><span class="p">[]</span> <span class="n">tmp</span> <span class="p">=</span> <span class="nf">GetRegexResult</span><span class="p">(</span><span class="n">inputInfo</span><span class="p">,</span> <span class="s">@"ABS[\s\S]*?35.*?max (.*?),[\s\S]*?max (.*?),"</span><span class="p">);</span>
            <span class="n">displayWidth</span> <span class="p">=</span> <span class="kt">int</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
            <span class="n">displayHeight</span> <span class="p">=</span> <span class="kt">int</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>

            <span class="c1">//ポートの設定</span>
            <span class="nf">Exec</span><span class="p">(</span><span class="s">"adb forward tcp:8081 tcp:8081"</span><span class="p">);</span>
            <span class="c1">//アプリのパスを取得</span>
            <span class="c1">//余計な文字や改行コードは削除</span>
            <span class="kt">string</span> <span class="n">pathToPackage</span> <span class="p">=</span> <span class="nf">Exec</span><span class="p">(</span><span class="s">"adb shell pm path space.siy.screencastsample"</span><span class="p">).</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"package:"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"\r\n"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>

            <span class="n">Process</span> <span class="n">process</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Process</span>
            <span class="p">{</span>
                <span class="n">StartInfo</span> <span class="p">=</span>
                 <span class="p">{</span>
                    <span class="n">FileName</span> <span class="p">=</span> <span class="s">"adb"</span><span class="p">,</span>
                    <span class="n">Arguments</span> <span class="p">=</span> <span class="s">$"shell"</span><span class="p">,</span>
                    <span class="n">UseShellExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
                    <span class="n">CreateNoWindow</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                    <span class="n">RedirectStandardInput</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                    <span class="n">RedirectStandardError</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                    <span class="n">RedirectStandardOutput</span> <span class="p">=</span> <span class="k">true</span>
                 <span class="p">},</span>
                <span class="n">EnableRaisingEvents</span> <span class="p">=</span> <span class="k">true</span>
            <span class="p">};</span>
            <span class="n">process</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
            <span class="n">process</span><span class="p">.</span><span class="n">OutputDataReceived</span> <span class="p">+=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Data</span><span class="p">);</span><span class="c1">//今後なにか処理をするかも</span>
            <span class="p">};</span>
            <span class="n">process</span><span class="p">.</span><span class="nf">BeginOutputReadLine</span><span class="p">();</span>
            <span class="c1">//Shell権限でInputHostを起動</span>
            <span class="n">process</span><span class="p">.</span><span class="n">StandardInput</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"sh -c \"CLASSPATH=</span><span class="p">{</span><span class="n">pathToPackage</span><span class="p">}</span><span class="s"> /system/bin/app_process /system/bin space.siy.screencastsample.InputHost\""</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span><span class="c1">//起動するまで待機</span>
            <span class="n">TcpClient</span> <span class="n">tcp</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TcpClient</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="m">8081</span><span class="p">);</span><span class="c1">//InputHostに接続</span>
            <span class="n">streamToInputHost</span> <span class="p">=</span> <span class="n">tcp</span><span class="p">.</span><span class="nf">GetStream</span><span class="p">();</span>
        <span class="p">}</span>
</code></pre></div>
</div>

<p>始めに adb shell getevent -iを実行し、出力を読み取っていますが、<br>
このコマンドはAndroidの入力デバイスに関するデータを表示するコマンドです。<br>
ここでは、タッチパネルがとり得る座標の最大値を取得しています。<br>
そして、InputHostを起動しています。<br>
起動するまで１秒待機と荒いことをやっていますがご了承ください。</p>

<h3>
<span id="inputhostにデータを送る" class="fragment"></span><a href="#inputhost%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E9%80%81%E3%82%8B"><i class="fa fa-link"></i></a>InputHostにデータを送る</h3>

<p>接続周りの準備は完了したので、あとはInputHostにデータを送信していくだけです。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code>        <span class="k">private</span> <span class="k">void</span> <span class="nf">image_MouseDown</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">MouseButtonEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Point</span> <span class="n">p</span> <span class="p">=</span> <span class="nf">GetDisplayPosition</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">GetPosition</span><span class="p">(</span><span class="n">image</span><span class="p">));</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">sendByte</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$"screen 0 </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">X</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">Y</span><span class="p">}</span><span class="s">\n"</span><span class="p">);</span>
            <span class="n">streamToInputHost</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sendByte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sendByte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">mouseDown</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">image_MouseMove</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">MouseEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mouseDown</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Point</span> <span class="n">p</span> <span class="p">=</span> <span class="nf">GetDisplayPosition</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">GetPosition</span><span class="p">(</span><span class="n">image</span><span class="p">));</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">sendByte</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$"screen 2 </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">X</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">Y</span><span class="p">}</span><span class="s">\n"</span><span class="p">);</span>
                <span class="n">streamToInputHost</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sendByte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sendByte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">image_MouseUp</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">MouseButtonEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Point</span> <span class="n">p</span> <span class="p">=</span> <span class="nf">GetDisplayPosition</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">GetPosition</span><span class="p">(</span><span class="n">image</span><span class="p">));</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">sendByte</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$"screen 1 </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">X</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">Y</span><span class="p">}</span><span class="s">\n"</span><span class="p">);</span>
            <span class="n">streamToInputHost</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sendByte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sendByte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">mouseDown</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//マウスの位置を端末のタッチ座標に変換</span>
        <span class="k">private</span> <span class="n">Point</span> <span class="nf">GetDisplayPosition</span><span class="p">(</span><span class="n">Point</span> <span class="n">p</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">x</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">p</span><span class="p">.</span><span class="n">X</span> <span class="p">/</span> <span class="n">image</span><span class="p">.</span><span class="n">ActualWidth</span> <span class="p">*</span> <span class="n">displayWidth</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">y</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">p</span><span class="p">.</span><span class="n">Y</span> <span class="p">/</span> <span class="n">image</span><span class="p">.</span><span class="n">ActualHeight</span> <span class="p">*</span> <span class="n">displayHeight</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div>
</div>

<p>imageのマウスに関するイベントを使用し、データを送信しています。<br>
空白区切で２つ目の0,1,2という数値は0がDonw、1がUp、2がMoveの意味です。<br>
また、キーイベントは以下のようにしています。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">MainWindow.xaml.cs</span></div>
<div class="highlight"><pre class="with-code"><code>        <span class="k">private</span> <span class="k">void</span> <span class="nf">Polygon_MouseDown</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">MouseButtonEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">sendByte</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$"key 0 4\n"</span><span class="p">);</span>
            <span class="n">streamToInputHost</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sendByte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sendByte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Polygon_MouseUp</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">MouseButtonEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">sendByte</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$"key 1 4\n"</span><span class="p">);</span>
            <span class="n">streamToInputHost</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sendByte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sendByte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Ellipse_MouseDown</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">MouseButtonEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">sendByte</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$"key 0 3\n"</span><span class="p">);</span>
            <span class="n">streamToInputHost</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sendByte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sendByte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Ellipse_MouseUp</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">MouseButtonEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">sendByte</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$"key 1 3\n"</span><span class="p">);</span>
            <span class="n">streamToInputHost</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sendByte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sendByte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Rectangle_MouseDown</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">MouseButtonEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">sendByte</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$"key 0 187\n"</span><span class="p">);</span>
            <span class="n">streamToInputHost</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sendByte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sendByte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">Rectangle_MouseUp</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">MouseButtonEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">sendByte</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="s">$"key 1 187\n"</span><span class="p">);</span>
            <span class="n">streamToInputHost</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">sendByte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sendByte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div>
</div>

<p>空白区切で２つ目は上と同じ意味です。<br>
３つ目はキーの固有番号で、<a href="https://developer.android.com/reference/android/view/KeyEvent.html" rel="nofollow noopener" target="_blank">KeyEvent</a>で確認ができます。<br>
また、端末に実装されていないキーも送ることができます。<br>
例えば120にはPrintScreenキーが割り振られています。<br>
スクリーンショットは普段は電源キーと音量Downの同時押しで行っていますが<br>
このキーを送信するだけでスクリーンショットが取れたりします。<br>
すぐに試したい方は</p>

<div class="code-frame" data-lang="shell"><div class="highlight"><pre class="with-code"><code>adb shell input keyevent 120
</code></pre></div></div>

<p>で再現できます。</p>

<h1>
<span id="実際に動かしてみる" class="fragment"></span><a href="#%E5%AE%9F%E9%9A%9B%E3%81%AB%E5%8B%95%E3%81%8B%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>実際に動かしてみる</h1>

<p>ポートフォアーティングやInputHostをshellから起動するなど、<br>
面倒なことは全てクライアントソフトに実装したので簡単です。</p>

<h2>
<span id="手順" class="fragment"></span><a href="#%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>手順</h2>

<p>１．Android側でアプリを起動し、スタートを押す<br>
２．クライアントソフトを起動する</p>

<p>これだけです。<br>
これで画面が映し出され、マウスで画面を操作することができます。</p>

<h1>
<span id="感想" class="fragment"></span><a href="#%E6%84%9F%E6%83%B3"><i class="fa fa-link"></i></a>感想</h1>

<p>Shellでapk内のクラスを実行するというのが普段のアプリ開発で無いことなので最初は戸惑いましたが、実装することができました。<br>
今回の機能でadbは必須になってしまったので通常のユーザーに配布するならadbを導入して貰う必要が出てしまいました。<br>
最も、今はadbのみのダウンロードができるようになっているので、導入の敷居も下がってると思いますが。（同梱はありなのかな？）</p>

<p>これでだいぶVysorに近づいてきました。<br>
ただ、まだ文字入力やファイル転送ができていないので、次はそこを実装したいと思います。<br>
では、最後までご覧下さりありがとうございました。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fsiy1121%2Fitems%2F9e96cb1eb14d9090a2b6&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fsiy1121%2Fitems%2F9e96cb1eb14d9090a2b6&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/siy1121/items/9e96cb1eb14d9090a2b6/likers" class="css-1iupg5d">52</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">42</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/9e96cb1eb14d9090a2b6/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/siy1121/items/9e96cb1eb14d9090a2b6/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/siy1121/items/9e96cb1eb14d9090a2b6/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/siy1121/items/9e96cb1eb14d9090a2b6/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/siy1121/items/9e96cb1eb14d9090a2b6.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-aecfc603-0e92-40dd-95af-89a7838ebb40">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-11a40696-612b-441d-a577-9a7303fa9856"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-11a40696-612b-441d-a577-9a7303fa9856">{}</script>
      
<div id="LoginModal-react-component-d8e83f64-b1c7-414e-9e43-e45eb728b6b1"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-d8e83f64-b1c7-414e-9e43-e45eb728b6b1">{}</script>
      
<div id="StockModal-react-component-60f6dc11-1449-4087-8011-d412bed238f4"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-60f6dc11-1449-4087-8011-d412bed238f4">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;Sp4EZ4qucBU8renVFm+cXhhnO2y7XBYyrWW06EphWHVUPIxc6pmglmCRpeCMu6tn5IkCMZjmT42D1vu0uXWLkA==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003eこの記事は\u003ca href=\"https://qiita.com/siy1121/items/71fadad0c3a1aa085867\" id=\"reference-b8aeb45819bc0fbd6342\"\u003eAndroidの画面をPCにミラーリングするソフトを作る１\u003c/a\u003eの続きです。\u003cbr\u003e\nAndroidの画面をミラーリングする機能の作り方は、そちらで解説しています。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"こんなものをつくります\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%82%93%E3%81%AA%E3%82%82%E3%81%AE%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%BE%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこんなものをつくります\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/9e5f5fc9d2e984e2f586dd00d4d360c1f0d01b51/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f31366635616631332d613062622d303532642d616531302d3664653163393839333236342e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F16f5af13-a0bb-052d-ae10-6de1c9893264.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=42b70384884e178fa6247abb06b4ac4f\" alt=\"capture5.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/89220/16f5af13-a0bb-052d-ae10-6de1c9893264.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F16f5af13-a0bb-052d-ae10-6de1c9893264.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=27398c76b5797599749a9c188a2c3a0d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eマウスでAndroid端末を操作できるようにします。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"仕様\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BB%95%E6%A7%98\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e仕様\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/45adf79c25874367909a08ce2f81dd947e6acbd4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f64313031306165612d656164332d366165322d653439312d3866653461313230306139332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fd1010aea-ead3-6ae2-e491-8fe4a1200a93.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=1fe3bdfd399ea4efc60aa2939e75c23e\" alt=\"fig7.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/89220/d1010aea-ead3-6ae2-e491-8fe4a1200a93.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fd1010aea-ead3-6ae2-e491-8fe4a1200a93.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5bd0ecee2b5051b8fd4a97c36fc88ada 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nAndroidとPC間のコネクションは１本にしたいところですが、プログラムが複雑になりそうだったので妥協しました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"クライアントソフトですること\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%BD%E3%83%95%E3%83%88%E3%81%A7%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eクライアントソフトですること\u003c/h2\u003e\n\n\u003cp\u003eFFmpegから流れてくるデータを表示します。\u003cbr\u003e\nまた、マウス操作をスクリーンのタッチ操作に変換して端末側に投げます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"android側ですること\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#android%E5%81%B4%E3%81%A7%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eAndroid側ですること\u003c/h2\u003e\n\n\u003cp\u003e前回同様、画面の内容をエンコードし、PC側に流します。\u003cbr\u003e\nまた、PC側からタッチイベントを受取り、それをシステムに介入させます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"pcからandroid端末を操作する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#pc%E3%81%8B%E3%82%89android%E7%AB%AF%E6%9C%AB%E3%82%92%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ePCからAndroid端末を操作する\u003c/h1\u003e\n\n\u003cp\u003eこのセクションでは、Android端末がどのようにタッチやキー操作を扱っているかについての説明をします。\u003cbr\u003e\n知らなくてもリアルタイムタッチの実装はできますので、興味がなければ「いざ、実装」まで飛ばしてください。\u003c/p\u003e\n\n\u003cp\u003ePCからAndroidを操作するにはどうすればいいのでしょうか？\u003cbr\u003e\n簡単な例から見てみます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"端末のシェルに入ってコマンドを叩く\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%AB%AF%E6%9C%AB%E3%81%AE%E3%82%B7%E3%82%A7%E3%83%AB%E3%81%AB%E5%85%A5%E3%81%A3%E3%81%A6%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E5%8F%A9%E3%81%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e端末のシェルに入ってコマンドを叩く\u003c/h2\u003e\n\n\u003cp\u003eAndroidはLinuxベースのOSです。ですから、機能限定版であるものの、Linuxのターミナルを使用できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"shell\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eadb shell\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとすることで対話に入ることができます。\u003cbr\u003e\nそして、タッチ操作やキー操作などを送る\u003cstrong\u003einput\u003c/strong\u003eというコマンドが用意されているのでそれを使用します。\u003cbr\u003e\n以下に例を出します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"shell\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003einput touchscreen tap x y\ninput touchscreen swipe x1 y1 x2 y2\ninput keyevent Key\ninput text Text\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれらを実行することで手軽に端末にイベントを送ることができます。\u003cbr\u003e\nしかし実行してみると、イベントが発行されるまで\u003cstrong\u003e時間がかかります\u003c/strong\u003e。\u003cbr\u003e\nこれではリアルタイムな操作に向きません。\u003cbr\u003e\nまた、タップやスワイプ以外の複雑な操作をしたい場合はどうすればよいのでしょうか。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"getevent-sendeventを使う\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#getevent-sendevent%E3%82%92%E4%BD%BF%E3%81%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003egetEvent sendEventを使う\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003egetevent\u003c/strong\u003eコマンドは端末のタッチパネルや物理キーから送られてくるデータを出力してくれるコマンドです。\u003cbr\u003e\n以下のコマンドを実行してからタッチパネルを操作してみてください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"shell\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003egetevent\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eすると以下の画像のように数値がズラッと表示されると思います。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/4b24e4954698ca13ca3589144b0efb335ae052fe/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f62353964326235352d303862322d376431302d313532342d6434323664343837313336322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fb59d2b55-08b2-7d10-1524-d426d4871362.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=88b6db5ea56641dad69aa2973a6f9c69\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/89220/b59d2b55-08b2-7d10-1524-d426d4871362.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fb59d2b55-08b2-7d10-1524-d426d4871362.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=583ef2084fbce72c7e6e41d8c19436f1 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれはタッチパネルから送られてくるデータです。\u003cbr\u003e\nOSはこのデータを解釈し、反映させます。\u003cbr\u003e\n実際にどのように解釈されているかについては\u003ca href=\"https://dev.classmethod.jp/smartphone/adb-attach-device/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e【Android】プログラムから端末をタッチする【ADB】\u003c/a\u003eで説明されているのでご覧ください。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003esendevent\u003c/strong\u003eはあたかもタッチパネルなどから送られてきたデータのように、任意のデータを送ることができるコマンドです。\u003cbr\u003e\nつまり、\u003cstrong\u003egetevent\u003c/strong\u003eで得たデータを\u003cstrong\u003esendevent\u003c/strong\u003eで送り直すことでタッチ操作を再現することができます。\u003cbr\u003e\nしかし、このコマンドも実行速度が遅く、完全再現とは行きません。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"デバイスファイルを直接操作する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%9B%B4%E6%8E%A5%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデバイスファイルを直接操作する\u003c/h2\u003e\n\n\u003cp\u003eAndroidはLinuxベースのため、デバイスファイルを使用しています。\u003cbr\u003e\nWindowsといったUnix系でないOSを使っている方には馴染みが無いかもしれませんが、\u003cbr\u003e\nデバイスファイルとは、接続されている様々なデバイスとやり取りを行うのに使用する特殊なファイルのことです。\u003cbr\u003e\n例えば、タッチパネルのデバイスファイルを開くと、geteventで得たようなタッチパネルの操作に関するデータを読み出すことができます。\u003cbr\u003e\n逆に、デバイスファイルに書き込むとsendeventと同じように、書き込んだデータはそのデバイスから送られてきたものとして処理されます。\u003cbr\u003e\n\u003ca href=\"http://wa3.i-3-i.info/word11689.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eデバイスファイル (device file)\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://uc2.h2np.net/index.php/%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%82%B9%E3%83%9A%E3%82%B7%E3%83%A3%E3%83%AB%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\" rel=\"nofollow noopener\" target=\"_blank\"\u003eデバイススペシャルファイル\u003c/a\u003e\u003cbr\u003e\nこのあたりが参考になると思います。\u003c/p\u003e\n\n\u003cp\u003eでは実際にデバイスファイルを開いてみましょう。\u003cbr\u003e\n先程の画像に/dev/input/event4というパスが記載されていると思います。\u003cbr\u003e\nこれがデバイスファイルの場所になります。\u003cbr\u003e\n/dev/inputディレクトリにはevent0、event1....といくつかのデバイスファイルが存在しており、それがタッチパネルや物理キー、センサーなどと対応しています。\u003cstrong\u003e対応する番号は端末によって違うので、注意してください。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"shell\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /dev/input/event●\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのコマンドを実行するとそのデバイスからのデータが流れてきます。が、こうなります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ea481bc1aa6cf23d5c7574838dda2b9154b68605/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f34636538373937332d393861332d376638352d646261312d6561383465626332303432642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F4ce87973-98a3-7f85-dba1-ea84ebc2042d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=08a081ce7e1c83a68aa73dc4791f9ddf\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/89220/4ce87973-98a3-7f85-dba1-ea84ebc2042d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F4ce87973-98a3-7f85-dba1-ea84ebc2042d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=68165bada82616aade36ee784badae48 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nデバイスファイルから得られる生データはバイナリデータであり、文字で表示するものではないのです。\u003cbr\u003e\ngetEventやsendEvent、冒頭で紹介したinputコマンドは、バイナリ⇔文字(数値)の変換を行ってくれているのです。\u003c/p\u003e\n\n\u003cp\u003eちなみに、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ecat /dev/input/event● \u0026gt; /sdcard/event.bin\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eと、することで生データをファイルに保存することができるので\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ecat /sdcard/event.bin \u0026gt; /dev/input/event●\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとすると、タッチデータを再現することができますが、ここにも罠があります。\u003cbr\u003e\nそれは、実行速度が早すぎることです（苦笑）。\u003cbr\u003e\n数秒間で記録したイベントデータが一瞬で流れてしまうので、早すぎてうまく操作できないと思います。\u003cbr\u003e\n操作を再現するにはsleepを挟むなどして、適切なタイミングでデータが送られるようにしなければいけません。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"結局どうするのか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E5%B1%80%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結局どうするのか\u003c/h2\u003e\n\n\u003cp\u003e要はPC側から送られてくるタッチイベントをデバイスファイルに流せれば良いわけです。\u003cbr\u003e\nシェルスクリプトでも書けるかもしれませんが、せっかくAndroid Studioで開発を行っているので\u003cbr\u003e\nJava/Kotlinで書ければ楽ですよね。しかし、今まで好き勝手にデバイスファイルにアクセスしていましたが、shell権限があってこそ成せた技なのです。つまり、通常のアプリにシステムファイルをいじる権限はないのです。（Root化されていれば別ですが）\u003cbr\u003e\n自分も諦めかけていましたがこんな質問を見つけました。\u003cbr\u003e\n\u003ca href=\"https://stackoverflow.com/questions/32954720/how-does-vysor-create-touch-events-on-a-non-rooted-device\" rel=\"nofollow noopener\" target=\"_blank\"\u003eHow does vysor create touch events on a non rooted device?\u003cbr\u003e\n\u003c/a\u003eVysorはRootを取っていない端末でどうやってリアルタイムのタッチイベントを実行しているのか？という質問です。\u003cbr\u003e\nそして解答は\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eWhat he does is, he then starts his Main class as a separate process using this shell user. Now, the Java code inside that Main class has the same privileges as the shell user (because duh, it's linux).\u003c/p\u003e\n\n\u003cp\u003e彼が何をしているのかというと、Shellユーザーの権限を使用してMainクラスを別プロセスで起動しているんだよ。これでMainクラス内のJavaコードはShellユーザーと同じ権限を持っているわけさ（だってAndroidはLinuxだからね）\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eつまり、shellからapkパッケージに含まれるクラスを実行するとその起動されたプログラムもshell権限を使用できるのです。\u003cbr\u003e\n言われてみれば、不思議な事ではありませんが、思いつきませんでした。\u003cbr\u003e\n今回はこの手法でリアルタイムタッチを実装しようと思います。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"いざ実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%84%E3%81%96%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eいざ、実装\u003c/h1\u003e\n\n\u003cp\u003e前述のようにアプリからシステム領域に介入するにはshellの力が必要です。\u003cbr\u003e\nまず、apkパッケージに含まれるクラスをshell権限で起動するには以下のようにします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"shell\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003esh \u003cspan class=\"nt\"\u003e-c\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"CLASSPATH=[apkファイルへのパス] /system/bin/app_process /system/bin [パッケージ名].[mainメソッドを含むクラスの名前]\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eapkファイルへのパスは\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"shell\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003epm path \u003cspan class=\"o\"\u003e[\u003c/span\u003eパッケージ名]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eで取得できますが、ここで普通にAndroid Studioでデバッグをしていると複数のパスが表示されます。\u003cbr\u003e\nこれはInstant Runという、ビルド時間を短縮したりプログラムの変更をリアルタイムで反映させる機能を使っている際に起こる現象です。\u003cbr\u003e\napkを複数に分割することで、変更時に差分のみをビルド、インストールして時短を図っているものと思われます。\u003cbr\u003e\nしかし、分割されてしまっては上記のコマンドが正しく動かないので、Instant Runを無効にする必要があります。\u003cbr\u003e\n設定の場所は以下のとおりです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c0eccdd17097f4171c715b6e0e27967904f8dd1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f34623938653832312d373264322d393237372d393437662d6533373939323936356163642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F4b98e821-72d2-9277-947f-e37992965acd.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=4237ebe24e29701a574d5d4181124deb\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/89220/4b98e821-72d2-9277-947f-e37992965acd.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F4b98e821-72d2-9277-947f-e37992965acd.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8b294f481e00d7668601c7f4c70b837e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eさらに注意なのが、ユーザーが起動するアプリ本体とshell権限で起動するプログラムは、同じパッケージに属するものの、プロセスが違うため、staticの共有などは一切できません。\u003cbr\u003e\nその為、やり取りをしたい場合はsocketなどを通して行うことになります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"プログラムからイベントをシステムに介入させる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%8B%E3%82%89%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E4%BB%8B%E5%85%A5%E3%81%95%E3%81%9B%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eプログラムからイベントをシステムに介入させる\u003c/h2\u003e\n\n\u003cp\u003eまずは以下のコードを見てください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"java\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eInputService.java\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputService\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nc\"\u003eInputManager\u003c/span\u003e \u003cspan class=\"n\"\u003eim\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nc\"\u003eMethod\u003c/span\u003e \u003cspan class=\"n\"\u003einjectInputEventMethod\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n\n    \u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eInputService\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"kd\"\u003ethrows\u003c/span\u003e \u003cspan class=\"nc\"\u003eException\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//InputManagerのインスタンスを取得\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eim\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eInputManager\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputManager\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetDeclaredMethod\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"getInstance\"\u003c/span\u003e\u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003einvoke\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eObject\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e]);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//MotionEventを生成するstaticメソッドを呼べるようにする\u003c/span\u003e\n        \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetDeclaredMethod\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"s\"\u003e\"obtain\"\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePointerProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e[].\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[].\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e).\u003c/span\u003e\u003cspan class=\"na\"\u003esetAccessible\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//システムにイベントを介入させるメソッドを取得\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einjectInputEventMethod\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputManager\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetDeclaredMethod\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"injectInputEvent\"\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eClass\u003c/span\u003e\u003cspan class=\"o\"\u003e[]{\u003c/span\u003e\u003cspan class=\"nc\"\u003eInputEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclass\u003c/span\u003e\u003cspan class=\"o\"\u003e});\u003c/span\u003e\n\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//タッチイベントを生成\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003einjectMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003einputSource\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eaction\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"kd\"\u003ethrows\u003c/span\u003e \u003cspan class=\"nc\"\u003eInvocationTargetException\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eIllegalAccessException\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePointerProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003epointerProperties\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePointerProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epointerProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePointerProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epointerProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n\n        \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003epointerCoords\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ePointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003epressure\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003etouchMajor\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003etouchMinor\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevent\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nc\"\u003eMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eobtain\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eSystemClock\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003euptimeMillis\u003c/span\u003e\u003cspan class=\"o\"\u003e(),\u003c/span\u003e \u003cspan class=\"nc\"\u003eSystemClock\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003euptimeMillis\u003c/span\u003e\u003cspan class=\"o\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eaction\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epointerProperties\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epointerCoords\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einputSource\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einjectInputEventMethod\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einvoke\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eim\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eObject\u003c/span\u003e\u003cspan class=\"o\"\u003e[]{\u003c/span\u003e\u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//キーイベントを生成\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003einjectKeyEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eKeyEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"kd\"\u003ethrows\u003c/span\u003e \u003cspan class=\"nc\"\u003eInvocationTargetException\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eIllegalAccessException\u003c/span\u003e\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einjectInputEventMethod\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einvoke\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eim\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eObject\u003c/span\u003e\u003cspan class=\"o\"\u003e[]{\u003c/span\u003e\u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこのコードは\u003ca href=\"https://github.com/omerjerk/RemoteDroid/blob/master/app/src/main/java/in/omerjerk/remotedroid/app/EventInput.java\" rel=\"nofollow noopener\" target=\"_blank\"\u003eここ\u003c/a\u003eを参考に、新しいAPIを使用するように多少変更しています。\u003c/p\u003e\n\n\u003cp\u003e通常はアクセスできないシステムのメソッドやインスタンスに、shell権限を利用してリフレクションでアクセスするという力技を行っています。\u003cbr\u003e\n「injectInputEvent」というのがそうで、そのメソッドにイベントデータを渡すとイベントが実行されます。\u003cbr\u003e\nそのメソッドは実際どこにあるのか、AOSPのソースを見てみたところ、\u003ca href=\"http://tools.oesf.biz/android-8.1.0_r1.0/xref/frameworks/base/core/java/android/hardware/input/InputManager.java\" rel=\"nofollow noopener\" target=\"_blank\"\u003eここ\u003c/a\u003eの914行目にありました。\u003cbr\u003e\nHideアノテーションで普通はアクセス出来ないようになっています。\u003cbr\u003e\nリフレクション？という方は\u003ca href=\"http://fantastic-works.com/archives/192\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこの記事\u003c/a\u003eが参考になるかと思います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"input-host-serverの実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#input-host-server%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eInput Host Serverの実装\u003c/h2\u003e\n\n\u003cp\u003eパソコンから送られてくるイベントを上記のInputServiceクラスを使用して実行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"java\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eInputHost.java\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputHost\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputService\u003c/span\u003e \u003cspan class=\"n\"\u003einputService\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"nc\"\u003eServerSocket\u003c/span\u003e \u003cspan class=\"n\"\u003elistener\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//サーバーソケット\u003c/span\u003e\n\n    \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"nc\"\u003eSocket\u003c/span\u003e \u003cspan class=\"n\"\u003eclientSocket\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//クライアント側へのソケット\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputStream\u003c/span\u003e \u003cspan class=\"n\"\u003einputStream\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//クライアントからのメッセージ受信用\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"nc\"\u003eOutputStream\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputStream\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//クライアントへのデータ送信用ストリーム\u003c/span\u003e\n\n\n    \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eboolean\u003c/span\u003e \u003cspan class=\"n\"\u003erunnning\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n\n    \u003cspan class=\"kd\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eString\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"o\"\u003e[])\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003einputService\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputService\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003eex\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eex\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintStackTrace\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elistener\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eServerSocket\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elistener\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esetReuseAddress\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elistener\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ebind\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eInetSocketAddress\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e8081\u003c/span\u003e\u003cspan class=\"o\"\u003e));\u003c/span\u003e\n            \u003cspan class=\"nc\"\u003eSystem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Server listening on port 8081...\"\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eclientSocket\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elistener\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eaccept\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\u003cspan class=\"c1\"\u003e//接続まで待機\u003c/span\u003e\n\n            \u003cspan class=\"nc\"\u003eSystem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Connected\"\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003einputStream\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclientSocket\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetInputStream\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eoutputStream\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclientSocket\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003egetOutputStream\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003erunnning\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"nc\"\u003eBufferedReader\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eBufferedReader\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eInputStreamReader\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einputStream\u003c/span\u003e\u003cspan class=\"o\"\u003e));\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erunnning\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"nc\"\u003eString\u003c/span\u003e \u003cspan class=\"n\"\u003emsg\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003ereadLine\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"nc\"\u003eString\u003c/span\u003e\u003cspan class=\"o\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003esplit\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\" \"\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003elength\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003eequals\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"screen\"\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"c1\"\u003e//タッチデータの場合\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003einputService\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einjectMotionEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eInputDeviceCompat\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eSOURCE_TOUCHSCREEN\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eInteger\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003evalueOf\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e]),\u003c/span\u003e \u003cspan class=\"nc\"\u003eInteger\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003evalueOf\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"o\"\u003e]),\u003c/span\u003e \u003cspan class=\"nc\"\u003eInteger\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003evalueOf\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"o\"\u003e]));\u003c/span\u003e\n                    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003eequals\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"key\"\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"c1\"\u003e//キーの場合\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003einputService\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003einjectKeyEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nc\"\u003eKeyEvent\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eInteger\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003evalueOf\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e]),\u003c/span\u003e \u003cspan class=\"nc\"\u003eInteger\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003evalueOf\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"o\"\u003e])));\u003c/span\u003e\n                    \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e].\u003c/span\u003e\u003cspan class=\"na\"\u003eequals\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"exit\"\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"c1\"\u003e//終了コール\u003c/span\u003e\n                        \u003cspan class=\"nc\"\u003eDisconnect\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintStackTrace\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"nc\"\u003eDisconnect\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//切断処理\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kd\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDisconnect\u003c/span\u003e\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003erunnning\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003elistener\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclose\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclientSocket\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eclientSocket\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eclose\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nc\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003eex\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eex\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintStackTrace\u003c/span\u003e\u003cspan class=\"o\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"nc\"\u003eSystem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eout\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"na\"\u003eprintln\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Disconnected\"\u003c/span\u003e\u003cspan class=\"o\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e単純なサーバープログラムです。\u003cbr\u003e\nPCとのデータのやり取りをjsonを使ってモダンにすることも考えたのですが、\u003cbr\u003e\n大したことはしないので、空白を区切りとしたcsvのような形式で送ることにしました。\u003c/p\u003e\n\n\u003cp\u003eAndroid側の実装はこれだけです。\u003cbr\u003e\n\u003cstrong\u003e全体のコードは\u003ca href=\"https://github.com/SIY1121/ScreenCastSample\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこちら\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e次にPC側の実装を行います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"クライアントの作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eクライアントの作成\u003c/h2\u003e\n\n\u003cp\u003eC# \u0026amp; WPFで作成しようと思います。\u003cbr\u003e\nWinFormsを選ばなかった理由は、仕様的？に画像を60FPSで表示することが困難だったからです。\u003cbr\u003e\n実装してみたら体感30FPSくらいでした。\u003cbr\u003e\nDoubleBufferedを無効にすると60FPSになりましたがチラツキがすごく、実用的ではありませんでした。\u003c/p\u003e\n\n\u003cp\u003eWPFも微妙な感じがしますが、GPUを描画に使っている分WinFormsよりはマシです。\u003cbr\u003e\n本気でやるならOpenGL(C#ならOpenTK)などのグラフィックAPIを使うことになりますね...\u003cbr\u003e\nまさか、送信側より受信側がボトルネックになるとは思いませんでした^^;\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eクライアントの全体のコードは\u003ca href=\"https://github.com/SIY1121/ScreenCastClient\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこちら\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ui\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ui\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUI\u003c/h3\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/4e465e64bf6386f2e6fafaa3be749731ac7a2e23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f37623538356666312d663061372d363736632d303664312d3531316665333064313136662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F7b585ff1-f0a7-676c-06d1-511fe30d116f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=177218aba29d025596f21f0379a77acf\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/89220/7b585ff1-f0a7-676c-06d1-511fe30d116f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2F7b585ff1-f0a7-676c-06d1-511fe30d116f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5dd0df1e08d011d3c592b945b7722812 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"xml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;Window\u003c/span\u003e \u003cspan class=\"na\"\u003ex:Class=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ScreenCastClient.MainWindow\"\u003c/span\u003e\n        \u003cspan class=\"na\"\u003exmlns=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://schemas.microsoft.com/winfx/2006/xaml/presentation\"\u003c/span\u003e\n        \u003cspan class=\"na\"\u003exmlns:x=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://schemas.microsoft.com/winfx/2006/xaml\"\u003c/span\u003e\n        \u003cspan class=\"na\"\u003exmlns:d=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://schemas.microsoft.com/expression/blend/2008\"\u003c/span\u003e\n        \u003cspan class=\"na\"\u003exmlns:mc=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://schemas.openxmlformats.org/markup-compatibility/2006\"\u003c/span\u003e\n        \u003cspan class=\"na\"\u003exmlns:local=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"clr-namespace:ScreenCastClient\"\u003c/span\u003e\n        \u003cspan class=\"na\"\u003emc:Ignorable=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"d\"\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eTitle=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ScreenCastClient\"\u003c/span\u003e \u003cspan class=\"na\"\u003eHeight=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"819.649\"\u003c/span\u003e \u003cspan class=\"na\"\u003eWidth=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"420.611\"\u003c/span\u003e \u003cspan class=\"na\"\u003eLoaded=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Window_Loaded\"\u003c/span\u003e \u003cspan class=\"na\"\u003eClosing=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Window_Closing\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;Grid\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;Grid.RowDefinitions\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;RowDefinition/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;RowDefinition\u003c/span\u003e \u003cspan class=\"na\"\u003eHeight=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"60\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/Grid.RowDefinitions\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;Image\u003c/span\u003e \u003cspan class=\"na\"\u003ex:Name=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"image\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMouseDown=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"image_MouseDown\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMouseUp=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"image_MouseUp\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMouseMove=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"image_MouseMove\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\n        \u003cspan class=\"nt\"\u003e\u0026lt;Grid\u003c/span\u003e \u003cspan class=\"na\"\u003eGrid.Row=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"1\"\u003c/span\u003e \u003cspan class=\"na\"\u003eBackground=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"#FF008BFF\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Grid.ColumnDefinitions\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"nt\"\u003e\u0026lt;ColumnDefinition\u003c/span\u003e \u003cspan class=\"na\"\u003eWidth=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"204*\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"nt\"\u003e\u0026lt;ColumnDefinition\u003c/span\u003e \u003cspan class=\"na\"\u003eWidth=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"193*\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;/Grid.ColumnDefinitions\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Polygon\u003c/span\u003e \u003cspan class=\"na\"\u003ePoints=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"0,15 25,0 25,30\"\u003c/span\u003e \u003cspan class=\"na\"\u003eFill=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"White\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMargin=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"30,17,0,0\"\u003c/span\u003e \u003cspan class=\"na\"\u003eHorizontalAlignment=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Left\"\u003c/span\u003e \u003cspan class=\"na\"\u003eWidth=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"36\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMouseDown=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Polygon_MouseDown\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMouseUp=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Polygon_MouseUp\"\u003c/span\u003e \u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Ellipse\u003c/span\u003e \u003cspan class=\"na\"\u003eFill=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"White\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMargin=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"186,18,181,12\"\u003c/span\u003e \u003cspan class=\"na\"\u003eWidth=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"30\"\u003c/span\u003e \u003cspan class=\"na\"\u003eHorizontalAlignment=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Center\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMouseDown=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Ellipse_MouseDown\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMouseUp=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Ellipse_MouseUp\"\u003c/span\u003e \u003cspan class=\"na\"\u003eGrid.ColumnSpan=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"2\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"nt\"\u003e\u0026lt;Rectangle\u003c/span\u003e \u003cspan class=\"na\"\u003eFill=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"White\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMargin=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"0,17,30,10\"\u003c/span\u003e \u003cspan class=\"na\"\u003eHorizontalAlignment=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Right\"\u003c/span\u003e \u003cspan class=\"na\"\u003eWidth=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"30\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMouseDown=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Rectangle_MouseDown\"\u003c/span\u003e \u003cspan class=\"na\"\u003eMouseUp=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Rectangle_MouseUp\"\u003c/span\u003e \u003cspan class=\"na\"\u003eGrid.Column=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"1\"\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"nt\"\u003e\u0026lt;/Grid\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/Grid\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/Window\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"この先使うメソッド\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%81%AE%E5%85%88%E4%BD%BF%E3%81%86%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこの先使うメソッド\u003c/h3\u003e\n\n\u003cp\u003eこの先頻繁に使う機能をまとめておきます。\u003cbr\u003e\nあるデータから必要な数値のみを取り出す、といった場合正規表現がかなり便利です。\u003cbr\u003e\nさらにその検証に\u003ca href=\"https://regex101.com/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eOnline regex tester and debugger: PHP, PCRE, Python, Golang and JavaScript\u003c/a\u003e\u003cbr\u003e\nこういったサイトがとても便利です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"c1\"\u003e//コマンド実行して標準出力を返すだけ\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eExec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eProcess\u003c/span\u003e \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eProcess\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eStartInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eFileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e  \u003cspan class=\"s\"\u003e\"cmd\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eArguments\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"/c \"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eUseShellExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eCreateNoWindow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eRedirectStandardInput\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eRedirectStandardError\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eRedirectStandardOutput\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eEnableRaisingEvents\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eresults\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStandardOutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadToEnd\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitForExit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresults\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//正規表現でマッチしたデータを配列で返す\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetRegexResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eRegex\u003c/span\u003e \u003cspan class=\"n\"\u003eregex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eMatch\u003c/span\u003e \u003cspan class=\"n\"\u003ematch\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eregex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGroups\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGroups\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGroups\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ffmpegと連携して動画をデコード表示する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ffmpeg%E3%81%A8%E9%80%A3%E6%90%BA%E3%81%97%E3%81%A6%E5%8B%95%E7%94%BB%E3%82%92%E3%83%87%E3%82%B3%E3%83%BC%E3%83%89%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFFmpegと連携して動画をデコード、表示する\u003c/h3\u003e\n\n\u003cp\u003eどんなOSのアプリケーションにも標準で入力、出力する機能が備わっています。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/dc51726891df24226d56c337bedcd06e247cde78/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f38393232302f64396335363237362d313366652d363263662d623134612d6463356635373163303730362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fd9c56276-13fe-62cf-b14a-dc5f571c0706.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f602bf7ab471ee0b1d06c3e76af61b8c\" alt=\"fig8-2.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/89220/d9c56276-13fe-62cf-b14a-dc5f571c0706.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fd9c56276-13fe-62cf-b14a-dc5f571c0706.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=4ca85b5cf8ce37f667c0cb4f51241962 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e一般的な動画変換ソフトでは入出力をファイルで行いますが、FFmpegは標準入出力が使えるので出力先をstdoutにすることで、プログラムからデコードされたデータを読むことができます。また、FFmpegの場合、stderrからログが出力される仕様になっています。\u003cbr\u003e\n以下のプログラムはFFmpegを起動し、stdout、stderrとのコネクションを確立するものです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStartFFmpeg\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//ポートの設定\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eExec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"adb forward tcp:8080 tcp:8080\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003einputArgs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"-framerate 60  -analyzeduration 100 -i tcp://127.0.0.1:8080\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputArgs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"-f rawvideo -pix_fmt bgr24 -r 60 -flags +global_header - \"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eProcess\u003c/span\u003e \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eProcess\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eStartInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eFileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"ffmpeg.exe\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eArguments\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003einputArgs\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputArgs\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eUseShellExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eCreateNoWindow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eRedirectStandardInput\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eRedirectStandardError\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"c1\"\u003e//stderrを読めるようにする\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eRedirectStandardOutput\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"c1\"\u003e//stdoutを読めるようにする\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eEnableRaisingEvents\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eErrorDataReceived\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003eProcess_ErrorDataReceived\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//stderrからはログが流れてくるので別途処理する\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003erawStream\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStandardOutput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBaseStream\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//stdoutからはデータが流れてくるのでストリームを取得しておく\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBeginErrorReadLine\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003erunning\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//別スレッドで読み取り開始\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eReadRawData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e必要な引数を設定しFFmpegを起動します。\u003cbr\u003e\n出力からデータを取得する方法には２つの方法があり、１つ目がイベントに登録する方法、２つ目がストリームを取得し自分で読む方法です。\u003cbr\u003e\n前者は手軽に取得することができますが、文字データに変換されるのでバイナリデータのやり取りには使用できません。\u003cbr\u003e\n後者はストリームを扱うので少々面倒ですが細かい制御が可能です。\u003cbr\u003e\n今回、stderrからはログが流れてくるので前者を、stdoutからは画像のバイナリデータが流れてくるので後者の方法でデータを読み出します。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ffmpegから送られてくるログを処理する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ffmpeg%E3%81%8B%E3%82%89%E9%80%81%E3%82%89%E3%82%8C%E3%81%A6%E3%81%8F%E3%82%8B%E3%83%AD%E3%82%B0%E3%82%92%E5%87%A6%E7%90%86%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFFmpegから送られてくるログを処理する\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"c1\"\u003e//FFmpegからの標準エラー出力を読む\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eProcess_ErrorDataReceived\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eDataReceivedEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimageWidth\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eimageHeight\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e//送られてくるサイズがまだ確定していないとき\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//FFmpegの出力からサイズを抜き取る荒業\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetRegexResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"([0-9]*?)x([0-9]*?), [0-9]*? fps\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eimageWidth\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eParse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eimageHeight\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eParse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebytePerframe\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eimageWidth\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eimageHeight\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimageWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eimageHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e//横向き画面の場合\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"c1\"\u003e//タッチ座標の最大値と最小値を入れ替える\u003c/span\u003e\n                        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edisplayWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003edisplayWidth\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edisplayHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003edisplayHeight\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                    \u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"c1\"\u003e//UIスレッドでBitmapを作成しないと、UIに反映できない\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ewriteableBitmap\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eWriteableBitmap\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimageWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimageHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e96\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e96\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePixelFormats\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBgr24\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSource\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ewriteableBitmap\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e今後送られてくる生データを復元するには画像のサイズが必須です。\u003cbr\u003e\nFFmpegは変換を開始する時に、これから出力するストリームの情報をログに出力するのでそこから画像のサイズを抜き取る荒業を行います。\u003cbr\u003e\nまたbytePerFrameという変数は1フレームの画像の生成に必要なバイト数です。\u003cbr\u003e\n画像の縦x横x1ピクセルに使用するバイト数で算出できます。\u003cbr\u003e\n今回はFFmpegにrgb24で出力するよう設定している(rgbにそれぞれ8bitで24bit)ので1ピクセルに使用するバイト数は3です。\u003cbr\u003e\n画像の仕組みの知識に不安がある方は、\u003ca href=\"http://www.cg-ya.net/2dcg/aboutimage/basic-knowledge-degitalimage/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e意外と知らない？画像の基礎知識とファイルの構造。\u003c/a\u003eを読んでみてください。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ffmpegから送られてくるデータを画像に戻す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ffmpeg%E3%81%8B%E3%82%89%E9%80%81%E3%82%89%E3%82%8C%E3%81%A6%E3%81%8F%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%94%BB%E5%83%8F%E3%81%AB%E6%88%BB%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFFmpegから送られてくるデータを画像に戻す\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"c1\"\u003e//FFmpegからのrawStreamを読んでBitmapに書き込む\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eReadRawData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eMemoryStream\u003c/span\u003e \u003cspan class=\"n\"\u003ems\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMemoryStream\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e10240\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erunning\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eresSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erawStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eresSize\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003ebytePerframe\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e//今回読んだデータで1フレーム分のデータに達したか、上回った場合\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eneedSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebytePerframe\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//1フレームに必要な残りのデータのサイズ\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eremainSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eresSize\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ebytePerframe\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c1\"\u003e//余ったデータのサイズ\u003c/span\u003e\n\n                    \u003cspan class=\"n\"\u003ems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebytePerframe\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//1フレームに必要な残りのデータを読む\u003c/span\u003e\n\n                    \u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewriteableBitmap\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"c1\"\u003e//データを書き込む\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ewriteableBitmap\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWritePixels\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInt32Rect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimageWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimageHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eimageWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n                    \u003cspan class=\"n\"\u003ems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ems\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMemoryStream\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eneedSize\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eremainSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//余ったデータを書き込む\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eresSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//データを蓄積\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eストリームからデータを取得し、MemoryStreamに蓄積していきます。\u003cbr\u003e\n1フレーム分のデータが確保できた場合、MemoryStream内のデータを画像に復元します。\u003cbr\u003e\nWritableBitmapに配列から復元してくれるメソッドがあるのでそれを使用します。\u003cbr\u003e\nまた、WritableBitmapへのアクセスはUIスレッドで行う必要があります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"inputhostを起動し接続する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#inputhost%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%97%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eInputHostを起動し、接続する\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindows.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"c1\"\u003e//InputHostを起動し、接続する\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStartInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003einputInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eExec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"adb shell getevent -i\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//Android端末の入力に関わるデータを取得\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//中からタッチ座標の最大値を抜き取る\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetRegexResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einputInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"ABS[\\s\\S]*?35.*?max (.*?),[\\s\\S]*?max (.*?),\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edisplayWidth\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eParse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edisplayHeight\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eParse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//ポートの設定\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eExec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"adb forward tcp:8081 tcp:8081\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//アプリのパスを取得\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//余計な文字や改行コードは削除\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epathToPackage\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eExec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"adb shell pm path space.siy.screencastsample\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eReplace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"package:\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eReplace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\\r\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eProcess\u003c/span\u003e \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eProcess\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eStartInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eFileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"adb\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eArguments\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"shell\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eUseShellExecute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eCreateNoWindow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eRedirectStandardInput\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eRedirectStandardError\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eRedirectStandardOutput\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eEnableRaisingEvents\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOutputDataReceived\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//今後なにか処理をするかも\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBeginOutputReadLine\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//Shell権限でInputHostを起動\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprocess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStandardInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"sh -c \\\"CLASSPATH=\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003epathToPackage\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e /system/bin/app_process /system/bin space.siy.screencastsample.InputHost\\\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eThreading\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//起動するまで待機\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eTcpClient\u003c/span\u003e \u003cspan class=\"n\"\u003etcp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eTcpClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"127.0.0.1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e8081\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//InputHostに接続\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etcp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStream\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e始めに adb shell getevent -iを実行し、出力を読み取っていますが、\u003cbr\u003e\nこのコマンドはAndroidの入力デバイスに関するデータを表示するコマンドです。\u003cbr\u003e\nここでは、タッチパネルがとり得る座標の最大値を取得しています。\u003cbr\u003e\nそして、InputHostを起動しています。\u003cbr\u003e\n起動するまで１秒待機と荒いことをやっていますがご了承ください。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"inputhostにデータを送る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#inputhost%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E9%80%81%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eInputHostにデータを送る\u003c/h3\u003e\n\n\u003cp\u003e接続周りの準備は完了したので、あとはInputHostにデータを送信していくだけです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eimage_MouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButtonEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePoint\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetDisplayPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"screen 0 \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003emouseDown\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eimage_MouseMove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ePoint\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetDisplayPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"screen 2 \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eimage_MouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButtonEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePoint\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetDisplayPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"screen 1 \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003emouseDown\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//マウスの位置を端末のタッチ座標に変換\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003ePoint\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetDisplayPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePoint\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eActualWidth\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edisplayWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eY\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eActualHeight\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edisplayHeight\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePoint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eimageのマウスに関するイベントを使用し、データを送信しています。\u003cbr\u003e\n空白区切で２つ目の0,1,2という数値は0がDonw、1がUp、2がMoveの意味です。\u003cbr\u003e\nまた、キーイベントは以下のようにしています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainWindow.xaml.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003ePolygon_MouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButtonEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"key 0 4\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003ePolygon_MouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButtonEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"key 1 4\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEllipse_MouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButtonEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"key 0 3\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEllipse_MouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButtonEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"key 1 3\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRectangle_MouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButtonEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"key 0 187\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRectangle_MouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButtonEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"key 1 187\\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estreamToInputHost\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esendByte\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e空白区切で２つ目は上と同じ意味です。\u003cbr\u003e\n３つ目はキーの固有番号で、\u003ca href=\"https://developer.android.com/reference/android/view/KeyEvent.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eKeyEvent\u003c/a\u003eで確認ができます。\u003cbr\u003e\nまた、端末に実装されていないキーも送ることができます。\u003cbr\u003e\n例えば120にはPrintScreenキーが割り振られています。\u003cbr\u003e\nスクリーンショットは普段は電源キーと音量Downの同時押しで行っていますが\u003cbr\u003e\nこのキーを送信するだけでスクリーンショットが取れたりします。\u003cbr\u003e\nすぐに試したい方は\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"shell\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eadb shell input keyevent 120\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eで再現できます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実際に動かしてみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E9%9A%9B%E3%81%AB%E5%8B%95%E3%81%8B%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実際に動かしてみる\u003c/h1\u003e\n\n\u003cp\u003eポートフォアーティングやInputHostをshellから起動するなど、\u003cbr\u003e\n面倒なことは全てクライアントソフトに実装したので簡単です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"手順\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%89%8B%E9%A0%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e手順\u003c/h2\u003e\n\n\u003cp\u003e１．Android側でアプリを起動し、スタートを押す\u003cbr\u003e\n２．クライアントソフトを起動する\u003c/p\u003e\n\n\u003cp\u003eこれだけです。\u003cbr\u003e\nこれで画面が映し出され、マウスで画面を操作することができます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"感想\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%84%9F%E6%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e感想\u003c/h1\u003e\n\n\u003cp\u003eShellでapk内のクラスを実行するというのが普段のアプリ開発で無いことなので最初は戸惑いましたが、実装することができました。\u003cbr\u003e\n今回の機能でadbは必須になってしまったので通常のユーザーに配布するならadbを導入して貰う必要が出てしまいました。\u003cbr\u003e\n最も、今はadbのみのダウンロードができるようになっているので、導入の敷居も下がってると思いますが。（同梱はありなのかな？）\u003c/p\u003e\n\n\u003cp\u003eこれでだいぶVysorに近づいてきました。\u003cbr\u003e\nただ、まだ文字入力やファイル転送ができていないので、次はそこを実装したいと思います。\u003cbr\u003e\nでは、最後までご覧下さりありがとうございました。\u003c/p\u003e\n","createdAt":"2018-01-28T07:30:04Z","elapsedYearsFromLastModifiedAt":3,"encryptedId":"CYBIB3q5/hJww2fajsejLWMYOoCSTber--r14YJjRsEpTJ6VHL--hJwWfLPmTGRHSKj/dTMgrA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2018-01-28T07:30:04Z","likesCount":52,"linkUrl":"https://qiita.com/siy1121/items/9e96cb1eb14d9090a2b6","organization":null,"originalId":604199,"stockedCount":42,"title":"Androidの画面をPCにミラーリングするソフトを作る２　リアルタイムタッチ編","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%82%93%E3%81%AA%E3%82%82%E3%81%AE%E3%82%92%E3%81%A4%E3%81%8F%E3%82%8A%E3%81%BE%E3%81%99\"\u003eこんなものをつくります\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BB%95%E6%A7%98\"\u003e仕様\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%BD%E3%83%95%E3%83%88%E3%81%A7%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8\"\u003eクライアントソフトですること\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#android%E5%81%B4%E3%81%A7%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8\"\u003eAndroid側ですること\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#pc%E3%81%8B%E3%82%89android%E7%AB%AF%E6%9C%AB%E3%82%92%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B\"\u003ePCからAndroid端末を操作する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%AB%AF%E6%9C%AB%E3%81%AE%E3%82%B7%E3%82%A7%E3%83%AB%E3%81%AB%E5%85%A5%E3%81%A3%E3%81%A6%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%82%92%E5%8F%A9%E3%81%8F\"\u003e端末のシェルに入ってコマンドを叩く\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#getevent-sendevent%E3%82%92%E4%BD%BF%E3%81%86\"\u003egetEvent sendEventを使う\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%90%E3%82%A4%E3%82%B9%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E7%9B%B4%E6%8E%A5%E6%93%8D%E4%BD%9C%E3%81%99%E3%82%8B\"\u003eデバイスファイルを直接操作する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E5%B1%80%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B\"\u003e結局どうするのか\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%84%E3%81%96%E5%AE%9F%E8%A3%85\"\u003eいざ、実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%8B%E3%82%89%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AB%E4%BB%8B%E5%85%A5%E3%81%95%E3%81%9B%E3%82%8B\"\u003eプログラムからイベントをシステムに介入させる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#input-host-server%E3%81%AE%E5%AE%9F%E8%A3%85\"\u003eInput Host Serverの実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90\"\u003eクライアントの作成\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#ui\"\u003eUI\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%81%AE%E5%85%88%E4%BD%BF%E3%81%86%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89\"\u003eこの先使うメソッド\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ffmpeg%E3%81%A8%E9%80%A3%E6%90%BA%E3%81%97%E3%81%A6%E5%8B%95%E7%94%BB%E3%82%92%E3%83%87%E3%82%B3%E3%83%BC%E3%83%89%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\"\u003eFFmpegと連携して動画をデコード、表示する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ffmpeg%E3%81%8B%E3%82%89%E9%80%81%E3%82%89%E3%82%8C%E3%81%A6%E3%81%8F%E3%82%8B%E3%83%AD%E3%82%B0%E3%82%92%E5%87%A6%E7%90%86%E3%81%99%E3%82%8B\"\u003eFFmpegから送られてくるログを処理する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ffmpeg%E3%81%8B%E3%82%89%E9%80%81%E3%82%89%E3%82%8C%E3%81%A6%E3%81%8F%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%94%BB%E5%83%8F%E3%81%AB%E6%88%BB%E3%81%99\"\u003eFFmpegから送られてくるデータを画像に戻す\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#inputhost%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%97%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B\"\u003eInputHostを起動し、接続する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#inputhost%E3%81%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E9%80%81%E3%82%8B\"\u003eInputHostにデータを送る\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E9%9A%9B%E3%81%AB%E5%8B%95%E3%81%8B%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e実際に動かしてみる\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%89%8B%E9%A0%86\"\u003e手順\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%84%9F%E6%83%B3\"\u003e感想\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":11071,"uuid":"9e96cb1eb14d9090a2b6","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"APmltGAyPKom+xp8uof6CH5iPN8=--oXDVbVUZoXYDpia4--Hbh2cy/3unAjBiVYNjniIQ==","originalId":89220,"description":"情報系の学部に通う大学３年生 / \r\nプログラミングしたり、CG(動画)作ったり、作曲したり色々してます / \r\n動画や音声を扱うプログラムを書くのが好き / \r\nKotlinが好きですが、js/tsの偉大さも感じている今日このごろです","facebookUrl":null,"githubUrl":"https://github.com/SIY1121","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/89220/profile-images/1527769802","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fprofile-images%2F1527769802?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=15c244d30c3ce7e730e7271bd333d682","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F89220%2Fprofile-images%2F1527769802?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=48bde3e9e95f68591f493be066cb5e43","urlName":"siy1121","websiteUrl":"https://siy.space","twitterUrl":"https://twitter.com/SIY1121","twitterUrlName":"SIY1121","revealedOrganizations":{"edges":[]}},"tags":[{"name":"Java","urlName":"java"},{"name":"Android","urlName":"android"},{"name":"Linux","urlName":"linux"},{"name":"C#","urlName":"csharp"},{"name":"ffmpeg","urlName":"ffmpeg"}],"followingLikers":{"edges":[]},"comments":{"totalCount":1}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
