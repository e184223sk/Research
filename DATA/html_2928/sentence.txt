More than 1 year has passed since last update.サイボウズ社のGaroon（ガルーン）は、組織内の情報共有を目的としたグループウェアのひとつだ。主に中堅～大企業をターゲットにしている。
電子メールの機能はあるもののSMTPサーバを持たないため、外部プログラムからメールを送信するにはGaroonのWeb APIを叩く必要がある。今回、Web APIを利用して、社内メールを一括送信するプログラムをC#で作成したので開発手順を紹介する。開発にあたり、下記の記事を大いに参考にさせていただいた。
深く謝意を表すとともに、本記事とあわせて参照して欲しい。Web APIを語る上で外せない2大用語、SOAPとRESTの違いについて簡単にふれておこう。SOAPは、Webサービスの初期に定義された古くからあるプロトコル（規格）で、HTTPのPOSTメソッドでXMLデータをやり取りする。WSDLと呼ばれるインターフェース仕様（XMLで記述されている）からネイティブAPIのコードを自動生成して使うことが多い。ステートフルである。JavaやC#と相性が良く、WebサービスといえばSOAPといわれるくらい昔は主流だった。RESTは、プロトコルというより概念とか設計思想に近い。HTTPのGET/POST/PUT/DELETEメソッドで主にjsonデータをやり取りする。フォーマットが厳密に決まっているわけでは無い。ステートレスである。単純な実装なので容易に始められる。APIといえば、筆者もかつてはRPCとかCORBAを叩きまくっていた世代だが、今日、たんにAPIといえばRESTを指すことが多い。GaroonのREST APIは基本的にクラウド版でしか提供されないため、本記事ではSOAP APIで作成していく。WSDLの定義情報を元に、Webサービスにアクセスするためのプロキシクラスを自動生成する。
オブジェクトをXMLデータにシリアライズしたり、逆にデシリアライズするのは、このプロキシクラスがやってくれる。赤枠内を順にクリックする。


URLの欄にWSDLの場所を入力する。
WSDLの場所は、公式ドキュメントGaroon SOAP APIの共通仕様に記載されている。
ソリューションエクスプローラ上部にある [すべてのファイルを表示] ボタンをクリックし、自動生成されたReference.csを表示する。

Reference.csにGaroonのSOAPヘッダを追加する。手順は【VisualStudio2017でガルーンAPIを使ってメッセージを送ってみる】が詳しいので、ここでは割愛する。プロキシクラスの下記APIを呼ぶリクエストクラスを作成する。Garoon共通のSOAPヘッダをメンバ変数に定義し、コンストラクタで設定するようにした。認証情報もコンストラクタで受け取る。ユーザ情報を管理するクラスは次の通り。これだけなら構造体で良いかもしれない。宛先ログイン名（連絡帳から確認できる）から、システム内のユーザIDを取得し、メールを送信する。
添付ファイルが要らなければ、nullを添付ファイル名に渡せば良い。


