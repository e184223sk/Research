<!DOCTYPE html><html><head><meta charset="utf-8" /><title>C# パフォーマンス改善に使える新しめの機能たち 7.0〜 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/hadashiA/items/0c65a999422e7713ed3c" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="TZfiRRO9GL7sT9pILfd+yB/OxrNK8sl5nPH9Dg44ku/uaJTFm8GJ0gORcLlxIFgf1TQWBFD3JTq9zq0QfNVw2g==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@hadashiA" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="C# パフォーマンス改善に使える新しめの機能たち 7.0〜 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReU1nNDRPUjQ0T1Y0NEtwNDRPODQ0T2U0NE96NDRLNTVwUzU1WmFFNDRHcjVMMl80NEdJNDRLTDVwYXc0NEdYNDRLQjQ0R3U1cW1mNklPOTQ0R2Y0NEdoSURjdU1PT0FuQSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz02MjVhODJiOTc1YTQ5ODlhMzRhOGQ5NTNmMzlkMGZmNQ&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2hoWkdGemFHbEImdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz03YjI0YmJiYjVjMDQ5Y2JlMmEyNTgyNjRiMzkxNDlhZA&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=3d009ece4745daf69aaceb0649ef2ca3"><meta property="og:description" content="時代に合わせてバージョンアップを続け、モダンな言語もまだまだ彼の背中を追っている部分があると噂されたりしている言語、C#。

現状の利用シーンとして割と大きいめの Unity (ゲームエンジン) では、使えるC#のバージョンがぐいぐい..."><meta content="https://qiita.com/hadashiA/items/0c65a999422e7713ed3c" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-b67c502f-de41-4436-9564-b5e856bf0f58"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FhadashiA%2Fitems%2F0c65a999422e7713ed3c">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FhadashiA%2Fitems%2F0c65a999422e7713ed3c">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-b67c502f-de41-4436-9564-b5e856bf0f58">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-04-10T15:32:01.000+09:00","dateModified":"2019-04-17T12:02:20.000+09:00","headline":"C# パフォーマンス改善に使える新しめの機能たち 7.0〜","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1ReU1nNDRPUjQ0T1Y0NEtwNDRPODQ0T2U0NE96NDRLNTVwUzU1WmFFNDRHcjVMMl80NEdJNDRLTDVwYXc0NEdYNDRLQjQ0R3U1cW1mNklPOTQ0R2Y0NEdoSURjdU1PT0FuQSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz02MjVhODJiOTc1YTQ5ODlhMzRhOGQ5NTNmMzlkMGZmNQ\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2hoWkdGemFHbEImdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz03YjI0YmJiYjVjMDQ5Y2JlMmEyNTgyNjRiMzkxNDlhZA\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=3d009ece4745daf69aaceb0649ef2ca3","mainEntityOfPage":"https://qiita.com/hadashiA/items/0c65a999422e7713ed3c","author":{"@type":"Person","address":"","email":null,"identifier":"hadashiA","name":"hadashiA","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F5859%2Fprofile-images%2F1473682324?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=b16e8286e5c3272bad99dc3238e293cd","url":"https://qiita.com/hadashiA","description":"フリーランスプログラマだよ","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita&amp;utm_medium=header-banner">LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"hadashiA","type":"items","id":"0c65a999422e7713ed3c"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから","url":"https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"hadashiA","type":"items","id":"0c65a999422e7713ed3c"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから","url":"https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"hadashiA","type":"items","id":"0c65a999422e7713ed3c"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから","url":"https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/hadashiA/items/0c65a999422e7713ed3c","location":"/hadashiA/items/0c65a999422e7713ed3c","scheme":"https","host":"qiita.com","port":null,"pathname":"/hadashiA/items/0c65a999422e7713ed3c","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"8J+8su1NTnLjO0rUwJ0RKHqlpDGk1R+wGmbbZjjB99RTYMoyZTHfHgzl4CWcSjf/sF90hr7Q8/M7WYt4SiwV4Q==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-1a8fdbb2-f6aa-4834-b292-2122d6ac6194"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/hadashiA/items/0c65a999422e7713ed3c/likers" class="css-1iupg5d">369</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">330</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/0c65a999422e7713ed3c/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/hadashiA/items/0c65a999422e7713ed3c/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/hadashiA/items/0c65a999422e7713ed3c/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/hadashiA/items/0c65a999422e7713ed3c/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/hadashiA/items/0c65a999422e7713ed3c.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/hadashiA"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/5859/profile-images/1473682324" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/hadashiA" class="css-10ougpm">@<!-- -->hadashiA</a><div class="css-1ay9vb9"><span><meta content="2019-04-10T06:32:01Z"/><time dateTime="2019-04-17T03:02:20Z" class="css-m19uds">updated at 2019-04-17</time></span></div></div></div></div></div><h1 class="css-cgzq40">C# パフォーマンス改善に使える新しめの機能たち 7.0〜</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>時代に合わせてバージョンアップを続け、モダンな言語もまだまだ彼の背中を追っている部分があると噂されたりしている言語、C#。</p>

<p>現状の利用シーンとして割と大きいめの Unity (ゲームエンジン) では、使えるC#のバージョンがぐいぐいっと上がりはじめて以降、そこそこ新しい書き方も認知されてきているようです。</p>

<p>しかし、個人的に注目している C#の新機能は、ショートハンドや関数型言語由来の機能よりもむしろ、C#自体のパフォーマンスを改善するような文法や標準ライブラリたちです。</p>

<p>ーーパフォーマンスを改善する言語機能って一体なんのことでしょう。</p>

<p>「C# なんて、ランタイムが勝手にJITで最適化した機械語にして走らせてくれるわけで、Unityの場合はc++にトランスパイルされるわけで、べつにプログラマがミクロなチューニングとか意識しなくても、夜、寝る前とかに祈ったり寄付とかをしていれば、ランタイムをつくってくれている方々が勝手に速くしてくれるんじゃないだろうか……?」</p>

<p>そんなふうに考えている人も多いかもしれません。</p>

<p>しかし、C# は、書き方次第でランタイムの労働する量がどうなるか、明確にコントロールできる部分が広く、パフォーマンスチューニングの伸びしろが開かれた言語だと思います。</p>

<p>わかりやすいところだと、変数がスタックに置かれるただの値になるか、ヒープアロケーションを伴いVMに管理される参照になるか、書き手に委ねられている点が挙げられます。</p>

<p>C#では、値型はスタックに置かれ、参照型はヒープに置かれる、と、型のレベルで区別されます。これは、プリミティブ型以外は原則ヒープに置かれるJavaや、値の寿命いかんで自動的に値をボクシングするGoと比較すると、VMに仕事をさせない速いコードを書ける可能性があるデザインだと思います。</p>

<p>Unity の IL2CPP 環境では、参照型に対しては色々なコード生成を伴うのに、C#のスタック変数は本当にただのc++のスタック変数として扱われている様を目の当たりにしたことのある方も多いんじゃないでしょうか。</p>

<p>そして、バージョンが上がる度に、その辺をコントロールできる幅が徐々に広がってきています。</p>

<p>僕がパフォチューをいくつかやってきた経験上では、実行ステップを減らすよりも、とにかくヒープアロケーションを減らす方が、マネージドコードの実行時間自体も改善しやすかったです。(もちろん GCの実行時間も減るが、マネージドコードの実行速度自体が改善する)</p>

<p>つまり、チューニング次第で、まるでGCが載ってない別言語なのかっていうくらい実行速度が変わってくるポテンシャルがC#にはある、と言えるんじゃないでしょうか。</p>

<p>そこで、パフォーマンスを出したい、ここぞの場合に、新しめのバージョンではどんな機能が使えるか、ざっくり見渡してみたいと思います。</p>

<h2>
<span id="文法" class="fragment"></span><a href="#%E6%96%87%E6%B3%95"><i class="fa fa-link"></i></a>文法</h2>

<h3>
<span id="タプル記法-valuetuple" class="fragment"></span><a href="#%E3%82%BF%E3%83%97%E3%83%AB%E8%A8%98%E6%B3%95-valuetuple"><i class="fa fa-link"></i></a>タプル記法 (ValueTuple)</h3>

<ul>
<li>C# 7.0 〜

<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/tuples%5D" rel="nofollow noopener" target="_blank">Tuple types - C# Guide | Microsoft Docs</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-7#tuples" rel="nofollow noopener" target="_blank">What's New in C# 7.0 - C# Guide | Microsoft Docs</a></li>
</ul>
</li>
</ul>

<p>関数型言語でおなじみのタプルが C# 7.0 で導入されています。</p>

<p>一時的な型をつくりたい場合、匿名型を使いたいケースがありますが、これはヒープアロケーションが発生します。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="k">new</span> <span class="p">{</span> <span class="n">A</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">B</span> <span class="p">=</span> <span class="m">2</span> <span class="p">};</span> <span class="c1">// この値はヒープ確保されて置かれる</span>
</code></pre></div></div>

<p>新しいタプル記法を使えば、各プロパティに名前をつけたいという要件を満たしつつ、ヒープは使われません。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">x</span> <span class="p">=</span> <span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">B</span><span class="p">:</span> <span class="m">2</span><span class="p">);</span> <span class="c1">// ヒープつかわない</span>
</code></pre></div></div>

<p>このようにプロパティに名前をつけてあげれば、匿名型がもっていた可読性もそのままです。<br>
<code>new</code> 文もなくなりオシャレになりました。</p>

<p>ちなみに、変数束縛もできます。 (パターンマッチにも使えます)</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">);</span>
<span class="c1">// a == 1</span>
<span class="c1">// b == 2</span>
</code></pre></div></div>

<p>分解した結果から名前つきタプルをつくることもできます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="p">(</span><span class="kt">int</span> <span class="n">A</span><span class="p">,</span> <span class="kt">int</span> <span class="n">B</span><span class="p">)</span> <span class="n">x</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">);</span>
<span class="c1">// x.A == 1</span>
<span class="c1">// x.B == 2</span>
</code></pre></div></div>

<p>タプルのシンタックスは、アロケーションを発生させず多値や一時的な型を扱えるので、便利さとパフォーマンス面で匿名型より勝ります。<br>
くわしくは上記リンクを参照のこと。</p>

<p>注: 元々、.NET 4.0 から 多値を表現する <code>Tuple&lt;T&gt;</code> がありましたが、こちらは実は参照型です。パフォーマンス改善のため、.NET4.7 で ValueTuple が導入されています。C#7.0のタプル記法は、こっちの値型である <code>ValueTuple&lt;T&gt;</code> として扱われます。</p>

<h3>
<span id="local-function" class="fragment"></span><a href="#local-function"><i class="fa fa-link"></i></a>Local Function</h3>

<ul>
<li>C# 7.0 〜

<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-7#local-functions" rel="nofollow noopener" target="_blank">What's New in C# 7.0 - C# Guide | Microsoft Docs</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/local-functions" rel="nofollow noopener" target="_blank">Local functions - C# Programming Guide | Microsoft Docs</a></li>
</ul>
</li>
</ul>

<p>Local Function は、メソッド内部にスコープの小さい関数を定義できる機能です。 (Nested Functionともいう)</p>

<p>これを ラムダ式のかわりにつかうことで、アロケーションを抑制できる場面があります。</p>

<p>C# のラムダ式はとても便利ですが、生成する度にアロケーションを伴う性質をもっています。</p>

<p>ラムダ式の中から外側のスコープの変数 (<code>this</code> やthisのメソッドを含む)を参照している場合、そのラムダ式が死ぬまで、参照を掴み続けなければいけません。この使命を果たすために、コンパイラは暗黙裏にクラスを生成して、キャプチャした外側の値をヒープに置いて保存します。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">a</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
<span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="n">f</span> <span class="p">=</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">+</span> <span class="n">a</span><span class="p">;</span>  <span class="c1">// `x =&gt; x + a` という式が生成される</span>
<span class="nf">f</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>

<span class="c1">//    // コンパイラが生成するC#:</span>
<span class="c1">//    // ローカル変数 a をキャプチャするための暗黙の型がつくられる</span>
<span class="c1">//    [CompilerGenerated]</span>
<span class="c1">//    private sealed class &lt;&gt;c__DisplayClass0_0</span>
<span class="c1">//    {</span>
<span class="c1">//        public int a;</span>
<span class="c1">//</span>
<span class="c1">//        internal int &lt;M&gt;b__0(int x)</span>
<span class="c1">//        {</span>
<span class="c1">//            return x + a;</span>
<span class="c1">//        }</span>
<span class="c1">//    }</span>
<span class="c1">//</span>
<span class="c1">//    // aを閉じこめる</span>
<span class="c1">//    &lt;&gt;c__DisplayClass0_0 &lt;&gt;c__DisplayClass0_ = new &lt;&gt;c__DisplayClass0_0();</span>
<span class="c1">//    &lt;&gt;c__DisplayClass0_.a = 10;</span>
<span class="c1">//</span>
<span class="c1">//    // Funcが生成される</span>
<span class="c1">//    Func&lt;int, int&gt; func = new Func&lt;int, int&gt;(&lt;&gt;c__DisplayClass0_.&lt;M&gt;b__0);</span>
<span class="c1">//    func(100);</span>
</code></pre></div></div>

<p>この例の場合、外側の変数 <code>a</code> をラムダ式内で参照していますが、a はスコープを抜けると破棄される宿命です。しかし、ラムダ式が生きている間に破棄されてしまうと困りますよね。そこで、<code>&lt;&gt;c_DisplayClass0</code> とかいうクラスのオブジェクトをつくり、<code>a</code> を閉じ込める、という動作をしています。(キャプチャするものが増減するともちろん、暗黙のクラスもでかくなります)</p>

<p>ちなみに、ラムダ式の生成のたびに毎回必ず暗黙のヒープ確保が行われるわけではありません。<br>
以下のように、ラムダ式内で使っている変数が、いつ実行されても全く同じになる場合 = いつも同じ式になる 場合は、コンパイラがキャッシュしてくれる模様です。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="n">f</span> <span class="p">=</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">+</span> <span class="m">10</span><span class="p">;</span> <span class="c1">// 外側のスコープや `this` を一切参照していない</span>
<span class="nf">f</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>

<span class="c1">// さっきと同じものが生成されるけど、キャッシュしてくれてる!</span>
<span class="c1">// Func&lt;int, int&gt; func = &lt;&gt;c.&lt;&gt;9__0_0 ?? (&lt;&gt;c.&lt;&gt;9__0_0 = new Func&lt;int, int&gt;(&lt;&gt;c.&lt;&gt;9.&lt;M&gt;b__0_0));</span>
<span class="c1">// func(100);</span>
</code></pre></div></div>

<p>ラムダ式は、いわゆるクロージャといわれている性質をもっていて、以下のような強力な機能をサポートしてくれる存在です。</p>

<ul>
<li>ラムダ式をつくった時点の外側のスコープをキャプチャする</li>
<li>ラムダ式は、値として使うことができ、キャプチャした変数のスコープの外でもいつまでも使える</li>
</ul>

<p>こうした機能の実現のために、基本的にはヒープアロケーションが必要になってくるのです。<br>
一方、 C# 7.0 から導入された Local Function を使うことで、寿命が決まっている式は、ヒープを使わずに変数をキャプチャすることができます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">void</span> <span class="n">Hoge</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">a</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
    <span class="kt">int</span> <span class="nf">AddA</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">+</span> <span class="n">a</span><span class="p">;</span>  <span class="c1">// aをキャプチャしているLocal Function</span>

    <span class="nf">AddA</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 暗黙の型は値型になる</span>
<span class="c1">// [Serializable]</span>
<span class="c1">// [CompilerGenerated]</span>
<span class="c1">// private sealed class &lt;&gt;c</span>
<span class="c1">// {</span>
<span class="c1">//     public static readonly &lt;&gt;c &lt;&gt;9 = new &lt;&gt;c();</span>
<span class="c1">//</span>
<span class="c1">//     public static Func&lt;int, int&gt; &lt;&gt;9__0_0;</span>
<span class="c1">//</span>
<span class="c1">//     internal int &lt;M&gt;b__0_0(int x)</span>
<span class="c1">//     {</span>
<span class="c1">//         return x + 10;</span>
<span class="c1">//     }</span>
<span class="c1">// }</span>

<span class="c1">// 暗黙の値のスコープがメソッド内であることが確定しているので `ref` による参照が使われてる</span>
<span class="c1">// &lt;M&gt;g__AddA|0_0(&lt;&gt;c__DisplayClass0_.a, ref &lt;&gt;c__DisplayClass0_);</span>
</code></pre></div></div>

<p>アロケーションがなくなりました。</p>

<p>ただし、ローカル変数を <code>Action</code> や <code>Func</code> をうけとる関数に渡してしまうと、結局、永遠の寿命を保証するために暗黙型はヒープに乗っけられてしまいます。アロケーション抑制の目的で効果があるのは、あくまで、ローカルスコープをキャプチャしたい場合だけというのは覚えておきましょう。</p>

<h3>
<span id="readonly-struct" class="fragment"></span><a href="#readonly-struct"><i class="fa fa-link"></i></a>readonly struct</h3>

<ul>
<li>C# 7.2 〜

<ul>
<li><a href="https://blogs.msdn.microsoft.com/seteplia/2018/05/03/avoiding-struct-and-readonly-reference-performance-pitfalls-with-errorprone-net/" rel="nofollow noopener" target="_blank">Avoiding struct and readonly reference performance pitfalls with ErrorProne.NET – Dissecting the code</a></li>
</ul>
</li>
</ul>

<p>C# 7.2 から、<code>struct</code> 自体に <code>readonly</code> 修飾子をつけることができるようになりました。<br>
これを使うことで struct に対するメソッド呼び出しの余計なコストを減らすことができます。</p>

<p><code>readonly struct</code> は、struct が一生を通じて絶対に不変な値であることをコンパイラに教えることができる機能です。 (readonly でないとコンパイルエラー)</p>

<p>値が不変であることとパフォーマンス改善がどう関係しているんでしょうか ?</p>

<p>実は、<code>readonly struct</code> を使うことで、 暗黙のうちに行われる値型のコピーが抑制されるのです。</p>

<p>いわゆる「Diffensive Copy」というやつです。</p>

<p>C# では、昔から、メンバ変数 に <code>readonly</code> 修飾子をつけることで、そのメンバが不変であることを保証できました。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">Owner</span>
<span class="p">{</span>
    <span class="k">readonly</span> <span class="n">Foo</span> <span class="n">foo</span><span class="p">;</span> <span class="c1">// 不変</span>
<span class="p">}</span>
</code></pre></div></div>

<p>しかし、これは実は、 <code>Foo</code> が参照型なのか、値型なのかで意味が変わります。(c言語のconst をはじめ、よくあるやつ)</p>

<ul>
<li>
<code>Foo</code> が参照型の場合

<ul>
<li>→ 参照先が変わらないことを保証する。参照先のオブジェクトの値が変わっても気にしない。</li>
</ul>
</li>
<li>
<code>Foo</code> が値型の場合 : 

<ul>
<li>→ 値が変わらないこと。つまり <code>foo</code> のメンバも不変であることが保証される。</li>
</ul>
</li>
</ul>

<p>そう、 値型のメンバに readonly がついている場合、コンパイラは、<code>foo</code> のメンバが絶対に変更されないことを保証してくれるのです。</p>

<p>そんなことできるんでしょうか?<br>
パフォーマンスを犠牲にするとできます。その答えが、「Deffensive Copy」です。</p>

<p>値型のメンバ変数が絶対に天地がひっくり返っても不変であることを保証するために、コンパイラはコピーを作成してからメソッド呼びだしをする、という保守的な方法を採ります。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="cm">/* readonly */</span> <span class="k">struct</span> <span class="nc">Foo</span> <span class="c1">// readonlyかどうかで挙動が変わる</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">A</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Hello</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Owner</span>
<span class="p">{</span>
    <span class="k">readonly</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Foo</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>  

    <span class="k">public</span> <span class="nf">Hello</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">foo</span><span class="p">.</span><span class="nf">Hello</span><span class="p">();</span> <span class="c1">// ここでコピー発生。 </span>
        <span class="c1">// 元のfooではなく、fooのコピーをつくってから Hello() を呼びだす。</span>
        <span class="c1">// メソッド呼び出しで値が変わるか知る方法がないため。</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">var</span> <span class="n">owner</span> <span class="p">=</span> <span class="nf">Owner</span><span class="p">();</span>
<span class="n">owner</span><span class="p">.</span><span class="nf">Hello</span><span class="p">();</span> 
</code></pre></div></div>

<p><code>readonly struct</code> に変更してみましょう。</p>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre class="with-code"><code><span class="gd">-struct Foo
</span><span class="gi">+readonly struct Foo
</span></code></pre></div></div>

<p>コンパイルされた IL を覗くと、ローカル変数へのfooの展開が減っていることが確認できました。</p>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre class="with-code"><code><span class="p">@@ -2,9 +2,8 @@</span>
 IL_0001: newobj instance void Owner::.ctor()
 IL_0006: stloc.0
 IL_0007: ldloc.0
<span class="gd">-IL_0008: ldfld valuetype Foo Owner::Foo
-IL_000d: stloc.1
-IL_000e: ldloca.s 1
-IL_0010: call instance void Foo::Hello()
-IL_0015: nop
-IL_0016: ret
</span><span class="err">\</span> No newline at end of file
<span class="gi">+IL_0008: ldflda valuetype Foo Owner::Foo
+IL_000d: call instance void Foo::Hello()
+IL_0012: nop
+IL_0013: ret
+
</span><span class="err">\</span> No newline at end of file

</code></pre></div></div>

<p>参考リンクに書かれていますが、 <code>Enumerator&lt;T&gt;</code> は大抵は値型として実装されているので、<code>MoveNext</code> を呼ぶたびにコピーが走るらしいです。<br>
(この辺は今後のバージョンアップで標準ライブラリは改善されていくんでしょうか)</p>

<p>また、Diffensive Copy は、メンバ変数に対するメソッド呼び出しだけでなく、 参照渡しした実引数のsturctに対してのメソッド呼び出しでも発生してしまいます。</p>

<p>このコピーは、けっこうわかりずらいです。struct のサイズが大きければ大きいほど、安くないコストがかかるので、セマンティクス的にもパフォーマンス的にも、不変な型には <code>readonly</code> をつけるスタイルを心掛けましょう。</p>

<h3>
<span id="引数の-in-修飾子" class="fragment"></span><a href="#%E5%BC%95%E6%95%B0%E3%81%AE-in-%E4%BF%AE%E9%A3%BE%E5%AD%90"><i class="fa fa-link"></i></a>引数の <code>in</code> 修飾子</h3>

<ul>
<li>C# 7.2 〜

<ul>
<li><a href="https://blogs.msdn.microsoft.com/seteplia/2018/03/07/the-in-modifier-and-the-readonly-structs-in-c/" rel="nofollow noopener" target="_blank">The ‘in’-modifier and the readonly structs in C# – Dissecting the code</a></li>
</ul>
</li>
</ul>

<p>もともと、C# には、2種類の参照渡しができました。 読み込みも書き込みもできる<code>ref</code>と、必ず書き込ませることを保証する <code>out</code> です。7.2 では、 新たに 3つめの <code>in</code> 参照渡しが追加されています。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="kt">int</span> <span class="nf">Hoge</span><span class="p">(</span><span class="k">in</span> <span class="n">Foo</span> <span class="n">foo</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">foo</span><span class="p">.</span><span class="nf">Hogehoge</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Foo</span><span class="p">();</span>
<span class="nf">Hoge</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
</code></pre></div></div>

<p><code>in</code> は、その名のとおり、参照とその指している変数への書き替えを禁止しつつ参照渡しができる機能です。</p>

<p>参考リンクによると、書き替えが禁止されているおかげで、 <code>using</code>文の中など、 <code>in</code> ,<code>out</code> 渡しが禁止されている場面でも <code>in</code> をつけると struct の参照渡しができるようになったとのこと。</p>

<p>でかいstruct を引数に渡したい場面で、コピーが発生せず高速にc++とかrustとかのノリで参照渡しできて便利です。</p>

<p><strong>ただし、<code>readonly</code> のついていないstructを参照渡ししても、結局は前述のとおり 暗黙裏にDiffensive Copyが発生してしまうため、readonly struct を合わせて使うことが推奨されます</strong></p>

<h2>
<span id="標準ライブラリ編" class="fragment"></span><a href="#%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E7%B7%A8"><i class="fa fa-link"></i></a>標準ライブラリ編</h2>

<h3>
<span id="systemmemory--spant--memoryt" class="fragment"></span><a href="#systemmemory--spant--memoryt"><i class="fa fa-link"></i></a><code>System.Memory</code>  (<code>Span&lt;T&gt;</code> / <code>Memory&lt;T&gt;</code>)</h3>

<ul>
<li>.NET Standard 2.1 〜

<ul>
<li><a href="https://msdn.microsoft.com/en-us/magazine/mt814808.aspx" rel="nofollow noopener" target="_blank">C# - All About Span: Exploring a New .NET Mainstay</a></li>
<li><a href="https://msdn.microsoft.com/ja-jp/magazine/mt814808.aspx" rel="nofollow noopener" target="_blank">C# - Span のすべて: .NET の新しい頼みの綱を探索する</a></li>
</ul>
</li>
</ul>

<p>C# は、c, rust, swift , go あたりなどと違い、プリミティブな固定長配列も必ずヒープに置かれます。</p>

<p>これは、ある意味で言語としてのパフォーマンス上の制約のひとつになっていたと思います。</p>

<p>スタック変数で充分な一時的な配列でもヒープ割り合てをしないといけないし、 文字列のいち部分だけの参照を使いたい場合や、配列を受けとるAPIに対して配列の一部だけを渡したいケースで、ヒープの部分的なコピーをこれまたヒープにつくらないといけない、という状況がすぐ生まれてしまうのです。(<code>unsafe</code>を使えば一応がんばれるが…) ヒープにコピーをつくるのは遅いです。こういうのは、どんどん伝搬していくので、全体として GCゴミの抑制がむずかしくなっていってしまいがちです。</p>

<p><code>System.Memory</code> パッケージは、機能的な拡張というよりは、このパフォーマンス上の制約を乗りこえるためのソリューションです。</p>

<p>このパッケージによって、<code>Span&lt;T&gt;</code> という、他の言語でいうところの「スライス」に近いものが導入されました。</p>

<p>これは、メモリ上にある配列や文字列などのオブジェクトの一部分だけの参照を表現し、コレクションとして扱うことができる型です。</p>

<p><code>Span&lt;T&gt;</code> という型が追加された、と聞いてもどう使うかわかりずらいかもしれませんが、参考リンクにも紹介されいるとおり、標準ライブラリの至るところでオーバーロードが用意され、 <code>int.Parse()</code> や <code>string.SubString()</code> などが Spanを渡したり返したりできるようになっています。</p>

<p>尚、<code>Span&lt;T&gt;</code> は、スタックに存在するポインタへの参照をもつことを保証するため、ボクシングができない <code>ref struct</code> という特殊な型として実装されています。</p>

<p>さきほど、「配列の確保にはヒープが必要」と書きましたが、 戻り値が <code>Span&lt;T&gt;</code> な <code>stackalloc</code> 文をつかうことで、ヒープ割り合てを回避し、スタック上に一時的な固定長配列をつくれるようになりました。</p>

<p>また、<code>Span&lt;T&gt;</code> は、 <code>ref struct</code> であるため、そのローカルスコープの外へ渡すことができない、という制約があります。どうしても外へ渡したい場合のために、 <code>Memory&lt;T&gt;</code> というただのstruct も用意されています。こっちは、参照をボクシングして閉じこめたものなので、<code>Span&lt;T&gt;</code> が使えるケースでは <code>Span&lt;T&gt;</code> を使おう。</p>

<p>.NET Core では、リリースの度に標準ライブラリのパフォーマンスが改善されてますが、この新しい <code>Span&lt;T&gt;</code> / <code>Memory&lt;T&gt;</code> を使った実装にどんどん書き換わっていることも大きく貢献しているみたいです。</p>

<p>スライスが使えるようになったということは、配列を値として扱えるような言語と同等の パフォーマンスを叩き出す扉が開かれたと言って良いんじゃないでしょうか。後方互換性を全く損なわいところがすごいな、と思います。</p>

<h3>
<span id="systemiopipelines" class="fragment"></span><a href="#systemiopipelines"><i class="fa fa-link"></i></a><code>System.IO.Pipelines</code>
</h3>

<ul>
<li>.NET Standard 2.1 〜

<ul>
<li><a href="https://devblogs.microsoft.com/dotnet/system-io-pipelines-high-performance-io-in-net/" rel="nofollow noopener" target="_blank">System.IO.Pipelines: High performance IO in .NET | .NET Blog</a></li>
<li>Marc Gravell さんの解説

<ul>
<li><a href="https://blog.marcgravell.com/2018/07/pipe-dreams-part-1.html" rel="nofollow noopener" target="_blank">Code, code and more code.: Pipe Dreams, part 1</a></li>
<li><a href="https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html" rel="nofollow noopener" target="_blank">Code, code and more code.: Pipe Dreams, part 2</a></li>
<li><a href="https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html" rel="nofollow noopener" target="_blank">Code, code and more code.: Pipe Dreams, part 3</a></li>
<li><a href="https://blog.marcgravell.com/2018/07/pipe-dreams-part-31.html" rel="nofollow noopener" target="_blank">Code, code and more code.: Pipe Dreams, part 3.1</a></li>
</ul>
</li>
<li><a href="https://qiita.com/skitoy4321/items/0fc4dc72bc50dabba92b" id="reference-db85b1adf09f187ba4b3">ReadOnlySequenceについて - Qiita</a></li>
</ul>
</li>
</ul>

<p>C# でSocket APIとかを使ってサーバを書こうとした場合、前述のような事情で、バイト配列のコピーを抑制しようと四苦八苦し、なかなか煩雑なコードになりがちです。</p>

<p>あたらしい 標準ライブラリの <code>System.IO.Pipelines</code> パッケージを使うことで、「データをバッファリングしておいて、逐次読み込んで処理する」といったよくある処理が簡単に書けるようになりました。</p>

<p>これは、内部的に <code>Span&lt;T&gt;/Memorty&lt;T&gt;</code> なども使われる実装になっていたりと、バッファのアロケーションを抑制するような仕組みになっているため、これまでの自前のバイト配列管理よりパフォーマンス面でも有利です。</p>

<p>僕はまだ使ったことがなく、理解できていない部分が多いので、くわしい説明は参考リンクのほうへ譲ります。</p>

<p>C# の有名なRedisクライアント、コネクションを多重化して使う実装で有名な <a href="https://github.com/StackExchange" rel="nofollow noopener" target="_blank">StackExchange.Redis</a> は、バージョン2以降でこのpipelines API で書き直されたそうです。<br>
(僕は、StackExchange.Redis 作者の人の情報発信をきっかけに知りました)</p>

<h3>
<span id="そんなかんじです" class="fragment"></span><a href="#%E3%81%9D%E3%82%93%E3%81%AA%E3%81%8B%E3%82%93%E3%81%98%E3%81%A7%E3%81%99"><i class="fa fa-link"></i></a>そんなかんじです</h3>

<p>なぜ速くなるのかわかりずらいけど速くなるC#の新機能について紹介してみました。<br>
その他、 <code>ArrayPool&lt;T&gt;</code> など、わかりやすいやつも色々あると思うので、色々使ってみよう。</p>

<p>C# が他の ぶ厚いVMの言語よりもパフォーマンス上のポテンシャルがあることがもっと広まって、今後もどんどん速いライブラリが増えると良いなーと思いまっす。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FhadashiA%2Fitems%2F0c65a999422e7713ed3c&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FhadashiA%2Fitems%2F0c65a999422e7713ed3c&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/hadashiA/items/0c65a999422e7713ed3c/likers" class="css-1iupg5d">369</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">330</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/0c65a999422e7713ed3c/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/hadashiA/items/0c65a999422e7713ed3c/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/hadashiA/items/0c65a999422e7713ed3c/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/hadashiA/items/0c65a999422e7713ed3c/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/hadashiA/items/0c65a999422e7713ed3c.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-1a8fdbb2-f6aa-4834-b292-2122d6ac6194">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-ddf64ee7-39b9-492f-8aac-5bef52e8b083"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-ddf64ee7-39b9-492f-8aac-5bef52e8b083">{}</script>
      
<div id="LoginModal-react-component-0423b565-564b-4fb3-8eca-bddd029c88d6"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-0423b565-564b-4fb3-8eca-bddd029c88d6">{}</script>
      
<div id="StockModal-react-component-49b4f920-51b3-4d49-b2d5-ecdcf4c983fc"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-49b4f920-51b3-4d49-b2d5-ecdcf4c983fc">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;Sa7NlNlO4V3OzRGbmF0c1ePlx7wq+RfLIMlcSOb8qUjqUbsUUTJwMSETu2rEijoCKR8XCzD8+4gB9gxWlBFLfQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e時代に合わせてバージョンアップを続け、モダンな言語もまだまだ彼の背中を追っている部分があると噂されたりしている言語、C#。\u003c/p\u003e\n\n\u003cp\u003e現状の利用シーンとして割と大きいめの Unity (ゲームエンジン) では、使えるC#のバージョンがぐいぐいっと上がりはじめて以降、そこそこ新しい書き方も認知されてきているようです。\u003c/p\u003e\n\n\u003cp\u003eしかし、個人的に注目している C#の新機能は、ショートハンドや関数型言語由来の機能よりもむしろ、C#自体のパフォーマンスを改善するような文法や標準ライブラリたちです。\u003c/p\u003e\n\n\u003cp\u003eーーパフォーマンスを改善する言語機能って一体なんのことでしょう。\u003c/p\u003e\n\n\u003cp\u003e「C# なんて、ランタイムが勝手にJITで最適化した機械語にして走らせてくれるわけで、Unityの場合はc++にトランスパイルされるわけで、べつにプログラマがミクロなチューニングとか意識しなくても、夜、寝る前とかに祈ったり寄付とかをしていれば、ランタイムをつくってくれている方々が勝手に速くしてくれるんじゃないだろうか……?」\u003c/p\u003e\n\n\u003cp\u003eそんなふうに考えている人も多いかもしれません。\u003c/p\u003e\n\n\u003cp\u003eしかし、C# は、書き方次第でランタイムの労働する量がどうなるか、明確にコントロールできる部分が広く、パフォーマンスチューニングの伸びしろが開かれた言語だと思います。\u003c/p\u003e\n\n\u003cp\u003eわかりやすいところだと、変数がスタックに置かれるただの値になるか、ヒープアロケーションを伴いVMに管理される参照になるか、書き手に委ねられている点が挙げられます。\u003c/p\u003e\n\n\u003cp\u003eC#では、値型はスタックに置かれ、参照型はヒープに置かれる、と、型のレベルで区別されます。これは、プリミティブ型以外は原則ヒープに置かれるJavaや、値の寿命いかんで自動的に値をボクシングするGoと比較すると、VMに仕事をさせない速いコードを書ける可能性があるデザインだと思います。\u003c/p\u003e\n\n\u003cp\u003eUnity の IL2CPP 環境では、参照型に対しては色々なコード生成を伴うのに、C#のスタック変数は本当にただのc++のスタック変数として扱われている様を目の当たりにしたことのある方も多いんじゃないでしょうか。\u003c/p\u003e\n\n\u003cp\u003eそして、バージョンが上がる度に、その辺をコントロールできる幅が徐々に広がってきています。\u003c/p\u003e\n\n\u003cp\u003e僕がパフォチューをいくつかやってきた経験上では、実行ステップを減らすよりも、とにかくヒープアロケーションを減らす方が、マネージドコードの実行時間自体も改善しやすかったです。(もちろん GCの実行時間も減るが、マネージドコードの実行速度自体が改善する)\u003c/p\u003e\n\n\u003cp\u003eつまり、チューニング次第で、まるでGCが載ってない別言語なのかっていうくらい実行速度が変わってくるポテンシャルがC#にはある、と言えるんじゃないでしょうか。\u003c/p\u003e\n\n\u003cp\u003eそこで、パフォーマンスを出したい、ここぞの場合に、新しめのバージョンではどんな機能が使えるか、ざっくり見渡してみたいと思います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"文法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%96%87%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e文法\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"タプル記法-valuetuple\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%BF%E3%83%97%E3%83%AB%E8%A8%98%E6%B3%95-valuetuple\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eタプル記法 (ValueTuple)\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eC# 7.0 〜\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/en-us/dotnet/csharp/tuples%5D\" rel=\"nofollow noopener\" target=\"_blank\"\u003eTuple types - C# Guide | Microsoft Docs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-7#tuples\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWhat's New in C# 7.0 - C# Guide | Microsoft Docs\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e関数型言語でおなじみのタプルが C# 7.0 で導入されています。\u003c/p\u003e\n\n\u003cp\u003e一時的な型をつくりたい場合、匿名型を使いたいケースがありますが、これはヒープアロケーションが発生します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eB\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e \u003cspan class=\"c1\"\u003e// この値はヒープ確保されて置かれる\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e新しいタプル記法を使えば、各プロパティに名前をつけたいという要件を満たしつつ、ヒープは使われません。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ヒープつかわない\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのようにプロパティに名前をつけてあげれば、匿名型がもっていた可読性もそのままです。\u003cbr\u003e\n\u003ccode\u003enew\u003c/code\u003e 文もなくなりオシャレになりました。\u003c/p\u003e\n\n\u003cp\u003eちなみに、変数束縛もできます。 (パターンマッチにも使えます)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// a == 1\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// b == 2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e分解した結果から名前つきタプルをつくることもできます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// x.A == 1\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// x.B == 2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eタプルのシンタックスは、アロケーションを発生させず多値や一時的な型を扱えるので、便利さとパフォーマンス面で匿名型より勝ります。\u003cbr\u003e\nくわしくは上記リンクを参照のこと。\u003c/p\u003e\n\n\u003cp\u003e注: 元々、.NET 4.0 から 多値を表現する \u003ccode\u003eTuple\u0026lt;T\u0026gt;\u003c/code\u003e がありましたが、こちらは実は参照型です。パフォーマンス改善のため、.NET4.7 で ValueTuple が導入されています。C#7.0のタプル記法は、こっちの値型である \u003ccode\u003eValueTuple\u0026lt;T\u0026gt;\u003c/code\u003e として扱われます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"local-function\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#local-function\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eLocal Function\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eC# 7.0 〜\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-7#local-functions\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWhat's New in C# 7.0 - C# Guide | Microsoft Docs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/local-functions\" rel=\"nofollow noopener\" target=\"_blank\"\u003eLocal functions - C# Programming Guide | Microsoft Docs\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eLocal Function は、メソッド内部にスコープの小さい関数を定義できる機能です。 (Nested Functionともいう)\u003c/p\u003e\n\n\u003cp\u003eこれを ラムダ式のかわりにつかうことで、アロケーションを抑制できる場面があります。\u003c/p\u003e\n\n\u003cp\u003eC# のラムダ式はとても便利ですが、生成する度にアロケーションを伴う性質をもっています。\u003c/p\u003e\n\n\u003cp\u003eラムダ式の中から外側のスコープの変数 (\u003ccode\u003ethis\u003c/code\u003e やthisのメソッドを含む)を参照している場合、そのラムダ式が死ぬまで、参照を掴み続けなければいけません。この使命を果たすために、コンパイラは暗黙裏にクラスを生成して、キャプチャした外側の値をヒープに置いて保存します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// `x =\u0026gt; x + a` という式が生成される\u003c/span\u003e\n\u003cspan class=\"nf\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//    // コンパイラが生成するC#:\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    // ローカル変数 a をキャプチャするための暗黙の型がつくられる\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    [CompilerGenerated]\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    private sealed class \u0026lt;\u0026gt;c__DisplayClass0_0\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    {\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//        public int a;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//        internal int \u0026lt;M\u0026gt;b__0(int x)\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//        {\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//            return x + a;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//        }\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    }\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    // aを閉じこめる\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    \u0026lt;\u0026gt;c__DisplayClass0_0 \u0026lt;\u0026gt;c__DisplayClass0_ = new \u0026lt;\u0026gt;c__DisplayClass0_0();\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    \u0026lt;\u0026gt;c__DisplayClass0_.a = 10;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    // Funcが生成される\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    Func\u0026lt;int, int\u0026gt; func = new Func\u0026lt;int, int\u0026gt;(\u0026lt;\u0026gt;c__DisplayClass0_.\u0026lt;M\u0026gt;b__0);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//    func(100);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこの例の場合、外側の変数 \u003ccode\u003ea\u003c/code\u003e をラムダ式内で参照していますが、a はスコープを抜けると破棄される宿命です。しかし、ラムダ式が生きている間に破棄されてしまうと困りますよね。そこで、\u003ccode\u003e\u0026lt;\u0026gt;c_DisplayClass0\u003c/code\u003e とかいうクラスのオブジェクトをつくり、\u003ccode\u003ea\u003c/code\u003e を閉じ込める、という動作をしています。(キャプチャするものが増減するともちろん、暗黙のクラスもでかくなります)\u003c/p\u003e\n\n\u003cp\u003eちなみに、ラムダ式の生成のたびに毎回必ず暗黙のヒープ確保が行われるわけではありません。\u003cbr\u003e\n以下のように、ラムダ式内で使っている変数が、いつ実行されても全く同じになる場合 = いつも同じ式になる 場合は、コンパイラがキャッシュしてくれる模様です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 外側のスコープや `this` を一切参照していない\u003c/span\u003e\n\u003cspan class=\"nf\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// さっきと同じものが生成されるけど、キャッシュしてくれてる!\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// Func\u0026lt;int, int\u0026gt; func = \u0026lt;\u0026gt;c.\u0026lt;\u0026gt;9__0_0 ?? (\u0026lt;\u0026gt;c.\u0026lt;\u0026gt;9__0_0 = new Func\u0026lt;int, int\u0026gt;(\u0026lt;\u0026gt;c.\u0026lt;\u0026gt;9.\u0026lt;M\u0026gt;b__0_0));\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// func(100);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eラムダ式は、いわゆるクロージャといわれている性質をもっていて、以下のような強力な機能をサポートしてくれる存在です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eラムダ式をつくった時点の外側のスコープをキャプチャする\u003c/li\u003e\n\u003cli\u003eラムダ式は、値として使うことができ、キャプチャした変数のスコープの外でもいつまでも使える\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこうした機能の実現のために、基本的にはヒープアロケーションが必要になってくるのです。\u003cbr\u003e\n一方、 C# 7.0 から導入された Local Function を使うことで、寿命が決まっている式は、ヒープを使わずに変数をキャプチャすることができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eHoge\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddA\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// aをキャプチャしているLocal Function\u003c/span\u003e\n\n    \u003cspan class=\"nf\"\u003eAddA\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 暗黙の型は値型になる\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// [Serializable]\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// [CompilerGenerated]\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// private sealed class \u0026lt;\u0026gt;c\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// {\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//     public static readonly \u0026lt;\u0026gt;c \u0026lt;\u0026gt;9 = new \u0026lt;\u0026gt;c();\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//     public static Func\u0026lt;int, int\u0026gt; \u0026lt;\u0026gt;9__0_0;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//     internal int \u0026lt;M\u0026gt;b__0_0(int x)\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//     {\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//         return x + 10;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//     }\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// }\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 暗黙の値のスコープがメソッド内であることが確定しているので `ref` による参照が使われてる\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// \u0026lt;M\u0026gt;g__AddA|0_0(\u0026lt;\u0026gt;c__DisplayClass0_.a, ref \u0026lt;\u0026gt;c__DisplayClass0_);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eアロケーションがなくなりました。\u003c/p\u003e\n\n\u003cp\u003eただし、ローカル変数を \u003ccode\u003eAction\u003c/code\u003e や \u003ccode\u003eFunc\u003c/code\u003e をうけとる関数に渡してしまうと、結局、永遠の寿命を保証するために暗黙型はヒープに乗っけられてしまいます。アロケーション抑制の目的で効果があるのは、あくまで、ローカルスコープをキャプチャしたい場合だけというのは覚えておきましょう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"readonly-struct\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#readonly-struct\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ereadonly struct\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eC# 7.2 〜\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://blogs.msdn.microsoft.com/seteplia/2018/05/03/avoiding-struct-and-readonly-reference-performance-pitfalls-with-errorprone-net/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAvoiding struct and readonly reference performance pitfalls with ErrorProne.NET – Dissecting the code\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eC# 7.2 から、\u003ccode\u003estruct\u003c/code\u003e 自体に \u003ccode\u003ereadonly\u003c/code\u003e 修飾子をつけることができるようになりました。\u003cbr\u003e\nこれを使うことで struct に対するメソッド呼び出しの余計なコストを減らすことができます。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ereadonly struct\u003c/code\u003e は、struct が一生を通じて絶対に不変な値であることをコンパイラに教えることができる機能です。 (readonly でないとコンパイルエラー)\u003c/p\u003e\n\n\u003cp\u003e値が不変であることとパフォーマンス改善がどう関係しているんでしょうか ?\u003c/p\u003e\n\n\u003cp\u003e実は、\u003ccode\u003ereadonly struct\u003c/code\u003e を使うことで、 暗黙のうちに行われる値型のコピーが抑制されるのです。\u003c/p\u003e\n\n\u003cp\u003eいわゆる「Diffensive Copy」というやつです。\u003c/p\u003e\n\n\u003cp\u003eC# では、昔から、メンバ変数 に \u003ccode\u003ereadonly\u003c/code\u003e 修飾子をつけることで、そのメンバが不変であることを保証できました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOwner\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eFoo\u003c/span\u003e \u003cspan class=\"n\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 不変\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eしかし、これは実は、 \u003ccode\u003eFoo\u003c/code\u003e が参照型なのか、値型なのかで意味が変わります。(c言語のconst をはじめ、よくあるやつ)\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eFoo\u003c/code\u003e が参照型の場合\n\n\u003cul\u003e\n\u003cli\u003e→ 参照先が変わらないことを保証する。参照先のオブジェクトの値が変わっても気にしない。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eFoo\u003c/code\u003e が値型の場合 : \n\n\u003cul\u003e\n\u003cli\u003e→ 値が変わらないこと。つまり \u003ccode\u003efoo\u003c/code\u003e のメンバも不変であることが保証される。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eそう、 値型のメンバに readonly がついている場合、コンパイラは、\u003ccode\u003efoo\u003c/code\u003e のメンバが絶対に変更されないことを保証してくれるのです。\u003c/p\u003e\n\n\u003cp\u003eそんなことできるんでしょうか?\u003cbr\u003e\nパフォーマンスを犠牲にするとできます。その答えが、「Deffensive Copy」です。\u003c/p\u003e\n\n\u003cp\u003e値型のメンバ変数が絶対に天地がひっくり返っても不変であることを保証するために、コンパイラはコピーを作成してからメソッド呼びだしをする、という保守的な方法を採ります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cm\"\u003e/* readonly */\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eFoo\u003c/span\u003e \u003cspan class=\"c1\"\u003e// readonlyかどうかで挙動が変わる\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ..\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eOwner\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eFoo\u003c/span\u003e \u003cspan class=\"n\"\u003efoo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFoo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ここでコピー発生。 \u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 元のfooではなく、fooのコピーをつくってから Hello() を呼びだす。\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// メソッド呼び出しで値が変わるか知る方法がないため。\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eowner\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eOwner\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"n\"\u003eowner\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003ereadonly struct\u003c/code\u003e に変更してみましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"diff\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gd\"\u003e-struct Foo\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+readonly struct Foo\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eコンパイルされた IL を覗くと、ローカル変数へのfooの展開が減っていることが確認できました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"diff\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e@@ -2,9 +2,8 @@\u003c/span\u003e\n IL_0001: newobj instance void Owner::.ctor()\n IL_0006: stloc.0\n IL_0007: ldloc.0\n\u003cspan class=\"gd\"\u003e-IL_0008: ldfld valuetype Foo Owner::Foo\n-IL_000d: stloc.1\n-IL_000e: ldloca.s 1\n-IL_0010: call instance void Foo::Hello()\n-IL_0015: nop\n-IL_0016: ret\n\u003c/span\u003e\u003cspan class=\"err\"\u003e\\\u003c/span\u003e No newline at end of file\n\u003cspan class=\"gi\"\u003e+IL_0008: ldflda valuetype Foo Owner::Foo\n+IL_000d: call instance void Foo::Hello()\n+IL_0012: nop\n+IL_0013: ret\n+\n\u003c/span\u003e\u003cspan class=\"err\"\u003e\\\u003c/span\u003e No newline at end of file\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e参考リンクに書かれていますが、 \u003ccode\u003eEnumerator\u0026lt;T\u0026gt;\u003c/code\u003e は大抵は値型として実装されているので、\u003ccode\u003eMoveNext\u003c/code\u003e を呼ぶたびにコピーが走るらしいです。\u003cbr\u003e\n(この辺は今後のバージョンアップで標準ライブラリは改善されていくんでしょうか)\u003c/p\u003e\n\n\u003cp\u003eまた、Diffensive Copy は、メンバ変数に対するメソッド呼び出しだけでなく、 参照渡しした実引数のsturctに対してのメソッド呼び出しでも発生してしまいます。\u003c/p\u003e\n\n\u003cp\u003eこのコピーは、けっこうわかりずらいです。struct のサイズが大きければ大きいほど、安くないコストがかかるので、セマンティクス的にもパフォーマンス的にも、不変な型には \u003ccode\u003ereadonly\u003c/code\u003e をつけるスタイルを心掛けましょう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"引数の-in-修飾子\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%BC%95%E6%95%B0%E3%81%AE-in-%E4%BF%AE%E9%A3%BE%E5%AD%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e引数の \u003ccode\u003ein\u003c/code\u003e 修飾子\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eC# 7.2 〜\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://blogs.msdn.microsoft.com/seteplia/2018/03/07/the-in-modifier-and-the-readonly-structs-in-c/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eThe ‘in’-modifier and the readonly structs in C# – Dissecting the code\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eもともと、C# には、2種類の参照渡しができました。 読み込みも書き込みもできる\u003ccode\u003eref\u003c/code\u003eと、必ず書き込ませることを保証する \u003ccode\u003eout\u003c/code\u003e です。7.2 では、 新たに 3つめの \u003ccode\u003ein\u003c/code\u003e 参照渡しが追加されています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eFoo\u003c/span\u003e \u003cspan class=\"n\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHogehoge\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efoo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFoo\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"nf\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003ein\u003c/code\u003e は、その名のとおり、参照とその指している変数への書き替えを禁止しつつ参照渡しができる機能です。\u003c/p\u003e\n\n\u003cp\u003e参考リンクによると、書き替えが禁止されているおかげで、 \u003ccode\u003eusing\u003c/code\u003e文の中など、 \u003ccode\u003ein\u003c/code\u003e ,\u003ccode\u003eout\u003c/code\u003e 渡しが禁止されている場面でも \u003ccode\u003ein\u003c/code\u003e をつけると struct の参照渡しができるようになったとのこと。\u003c/p\u003e\n\n\u003cp\u003eでかいstruct を引数に渡したい場面で、コピーが発生せず高速にc++とかrustとかのノリで参照渡しできて便利です。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eただし、\u003ccode\u003ereadonly\u003c/code\u003e のついていないstructを参照渡ししても、結局は前述のとおり 暗黙裏にDiffensive Copyが発生してしまうため、readonly struct を合わせて使うことが推奨されます\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"標準ライブラリ編\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E7%B7%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e標準ライブラリ編\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"systemmemory--spant--memoryt\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#systemmemory--spant--memoryt\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eSystem.Memory\u003c/code\u003e  (\u003ccode\u003eSpan\u0026lt;T\u0026gt;\u003c/code\u003e / \u003ccode\u003eMemory\u0026lt;T\u0026gt;\u003c/code\u003e)\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003e.NET Standard 2.1 〜\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://msdn.microsoft.com/en-us/magazine/mt814808.aspx\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC# - All About Span: Exploring a New .NET Mainstay\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://msdn.microsoft.com/ja-jp/magazine/mt814808.aspx\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC# - Span のすべて: .NET の新しい頼みの綱を探索する\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eC# は、c, rust, swift , go あたりなどと違い、プリミティブな固定長配列も必ずヒープに置かれます。\u003c/p\u003e\n\n\u003cp\u003eこれは、ある意味で言語としてのパフォーマンス上の制約のひとつになっていたと思います。\u003c/p\u003e\n\n\u003cp\u003eスタック変数で充分な一時的な配列でもヒープ割り合てをしないといけないし、 文字列のいち部分だけの参照を使いたい場合や、配列を受けとるAPIに対して配列の一部だけを渡したいケースで、ヒープの部分的なコピーをこれまたヒープにつくらないといけない、という状況がすぐ生まれてしまうのです。(\u003ccode\u003eunsafe\u003c/code\u003eを使えば一応がんばれるが…) ヒープにコピーをつくるのは遅いです。こういうのは、どんどん伝搬していくので、全体として GCゴミの抑制がむずかしくなっていってしまいがちです。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eSystem.Memory\u003c/code\u003e パッケージは、機能的な拡張というよりは、このパフォーマンス上の制約を乗りこえるためのソリューションです。\u003c/p\u003e\n\n\u003cp\u003eこのパッケージによって、\u003ccode\u003eSpan\u0026lt;T\u0026gt;\u003c/code\u003e という、他の言語でいうところの「スライス」に近いものが導入されました。\u003c/p\u003e\n\n\u003cp\u003eこれは、メモリ上にある配列や文字列などのオブジェクトの一部分だけの参照を表現し、コレクションとして扱うことができる型です。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eSpan\u0026lt;T\u0026gt;\u003c/code\u003e という型が追加された、と聞いてもどう使うかわかりずらいかもしれませんが、参考リンクにも紹介されいるとおり、標準ライブラリの至るところでオーバーロードが用意され、 \u003ccode\u003eint.Parse()\u003c/code\u003e や \u003ccode\u003estring.SubString()\u003c/code\u003e などが Spanを渡したり返したりできるようになっています。\u003c/p\u003e\n\n\u003cp\u003e尚、\u003ccode\u003eSpan\u0026lt;T\u0026gt;\u003c/code\u003e は、スタックに存在するポインタへの参照をもつことを保証するため、ボクシングができない \u003ccode\u003eref struct\u003c/code\u003e という特殊な型として実装されています。\u003c/p\u003e\n\n\u003cp\u003eさきほど、「配列の確保にはヒープが必要」と書きましたが、 戻り値が \u003ccode\u003eSpan\u0026lt;T\u0026gt;\u003c/code\u003e な \u003ccode\u003estackalloc\u003c/code\u003e 文をつかうことで、ヒープ割り合てを回避し、スタック上に一時的な固定長配列をつくれるようになりました。\u003c/p\u003e\n\n\u003cp\u003eまた、\u003ccode\u003eSpan\u0026lt;T\u0026gt;\u003c/code\u003e は、 \u003ccode\u003eref struct\u003c/code\u003e であるため、そのローカルスコープの外へ渡すことができない、という制約があります。どうしても外へ渡したい場合のために、 \u003ccode\u003eMemory\u0026lt;T\u0026gt;\u003c/code\u003e というただのstruct も用意されています。こっちは、参照をボクシングして閉じこめたものなので、\u003ccode\u003eSpan\u0026lt;T\u0026gt;\u003c/code\u003e が使えるケースでは \u003ccode\u003eSpan\u0026lt;T\u0026gt;\u003c/code\u003e を使おう。\u003c/p\u003e\n\n\u003cp\u003e.NET Core では、リリースの度に標準ライブラリのパフォーマンスが改善されてますが、この新しい \u003ccode\u003eSpan\u0026lt;T\u0026gt;\u003c/code\u003e / \u003ccode\u003eMemory\u0026lt;T\u0026gt;\u003c/code\u003e を使った実装にどんどん書き換わっていることも大きく貢献しているみたいです。\u003c/p\u003e\n\n\u003cp\u003eスライスが使えるようになったということは、配列を値として扱えるような言語と同等の パフォーマンスを叩き出す扉が開かれたと言って良いんじゃないでしょうか。後方互換性を全く損なわいところがすごいな、と思います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"systemiopipelines\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#systemiopipelines\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eSystem.IO.Pipelines\u003c/code\u003e\n\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003e.NET Standard 2.1 〜\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://devblogs.microsoft.com/dotnet/system-io-pipelines-high-performance-io-in-net/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eSystem.IO.Pipelines: High performance IO in .NET | .NET Blog\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eMarc Gravell さんの解説\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://blog.marcgravell.com/2018/07/pipe-dreams-part-1.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCode, code and more code.: Pipe Dreams, part 1\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCode, code and more code.: Pipe Dreams, part 2\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCode, code and more code.: Pipe Dreams, part 3\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.marcgravell.com/2018/07/pipe-dreams-part-31.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCode, code and more code.: Pipe Dreams, part 3.1\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/skitoy4321/items/0fc4dc72bc50dabba92b\" id=\"reference-db85b1adf09f187ba4b3\"\u003eReadOnlySequenceについて - Qiita\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eC# でSocket APIとかを使ってサーバを書こうとした場合、前述のような事情で、バイト配列のコピーを抑制しようと四苦八苦し、なかなか煩雑なコードになりがちです。\u003c/p\u003e\n\n\u003cp\u003eあたらしい 標準ライブラリの \u003ccode\u003eSystem.IO.Pipelines\u003c/code\u003e パッケージを使うことで、「データをバッファリングしておいて、逐次読み込んで処理する」といったよくある処理が簡単に書けるようになりました。\u003c/p\u003e\n\n\u003cp\u003eこれは、内部的に \u003ccode\u003eSpan\u0026lt;T\u0026gt;/Memorty\u0026lt;T\u0026gt;\u003c/code\u003e なども使われる実装になっていたりと、バッファのアロケーションを抑制するような仕組みになっているため、これまでの自前のバイト配列管理よりパフォーマンス面でも有利です。\u003c/p\u003e\n\n\u003cp\u003e僕はまだ使ったことがなく、理解できていない部分が多いので、くわしい説明は参考リンクのほうへ譲ります。\u003c/p\u003e\n\n\u003cp\u003eC# の有名なRedisクライアント、コネクションを多重化して使う実装で有名な \u003ca href=\"https://github.com/StackExchange\" rel=\"nofollow noopener\" target=\"_blank\"\u003eStackExchange.Redis\u003c/a\u003e は、バージョン2以降でこのpipelines API で書き直されたそうです。\u003cbr\u003e\n(僕は、StackExchange.Redis 作者の人の情報発信をきっかけに知りました)\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"そんなかんじです\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%82%93%E3%81%AA%E3%81%8B%E3%82%93%E3%81%98%E3%81%A7%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eそんなかんじです\u003c/h3\u003e\n\n\u003cp\u003eなぜ速くなるのかわかりずらいけど速くなるC#の新機能について紹介してみました。\u003cbr\u003e\nその他、 \u003ccode\u003eArrayPool\u0026lt;T\u0026gt;\u003c/code\u003e など、わかりやすいやつも色々あると思うので、色々使ってみよう。\u003c/p\u003e\n\n\u003cp\u003eC# が他の ぶ厚いVMの言語よりもパフォーマンス上のポテンシャルがあることがもっと広まって、今後もどんどん速いライブラリが増えると良いなーと思いまっす。\u003c/p\u003e\n","createdAt":"2019-04-10T06:32:01Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"qllNqXUTAsfKSAuCyOTG3cABw4pS//wK--p+MK0PBfCZooOSUu--DqujqOEiHtz9KfjcHRdiNQ==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-04-17T03:02:20Z","likesCount":369,"linkUrl":"https://qiita.com/hadashiA/items/0c65a999422e7713ed3c","organization":null,"originalId":858742,"stockedCount":330,"title":"C# パフォーマンス改善に使える新しめの機能たち 7.0〜","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%96%87%E6%B3%95\"\u003e文法\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%BF%E3%83%97%E3%83%AB%E8%A8%98%E6%B3%95-valuetuple\"\u003eタプル記法 (ValueTuple)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#local-function\"\u003eLocal Function\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#readonly-struct\"\u003ereadonly struct\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%BC%95%E6%95%B0%E3%81%AE-in-%E4%BF%AE%E9%A3%BE%E5%AD%90\"\u003e引数の in 修飾子\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A8%99%E6%BA%96%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E7%B7%A8\"\u003e標準ライブラリ編\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#systemmemory--spant--memoryt\"\u003eSystem.Memory  (Span\u0026lt;T\u0026gt; / Memory\u0026lt;T\u0026gt;)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#systemiopipelines\"\u003eSystem.IO.Pipelines\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%82%93%E3%81%AA%E3%81%8B%E3%82%93%E3%81%98%E3%81%A7%E3%81%99\"\u003eそんなかんじです\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":31498,"uuid":"0c65a999422e7713ed3c","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"v6kXDdUyO8cAT0wF/8RlehAXSg==--56gc8XvPS+W7qTel--+7waJwuZRFSdWLrFmlJT7w==","originalId":5859,"description":"フリーランスプログラマだよ","facebookUrl":null,"githubUrl":"https://github.com/hadashiA","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/5859/profile-images/1473682324","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F5859%2Fprofile-images%2F1473682324?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=2628fcfe4e01546b4557ce34887fcfca","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F5859%2Fprofile-images%2F1473682324?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=b16e8286e5c3272bad99dc3238e293cd","urlName":"hadashiA","websiteUrl":"https://twitter.com/hadashiA","twitterUrl":"https://twitter.com/hadashiA","twitterUrlName":"hadashiA","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"}],"followingLikers":{"edges":[]},"comments":{"totalCount":3}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
