　11/20にMicrosoftが.NET向けのWebView2を正式公開しました。これによりWPFやWinformといったアプリで、Chromiumを採用した新しいMicrosoft Edgeベースのブラウザーコントロールを利用できることになりました。
　下記のマイクロソフトのドキュメントの中では、ブラウザーコントロールがバックエンドで使うWebViewランタイムの2つの配布方法について解説されています。この記事では2つの配布パターンの内、固定バージョンの配布モードでアプリのパッケージを作成して動作を確認します。　WebView2はバックエンドにEdgeと同じWebブラウザーのランタイムを利用するのですが、すべての環境にEdgeがインストールされているとは限らない＆様々なバージョンがインストールされている可能性があります。WebView2コントロールでは再配布可能なWebViewランタイムをアプリのパッケージに含めて、そのランタイムを利用することで安定して利用するために下記の2パターンの配布方法が用意されています。　エバーグリーン配布モードは、あらかじめWebViewランタイムがインストールされている、もしくはアプリ起動時にWebViewランタイムをインストールできる環境向けの配布モードです。実行環境にインストールされた最新のWebViewランタイムを使用するため、といったメリットがあります。　今後はWindowsのリリースに含まれる予定のようですが、現時点ではWebViewランタイムは自動的に配信されていないので、エバーグリーン配布モードを利用する場合は下記手順に従ってWebViewランタイムをインストールする必要があります。　固定バージョンの配布モードは、WebView2の配置時にWebViewランタイムのパスを指定してWebView2を初期化する方法です。エバーグリーン配布モードが実行環境に1つだけ存在する共有のWebViewランタイムを利用するのに対し、WebView2初期化時に指定した特定バージョンのWebViewランタイムを利用できるためといったメリットがありますが、　といったデメリットがあり、ランタイムの管理コストがエバーグリーン配布モードよりも高くなります。ただ、厳密に指定されたバージョンのWebViewランタイムを利用できることは大きなメリットなので、個人的にはとても魅力的に見えます。　ここの手順に従い、Microsoft Edge WebView2のダウンロードページから実行環境ごとのWebViewランタイムをダウンロードしてCabファイルをC:¥tempなどに展開します。参照元のドキュメントにもありますが、フォルダー構造が重要なのでエクスプローラーの機能で展開すると動作しないので注意が必要です。

　まずは単純にダウンロードしたランタイムを参照してプログラムが起動するかを確認していきましょう。
　WPFでのWebView2の概要に従いWPFプロジェクトを作成し、NugetからMicrosoft.Web.WebView2パッケージをプロジェクトにインストールします。App.xamlおよびMainWindow.xamlにWebView2用のネームスペースを追加し、App.xamlにWebViewランタイムのパスを設定するプロパティーをリソースに追加します。次にWebView2コントロールをページに追加し、上で作ったリソースを参照します。xml:MainWindow.xamlはこのようになります。実行すると、WebView2コントール内にSourceに指定したURLのページが表示されていることが確認できます。
　このままでは、個別にC:¥tempにWebViewランタイムをダウンロードして展開しないと動かないので、アプリのパッケージにWebViewランタイムを含めていきます。とりあえず展開したWebViewランタイムをプロジェクトにドロップしてこんな状態にします。

　このフォルダー配下の全ファイル（フォルダーの中も）の出力ディレクトリにコピープロパティーを新しい場合はコピーするにします(GUIで操作するのがめんどくさい場合は、文末の「おまけ 出力ディレクトリにコピーの設定」の設定をプロジェクトファイルに追加してあげればたぶんOKです)。これでビルド時にWebViewランタイムがパッケージに含まれるようになります。

App.xaml.csなどでアプリケーションリソースの属性値をビルド時に配置したディレクトリにしてあげれば設定は完了です。プロジェクトディレクトリで、次のコマンドを実行し単一実行形式のパッケージを作成します。じっ、実行ファイルのサイズが458MBになりましたね（汗。まぁ、WebViewランタイムを展開した時点で297MBとかありますからしょうがない、、、ですよね。サイズが気になるならエバーグリーン配布モードを使いましょう。
7zで圧縮したら140MBまで小さくなりました。
これまでWebBrowserコントロールがIEベースだったために起きていた問題が少なくなると良いですね。
WebViewランタイムのパッケージ方法はなんとなく別の方法がある気がします。
ご存じの方がいらっしゃったら教えてください。


