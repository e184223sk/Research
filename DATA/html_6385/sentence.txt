More than 3 years have passed since last update.Roslyn for Scriptingについていろいろ触ってみたのでまとめました。Visual Studio 2017 Community
.NET Framework 4.6.2
Microsoft.CodeAnalysis.CSharp.Scripting 2.1.0nugetでパッケージをインストール出来ます。パッケージインストール後、Roslyn for ScriptingのAPIが使用できるようになります。
以下、サンプルコードを示します。その他のサンプルコードについてはRoslynのgithubのwikiにあります。
https://github.com/dotnet/roslyn/wiki/Scripting-API-Samplesまた、日本語でのサンプルならば以下のサイトが一番まとまっていると思います。
http://wiki.clockahead.com/index.php?Coding/.NET/Roslyn/Scripting今までハマったことについて。同じ現象が起きた方の助けになれば幸いです。ターゲットフレームワークが.NET Framework 4.6(.NET Core 1.1)以前のバージョンになっている可能性があります。プロジェクトのプロパティからターゲットフレームワークを変更出来ます。初回だけRunAsync呼び出しからスクリプト実行まで時間が掛かります。
一応issueとして挙がっているようですが、現在(V2.1.0)はまだ修正されていないようです。RunAsync()は非同期メソッドでawaitしていても同期になり、GUIの場合はUIが固まる事があります。
スクリプトで同期処理を行っている事が原因です。非同期処理にすると非同期になります。RunAsyncには他のTaskと同様にcancelationTokenを渡すオーバーロードが存在しますが、現在スクリプト実行中にキャンセルさせる事が出来ません(スクリプト実行前にキャンセルした場合はOperationCanceledExceptionが発生してキャンセルされます)。
以下の関数を呼び出し、関数内のCancelメソッド呼び出し後もキャンセルされずにスクリプトを実行し続けます。コードを読んでみると内部でThrowIfCancellationRequestedメソッドを呼び出しているようにも見えるのですが・・対策として、スクリプト側でキャンセルするかスクリプト内で呼び出すメソッド内でキャンセルする事でTaskCanceledExceptionをthrowさせる事が出来ます。Roslyn for Scriptingについて記載しました。Visual Basicの方についても現在開発中みたいですので今後、Visual Basic版のRoslyn for Scriptingも使えるようになるかもしれません。


