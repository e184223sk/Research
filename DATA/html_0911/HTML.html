<!DOCTYPE html><html><head><meta charset="utf-8" /><title>BeatSaberで楽曲のキーを推定する - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/dea-azat/items/484be9e5a4849f30c6d6" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="8Es6fW9Pm1o5WSmnazSwSf+J6jasqW2t2R1U+ppbYoFG5geb4tnYVgduk4EBvy2UmixbWNXOah1jxcwGWzWJ5Q==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="BeatSaberで楽曲のキーを推定する - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RbVZoZEZOaFltVnk0NEduNXFXOTVwdXk0NEd1NDRLdDQ0Tzg0NEtTNW82bzVhNmE0NEdaNDRLTCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz01ZWI0ODViNTg0NTNlMDVmNjEzYzlkYjA4MzU1ZGQxMg&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR1JsWVMxaGVtRjAmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz01YjY1MTIyYTQwNmVlZGZlNWFmNmUyMmI2YmQ1ZDg3Nw&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=9802dc724367501f245fd89fc2563e1a"><meta property="og:description" content="

使用するキー推定ライブラリ


libKeyFinder


使ってみて精度が良さげだったのでこのライブラリを選定。
ほかにはSuperPowererdSDKを試したが、libKeyFinderのほうが良さそうだった。
ほかの有償..."><meta content="https://qiita.com/dea-azat/items/484be9e5a4849f30c6d6" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-46f79dac-5858-4900-97c3-e9a5faed58dc"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fdea-azat%2Fitems%2F484be9e5a4849f30c6d6">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fdea-azat%2Fitems%2F484be9e5a4849f30c6d6">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-46f79dac-5858-4900-97c3-e9a5faed58dc">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-08-13T18:55:59.000+09:00","dateModified":"2020-11-29T17:56:45.000+09:00","headline":"BeatSaberで楽曲のキーを推定する","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RbVZoZEZOaFltVnk0NEduNXFXOTVwdXk0NEd1NDRLdDQ0Tzg0NEtTNW82bzVhNmE0NEdaNDRLTCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz01ZWI0ODViNTg0NTNlMDVmNjEzYzlkYjA4MzU1ZGQxMg\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR1JsWVMxaGVtRjAmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz01YjY1MTIyYTQwNmVlZGZlNWFmNmUyMmI2YmQ1ZDg3Nw\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=9802dc724367501f245fd89fc2563e1a","mainEntityOfPage":"https://qiita.com/dea-azat/items/484be9e5a4849f30c6d6","author":{"@type":"Person","address":"","email":null,"identifier":"dea-azat","name":"dea-azat","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars3.githubusercontent.com%2Fu%2F68429166%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=d1249c8220b8bca37ba2294fe1feb93b","url":"https://qiita.com/dea-azat","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita&amp;utm_medium=header-banner">急成長する「NewsPicks」ブランドの開発思想を探る</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"dea-azat","type":"items","id":"484be9e5a4849f30c6d6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"急成長する「NewsPicks」ブランドの開発思想を探る","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"dea-azat","type":"items","id":"484be9e5a4849f30c6d6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"急成長する「NewsPicks」ブランドの開発思想を探る","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"dea-azat","type":"items","id":"484be9e5a4849f30c6d6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"急成長する「NewsPicks」ブランドの開発思想を探る","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/dea-azat/items/484be9e5a4849f30c6d6","location":"/dea-azat/items/484be9e5a4849f30c6d6","scheme":"https","host":"qiita.com","port":null,"pathname":"/dea-azat/items/484be9e5a4849f30c6d6","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"rjx2aqrT98AkbNIDtwseScGzlvSU7mNFu4lFjZ91nWUYkUuMJ0W0zBpbaCXdgIOUpBYnmu2JZPUBUd1xXht2AQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-a2d9ef6b-7a03-4abb-8188-f90bf7fa0630"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/dea-azat/items/484be9e5a4849f30c6d6/likers" class="css-1iupg5d">0</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">0</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/484be9e5a4849f30c6d6/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/dea-azat/items/484be9e5a4849f30c6d6/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/dea-azat/items/484be9e5a4849f30c6d6/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/dea-azat/items/484be9e5a4849f30c6d6/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/dea-azat/items/484be9e5a4849f30c6d6.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/dea-azat"><img class="css-100alwu eyfquo10" src="https://avatars3.githubusercontent.com/u/68429166?v=4" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/dea-azat" class="css-10ougpm">@<!-- -->dea-azat</a><div class="css-1ay9vb9"><span><meta content="2020-08-13T09:55:59Z"/><time dateTime="2020-11-29T08:56:45Z" class="css-m19uds">updated at 2020-11-29</time></span></div></div></div></div></div><h1 class="css-cgzq40">BeatSaberで楽曲のキーを推定する</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h2>
<span id="使用するキー推定ライブラリ" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%82%AD%E3%83%BC%E6%8E%A8%E5%AE%9A%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a>使用するキー推定ライブラリ</h2>

<h3>
<span id="libkeyfinder" class="fragment"></span><a href="#libkeyfinder"><i class="fa fa-link"></i></a><a href="https://github.com/ibsh/libKeyFinder" rel="nofollow noopener" target="_blank">libKeyFinder</a>
</h3>

<p>使ってみて精度が良さげだったのでこのライブラリを選定。<br>
ほかには<a href="https://github.com/superpoweredSDK/Low-Latency-Android-iOS-Linux-Windows-tvOS-macOS-Interactive-Audio-Platform" rel="nofollow noopener" target="_blank">SuperPowererdSDK</a>を試したが、libKeyFinderのほうが良さそうだった。<br><br>
<a href="http://ibrahimshaath.co.uk/keyfinder/comparison.pdf" rel="nofollow noopener" target="_blank">ほかの有償アプリと比べて遜色のない性能を持っている</a>らしい。</p>

<p>(キー推定のアルゴリズムについてはできたら今度。<br>
ピッチ推定は<a href="https://www.cycfi.com/2020/07/fast-and-efficient-pitch-detection-revisited/" rel="nofollow noopener" target="_blank">このあたり</a>か？倍音成分の除去がメイン？)</p>

<h4>
<span id="組み込み時の注意点" class="fragment"></span><a href="#%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>組み込み時の注意点</h4>

<p>Audioは非常にデータが大きいので、スタック領域に確保してはいけない。<br>
(スタック領域はWindowsで2MBなので、2~3秒のデータでさえ乗り切らない)　　<br>
動的に確保するか、staticをつけて静的領域で確保するようにする。<br>
(<a href="https://teratail.com/questions/188732" rel="nofollow noopener" target="_blank">スタック/ヒープ領域の仕組みはいまだに完全理解できない</a>)</p>

<p>また、ライブラリ側でもメモリ制限があるため、長いデータを一気に解析しようとしてはいけない。</p>

<h2>
<span id="組み込み手順" class="fragment"></span><a href="#%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>組み込み手順</h2>

<h3>
<span id="1-fftwのlibファイルを作成する" class="fragment"></span><a href="#1-fftw%E3%81%AElib%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. <a href="https://stackoverflow.com/questions/39675436/how-to-get-fftw-working-on-windows-for-dummies" rel="nofollow noopener" target="_blank">FFTWのlibファイルを作成する</a>
</h3>

<p>注：BeatSaberは64bitで動作するので64bitのライブラリを作成すること。</p>

<p>FFTWは高速フーリエ変換のライブラリで、libKeyFinderから参照されている。<br>
<a href="http://www.fftw.org/install/windows.html" rel="nofollow noopener" target="_blank">ココ</a>からFFTWをダウンロードしてきて項目タイトルのリンクの方法(<strong>Create the import library</strong>まで)でlibファイルを作成する。</p>

<p>なお、途中で開発者用コンソールの使用を求められるが、Windowsのフォルダ検索から辿れる。<br>
<a href="https://camo.qiitausercontent.com/62cd1964906f6228ad8653bb086fa7c14a70e0de/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3639313438302f39666539613136352d303861392d326630382d646436632d6661333865393232633362632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F691480%2F9fe9a165-08a9-2f08-dd6c-fa38e922c3bc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=afc1e63e9353ad59a42932daa71604cc" alt="developercommand.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/691480/9fe9a165-08a9-2f08-dd6c-fa38e922c3bc.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F691480%2F9fe9a165-08a9-2f08-dd6c-fa38e922c3bc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=7b1b23542cda5564a57dbfa3aa6fa680 1x" loading="lazy"></a></p>

<h3>
<span id="2-libkeyfinderのラッパーdllファイルを作成する" class="fragment"></span><a href="#2-libkeyfinder%E3%81%AE%E3%83%A9%E3%83%83%E3%83%91%E3%83%BCdll%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2. libKeyFinderのラッパーdllファイルを作成する</h3>

<p><a href="https://qiita.com/TackKaiware/items/27ebcf10bb2624db197a" id="reference-237462aaf1aee1b92ccb">WindowsコンソールアプリでC#からC++の関数を呼ぶ方法</a>を参考にしてdllファイルを作成し、<br>
C#から呼び出しテストをする。<br>
C++ライブラリを出力する場所がVisualStudioのバージョンによって若干違うので注意。</p>

<h5>
<span id="fftwのライブラリを組み込む" class="fragment"></span><a href="#fftw%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E7%B5%84%E3%81%BF%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>FFTWのライブラリを組み込む</h5>

<p>Visual Stdio2019では、以下の3つの場所にパスを通す必要がある。</p>

<ul>
<li>構成プロパティ → C/C++ → 追加のインクルードディレクトリ

<ul>
<li>&lt;path&gt;\fftw-3.3.5-dll64</li>
</ul>
</li>
<li>構成プロパティ → リンカー → 全般 → 追加のライブラリディレクトリ

<ul>
<li>&lt;path&gt;\fftw-3.3.5-dll64</li>
</ul>
</li>
<li>構成プロパティ → リンカー → 入力 → 追加の依存ファイル

<ul>
<li>libfftw3-3.lib</li>
</ul>
</li>
</ul>

<p>※libfftw3-3.dllはexeのあるフォルダに入れるか、パスを通す必要があるので注意。</p>

<p>また、libKeyFinderのサンプルコードは若干間違っているので注意。正しくは下記。</p>

<div class="code-frame" data-lang="c++"><div class="highlight"><pre><code>
<span class="c1">// Static because it retains useful resources for repeat use</span>
<span class="k">static</span> <span class="n">KeyFinder</span><span class="o">::</span><span class="n">KeyFinder</span> <span class="n">k</span><span class="p">;</span>

<span class="c1">// Build an empty audio object</span>
<span class="n">KeyFinder</span><span class="o">::</span><span class="n">AudioData</span> <span class="n">a</span><span class="p">;</span>

<span class="c1">// Prepare the object for your audio stream</span>
<span class="n">a</span><span class="p">.</span><span class="n">setFrameRate</span><span class="p">(</span><span class="n">yourAudioStream</span><span class="p">.</span><span class="n">framerate</span><span class="p">);</span>
<span class="n">a</span><span class="p">.</span><span class="n">setChannels</span><span class="p">(</span><span class="n">yourAudioStream</span><span class="p">.</span><span class="n">channels</span><span class="p">);</span>
<span class="n">a</span><span class="p">.</span><span class="n">addToSampleCount</span><span class="p">(</span><span class="n">yourAudioStream</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

<span class="c1">// Copy your audio into the object</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">yourAudioStream</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">a</span><span class="p">.</span><span class="n">setSample</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">yourAudioStream</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="c1">// Run the analysis</span>
<span class="n">KeyFinder</span><span class="o">::</span><span class="n">key_t</span> <span class="n">r</span> <span class="o">=</span>  <span class="n">k</span><span class="p">.</span><span class="n">keyOfAudio</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">//&lt;-ここが違う。key_tを使う</span>
</code></pre></div></div>

<h5>
<span id="cでcのデバッグ" class="fragment"></span><a href="#c%E3%81%A7c%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0"><i class="fa fa-link"></i></a>C#でC++のデバッグ</h5>

<p><a href="https://docs.microsoft.com/ja-jp/visualstudio/debugger/how-to-debug-managed-and-native-code?view=vs-2019" rel="nofollow noopener" target="_blank">native code debuggingをONにする</a></p>

<p>ブレークポイントを貼ってデバッグ実行できる。(ただし配列外参照は止まらないでランタイムエラーを出す)</p>

<h3>
<span id="3-libkeyfinderdllをunityで動かす省略可" class="fragment"></span><a href="#3-libkeyfinderdll%E3%82%92unity%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99%E7%9C%81%E7%95%A5%E5%8F%AF"><i class="fa fa-link"></i></a>3. libKeyFinder.dllをUnityで動かす(省略可)</h3>

<p>最初にUnityで実験するステップを踏んだほうが組み込み難易度が下がるので、この項目を追加。<br>
UnityでC++の関数を呼ぶには、Asset直下にPlugins/x86_64フォルダを作成し、その下にdllを置く。</p>

<h4>
<span id="サンプルコード" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>サンプルコード</h4>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code>        <span class="kt">int</span> <span class="n">dataLength</span> <span class="p">=</span> <span class="m">44100</span> <span class="p">*</span> <span class="m">5</span><span class="p">;</span><span class="err">　</span><span class="c1">//5秒のデータ</span>
        <span class="kt">int</span> <span class="n">sampleRate</span> <span class="p">=</span> <span class="m">44100</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">bitDepth</span> <span class="p">=</span> <span class="m">24</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">ampMax</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>


        <span class="n">AudioClip</span> <span class="n">clip</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">AudioSource</span><span class="p">&gt;().</span><span class="n">clip</span><span class="p">;</span>
        <span class="kt">float</span><span class="p">[]</span> <span class="n">clipData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="n">dataLength</span> <span class="p">*</span> <span class="n">clip</span><span class="p">.</span><span class="n">channels</span><span class="p">];</span>
        <span class="n">clip</span><span class="p">.</span><span class="nf">GetData</span><span class="p">(</span><span class="n">clipData</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>


        <span class="kt">double</span><span class="p">[]</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">dataLength</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span><span class="n">dataLength</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">float</span> <span class="n">monoData</span> <span class="p">=</span> <span class="n">clipData</span><span class="p">[</span><span class="n">i</span> <span class="p">*</span> <span class="m">2</span><span class="p">]</span> <span class="p">/</span> <span class="m">2f</span> <span class="p">+</span> <span class="n">clipData</span><span class="p">[</span><span class="n">i</span> <span class="p">*</span> <span class="m">2</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">/</span> <span class="m">2f</span><span class="p">;</span> <span class="c1">// とりあえずモノラルで処理</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">monoData</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">monoData</span><span class="p">)</span> <span class="p">&gt;</span> <span class="n">ampMax</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ampMax</span> <span class="p">=</span> <span class="n">monoData</span><span class="p">;</span> <span class="c1">//AudioClipはビット深度を持たないっぽいので妥協案として最大値を求めておく</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">sampleRate</span> <span class="p">=</span> <span class="n">clip</span><span class="p">.</span><span class="n">frequency</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">key</span> <span class="p">=</span> <span class="nf">KeyFind</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dataLength</span><span class="p">,</span> <span class="n">ampMax</span><span class="p">,</span> <span class="n">sampleRate</span><span class="p">);</span>
</code></pre></div></div>

<h3>
<span id="4-libkeyfinderをbeatsaberで動かす" class="fragment"></span><a href="#4-libkeyfinder%E3%82%92beatsaber%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99"><i class="fa fa-link"></i></a>4. libKeyFinderをBeatSaberで動かす</h3>

<h4>
<span id="libkeyfinderdllの配置" class="fragment"></span><a href="#libkeyfinderdll%E3%81%AE%E9%85%8D%E7%BD%AE"><i class="fa fa-link"></i></a>libKeyFinder.dllの配置</h4>

<p>以下にlibKeyFinder.dllを設置する。<br>
<code>\&lt;Beat Saber Folder&gt;\Beat Saber_Data\Plugins\</code></p>

<h4>
<span id="楽曲取得" class="fragment"></span><a href="#%E6%A5%BD%E6%9B%B2%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>楽曲取得</h4>

<h5>
<span id="1-楽曲ファイルパスの取得" class="fragment"></span><a href="#1-%E6%A5%BD%E6%9B%B2%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%91%E3%82%B9%E3%81%AE%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>1. 楽曲ファイルパスの取得</h5>

<p>デフォルトで入っている楽曲は圧縮された状態でロードされてしまうため解析できない。<br>
そのため、CustomLevel限定。(無理やり読もうとすると<a href="https://forum.unity.com/threads/cannot-get-data-from-streamed-audio-sample-but-the-sample-is-not-streamed.130371/" rel="nofollow noopener" target="_blank">こんなエラー</a>が出る)<br>
まずは、CustomLevelで追加されている楽曲のファイルパスを取得する。</p>

<p>CustomLevelPathの取得は<a href="https://github.com/andruzzzhka/BS_360_Mode/blob/26c78bb00809869966ff6b864f4651adfd1673b4/360Mode/ExtraBeatmapData.cs" rel="nofollow noopener" target="_blank">ココ</a>を参考に以下のようにした。<br>
下記実装でCustomLevelのときのみ処理が実行されるようになっている。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code>
<span class="n">IDifficultyBeatmap</span> <span class="n">diffBeatmap</span> <span class="p">=</span> <span class="n">BS_Utils</span><span class="p">.</span><span class="n">Plugin</span><span class="p">.</span><span class="n">LevelData</span><span class="p">.</span><span class="n">GameplayCoreSceneSetupData</span><span class="p">.</span><span class="n">difficultyBeatmap</span><span class="p">;</span>
<span class="n">CustomPreviewBeatmapLevel</span> <span class="n">customPreviewBeatmapLevel</span> <span class="p">=</span> <span class="n">diffBeatmap</span><span class="p">.</span><span class="n">level</span> <span class="k">as</span> <span class="n">CustomPreviewBeatmapLevel</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">customPreviewBeatmapLevel</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">customLevelPath</span> <span class="p">=</span> <span class="n">customPreviewBeatmapLevel</span><span class="p">.</span><span class="n">customLevelPath</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">songFileName</span> <span class="p">=</span> <span class="n">customPreviewBeatmapLevel</span><span class="p">.</span><span class="n">standardLevelInfoSaveData</span><span class="p">.</span><span class="n">songFilename</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">filepath</span> <span class="p">=</span> <span class="n">customLevelPath</span> <span class="p">+</span> <span class="s">"\\"</span> <span class="p">+</span> <span class="n">songFileName</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<h5>
<span id="2ファイルをaudioclipとして読み込んで波形データを取得する" class="fragment"></span><a href="#2%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92audioclip%E3%81%A8%E3%81%97%E3%81%A6%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%93%E3%81%A7%E6%B3%A2%E5%BD%A2%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2.ファイルをAudioClipとして読み込んで波形データを取得する</h5>

<p>ファイルパスからAudioClipに読み込むときには、<a href="https://docs.unity3d.com/ScriptReference/Networking.UnityWebRequestMultimedia.GetAudioClip.html" rel="nofollow noopener" target="_blank">UnityWebRequset</a>を使う。</p>

<h4>
<span id="サンプルコード-1" class="fragment"></span><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89-1"><i class="fa fa-link"></i></a>サンプルコード</h4>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code>        <span class="n">IEnumerator</span> <span class="nf">LoadAudioClipWithWebRequest</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">AudioClip</span> <span class="n">clip</span><span class="p">;</span> 

            <span class="k">using</span> <span class="p">(</span><span class="n">UnityWebRequest</span> <span class="n">www</span> <span class="p">=</span> <span class="n">UnityWebRequestMultimedia</span><span class="p">.</span><span class="nf">GetAudioClip</span><span class="p">(</span><span class="s">"file://"</span> <span class="p">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">AudioType</span><span class="p">.</span><span class="n">OGGVORBIS</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">yield</span> <span class="k">return</span> <span class="n">www</span><span class="p">.</span><span class="nf">SendWebRequest</span><span class="p">();</span> <span class="cm">/* 読み込みを待ってあげないとダメ */</span>
                <span class="n">clip</span> <span class="p">=</span> <span class="n">DownloadHandlerAudioClip</span><span class="p">.</span><span class="nf">GetContent</span><span class="p">(</span><span class="n">www</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kt">int</span> <span class="n">key</span> <span class="p">=</span> <span class="n">KeyFinder</span><span class="p">.</span><span class="nf">KeyFind</span><span class="p">(</span><span class="n">clip</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p><code>www.result == UnityWebRequest.Result.ConnectionError</code>は構文エラーが出たので取ってしまった。<br>
AudioClipのLoadStatusがLoadedになっていることを確認すればとりあえずはOKのはず。</p>

<p>(ちなみにWebRequestでLoad中は、LoadStatusはUnloadのまま。<br>
<code>yield return www.SendWebRequest();</code>でLoadを待ってあげないといけない。<br>
したがってコルーチンの使用が必須になるが、<code>MonoBehaiviour</code>を継承すればよいだけ)</p>

<p>波形データが得られれば、libKeyFinderに渡してやればおしまい。</p>

<h2>
<span id="参考情報" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1"><i class="fa fa-link"></i></a>参考情報</h2>

<ul>
<li>テスト用にWaveファイルを読み込むときのライブラリは<a href="https://github.com/adamstark/AudioFile" rel="nofollow noopener" target="_blank">AudioFile</a>が使いやすかった</li>
<li><p>AudioClipの読み込み方法をプログラム内で<a href="https://kan-kikuchi.hatenablog.com/entry/AudioSettings" rel="nofollow noopener" target="_blank">動的に設定する方法がある</a>らしい(<a href="https://docs.unity3d.com/ScriptReference/AudioImporter.html" rel="nofollow noopener" target="_blank">AudioImporter</a>)</p></li>
<li><p>デフォルト楽曲をどうにか読めないか検索しているとき、<a href="https://medium.com/swlh/beatmapsynth-an-automatic-song-mapper-for-beat-saber-aa9e59f093f8" rel="nofollow noopener" target="_blank">譜面自動生成ライブラリ</a>を発見した。<br>
ここを参考にすればもしかしたらデフォルト楽曲も読めるようになる？</p></li>
</ul>

<h2>
<span id="あとがき" class="fragment"></span><a href="#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D"><i class="fa fa-link"></i></a>あとがき</h2>

<p>BeatSaberに組み込むときのサンプルコード全体は<a href="https://github.com/dea-azat/SongPerformer" rel="nofollow noopener" target="_blank">コチラ</a></p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fdea-azat%2Fitems%2F484be9e5a4849f30c6d6&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fdea-azat%2Fitems%2F484be9e5a4849f30c6d6&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/dea-azat/items/484be9e5a4849f30c6d6/likers" class="css-1iupg5d">0</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">0</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/484be9e5a4849f30c6d6/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/dea-azat/items/484be9e5a4849f30c6d6/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/dea-azat/items/484be9e5a4849f30c6d6/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/dea-azat/items/484be9e5a4849f30c6d6/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/dea-azat/items/484be9e5a4849f30c6d6.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-a2d9ef6b-7a03-4abb-8188-f90bf7fa0630">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-6913e2c6-1bfb-4098-91fd-abf3991f2da3"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-6913e2c6-1bfb-4098-91fd-abf3991f2da3">{}</script>
      
<div id="LoginModal-react-component-00fd6407-3583-4410-a0ba-c06b3d1e1bc3"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-00fd6407-3583-4410-a0ba-c06b3d1e1bc3">{}</script>
      
<div id="StockModal-react-component-b78096cc-e983-49dc-8d06-2c834e50223a"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-b78096cc-e983-49dc-8d06-2c834e50223a">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;5qnBcvlIERKSBmLTswD1rAcTAv1XFxoWDHCwe7viGnZQBPyUdN5SHqwx2PXZi2hxYrazky5wHaa2qCiHeozxEg==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch2\u003e\n\u003cspan id=\"使用するキー推定ライブラリ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%82%AD%E3%83%BC%E6%8E%A8%E5%AE%9A%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e使用するキー推定ライブラリ\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"libkeyfinder\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#libkeyfinder\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ca href=\"https://github.com/ibsh/libKeyFinder\" rel=\"nofollow noopener\" target=\"_blank\"\u003elibKeyFinder\u003c/a\u003e\n\u003c/h3\u003e\n\n\u003cp\u003e使ってみて精度が良さげだったのでこのライブラリを選定。\u003cbr\u003e\nほかには\u003ca href=\"https://github.com/superpoweredSDK/Low-Latency-Android-iOS-Linux-Windows-tvOS-macOS-Interactive-Audio-Platform\" rel=\"nofollow noopener\" target=\"_blank\"\u003eSuperPowererdSDK\u003c/a\u003eを試したが、libKeyFinderのほうが良さそうだった。\u003cbr\u003e\u003cbr\u003e\n\u003ca href=\"http://ibrahimshaath.co.uk/keyfinder/comparison.pdf\" rel=\"nofollow noopener\" target=\"_blank\"\u003eほかの有償アプリと比べて遜色のない性能を持っている\u003c/a\u003eらしい。\u003c/p\u003e\n\n\u003cp\u003e(キー推定のアルゴリズムについてはできたら今度。\u003cbr\u003e\nピッチ推定は\u003ca href=\"https://www.cycfi.com/2020/07/fast-and-efficient-pitch-detection-revisited/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこのあたり\u003c/a\u003eか？倍音成分の除去がメイン？)\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"組み込み時の注意点\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e組み込み時の注意点\u003c/h4\u003e\n\n\u003cp\u003eAudioは非常にデータが大きいので、スタック領域に確保してはいけない。\u003cbr\u003e\n(スタック領域はWindowsで2MBなので、2~3秒のデータでさえ乗り切らない)　　\u003cbr\u003e\n動的に確保するか、staticをつけて静的領域で確保するようにする。\u003cbr\u003e\n(\u003ca href=\"https://teratail.com/questions/188732\" rel=\"nofollow noopener\" target=\"_blank\"\u003eスタック/ヒープ領域の仕組みはいまだに完全理解できない\u003c/a\u003e)\u003c/p\u003e\n\n\u003cp\u003eまた、ライブラリ側でもメモリ制限があるため、長いデータを一気に解析しようとしてはいけない。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"組み込み手順\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E6%89%8B%E9%A0%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e組み込み手順\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"1-fftwのlibファイルを作成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-fftw%E3%81%AElib%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. \u003ca href=\"https://stackoverflow.com/questions/39675436/how-to-get-fftw-working-on-windows-for-dummies\" rel=\"nofollow noopener\" target=\"_blank\"\u003eFFTWのlibファイルを作成する\u003c/a\u003e\n\u003c/h3\u003e\n\n\u003cp\u003e注：BeatSaberは64bitで動作するので64bitのライブラリを作成すること。\u003c/p\u003e\n\n\u003cp\u003eFFTWは高速フーリエ変換のライブラリで、libKeyFinderから参照されている。\u003cbr\u003e\n\u003ca href=\"http://www.fftw.org/install/windows.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eココ\u003c/a\u003eからFFTWをダウンロードしてきて項目タイトルのリンクの方法(\u003cstrong\u003eCreate the import library\u003c/strong\u003eまで)でlibファイルを作成する。\u003c/p\u003e\n\n\u003cp\u003eなお、途中で開発者用コンソールの使用を求められるが、Windowsのフォルダ検索から辿れる。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/62cd1964906f6228ad8653bb086fa7c14a70e0de/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3639313438302f39666539613136352d303861392d326630382d646436632d6661333865393232633362632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F691480%2F9fe9a165-08a9-2f08-dd6c-fa38e922c3bc.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=afc1e63e9353ad59a42932daa71604cc\" alt=\"developercommand.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/691480/9fe9a165-08a9-2f08-dd6c-fa38e922c3bc.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F691480%2F9fe9a165-08a9-2f08-dd6c-fa38e922c3bc.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=7b1b23542cda5564a57dbfa3aa6fa680 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"2-libkeyfinderのラッパーdllファイルを作成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2-libkeyfinder%E3%81%AE%E3%83%A9%E3%83%83%E3%83%91%E3%83%BCdll%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2. libKeyFinderのラッパーdllファイルを作成する\u003c/h3\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/TackKaiware/items/27ebcf10bb2624db197a\" id=\"reference-237462aaf1aee1b92ccb\"\u003eWindowsコンソールアプリでC#からC++の関数を呼ぶ方法\u003c/a\u003eを参考にしてdllファイルを作成し、\u003cbr\u003e\nC#から呼び出しテストをする。\u003cbr\u003e\nC++ライブラリを出力する場所がVisualStudioのバージョンによって若干違うので注意。\u003c/p\u003e\n\n\u003ch5\u003e\n\u003cspan id=\"fftwのライブラリを組み込む\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#fftw%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E7%B5%84%E3%81%BF%E8%BE%BC%E3%82%80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFFTWのライブラリを組み込む\u003c/h5\u003e\n\n\u003cp\u003eVisual Stdio2019では、以下の3つの場所にパスを通す必要がある。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e構成プロパティ → C/C++ → 追加のインクルードディレクトリ\n\n\u003cul\u003e\n\u003cli\u003e\u0026lt;path\u0026gt;\\fftw-3.3.5-dll64\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e構成プロパティ → リンカー → 全般 → 追加のライブラリディレクトリ\n\n\u003cul\u003e\n\u003cli\u003e\u0026lt;path\u0026gt;\\fftw-3.3.5-dll64\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e構成プロパティ → リンカー → 入力 → 追加の依存ファイル\n\n\u003cul\u003e\n\u003cli\u003elibfftw3-3.lib\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e※libfftw3-3.dllはexeのあるフォルダに入れるか、パスを通す必要があるので注意。\u003c/p\u003e\n\n\u003cp\u003eまた、libKeyFinderのサンプルコードは若干間違っているので注意。正しくは下記。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\n\u003cspan class=\"c1\"\u003e// Static because it retains useful resources for repeat use\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eKeyFinder\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyFinder\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// Build an empty audio object\u003c/span\u003e\n\u003cspan class=\"n\"\u003eKeyFinder\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eAudioData\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// Prepare the object for your audio stream\u003c/span\u003e\n\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esetFrameRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eyourAudioStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eframerate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esetChannels\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eyourAudioStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003echannels\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eaddToSampleCount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eyourAudioStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// Copy your audio into the object\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eyourAudioStream\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esetSample\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eyourAudioStream\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// Run the analysis\u003c/span\u003e\n\u003cspan class=\"n\"\u003eKeyFinder\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ekey_t\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e  \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ekeyOfAudio\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e//\u0026lt;-ここが違う。key_tを使う\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch5\u003e\n\u003cspan id=\"cでcのデバッグ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#c%E3%81%A7c%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eC#でC++のデバッグ\u003c/h5\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/visualstudio/debugger/how-to-debug-managed-and-native-code?view=vs-2019\" rel=\"nofollow noopener\" target=\"_blank\"\u003enative code debuggingをONにする\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eブレークポイントを貼ってデバッグ実行できる。(ただし配列外参照は止まらないでランタイムエラーを出す)\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"3-libkeyfinderdllをunityで動かす省略可\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3-libkeyfinderdll%E3%82%92unity%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99%E7%9C%81%E7%95%A5%E5%8F%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3. libKeyFinder.dllをUnityで動かす(省略可)\u003c/h3\u003e\n\n\u003cp\u003e最初にUnityで実験するステップを踏んだほうが組み込み難易度が下がるので、この項目を追加。\u003cbr\u003e\nUnityでC++の関数を呼ぶには、Asset直下にPlugins/x86_64フォルダを作成し、その下にdllを置く。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"サンプルコード\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eサンプルコード\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e44100\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"err\"\u003e　\u003c/span\u003e\u003cspan class=\"c1\"\u003e//5秒のデータ\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esampleRate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e44100\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebitDepth\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e24\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eampMax\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\n        \u003cspan class=\"n\"\u003eAudioClip\u003c/span\u003e \u003cspan class=\"n\"\u003eclip\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAudioSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003eclip\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eclipData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003edataLength\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eclip\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003echannels\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eclip\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclipData\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\n        \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003emonoData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclipData\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2f\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eclipData\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// とりあえずモノラルで処理\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003emonoData\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAbs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emonoData\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eampMax\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eampMax\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emonoData\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e//AudioClipはビット深度を持たないっぽいので妥協案として最大値を求めておく\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003esampleRate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclip\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efrequency\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eKeyFind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eampMax\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esampleRate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"4-libkeyfinderをbeatsaberで動かす\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4-libkeyfinder%E3%82%92beatsaber%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4. libKeyFinderをBeatSaberで動かす\u003c/h3\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"libkeyfinderdllの配置\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#libkeyfinderdll%E3%81%AE%E9%85%8D%E7%BD%AE\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003elibKeyFinder.dllの配置\u003c/h4\u003e\n\n\u003cp\u003e以下にlibKeyFinder.dllを設置する。\u003cbr\u003e\n\u003ccode\u003e\\\u0026lt;Beat Saber Folder\u0026gt;\\Beat Saber_Data\\Plugins\\\u003c/code\u003e\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"楽曲取得\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A5%BD%E6%9B%B2%E5%8F%96%E5%BE%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e楽曲取得\u003c/h4\u003e\n\n\u003ch5\u003e\n\u003cspan id=\"1-楽曲ファイルパスの取得\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-%E6%A5%BD%E6%9B%B2%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%91%E3%82%B9%E3%81%AE%E5%8F%96%E5%BE%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. 楽曲ファイルパスの取得\u003c/h5\u003e\n\n\u003cp\u003eデフォルトで入っている楽曲は圧縮された状態でロードされてしまうため解析できない。\u003cbr\u003e\nそのため、CustomLevel限定。(無理やり読もうとすると\u003ca href=\"https://forum.unity.com/threads/cannot-get-data-from-streamed-audio-sample-but-the-sample-is-not-streamed.130371/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこんなエラー\u003c/a\u003eが出る)\u003cbr\u003e\nまずは、CustomLevelで追加されている楽曲のファイルパスを取得する。\u003c/p\u003e\n\n\u003cp\u003eCustomLevelPathの取得は\u003ca href=\"https://github.com/andruzzzhka/BS_360_Mode/blob/26c78bb00809869966ff6b864f4651adfd1673b4/360Mode/ExtraBeatmapData.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eココ\u003c/a\u003eを参考に以下のようにした。\u003cbr\u003e\n下記実装でCustomLevelのときのみ処理が実行されるようになっている。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\n\u003cspan class=\"n\"\u003eIDifficultyBeatmap\u003c/span\u003e \u003cspan class=\"n\"\u003ediffBeatmap\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBS_Utils\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlugin\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLevelData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGameplayCoreSceneSetupData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edifficultyBeatmap\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eCustomPreviewBeatmapLevel\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomPreviewBeatmapLevel\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ediffBeatmap\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elevel\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003eCustomPreviewBeatmapLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecustomPreviewBeatmapLevel\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomLevelPath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomPreviewBeatmapLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecustomLevelPath\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003esongFileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomPreviewBeatmapLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estandardLevelInfoSaveData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esongFilename\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003efilepath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomLevelPath\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\\\\\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003esongFileName\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch5\u003e\n\u003cspan id=\"2ファイルをaudioclipとして読み込んで波形データを取得する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92audioclip%E3%81%A8%E3%81%97%E3%81%A6%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%93%E3%81%A7%E6%B3%A2%E5%BD%A2%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2.ファイルをAudioClipとして読み込んで波形データを取得する\u003c/h5\u003e\n\n\u003cp\u003eファイルパスからAudioClipに読み込むときには、\u003ca href=\"https://docs.unity3d.com/ScriptReference/Networking.UnityWebRequestMultimedia.GetAudioClip.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnityWebRequset\u003c/a\u003eを使う。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"サンプルコード-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eサンプルコード\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e        \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"nf\"\u003eLoadAudioClipWithWebRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003efilename\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eAudioClip\u003c/span\u003e \u003cspan class=\"n\"\u003eclip\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \n\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUnityWebRequest\u003c/span\u003e \u003cspan class=\"n\"\u003ewww\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eUnityWebRequestMultimedia\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAudioClip\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"file://\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efilename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eAudioType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOGGVORBIS\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ewww\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendWebRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* 読み込みを待ってあげないとダメ */\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eclip\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDownloadHandlerAudioClip\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetContent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewww\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eKeyFinder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eKeyFind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclip\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003ewww.result == UnityWebRequest.Result.ConnectionError\u003c/code\u003eは構文エラーが出たので取ってしまった。\u003cbr\u003e\nAudioClipのLoadStatusがLoadedになっていることを確認すればとりあえずはOKのはず。\u003c/p\u003e\n\n\u003cp\u003e(ちなみにWebRequestでLoad中は、LoadStatusはUnloadのまま。\u003cbr\u003e\n\u003ccode\u003eyield return www.SendWebRequest();\u003c/code\u003eでLoadを待ってあげないといけない。\u003cbr\u003e\nしたがってコルーチンの使用が必須になるが、\u003ccode\u003eMonoBehaiviour\u003c/code\u003eを継承すればよいだけ)\u003c/p\u003e\n\n\u003cp\u003e波形データが得られれば、libKeyFinderに渡してやればおしまい。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"参考情報\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考情報\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eテスト用にWaveファイルを読み込むときのライブラリは\u003ca href=\"https://github.com/adamstark/AudioFile\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAudioFile\u003c/a\u003eが使いやすかった\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eAudioClipの読み込み方法をプログラム内で\u003ca href=\"https://kan-kikuchi.hatenablog.com/entry/AudioSettings\" rel=\"nofollow noopener\" target=\"_blank\"\u003e動的に設定する方法がある\u003c/a\u003eらしい(\u003ca href=\"https://docs.unity3d.com/ScriptReference/AudioImporter.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAudioImporter\u003c/a\u003e)\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eデフォルト楽曲をどうにか読めないか検索しているとき、\u003ca href=\"https://medium.com/swlh/beatmapsynth-an-automatic-song-mapper-for-beat-saber-aa9e59f093f8\" rel=\"nofollow noopener\" target=\"_blank\"\u003e譜面自動生成ライブラリ\u003c/a\u003eを発見した。\u003cbr\u003e\nここを参考にすればもしかしたらデフォルト楽曲も読めるようになる？\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"あとがき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eあとがき\u003c/h2\u003e\n\n\u003cp\u003eBeatSaberに組み込むときのサンプルコード全体は\u003ca href=\"https://github.com/dea-azat/SongPerformer\" rel=\"nofollow noopener\" target=\"_blank\"\u003eコチラ\u003c/a\u003e\u003c/p\u003e\n","createdAt":"2020-08-13T09:55:59Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"lMsZTD8kVaA7qqk1DFkYGUKncbHAoRzu5A==--p6R1wo3amFYsusrW--S08IXeKlHnmZSCIOno6xYA==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-11-29T08:56:45Z","likesCount":0,"linkUrl":"https://qiita.com/dea-azat/items/484be9e5a4849f30c6d6","organization":null,"originalId":1281300,"stockedCount":0,"title":"BeatSaberで楽曲のキーを推定する","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%82%AD%E3%83%BC%E6%8E%A8%E5%AE%9A%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA\"\u003e使用するキー推定ライブラリ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#libkeyfinder\"\u003elibKeyFinder\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003e組み込み時の注意点\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E6%89%8B%E9%A0%86\"\u003e組み込み手順\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1-fftw%E3%81%AElib%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e1. FFTWのlibファイルを作成する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2-libkeyfinder%E3%81%AE%E3%83%A9%E3%83%83%E3%83%91%E3%83%BCdll%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e2. libKeyFinderのラッパーdllファイルを作成する\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#fftw%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E7%B5%84%E3%81%BF%E8%BE%BC%E3%82%80\"\u003eFFTWのライブラリを組み込む\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#c%E3%81%A7c%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\"\u003eC#でC++のデバッグ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3-libkeyfinderdll%E3%82%92unity%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99%E7%9C%81%E7%95%A5%E5%8F%AF\"\u003e3. libKeyFinder.dllをUnityで動かす(省略可)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89\"\u003eサンプルコード\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4-libkeyfinder%E3%82%92beatsaber%E3%81%A7%E5%8B%95%E3%81%8B%E3%81%99\"\u003e4. libKeyFinderをBeatSaberで動かす\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#libkeyfinderdll%E3%81%AE%E9%85%8D%E7%BD%AE\"\u003elibKeyFinder.dllの配置\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A5%BD%E6%9B%B2%E5%8F%96%E5%BE%97\"\u003e楽曲取得\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1-%E6%A5%BD%E6%9B%B2%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%91%E3%82%B9%E3%81%AE%E5%8F%96%E5%BE%97\"\u003e1. 楽曲ファイルパスの取得\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92audioclip%E3%81%A8%E3%81%97%E3%81%A6%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%93%E3%81%A7%E6%B3%A2%E5%BD%A2%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B\"\u003e2.ファイルをAudioClipとして読み込んで波形データを取得する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%B3%E3%83%BC%E3%83%89-1\"\u003eサンプルコード\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E6%83%85%E5%A0%B1\"\u003e参考情報\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D\"\u003eあとがき\u003c/a\u003e\n\u003c/li\u003e\n\n","totalPv":287,"uuid":"484be9e5a4849f30c6d6","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"NFAgIzEQttSs9Xp0QuMHYkJuDYPB--ipDQTdoUFrCilhfg--Q+eiB4di2PAq26E2AmONUA==","originalId":691480,"description":"","facebookUrl":null,"githubUrl":"https://github.com/dea-azat","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://avatars3.githubusercontent.com/u/68429166?v=4","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars3.githubusercontent.com%2Fu%2F68429166%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=a329299fbeb50300e7b66633f210b7f8","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars3.githubusercontent.com%2Fu%2F68429166%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=d1249c8220b8bca37ba2294fe1feb93b","urlName":"dea-azat","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
