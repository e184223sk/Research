<!DOCTYPE html><html><head><meta charset="utf-8" /><title>【Unity, C#】続・privateな型やメンバにアクセスするには、多分これが一番早いと思います - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/mob-sakai/items/a24780d68a6133be338f" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="s/YkkLHGVQ81HmOklZELPV6ASs3ZP52C3rquV+qY/XZz1yt5saiLQqBs7wiSh1ZR4QbddFb0gbX/ExBi6eUa9g==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="【Unity, C#】続・privateな型やメンバにアクセスするには、多分これが一番早いと思います - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRVlc1cGRIa3NJRU1qNDRDUjU3YWE0NE83Y0hKcGRtRjBaZU9CcXVXZWktT0NoT09Eb2VPRHMtT0RrT09CcS1PQ291T0NyLU9DdS1PQ3VlT0JtZU9DaS1PQnEtT0JyLU9BZ2VXa211V0lodU9Cay1PQ2pPT0JqT1M0Z09lVnF1YVhxZU9CaE9PQnFPYUFuZU9CaE9PQnZ1T0JtUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0yOTJjNjBiZjA2ZWU5NjVmODZjOWZiZGM1ZDk4YjNmZA&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzF2WWkxellXdGhhUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWVlZDdiMzJkOThlZWY4MzNlZWNiNDM4OWNjYWM2ODU5&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=3c78abfcec9c1e4363a25c476de4eaf2"><meta property="og:description" content="この記事は【unityプロ技②】 Advent Calendar 2019の25日目の記事です。
この記事は【Unity, C#】internalな型やメンバにアクセスするには、多分これが一番早いと思いますの続編です。先にこちらをご覧..."><meta content="https://qiita.com/mob-sakai/items/a24780d68a6133be338f" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,private,Unity" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-678c15c1-4eed-4d95-a716-59236c496ce5"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fmob-sakai%2Fitems%2Fa24780d68a6133be338f">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fmob-sakai%2Fitems%2Fa24780d68a6133be338f">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-678c15c1-4eed-4d95-a716-59236c496ce5">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-12-13T15:40:09.000+09:00","dateModified":"2019-12-27T13:53:05.000+09:00","headline":"【Unity, C#】続・privateな型やメンバにアクセスするには、多分これが一番早いと思います","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRVlc1cGRIa3NJRU1qNDRDUjU3YWE0NE83Y0hKcGRtRjBaZU9CcXVXZWktT0NoT09Eb2VPRHMtT0RrT09CcS1PQ291T0NyLU9DdS1PQ3VlT0JtZU9DaS1PQnEtT0JyLU9BZ2VXa211V0lodU9Cay1PQ2pPT0JqT1M0Z09lVnF1YVhxZU9CaE9PQnFPYUFuZU9CaE9PQnZ1T0JtUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0yOTJjNjBiZjA2ZWU5NjVmODZjOWZiZGM1ZDk4YjNmZA\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzF2WWkxellXdGhhUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWVlZDdiMzJkOThlZWY4MzNlZWNiNDM4OWNjYWM2ODU5\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=3c78abfcec9c1e4363a25c476de4eaf2","mainEntityOfPage":"https://qiita.com/mob-sakai/items/a24780d68a6133be338f","author":{"@type":"Person","address":null,"email":null,"identifier":"mob-sakai","name":"mob-sakai","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F12690315%3Fv%3D3?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=157030055d562d2dae611d3a9828b0cf","url":"https://qiita.com/mob-sakai","description":null,"memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mob-sakai","type":"items","id":"a24780d68a6133be338f"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mob-sakai","type":"items","id":"a24780d68a6133be338f"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mob-sakai","type":"items","id":"a24780d68a6133be338f"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/mob-sakai/items/a24780d68a6133be338f","location":"/mob-sakai/items/a24780d68a6133be338f","scheme":"https","host":"qiita.com","port":null,"pathname":"/mob-sakai/items/a24780d68a6133be338f","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"ERbB/LaTEUt06o3/SD8etAeaNBp+ha9izCXZVjOI+c7RN84Vtv3PBuGYAVNPKUPYuByjo/FOs1XtjGdjMPUeTg==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-4bc15d6a-1bdd-416d-bf83-b0c31b1aa0ec"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mob-sakai/items/a24780d68a6133be338f/likers" class="css-1iupg5d">24</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">15</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/a24780d68a6133be338f/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mob-sakai/items/a24780d68a6133be338f/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mob-sakai/items/a24780d68a6133be338f/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mob-sakai/items/a24780d68a6133be338f/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mob-sakai/items/a24780d68a6133be338f.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2019/unityforpro2" class="it-AdcalRibbon_title">【unityプロ技②】<!-- --> Advent Calendar<!-- --> <!-- -->2019</a>Day 25</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/mob-sakai"><img class="css-100alwu eyfquo10" src="https://avatars.githubusercontent.com/u/12690315?v=3" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/mob-sakai" class="css-10ougpm">@<!-- -->mob-sakai</a><div class="css-1ay9vb9"><span><meta content="2019-12-13T06:40:09Z"/><time dateTime="2019-12-27T04:53:05Z" class="css-m19uds">updated at 2019-12-27</time></span></div></div></div></div></div><h1 class="css-cgzq40">【Unity, C#】続・privateな型やメンバにアクセスするには、多分これが一番早いと思います</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/private" class="css-4czcte">private</a><a href="/tags/unity" class="css-4czcte">Unity</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>この記事は<a href="https://qiita.com/advent-calendar/2019/unityforpro2">【unityプロ技②】 Advent Calendar 2019</a>の25日目の記事です。<br>
この記事は<a href="https://qiita.com/mob-sakai/items/f3bbc0c45abc31ea7ac0" id="reference-a3c1b4630e94d4b63d31">【Unity, C#】internalな型やメンバにアクセスするには、多分これが一番早いと思います</a>の続編です。先にこちらをご覧ください。<br>
この記事におけるソースコードは、全て<code>Public Domain</code>です。</p>

<h2>
<span id="tldr" class="fragment"></span><a href="#tldr"><i class="fa fa-link"></i></a>TL;DR</h2>

<ul>
<li>C#の属性<code>IgnoresAccessChecksToAttribute</code>は実は<strong>任意の外部アセンブリのinternal/privateメンバに対して自由にアクセスできるヤバいやつ</strong>だったよ。C#宇宙の　法則が　乱れる！</li>
<li>
<strong>自作のRoslynコンパイラをビルドパイプラインに乗っける</strong>ことで、ワークフローを意識することなく運用できるよ。</li>
<li>
<strong>C#8の機能を使うことができる</strong>よ。</li>
<li>くれぐれも　じこせきにんで　おねがいします。</li>
</ul>

<h2>
<span id="ignoresaccesscheckstoattributeおさらい" class="fragment"></span><a href="#ignoresaccesscheckstoattribute%E3%81%8A%E3%81%95%E3%82%89%E3%81%84"><i class="fa fa-link"></i></a><code>IgnoresAccessChecksToAttribute</code>おさらい</h2>

<p><a href="https://qiita.com/mob-sakai/items/f3bbc0c45abc31ea7ac0">前回</a>、こんな風に述べてました。</p>

<blockquote>
<ul>
<li>InternalsVisibleToAttributeとは逆の方向に作用する。つまり、ライブラリ利用者側に設定することで、ライブラリに対するinternalアクセスを許可する</li>
<li>フルネームはSystem.Runtime.CompilerServices.IgnoresAccessChecksToAttribute</li>
<li>Base Class Libraryに載っていないが、ランタイム（CLR/CoreCLR）で作用する</li>
<li>csc.exeやMsBuildを使わずに自力でコンパイルする際に、CSharpCompilationOptions.TopLevelBinderFlagsに対して特定のフラグを立てると有効になる</li>
</ul>
</blockquote>

<p>ところが、その後の調査により、<strong>privateな型やメンバ</strong>に対してもアクセスができることが判明しました。</p>

<p>ちなみに、<strong><a href="https://www.strathweb.com/2018/10/no-internalvisibleto-no-problem-bypassing-c-visibility-rules-with-roslyn/" rel="nofollow noopener" target="_blank">元記事</a>にもキッチリ書いてありました</strong>。</p>

<ul>
<li>In other words, how to get access to internal and private members without needing to use reflection or something like InternalsVisibleToAttribute.</li>
</ul>

<p>うっかりが過ぎる。</p>

<h2>
<span id="privateな型やメンバにアクセスするモチベーション" class="fragment"></span><a href="#private%E3%81%AA%E5%9E%8B%E3%82%84%E3%83%A1%E3%83%B3%E3%83%90%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>privateな型やメンバにアクセスするモチベーション</h2>

<p><a href="https://qiita.com/mob-sakai/items/f3bbc0c45abc31ea7ac0#internal%E3%81%AA%E5%9E%8B%E3%82%84%E3%83%A1%E3%83%B3%E3%83%90%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3" id="reference-a3c1b4630e94d4b63d31">internalな型やメンバにアクセスするモチベーション</a>と同じです。<br>
internal要素以上に、privateアクセス修飾子によって隠蔽されているメンバは多く、その中には有用なものもあります。</p>

<p>また、例えば拡張メソッドを実装する場面において、<strong>そのクラスのprivateメンバを扱うことができる</strong>と考えるとどうでしょうか。<br>
パフォーマンス/機能面で強力なハックを提供できるかもしれません。</p>

<h2>
<span id="実際やろうとすると手順が面倒なことに気づく" class="fragment"></span><a href="#%E5%AE%9F%E9%9A%9B%E3%82%84%E3%82%8D%E3%81%86%E3%81%A8%E3%81%99%E3%82%8B%E3%81%A8%E6%89%8B%E9%A0%86%E3%81%8C%E9%9D%A2%E5%80%92%E3%81%AA%E3%81%93%E3%81%A8%E3%81%AB%E6%B0%97%E3%81%A5%E3%81%8F"><i class="fa fa-link"></i></a>実際やろうとすると手順が面倒なことに気づく</h2>

<p><a href="https://github.com/mob-sakai/InternalAccessibleCompilerForUnity" rel="nofollow noopener" target="_blank">前回のパッケージ</a>を使ってprivateアクセスしてみましょう。</p>

<ul>
<li>privateアクセスするコードを書く。IDE上でエラー表示になる(正常)</li>
<li>Unity側ではコンパイルエラーになる(正常)</li>
<li>
<code>Assets/Open C# Project</code>でC#プロジェクトを生成</li>
<li>
<code>AssemblyDefinitionFile</code>を<code>Define Constraints</code>で無効化し、コンパイルエラーを解消</li>
<li>
<code>AssemblyDefinitionFile</code>を右クリックし、<code>InternalAccessibleCompiler/Compile</code>でコンパイル</li>
<li>生成したdllをインポート</li>
</ul>

<p>わーい、<strong>とっても面倒くさい</strong>。<br>
いちいち手作業でコンパイルするのもナンセンスですね。<br>
<del>こんなことならリフレクション使ったほうが早いんじゃね。</del></p>

<p>ちなみに、C#プロジェクトを生成しても、対応する<code>AssemblyDefinitionFile</code>が無効化されるとC#ソリューションから外れ、<strong>インテリセンスがご臨の終です</strong>。どうもありがとうございました。<br>
新しくIDEのインスタンス立ててC#プロジェクト読み込めばなんとかなりますが、なんか釈然としません...</p>

<p>なんとか<strong>良い感じに運用</strong>してみましょう。</p>

<h2>
<span id="方法1-アセットの変更に対するコールバックで対処する" class="fragment"></span><a href="#%E6%96%B9%E6%B3%951-%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E5%A4%89%E6%9B%B4%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%81%A7%E5%AF%BE%E5%87%A6%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>【方法1】 アセットの変更に対するコールバックで対処する</h2>

<p>素直に実装すればこうでしょうか。</p>

<ul>
<li>無効化されている<code>AssemblyDefinitionFile</code>から（なんとかして）C#プロジェクトを生成する</li>
<li>
<code>AssetPostprocessor</code>で対象のcsファイルの変更を検知して、ファイルや外部参照、シンボルをコンパイラに引き渡す</li>
<li>
<code>AssetPostprocessor.OnGeneratedSlnSolution</code>メソッドでソリューションファイルの変更を検知し、C#プロジェクトが除外されないように対応する</li>
</ul>

<p>運用するだけであればこの方法で十分そうですが、問題もあります。</p>

<ul>
<li>無効化された<code>AssemblyDefinitionFile</code>が放置されているの</li>
<li>外部参照解決がプラットフォーム的に正しいか確認が必要

<ul>
<li>Unityのバージョンアップで参照が増えたりするので対応が必要</li>
</ul>
</li>
</ul>

<p>さらっと流しましたが<code>OnGeneratedSlnSolution</code>は<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/master/Editor/Mono/AssetPostprocessor.cs#L140" rel="nofollow noopener" target="_blank">文書化されていないメソッド</a>です。<br>
その他、以下のようにソリューションやプロジェクト生成時コールバックが用意されています。<br>
これらは<strong>staticメソッドである</strong>ことに注意してください。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">CSharpProjectSolutions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">CustomAssetPostprocessor</span> <span class="p">:</span> <span class="n">AssetPostprocessor</span>
    <span class="p">{</span>
        <span class="c1">// Unity標準のジェネレータ「以外」でC#プロジェクトを生成するかどうか返すコールバック(UnityVS等で利用).</span>
        <span class="k">static</span> <span class="kt">bool</span> <span class="nf">OnPreGeneratingCSProjectFiles</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">LogFormat</span><span class="p">(</span><span class="s">"&lt;color=cyan&gt;OnPreGeneratingCSProjectFiles&lt;/color&gt;"</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// C#プロジェクトファイルが生成された後に、修正を適用するコールバック.</span>
        <span class="k">static</span> <span class="kt">string</span> <span class="nf">OnGeneratedCSProject</span><span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">,</span> <span class="kt">string</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">LogFormat</span><span class="p">(</span><span class="s">"&lt;color=blue&gt;OnGeneratedCSProject:&lt;/color&gt; {0}\n\n{1}"</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">content</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// C#ソリューションファイルが生成された後に、修正を適用するコールバック.</span>
        <span class="k">static</span> <span class="kt">string</span> <span class="nf">OnGeneratedSlnSolution</span><span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">,</span> <span class="kt">string</span> <span class="n">content</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">LogFormat</span><span class="p">(</span><span class="s">"&lt;color=orange&gt;OnGeneratedSlnSolution:&lt;/color&gt; {0}\n\n{1}"</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">content</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// VisualStudioのバージョンアップによってcsprojがUnityと互換性が無くなったときの「セーフガード」.</span>
        <span class="c1">// 後処理でcsprojを修正、または作り直す. 願わくば、これが必要になりませんように.</span>
        <span class="c1">// ...とソースコードに書いてあった(意訳)</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">OnGeneratedCSProjectFiles</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"&lt;color=red&gt;OnGeneratedCSProjectFiles:&lt;/color&gt;"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="方法2-自作コンパイラをビルドパイプラインに組み込む" class="fragment"></span><a href="#%E6%96%B9%E6%B3%952-%E8%87%AA%E4%BD%9C%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AB%E7%B5%84%E3%81%BF%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>【方法2】 自作コンパイラをビルドパイプラインに組み込む</h2>

<p>そもそも、こんなに手間が掛かるのは、コンパイラへの入力としてC#プロジェクトファイルを使っているからです。<br>
では、UnityにおいてC#プロジェクトファイルってビルドに必要なんでしょうか？<strong>答えはノーです</strong>。</p>

<p>プロジェクトディレクトリ内から<strong>ソリューションファイルやプロジェクトファイルを全て削除したとしても、コンパイルは元気に走ります</strong>。<br>
コンパイラへの入力は、実際には何が使われているんでしょうか？</p>

<p>以下、Unityにおけるコンパイルのに関する話になりますが、長くなりますので<strong>興味ない方は「<a href="#%E3%82%81%E3%82%93%E3%81%A9%E3%81%8F%E3%81%95%E3%81%84%E3%81%AE%E3%81%A7%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E4%BD%BF%E3%81%86%E3%83%87%E3%83%A2">めんどくさいのでパッケージを使う</a>」まで読み飛ばし推奨</strong>。</p>

<hr>

<h3>
<span id="unity組み込みコンパイラの仕組み" class="fragment"></span><a href="#unity%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF"><i class="fa fa-link"></i></a>Unity組み込みコンパイラの仕組み</h3>

<p>UnityのC#コンパイラは<code>csc</code>で、<code>unity_csc.bat</code>または<code>unity_csc.sh</code>としてプラットフォームごとのスクリプトにラップされています。<br>
実際のところ、この辺の処理はUnityのバージョンによって異なりますが詳しくは割愛。<br>
Unity 2019.3では、<code>unity_csc.*</code>に関する記述は<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/Compilers/MicrosoftCSharpCompiler.cs#L120" rel="nofollow noopener" target="_blank">MicrosoftCSharpCompiler.StartCompiler</a>にあります。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">protected</span> <span class="k">override</span> <span class="n">Program</span> <span class="nf">StartCompiler</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// プラットフォームに合ったコンパイラ（unity_csc）を探す</span>
    <span class="kt">var</span> <span class="n">csc</span> <span class="p">=</span> <span class="n">Paths</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">EditorApplication</span><span class="p">.</span><span class="n">applicationContentsPath</span><span class="p">,</span> <span class="s">"Tools"</span><span class="p">,</span> <span class="s">"RoslynScripts"</span><span class="p">,</span> <span class="s">"unity_csc"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="n">platform</span> <span class="p">==</span> <span class="n">RuntimePlatform</span><span class="p">.</span><span class="n">WindowsEditor</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">csc</span> <span class="p">+=</span> <span class="s">".bat"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">csc</span> <span class="p">+=</span> <span class="s">".sh"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">csc</span> <span class="p">=</span> <span class="n">Paths</span><span class="p">.</span><span class="nf">UnifyDirectorySeparator</span><span class="p">(</span><span class="n">csc</span><span class="p">);</span>

    <span class="c1">// コンパイラが見つからなかったら例外</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">csc</span><span class="p">))</span>
        <span class="nf">ThrowCompilerNotFoundException</span><span class="p">(</span><span class="n">csc</span><span class="p">);</span>

    <span class="c1">// responseファイルを生成する</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">assembly</span><span class="p">.</span><span class="n">GeneratedResponseFile</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">assembly</span><span class="p">.</span><span class="n">GeneratedResponseFile</span> <span class="p">=</span> <span class="nf">GenerateResponseFile</span><span class="p">(</span><span class="n">assembly</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">tempOutputDirectory</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ProcessStartInfoを生成し、新しいコンパイルプロセスを開始</span>
    <span class="kt">var</span> <span class="n">psi</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ProcessStartInfo</span><span class="p">()</span> <span class="p">{</span> <span class="n">Arguments</span> <span class="p">=</span> <span class="s">"/noconfig @"</span> <span class="p">+</span> <span class="n">assembly</span><span class="p">.</span><span class="n">GeneratedResponseFile</span><span class="p">,</span> <span class="n">FileName</span> <span class="p">=</span> <span class="n">csc</span><span class="p">,</span> <span class="n">CreateNoWindow</span> <span class="p">=</span> <span class="k">true</span> <span class="p">};</span>
    <span class="kt">var</span> <span class="n">program</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Program</span><span class="p">(</span><span class="n">psi</span><span class="p">);</span>
    <span class="n">program</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">program</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>自作コンパイラをビルドパイプラインに載せるには、この部分がハックできれば良さそうです。<br>
どうやってハックできるのか確認していきましょう。</p>

<p>まず、<code>MicrosoftCSharpCompiler</code>は<code>CSharpLanguage.CreateCompiler</code>メソッドから<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/Compilers/CSharpLanguage.cs#L39" rel="nofollow noopener" target="_blank">参照されています</a>。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">override</span> <span class="n">ScriptCompilerBase</span> <span class="nf">CreateCompiler</span><span class="p">(</span><span class="n">ScriptAssembly</span> <span class="n">scriptAssembly</span><span class="p">,</span> <span class="n">EditorScriptCompilationOptions</span> <span class="n">options</span><span class="p">,</span> <span class="kt">string</span> <span class="n">tempOutputDirectory</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">MicrosoftCSharpCompiler</span><span class="p">(</span><span class="n">scriptAssembly</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">tempOutputDirectory</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>そして、<code>CSharpLanguage</code>は<code>ScriptCompilers</code>のコンストラクタから<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/ScriptCompilers.cs#L79" rel="nofollow noopener" target="_blank">参照されています</a>。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="nf">ScriptCompilers</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">SupportedLanguages</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SupportedLanguage</span><span class="p">&gt;();</span>

    <span class="kt">var</span> <span class="n">types</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;();</span>
    <span class="n">types</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CSharpLanguage</span><span class="p">));</span>

    <span class="c1">// typesにはCSharpLanguageしか入っていないので、以下と同じ</span>
    <span class="c1">// SupportedLanguages.Add(new CSharpLanguage());</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">t</span> <span class="k">in</span> <span class="n">types</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">SupportedLanguages</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="n">SupportedLanguage</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="nf">CreateInstance</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// SupportedLanguagesにはCSharpLanguageしか入っていないので以下略</span>
    <span class="n">CSharpSupportedLanguage</span> <span class="p">=</span> <span class="n">SupportedLanguages</span><span class="p">.</span><span class="nf">Single</span><span class="p">(</span><span class="n">l</span> <span class="p">=&gt;</span> <span class="n">l</span><span class="p">.</span><span class="nf">GetType</span><span class="p">()</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CSharpLanguage</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>staticコンストラクタに行き着きました。<br>
<code>CSharpSupportedLanguage</code>がこのタイミングで生成されていることがわかりますね。<br>
<code>SupportedLanguage</code>がリストとして受けられるようになっているのは、C#以外の言語(懐かしのUnityScript、Boo)に対応していた名残でしょう。</p>

<p>ここから先の参照は本題とズレるので省きますが、この<strong><code>CSharpSupportedLanguage</code>をどうにかして書き換えることができれば良さそうです</strong>。</p>

<h3>
<span id="自作コンパイルを使ってコンパイルする" class="fragment"></span><a href="#%E8%87%AA%E4%BD%9C%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>自作コンパイルを使ってコンパイルする</h3>

<p><code>IncrementalCompiler</code>というパッケージを使ったことはありますか？<br>
「ビルド時間が大幅に短縮できる」「C#7.2の機能が使える」という、Unity 2018.1〜2018.2向けの非常に強力なエディタ拡張パッケージで、実はUnity 2018.3以降では<a href="https://forum.unity.com/threads/unity-incremental-c-compiler-deprecated.523993/" rel="nofollow noopener" target="_blank">類似機能がビルトインされています</a>。</p>

<p><strong>「自作コンパイラをビルドパイプラインに載せる」</strong>という意味では、<code>IncrementalCompiler</code>も同じことを行なっているはずです。<br>
試しにパッケージを調べてみると、<strong><code>ScriptCompilers.CSharpSupportedLanguage</code>と<code>ScriptCompilers.SupportedLanguages</code>の上書きがキー</strong>になっているようでした（調べ方については割愛）。</p>

<p>さっそく、それらを上書きしてみましょう。</p>

<hr>

<p>なお、以下のコードは<strong>internalアクセスを多用している</strong>ため、<code>Unity.InternalAPIEditorBridgeDev.001</code>等<code>UnityEditor</code>に<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/master/Editor/Mono/AssemblyInfo/AssemblyInfo.cs" rel="nofollow noopener" target="_blank">internalアクセスが許可されているアセンブリ名</a>を持つ<code>AssemblyDefinitionFile</code>が必要です。</p>

<p>まずはエントリポイントからです。<br>
<code>InitializeOnLoad</code>属性を使って、ロード時に自動的に実行されるようにしましょう。<br>
ここでは<code>ScriptCompilers</code>のフィールドを書き換えるコードを用意します。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="n">InitializeOnLoad</span><span class="p">]</span>
<span class="k">internal</span> <span class="k">class</span> <span class="nc">CustomCSharpInstaller</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="nf">CustomCSharpInstaller</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">customLanguage</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CustomCSharpLanguage</span><span class="p">();</span>

        <span class="c1">// SupportedLanguagesにカスタムC#を追加.</span>
        <span class="n">ScriptCompilers</span><span class="p">.</span><span class="n">SupportedLanguages</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">GetType</span><span class="p">()</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CustomCSharpLanguage</span><span class="p">));</span>
        <span class="n">ScriptCompilers</span><span class="p">.</span><span class="n">SupportedLanguages</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">customLanguage</span><span class="p">);</span>

        <span class="c1">// CSharpSupportedLanguageはreadonlyなのでリフレクションで上書き.</span>
        <span class="k">typeof</span><span class="p">(</span><span class="n">ScriptCompilers</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">GetField</span><span class="p">(</span><span class="s">"CSharpSupportedLanguage"</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Static</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">customLanguage</span><span class="p">);</span>

        <span class="c1">// こちらも上書き.</span>
        <span class="n">EditorBuildRules</span><span class="p">.</span><span class="nf">GetPredefinedTargetAssemblies</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">x</span><span class="p">.</span><span class="n">Language</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">First</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Language</span><span class="p">.</span><span class="nf">GetType</span><span class="p">()</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">CSharpLanguage</span><span class="p">))</span>
            <span class="p">.</span><span class="n">Language</span> <span class="p">=</span> <span class="n">customLanguage</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これにより、C#のコンパイル時に、<code>CSharpLanguage</code>の代わりに<code>CustomCSharpLanguage</code>が選択されるようになりました。</p>

<hr>

<p>次に、<code>CustomCSharpLanguage</code>を実装していきますが、こちらは<code>CSharpLanguage</code>(<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/Compilers/CSharpLanguage.cs" rel="nofollow noopener" target="_blank">ソース</a>)を継承すれば最小限のコードで済みます。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">internal</span> <span class="k">class</span> <span class="nc">CustomCSharpLanguage</span> <span class="p">:</span> <span class="n">CSharpLanguage</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="n">ScriptCompilerBase</span> <span class="nf">CreateCompiler</span><span class="p">(</span><span class="n">ScriptAssembly</span> <span class="n">scriptAssembly</span><span class="p">,</span> <span class="n">MonoIsland</span> <span class="n">island</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">buildingForEditor</span><span class="p">,</span> <span class="n">BuildTarget</span> <span class="n">targetPlatform</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">runUpdater</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// カスタムコンパイラを使うかどうかのフラグ.</span>
        <span class="c1">// ScriptAssemblyやMonoIslandにはファイル一覧、参照一覧、シンボル一覧、出力ファイル名などの情報が格納されている.</span>
        <span class="c1">// それに応じて必要なアセンブリのみコンパイラを切り替えることが可能。</span>
        <span class="kt">bool</span> <span class="n">useCustomCompiler</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">useCustomCompiler</span><span class="p">)</span>
            <span class="c1">// カスタムコンパイラを使う.</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">CustomCSharpCompiler</span><span class="p">(</span><span class="n">island</span><span class="p">,</span> <span class="n">runUpdater</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="c1">// 使わない場合はデフォルトのコンパイラを使う.</span>
            <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="nf">CreateCompiler</span><span class="p">(</span><span class="n">scriptAssembly</span><span class="p">,</span> <span class="n">island</span><span class="p">,</span> <span class="n">buildingForEditor</span><span class="p">,</span> <span class="n">targetPlatform</span><span class="p">,</span> <span class="n">runUpdater</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>このように、<code>CSharpLanguage</code>は<strong>動的にコンパイラクラスのインスタンスを返せます</strong>。<br>
Unity2019.2までは、<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/2019.2/Editor/Mono/Scripting/Compilers/CSharpLanguage.cs#L49" rel="nofollow noopener" target="_blank">この部分でmsc/cscの切り替えを行なっていました</a>。<br>
なお、Unity2019.3からはcsc(<code>MicrosoftCSharpCompiler</code>)のみです。</p>

<hr>

<p>最後に、コンパイラクラスを作成しましょう。<br>
このクラスは<strong>response file(コンパイルオプションを記述したファイル)を生成</strong>し、それを入力として<strong>コンパイラプロセスを起動</strong>することが責務です。<br>
<code>MicrosoftCSharpCompiler</code>(<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/ScriptCompilers.cs" rel="nofollow noopener" target="_blank">ソース</a>)を継承すればこちらも簡単です。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">internal</span> <span class="k">class</span> <span class="nc">CustomCSharpCompiler</span> <span class="p">:</span> <span class="n">MicrosoftCSharpCompiler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">CustomCSharpCompiler</span><span class="p">(</span><span class="n">MonoIsland</span> <span class="n">island</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">runUpdater</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">island</span><span class="p">,</span> <span class="n">runUpdater</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="n">Program</span> <span class="nf">StartCompiler</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 継承元のコンパイルプロセスは即終了させる.</span>
        <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="nf">StartCompiler</span><span class="p">();</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">Kill</span><span class="p">();</span>

        <span class="c1">// 最後に生成されたresponse fileを取得する.</span>
        <span class="c1">// 複数のファイルが生成される場合があるので、outオプションで判定する.</span>
        <span class="kt">var</span> <span class="n">outopt</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"/out:\"{0}\""</span><span class="p">,</span> <span class="n">m_Island</span><span class="p">.</span><span class="n">_output</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">responsefile</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">GetFiles</span><span class="p">(</span><span class="s">"Temp"</span><span class="p">,</span> <span class="s">"UnityTempFile*"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">OrderByDescending</span><span class="p">(</span><span class="n">f</span> <span class="p">=&gt;</span> <span class="n">File</span><span class="p">.</span><span class="nf">GetLastWriteTime</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">First</span><span class="p">(</span><span class="n">path</span> <span class="p">=&gt;</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllLines</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="nf">Any</span><span class="p">(</span><span class="n">line</span> <span class="p">=&gt;</span> <span class="n">line</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">outopt</span><span class="p">)));</span>

        <span class="c1">// 　自作のコンパイラでresponse fileを処理する.</span>
        <span class="kt">var</span> <span class="n">psi</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ProcessStartInfo</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Arguments</span> <span class="p">=</span> <span class="p">...,</span>
            <span class="n">FileName</span> <span class="p">=</span> <span class="p">...,</span>
            <span class="n">CreateNoWindow</span> <span class="p">=</span> <span class="k">true</span>
        <span class="p">};</span>

        <span class="c1">// プロセスを開始する.</span>
        <span class="kt">var</span> <span class="n">program</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Program</span><span class="p">(</span><span class="n">psi</span><span class="p">);</span>
        <span class="n">program</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">program</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>継承元(<code>MicrosoftCSharpCompiler</code>)でcscを使ったコンパイルプロセスを作っているので、継承元のものは終了させましょう。</p>

<hr>

<p>response fileは、継承元のコンパイラクラスで作成され、<code>Temp</code>フォルダに保存されるので、最新のものをピックアップしましょう。<br>
response fileの生成は継承元のコンパイラクラスに任せましょう、簡単に外部参照やシンボル等の整合性が取れます。<br>
ちなみに、responsefileの中身はこんな感じです。<br>
C#プロジェクトの内容をコンパイルオプションに置き換えたようなイメージですね。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>/target:library
/nowarn:0169
/out:"Temp/*********.dll"
/debug:portable
/optimize-
/nostdlib+
/preferreduilang:en-US
/langversion:latest
/reference:"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.dll"
/reference:"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.AIModule.dll"
/reference:"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.ARModule.dll"
/reference:"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.AccessibilityModule.dll"
/reference:"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.AnimationModule.dll"
/reference:"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.AssetBundleModule.dll"
...以下、シンボル定義とcsファイルの一覧
</code></pre></div></div>

<p>余談ですが、なんでわざわざresponse fileを作る必要があるんでしょうか？<br>
正解は<strong>Process.Startで引数が長すぎて死ぬから</strong>です。<br>
あと、<strong>文字列がダブルクォーテーションで囲まれてる</strong>のも注意が必要です。<br>
<del>私はどちらの罠も踏み抜きました。</del></p>

<p><br></p>

<p>長くなりましたが、これがUnity上で自作C#コンパイラを動かすための<strong>雛形となるコード</strong>です。<br>
このコードを好きなように改造し、<strong>dllにコンパイルしてインポート</strong>することで、csファイルのコンパイルが始まる前に自作C#コンパイラをビルドパイプラインに載せられます。</p>

<p><a href="https://qiita.com/mob-sakai/items/f3bbc0c45abc31ea7ac0#ignoresaccesscheckstoattribute%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6internal%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B" id="reference-a3c1b4630e94d4b63d31">前回</a>の<code>IgnoresAccessChecksTo</code>の下準備よりもめんどくさいですね。</p>

<h3>
<span id="めんどくさいのでパッケージを使うデモ" class="fragment"></span><a href="#%E3%82%81%E3%82%93%E3%81%A9%E3%81%8F%E3%81%95%E3%81%84%E3%81%AE%E3%81%A7%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E4%BD%BF%E3%81%86%E3%83%87%E3%83%A2"><i class="fa fa-link"></i></a>めんどくさいのでパッケージを使う＆デモ</h3>

<p>今回は、先述のコンパイラを同梱済みの<a href="https://github.com/mob-sakai/OpenSesameCompilerForUnity" rel="nofollow noopener" target="_blank">Unity向けに公開しているパッケージ</a>をデモとして使います。<br>
<a href="https://github.com/mob-sakai/OpenSesameCompilerForUnity/archive/demo.zip" rel="nofollow noopener" target="_blank">こちら</a>からデモプロジェクト一式をダウンロードできます。</p>

<ol>
<li>動作にはdotnet 3.0以上が必要です

<ul>
<li>コマンドプロンプト(Windows)やターミナル(Mac)で、<code>dotnet --version</code>を実行したときに、<code>3.0.x</code>以上が表示されていればインストール不要です</li>
<li>
<a href="https://dotnet.microsoft.com/download" class="autolink" rel="nofollow noopener" target="_blank">https://dotnet.microsoft.com/download</a> からインストールしてください</li>
</ul>
</li>
<li>UnityプロジェクトをUnityエディタで開きます</li>
<li>
<code>Coffee.OpenSesame.Test.cs</code>がアクセシビリティに関するコンパイルエラー(CS0122)を吐いてますね。<strong>安心してください、privateアクセスしているだけです。あなたのUnityは正常ですよ。</strong><br>
</li>
<li><a href="https://camo.qiitausercontent.com/ca7b1e95622822d480b09731a06f396eb09be31d/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383732352d66643738623730302d323738322d313165612d383332332d3032616333356232336339652e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448725-fd78b700-2782-11ea-8323-02ac35b23c9e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3949bf905c67595020cb9906cb064953" alt="" data-canonical-src="https://user-images.githubusercontent.com/12690315/71448725-fd78b700-2782-11ea-8323-02ac35b23c9e.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448725-fd78b700-2782-11ea-8323-02ac35b23c9e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5c630deec3c287616c03213abcf7eb50 1x" loading="lazy"></a></li>
<li>プロジェクトビューで<code>Tests/Coffee.OpenSesame.Test.asmdef</code>を選択し、コンテキストメニュー(右クリック)から<code>OpenSesame Compiler &gt; Setting</code>をクリックし、開いたウィンドウで以下のように入力します<br>
<a href="https://camo.qiitausercontent.com/c121c7cc22391e1fccc8d02d7a6fb7207c4efc9e/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383439322d63633461623738302d323737662d313165612d396336352d3534353661313265356365312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448492-cc4ab780-277f-11ea-9c65-5456a12e5ce1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=dfbf34e0334cfb8515b2de350f757a6a" alt="" data-canonical-src="https://user-images.githubusercontent.com/12690315/71448492-cc4ab780-277f-11ea-9c65-5456a12e5ce1.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448492-cc4ab780-277f-11ea-9c65-5456a12e5ce1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=717cd4cdea3d3e453ccecabdad4af7b8 1x" loading="lazy"></a>

<ul>
<li>Open Sesame Compiler: <strong>チェックを入れる</strong>
</li>
<li>Publish Folder:  <strong>Assets/Editor</strong> (初期値)</li>
</ul>
</li>
<li>
<code>Save</code>を押すと、内容が保存されて、コンパイルが実行されます。そのまましばらく待つと...コンパイルエラーが消えました！<img alt=":tada:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png" title=":tada:" width="20" loading="lazy"><br>
<a href="https://camo.qiitausercontent.com/bb202a19098965ab0ee4bf50db5003ff4ef22fc3/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383835392d36393563316630302d323738352d313165612d383336322d6237316232336630356330382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448859-695c1f00-2785-11ea-8362-b71b23f05c08.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=621ebb4f78468358671242ef2df8d5ca" alt="" data-canonical-src="https://user-images.githubusercontent.com/12690315/71448859-695c1f00-2785-11ea-8362-b71b23f05c08.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448859-695c1f00-2785-11ea-8362-b71b23f05c08.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b25825709969c954217569ac152d7508 1x" loading="lazy"></a>
</li>
<li>ツールバーの<code>Window &gt; General &gt; Test Runner</code>を選択し、テストランナーウィンドウを開き、 <code>Run All</code>を押すと...privateアクセステストが通りました！<br>
<a href="https://camo.qiitausercontent.com/2ee27a8009e70bbd72d46df416d6fc3891ba1bc6/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383839302d65363837393430302d323738352d313165612d386535352d3033336635356137366236382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448890-e6879400-2785-11ea-8e55-033f55a76b68.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8851fccc27d390e331a987ee214eac96" alt="" data-canonical-src="https://user-images.githubusercontent.com/12690315/71448890-e6879400-2785-11ea-8e55-033f55a76b68.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448890-e6879400-2785-11ea-8e55-033f55a76b68.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d888ef6b57ba5a4c3f39e9a677eed3b4 1x" loading="lazy"></a>
</li>
<li>この後は<code>Tests/Coffee.OpenSesame.Test.cs</code>にinternal/privateアクセスを追加しても、コンパイルエラーが吐かれませんよ！</li>
<li>次に、プロジェクトビューで<code>Tests/Coffee.OpenSesame.Test.asmdef</code>を選択し、コンテキストメニュー(右クリック)から<code>OpenSesame Compiler &gt; Publish</code>を選択しましょう。</li>
<li>dllファイルが生成されました。このdllは、<strong>もはやコンパイラの手を借りることなくinternal/privateアクセスが可能な存在です</strong>。<br>
<a href="https://camo.qiitausercontent.com/a2bdb52126e2575b2974e34c50ab13980e1f0cd0/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383934302d31313236316338302d323738372d313165612d386365382d6462373634376637313961322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448940-11261c80-2787-11ea-8ce8-db7647f719a2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=04ffc1e3ead5a558d201df783da2d4c8" alt="" data-canonical-src="https://user-images.githubusercontent.com/12690315/71448940-11261c80-2787-11ea-8ce8-db7647f719a2.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448940-11261c80-2787-11ea-8ce8-db7647f719a2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b35ea873dd2526ec22307ef882f92545 1x" loading="lazy"></a>
</li>
<li>このように、ポータブルなdllファイルを生成することで、<strong>dllをインターフェースとしたinternal/privateアクセスが実現できます</strong>。もちろん、別プロジェクトでも利用できますし、パッケージとして配布することも可能です。</li>
</ol>

<h4>
<span id="このパッケージcomcoffeeopen-sesame-compilerのアピールポイント" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8comcoffeeopen-sesame-compiler%E3%81%AE%E3%82%A2%E3%83%94%E3%83%BC%E3%83%AB%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>このパッケージ(com.coffee.open-sesame-compiler)のアピールポイント</h4>

<ul>
<li>
<strong>ワークフローを変化させずに、internalアクセスもprivateアクセスもできちゃう</strong>

<ul>
<li>C#宇宙の　法則が　乱れる！</li>
<li>インストールするだけで使え、覚えるべきことが少ない</li>
</ul>
</li>
<li>
<strong>必要最低限のアセンブリだけを自作コンパイルで処理できる</strong>

<ul>
<li>↑の設定画面で<code>Open Sesame Compiler</code>にチェックを入れたアセンブリのみ処理できる</li>
<li>それ以外はデフォルトのコンパイラで処理するので、影響範囲が小さい</li>
</ul>
</li>
<li>
<code>AssemblyDefinitionFile</code>を無効化しなくていい

<ul>
<li>internal/privateな要素を使っていても、コンパイルエラーにならない</li>
<li>間違った使い方によるエラーは報告してくれるので安心</li>
</ul>
</li>
<li>Publish機能を使えば、ポータブルなdllとしてエクスポートできる

<ul>
<li>配布する際にコンパイル部分の依存が不要になる</li>
</ul>
</li>
<li><strong>C#8が使える</strong></li>
<li>.Net 3.5でも.Net 4.xでも動く</li>
</ul>

<h2>
<span id="気になるところ" class="fragment"></span><a href="#%E6%B0%97%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%A8%E3%81%93%E3%82%8D"><i class="fa fa-link"></i></a>気になるところ</h2>

<p>機能検証に時間を取りすぎた結果、テストにあまり時間が取れませんでした...<br>
「とりあえず、こういうことができる」事が分かったという段階ですね。今後に期待してください。</p>

<ul>
<li>
<strong><code>IgnoresAccessChecksToAttribute</code>によるinternal/privateアクセスでできないことは？</strong>

<ul>
<li>internal/privateクラス・インターフェースの継承

<ul>
<li>internalクラス・インターフェースの継承は<code>InternalsVisibleTo</code>を併用することで可能</li>
</ul>
</li>
<li>privateクラスに対する拡張メソッド

<ul>
<li>拡張メソッドの仕様上仕方ない気がするけど</li>
</ul>
</li>
<li>たぶん、まだあると思うので見つけたらコメントください！</li>
</ul>
</li>
<li>
<strong>ランタイムでも動くの？</strong>

<ul>
<li>未確認です...</li>
</ul>
</li>
<li>
<strong>IL2CPP対応してる？</strong>

<ul>
<li>未確認です...</li>
</ul>
</li>
<li>
<strong>ブレークポイントは？</strong>

<ul>
<li>未確認です...</li>
</ul>
</li>
<li>
<strong>サポートしてるバージョンは？</strong>

<ul>
<li>Unity 2018.3〜2019.2までは確認しました（Mac）</li>
<li>Unity 2019.3と2020.1で大幅に変更があったようなので、今後対応します</li>
</ul>
</li>
<li>
<strong>なんかエラー出るんだけど？</strong>

<ul>
<li>エディタを一度閉じた後、<code>Library/ScriptAssemblies</code>を削除して再起動してください</li>
</ul>
</li>
<li>
<strong>IDEだとprivate要素にエラー出たまんまなんだけど？</strong>

<ul>
<li><del>それはいわゆる、コラテラルダメージというものに過ぎない。目的の為の、致し方ない犠牲だ。</del></li>
</ul>
</li>
</ul>

<h2>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h2>

<p>internal/privateアクセスが手軽にできるようになりました。<br>
正直、リフレクション憎しのエネルギーで<strong>結構ヤバいものを生み出してしまった感</strong>があります。<br>
くれぐれも　じこせきにんで　おねがいします。</p>

<p>そして、この記事を書いている間に<strong>「あれ？<code>UnityEditor.Modules.ICompilationExtension</code>使ったらもっと簡単にイケるんじゃね？」</strong>と気づきました。<br>
<del>そういうことに気を取られるから遅筆なんだぞ！</del><br>
後でその検証もやります。<br>
【追記】ダメでした。</p>

<p>この場を借りて、様々な情報をご提供頂きました<a href="/pCYSl5EDgo" class="user-mention js-hovercard" title="pCYSl5EDgo" data-hovercard-target-type="user" data-hovercard-target-name="pCYSl5EDgo">@pCYSl5EDgo</a>さんにお礼を申し上げますm(_ _)m</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fmob-sakai%2Fitems%2Fa24780d68a6133be338f&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fmob-sakai%2Fitems%2Fa24780d68a6133be338f&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mob-sakai/items/a24780d68a6133be338f/likers" class="css-1iupg5d">24</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">15</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/a24780d68a6133be338f/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mob-sakai/items/a24780d68a6133be338f/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mob-sakai/items/a24780d68a6133be338f/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mob-sakai/items/a24780d68a6133be338f/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mob-sakai/items/a24780d68a6133be338f.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-4bc15d6a-1bdd-416d-bf83-b0c31b1aa0ec">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-3f6c9acb-1412-4507-ad53-5ec89f9b1760"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-3f6c9acb-1412-4507-ad53-5ec89f9b1760">{}</script>
      
<div id="LoginModal-react-component-db51845d-7918-4a5f-aa27-64ab8e7bc4fb"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-db51845d-7918-4a5f-aa27-64ab8e7bc4fb">{}</script>
      
<div id="StockModal-react-component-93fd22d9-9438-437c-8c0e-8934b52491bc"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-93fd22d9-9438-437c-8c0e-8934b52491bc">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;8gmU/QaJyKXOVbj3rXgFKNlcRDD61nxr1SOzGXEb1wwyKJsUBucW6FsnNFuqblhEZtrTiXUdYFz0ig0scmYwjA==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003eこの記事は\u003ca href=\"https://qiita.com/advent-calendar/2019/unityforpro2\"\u003e【unityプロ技②】 Advent Calendar 2019\u003c/a\u003eの25日目の記事です。\u003cbr\u003e\nこの記事は\u003ca href=\"https://qiita.com/mob-sakai/items/f3bbc0c45abc31ea7ac0\" id=\"reference-a3c1b4630e94d4b63d31\"\u003e【Unity, C#】internalな型やメンバにアクセスするには、多分これが一番早いと思います\u003c/a\u003eの続編です。先にこちらをご覧ください。\u003cbr\u003e\nこの記事におけるソースコードは、全て\u003ccode\u003ePublic Domain\u003c/code\u003eです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"tldr\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#tldr\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTL;DR\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eC#の属性\u003ccode\u003eIgnoresAccessChecksToAttribute\u003c/code\u003eは実は\u003cstrong\u003e任意の外部アセンブリのinternal/privateメンバに対して自由にアクセスできるヤバいやつ\u003c/strong\u003eだったよ。C#宇宙の　法則が　乱れる！\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e自作のRoslynコンパイラをビルドパイプラインに乗っける\u003c/strong\u003eことで、ワークフローを意識することなく運用できるよ。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eC#8の機能を使うことができる\u003c/strong\u003eよ。\u003c/li\u003e\n\u003cli\u003eくれぐれも　じこせきにんで　おねがいします。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ignoresaccesscheckstoattributeおさらい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ignoresaccesscheckstoattribute%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eIgnoresAccessChecksToAttribute\u003c/code\u003eおさらい\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/mob-sakai/items/f3bbc0c45abc31ea7ac0\"\u003e前回\u003c/a\u003e、こんな風に述べてました。\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003eInternalsVisibleToAttributeとは逆の方向に作用する。つまり、ライブラリ利用者側に設定することで、ライブラリに対するinternalアクセスを許可する\u003c/li\u003e\n\u003cli\u003eフルネームはSystem.Runtime.CompilerServices.IgnoresAccessChecksToAttribute\u003c/li\u003e\n\u003cli\u003eBase Class Libraryに載っていないが、ランタイム（CLR/CoreCLR）で作用する\u003c/li\u003e\n\u003cli\u003ecsc.exeやMsBuildを使わずに自力でコンパイルする際に、CSharpCompilationOptions.TopLevelBinderFlagsに対して特定のフラグを立てると有効になる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eところが、その後の調査により、\u003cstrong\u003eprivateな型やメンバ\u003c/strong\u003eに対してもアクセスができることが判明しました。\u003c/p\u003e\n\n\u003cp\u003eちなみに、\u003cstrong\u003e\u003ca href=\"https://www.strathweb.com/2018/10/no-internalvisibleto-no-problem-bypassing-c-visibility-rules-with-roslyn/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e元記事\u003c/a\u003eにもキッチリ書いてありました\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eIn other words, how to get access to internal and private members without needing to use reflection or something like InternalsVisibleToAttribute.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eうっかりが過ぎる。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"privateな型やメンバにアクセスするモチベーション\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#private%E3%81%AA%E5%9E%8B%E3%82%84%E3%83%A1%E3%83%B3%E3%83%90%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eprivateな型やメンバにアクセスするモチベーション\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/mob-sakai/items/f3bbc0c45abc31ea7ac0#internal%E3%81%AA%E5%9E%8B%E3%82%84%E3%83%A1%E3%83%B3%E3%83%90%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\" id=\"reference-a3c1b4630e94d4b63d31\"\u003einternalな型やメンバにアクセスするモチベーション\u003c/a\u003eと同じです。\u003cbr\u003e\ninternal要素以上に、privateアクセス修飾子によって隠蔽されているメンバは多く、その中には有用なものもあります。\u003c/p\u003e\n\n\u003cp\u003eまた、例えば拡張メソッドを実装する場面において、\u003cstrong\u003eそのクラスのprivateメンバを扱うことができる\u003c/strong\u003eと考えるとどうでしょうか。\u003cbr\u003e\nパフォーマンス/機能面で強力なハックを提供できるかもしれません。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実際やろうとすると手順が面倒なことに気づく\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E9%9A%9B%E3%82%84%E3%82%8D%E3%81%86%E3%81%A8%E3%81%99%E3%82%8B%E3%81%A8%E6%89%8B%E9%A0%86%E3%81%8C%E9%9D%A2%E5%80%92%E3%81%AA%E3%81%93%E3%81%A8%E3%81%AB%E6%B0%97%E3%81%A5%E3%81%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実際やろうとすると手順が面倒なことに気づく\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/mob-sakai/InternalAccessibleCompilerForUnity\" rel=\"nofollow noopener\" target=\"_blank\"\u003e前回のパッケージ\u003c/a\u003eを使ってprivateアクセスしてみましょう。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eprivateアクセスするコードを書く。IDE上でエラー表示になる(正常)\u003c/li\u003e\n\u003cli\u003eUnity側ではコンパイルエラーになる(正常)\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eAssets/Open C# Project\u003c/code\u003eでC#プロジェクトを生成\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eAssemblyDefinitionFile\u003c/code\u003eを\u003ccode\u003eDefine Constraints\u003c/code\u003eで無効化し、コンパイルエラーを解消\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eAssemblyDefinitionFile\u003c/code\u003eを右クリックし、\u003ccode\u003eInternalAccessibleCompiler/Compile\u003c/code\u003eでコンパイル\u003c/li\u003e\n\u003cli\u003e生成したdllをインポート\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eわーい、\u003cstrong\u003eとっても面倒くさい\u003c/strong\u003e。\u003cbr\u003e\nいちいち手作業でコンパイルするのもナンセンスですね。\u003cbr\u003e\n\u003cdel\u003eこんなことならリフレクション使ったほうが早いんじゃね。\u003c/del\u003e\u003c/p\u003e\n\n\u003cp\u003eちなみに、C#プロジェクトを生成しても、対応する\u003ccode\u003eAssemblyDefinitionFile\u003c/code\u003eが無効化されるとC#ソリューションから外れ、\u003cstrong\u003eインテリセンスがご臨の終です\u003c/strong\u003e。どうもありがとうございました。\u003cbr\u003e\n新しくIDEのインスタンス立ててC#プロジェクト読み込めばなんとかなりますが、なんか釈然としません...\u003c/p\u003e\n\n\u003cp\u003eなんとか\u003cstrong\u003e良い感じに運用\u003c/strong\u003eしてみましょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"方法1-アセットの変更に対するコールバックで対処する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%96%B9%E6%B3%951-%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E5%A4%89%E6%9B%B4%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%81%A7%E5%AF%BE%E5%87%A6%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e【方法1】 アセットの変更に対するコールバックで対処する\u003c/h2\u003e\n\n\u003cp\u003e素直に実装すればこうでしょうか。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e無効化されている\u003ccode\u003eAssemblyDefinitionFile\u003c/code\u003eから（なんとかして）C#プロジェクトを生成する\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eAssetPostprocessor\u003c/code\u003eで対象のcsファイルの変更を検知して、ファイルや外部参照、シンボルをコンパイラに引き渡す\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eAssetPostprocessor.OnGeneratedSlnSolution\u003c/code\u003eメソッドでソリューションファイルの変更を検知し、C#プロジェクトが除外されないように対応する\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e運用するだけであればこの方法で十分そうですが、問題もあります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e無効化された\u003ccode\u003eAssemblyDefinitionFile\u003c/code\u003eが放置されているの\u003c/li\u003e\n\u003cli\u003e外部参照解決がプラットフォーム的に正しいか確認が必要\n\n\u003cul\u003e\n\u003cli\u003eUnityのバージョンアップで参照が増えたりするので対応が必要\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eさらっと流しましたが\u003ccode\u003eOnGeneratedSlnSolution\u003c/code\u003eは\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/master/Editor/Mono/AssetPostprocessor.cs#L140\" rel=\"nofollow noopener\" target=\"_blank\"\u003e文書化されていないメソッド\u003c/a\u003eです。\u003cbr\u003e\nその他、以下のようにソリューションやプロジェクト生成時コールバックが用意されています。\u003cbr\u003e\nこれらは\u003cstrong\u003estaticメソッドである\u003c/strong\u003eことに注意してください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eCSharpProjectSolutions\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomAssetPostprocessor\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eAssetPostprocessor\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// Unity標準のジェネレータ「以外」でC#プロジェクトを生成するかどうか返すコールバック(UnityVS等で利用).\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnPreGeneratingCSProjectFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLogFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u0026lt;color=cyan\u0026gt;OnPreGeneratingCSProjectFiles\u0026lt;/color\u0026gt;\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// C#プロジェクトファイルが生成された後に、修正を適用するコールバック.\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnGeneratedCSProject\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003econtent\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLogFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u0026lt;color=blue\u0026gt;OnGeneratedCSProject:\u0026lt;/color\u0026gt; {0}\\n\\n{1}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econtent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003econtent\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// C#ソリューションファイルが生成された後に、修正を適用するコールバック.\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnGeneratedSlnSolution\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003econtent\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLogFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u0026lt;color=orange\u0026gt;OnGeneratedSlnSolution:\u0026lt;/color\u0026gt; {0}\\n\\n{1}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econtent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003econtent\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// VisualStudioのバージョンアップによってcsprojがUnityと互換性が無くなったときの「セーフガード」.\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 後処理でcsprojを修正、または作り直す. 願わくば、これが必要になりませんように.\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ...とソースコードに書いてあった(意訳)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnGeneratedCSProjectFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u0026lt;color=red\u0026gt;OnGeneratedCSProjectFiles:\u0026lt;/color\u0026gt;\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"方法2-自作コンパイラをビルドパイプラインに組み込む\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%96%B9%E6%B3%952-%E8%87%AA%E4%BD%9C%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AB%E7%B5%84%E3%81%BF%E8%BE%BC%E3%82%80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e【方法2】 自作コンパイラをビルドパイプラインに組み込む\u003c/h2\u003e\n\n\u003cp\u003eそもそも、こんなに手間が掛かるのは、コンパイラへの入力としてC#プロジェクトファイルを使っているからです。\u003cbr\u003e\nでは、UnityにおいてC#プロジェクトファイルってビルドに必要なんでしょうか？\u003cstrong\u003e答えはノーです\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003eプロジェクトディレクトリ内から\u003cstrong\u003eソリューションファイルやプロジェクトファイルを全て削除したとしても、コンパイルは元気に走ります\u003c/strong\u003e。\u003cbr\u003e\nコンパイラへの入力は、実際には何が使われているんでしょうか？\u003c/p\u003e\n\n\u003cp\u003e以下、Unityにおけるコンパイルのに関する話になりますが、長くなりますので\u003cstrong\u003e興味ない方は「\u003ca href=\"#%E3%82%81%E3%82%93%E3%81%A9%E3%81%8F%E3%81%95%E3%81%84%E3%81%AE%E3%81%A7%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E4%BD%BF%E3%81%86%E3%83%87%E3%83%A2\"\u003eめんどくさいのでパッケージを使う\u003c/a\u003e」まで読み飛ばし推奨\u003c/strong\u003e。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"unity組み込みコンパイラの仕組み\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unity%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUnity組み込みコンパイラの仕組み\u003c/h3\u003e\n\n\u003cp\u003eUnityのC#コンパイラは\u003ccode\u003ecsc\u003c/code\u003eで、\u003ccode\u003eunity_csc.bat\u003c/code\u003eまたは\u003ccode\u003eunity_csc.sh\u003c/code\u003eとしてプラットフォームごとのスクリプトにラップされています。\u003cbr\u003e\n実際のところ、この辺の処理はUnityのバージョンによって異なりますが詳しくは割愛。\u003cbr\u003e\nUnity 2019.3では、\u003ccode\u003eunity_csc.*\u003c/code\u003eに関する記述は\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/Compilers/MicrosoftCSharpCompiler.cs#L120\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMicrosoftCSharpCompiler.StartCompiler\u003c/a\u003eにあります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"n\"\u003eProgram\u003c/span\u003e \u003cspan class=\"nf\"\u003eStartCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// プラットフォームに合ったコンパイラ（unity_csc）を探す\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecsc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePaths\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCombine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEditorApplication\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eapplicationContentsPath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Tools\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"RoslynScripts\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"unity_csc\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eApplication\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eplatform\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eRuntimePlatform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWindowsEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecsc\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"s\"\u003e\".bat\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecsc\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"s\"\u003e\".sh\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ecsc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePaths\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnifyDirectorySeparator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecsc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// コンパイラが見つからなかったら例外\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExists\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecsc\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eThrowCompilerNotFoundException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecsc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// responseファイルを生成する\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eassembly\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGeneratedResponseFile\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eassembly\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGeneratedResponseFile\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGenerateResponseFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eassembly\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etempOutputDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// ProcessStartInfoを生成し、新しいコンパイルプロセスを開始\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epsi\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eProcessStartInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eArguments\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"/noconfig @\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eassembly\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGeneratedResponseFile\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecsc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateNoWindow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eprogram\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eProgram\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epsi\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eprogram\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eprogram\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e自作コンパイラをビルドパイプラインに載せるには、この部分がハックできれば良さそうです。\u003cbr\u003e\nどうやってハックできるのか確認していきましょう。\u003c/p\u003e\n\n\u003cp\u003eまず、\u003ccode\u003eMicrosoftCSharpCompiler\u003c/code\u003eは\u003ccode\u003eCSharpLanguage.CreateCompiler\u003c/code\u003eメソッドから\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/Compilers/CSharpLanguage.cs#L39\" rel=\"nofollow noopener\" target=\"_blank\"\u003e参照されています\u003c/a\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"n\"\u003eScriptCompilerBase\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eScriptAssembly\u003c/span\u003e \u003cspan class=\"n\"\u003escriptAssembly\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEditorScriptCompilationOptions\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003etempOutputDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMicrosoftCSharpCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003escriptAssembly\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etempOutputDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eそして、\u003ccode\u003eCSharpLanguage\u003c/code\u003eは\u003ccode\u003eScriptCompilers\u003c/code\u003eのコンストラクタから\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/ScriptCompilers.cs#L79\" rel=\"nofollow noopener\" target=\"_blank\"\u003e参照されています\u003c/a\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"nf\"\u003eScriptCompilers\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eSupportedLanguages\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSupportedLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etypes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCSharpLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// typesにはCSharpLanguageしか入っていないので、以下と同じ\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// SupportedLanguages.Add(new CSharpLanguage());\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003etypes\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSupportedLanguages\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eSupportedLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eActivator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// SupportedLanguagesにはCSharpLanguageしか入っていないので以下略\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCSharpSupportedLanguage\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSupportedLanguages\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSingle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetType\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCSharpLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003estaticコンストラクタに行き着きました。\u003cbr\u003e\n\u003ccode\u003eCSharpSupportedLanguage\u003c/code\u003eがこのタイミングで生成されていることがわかりますね。\u003cbr\u003e\n\u003ccode\u003eSupportedLanguage\u003c/code\u003eがリストとして受けられるようになっているのは、C#以外の言語(懐かしのUnityScript、Boo)に対応していた名残でしょう。\u003c/p\u003e\n\n\u003cp\u003eここから先の参照は本題とズレるので省きますが、この\u003cstrong\u003e\u003ccode\u003eCSharpSupportedLanguage\u003c/code\u003eをどうにかして書き換えることができれば良さそうです\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"自作コンパイルを使ってコンパイルする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%87%AA%E4%BD%9C%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e自作コンパイルを使ってコンパイルする\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003eIncrementalCompiler\u003c/code\u003eというパッケージを使ったことはありますか？\u003cbr\u003e\n「ビルド時間が大幅に短縮できる」「C#7.2の機能が使える」という、Unity 2018.1〜2018.2向けの非常に強力なエディタ拡張パッケージで、実はUnity 2018.3以降では\u003ca href=\"https://forum.unity.com/threads/unity-incremental-c-compiler-deprecated.523993/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e類似機能がビルトインされています\u003c/a\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e「自作コンパイラをビルドパイプラインに載せる」\u003c/strong\u003eという意味では、\u003ccode\u003eIncrementalCompiler\u003c/code\u003eも同じことを行なっているはずです。\u003cbr\u003e\n試しにパッケージを調べてみると、\u003cstrong\u003e\u003ccode\u003eScriptCompilers.CSharpSupportedLanguage\u003c/code\u003eと\u003ccode\u003eScriptCompilers.SupportedLanguages\u003c/code\u003eの上書きがキー\u003c/strong\u003eになっているようでした（調べ方については割愛）。\u003c/p\u003e\n\n\u003cp\u003eさっそく、それらを上書きしてみましょう。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003eなお、以下のコードは\u003cstrong\u003einternalアクセスを多用している\u003c/strong\u003eため、\u003ccode\u003eUnity.InternalAPIEditorBridgeDev.001\u003c/code\u003e等\u003ccode\u003eUnityEditor\u003c/code\u003eに\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/master/Editor/Mono/AssemblyInfo/AssemblyInfo.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003einternalアクセスが許可されているアセンブリ名\u003c/a\u003eを持つ\u003ccode\u003eAssemblyDefinitionFile\u003c/code\u003eが必要です。\u003c/p\u003e\n\n\u003cp\u003eまずはエントリポイントからです。\u003cbr\u003e\n\u003ccode\u003eInitializeOnLoad\u003c/code\u003e属性を使って、ロード時に自動的に実行されるようにしましょう。\u003cbr\u003e\nここでは\u003ccode\u003eScriptCompilers\u003c/code\u003eのフィールドを書き換えるコードを用意します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eInitializeOnLoad\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomCSharpInstaller\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"nf\"\u003eCustomCSharpInstaller\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomLanguage\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCustomCSharpLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// SupportedLanguagesにカスタムC#を追加.\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eScriptCompilers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSupportedLanguages\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetType\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCustomCSharpLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eScriptCompilers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSupportedLanguages\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInsert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// CSharpSupportedLanguageはreadonlyなのでリフレクションで上書き.\u003c/span\u003e\n        \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eScriptCompilers\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetField\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"CSharpSupportedLanguage\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBindingFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStatic\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eBindingFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNonPublic\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// こちらも上書き.\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eEditorBuildRules\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetPredefinedTargetAssemblies\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLanguage\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetType\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCSharpLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLanguage\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecustomLanguage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれにより、C#のコンパイル時に、\u003ccode\u003eCSharpLanguage\u003c/code\u003eの代わりに\u003ccode\u003eCustomCSharpLanguage\u003c/code\u003eが選択されるようになりました。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003e次に、\u003ccode\u003eCustomCSharpLanguage\u003c/code\u003eを実装していきますが、こちらは\u003ccode\u003eCSharpLanguage\u003c/code\u003e(\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/Compilers/CSharpLanguage.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eソース\u003c/a\u003e)を継承すれば最小限のコードで済みます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomCSharpLanguage\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eCSharpLanguage\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"n\"\u003eScriptCompilerBase\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eScriptAssembly\u003c/span\u003e \u003cspan class=\"n\"\u003escriptAssembly\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoIsland\u003c/span\u003e \u003cspan class=\"n\"\u003eisland\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003ebuildingForEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBuildTarget\u003c/span\u003e \u003cspan class=\"n\"\u003etargetPlatform\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003erunUpdater\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// カスタムコンパイラを使うかどうかのフラグ.\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ScriptAssemblyやMonoIslandにはファイル一覧、参照一覧、シンボル一覧、出力ファイル名などの情報が格納されている.\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// それに応じて必要なアセンブリのみコンパイラを切り替えることが可能。\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003euseCustomCompiler\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euseCustomCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// カスタムコンパイラを使う.\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCustomCSharpCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eisland\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erunUpdater\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 使わない場合はデフォルトのコンパイラを使う.\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003escriptAssembly\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisland\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuildingForEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etargetPlatform\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erunUpdater\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのように、\u003ccode\u003eCSharpLanguage\u003c/code\u003eは\u003cstrong\u003e動的にコンパイラクラスのインスタンスを返せます\u003c/strong\u003e。\u003cbr\u003e\nUnity2019.2までは、\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/2019.2/Editor/Mono/Scripting/Compilers/CSharpLanguage.cs#L49\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこの部分でmsc/cscの切り替えを行なっていました\u003c/a\u003e。\u003cbr\u003e\nなお、Unity2019.3からはcsc(\u003ccode\u003eMicrosoftCSharpCompiler\u003c/code\u003e)のみです。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003e最後に、コンパイラクラスを作成しましょう。\u003cbr\u003e\nこのクラスは\u003cstrong\u003eresponse file(コンパイルオプションを記述したファイル)を生成\u003c/strong\u003eし、それを入力として\u003cstrong\u003eコンパイラプロセスを起動\u003c/strong\u003eすることが責務です。\u003cbr\u003e\n\u003ccode\u003eMicrosoftCSharpCompiler\u003c/code\u003e(\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/2019.3/Editor/Mono/Scripting/ScriptCompilers.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eソース\u003c/a\u003e)を継承すればこちらも簡単です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomCSharpCompiler\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMicrosoftCSharpCompiler\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eCustomCSharpCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMonoIsland\u003c/span\u003e \u003cspan class=\"n\"\u003eisland\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003erunUpdater\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eisland\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erunUpdater\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"n\"\u003eProgram\u003c/span\u003e \u003cspan class=\"nf\"\u003eStartCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 継承元のコンパイルプロセスは即終了させる.\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartCompiler\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eKill\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 最後に生成されたresponse fileを取得する.\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 複数のファイルが生成される場合があるので、outオプションで判定する.\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eoutopt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"/out:\\\"{0}\\\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003em_Island\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_output\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresponsefile\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Temp\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"UnityTempFile*\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOrderByDescending\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetLastWriteTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFirst\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAllLines\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eAny\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoutopt\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 　自作のコンパイラでresponse fileを処理する.\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epsi\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eProcessStartInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eArguments\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e...,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eFileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e...,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eCreateNoWindow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// プロセスを開始する.\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eprogram\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eProgram\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epsi\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eprogram\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eprogram\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e継承元(\u003ccode\u003eMicrosoftCSharpCompiler\u003c/code\u003e)でcscを使ったコンパイルプロセスを作っているので、継承元のものは終了させましょう。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003eresponse fileは、継承元のコンパイラクラスで作成され、\u003ccode\u003eTemp\u003c/code\u003eフォルダに保存されるので、最新のものをピックアップしましょう。\u003cbr\u003e\nresponse fileの生成は継承元のコンパイラクラスに任せましょう、簡単に外部参照やシンボル等の整合性が取れます。\u003cbr\u003e\nちなみに、responsefileの中身はこんな感じです。\u003cbr\u003e\nC#プロジェクトの内容をコンパイルオプションに置き換えたようなイメージですね。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e/target:library\n/nowarn:0169\n/out:\"Temp/*********.dll\"\n/debug:portable\n/optimize-\n/nostdlib+\n/preferreduilang:en-US\n/langversion:latest\n/reference:\"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.dll\"\n/reference:\"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.AIModule.dll\"\n/reference:\"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.ARModule.dll\"\n/reference:\"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.AccessibilityModule.dll\"\n/reference:\"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.AnimationModule.dll\"\n/reference:\"/********/Unity.app/Contents/Managed/UnityEngine/UnityEngine.AssetBundleModule.dll\"\n...以下、シンボル定義とcsファイルの一覧\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e余談ですが、なんでわざわざresponse fileを作る必要があるんでしょうか？\u003cbr\u003e\n正解は\u003cstrong\u003eProcess.Startで引数が長すぎて死ぬから\u003c/strong\u003eです。\u003cbr\u003e\nあと、\u003cstrong\u003e文字列がダブルクォーテーションで囲まれてる\u003c/strong\u003eのも注意が必要です。\u003cbr\u003e\n\u003cdel\u003e私はどちらの罠も踏み抜きました。\u003c/del\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cbr\u003e\u003c/p\u003e\n\n\u003cp\u003e長くなりましたが、これがUnity上で自作C#コンパイラを動かすための\u003cstrong\u003e雛形となるコード\u003c/strong\u003eです。\u003cbr\u003e\nこのコードを好きなように改造し、\u003cstrong\u003edllにコンパイルしてインポート\u003c/strong\u003eすることで、csファイルのコンパイルが始まる前に自作C#コンパイラをビルドパイプラインに載せられます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/mob-sakai/items/f3bbc0c45abc31ea7ac0#ignoresaccesscheckstoattribute%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6internal%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\" id=\"reference-a3c1b4630e94d4b63d31\"\u003e前回\u003c/a\u003eの\u003ccode\u003eIgnoresAccessChecksTo\u003c/code\u003eの下準備よりもめんどくさいですね。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"めんどくさいのでパッケージを使うデモ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%81%E3%82%93%E3%81%A9%E3%81%8F%E3%81%95%E3%81%84%E3%81%AE%E3%81%A7%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E4%BD%BF%E3%81%86%E3%83%87%E3%83%A2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eめんどくさいのでパッケージを使う＆デモ\u003c/h3\u003e\n\n\u003cp\u003e今回は、先述のコンパイラを同梱済みの\u003ca href=\"https://github.com/mob-sakai/OpenSesameCompilerForUnity\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnity向けに公開しているパッケージ\u003c/a\u003eをデモとして使います。\u003cbr\u003e\n\u003ca href=\"https://github.com/mob-sakai/OpenSesameCompilerForUnity/archive/demo.zip\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこちら\u003c/a\u003eからデモプロジェクト一式をダウンロードできます。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e動作にはdotnet 3.0以上が必要です\n\n\u003cul\u003e\n\u003cli\u003eコマンドプロンプト(Windows)やターミナル(Mac)で、\u003ccode\u003edotnet --version\u003c/code\u003eを実行したときに、\u003ccode\u003e3.0.x\u003c/code\u003e以上が表示されていればインストール不要です\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://dotnet.microsoft.com/download\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://dotnet.microsoft.com/download\u003c/a\u003e からインストールしてください\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eUnityプロジェクトをUnityエディタで開きます\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eCoffee.OpenSesame.Test.cs\u003c/code\u003eがアクセシビリティに関するコンパイルエラー(CS0122)を吐いてますね。\u003cstrong\u003e安心してください、privateアクセスしているだけです。あなたのUnityは正常ですよ。\u003c/strong\u003e\u003cbr\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://camo.qiitausercontent.com/ca7b1e95622822d480b09731a06f396eb09be31d/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383732352d66643738623730302d323738322d313165612d383332332d3032616333356232336339652e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448725-fd78b700-2782-11ea-8323-02ac35b23c9e.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3949bf905c67595020cb9906cb064953\" alt=\"\" data-canonical-src=\"https://user-images.githubusercontent.com/12690315/71448725-fd78b700-2782-11ea-8323-02ac35b23c9e.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448725-fd78b700-2782-11ea-8323-02ac35b23c9e.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5c630deec3c287616c03213abcf7eb50 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eプロジェクトビューで\u003ccode\u003eTests/Coffee.OpenSesame.Test.asmdef\u003c/code\u003eを選択し、コンテキストメニュー(右クリック)から\u003ccode\u003eOpenSesame Compiler \u0026gt; Setting\u003c/code\u003eをクリックし、開いたウィンドウで以下のように入力します\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c121c7cc22391e1fccc8d02d7a6fb7207c4efc9e/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383439322d63633461623738302d323737662d313165612d396336352d3534353661313265356365312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448492-cc4ab780-277f-11ea-9c65-5456a12e5ce1.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=dfbf34e0334cfb8515b2de350f757a6a\" alt=\"\" data-canonical-src=\"https://user-images.githubusercontent.com/12690315/71448492-cc4ab780-277f-11ea-9c65-5456a12e5ce1.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448492-cc4ab780-277f-11ea-9c65-5456a12e5ce1.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=717cd4cdea3d3e453ccecabdad4af7b8 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eOpen Sesame Compiler: \u003cstrong\u003eチェックを入れる\u003c/strong\u003e\n\u003c/li\u003e\n\u003cli\u003ePublish Folder:  \u003cstrong\u003eAssets/Editor\u003c/strong\u003e (初期値)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eSave\u003c/code\u003eを押すと、内容が保存されて、コンパイルが実行されます。そのまましばらく待つと...コンパイルエラーが消えました！\u003cimg alt=\":tada:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png\" title=\":tada:\" width=\"20\" loading=\"lazy\"\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/bb202a19098965ab0ee4bf50db5003ff4ef22fc3/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383835392d36393563316630302d323738352d313165612d383336322d6237316232336630356330382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448859-695c1f00-2785-11ea-8362-b71b23f05c08.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=621ebb4f78468358671242ef2df8d5ca\" alt=\"\" data-canonical-src=\"https://user-images.githubusercontent.com/12690315/71448859-695c1f00-2785-11ea-8362-b71b23f05c08.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448859-695c1f00-2785-11ea-8362-b71b23f05c08.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b25825709969c954217569ac152d7508 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003eツールバーの\u003ccode\u003eWindow \u0026gt; General \u0026gt; Test Runner\u003c/code\u003eを選択し、テストランナーウィンドウを開き、 \u003ccode\u003eRun All\u003c/code\u003eを押すと...privateアクセステストが通りました！\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/2ee27a8009e70bbd72d46df416d6fc3891ba1bc6/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383839302d65363837393430302d323738352d313165612d386535352d3033336635356137366236382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448890-e6879400-2785-11ea-8e55-033f55a76b68.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=8851fccc27d390e331a987ee214eac96\" alt=\"\" data-canonical-src=\"https://user-images.githubusercontent.com/12690315/71448890-e6879400-2785-11ea-8e55-033f55a76b68.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448890-e6879400-2785-11ea-8e55-033f55a76b68.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d888ef6b57ba5a4c3f39e9a677eed3b4 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003eこの後は\u003ccode\u003eTests/Coffee.OpenSesame.Test.cs\u003c/code\u003eにinternal/privateアクセスを追加しても、コンパイルエラーが吐かれませんよ！\u003c/li\u003e\n\u003cli\u003e次に、プロジェクトビューで\u003ccode\u003eTests/Coffee.OpenSesame.Test.asmdef\u003c/code\u003eを選択し、コンテキストメニュー(右クリック)から\u003ccode\u003eOpenSesame Compiler \u0026gt; Publish\u003c/code\u003eを選択しましょう。\u003c/li\u003e\n\u003cli\u003edllファイルが生成されました。このdllは、\u003cstrong\u003eもはやコンパイラの手を借りることなくinternal/privateアクセスが可能な存在です\u003c/strong\u003e。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/a2bdb52126e2575b2974e34c50ab13980e1f0cd0/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f31323639303331352f37313434383934302d31313236316338302d323738372d313165612d386365382d6462373634376637313961322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448940-11261c80-2787-11ea-8ce8-db7647f719a2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=04ffc1e3ead5a558d201df783da2d4c8\" alt=\"\" data-canonical-src=\"https://user-images.githubusercontent.com/12690315/71448940-11261c80-2787-11ea-8ce8-db7647f719a2.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F12690315%2F71448940-11261c80-2787-11ea-8ce8-db7647f719a2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b35ea873dd2526ec22307ef882f92545 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003eこのように、ポータブルなdllファイルを生成することで、\u003cstrong\u003edllをインターフェースとしたinternal/privateアクセスが実現できます\u003c/strong\u003e。もちろん、別プロジェクトでも利用できますし、パッケージとして配布することも可能です。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"このパッケージcomcoffeeopen-sesame-compilerのアピールポイント\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%81%AE%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8comcoffeeopen-sesame-compiler%E3%81%AE%E3%82%A2%E3%83%94%E3%83%BC%E3%83%AB%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこのパッケージ(com.coffee.open-sesame-compiler)のアピールポイント\u003c/h4\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eワークフローを変化させずに、internalアクセスもprivateアクセスもできちゃう\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003eC#宇宙の　法則が　乱れる！\u003c/li\u003e\n\u003cli\u003eインストールするだけで使え、覚えるべきことが少ない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e必要最低限のアセンブリだけを自作コンパイルで処理できる\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e↑の設定画面で\u003ccode\u003eOpen Sesame Compiler\u003c/code\u003eにチェックを入れたアセンブリのみ処理できる\u003c/li\u003e\n\u003cli\u003eそれ以外はデフォルトのコンパイラで処理するので、影響範囲が小さい\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eAssemblyDefinitionFile\u003c/code\u003eを無効化しなくていい\n\n\u003cul\u003e\n\u003cli\u003einternal/privateな要素を使っていても、コンパイルエラーにならない\u003c/li\u003e\n\u003cli\u003e間違った使い方によるエラーは報告してくれるので安心\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ePublish機能を使えば、ポータブルなdllとしてエクスポートできる\n\n\u003cul\u003e\n\u003cli\u003e配布する際にコンパイル部分の依存が不要になる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eC#8が使える\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e.Net 3.5でも.Net 4.xでも動く\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"気になるところ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B0%97%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%A8%E3%81%93%E3%82%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e気になるところ\u003c/h2\u003e\n\n\u003cp\u003e機能検証に時間を取りすぎた結果、テストにあまり時間が取れませんでした...\u003cbr\u003e\n「とりあえず、こういうことができる」事が分かったという段階ですね。今後に期待してください。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e\u003ccode\u003eIgnoresAccessChecksToAttribute\u003c/code\u003eによるinternal/privateアクセスでできないことは？\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003einternal/privateクラス・インターフェースの継承\n\n\u003cul\u003e\n\u003cli\u003einternalクラス・インターフェースの継承は\u003ccode\u003eInternalsVisibleTo\u003c/code\u003eを併用することで可能\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eprivateクラスに対する拡張メソッド\n\n\u003cul\u003e\n\u003cli\u003e拡張メソッドの仕様上仕方ない気がするけど\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eたぶん、まだあると思うので見つけたらコメントください！\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eランタイムでも動くの？\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e未確認です...\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eIL2CPP対応してる？\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e未確認です...\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eブレークポイントは？\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e未確認です...\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eサポートしてるバージョンは？\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003eUnity 2018.3〜2019.2までは確認しました（Mac）\u003c/li\u003e\n\u003cli\u003eUnity 2019.3と2020.1で大幅に変更があったようなので、今後対応します\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eなんかエラー出るんだけど？\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003eエディタを一度閉じた後、\u003ccode\u003eLibrary/ScriptAssemblies\u003c/code\u003eを削除して再起動してください\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eIDEだとprivate要素にエラー出たまんまなんだけど？\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cdel\u003eそれはいわゆる、コラテラルダメージというものに過ぎない。目的の為の、致し方ない犠牲だ。\u003c/del\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"終わりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e終わりに\u003c/h2\u003e\n\n\u003cp\u003einternal/privateアクセスが手軽にできるようになりました。\u003cbr\u003e\n正直、リフレクション憎しのエネルギーで\u003cstrong\u003e結構ヤバいものを生み出してしまった感\u003c/strong\u003eがあります。\u003cbr\u003e\nくれぐれも　じこせきにんで　おねがいします。\u003c/p\u003e\n\n\u003cp\u003eそして、この記事を書いている間に\u003cstrong\u003e「あれ？\u003ccode\u003eUnityEditor.Modules.ICompilationExtension\u003c/code\u003e使ったらもっと簡単にイケるんじゃね？」\u003c/strong\u003eと気づきました。\u003cbr\u003e\n\u003cdel\u003eそういうことに気を取られるから遅筆なんだぞ！\u003c/del\u003e\u003cbr\u003e\n後でその検証もやります。\u003cbr\u003e\n【追記】ダメでした。\u003c/p\u003e\n\n\u003cp\u003eこの場を借りて、様々な情報をご提供頂きました\u003ca href=\"/pCYSl5EDgo\" class=\"user-mention js-hovercard\" title=\"pCYSl5EDgo\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"pCYSl5EDgo\"\u003e@pCYSl5EDgo\u003c/a\u003eさんにお礼を申し上げますm(_ _)m\u003c/p\u003e\n","createdAt":"2019-12-13T06:40:09Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"vOpA5qyRk8q6f462W+R4u2shiQ2uL+G5NQ==--Vtj6EXZpK6In4E4U--MQVk3a4KwsPBMduiTuCoEw==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-12-27T04:53:05Z","likesCount":24,"linkUrl":"https://qiita.com/mob-sakai/items/a24780d68a6133be338f","organization":null,"originalId":1110216,"stockedCount":15,"title":"【Unity, C#】続・privateな型やメンバにアクセスするには、多分これが一番早いと思います","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#tldr\"\u003eTL;DR\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ignoresaccesscheckstoattribute%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\"\u003eIgnoresAccessChecksToAttributeおさらい\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#private%E3%81%AA%E5%9E%8B%E3%82%84%E3%83%A1%E3%83%B3%E3%83%90%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%99%E3%82%8B%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\"\u003eprivateな型やメンバにアクセスするモチベーション\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E9%9A%9B%E3%82%84%E3%82%8D%E3%81%86%E3%81%A8%E3%81%99%E3%82%8B%E3%81%A8%E6%89%8B%E9%A0%86%E3%81%8C%E9%9D%A2%E5%80%92%E3%81%AA%E3%81%93%E3%81%A8%E3%81%AB%E6%B0%97%E3%81%A5%E3%81%8F\"\u003e実際やろうとすると手順が面倒なことに気づく\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%96%B9%E6%B3%951-%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E5%A4%89%E6%9B%B4%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%81%A7%E5%AF%BE%E5%87%A6%E3%81%99%E3%82%8B\"\u003e【方法1】 アセットの変更に対するコールバックで対処する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%96%B9%E6%B3%952-%E8%87%AA%E4%BD%9C%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AB%E7%B5%84%E3%81%BF%E8%BE%BC%E3%82%80\"\u003e【方法2】 自作コンパイラをビルドパイプラインに組み込む\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#unity%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF\"\u003eUnity組み込みコンパイラの仕組み\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%87%AA%E4%BD%9C%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%99%E3%82%8B\"\u003e自作コンパイルを使ってコンパイルする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%81%E3%82%93%E3%81%A9%E3%81%8F%E3%81%95%E3%81%84%E3%81%AE%E3%81%A7%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E4%BD%BF%E3%81%86%E3%83%87%E3%83%A2\"\u003eめんどくさいのでパッケージを使う＆デモ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%81%AE%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8comcoffeeopen-sesame-compiler%E3%81%AE%E3%82%A2%E3%83%94%E3%83%BC%E3%83%AB%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88\"\u003eこのパッケージ(com.coffee.open-sesame-compiler)のアピールポイント\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B0%97%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%A8%E3%81%93%E3%82%8D\"\u003e気になるところ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e終わりに\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":4069,"uuid":"a24780d68a6133be338f","banReason":null,"adventCalendarItem":{"day":25,"calendar":{"name":"【unityプロ技②】","urlName":"unityforpro2","year":2019,"organization":null}},"author":{"encryptedId":"wBtPGzvkn0IHTaE5nkAgpflLDcwX--7ezs6gkEFnsw5jO7--lbRoGz8IDXIxVYNxpFt8tg==","originalId":158545,"description":"","facebookUrl":null,"githubUrl":"https://github.com/mob-sakai","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":false,"linkedinUrl":null,"name":"","profileImageUrl":"https://avatars.githubusercontent.com/u/12690315?v=3","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F12690315%3Fv%3D3?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=6b0a822c24a85b538ea9a0a484eade39","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F12690315%3Fv%3D3?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=157030055d562d2dae611d3a9828b0cf","urlName":"mob-sakai","websiteUrl":null,"twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"private","urlName":"private"},{"name":"Unity","urlName":"unity"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
