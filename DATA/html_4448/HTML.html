<!DOCTYPE html><html><head><meta charset="utf-8" /><title>TelemetryClient と Activity の挙動を理解する (2) - Activity - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/TsuyoshiUshio@github/items/c44624205e3741897804" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="++HvXz3038vIqMZusGx1gdpriBsDIJDcqxphJ6LL5aqTI344vdPt9Y9sL+GnbNTeckELqppyXNgNL4I7/o1eLQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="TelemetryClient と Activity の挙動を理解する (2) - Activity - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WR1ZzWlcxbGRISjVRMnhwWlc1MElPT0JxQ0JCWTNScGRtbDBlU0RqZ2E3bWpKbmxpNVhqZ3BMbmtJYm9wNlBqZ1puamdvc2dLRElwSUMwZ1FXTjBhWFpwZEhrJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTUyNjBiNDUxOGZiOTU3Yjc3NGJkZWEwZmI2NmExMTFk&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=f5549cb170e0502746a5d4b44cbef097"><meta property="og:description" content="前回の記事では、Application Insights のデータモデルについて説明した。第二回は、Activity について整理してみたい。


TelemetryClient と Activity の挙動を理解する (1) - デ..."><meta content="https://qiita.com/TsuyoshiUshio@github/items/c44624205e3741897804" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,ApplicationInsights" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-47512ced-b202-4265-a074-c5c45029962e"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2Fc44624205e3741897804">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2Fc44624205e3741897804">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-47512ced-b202-4265-a074-c5c45029962e">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-10-31T22:51:12.000+09:00","dateModified":"2018-10-31T22:51:12.000+09:00","headline":"TelemetryClient と Activity の挙動を理解する (2) - Activity","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WR1ZzWlcxbGRISjVRMnhwWlc1MElPT0JxQ0JCWTNScGRtbDBlU0RqZ2E3bWpKbmxpNVhqZ3BMbmtJYm9wNlBqZ1puamdvc2dLRElwSUMwZ1FXTjBhWFpwZEhrJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTUyNjBiNDUxOGZiOTU3Yjc3NGJkZWEwZmI2NmExMTFk\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=f5549cb170e0502746a5d4b44cbef097","mainEntityOfPage":"https://qiita.com/TsuyoshiUshio@github/items/c44624205e3741897804","author":{"@type":"Person","address":"Kanagwa, Japan","email":null,"identifier":"TsuyoshiUshio@github","name":"TsuyoshiUshio@github","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","url":"https://qiita.com/TsuyoshiUshio@github","description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">CTO業務を積極的に権限移譲するユーザベースの開発組織とは</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"c44624205e3741897804"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"c44624205e3741897804"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"c44624205e3741897804"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/TsuyoshiUshio@github/items/c44624205e3741897804","location":"/TsuyoshiUshio@github/items/c44624205e3741897804","scheme":"https","host":"qiita.com","port":null,"pathname":"/TsuyoshiUshio@github/items/c44624205e3741897804","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"yuNxP2pK5nexDTBN1wQGb9R6SMukJfHTAtJNoar02kaiIeBY6m3USfbJ2cLABKcwfFDLej13Pdek56699rJhwQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-b95f2f4c-9ae7-4c0f-a83e-81ccc4ca9bdb"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/c44624205e3741897804/likers" class="css-1iupg5d">3</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">1</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/c44624205e3741897804/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/c44624205e3741897804/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/c44624205e3741897804/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/c44624205e3741897804/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/c44624205e3741897804.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/TsuyoshiUshio@github"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/TsuyoshiUshio@github" class="css-10ougpm">@<!-- -->TsuyoshiUshio@github</a><div class="css-1ay9vb9"><time dateTime="2018-10-31T13:51:12Z" class="css-m19uds">posted at 2018-10-31</time></div></div></div></div></div><h1 class="css-cgzq40">TelemetryClient と Activity の挙動を理解する (2) - Activity</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/applicationinsights" class="css-4czcte">ApplicationInsights</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>前回の記事では、Application Insights のデータモデルについて説明した。第二回は、Activity について整理してみたい。</p>

<ul>
<li><p><a href="https://qiita.com/TsuyoshiUshio@github/items/f02d74a18d0b5a855fde" id="reference-e47018271ef2ec7e8187">TelemetryClient と Activity の挙動を理解する (1) - データモデル</a> </p></li>
<li><p><a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#overview" rel="nofollow noopener" target="_blank">Activity User Guide (原典)</a></p></li>
</ul>

<h1>
<span id="activity-user-guide" class="fragment"></span><a href="#activity-user-guide"><i class="fa fa-link"></i></a>Activity User Guide</h1>

<p>このドキュメントは Actvitiy について説明します。Actvitiy は、診断コンテキスト <code>diagnostic context</code> をストアしたり、アクセスしたりできるようにするクラスです。ロギングによって、使われます。</p>

<p>このドキュメントは、Activity のアーキテクチャオーバービューと使い方について説明します。</p>

<h1>
<span id="overview" class="fragment"></span><a href="#overview"><i class="fa fa-link"></i></a>Overview</h1>

<p>アプリケーションが、オペレーションを実行するとき、例えば HTTPリクエストや、Queue からのタスクなど、アプリケーションは、<code>Activity</code> を生成します。Activity は、リクエストの実行が、システム間でトラックできるようにします。<code>Activity</code> に保存されている<code>Context</code> の例としては、HTTPのリクエストパスだったり、メソッドだったり、<code>user-agent</code> だったり、<code>correlation id</code> だったりします。すべての重要な詳細は、すべてのトレースと共にログされます。詳細は[Activity Reference]</p>

<p>(<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-reference)%E3%81%AB%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-reference)にあります。</a></p>

<p><code>Activity</code> は、<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#tags" rel="nofollow noopener" target="_blank">Tags</a>を提供しています。それは、ロギングのみに使われるコンテキストを示しています。<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#baggage" rel="nofollow noopener" target="_blank">Baggage</a> は、外部の依存先に伝搬するためのコンテキストを表します。</p>

<p>すべての <code>Activity</code> は <code>Id</code> をもっています。特定のアプリケーションのリクエストを定義しており、Activity が開始されたときに生成されます。</p>

<p><code>Activity</code>(root のものは除く) は<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#parent" rel="nofollow noopener" target="_blank">Parent</a>を持っています。<code>in-process</code> もしくは、外部のものです。例えば、アプリケーションがリクエストを受け取って、外部依存サービスを呼び出した場合、外部サービスを呼び出すための Activity が存在し、それは、親の Activity すなわち、リクエストの受け取りを表す Parent Activity を持ちます。外部依存呼び出しの Activity Id は、リクエストと共に送信されて、おそらく、外部依存サービスのActivityの、ParentId として使われます。これにより、子と親の間のユニークなマッピングが可能になります。Parent は、Activity がスタートしたらアサインされます。</p>

<p>Activities は、プラットフォームやフレームワークのコードの中で、おそらく、作られたり、開始/終了したりします。アプリケーションは、アクティビティのイベントを通知する必要があり、実行された Current Activity にアクセスする必要があります。ですので、Activity を作ったコードは、該当イベントを、<code>DiagnosticSource</code> に書いてあげる必要があります。:</p>

<ul>
<li>
<strong>DO</strong> - 特定の Activity type に対して、フィルタリングを行うために、新しい <code>DiagnosticListener</code>を 作成します。例えば、Incoming と Outgoing の Http Requests は、別の違う <code>DiagnosticListener</code> であるべきです。<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md" rel="nofollow noopener" target="_blank">DignosticSource User Guide</a>を参考にしましょう。</li>
<li>
<strong>DO</strong> - Activity の生成と、コールのスタートを、<code>DignosticSource.IsEnabled</code> を呼ぶことでガードしましょう。これにより、だれもリスニングしていない Activities 作成することを防ぐことができます。イベント名ベースのフィルタリングやサンプリングを可能にします。</li>
<li>
<strong>DO</strong> - Activity のメソッドが、Activity のイベントが常に <code>DiagnosticSource</code> に書かれることを保証する代わりに、<code>DiagnosticSource.StartActivity(Activity)</code> と <code>DiagnosticSource.StopActivity(Activity)</code> メソッドをつかいましょう。</li>
<li>
<strong>DO</strong> 必要な全てのコンテキストを<code>DiagnosticsListner</code>に引き渡しましょう。そうすればあなたのアプリケーションは、Activityがよりよくなるでしょう。例えば、HTTPリクエストを受け取ったとき、アプリケーションは、カスタムタグを追加するために、<code>HttpContext</code> のインスタンスが必要です。（method, path, user-agent, など)</li>
<li>
<strong>CONSIDER</strong> <a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#baggage" rel="nofollow noopener" target="_blank">Baggage</a>を避けて、できるだけ小さく保ちましょう。</li>
<li>
<strong>DO NOT</strong> baggage にセンシティブな情報を詰めることはやめましょう。ほかのプロセスのバウンダリに送られてしまうことがあります。</li>
<li>
<strong>DO</strong> すべてのテレメトリイベントで、activity id を書きましょう。ParentId, Tags, そして Baggage は、１回のオペレーションにつき、最低１回はかかれるべきで、Id により見つかるべきです。Tags と Baggage は、アクティビティのライフタイムで変わることがあります。そして、アクティビティがストップするときに書きだされることは的を得ています。Duration は、アクティビティがストップしたときのみログ出力されるべです。</li>
<li>
<strong>CONSIDER</strong> アクティビティの RootId をすべてのテレメトリで書きます。たとえ、Id のプレフィックスでフィルタリングあなたの使っているログインぐバックエンドがサポートしていない、もしくはとても高価な場合もです。</li>
</ul>

<p>Current Activity は、スタティックの変数で公開されています。<code>Activity.Current</code> そして、すべての<code>call context</code> を流れます。async 呼び出しも含みます。ですので、すべての、Start/Stop イベントのコールバックで利用可能です。</p>

<p>アプリケーションは、<code>Activity.Current</code> にコードのどこからでもアクセスする可能性があり、Activity の Context に保存されているコンテキストとともに、イベントのログ出力をどこからでも行うかもしれません。</p>

<h1>
<span id="activity-の使い方" class="fragment"></span><a href="#activity-%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>Activity の使い方</h1>

<h2>
<span id="activity-の作成" class="fragment"></span><a href="#activity-%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>Activity の作成</h2>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="n">Activity</span> <span class="n">activity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Activity</span><span class="p">(</span><span class="s">"Http_In"</span><span class="p">);</span>
</code></pre></div></div>

<p>アクティビティは、オペレーション名と一緒に作られる必要があります。これは、大きめの名前で、グルーピングやログのフィルタに使われます。アクティビティが作られた後、詳細を追加することができます。<code>Start time</code>, <code>Tags</code>, そして <code>Baggage</code></p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="n">actvity</span><span class="p">.</span><span class="nf">SetStartTime</span><span class="p">()</span>
  <span class="p">.</span><span class="nf">AddTag</span><span class="p">(</span><span class="s">"Path"</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Path</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">AddBaggage</span><span class="p">(</span><span class="s">"FeatureId"</span><span class="p">,</span> <span class="n">experimentalFeatureId</span><span class="p">);</span>
</code></pre></div></div>

<p>一度アクティビティが作られたら、スタートするときです。そして、リクエストの実行を実施しましょう。</p>

<h2>
<span id="starting-and-stopping-activity" class="fragment"></span><a href="#starting-and-stopping-activity"><i class="fa fa-link"></i></a>Starting and Stopping Activity</h2>

<p><code>Start()</code> と <code>Stop()</code> メソッドは、<code>Activity.Current</code> を維持します。これは、async の呼び出しや、リクエストの処理の間有効です。もし、activity が開始されたら、<code>Activity.Current</code> は Id と Parent を持ちます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">void</span> <span class="nf">OnIncomingRequest</span><span class="p">(</span><span class="n">DiagnosticListener</span> <span class="n">httpListener</span><span class="p">,</span> <span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">httpListener</span><span class="p">.</span><span class="nf">IsEnabled</span><span class="p">(</span><span class="s">"Http_In"</span><span class="p">))</span>
  <span class="p">{</span>
     <span class="n">Activity</span> <span class="n">activity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Activity</span><span class="p">(</span><span class="s">"Http_In"</span><span class="p">);</span>
     <span class="n">activity</span><span class="p">.</span><span class="nf">SetParentId</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"Request-id"</span><span class="p">])</span>
     <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">pair</span> <span class="k">in</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">"Correlation-Context"</span><span class="p">])</span>
     <span class="p">{</span>
         <span class="kt">var</span> <span class="n">baggageItem</span> <span class="p">=</span> <span class="n">NameValueHeaderValue</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">pair</span><span class="p">);</span>
         <span class="n">activity</span><span class="p">.</span><span class="nf">AddBaggage</span><span class="p">(</span><span class="n">baggageItem</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">baggageItem</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">httpListener</span><span class="p">.</span><span class="nf">StartActivity</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span><span class="n">context</span><span class="p">});</span>
      <span class="k">try</span> <span class="p">{</span>
         <span class="c1">// process request ...</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
         <span class="n">httpListener</span><span class="p">.</span><span class="nf">StopActivity</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span><span class="n">context</span><span class="p">});</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>NOTE</strong><br>
* Activity.Start()やStop()メソッドの代わりに、上のサンプルでは、<code>DiagnosticSource.StartActivity()</code> と <code>StopActivity()</code> メソッドを呼んでいます。それは、DiagnosticSource にイベントを書き込みます。<br>
* Activity の作成は、<code>DiagnosticSource.IsEnabled</code> の呼び出しでガードされます。もし、だれも、<code>DiagnosticSource</code> をリスニングしていない時のパフォーマンスインパクトを削減できます。</p>

<h2>
<span id="create-child-activities" class="fragment"></span><a href="#create-child-activities"><i class="fa fa-link"></i></a>Create child Activities</h2>

<p>アプリケーションが、外部呼出しをするとき、例えば、外部の Web サービスを呼び出すとき、新しい Activity が作成されるべきです。この子の Activity が既存のアクティビティの一部である場合、Parent が　Start() 時に自動的にアサインされます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">void</span> <span class="nf">OnOutgoingRequest</span><span class="p">(</span><span class="n">DiagnosticListener</span> <span class="n">httpListener</span><span class="p">,</span> <span class="n">HttpRequestMessage</span> <span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">httpListener</span><span class="p">.</span><span class="nf">IsEnabled</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">httpListener</span><span class="p">.</span><span class="nf">IsEnabled</span><span class="p">(</span><span class="s">"Http_Out"</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">activity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Activity</span><span class="p">(</span><span class="s">"Http_Out"</span><span class="p">);</span>
    <span class="n">httpListener</span><span class="p">.</span><span class="nf">StartActivity</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span><span class="n">request</span><span class="p">})</span>

    <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Request-Id"</span><span class="p">,</span> <span class="n">activity</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
    <span class="n">request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Correlation-Context"</span><span class="p">,</span> <span class="nf">baggageToHeader</span><span class="p">(</span><span class="n">activity</span><span class="p">.</span><span class="n">Baggage</span><span class="p">));</span>
    <span class="k">try</span> <span class="p">{</span>
          <span class="c1">// process request</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
         <span class="c1">// stop activity</span>
         <span class="n">httpListener</span><span class="p">.</span><span class="nf">StopActivity</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span><span class="n">request</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>子の Activity は、自動的に Baggage を親から引き継ぎます。上記のサンプルは、どのように、baggage が下流のWebサービスに HTTP request ヘッダを使って伝搬されうるかということも示しています。<br>
前のサンプルにあるとおり、Activity の生成は、<code>DiagnosticSource.IsEnabled()</code> でガードされるべきです。このケースでは、ツールベースのリクエストプロパティを防ぐことができます。例えば URI などです。他の DiagnosticSource がincoming と outgoing のHTTP アクティビティで違うものが使われているのに注意してください。このことは、あなたに、イベントのフィルターで分離できることを意味します。</p>

<h1>
<span id="activity-event-のリスニング" class="fragment"></span><a href="#activity-event-%E3%81%AE%E3%83%AA%E3%82%B9%E3%83%8B%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>Activity Event のリスニング</h1>

<p>アプリケーションは、Activity Event をリッスンして、ログを出力しているかもしれません。アプリケーションは、<code>Activity.Current</code> にアクセスいｓて、現在のアクティビティの情報を取得することができます。<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md" rel="nofollow noopener" target="_blank">DiagnositcListener convension</a>に従っています。</p>

<p>アプリケーションは、tags と baggage を アクティビティの Start コールバックの時に、<code>Activity.Current</code> に足すかもしれません。<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#starting-and-stopping-activity" rel="nofollow noopener" target="_blank">Incoming Request Sample</a>の中にかいています。私たちは、<code>HttpContext</code> を <code>DiagnosticSource</code> に渡しています。それによって、アプリケーションは、リクエストプロパティにアクセスできて、現在のアクティビティをよりリッチにすることができます。</p>

<h2>
<span id="subscribe-to-diagnosticsource" class="fragment"></span><a href="#subscribe-to-diagnosticsource"><i class="fa fa-link"></i></a>Subscribe to DiagnosticSource</h2>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>   <span class="n">DiagnosticListener</span><span class="p">.</span><span class="n">AllListeners</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="k">delegate</span> <span class="p">(</span><span class="n">DiagnosticListener</span> <span class="n">listener</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"MyActivitySource"</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">listener</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="k">delegate</span> <span class="p">(</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;</span> <span class="k">value</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="nf">EndsWith</span><span class="p">(</span><span class="s">"Start"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">))</span>
                    <span class="nf">LogActivityStart</span><span class="p">();</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="nf">EndsWith</span><span class="p">(</span><span class="s">"Stop"</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">))</span>
                    <span class="nf">LogActivityStop</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="log-events" class="fragment"></span><a href="#log-events"><i class="fa fa-link"></i></a>Log Events</h2>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre><code>    <span class="k">public</span> <span class="k">void</span> <span class="nf">LogActivityStart</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">document</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">object</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="p">[</span><span class="s">"Message"</span><span class="p">]</span> <span class="p">=</span> <span class="s">$"Activity </span><span class="p">{</span><span class="n">activity</span><span class="p">.</span><span class="n">OperationName</span><span class="p">}</span><span class="s"> was started"</span><span class="p">,</span>
            <span class="p">[</span><span class="s">"LogLevel"</span><span class="p">]</span> <span class="p">=</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Info</span><span class="p">,</span>
            <span class="p">[</span><span class="s">"Id"</span><span class="p">]</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
            <span class="p">[</span><span class="s">"ParentId"</span><span class="p">]</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">ParentId</span><span class="p">,</span>
            <span class="p">[</span><span class="s">"StartTime"</span><span class="p">]</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">StartTimeUtc</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1">//log tags and baggage if needed</span>
        <span class="p">...</span><span class="c1">// send document to log storage       </span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">LogActivityStop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">document</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">object</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="p">[</span><span class="s">"Message"</span><span class="p">]</span> <span class="p">=</span> <span class="s">$"Activity </span><span class="p">{</span><span class="n">activity</span><span class="p">.</span><span class="n">OperationName</span><span class="p">}</span><span class="s"> is being stopped"</span><span class="p">,</span>
            <span class="p">[</span><span class="s">"LogLevel"</span><span class="p">]</span> <span class="p">=</span> <span class="n">LogLevel</span><span class="p">.</span><span class="n">Info</span><span class="p">,</span>
            <span class="p">[</span><span class="s">"Id"</span><span class="p">]</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
            <span class="p">[</span><span class="s">"ParentId"</span><span class="p">]</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">ParentId</span><span class="p">,</span>
            <span class="p">[</span><span class="s">"Duration"</span><span class="p">]</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">Duration</span>
        <span class="p">};</span>

        <span class="c1">//warning: Baggage or Tag could have duplicated keys!</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">kv</span> <span class="k">in</span> <span class="n">activity</span><span class="p">.</span><span class="n">Tags</span><span class="p">)</span>
            <span class="n">document</span><span class="p">[</span><span class="n">kv</span><span class="p">.</span><span class="n">Key</span><span class="p">]</span> <span class="p">=</span> <span class="n">kv</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">kv</span> <span class="k">in</span> <span class="n">activity</span><span class="p">.</span><span class="n">Baggage</span><span class="p">)</span>
            <span class="n">document</span><span class="p">[</span><span class="n">kv</span><span class="p">.</span><span class="n">Key</span><span class="p">]</span> <span class="p">=</span> <span class="n">kv</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
        <span class="p">...</span><span class="c1">// send document to log storage</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="n">LogLevel</span> <span class="n">level</span><span class="p">,</span> <span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">document</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="kt">object</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="p">[</span><span class="s">"Message"</span><span class="p">]</span> <span class="p">=</span> <span class="n">message</span><span class="p">,</span>
            <span class="p">[</span><span class="s">"LogLevel"</span><span class="p">]</span> <span class="p">=</span> <span class="n">logLevel</span><span class="p">,</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">Activity</span><span class="p">.</span><span class="n">Current</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">document</span><span class="p">[</span><span class="s">"Id"</span><span class="p">]</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">Id</span><span class="p">;</span>
            <span class="c1">//add tags, baggage and ParentId if needed</span>
        <span class="p">}</span>
        <span class="p">...</span><span class="c1">// send document to log storage</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Activity Id がすべてのイベントで、ログ出力されていることが必須。ParentId, Tags, Baggage　が、すべてのアクティビティで少なくとも１度ログ出力されるのが必須です。すべてのテレメトリイベントをクエリーと、アグリゲーションをシンプルにするためにログ出力されるかもしれません。Duration は、SetEndTimeが呼ばれた後に有効です。そして、Activity Stop イベントが発生したときに、ログ出力されます。</p>

<p><strong>NOTE:</strong> アクティビティは、Tags や Baggage には、重複するキーを認めています。</p>

<h1>
<span id="activity-id" class="fragment"></span><a href="#activity-id"><i class="fa fa-link"></i></a>Activity Id</h1>

<p>Activity の主なゴールは、テレメトリイベントをユーザリクエストを紐づけることです。Activity.Id は、この機能のキーパーとです。</p>

<p>アプリケーションは、Activity を開始して、終えるべき仕事の論理的なピースを表します。一つの Activity は、ほかの Activity の子としてスタートされることがあります。全体のオペレーションは、Activity のツリーとして表現されるかもしれません。すべてのオペレーションは、分散システムで、実施されて、Activity ツリーの森として表現されるかもしれません。Id は、Activity を森の中でユニークに識別します。それは、階層的な構造をもっており、効果的に Activity のツリーを表現します。</p>

<p>Activity.Id は、<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/HttpCorrelationProtocol.md" rel="nofollow noopener" target="_blank">HTTP Correlation Protocol</a> の<code>hierarchical Request-Id</code>を表します。</p>

<h2>
<span id="id-フォーマット" class="fragment"></span><a href="#id-%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>Id フォーマット</h2>

<p><code>|root-id.id1_id2.id3_id4.</code></p>

<p>たとえば<br>
<code>|a000b421-5d183ab6.1.8e2d4c28_1.</code></p>

<p><code>|</code> で開始されて、<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#root-id" rel="nofollow noopener" target="_blank">root-id</a> が続き<code>.</code>が続き、そして、全てのローカルのアクティビティの識別子が、<code>.</code> か <code>_</code> で区切られます。<br>
<a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#root-id" rel="nofollow noopener" target="_blank">Root-id</a>は、すべてのオペレーションを識別し、<code>Id</code> は、特定のアクティビティが含まれているオペレーションを識別します。<br>
<code>|</code> は、Id が階層構造になっていることを表しており、ロギングシステムには有効な情報です。</p>

<ul>
<li>Id は、1024 バイト以下</li>
<li>Id は、<a href="https://en.wikipedia.org/wiki/Base64" rel="nofollow noopener" target="_blank">Base64</a>で構成されていて, <code>_</code>, <code>.</code>, <code>_</code>, <code>#</code> キャラクタを含みます。Base64 と、<code>_</code> がnode の中で使われて、ほかのキャラクターは、node を分割するのに使われます。Id は常にいづれかのデリミタで終わります。</li>
</ul>

<h2>
<span id="root-id" class="fragment"></span><a href="#root-id"><i class="fa fa-link"></i></a>Root Id</h2>

<p>アクティビティを最初にスタートさせたとき、あなたは、<code>Activity.SetParentId(string)</code> で、ルートIdをオプションでセット可能です。もし、セットしなければ、アクティビティは、root-id を生成します。例えば <code>a000b421-5d183ab6</code></p>

<p>もし、他のプロセスからの、ParentId がなくて、生成したいなら、Root-Id に関して次のようなことを心にとめておいてください。</p>

<ul>
<li>
<strong>MUST</strong> システム全体で１つのオペレーションを十分に特定できうるだけの大きさにします。64(or 128) ビットのランダムナンバーか、Guid</li>
<li>
<strong>MUST</strong> <a href="https://en.wikipedia.org/wiki/Base64" rel="nofollow noopener" target="_blank">Base64 characters</a>と、<code>-</code> のみを含みます。</li>
</ul>

<p>root id を取得するには、<code>Activity.RootId</code> を使いましょう。ただし、ParentId がわたされるか、Activity が開始された後で。</p>

<h2>
<span id="child-activity-and-parent-id" class="fragment"></span><a href="#child-activity-and-parent-id"><i class="fa fa-link"></i></a>Child Activity and Parent Id</h2>

<h3>
<span id="internal-parent" class="fragment"></span><a href="#internal-parent"><i class="fa fa-link"></i></a>Internal Parent</h3>

<p>子アクティビティは、親と同じプロセスでスタートします。<code>Parent.Id</code> を取得して、自分の Id を適切な <code>Parent.Id</code> にInt型のサフィックスをつけて作成します。例えば <code>&lt;Parent.Id&gt;.1.</code> サフィックスは、Int型で、同じ親からスタートした子アクティビティの番号です。</p>

<p>アクティビティは、Id を生成して、<code>parent-id.local-id</code> のフォーマットに従います。</p>

<h3>
<span id="external-parent" class="fragment"></span><a href="#external-parent"><i class="fa fa-link"></i></a>External Parent</h3>

<p>親が別プロセスのアクティビティの場合、Parent-Id をStart する前に、アサインする必要があります。<code>Activity.SetParentId(string)</code> を使います。Activity は、ほかのサフィックスを Id に使うかもしれません。Root Id で説明したとおり、<code>_</code> のデリミタが、親が、ほかのプロセスから来たことを表します。</p>

<p>もし、外部の ParentId が、<code>|</code> からスタートしていないなら、アクティビティは、<code>|</code> と自分のId を先頭につけて、<code>ParentId</code>をキープします。同じように、最後が <code>.</code> で終わっていないなら、追加します。</p>

<p>アクティビティは、Id を生成して、<code>parent-id.local-id_</code> というフォーマットに従います。</p>

<h3>
<span id="id-オーバーフロー" class="fragment"></span><a href="#id-%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%95%E3%83%AD%E3%83%BC"><i class="fa fa-link"></i></a>Id オーバーフロー</h3>

<p>local-id を Parent.Id に足すことは、長さの制限を超えてしまう可能性を意味します。オーバーフローした場合、Parent.Id の最後のバイトは、削除されて、32-bit のランダムな、小文字の16進数でエンコードされた整数型と<code>#</code>デリミタで埋められます。これは、オーバーフローを表します。<code>&lt;Beginning-Of-Parent-Id&gt;.local-id#</code></p>

<h1>
<span id="リファレンス" class="fragment"></span><a href="#%E3%83%AA%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>リファレンス</h1>

<ul>
<li><a href="https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#reference" rel="nofollow noopener" target="_blank">Reference</a></li>
</ul>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>がっつり翻訳してみましたが、Activity は、コリレーションの内容を、保持、更新してくれて、親子の関連付けなども行ってくれる便利クラスのようです。ただ、これが、自動でテレメトリを送信することはなさげなので、それは、<code>DiagnosticListener</code> の役割のようです。Id も自動で振ってくれるようすなので、なかなかいい感じです。ただ、<a href="https://w3c.github.io/trace-context/?fbclid=IwAR3exAmMf2QMok0eMzegZrguQXYZejVNCCBYSknIHldoRKlYtAjiKFCZPiM" rel="nofollow noopener" target="_blank">W3C TraceContext</a>には対応してなさげですが、ローカルで試したところ、<code>&lt;PackageReference Include="Microsoft.ApplicationInsights.DependencyCollector" Version="2.8.0" /&gt;</code> を足すと<a href="https://github.com/Microsoft/ApplicationInsights-dotnet-server/blob/307ed401875661716ba24ad5979336a8381e62e9/Src/Common/W3C/W3CActivityExtensions.cs?fbclid=IwAR0mEGJXsA1Qul1G5NxVoVM4JAw2XOKJtCguvJg6a6TN3f3n0OtSKpyqZUo" rel="nofollow noopener" target="_blank">W3CActivityExtensions.cs</a>が追加されて、W3C の Traceparent や Tracestate が使えるようになるようです。次は、TelemetryClient と Activity の関係を見ていきたいと思います。</p>

<h1>
<span id="dictionary" class="fragment"></span><a href="#dictionary"><i class="fa fa-link"></i></a>Dictionary</h1>

<ul>
<li>causality noun[u]: the principle that there is a cause for everything that happens</li>
<li>consume verb[t]: to eat or drink, especially a lot of something:</li>
<li>trace noun [c or u]: a sign that something has happened or existed:</li>
<li>log noun [c]: a full written record of a journey, a period of time, or an event:</li>
<li>baggage noun [u]: the beliefs and feelings that influence how you think and behave - We all carry a lot of emotional baggage around with us.</li>
<li>enrich verb [t]: to improve the quality of something by adding something else:</li>
<li>coarse adj: rough and not smooth or soft, or not in very small pieces:</li>
<li>instrumentation noun [u]: the set of instruments that are used to operate a machine</li>
<li>prepend verb [t]: ​
to add something to the beginning of something else, especially a piece of data (= information) to the beginning of a computer instruction:</li>
<li><p>intact adj: complete and in the original state:<br>
*</p></li>
<li><p><a href="https://dictionary.cambridge.org/" rel="nofollow noopener" target="_blank">Cambridge dictionary</a></p></li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2Fc44624205e3741897804&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2Fc44624205e3741897804&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/c44624205e3741897804/likers" class="css-1iupg5d">3</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">1</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/c44624205e3741897804/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/c44624205e3741897804/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/c44624205e3741897804/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/c44624205e3741897804/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/c44624205e3741897804.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-b95f2f4c-9ae7-4c0f-a83e-81ccc4ca9bdb">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-d81ee9e7-56ca-4c05-b90b-ef70825e406e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-d81ee9e7-56ca-4c05-b90b-ef70825e406e">{}</script>
      
<div id="LoginModal-react-component-2dbf00e6-161e-460e-96cb-c096fea73fb6"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-2dbf00e6-161e-460e-96cb-c096fea73fb6">{}</script>
      
<div id="StockModal-react-component-d4edb98d-e9df-45cf-9d8b-2d2c60ad1593"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-d4edb98d-e9df-45cf-9d8b-2d2c60ad1593">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;9SjNVSyd1QHuhTe+gtI9b6m81RmaosOy4vQh6sDVq/Cd6lwyrLrnP6lB3jGV0pwwAZZWqAPwD7ZEwcL2nJMQdw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e前回の記事では、Application Insights のデータモデルについて説明した。第二回は、Activity について整理してみたい。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"https://qiita.com/TsuyoshiUshio@github/items/f02d74a18d0b5a855fde\" id=\"reference-e47018271ef2ec7e8187\"\u003eTelemetryClient と Activity の挙動を理解する (1) - データモデル\u003c/a\u003e \u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#overview\" rel=\"nofollow noopener\" target=\"_blank\"\u003eActivity User Guide (原典)\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"activity-user-guide\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#activity-user-guide\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eActivity User Guide\u003c/h1\u003e\n\n\u003cp\u003eこのドキュメントは Actvitiy について説明します。Actvitiy は、診断コンテキスト \u003ccode\u003ediagnostic context\u003c/code\u003e をストアしたり、アクセスしたりできるようにするクラスです。ロギングによって、使われます。\u003c/p\u003e\n\n\u003cp\u003eこのドキュメントは、Activity のアーキテクチャオーバービューと使い方について説明します。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"overview\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#overview\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eOverview\u003c/h1\u003e\n\n\u003cp\u003eアプリケーションが、オペレーションを実行するとき、例えば HTTPリクエストや、Queue からのタスクなど、アプリケーションは、\u003ccode\u003eActivity\u003c/code\u003e を生成します。Activity は、リクエストの実行が、システム間でトラックできるようにします。\u003ccode\u003eActivity\u003c/code\u003e に保存されている\u003ccode\u003eContext\u003c/code\u003e の例としては、HTTPのリクエストパスだったり、メソッドだったり、\u003ccode\u003euser-agent\u003c/code\u003e だったり、\u003ccode\u003ecorrelation id\u003c/code\u003e だったりします。すべての重要な詳細は、すべてのトレースと共にログされます。詳細は[Activity Reference]\u003c/p\u003e\n\n\u003cp\u003e(\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-reference)%E3%81%AB%E3%81%82%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-reference)にあります。\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eActivity\u003c/code\u003e は、\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#tags\" rel=\"nofollow noopener\" target=\"_blank\"\u003eTags\u003c/a\u003eを提供しています。それは、ロギングのみに使われるコンテキストを示しています。\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#baggage\" rel=\"nofollow noopener\" target=\"_blank\"\u003eBaggage\u003c/a\u003e は、外部の依存先に伝搬するためのコンテキストを表します。\u003c/p\u003e\n\n\u003cp\u003eすべての \u003ccode\u003eActivity\u003c/code\u003e は \u003ccode\u003eId\u003c/code\u003e をもっています。特定のアプリケーションのリクエストを定義しており、Activity が開始されたときに生成されます。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eActivity\u003c/code\u003e(root のものは除く) は\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#parent\" rel=\"nofollow noopener\" target=\"_blank\"\u003eParent\u003c/a\u003eを持っています。\u003ccode\u003ein-process\u003c/code\u003e もしくは、外部のものです。例えば、アプリケーションがリクエストを受け取って、外部依存サービスを呼び出した場合、外部サービスを呼び出すための Activity が存在し、それは、親の Activity すなわち、リクエストの受け取りを表す Parent Activity を持ちます。外部依存呼び出しの Activity Id は、リクエストと共に送信されて、おそらく、外部依存サービスのActivityの、ParentId として使われます。これにより、子と親の間のユニークなマッピングが可能になります。Parent は、Activity がスタートしたらアサインされます。\u003c/p\u003e\n\n\u003cp\u003eActivities は、プラットフォームやフレームワークのコードの中で、おそらく、作られたり、開始/終了したりします。アプリケーションは、アクティビティのイベントを通知する必要があり、実行された Current Activity にアクセスする必要があります。ですので、Activity を作ったコードは、該当イベントを、\u003ccode\u003eDiagnosticSource\u003c/code\u003e に書いてあげる必要があります。:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eDO\u003c/strong\u003e - 特定の Activity type に対して、フィルタリングを行うために、新しい \u003ccode\u003eDiagnosticListener\u003c/code\u003eを 作成します。例えば、Incoming と Outgoing の Http Requests は、別の違う \u003ccode\u003eDiagnosticListener\u003c/code\u003e であるべきです。\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDignosticSource User Guide\u003c/a\u003eを参考にしましょう。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eDO\u003c/strong\u003e - Activity の生成と、コールのスタートを、\u003ccode\u003eDignosticSource.IsEnabled\u003c/code\u003e を呼ぶことでガードしましょう。これにより、だれもリスニングしていない Activities 作成することを防ぐことができます。イベント名ベースのフィルタリングやサンプリングを可能にします。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eDO\u003c/strong\u003e - Activity のメソッドが、Activity のイベントが常に \u003ccode\u003eDiagnosticSource\u003c/code\u003e に書かれることを保証する代わりに、\u003ccode\u003eDiagnosticSource.StartActivity(Activity)\u003c/code\u003e と \u003ccode\u003eDiagnosticSource.StopActivity(Activity)\u003c/code\u003e メソッドをつかいましょう。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eDO\u003c/strong\u003e 必要な全てのコンテキストを\u003ccode\u003eDiagnosticsListner\u003c/code\u003eに引き渡しましょう。そうすればあなたのアプリケーションは、Activityがよりよくなるでしょう。例えば、HTTPリクエストを受け取ったとき、アプリケーションは、カスタムタグを追加するために、\u003ccode\u003eHttpContext\u003c/code\u003e のインスタンスが必要です。（method, path, user-agent, など)\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eCONSIDER\u003c/strong\u003e \u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#baggage\" rel=\"nofollow noopener\" target=\"_blank\"\u003eBaggage\u003c/a\u003eを避けて、できるだけ小さく保ちましょう。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eDO NOT\u003c/strong\u003e baggage にセンシティブな情報を詰めることはやめましょう。ほかのプロセスのバウンダリに送られてしまうことがあります。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eDO\u003c/strong\u003e すべてのテレメトリイベントで、activity id を書きましょう。ParentId, Tags, そして Baggage は、１回のオペレーションにつき、最低１回はかかれるべきで、Id により見つかるべきです。Tags と Baggage は、アクティビティのライフタイムで変わることがあります。そして、アクティビティがストップするときに書きだされることは的を得ています。Duration は、アクティビティがストップしたときのみログ出力されるべです。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eCONSIDER\u003c/strong\u003e アクティビティの RootId をすべてのテレメトリで書きます。たとえ、Id のプレフィックスでフィルタリングあなたの使っているログインぐバックエンドがサポートしていない、もしくはとても高価な場合もです。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eCurrent Activity は、スタティックの変数で公開されています。\u003ccode\u003eActivity.Current\u003c/code\u003e そして、すべての\u003ccode\u003ecall context\u003c/code\u003e を流れます。async 呼び出しも含みます。ですので、すべての、Start/Stop イベントのコールバックで利用可能です。\u003c/p\u003e\n\n\u003cp\u003eアプリケーションは、\u003ccode\u003eActivity.Current\u003c/code\u003e にコードのどこからでもアクセスする可能性があり、Activity の Context に保存されているコンテキストとともに、イベントのログ出力をどこからでも行うかもしれません。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"activity-の使い方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#activity-%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eActivity の使い方\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"activity-の作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#activity-%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eActivity の作成\u003c/h2\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eActivity\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Http_In\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eアクティビティは、オペレーション名と一緒に作られる必要があります。これは、大きめの名前で、グルーピングやログのフィルタに使われます。アクティビティが作られた後、詳細を追加することができます。\u003ccode\u003eStart time\u003c/code\u003e, \u003ccode\u003eTags\u003c/code\u003e, そして \u003ccode\u003eBaggage\u003c/code\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eactvity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetStartTime\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddTag\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Path\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddBaggage\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"FeatureId\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eexperimentalFeatureId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e一度アクティビティが作られたら、スタートするときです。そして、リクエストの実行を実施しましょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"starting-and-stopping-activity\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#starting-and-stopping-activity\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStarting and Stopping Activity\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eStart()\u003c/code\u003e と \u003ccode\u003eStop()\u003c/code\u003e メソッドは、\u003ccode\u003eActivity.Current\u003c/code\u003e を維持します。これは、async の呼び出しや、リクエストの処理の間有効です。もし、activity が開始されたら、\u003ccode\u003eActivity.Current\u003c/code\u003e は Id と Parent を持ちます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnIncomingRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnosticListener\u003c/span\u003e \u003cspan class=\"n\"\u003ehttpListener\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eHttpContext\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehttpListener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Http_In\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eActivity\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Http_In\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetParentId\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eheaders\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Request-id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n     \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epair\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeaders\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Correlation-Context\"\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n     \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebaggageItem\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNameValueHeaderValue\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eParse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epair\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n         \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddBaggage\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebaggageItem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebaggageItem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"n\"\u003ehttpListener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\n      \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"c1\"\u003e// process request ...\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003efinally\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"n\"\u003ehttpListener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStopActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n   \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003eNOTE\u003c/strong\u003e\u003cbr\u003e\n* Activity.Start()やStop()メソッドの代わりに、上のサンプルでは、\u003ccode\u003eDiagnosticSource.StartActivity()\u003c/code\u003e と \u003ccode\u003eStopActivity()\u003c/code\u003e メソッドを呼んでいます。それは、DiagnosticSource にイベントを書き込みます。\u003cbr\u003e\n* Activity の作成は、\u003ccode\u003eDiagnosticSource.IsEnabled\u003c/code\u003e の呼び出しでガードされます。もし、だれも、\u003ccode\u003eDiagnosticSource\u003c/code\u003e をリスニングしていない時のパフォーマンスインパクトを削減できます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"create-child-activities\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#create-child-activities\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCreate child Activities\u003c/h2\u003e\n\n\u003cp\u003eアプリケーションが、外部呼出しをするとき、例えば、外部の Web サービスを呼び出すとき、新しい Activity が作成されるべきです。この子の Activity が既存のアクティビティの一部である場合、Parent が　Start() 時に自動的にアサインされます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnOutgoingRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnosticListener\u003c/span\u003e \u003cspan class=\"n\"\u003ehttpListener\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eHttpRequestMessage\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehttpListener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ehttpListener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Http_Out\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Http_Out\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehttpListener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e})\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeaders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Request-Id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeaders\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Correlation-Context\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003ebaggageToHeader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBaggage\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"c1\"\u003e// process request\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003efinally\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"c1\"\u003e// stop activity\u003c/span\u003e\n         \u003cspan class=\"n\"\u003ehttpListener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStopActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e子の Activity は、自動的に Baggage を親から引き継ぎます。上記のサンプルは、どのように、baggage が下流のWebサービスに HTTP request ヘッダを使って伝搬されうるかということも示しています。\u003cbr\u003e\n前のサンプルにあるとおり、Activity の生成は、\u003ccode\u003eDiagnosticSource.IsEnabled()\u003c/code\u003e でガードされるべきです。このケースでは、ツールベースのリクエストプロパティを防ぐことができます。例えば URI などです。他の DiagnosticSource がincoming と outgoing のHTTP アクティビティで違うものが使われているのに注意してください。このことは、あなたに、イベントのフィルターで分離できることを意味します。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"activity-event-のリスニング\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#activity-event-%E3%81%AE%E3%83%AA%E3%82%B9%E3%83%8B%E3%83%B3%E3%82%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eActivity Event のリスニング\u003c/h1\u003e\n\n\u003cp\u003eアプリケーションは、Activity Event をリッスンして、ログを出力しているかもしれません。アプリケーションは、\u003ccode\u003eActivity.Current\u003c/code\u003e にアクセスいｓて、現在のアクティビティの情報を取得することができます。\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDiagnositcListener convension\u003c/a\u003eに従っています。\u003c/p\u003e\n\n\u003cp\u003eアプリケーションは、tags と baggage を アクティビティの Start コールバックの時に、\u003ccode\u003eActivity.Current\u003c/code\u003e に足すかもしれません。\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#starting-and-stopping-activity\" rel=\"nofollow noopener\" target=\"_blank\"\u003eIncoming Request Sample\u003c/a\u003eの中にかいています。私たちは、\u003ccode\u003eHttpContext\u003c/code\u003e を \u003ccode\u003eDiagnosticSource\u003c/code\u003e に渡しています。それによって、アプリケーションは、リクエストプロパティにアクセスできて、現在のアクティビティをよりリッチにすることができます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"subscribe-to-diagnosticsource\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#subscribe-to-diagnosticsource\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eSubscribe to DiagnosticSource\u003c/h2\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e   \u003cspan class=\"n\"\u003eDiagnosticListener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAllListeners\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edelegate\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnosticListener\u003c/span\u003e \u003cspan class=\"n\"\u003elistener\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"s\"\u003e\"MyActivitySource\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elistener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSubscribe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edelegate\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyValuePair\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEndsWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Start\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStringComparison\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOrdinal\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                    \u003cspan class=\"nf\"\u003eLogActivityStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEndsWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Stop\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStringComparison\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOrdinal\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                    \u003cspan class=\"nf\"\u003eLogActivityStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"log-events\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#log-events\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eLog Events\u003c/h2\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eLogActivityStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edocument\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Message\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"Activity \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOperationName\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e was started\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"LogLevel\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLogLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ParentId\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParentId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"StartTime\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStartTimeUtc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//log tags and baggage if needed\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e...\u003c/span\u003e\u003cspan class=\"c1\"\u003e// send document to log storage       \u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eLogActivityStop\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edocument\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Message\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"Activity \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOperationName\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e is being stopped\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"LogLevel\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLogLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ParentId\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParentId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Duration\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDuration\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//warning: Baggage or Tag could have duplicated keys!\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ekv\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTags\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ekv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ekv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ekv\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBaggage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ekv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ekv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e...\u003c/span\u003e\u003cspan class=\"c1\"\u003e// send document to log storage\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLogLevel\u003c/span\u003e \u003cspan class=\"n\"\u003elevel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edocument\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Message\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"LogLevel\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elogLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eActivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrent\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Id\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eactivity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//add tags, baggage and ParentId if needed\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e...\u003c/span\u003e\u003cspan class=\"c1\"\u003e// send document to log storage\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eActivity Id がすべてのイベントで、ログ出力されていることが必須。ParentId, Tags, Baggage　が、すべてのアクティビティで少なくとも１度ログ出力されるのが必須です。すべてのテレメトリイベントをクエリーと、アグリゲーションをシンプルにするためにログ出力されるかもしれません。Duration は、SetEndTimeが呼ばれた後に有効です。そして、Activity Stop イベントが発生したときに、ログ出力されます。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eNOTE:\u003c/strong\u003e アクティビティは、Tags や Baggage には、重複するキーを認めています。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"activity-id\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#activity-id\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eActivity Id\u003c/h1\u003e\n\n\u003cp\u003eActivity の主なゴールは、テレメトリイベントをユーザリクエストを紐づけることです。Activity.Id は、この機能のキーパーとです。\u003c/p\u003e\n\n\u003cp\u003eアプリケーションは、Activity を開始して、終えるべき仕事の論理的なピースを表します。一つの Activity は、ほかの Activity の子としてスタートされることがあります。全体のオペレーションは、Activity のツリーとして表現されるかもしれません。すべてのオペレーションは、分散システムで、実施されて、Activity ツリーの森として表現されるかもしれません。Id は、Activity を森の中でユニークに識別します。それは、階層的な構造をもっており、効果的に Activity のツリーを表現します。\u003c/p\u003e\n\n\u003cp\u003eActivity.Id は、\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/HttpCorrelationProtocol.md\" rel=\"nofollow noopener\" target=\"_blank\"\u003eHTTP Correlation Protocol\u003c/a\u003e の\u003ccode\u003ehierarchical Request-Id\u003c/code\u003eを表します。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"id-フォーマット\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#id-%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eId フォーマット\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003e|root-id.id1_id2.id3_id4.\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eたとえば\u003cbr\u003e\n\u003ccode\u003e|a000b421-5d183ab6.1.8e2d4c28_1.\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003e|\u003c/code\u003e で開始されて、\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#root-id\" rel=\"nofollow noopener\" target=\"_blank\"\u003eroot-id\u003c/a\u003e が続き\u003ccode\u003e.\u003c/code\u003eが続き、そして、全てのローカルのアクティビティの識別子が、\u003ccode\u003e.\u003c/code\u003e か \u003ccode\u003e_\u003c/code\u003e で区切られます。\u003cbr\u003e\n\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#root-id\" rel=\"nofollow noopener\" target=\"_blank\"\u003eRoot-id\u003c/a\u003eは、すべてのオペレーションを識別し、\u003ccode\u003eId\u003c/code\u003e は、特定のアクティビティが含まれているオペレーションを識別します。\u003cbr\u003e\n\u003ccode\u003e|\u003c/code\u003e は、Id が階層構造になっていることを表しており、ロギングシステムには有効な情報です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eId は、1024 バイト以下\u003c/li\u003e\n\u003cli\u003eId は、\u003ca href=\"https://en.wikipedia.org/wiki/Base64\" rel=\"nofollow noopener\" target=\"_blank\"\u003eBase64\u003c/a\u003eで構成されていて, \u003ccode\u003e_\u003c/code\u003e, \u003ccode\u003e.\u003c/code\u003e, \u003ccode\u003e_\u003c/code\u003e, \u003ccode\u003e#\u003c/code\u003e キャラクタを含みます。Base64 と、\u003ccode\u003e_\u003c/code\u003e がnode の中で使われて、ほかのキャラクターは、node を分割するのに使われます。Id は常にいづれかのデリミタで終わります。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"root-id\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#root-id\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eRoot Id\u003c/h2\u003e\n\n\u003cp\u003eアクティビティを最初にスタートさせたとき、あなたは、\u003ccode\u003eActivity.SetParentId(string)\u003c/code\u003e で、ルートIdをオプションでセット可能です。もし、セットしなければ、アクティビティは、root-id を生成します。例えば \u003ccode\u003ea000b421-5d183ab6\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eもし、他のプロセスからの、ParentId がなくて、生成したいなら、Root-Id に関して次のようなことを心にとめておいてください。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eMUST\u003c/strong\u003e システム全体で１つのオペレーションを十分に特定できうるだけの大きさにします。64(or 128) ビットのランダムナンバーか、Guid\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eMUST\u003c/strong\u003e \u003ca href=\"https://en.wikipedia.org/wiki/Base64\" rel=\"nofollow noopener\" target=\"_blank\"\u003eBase64 characters\u003c/a\u003eと、\u003ccode\u003e-\u003c/code\u003e のみを含みます。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eroot id を取得するには、\u003ccode\u003eActivity.RootId\u003c/code\u003e を使いましょう。ただし、ParentId がわたされるか、Activity が開始された後で。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"child-activity-and-parent-id\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#child-activity-and-parent-id\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eChild Activity and Parent Id\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"internal-parent\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#internal-parent\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eInternal Parent\u003c/h3\u003e\n\n\u003cp\u003e子アクティビティは、親と同じプロセスでスタートします。\u003ccode\u003eParent.Id\u003c/code\u003e を取得して、自分の Id を適切な \u003ccode\u003eParent.Id\u003c/code\u003e にInt型のサフィックスをつけて作成します。例えば \u003ccode\u003e\u0026lt;Parent.Id\u0026gt;.1.\u003c/code\u003e サフィックスは、Int型で、同じ親からスタートした子アクティビティの番号です。\u003c/p\u003e\n\n\u003cp\u003eアクティビティは、Id を生成して、\u003ccode\u003eparent-id.local-id\u003c/code\u003e のフォーマットに従います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"external-parent\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#external-parent\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eExternal Parent\u003c/h3\u003e\n\n\u003cp\u003e親が別プロセスのアクティビティの場合、Parent-Id をStart する前に、アサインする必要があります。\u003ccode\u003eActivity.SetParentId(string)\u003c/code\u003e を使います。Activity は、ほかのサフィックスを Id に使うかもしれません。Root Id で説明したとおり、\u003ccode\u003e_\u003c/code\u003e のデリミタが、親が、ほかのプロセスから来たことを表します。\u003c/p\u003e\n\n\u003cp\u003eもし、外部の ParentId が、\u003ccode\u003e|\u003c/code\u003e からスタートしていないなら、アクティビティは、\u003ccode\u003e|\u003c/code\u003e と自分のId を先頭につけて、\u003ccode\u003eParentId\u003c/code\u003eをキープします。同じように、最後が \u003ccode\u003e.\u003c/code\u003e で終わっていないなら、追加します。\u003c/p\u003e\n\n\u003cp\u003eアクティビティは、Id を生成して、\u003ccode\u003eparent-id.local-id_\u003c/code\u003e というフォーマットに従います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"id-オーバーフロー\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#id-%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%95%E3%83%AD%E3%83%BC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eId オーバーフロー\u003c/h3\u003e\n\n\u003cp\u003elocal-id を Parent.Id に足すことは、長さの制限を超えてしまう可能性を意味します。オーバーフローした場合、Parent.Id の最後のバイトは、削除されて、32-bit のランダムな、小文字の16進数でエンコードされた整数型と\u003ccode\u003e#\u003c/code\u003eデリミタで埋められます。これは、オーバーフローを表します。\u003ccode\u003e\u0026lt;Beginning-Of-Parent-Id\u0026gt;.local-id#\u003c/code\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"リファレンス\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%AA%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eリファレンス\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#reference\" rel=\"nofollow noopener\" target=\"_blank\"\u003eReference\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003eがっつり翻訳してみましたが、Activity は、コリレーションの内容を、保持、更新してくれて、親子の関連付けなども行ってくれる便利クラスのようです。ただ、これが、自動でテレメトリを送信することはなさげなので、それは、\u003ccode\u003eDiagnosticListener\u003c/code\u003e の役割のようです。Id も自動で振ってくれるようすなので、なかなかいい感じです。ただ、\u003ca href=\"https://w3c.github.io/trace-context/?fbclid=IwAR3exAmMf2QMok0eMzegZrguQXYZejVNCCBYSknIHldoRKlYtAjiKFCZPiM\" rel=\"nofollow noopener\" target=\"_blank\"\u003eW3C TraceContext\u003c/a\u003eには対応してなさげですが、ローカルで試したところ、\u003ccode\u003e\u0026lt;PackageReference Include=\"Microsoft.ApplicationInsights.DependencyCollector\" Version=\"2.8.0\" /\u0026gt;\u003c/code\u003e を足すと\u003ca href=\"https://github.com/Microsoft/ApplicationInsights-dotnet-server/blob/307ed401875661716ba24ad5979336a8381e62e9/Src/Common/W3C/W3CActivityExtensions.cs?fbclid=IwAR0mEGJXsA1Qul1G5NxVoVM4JAw2XOKJtCguvJg6a6TN3f3n0OtSKpyqZUo\" rel=\"nofollow noopener\" target=\"_blank\"\u003eW3CActivityExtensions.cs\u003c/a\u003eが追加されて、W3C の Traceparent や Tracestate が使えるようになるようです。次は、TelemetryClient と Activity の関係を見ていきたいと思います。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"dictionary\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dictionary\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDictionary\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003ecausality noun[u]: the principle that there is a cause for everything that happens\u003c/li\u003e\n\u003cli\u003econsume verb[t]: to eat or drink, especially a lot of something:\u003c/li\u003e\n\u003cli\u003etrace noun [c or u]: a sign that something has happened or existed:\u003c/li\u003e\n\u003cli\u003elog noun [c]: a full written record of a journey, a period of time, or an event:\u003c/li\u003e\n\u003cli\u003ebaggage noun [u]: the beliefs and feelings that influence how you think and behave - We all carry a lot of emotional baggage around with us.\u003c/li\u003e\n\u003cli\u003eenrich verb [t]: to improve the quality of something by adding something else:\u003c/li\u003e\n\u003cli\u003ecoarse adj: rough and not smooth or soft, or not in very small pieces:\u003c/li\u003e\n\u003cli\u003einstrumentation noun [u]: the set of instruments that are used to operate a machine\u003c/li\u003e\n\u003cli\u003eprepend verb [t]: ​\nto add something to the beginning of something else, especially a piece of data (= information) to the beginning of a computer instruction:\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eintact adj: complete and in the original state:\u003cbr\u003e\n*\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"https://dictionary.cambridge.org/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCambridge dictionary\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2018-10-31T13:51:12Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"fAF9X2NeL2DKIs+w9hRotUe6BdE8Xh/s--c3+0cYMXhz9G4OYh--j1zpTopOqthuzV09Kne0WA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2018-10-31T13:51:12Z","likesCount":3,"linkUrl":"https://qiita.com/TsuyoshiUshio@github/items/c44624205e3741897804","organization":null,"originalId":716047,"stockedCount":1,"title":"TelemetryClient と Activity の挙動を理解する (2) - Activity","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#activity-user-guide\"\u003eActivity User Guide\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#overview\"\u003eOverview\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#activity-%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9\"\u003eActivity の使い方\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#activity-%E3%81%AE%E4%BD%9C%E6%88%90\"\u003eActivity の作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#starting-and-stopping-activity\"\u003eStarting and Stopping Activity\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#create-child-activities\"\u003eCreate child Activities\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#activity-event-%E3%81%AE%E3%83%AA%E3%82%B9%E3%83%8B%E3%83%B3%E3%82%B0\"\u003eActivity Event のリスニング\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#subscribe-to-diagnosticsource\"\u003eSubscribe to DiagnosticSource\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#log-events\"\u003eLog Events\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#activity-id\"\u003eActivity Id\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#id-%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88\"\u003eId フォーマット\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#root-id\"\u003eRoot Id\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#child-activity-and-parent-id\"\u003eChild Activity and Parent Id\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#internal-parent\"\u003eInternal Parent\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#external-parent\"\u003eExternal Parent\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#id-%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC%E3%83%95%E3%83%AD%E3%83%BC\"\u003eId オーバーフロー\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%AA%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9\"\u003eリファレンス\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#dictionary\"\u003eDictionary\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":1037,"uuid":"c44624205e3741897804","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"4+IDDc6NJ46g8zh127Y97Htlmw==--kWbcJG+EXLYYQfbn--RvtrB6rZfvV5P2QBowB+lA==","originalId":3470,"description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","facebookUrl":null,"githubUrl":"https://github.com/TsuyoshiUshio","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"Ushio Tsuyoshi","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=f09fda0ad182a04e6357e901c2c45fb7","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","urlName":"TsuyoshiUshio@github","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"ApplicationInsights","urlName":"applicationinsights"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
