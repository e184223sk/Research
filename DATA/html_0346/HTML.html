<!DOCTYPE html><html><head><meta charset="utf-8" /><title>【Unity(C#)】Mirrorで同期通信①　マッチング機能 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/OKsaiyowa/items/ecef8e5d50c84664f2a2" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="whaErhVaXVwYp2Nnn/pf0DsSezG2FmbQETrJsJ95AwBR3cKpVZ31XVJnPZQ+zSw4Vr9ocd1p+b/yuLsV90UAAQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@okprogramming" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="【Unity(C#)】Mirrorで同期通信①　マッチング機能 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRVlc1cGRIa29ReU1wNDRDUlRXbHljbTl5NDRHbjVaQ001cHlmNllDYTVMLWg0cEdnNDRDQTQ0T2U0NE9ENDRPQjQ0T3o0NEt3NXFtZjZJTzkmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9MzA0NGU2M2I2MTJhNDc0YmMxY2FkZGJkMzRhNzA5YWU&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRTlMYzJGcGVXOTNZUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTdjYzAxMTRmZDliOTFlMzkzMGY3MTUyY2QzMmJjNWJi&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=e26ff73fbcb713ee190a2d1865c26e1b"><meta property="og:description" content="

Unity #2 Advent Calendar 2020

こちらは Unity #2 Advent Calendar 2020 の 6日目の記事です。


Mirror

オープンソースのネットワークライブラリ(アセット)です..."><meta content="https://qiita.com/OKsaiyowa/items/ecef8e5d50c84664f2a2" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity,mirror" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-2049156a-7651-4ef9-99b6-15e6a079caea"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FOKsaiyowa%2Fitems%2Fecef8e5d50c84664f2a2">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FOKsaiyowa%2Fitems%2Fecef8e5d50c84664f2a2">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-2049156a-7651-4ef9-99b6-15e6a079caea">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-12-04T20:53:06.000+09:00","dateModified":"2020-12-06T07:00:26.000+09:00","headline":"【Unity(C#)】Mirrorで同期通信①　マッチング機能","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRVlc1cGRIa29ReU1wNDRDUlRXbHljbTl5NDRHbjVaQ001cHlmNllDYTVMLWg0cEdnNDRDQTQ0T2U0NE9ENDRPQjQ0T3o0NEt3NXFtZjZJTzkmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9MzA0NGU2M2I2MTJhNDc0YmMxY2FkZGJkMzRhNzA5YWU\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRTlMYzJGcGVXOTNZUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTdjYzAxMTRmZDliOTFlMzkzMGY3MTUyY2QzMmJjNWJi\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=e26ff73fbcb713ee190a2d1865c26e1b","mainEntityOfPage":"https://qiita.com/OKsaiyowa/items/ecef8e5d50c84664f2a2","author":{"@type":"Person","address":"","email":null,"identifier":"OKsaiyowa","name":"OKsaiyowa","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F244071%2Fbae8dc3d07d0e3470f1689dbf348860d57405186%2Flarge.png%3F1590752982?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1db3c0b8d02da57022d0bbed7e449028","url":"https://qiita.com/OKsaiyowa","description":"備忘録として学んだことを記録します。 あやふやな箇所が多いですが、そんなときはビシッと指摘いただけますと幸いです。(特に明示されていない場合、記事中のソースコードはパブリックドメインです。)","memberOf":[{"@type":"Organization","address":"オンライン@Slack","legalName":"Unityゲーム開発者ギルド","image":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/5e3ba3bb442371003e6b5d4618ef627b9b478357/original.jpg?1570216541","logo":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/f7eb993765ddcdb2c5e6890556c43ea3de8fbfb7/original.jpg?1570215690","identifier":"unity-game-dev-guild","description":"趣味・仕事問わずUnityでゲームを作っている開発者のみで構成されるオンラインコミュニティです。Unityでゲームを開発・運用するにあたって必要なあらゆる知見を共有することを目的とします。"}]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"OKsaiyowa","type":"items","id":"ecef8e5d50c84664f2a2"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"OKsaiyowa","type":"items","id":"ecef8e5d50c84664f2a2"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"OKsaiyowa","type":"items","id":"ecef8e5d50c84664f2a2"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/OKsaiyowa/items/ecef8e5d50c84664f2a2","location":"/OKsaiyowa/items/ecef8e5d50c84664f2a2","scheme":"https","host":"qiita.com","port":null,"pathname":"/OKsaiyowa/items/ecef8e5d50c84664f2a2","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"nizEIZAc9FE8iYg+Wh2PVfz4c57VL0OcklTCk/t22DgN54Im0NtcUHZJ1s37Kvy9kVVg3r5Q3PNx1rA2k0rbOQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-bcf0417c-31d5-4780-9303-f86144496144"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2/likers" class="css-1iupg5d">11</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">7</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/ecef8e5d50c84664f2a2/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2020/unity2" class="it-AdcalRibbon_title">Unity #2<!-- --> Advent Calendar<!-- --> <!-- -->2020</a>Day 6</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/OKsaiyowa"><img class="css-100alwu eyfquo10" src="https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/244071/bae8dc3d07d0e3470f1689dbf348860d57405186/large.png?1590752982" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/OKsaiyowa" class="css-10ougpm">@<!-- -->OKsaiyowa</a><div class="css-1ay9vb9"><span><meta content="2020-12-04T11:53:06Z"/><time dateTime="2020-12-05T22:00:26Z" class="css-m19uds">updated at 2020-12-05</time></span></div></div></div></div></div><h1 class="css-cgzq40">【Unity(C#)】Mirrorで同期通信①　マッチング機能</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/mirror" class="css-4czcte">mirror</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h2>
<span id="unity-2-advent-calendar-2020" class="fragment"></span><a href="#unity-2-advent-calendar-2020"><i class="fa fa-link"></i></a>Unity #2 Advent Calendar 2020</h2>

<p>こちらは <a href="https://qiita.com/advent-calendar/2020/unity2">Unity #2 Advent Calendar 2020</a> の 6日目の記事です。</p>

<h2>
<span id="mirror" class="fragment"></span><a href="#mirror"><i class="fa fa-link"></i></a>Mirror</h2>

<p>オープンソースのネットワークライブラリ(<a href="https://assetstore.unity.com/packages/tools/network/mirror-129321?locale=ja-JP&amp;aid=1100l3q4P&amp;utm_source=twitter&amp;utm_medium=social&amp;utm_campaign=jp-advent-calendar-summer" rel="nofollow noopener" target="_blank">アセット</a>)です。</p>

<p>プレイヤーのマッチングに公式サーバーが必要ないので<br>
同一LAN内が担保されていれば接続が可能です。</p>

<p>当然、サーバーをゴリゴリ頑張れば自前運用も可能です。</p>

<p>【参考リンク】：<a href="https://am1tanaka.hatenablog.com/entry/mirrorzakkuri" rel="nofollow noopener" target="_blank">無料で使えるネットライブラリMirrorのざっくり紹介</a></p>

<p><a href="https://discord.gg/N9QVxbM" rel="nofollow noopener" target="_blank">公式Discord</a>に参加してみましたが、<br>
アップデートが頻繁に行われているのもあってか、<br>
実装上の質問も飛び交って賑やかでした。(全部英語です)</p>

<h2>
<span id="今回やること" class="fragment"></span><a href="#%E4%BB%8A%E5%9B%9E%E3%82%84%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>今回やること</h2>

<p><strong>①同一LAN内のサーバー(ホスト)を検索<br>
②サーバーが見つかればクライアントとして接続、なければ自身がサーバー(ホスト)になる<br>
③サーバー(ホスト)がマッチングを確認し、ゲームを開始する<br>
④サーバー(ホスト)、各クライアント、共にシーン遷移する</strong></p>

<p>一言でまとめるとオートマッチングシステムを作ります。</p>

<h2>
<span id="バージョン" class="fragment"></span><a href="#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>バージョン</h2>

<p>Unity 2019.4.8f1<br>
Mirror 26.2.2<br>
UniTask.2.0.18</p>

<h2>
<span id="デモ" class="fragment"></span><a href="#%E3%83%87%E3%83%A2"><i class="fa fa-link"></i></a>デモ</h2>

<p>左上が自動でホストになり、残りの3画面がクライアントとして接続を試みます。<br>
<a href="https://camo.qiitausercontent.com/f39821f6c8e1cf6ad29e8053013e7906e977a785/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3234343037312f39356237626435662d316430302d336534352d366332632d3962383839333462333666362e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/244071/95b7bd5f-1d00-3e45-6c2c-9b88934b36f6.gif" alt="MirrorForQiita1.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/244071/95b7bd5f-1d00-3e45-6c2c-9b88934b36f6.gif" loading="lazy"></a></p>

<p>同一LAN内が前提なのでIPアドレスの入力などは省略できます。</p>

<h2>
<span id="コードcustomnetworkdiscovery-" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89customnetworkdiscovery-"><i class="fa fa-link"></i></a>コード(CustomNetworkDiscovery )</h2>

<p>まずはサーバーを検索し、接続するための処理を担うコードです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Cysharp.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Mirror</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Mirror.Discovery</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UI</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// サーバー検索、接続</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CustomNetworkDiscovery</span> <span class="p">:</span> <span class="n">NetworkDiscovery</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Button</span> <span class="n">_multiPlayButton</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Button</span> <span class="n">_backButton</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Button</span> <span class="n">_playButton</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Text</span> <span class="n">_playerCountText</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="n">Text</span> <span class="n">_connectionStateText</span><span class="p">;</span>
    <span class="c1">//SceneのアトリビュートはMirrorに用意されている便利機能</span>
    <span class="c1">//Inspectorでシーンを参照してコード内で文字列として使用できる</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">,</span><span class="n">Scene</span><span class="p">]</span> <span class="k">private</span> <span class="kt">string</span> <span class="n">_gameSceneName</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">ServerResponse</span> <span class="n">_discoveredServer</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">CancellationTokenSource</span> <span class="n">_cancellationTokenSource</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">CONNECT_INTERVAL_TIME</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">WAIT_TIME</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">CONNECT_TRY_COUNT</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">CONNECTION_STATUS_CLIENT_WAITING</span> <span class="p">=</span> <span class="s">"Waiting start..."</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">CONNECTION_STATUS_HOST_WAITING</span> <span class="p">=</span> <span class="s">"Waiting other player..."</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">CONNECTION_STATUS_SUCCESS</span> <span class="p">=</span> <span class="s">"Success!"</span><span class="p">;</span>

    <span class="k">private</span> <span class="kt">bool</span> <span class="n">_isHostReady</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">NetworkManager</span> <span class="n">_networkManager</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//シーン遷移などで破棄されたタイミングで検索をやめる</span>
        <span class="nf">StopDiscovery</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//データ受信の準備</span>
        <span class="n">NetworkClient</span><span class="p">.</span><span class="n">RegisterHandler</span><span class="p">&lt;</span><span class="n">SendHostReadyData</span><span class="p">&gt;(</span><span class="n">ReceivedReadyInfo</span><span class="p">);</span>
        <span class="n">NetworkClient</span><span class="p">.</span><span class="n">RegisterHandler</span><span class="p">&lt;</span><span class="n">SendPlayerCountData</span><span class="p">&gt;(</span><span class="n">ReceivedPlayerCountInfo</span><span class="p">);</span>

        <span class="c1">//サーバー見つけたらこれが呼ばれる</span>
        <span class="n">OnServerFound</span><span class="p">.</span><span class="nf">AddListener</span><span class="p">(</span><span class="n">serverResponse</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="c1">//見つけたサーバーを辞書に登録</span>
            <span class="n">_discoveredServer</span> <span class="p">=</span> <span class="n">serverResponse</span><span class="p">;</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"ServerFound"</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="c1">//サーバーの検索＆接続開始</span>
        <span class="n">_multiPlayButton</span><span class="p">.</span><span class="n">onClick</span><span class="p">.</span><span class="nf">AddListener</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Search Connection"</span><span class="p">);</span>
            <span class="n">_backButton</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="n">_multiPlayButton</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

            <span class="c1">//接続を試みる</span>
            <span class="n">_cancellationTokenSource</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CancellationTokenSource</span><span class="p">();</span>
            <span class="n">CancellationToken</span> <span class="n">token</span> <span class="p">=</span> <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">;</span>
            <span class="nf">TryConnectAsync</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nf">Forget</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="c1">//最初の画面に戻る</span>
        <span class="n">_backButton</span><span class="p">.</span><span class="n">onClick</span><span class="p">.</span><span class="nf">AddListener</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Cancel"</span><span class="p">);</span>

            <span class="c1">//サーバーから抜ける</span>
            <span class="c1">//サーバーの検索停止</span>
            <span class="nf">StopDiscovery</span><span class="p">();</span>
            <span class="n">NetworkManager</span><span class="p">.</span><span class="n">singleton</span><span class="p">.</span><span class="nf">StopHost</span><span class="p">();</span>

            <span class="c1">//非同期処理止める</span>
            <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">();</span>
            <span class="n">_cancellationTokenSource</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>

        <span class="p">});</span>

        <span class="c1">//ホスト側にのみ表示されるボタン プレイボタン押下で準備完了とする</span>
        <span class="n">_playButton</span><span class="p">.</span><span class="n">onClick</span><span class="p">.</span><span class="nf">AddListener</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Ready Ok"</span><span class="p">);</span>
            <span class="c1">//各クライアントにフラグデータを送る</span>
            <span class="n">SendHostReadyData</span> <span class="n">sendData</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendHostReadyData</span><span class="p">()</span> <span class="p">{</span><span class="n">IsHostReady</span> <span class="p">=</span> <span class="k">true</span><span class="p">};</span>
            <span class="n">NetworkServer</span><span class="p">.</span><span class="nf">SendToAll</span><span class="p">(</span><span class="n">sendData</span><span class="p">);</span>

            <span class="n">_playButton</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// サーバーから受け取ったデータを各クライアントで使う</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="conn"&gt;コネクション情報　関数内で使ってないけど必要みたい&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="receivedData"&gt;受け取ったデータ&lt;/param&gt;</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">ReceivedReadyInfo</span><span class="p">(</span><span class="n">NetworkConnection</span> <span class="n">conn</span><span class="p">,</span> <span class="n">SendHostReadyData</span> <span class="n">receivedData</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ローカルのフラグに反映</span>
        <span class="n">_isHostReady</span> <span class="p">=</span> <span class="n">receivedData</span><span class="p">.</span><span class="n">IsHostReady</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// サーバーから受け取ったデータを各クライアントで使う</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="conn"&gt;コネクション情報　関数内で使ってないけど必要みたい&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="receivedData"&gt;受け取ったデータ&lt;/param&gt;</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">ReceivedPlayerCountInfo</span><span class="p">(</span><span class="n">NetworkConnection</span> <span class="n">conn</span><span class="p">,</span> <span class="n">SendPlayerCountData</span> <span class="n">receivedData</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_playButton</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">_playerCountText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">receivedData</span><span class="p">.</span><span class="n">PlayerCount</span> <span class="p">+</span> <span class="s">"/"</span> <span class="p">+</span> <span class="n">_networkManager</span><span class="p">.</span><span class="n">maxConnections</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 接続を試みる</span>
    <span class="c1">/// 非同期</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">async</span> <span class="n">UniTaskVoid</span> <span class="nf">TryConnectAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_networkManager</span> <span class="p">=</span> <span class="n">NetworkManager</span><span class="p">.</span><span class="n">singleton</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">tryCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="c1">//サーバーの検索開始</span>
        <span class="nf">StartDiscovery</span><span class="p">();</span>

        <span class="c1">//サーバーに接続するまでループ</span>
        <span class="k">while</span> <span class="p">(!</span><span class="n">_networkManager</span><span class="p">.</span><span class="n">isNetworkActive</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//n秒間隔で実行</span>
            <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="n">CONNECT_INTERVAL_TIME</span><span class="p">),</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>

            <span class="c1">//サーバー発見した場合</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_discoveredServer</span><span class="p">.</span><span class="n">uri</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Start Client"</span><span class="p">);</span>
                <span class="c1">//クライアントとして接続開始</span>
                <span class="n">_networkManager</span><span class="p">.</span><span class="nf">StartClient</span><span class="p">(</span><span class="n">_discoveredServer</span><span class="p">.</span><span class="n">uri</span><span class="p">);</span>
                <span class="c1">//接続ステータスの文言変更</span>
                <span class="n">_connectionStateText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span><span class="n">CONNECTION_STATUS_CLIENT_WAITING</span><span class="p">;</span>
                <span class="c1">//サーバーの検索停止</span>
                <span class="nf">StopDiscovery</span><span class="p">();</span>
                <span class="c1">//ここでホストの開始フラグを待つ</span>
                <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">WaitUntil</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">_isHostReady</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
                <span class="c1">//接続ステータスの文言変更</span>
                <span class="n">_connectionStateText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">CONNECTION_STATUS_SUCCESS</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//サーバー見つからない場合</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Try Connect..."</span><span class="p">);</span>

                <span class="c1">//接続を試みた回数をカウントアップ</span>
                <span class="n">tryCount</span><span class="p">++;</span>

                <span class="c1">//任意の回数以上接続に試みて失敗した場合は自身がホストになる</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tryCount</span> <span class="p">&gt;</span> <span class="n">CONNECT_TRY_COUNT</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Start Host"</span><span class="p">);</span>

                    <span class="c1">//ホストになる(サーバー)</span>
                    <span class="n">_networkManager</span><span class="p">.</span><span class="nf">StartHost</span><span class="p">();</span>
                    <span class="c1">//サーバーあるよーってお知らせする</span>
                    <span class="nf">AdvertiseServer</span><span class="p">();</span>

                    <span class="c1">//接続ステータスの文言変更</span>
                    <span class="n">_connectionStateText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">CONNECTION_STATUS_HOST_WAITING</span><span class="p">;</span>

                    <span class="c1">//プレイボタン表示</span>
                    <span class="n">_playButton</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

                    <span class="c1">//ここでホストの開始フラグを待つ</span>
                    <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">WaitUntil</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">_isHostReady</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
                    <span class="c1">//接続ステータスの文言変更</span>
                    <span class="n">_connectionStateText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">CONNECTION_STATUS_SUCCESS</span><span class="p">;</span>
                    <span class="c1">//n秒待つ</span>
                    <span class="k">await</span> <span class="n">UniTask</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="n">WAIT_TIME</span><span class="p">),</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">token</span><span class="p">);</span>
                    <span class="c1">//シーン遷移</span>
                    <span class="n">_networkManager</span><span class="p">.</span><span class="nf">ServerChangeScene</span><span class="p">(</span><span class="n">_gameSceneName</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr>

<h3>
<span id="networkdiscovery" class="fragment"></span><a href="#networkdiscovery"><i class="fa fa-link"></i></a>NetworkDiscovery</h3>

<p>サーバーを検索、もしくはサーバーが自身の存在を通知する機能を持ちます。</p>

<p><code>NetworkDiscovery</code>はそのまま使用することもできますが、<br>
UIをカスタマイズしたかったり、<br>
シーン遷移時のフェードアニメーションなどを追加したかったりする場合には<br>
カスタムしないと難しいです。</p>

<p>そのために継承して利用しています。</p>

<p><code>StartDiscovery</code>,<code>StopDiscovery</code>,<code>AdvertiseServer</code>などは<br>
<code>NetworkDiscovery</code>の機能に当たります。</p>

<p>これらの機能は名前のまんまです。<br>
ただし、シーン遷移時にしっかりとサーバーの検索、通知を停止させないと<br>
サーバーは停止しているのにレスポンスだけは返ってくるという謎の減少が起きるので<br>
<code>OnDestroy</code>で確実に<code>StopDiscovery</code>するのが安全だと思います。</p>

<hr>

<h3>
<span id="networkserversendtoall" class="fragment"></span><a href="#networkserversendtoall"><i class="fa fa-link"></i></a>NetworkServer.SendToAll</h3>

<p>サーバー内のすべてのクライアント(ホスト含む)に引数で指定したデータを送信します。</p>

<p><code>CustomNetworkDiscovery</code>内ではホストがプレイボタンを押したことを各クライアントに通知しています。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>   <span class="c1">//ホスト側にのみ表示されるボタン プレイボタン押下で準備完了とする</span>
   <span class="n">_playButton</span><span class="p">.</span><span class="n">onClick</span><span class="p">.</span><span class="nf">AddListener</span><span class="p">(()</span> <span class="p">=&gt;</span>
   <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Ready Ok"</span><span class="p">);</span>
        <span class="c1">//各クライアントにフラグデータを送る</span>
        <span class="n">SendHostReadyData</span> <span class="n">sendData</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendHostReadyData</span><span class="p">()</span> <span class="p">{</span><span class="n">IsHostReady</span> <span class="p">=</span> <span class="k">true</span><span class="p">};</span>
        <span class="n">NetworkServer</span><span class="p">.</span><span class="nf">SendToAll</span><span class="p">(</span><span class="n">sendData</span><span class="p">);</span>

        <span class="n">_playButton</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
   <span class="p">});</span>
</code></pre></div></div>

<hr>

<h3>
<span id="networkclientregisterhandler" class="fragment"></span><a href="#networkclientregisterhandler"><i class="fa fa-link"></i></a>NetworkClient.RegisterHandler</h3>

<p>先ほどの<code>SendToAll</code>でデータが送られてきたことを検知し、<br>
各クライアントでデータの受信時に行いたい処理を登録できます。</p>

<p>(引数の<code>NetworkConnection</code>は別になくても動きます。)</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>
<span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//データ受信の準備</span>
    <span class="n">NetworkClient</span><span class="p">.</span><span class="n">RegisterHandler</span><span class="p">&lt;</span><span class="n">SendHostReadyData</span><span class="p">&gt;(</span><span class="n">ReceivedReadyInfo</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// サーバーから受け取ったデータを各クライアントで使う</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="c1">/// &lt;param name="conn"&gt;コネクション情報　関数内で使ってないけど必要みたい&lt;/param&gt;</span>
<span class="c1">/// &lt;param name="receivedData"&gt;受け取ったデータ&lt;/param&gt;</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">ReceivedReadyInfo</span><span class="p">(</span><span class="n">NetworkConnection</span> <span class="n">conn</span><span class="p">,</span> <span class="n">SendHostReadyData</span> <span class="n">receivedData</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//ローカルのフラグに反映</span>
    <span class="n">_isHostReady</span> <span class="p">=</span> <span class="n">receivedData</span><span class="p">.</span><span class="n">IsHostReady</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>やり取りするデータも別途定義が必要となります。<br>
<code>NetworkMessage</code>というインターフェースを実装することで<br>
やり取りが可能なデータとなります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Mirror</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// 送信するデータ</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">SendHostReadyData</span> <span class="p">:</span> <span class="n">NetworkMessage</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// ホストが準備できたかどうか</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsHostReady</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="コードcustomnetworkmanager" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89customnetworkmanager"><i class="fa fa-link"></i></a>コード(CustomNetworkManager)</h2>

<p>次に接続にまつわるコードです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">Mirror</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.SceneManagement</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// 接続にまつわるいろいろ</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CustomNetworkManager</span> <span class="p">:</span> <span class="n">NetworkManager</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">,</span><span class="n">Scene</span><span class="p">]</span> <span class="k">private</span> <span class="kt">string</span> <span class="n">_titleScene</span><span class="p">;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">,</span><span class="n">Scene</span><span class="p">]</span> <span class="k">private</span> <span class="kt">string</span> <span class="n">_mainScene</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">Transform</span> <span class="n">_playerTransform</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Material</span> <span class="n">_playerMaterial</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// プレイヤー入室時にサーバー側が実行</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="conn"&gt;接続されたプレイヤーのコネクション&lt;/param&gt;</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnServerAddPlayer</span><span class="p">(</span><span class="n">NetworkConnection</span> <span class="n">conn</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Add Player"</span><span class="p">);</span>

        <span class="c1">//タイトルシーンでのみ実行</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_titleScene</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">SceneManager</span><span class="p">.</span><span class="nf">GetActiveScene</span><span class="p">().</span><span class="n">name</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">//接続中の人数表記を変える</span>
            <span class="n">SendPlayerCountData</span> <span class="n">sendData</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendPlayerCountData</span><span class="p">()</span> <span class="p">{</span><span class="n">PlayerCount</span> <span class="p">=</span> <span class="n">NetworkServer</span><span class="p">.</span><span class="n">connections</span><span class="p">.</span><span class="n">Count</span><span class="p">};</span>
            <span class="n">NetworkServer</span><span class="p">.</span><span class="nf">SendToAll</span><span class="p">(</span><span class="n">sendData</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//メインシーンでのみ実行</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_mainScene</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">SceneManager</span><span class="p">.</span><span class="nf">GetActiveScene</span><span class="p">().</span><span class="n">name</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Spawn Player"</span><span class="p">);</span>
            <span class="c1">//プレイヤー生成</span>
            <span class="n">GameObject</span> <span class="n">player</span> <span class="p">=</span> <span class="nf">Instantiate</span><span class="p">(</span><span class="n">playerPrefab</span><span class="p">);</span>
            <span class="c1">//今立ち上げているサーバーにプレイヤーを追加登録</span>
            <span class="n">NetworkServer</span><span class="p">.</span><span class="nf">AddPlayerForConnection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">player</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 各プレイヤー退室時にサーバー側が実行</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="conn"&gt;切れたコネクション&lt;/param&gt;</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnServerDisconnect</span><span class="p">(</span><span class="n">NetworkConnection</span> <span class="n">conn</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//接続中の人数表記を変える</span>
        <span class="n">SendPlayerCountData</span> <span class="n">sendData</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendPlayerCountData</span><span class="p">()</span> <span class="p">{</span><span class="n">PlayerCount</span> <span class="p">=</span> <span class="n">NetworkServer</span><span class="p">.</span><span class="n">connections</span><span class="p">.</span><span class="n">Count</span><span class="p">};</span>
        <span class="n">NetworkServer</span><span class="p">.</span><span class="nf">SendToAll</span><span class="p">(</span><span class="n">sendData</span><span class="p">);</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Anyone Disconnect"</span><span class="p">);</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">OnServerDisconnect</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// サーバーとの接続が切れた時にクライアント側で呼ばれる</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnStopClient</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">SceneManager</span><span class="p">.</span><span class="nf">LoadScene</span><span class="p">(</span><span class="n">_titleScene</span><span class="p">);</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Disconnect"</span><span class="p">);</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">OnStopClient</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr>

<h3>
<span id="networkmanager" class="fragment"></span><a href="#networkmanager"><i class="fa fa-link"></i></a>NetworkManager</h3>

<p>文字通りネットワークにまつわるいろいろを担います。</p>

<blockquote>
<p>The Network Manager is a component for managing the networking aspects of a multiplayer game.</p>
</blockquote>

<p>引用：<a href="https://mirror-networking.com/docs/Articles/Components/NetworkManager.html" rel="nofollow noopener" target="_blank">Network Manager</a></p>

<p>これもあまりそのまま使う想定のものではないので、<br>
継承してメソッドをオーバーライドしてカスタムします。</p>

<p>コールバック含め、大量に機能があるので今回使ったものだけ解説します。</p>

<hr>

<h3>
<span id="starthost-startclient-stophost" class="fragment"></span><a href="#starthost-startclient-stophost"><i class="fa fa-link"></i></a>StartHost, StartClient, StopHost</h3>

<p>接続にまつわる関数です。<br>
<code>StartHost</code>を実行した場合、サーバーとクライアントの両方の役割を持つことになります。</p>

<p><code>StartClient</code>は引数に指定したアドレスのサーバーにクライアントとして接続します。</p>

<p><code>StopHost</code>は自身がサーバーならサーバーの接続を中断し、<br>
クライアントならサーバーから抜けます。</p>

<p><code>NetworkManager</code>はシングルトンとなっており、<br>
インスタンスをどこからでも呼び出せます。</p>

<p><code>StartHost</code>, <code>StartClient</code>, <code>StopHost</code>は全て<code>Public</code>な関数なので、<br>
これらもどこからでも呼び出せるってことです。</p>

<p>今回はサーバーの検索を担う、<code>CustomNetworkDiscovery</code>で接続にまつわる関数を呼び出しています。</p>

<p>そうすることで、<br>
<strong>・LAN内にサーバーが見つかったら→StartClient<br>
・LAN内にサーバーが見つからなかったら→StartHost</strong><br>
のように同一LAN内で自動でマッチングする仕組みを作れます。</p>

<hr>

<h3>
<span id="onstopclient" class="fragment"></span><a href="#onstopclient"><i class="fa fa-link"></i></a>OnStopClient</h3>

<p>クライアントがサーバーから切断された場合に各クライアントで呼び出されます。</p>

<p>このコールバックの中でシーン遷移を呼び出すことで<br>
切断→シーン遷移　という処理が可能となります。</p>

<p>すなわち、接続状態にあるクライアントで<code>StopHost</code>を呼び出せば<br>
下記処理が呼ばれるということです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code> <span class="c1">/// &lt;summary&gt;</span>
 <span class="c1">/// サーバーとの接続が切れた時にクライアント側で呼ばれる</span>
 <span class="c1">/// &lt;/summary&gt;</span>
 <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnStopClient</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="n">SceneManager</span><span class="p">.</span><span class="nf">LoadScene</span><span class="p">(</span><span class="n">_titleScene</span><span class="p">);</span>
     <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Disconnect"</span><span class="p">);</span>
     <span class="k">base</span><span class="p">.</span><span class="nf">OnStopClient</span><span class="p">();</span>
 <span class="p">}</span>
</code></pre></div></div>

<hr>

<h3>
<span id="onserveraddplayer" class="fragment"></span><a href="#onserveraddplayer"><i class="fa fa-link"></i></a>OnServerAddPlayer</h3>

<p>Mirrorにはプレイヤーという概念があります。<br>
誤解を恐れずに簡単にまとめると<br>
サーバーに接続したクライアントのことをプレイヤーと呼び、接続時にサーバーに追加されます。</p>

<p>この<code>OnServerAddPlayer</code>はプレイヤーが追加された際に呼び出される処理です。</p>

<p>デモにおける接続された人数の表記の変更の通知(プレイヤー増加時)は<code>OnServerAddPlayer</code>で行っています。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// プレイヤー入室時にサーバー側が実行</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="conn"&gt;接続されたプレイヤーのコネクション&lt;/param&gt;</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnServerAddPlayer</span><span class="p">(</span><span class="n">NetworkConnection</span> <span class="n">conn</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Add Player"</span><span class="p">);</span>

        <span class="c1">//タイトルシーンでのみ実行</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_titleScene</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">SceneManager</span><span class="p">.</span><span class="nf">GetActiveScene</span><span class="p">().</span><span class="n">name</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">//接続中の人数表記を変える</span>
            <span class="n">SendPlayerCountData</span> <span class="n">sendData</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SendPlayerCountData</span><span class="p">()</span> <span class="p">{</span><span class="n">PlayerCount</span> <span class="p">=</span> <span class="n">NetworkServer</span><span class="p">.</span><span class="n">connections</span><span class="p">.</span><span class="n">Count</span><span class="p">};</span>
            <span class="n">NetworkServer</span><span class="p">.</span><span class="nf">SendToAll</span><span class="p">(</span><span class="n">sendData</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//メインシーンでのみ実行</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_mainScene</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">SceneManager</span><span class="p">.</span><span class="nf">GetActiveScene</span><span class="p">().</span><span class="n">name</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Spawn Player"</span><span class="p">);</span>
            <span class="c1">//プレイヤー生成</span>
            <span class="n">GameObject</span> <span class="n">player</span> <span class="p">=</span> <span class="nf">Instantiate</span><span class="p">(</span><span class="n">playerPrefab</span><span class="p">);</span>
            <span class="c1">//今立ち上げているサーバーにプレイヤーを追加登録</span>
            <span class="n">NetworkServer</span><span class="p">.</span><span class="nf">AddPlayerForConnection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">player</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>また、プレイヤーを概念ではなく、実体として生成する場合もあるかと思います。</p>

<p>その場合、<code>OnServerAddPlayer</code>でInstantiateしてあげれば<br>
各クライアントにプレイヤーが生成されます。</p>

<p>ただし、この機能を利用するには<br>
Inspectorの<code>PlayerPrefab</code>に<code>NetworkIdentity</code>が付与されたPrefabを<br>
事前に登録しておく必要があります。</p>

<p><a href="https://camo.qiitausercontent.com/3cdad1cdec88610f820b6cb09ae1b7af7a4ab3dc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3234343037312f61633735353534352d613636622d356232662d666462352d3034386237666337356339362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F244071%2Fac755545-a66b-5b2f-fdb5-048b7fc75c96.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5a8c61513916d21054a3d5ae4d7b5f27" alt="PlayerPrefabSS.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/244071/ac755545-a66b-5b2f-fdb5-048b7fc75c96.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F244071%2Fac755545-a66b-5b2f-fdb5-048b7fc75c96.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f51f1ba992b32c866649a7b3bc216c5c 1x" loading="lazy"></a></p>

<h2>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h2>

<p>詳しくは知りませんがUNETという機能？がひと昔前にあったそうで、<br>
それを改良したのがMirrorのようです。</p>

<p>結構なビッグタイトルに採用されているようですが、<br>
ドキュメント以外の情報がなかなか無いので苦労しました。</p>

<p>私の今の力では及びませんがサーバー側の実装とかもいずれできるようになりたいです。</p>

<p>(UniTaskの実装は見よう見真似でやったので間違ってたら教えてください。)</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FOKsaiyowa%2Fitems%2Fecef8e5d50c84664f2a2&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FOKsaiyowa%2Fitems%2Fecef8e5d50c84664f2a2&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2/likers" class="css-1iupg5d">11</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">7</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/ecef8e5d50c84664f2a2/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/OKsaiyowa/items/ecef8e5d50c84664f2a2.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-bcf0417c-31d5-4780-9303-f86144496144">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-914c24b9-1978-4d1a-8d05-9f8e7db5485d"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-914c24b9-1978-4d1a-8d05-9f8e7db5485d">{}</script>
      
<div id="LoginModal-react-component-7f93bb0d-40eb-4f22-9202-a26eaa639a52"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-7f93bb0d-40eb-4f22-9202-a26eaa639a52">{}</script>
      
<div id="StockModal-react-component-6ae59e41-a741-4045-8e60-265dfacf2102"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-6ae59e41-a741-4045-8e60-265dfacf2102">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;0mEvGOPiWCc/ZXL5UwQnewfBAlaWQBfgBY4TaMWeOe1BqmkfoyXwJnWlLAryM1STamwRFv0/iI/mDGHNraI67A==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch2\u003e\n\u003cspan id=\"unity-2-advent-calendar-2020\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unity-2-advent-calendar-2020\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUnity #2 Advent Calendar 2020\u003c/h2\u003e\n\n\u003cp\u003eこちらは \u003ca href=\"https://qiita.com/advent-calendar/2020/unity2\"\u003eUnity #2 Advent Calendar 2020\u003c/a\u003e の 6日目の記事です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"mirror\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#mirror\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eMirror\u003c/h2\u003e\n\n\u003cp\u003eオープンソースのネットワークライブラリ(\u003ca href=\"https://assetstore.unity.com/packages/tools/network/mirror-129321?locale=ja-JP\u0026amp;aid=1100l3q4P\u0026amp;utm_source=twitter\u0026amp;utm_medium=social\u0026amp;utm_campaign=jp-advent-calendar-summer\" rel=\"nofollow noopener\" target=\"_blank\"\u003eアセット\u003c/a\u003e)です。\u003c/p\u003e\n\n\u003cp\u003eプレイヤーのマッチングに公式サーバーが必要ないので\u003cbr\u003e\n同一LAN内が担保されていれば接続が可能です。\u003c/p\u003e\n\n\u003cp\u003e当然、サーバーをゴリゴリ頑張れば自前運用も可能です。\u003c/p\u003e\n\n\u003cp\u003e【参考リンク】：\u003ca href=\"https://am1tanaka.hatenablog.com/entry/mirrorzakkuri\" rel=\"nofollow noopener\" target=\"_blank\"\u003e無料で使えるネットライブラリMirrorのざっくり紹介\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://discord.gg/N9QVxbM\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式Discord\u003c/a\u003eに参加してみましたが、\u003cbr\u003e\nアップデートが頻繁に行われているのもあってか、\u003cbr\u003e\n実装上の質問も飛び交って賑やかでした。(全部英語です)\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"今回やること\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BB%8A%E5%9B%9E%E3%82%84%E3%82%8B%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e今回やること\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003e①同一LAN内のサーバー(ホスト)を検索\u003cbr\u003e\n②サーバーが見つかればクライアントとして接続、なければ自身がサーバー(ホスト)になる\u003cbr\u003e\n③サーバー(ホスト)がマッチングを確認し、ゲームを開始する\u003cbr\u003e\n④サーバー(ホスト)、各クライアント、共にシーン遷移する\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e一言でまとめるとオートマッチングシステムを作ります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"バージョン\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eバージョン\u003c/h2\u003e\n\n\u003cp\u003eUnity 2019.4.8f1\u003cbr\u003e\nMirror 26.2.2\u003cbr\u003e\nUniTask.2.0.18\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"デモ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%A2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデモ\u003c/h2\u003e\n\n\u003cp\u003e左上が自動でホストになり、残りの3画面がクライアントとして接続を試みます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f39821f6c8e1cf6ad29e8053013e7906e977a785/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3234343037312f39356237626435662d316430302d336534352d366332632d3962383839333462333666362e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/244071/95b7bd5f-1d00-3e45-6c2c-9b88934b36f6.gif\" alt=\"MirrorForQiita1.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/244071/95b7bd5f-1d00-3e45-6c2c-9b88934b36f6.gif\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e同一LAN内が前提なのでIPアドレスの入力などは省略できます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"コードcustomnetworkdiscovery-\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%89customnetworkdiscovery-\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコード(CustomNetworkDiscovery )\u003c/h2\u003e\n\n\u003cp\u003eまずはサーバーを検索し、接続するための処理を担うコードです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eCysharp.Threading.Tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMirror\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMirror.Discovery\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UI\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// サーバー検索、接続\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomNetworkDiscovery\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eNetworkDiscovery\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eButton\u003c/span\u003e \u003cspan class=\"n\"\u003e_multiPlayButton\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eButton\u003c/span\u003e \u003cspan class=\"n\"\u003e_backButton\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eButton\u003c/span\u003e \u003cspan class=\"n\"\u003e_playButton\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"n\"\u003e_playerCountText\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"n\"\u003e_connectionStateText\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//SceneのアトリビュートはMirrorに用意されている便利機能\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//Inspectorでシーンを参照してコード内で文字列として使用できる\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eScene\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_gameSceneName\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eServerResponse\u003c/span\u003e \u003cspan class=\"n\"\u003e_discoveredServer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eCancellationTokenSource\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eCONNECT_INTERVAL_TIME\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eWAIT_TIME\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eCONNECT_TRY_COUNT\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eCONNECTION_STATUS_CLIENT_WAITING\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Waiting start...\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eCONNECTION_STATUS_HOST_WAITING\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Waiting other player...\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eCONNECTION_STATUS_SUCCESS\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Success!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003e_isHostReady\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNetworkManager\u003c/span\u003e \u003cspan class=\"n\"\u003e_networkManager\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//シーン遷移などで破棄されたタイミングで検索をやめる\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStopDiscovery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAwake\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//データ受信の準備\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eNetworkClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSendHostReadyData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eReceivedReadyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eNetworkClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSendPlayerCountData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eReceivedPlayerCountInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//サーバー見つけたらこれが呼ばれる\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eOnServerFound\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserverResponse\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//見つけたサーバーを辞書に登録\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_discoveredServer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eserverResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ServerFound\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//サーバーの検索＆接続開始\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_multiPlayButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eonClick\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Search Connection\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_backButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egameObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetActive\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_multiPlayButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egameObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetActive\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//接続を試みる\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToken\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eTryConnectAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eForget\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//最初の画面に戻る\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_backButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eonClick\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Cancel\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//サーバーから抜ける\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//サーバーの検索停止\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eStopDiscovery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNetworkManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esingleton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStopHost\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//非同期処理止める\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCancel\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_cancellationTokenSource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//ホスト側にのみ表示されるボタン プレイボタン押下で準備完了とする\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_playButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eonClick\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Ready Ok\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//各クライアントにフラグデータを送る\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eSendHostReadyData\u003c/span\u003e \u003cspan class=\"n\"\u003esendData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendHostReadyData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eIsHostReady\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendToAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendData\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003e_playButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egameObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetActive\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// サーバーから受け取ったデータを各クライアントで使う\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"conn\"\u0026gt;コネクション情報　関数内で使ってないけど必要みたい\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"receivedData\"\u0026gt;受け取ったデータ\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eReceivedReadyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNetworkConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSendHostReadyData\u003c/span\u003e \u003cspan class=\"n\"\u003ereceivedData\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//ローカルのフラグに反映\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_isHostReady\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereceivedData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsHostReady\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// サーバーから受け取ったデータを各クライアントで使う\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"conn\"\u0026gt;コネクション情報　関数内で使ってないけど必要みたい\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"receivedData\"\u0026gt;受け取ったデータ\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eReceivedPlayerCountInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNetworkConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSendPlayerCountData\u003c/span\u003e \u003cspan class=\"n\"\u003ereceivedData\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_playButton\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_playerCountText\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereceivedData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayerCount\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\"/\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003e_networkManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emaxConnections\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// 接続を試みる\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// 非同期\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTaskVoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eTryConnectAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCancellationToken\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_networkManager\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNetworkManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esingleton\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etryCount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//サーバーの検索開始\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStartDiscovery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//サーバーに接続するまでループ\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003e_networkManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisNetworkActive\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//n秒間隔で実行\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCONNECT_INTERVAL_TIME\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//サーバー発見した場合\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_discoveredServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euri\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Start Client\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//クライアントとして接続開始\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_networkManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_discoveredServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003euri\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//接続ステータスの文言変更\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_connectionStateText\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eCONNECTION_STATUS_CLIENT_WAITING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//サーバーの検索停止\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eStopDiscovery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//ここでホストの開始フラグを待つ\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitUntil\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_isHostReady\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//接続ステータスの文言変更\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_connectionStateText\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCONNECTION_STATUS_SUCCESS\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//サーバー見つからない場合\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Try Connect...\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//接続を試みた回数をカウントアップ\u003c/span\u003e\n                \u003cspan class=\"n\"\u003etryCount\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//任意の回数以上接続に試みて失敗した場合は自身がホストになる\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etryCount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eCONNECT_TRY_COUNT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Start Host\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//ホストになる(サーバー)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_networkManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartHost\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//サーバーあるよーってお知らせする\u003c/span\u003e\n                    \u003cspan class=\"nf\"\u003eAdvertiseServer\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//接続ステータスの文言変更\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_connectionStateText\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCONNECTION_STATUS_HOST_WAITING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//プレイボタン表示\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_playButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egameObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetActive\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e//ここでホストの開始フラグを待つ\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitUntil\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_isHostReady\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//接続ステータスの文言変更\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_connectionStateText\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCONNECTION_STATUS_SUCCESS\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//n秒待つ\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eUniTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eWAIT_TIME\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ecancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e//シーン遷移\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_networkManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eServerChangeScene\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_gameSceneName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003chr\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"networkdiscovery\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#networkdiscovery\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNetworkDiscovery\u003c/h3\u003e\n\n\u003cp\u003eサーバーを検索、もしくはサーバーが自身の存在を通知する機能を持ちます。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eNetworkDiscovery\u003c/code\u003eはそのまま使用することもできますが、\u003cbr\u003e\nUIをカスタマイズしたかったり、\u003cbr\u003e\nシーン遷移時のフェードアニメーションなどを追加したかったりする場合には\u003cbr\u003e\nカスタムしないと難しいです。\u003c/p\u003e\n\n\u003cp\u003eそのために継承して利用しています。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eStartDiscovery\u003c/code\u003e,\u003ccode\u003eStopDiscovery\u003c/code\u003e,\u003ccode\u003eAdvertiseServer\u003c/code\u003eなどは\u003cbr\u003e\n\u003ccode\u003eNetworkDiscovery\u003c/code\u003eの機能に当たります。\u003c/p\u003e\n\n\u003cp\u003eこれらの機能は名前のまんまです。\u003cbr\u003e\nただし、シーン遷移時にしっかりとサーバーの検索、通知を停止させないと\u003cbr\u003e\nサーバーは停止しているのにレスポンスだけは返ってくるという謎の減少が起きるので\u003cbr\u003e\n\u003ccode\u003eOnDestroy\u003c/code\u003eで確実に\u003ccode\u003eStopDiscovery\u003c/code\u003eするのが安全だと思います。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"networkserversendtoall\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#networkserversendtoall\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNetworkServer.SendToAll\u003c/h3\u003e\n\n\u003cp\u003eサーバー内のすべてのクライアント(ホスト含む)に引数で指定したデータを送信します。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eCustomNetworkDiscovery\u003c/code\u003e内ではホストがプレイボタンを押したことを各クライアントに通知しています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e   \u003cspan class=\"c1\"\u003e//ホスト側にのみ表示されるボタン プレイボタン押下で準備完了とする\u003c/span\u003e\n   \u003cspan class=\"n\"\u003e_playButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eonClick\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n   \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Ready Ok\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//各クライアントにフラグデータを送る\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSendHostReadyData\u003c/span\u003e \u003cspan class=\"n\"\u003esendData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendHostReadyData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eIsHostReady\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendToAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendData\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_playButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egameObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetActive\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n   \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003chr\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"networkclientregisterhandler\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#networkclientregisterhandler\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNetworkClient.RegisterHandler\u003c/h3\u003e\n\n\u003cp\u003e先ほどの\u003ccode\u003eSendToAll\u003c/code\u003eでデータが送られてきたことを検知し、\u003cbr\u003e\n各クライアントでデータの受信時に行いたい処理を登録できます。\u003c/p\u003e\n\n\u003cp\u003e(引数の\u003ccode\u003eNetworkConnection\u003c/code\u003eは別になくても動きます。)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//データ受信の準備\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eNetworkClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSendHostReadyData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eReceivedReadyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// サーバーから受け取ったデータを各クライアントで使う\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"conn\"\u0026gt;コネクション情報　関数内で使ってないけど必要みたい\u0026lt;/param\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"receivedData\"\u0026gt;受け取ったデータ\u0026lt;/param\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eReceivedReadyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNetworkConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSendHostReadyData\u003c/span\u003e \u003cspan class=\"n\"\u003ereceivedData\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//ローカルのフラグに反映\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_isHostReady\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereceivedData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsHostReady\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eやり取りするデータも別途定義が必要となります。\u003cbr\u003e\n\u003ccode\u003eNetworkMessage\u003c/code\u003eというインターフェースを実装することで\u003cbr\u003e\nやり取りが可能なデータとなります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMirror\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// 送信するデータ\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializable\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eSendHostReadyData\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eNetworkMessage\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// ホストが準備できたかどうか\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eIsHostReady\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"コードcustomnetworkmanager\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%89customnetworkmanager\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコード(CustomNetworkManager)\u003c/h2\u003e\n\n\u003cp\u003e次に接続にまつわるコードです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMirror\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.SceneManagement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// 接続にまつわるいろいろ\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCustomNetworkManager\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eNetworkManager\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eScene\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_titleScene\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eScene\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_mainScene\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eTransform\u003c/span\u003e \u003cspan class=\"n\"\u003e_playerTransform\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eMaterial\u003c/span\u003e \u003cspan class=\"n\"\u003e_playerMaterial\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// プレイヤー入室時にサーバー側が実行\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"conn\"\u0026gt;接続されたプレイヤーのコネクション\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnServerAddPlayer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNetworkConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Add Player\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//タイトルシーンでのみ実行\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_titleScene\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSceneManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetActiveScene\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//接続中の人数表記を変える\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eSendPlayerCountData\u003c/span\u003e \u003cspan class=\"n\"\u003esendData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendPlayerCountData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayerCount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econnections\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendToAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendData\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//メインシーンでのみ実行\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_mainScene\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSceneManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetActiveScene\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Spawn Player\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//プレイヤー生成\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eGameObject\u003c/span\u003e \u003cspan class=\"n\"\u003eplayer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eInstantiate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eplayerPrefab\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//今立ち上げているサーバーにプレイヤーを追加登録\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddPlayerForConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eplayer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// 各プレイヤー退室時にサーバー側が実行\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"conn\"\u0026gt;切れたコネクション\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnServerDisconnect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNetworkConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//接続中の人数表記を変える\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSendPlayerCountData\u003c/span\u003e \u003cspan class=\"n\"\u003esendData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendPlayerCountData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayerCount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econnections\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendToAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendData\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Anyone Disconnect\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnServerDisconnect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// サーバーとの接続が切れた時にクライアント側で呼ばれる\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnStopClient\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSceneManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLoadScene\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_titleScene\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Disconnect\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnStopClient\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003chr\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"networkmanager\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#networkmanager\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eNetworkManager\u003c/h3\u003e\n\n\u003cp\u003e文字通りネットワークにまつわるいろいろを担います。\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eThe Network Manager is a component for managing the networking aspects of a multiplayer game.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e引用：\u003ca href=\"https://mirror-networking.com/docs/Articles/Components/NetworkManager.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eNetwork Manager\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれもあまりそのまま使う想定のものではないので、\u003cbr\u003e\n継承してメソッドをオーバーライドしてカスタムします。\u003c/p\u003e\n\n\u003cp\u003eコールバック含め、大量に機能があるので今回使ったものだけ解説します。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"starthost-startclient-stophost\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#starthost-startclient-stophost\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStartHost, StartClient, StopHost\u003c/h3\u003e\n\n\u003cp\u003e接続にまつわる関数です。\u003cbr\u003e\n\u003ccode\u003eStartHost\u003c/code\u003eを実行した場合、サーバーとクライアントの両方の役割を持つことになります。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eStartClient\u003c/code\u003eは引数に指定したアドレスのサーバーにクライアントとして接続します。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eStopHost\u003c/code\u003eは自身がサーバーならサーバーの接続を中断し、\u003cbr\u003e\nクライアントならサーバーから抜けます。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eNetworkManager\u003c/code\u003eはシングルトンとなっており、\u003cbr\u003e\nインスタンスをどこからでも呼び出せます。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eStartHost\u003c/code\u003e, \u003ccode\u003eStartClient\u003c/code\u003e, \u003ccode\u003eStopHost\u003c/code\u003eは全て\u003ccode\u003ePublic\u003c/code\u003eな関数なので、\u003cbr\u003e\nこれらもどこからでも呼び出せるってことです。\u003c/p\u003e\n\n\u003cp\u003e今回はサーバーの検索を担う、\u003ccode\u003eCustomNetworkDiscovery\u003c/code\u003eで接続にまつわる関数を呼び出しています。\u003c/p\u003e\n\n\u003cp\u003eそうすることで、\u003cbr\u003e\n\u003cstrong\u003e・LAN内にサーバーが見つかったら→StartClient\u003cbr\u003e\n・LAN内にサーバーが見つからなかったら→StartHost\u003c/strong\u003e\u003cbr\u003e\nのように同一LAN内で自動でマッチングする仕組みを作れます。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"onstopclient\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#onstopclient\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eOnStopClient\u003c/h3\u003e\n\n\u003cp\u003eクライアントがサーバーから切断された場合に各クライアントで呼び出されます。\u003c/p\u003e\n\n\u003cp\u003eこのコールバックの中でシーン遷移を呼び出すことで\u003cbr\u003e\n切断→シーン遷移　という処理が可能となります。\u003c/p\u003e\n\n\u003cp\u003eすなわち、接続状態にあるクライアントで\u003ccode\u003eStopHost\u003c/code\u003eを呼び出せば\u003cbr\u003e\n下記処理が呼ばれるということです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n \u003cspan class=\"c1\"\u003e/// サーバーとの接続が切れた時にクライアント側で呼ばれる\u003c/span\u003e\n \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnStopClient\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eSceneManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLoadScene\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_titleScene\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Disconnect\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n     \u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnStopClient\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003chr\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"onserveraddplayer\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#onserveraddplayer\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eOnServerAddPlayer\u003c/h3\u003e\n\n\u003cp\u003eMirrorにはプレイヤーという概念があります。\u003cbr\u003e\n誤解を恐れずに簡単にまとめると\u003cbr\u003e\nサーバーに接続したクライアントのことをプレイヤーと呼び、接続時にサーバーに追加されます。\u003c/p\u003e\n\n\u003cp\u003eこの\u003ccode\u003eOnServerAddPlayer\u003c/code\u003eはプレイヤーが追加された際に呼び出される処理です。\u003c/p\u003e\n\n\u003cp\u003eデモにおける接続された人数の表記の変更の通知(プレイヤー増加時)は\u003ccode\u003eOnServerAddPlayer\u003c/code\u003eで行っています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// プレイヤー入室時にサーバー側が実行\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"conn\"\u0026gt;接続されたプレイヤーのコネクション\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnServerAddPlayer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNetworkConnection\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Add Player\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//タイトルシーンでのみ実行\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_titleScene\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSceneManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetActiveScene\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//接続中の人数表記を変える\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eSendPlayerCountData\u003c/span\u003e \u003cspan class=\"n\"\u003esendData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSendPlayerCountData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayerCount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econnections\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendToAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esendData\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//メインシーンでのみ実行\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_mainScene\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSceneManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetActiveScene\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Spawn Player\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//プレイヤー生成\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eGameObject\u003c/span\u003e \u003cspan class=\"n\"\u003eplayer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eInstantiate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eplayerPrefab\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//今立ち上げているサーバーにプレイヤーを追加登録\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eNetworkServer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddPlayerForConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eplayer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまた、プレイヤーを概念ではなく、実体として生成する場合もあるかと思います。\u003c/p\u003e\n\n\u003cp\u003eその場合、\u003ccode\u003eOnServerAddPlayer\u003c/code\u003eでInstantiateしてあげれば\u003cbr\u003e\n各クライアントにプレイヤーが生成されます。\u003c/p\u003e\n\n\u003cp\u003eただし、この機能を利用するには\u003cbr\u003e\nInspectorの\u003ccode\u003ePlayerPrefab\u003c/code\u003eに\u003ccode\u003eNetworkIdentity\u003c/code\u003eが付与されたPrefabを\u003cbr\u003e\n事前に登録しておく必要があります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/3cdad1cdec88610f820b6cb09ae1b7af7a4ab3dc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3234343037312f61633735353534352d613636622d356232662d666462352d3034386237666337356339362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F244071%2Fac755545-a66b-5b2f-fdb5-048b7fc75c96.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5a8c61513916d21054a3d5ae4d7b5f27\" alt=\"PlayerPrefabSS.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/244071/ac755545-a66b-5b2f-fdb5-048b7fc75c96.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F244071%2Fac755545-a66b-5b2f-fdb5-048b7fc75c96.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f51f1ba992b32c866649a7b3bc216c5c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"最後に\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e最後に\u003c/h2\u003e\n\n\u003cp\u003e詳しくは知りませんがUNETという機能？がひと昔前にあったそうで、\u003cbr\u003e\nそれを改良したのがMirrorのようです。\u003c/p\u003e\n\n\u003cp\u003e結構なビッグタイトルに採用されているようですが、\u003cbr\u003e\nドキュメント以外の情報がなかなか無いので苦労しました。\u003c/p\u003e\n\n\u003cp\u003e私の今の力では及びませんがサーバー側の実装とかもいずれできるようになりたいです。\u003c/p\u003e\n\n\u003cp\u003e(UniTaskの実装は見よう見真似でやったので間違ってたら教えてください。)\u003c/p\u003e\n","createdAt":"2020-12-04T11:53:06Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"7vL9xNKWzOnC7+KCezoBvjnIKVVwe6zFjg==--Y8GCY+aub5wfnfsn--b8r3Vtxi23muxwt3fD8FIg==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-12-05T22:00:26Z","likesCount":11,"linkUrl":"https://qiita.com/OKsaiyowa/items/ecef8e5d50c84664f2a2","organization":null,"originalId":1350042,"stockedCount":7,"title":"【Unity(C#)】Mirrorで同期通信①　マッチング機能","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#unity-2-advent-calendar-2020\"\u003eUnity #2 Advent Calendar 2020\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#mirror\"\u003eMirror\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BB%8A%E5%9B%9E%E3%82%84%E3%82%8B%E3%81%93%E3%81%A8\"\u003e今回やること\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3\"\u003eバージョン\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%A2\"\u003eデモ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%89customnetworkdiscovery-\"\u003eコード(CustomNetworkDiscovery )\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#networkdiscovery\"\u003eNetworkDiscovery\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#networkserversendtoall\"\u003eNetworkServer.SendToAll\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#networkclientregisterhandler\"\u003eNetworkClient.RegisterHandler\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%89customnetworkmanager\"\u003eコード(CustomNetworkManager)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#networkmanager\"\u003eNetworkManager\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#starthost-startclient-stophost\"\u003eStartHost, StartClient, StopHost\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#onstopclient\"\u003eOnStopClient\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#onserveraddplayer\"\u003eOnServerAddPlayer\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"\u003e最後に\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":2674,"uuid":"ecef8e5d50c84664f2a2","banReason":null,"adventCalendarItem":{"day":6,"calendar":{"name":"Unity #2","urlName":"unity2","year":2020,"organization":null}},"author":{"encryptedId":"3XuXtyFyNpvC0fXLNZdJd6Pn+zgn--504e1QgRHyab7ZPn--zpFp6kiN+ShkOM4fP+eNrA==","originalId":244071,"description":"備忘録として学んだことを記録します。 あやふやな箇所が多いですが、そんなときはビシッと指摘いただけますと幸いです。(特に明示されていない場合、記事中のソースコードはパブリックドメインです。)","facebookUrl":"https://facebook.com/onoue.kento","githubUrl":"https://github.com/ForJobOk","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":"https://www.linkedin.com/in/onouekento","name":"","profileImageUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/244071/bae8dc3d07d0e3470f1689dbf348860d57405186/large.png?1590752982","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F244071%2Fbae8dc3d07d0e3470f1689dbf348860d57405186%2Flarge.png%3F1590752982?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=e39d5880c47f81bc23c0a4efc15cd6bb","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F244071%2Fbae8dc3d07d0e3470f1689dbf348860d57405186%2Flarge.png%3F1590752982?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1db3c0b8d02da57022d0bbed7e449028","urlName":"OKsaiyowa","websiteUrl":"https://www.wantedly.com/users/98233916","twitterUrl":"https://twitter.com/okprogramming","twitterUrlName":"okprogramming","revealedOrganizations":{"edges":[{"node":{"encryptedId":"oZ25jY9MIx/mX9ryMnhWzDyiByuH17osUbk=--Y7h8t+cEVPH7oGZ+--P4zRho4V2JuG/T2jVtGufw==","isBetaReleaseEnabled":false,"isFollowableByViewer":false,"isFollowedByViewer":false,"name":"Unityゲーム開発者ギルド","logoUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/f7eb993765ddcdb2c5e6890556c43ea3de8fbfb7/original.jpg?1570215690","urlName":"unity-game-dev-guild","description":"趣味・仕事問わずUnityでゲームを作っている開発者のみで構成されるオンラインコミュニティです。Unityでゲームを開発・運用するにあたって必要なあらゆる知見を共有することを目的とします。","url":"https://unity-game-dev-guild.github.io/"}}]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"},{"name":"mirror","urlName":"mirror"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
