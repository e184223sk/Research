More than 3 years have passed since last update.こんにちは。Xamarin + Visual Studio + C# で賢いお絵描きアプリを作ろうとして苦戦している shiatsumat です。アプリ開発は初めてなのですが、Xamarin.Android での開発は凄く楽しいなと感じています。C# 向けの薄いラッパーが掛かっているだけと言えばそうなのですが、Visual Studio + C# という開発環境がやはり充実しているように思います。UI はなかなか奥が深くて、思わぬところで悪戦苦闘したのでまとめて報告します。開発中のソースコードはdevelopブランチから見られます。長々書いていますが、色々使える知識を並べたつもりなので、適当に拾い読みしてください。が、ScrollView がバグる ・ 原因と巧妙な解決法 が本題です。Xamarin でなく Android Studio + Java で開発する人も使えるテクニックかと思います。さて、ペンの色や太さなどを設定するためのダイアログを作りたかったのですが、Android には色を選択するための標準のコントロールが無いので自作することにしました。とりあえず RGBA を指定する NumberPicker を並べただけのものを作りました。良い感じです。一見すると上下の NubmerPicker が重なっているように見えますが、グレーの部分は実際にはただの通り道なので気にする必要はありません。ちなみに UI Designer を起動するとよく固まります。Visual Studio の再起動を余儀なくされることもあります。これのせいでどれほどの時間が無駄になったことでしょうか。さて、この AXML を元にカスタムコントロールを作ります。（なお、ここでの Color は Android のものではなく自作の構造体です。）Inflate で AXML からカスタムコントロールを錬成しています。なお、Inflate という英単語は馴染みが薄いかもしれませんが、ぺちゃんこの風船を膨らませて（inflate a baloon）何かしらの立体的なキャラクターか何かを作る、というのをイメージするとわかりやすいかと思います。コンストラクタの引数にも注意が必要です。なお、コンテキストはコンストラクタの引数から取っても良いのですが、base のコンストラクタが呼ばれた時点で Context プロパティに入っているのでそれを使うのが楽です。継承元が元の AXML のルート要素に合わせて LinearLayout となっているのもポイントです。さて、自作のクラスはそのまま AXML で使えます。名前空間の指定だけ注意してください。なお、ここでは C# の時点で名前空間が小文字ですが、C# の名前空間で大文字であっても AXML では小文字にする必要があります。良い感じですね。実際に動かしてみないと分かりませんが（というのは伏線でここのせいでバグが起こるのですがとりあえず先に進みましょう）。UI Designer ではカスタムコントロールの表示はサボった形になるのですが、なぜか Spinner の表示もサボられています。気になります。ここで、TextView の文字や Spinner の文字配列を XML で指定できるというのもポイントです。特に文字配列の方はきちんと書かれている文献があまり無いので、少し苦労しました。XML にする利点としては多言語対応が出来るということが挙げられます。例えば、values フォルダではなく values-ja フォルダに入れたファイルは日本語環境で参照されます。さて、いよいよダイアログを作ります。カスタム可能なダイアログが AlertDialog という名前で用意されています（特に注意喚起をするわけではありませんが）。まずビルダーを作るという点に注意してください。また、Inflate の方法が先ほどとは異なるので注意してください。UI の細かい部分も設定します。view を経由して FindViewById するという点だけ注意してください。ダイアログからの脱出のために OK ボタンも作ります。値を設定して戻ります。細かい部分は無視して良いです。最終的にビルダーからダイアログを作ります。この時点ではまだダイアログは表示されなくて、ダイアログを表示するには Show メソッドを呼び出します。例えば、ボタンからダイアログを呼び出せるようにするにはこうすれば良いです。さて、満を持してデバッグしましょう（エミュレータは日本語環境に設定しました）。ボタンを押すとダイアログが出ました。ん？なぜか一番上まで表示されません。（実際のデバッグ時には、ストローク色の設定の部分だけちょうど表示されない状態になっていて、Inflate のバグだと考え、色々と調べていたのですが、見当違いでした。）これは、ScrollView がカスタムコントロールの大きさを上手く把握できていないことにおそらく起因します（あっさり書くことにしましたがこのことに気付くのに実際にはかなりの時間を費やしました）。ScrollView がいきなりあると危なそうですし、FrameLayout を挟んでみれば良いような気がします（というのをいきなり思いつくはずもなく、色々調べていくうちにわかりました）。やってみましょう。残念ながらこれでもまだバグは取れません。FrameLayout に android:layout_gravity="center" とあるのがサイズの把握に不確定要素を加えているような気がします。このように書き換えるとどうでしょうか？見事一番上まで表示されました。お疲れさまです！このあたりは若干バッドノウハウ感もありますが、お役に立てれば幸いです。UI 作りは面白いですが、これだけ複雑なライブラリとなると結構良くわからない挙動も多いなと思いました。Xamarin による開発のテクニックについてはまだまだ文献が少ないので、お絵描きアプリの開発を通じて得られた知見を少しずつ共有していきたいと思います。よろしくお願いします。


