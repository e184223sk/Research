<!DOCTYPE html><html><head><meta charset="utf-8" /><title>UX最強のベジェ曲線「κ-Curves」を完全に理解する - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/Rijicho_nl/items/05ee4c8d77e99e29daa5" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="ZWlcCZDGPafL0USo2PWYzPIJ4XrYiLQlKqkt4veUlHiD3hRPi2p0AX/4Y+2jY63dY1KBZonPEyh11LQ9/fEqzg==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@Rijicho_nl" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="UX最強のベジェ曲線「κ-Curves」を完全に理解する - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WVmptbklEbHZMZmpnYTdqZzVuamdyampncWZtbTdMbnQ1cmpnSXpPdWkxRGRYSjJaWFBqZ0kzamdwTGxyb3psaGFqamdhdm5rSWJvcDZQamdabmpnb3MmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9MWUwZDZmOWM0NmU1NDM2Njg0NjgxOGZiN2M3YmRlMmQ&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRkpwYW1samFHOWZibXcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1lZmY5ZTAxNzJhNGFjNzZkZWNlMGZkMzZkNTlhZjc5ZQ&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=908ebdfbbee13335ede4d106c5979013"><meta property="og:description" content="

TL;DR


全てのユーザ制御点上を通り、
全ての曲率極大点がユーザ制御点上にある


そんな超便利なのにあまり知られていないパラメトリック曲線こと「κ-Curves」。
Adobe ResearchとテキサスA&amp;amp;M大学..."><meta content="https://qiita.com/Rijicho_nl/items/05ee4c8d77e99e29daa5" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity,ベジェ曲線,SIGGRAPH,曲線" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-bcde47f4-de76-4f46-a611-2960778613f4"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FRijicho_nl%2Fitems%2F05ee4c8d77e99e29daa5">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FRijicho_nl%2Fitems%2F05ee4c8d77e99e29daa5">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-bcde47f4-de76-4f46-a611-2960778613f4">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-02-04T13:19:44.000+09:00","dateModified":"2021-04-09T21:31:32.000+09:00","headline":"UX最強のベジェ曲線「κ-Curves」を完全に理解する","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WVmptbklEbHZMZmpnYTdqZzVuamdyampncWZtbTdMbnQ1cmpnSXpPdWkxRGRYSjJaWFBqZ0kzamdwTGxyb3psaGFqamdhdm5rSWJvcDZQamdabmpnb3MmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9MWUwZDZmOWM0NmU1NDM2Njg0NjgxOGZiN2M3YmRlMmQ\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRkpwYW1samFHOWZibXcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1lZmY5ZTAxNzJhNGFjNzZkZWNlMGZkMzZkNTlhZjc5ZQ\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=908ebdfbbee13335ede4d106c5979013","mainEntityOfPage":"https://qiita.com/Rijicho_nl/items/05ee4c8d77e99e29daa5","author":{"@type":"Person","address":"","email":null,"identifier":"Rijicho_nl","name":"Rijicho_nl","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fprofile-images%2F1582773093?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=10e5976ac4859ffb5f42ce8b7365e3be","url":"https://qiita.com/Rijicho_nl","description":"東大の同人ゲーム制作サークル「ノンリニア」のプログラマ、絵師、シナリオライター。Unity界隈。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita&amp;utm_medium=header-banner">社内改善＝業界革新。GA technologiesの一石三鳥な社内プロダクト開発とは</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Rijicho_nl","type":"items","id":"05ee4c8d77e99e29daa5"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"社内改善＝業界革新。GA technologiesの一石三鳥な社内プロダクト開発とは","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Rijicho_nl","type":"items","id":"05ee4c8d77e99e29daa5"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"社内改善＝業界革新。GA technologiesの一石三鳥な社内プロダクト開発とは","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"Rijicho_nl","type":"items","id":"05ee4c8d77e99e29daa5"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"社内改善＝業界革新。GA technologiesの一石三鳥な社内プロダクト開発とは","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/Rijicho_nl/items/05ee4c8d77e99e29daa5","location":"/Rijicho_nl/items/05ee4c8d77e99e29daa5","scheme":"https","host":"qiita.com","port":null,"pathname":"/Rijicho_nl/items/05ee4c8d77e99e29daa5","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"gGcFC+cB/UCLlcHwjxhABYT9BRIWXfTJeTfkpWr//Vdm0E1N/K205j+85rX0jnUUFaZlDkcaU8QmSn16YJpD4Q==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-10bc0efa-d390-4249-8bae-2884f091c9cb"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5/likers" class="css-1iupg5d">285</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">252</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/05ee4c8d77e99e29daa5/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/Rijicho_nl"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/profile-images/1582773093" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/Rijicho_nl" class="css-10ougpm">@<!-- -->Rijicho_nl</a><div class="css-1ay9vb9"><span><meta content="2020-02-04T04:19:44Z"/><time dateTime="2021-04-09T12:31:32Z" class="css-m19uds">updated at 2021-04-09</time></span></div></div></div></div></div><h1 class="css-cgzq40">UX最強のベジェ曲線「κ-Curves」を完全に理解する</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/%e3%83%99%e3%82%b8%e3%82%a7%e6%9b%b2%e7%b7%9a" class="css-4czcte">ベジェ曲線</a><a href="/tags/siggraph" class="css-4czcte">SIGGRAPH</a><a href="/tags/%e6%9b%b2%e7%b7%9a" class="css-4czcte">曲線</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="tldr" class="fragment"></span><a href="#tldr"><i class="fa fa-link"></i></a>TL;DR</h1>

<ul>
<li>全てのユーザ制御点上を通り、</li>
<li>全ての曲率極大点がユーザ制御点上にある</li>
</ul>

<p>そんな超便利なのにあまり知られていないパラメトリック曲線こと<strong>「κ-Curves」</strong>。<br>
<a href="http://people.tamu.edu/%7Eyanzp/projects/kCurves/kCurves.pdf" rel="nofollow noopener" target="_blank">Adobe ResearchとテキサスA&amp;M大学のYan氏らがSIGGRAPH 2017で発表した研究</a>で、Adobe Illustratorに実装されており、Adobeが特許を取っています<font color="red">（無断の商用利用はNG）</font>。<br>
新しめなせいか、検索しても情報があまり出てきません。<br>
この論文と同じ流れを、前提知識や行間を補いつつ日本語で追っていきます。</p>

<p>C#で実際に実装もしていきます。<br>
論文に忠実に実装するとちょっとバグるので、それについても少し。</p>

<p>※本記事では、上記論文から一部画像や式を引用しています。</p>

<p><a href="https://camo.qiitausercontent.com/9ccf43a6f5d496ee8a547a8b58f0c687d8336b3b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f39653130663735342d633435652d396632322d336537392d3638343835303330373635352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F9e10f754-c45e-9f22-3e79-684850307655.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=40bd60e0e3e52a59c0fb3c39c8a484bc" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/9e10f754-c45e-9f22-3e79-684850307655.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F9e10f754-c45e-9f22-3e79-684850307655.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=14b89912a42e6d2db7e6bb7912600002 1x" loading="lazy"></a><br>
これは論文から引用した図で、他の様々なパラメトリック曲線とκ-Curvesの比較。<br>
左から順に、Interpolatory subdivision curve, Catmull-Romスプライン、Cubic B-スプライン、κ-Curvesです。</p>

<h1>
<span id="デモ" class="fragment"></span><a href="#%E3%83%87%E3%83%A2"><i class="fa fa-link"></i></a>デモ</h1>

<p><a href="https://rijicho-k-curves.glitch.me/" rel="nofollow noopener" target="_blank">WebGL(JavaScript)で実装したものをGlitchに公開しました。</a></p>

<p>注意：</p>

<ul>
<li>ループ非対応、最適化が雑です

<ul>
<li>JSは専門外なのでゆるして</li>
</ul>
</li>
<li>以下のライブラリを使用しました

<ul>
<li><a href="https://bitbucket.org/kenshi84/legacygl.js" class="autolink" rel="nofollow noopener" target="_blank">https://bitbucket.org/kenshi84/legacygl.js</a></li>
<li><a href="https://github.com/toji/gl-matrix" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/toji/gl-matrix</a></li>
</ul>
</li>
<li>初期値は某こころぴょんぴょんアニメのトレスです</li>
</ul>

<h1>
<span id="事前知識" class="fragment"></span><a href="#%E4%BA%8B%E5%89%8D%E7%9F%A5%E8%AD%98"><i class="fa fa-link"></i></a>事前知識</h1>

<p>簡単のため、本記事ではxy平面上の曲線のみを考えます。<br>
高校レベルの数学＋行列の基礎知識で理解できる内容のはずです。</p>

<h2>
<span id="パラメトリック曲線" class="fragment"></span><a href="#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E6%9B%B2%E7%B7%9A"><i class="fa fa-link"></i></a>パラメトリック曲線</h2>

<p>パラメトリック曲線とは、X座標、Y座標がそれぞれパラメータ$t$によって決まる曲線です。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
&amp;f:\mathbb{R}\rightarrow\mathbb{R}^2\\
&amp;f(t)=
\left(\begin{matrix}
x(t)\\
y(t)
\end{matrix}\right)
\end{align}
</code></pre></div></div>

<p>世の中には様々なパラメトリック曲線があります。いくつか雑に紹介すると、</p>

<ul>
<li>（３次）エルミート曲線

<ul>
<li>$f(0), f(1), f'(0),f'(1)$の値が制約として与えられ、それを満たすような$t$の３次式。</li>
<li>あんまり融通が効かない。</li>
</ul>
</li>
<li>（n次）ベジェ曲線

<ul>
<li>連続する各セグメント$i$について、制御点$c_{i,0}, \cdots, c_{i,n}$が与えられる。</li>
<li>$c_{i,0}, c_{i,n}$を結ぶ線をそれ以外の制御点がそれぞれ引っ張ったような曲線になる。</li>
<li><strong>曲線は$c_{i,0}, c_{i,n}$以外の制御点の上を通らない。</strong></li>
</ul>
</li>
<li>スプライン曲線

<ul>
<li>３次曲線などをいくつも繋げたり重ねたりして一本の曲線を作るもの。</li>
<li>いろいろと種類がある。Catmull-Romスプライン、B-スプライン、NURBSなど。</li>
<li>接続点を制御点として動かすタイプの場合、<strong>曲線は制御点上を通る。</strong>

<ul>
<li>が、<strong>通るだけで、期待した形になるとは限らない。</strong>
</li>
<li>なんかひん曲がってしまう例（Excelの曲線ツール）：<a href="https://camo.qiitausercontent.com/d0a2e8660c37008dbd2e7736c8faa1f4e126e6ce/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f34646266343166612d383731322d346637382d373861322d3936653332613937363739322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F4dbf41fa-8712-4f78-78a2-96e32a976792.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=03bf6973db26303fd30f3dd4ffe4c006" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/4dbf41fa-8712-4f78-78a2-96e32a976792.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F4dbf41fa-8712-4f78-78a2-96e32a976792.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=7a8df30498faf626d9fe779dda4f5c6a 1x" loading="lazy"></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>と、他にもいろいろありますが、とにかくどれもこれも融通が効きません。<br>
イラストソフトなどでポチポチ<strong>クリックした場所をいい感じになめらかに繋いで曲線を作ってほしい</strong>場合、どれも力不足。</p>

<p>κ-Curvesは、<strong>曲率</strong>を制御することでこれを実現します。<br>
※ベースはベジェ曲線なので、ベジェ曲線以外のことは忘れて大丈夫です。</p>

<h2>
<span id="曲率" class="fragment"></span><a href="#%E6%9B%B2%E7%8E%87"><i class="fa fa-link"></i></a>曲率</h2>

<p>κ-Curvesは、「ユーザー制御点の<strong>曲率</strong>の絶対値が極大になる」という特徴を持つ曲線です。<br>
曲率（Curvature）とは、曲線上のある点の周りの微小区間を<strong>円弧に近似</strong>したときの<strong>円の半径</strong>の<strong>逆数</strong>（符号付き<sup id="fnref1"><a href="#fn1" title="3D曲線の場合、曲率は絶対値を取って扱うことが多いようです。2D曲線でも絶対値つきで定義されていることがあるかもしれませんが、ここではκ-Curvesの論文に倣って符号付きとします。">1</a></sup>）です。<br>
要は、曲線上のある点の周囲が<strong>いかに急カーブか</strong>を示す値ですね。絶対値が大きいほど急になります。</p>

<p>具体的には、2Dパラメトリック曲線においては以下の式で表される値です。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\kappa(t)=\frac{f'(t)\times f''(t)}{\|f'(t)\|^3}
</code></pre></div></div>

<p>軽く導出しておきましょう。<br>
<a href="https://camo.qiitausercontent.com/cb039b83de8c1a0b6d3a3e68b25f027d3ef2c5f3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f30616464626432322d326361352d326265652d333435382d3834636261623863353632362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F0addbd22-2ca5-2bee-3458-84cbab8c5626.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=df21aa8541e804bf8e6d361942a980d5" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/0addbd22-2ca5-2bee-3458-84cbab8c5626.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F0addbd22-2ca5-2bee-3458-84cbab8c5626.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4ed154a59a32f1e208c5217d47bf53ac 1x" loading="lazy"></a></p>

<p>平面曲線$f:\mathbb{R}\rightarrow\mathbb{R}^2$において、ある微小区間$f(t)$～$f(t+\Delta t)$の長さを$\Delta s$、それが円弧だとしたときの中心角を$\Delta\theta$、半径を$r$とすると、$\Delta s=r\Delta\theta$が成り立ちます。これより、点$f(t)$における曲率$\kappa(t)$は、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\kappa(t)=\lim_{\Delta t\rightarrow0}\frac{\Delta \theta}{\Delta s}=\frac{d\theta}{ds}
</code></pre></div></div>

<p>と表されます。</p>

<p>ここで、$\dot{x}=\frac{dx}{dt},\ \dot{y}=\frac{dy}{dt}$とすると、点$f(t)$における傾きは</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\tan\theta=\frac{dy}{dx}=\frac{\dot{y}}{\dot{x}}
</code></pre></div></div>

<p>ですが、この両辺を$t$で微分すると、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
\frac{1}{\cos^2\theta}\frac{d\theta}{dt}&amp;=\frac{\dot{x}\ddot{y}-\dot{y}\ddot{x}}{\dot{x}^2}\\\\
\frac{d\theta}{dt}&amp;=\frac{1}{1+\tan^2\theta}\frac{\dot{x}\ddot{y}-\dot{y}\ddot{x}}{\dot{x}^2}\\\\
\frac{d\theta}{dt}&amp;=\frac{\dot{x}\ddot{y}-\dot{y}\ddot{x}}{\dot{x}^2 + \dot{y}^2}
\end{align}
</code></pre></div></div>

<p>が得られます。ドット２つは$t$での二階微分です。<br>
また、$\Delta s$は微小区間の長さなので、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\frac{ds}{dt}=\sqrt{\dot{x}^2+\dot{y}^2}
</code></pre></div></div>

<p>であり、以上から</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
\kappa(t)&amp;=\frac{d\theta}{ds}=\frac{\dot{x}\ddot{y}-\dot{y}\ddot{x}}{(\dot{x}^2 + \dot{y}^2)^{\frac{3}{2}}}\\\\
&amp;=\frac{f'(t)\times f''(t)}{\|f'(t)\|^3}
\end{align}
</code></pre></div></div>

<p>が導かれます。</p>

<p>κ-Curvesは、ユーザ制御点上でこの値（の絶対値）が極大値を取るような曲線である、ということです。</p>

<h2>
<span id="ベジェ曲線" class="fragment"></span><a href="#%E3%83%99%E3%82%B8%E3%82%A7%E6%9B%B2%E7%B7%9A"><i class="fa fa-link"></i></a>ベジェ曲線</h2>

<p>先程少し触れましたが、κ-Curvesはベジェ曲線がベースになっています。<br>
というか、<strong>曲線の式自体はベジェ曲線そのもの</strong>なのです。<br>
というわけで、まずはベジェ曲線について。</p>

<h3>
<span id="表式" class="fragment"></span><a href="#%E8%A1%A8%E5%BC%8F"><i class="fa fa-link"></i></a>表式</h3>

<p>いくつものベジェ曲線を連結して一本の曲線にすることを考えます。<br>
この各ベジェ曲線をセグメントと呼ぶことにし、それぞれの$t$の変域を$[0,1]$とします。</p>

<p>一般の$d$次ベジェ曲線の$i$番目のセグメントは、$c_{i,j}$をそのセグメントのベジェ制御点とすると</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>c_i^d(t)=\sum_{j=0}^d\frac{d!}{(d-j)!j!}(1-t)^{d-j}t^jc_{i,j}
</code></pre></div></div>

<p>で表されますが、κ-Curvesにおいては次に示す<strong>2次ベジェ曲線</strong>を前提とします。$d$のことは忘れてください。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
c_i(t)&amp;=(1-t)^2c_{i,0} + 2(1-t)tc_{i,1} + t^2c_{i,2}\\
&amp;=(c_{i,0}-2c_{i,1}+c_{i,2})t^2-2(c_{i,0}-c_{i,1})t+c_{i,0}\\
\end{align}
</code></pre></div></div>

<p>二階微分まで求めておくと、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
c_i'(t)&amp;=2(c_{i,0}-2c_{i,1}+c_{i,2})t-2(c_{i,0}-c_{i,1})\\
&amp;=2((1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1}))\\
\\
c_i''(t)&amp;=2(c_{i,0}-2c_{i,1}+c_{i,2})\\
&amp;=2((c_{i,0}-c_{i,1}) + (c_{i,2} - c_{i,1}))
\end{align}
</code></pre></div></div>

<p>となります。</p>

<h3>
<span id="曲率-1" class="fragment"></span><a href="#%E6%9B%B2%E7%8E%87-1"><i class="fa fa-link"></i></a>曲率</h3>

<p>$i番目の$セグメントの各点$c_i(t)$における曲率を$\kappa_i(t)$とすると、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
\kappa_i(t)&amp;=\frac{c_i'(t)\times c_i''(t)}{\|c_i'(t)\|^3}\\
&amp;=\frac{\triangle(c_{i,0},c_{i,1},c_{i,2})}{\|(1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1})\|^3}\\
\end{align}\\
</code></pre></div></div>

<p>となります。ここで$\triangle(c_{i,0},c_{i,1},c_{i,2})$は<strong>３つの制御点を結んだ三角形の符号付き面積</strong>で、つまり<strong>定数</strong>です。</p>

<p>……何ともよく分からん式変形なので、図解します。<br>
同じ色の線分は平行です。<br>
<a href="https://camo.qiitausercontent.com/b81607a57c7fb1b46e9f979d297624935d25f654/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f39303634383938332d383335312d356637632d356337642d3030333833336132653430352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F90648983-8351-5f7c-5c7d-003833a2e405.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7fca544ecfe6ac7ad242bad79ca55db5" alt="k0.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/90648983-8351-5f7c-5c7d-003833a2e405.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F90648983-8351-5f7c-5c7d-003833a2e405.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6764dbb2cd87eadafa29735de9ae7390 1x" loading="lazy"></a><br>
$c_{i,0},c_{i,1},c_{i,2}$を３点とする平行四辺形の残りの点（$c_{i,1}$の対角位置）を$P$とし、<br>
$c_{i,0},c_{i,1},P$を３点とする平行四辺形の残りの点（$c_{i,1}$の対角位置）を$R$とします。</p>

<p>$c_{i,0}$を原点としたときに、$\frac{1}{2}c_i'(t)=(1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1})$がどこを示す位置ベクトルになるかというと、見たまんま内分点なので図の点$Q$です。</p>

<p>同じように、$\frac{1}{2}c_i''(t)=(c_{i,0}-c_{i,1}) + (c_{i,2} - c_{i,1})$は点$R$を示します。</p>

<p>よって、これらの外積$\frac{1}{4}c_i'(t)\times c_i''(t)$の絶対値は、以下の領域の面積になります。<br>
<a href="https://camo.qiitausercontent.com/f717d4e75f742f25ea45120843895b4e76f6cc71/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f61363361643038652d376363352d613331632d376335302d6633613532333231306566622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fa63ad08e-7cc5-a31c-7c50-f3a523210efb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7be79a1312482c241e016e1b68b82a13" alt="k1.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/a63ad08e-7cc5-a31c-7c50-f3a523210efb.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fa63ad08e-7cc5-a31c-7c50-f3a523210efb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=08e8ab62c7ed6b5b91d500a5934ab426 1x" loading="lazy"></a><br>
これは、以下の領域の面積と等しいことが等積変形によってわかります。<br>
<a href="https://camo.qiitausercontent.com/7269b52c0b2e481f84e354a65ecaee86bfa27d38/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f66326534396661312d303163612d643037612d336461652d3865306531313031323238662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Ff2e49fa1-01ca-d07a-3dae-8e0e1101228f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3c9a71c6dabcdcd2b4f546b8c149e4d5" alt="k2.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/f2e49fa1-01ca-d07a-3dae-8e0e1101228f.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Ff2e49fa1-01ca-d07a-3dae-8e0e1101228f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=fe5a6fc0ea7028338704fe1f986a3f93 1x" loading="lazy"></a><br>
よって、$t$の値によらず、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\frac{1}{4}c_i'(t)\times c_i''(t)=2\triangle(c_{i,0},c_{i,1},c_{i,2})
</code></pre></div></div>

<p>であることが分かります。初等幾何は楽しいですね。</p>

<p>というわけで再掲すると、２次ベジェ曲線の$i$番目のセグメント上の点$c_i(t)$における曲率は、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\kappa_i(t)=\frac{\triangle(c_{i,0},c_{i,1},c_{i,2})}{\|(1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1})\|^3}
</code></pre></div></div>

<p>で求められます。</p>

<p>※面積の符号については、最終的に絶対値で吸収されるのであまり気にしなくて大丈夫です。</p>

<h3>
<span id="曲率極大点" class="fragment"></span><a href="#%E6%9B%B2%E7%8E%87%E6%A5%B5%E5%A4%A7%E7%82%B9"><i class="fa fa-link"></i></a>曲率極大点</h3>

<p>曲率の絶対値が極大になるときの$t$を$t_i$とすると、$\kappa'(t_i)=0$より、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
\kappa'(t_i)=-\frac{\triangle(c_{i,0},c_{i,1},c_{i,2})\cdot 3(\|c_i'(t_i)\|)'}{\|c_i'(t_i)\|^4}&amp;=0\\\\
(\|c_i'(t_i)\|)'&amp;=0\\\\
c_i'(t_i)c_i''(t_i)&amp;=0\\\\
((c_{i,0}-2c_{i,1}+c_{i,2})t_i-(c_{i,0}-c_{i,1}))\cdot(c_{i,0}-2c_{i,1}+c_{i,2})&amp;=0
\end{align}
</code></pre></div></div>

<p>というわけで</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>t_i=\frac{(c_{i,0}-c_{i,1})\cdot(c_{i,0}-2c_{i,1}+c_{i,2})}{\|c_{i,0}-2c_{i,1}+c_{i,2}\|^2}
</code></pre></div></div>

<p>となります。<br>
$c_{i,1}$から見たローカル座標として、$c_{i,0}'=c_{i,0}-c_{i,1},\ c_{i,2}'=c_{i,2}-c_{i,1}$とおけば、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>t_i=\frac{c_{i,0}'\cdot(c_{i,0}'+c_{i,2}')}{\|c_{i,0}'+c_{i,2}'\|^2}
</code></pre></div></div>

<p>とそこそこ綺麗な形になります。</p>

<p>このように、与えられたベジェ制御点から曲率極大点を求めるのは簡単です。<br>
κ-Curvesはこの逆、<strong>与えられたユーザ制御点を曲率極大点$c_i(t_i)$とし、それを満たすベジェ制御点を逆算</strong>するシステムです。</p>

<h1>
<span id="κ-curves" class="fragment"></span><a href="#%CE%BA-curves"><i class="fa fa-link"></i></a>κ-Curves</h1>

<p>いよいよκ-Curvesを構成していきます。<br>
問題の大枠は以下の通り：</p>

<blockquote>
<p>入力：$n$個のユーザ制御点$p_i\ (0\le i&lt;n)$<br>
出力：$3n$個のベジェ制御点$c_{i,j}\ (0\le i&lt;n,\ j=0,1,2)$</p>

<p>制約１：ユーザ制御点で極大曲率<br>
制約２：$C^0$連続<br>
制約３：$G^1$連続<br>
制約４：ほぼ$G^2$連続</p>
</blockquote>

<p>４つの制約を順に見ていきましょう。</p>

<p>※ベジェ制御点$c_{i,j}$の添字$i$については、ひとまずはループしているものとみなし、$\rm{mod}\ n$で考えます。<br>
　範囲制限をつけずに$i+1$とか$i-1$とか書きますが怒らないでください。非ループ版への拡張は簡単です。</p>

<h2>
<span id="制約１ユーザ制御点で極大曲率" class="fragment"></span><a href="#%E5%88%B6%E7%B4%84%EF%BC%91%E3%83%A6%E3%83%BC%E3%82%B6%E5%88%B6%E5%BE%A1%E7%82%B9%E3%81%A7%E6%A5%B5%E5%A4%A7%E6%9B%B2%E7%8E%87"><i class="fa fa-link"></i></a>制約１：ユーザ制御点で極大曲率</h2>

<p>$p_i=c_i(t_i)$を、$c_{i,1}$について整理してみます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
p_i&amp;=c_i(t_i)\\
p_i&amp;=(c_{i,0}-2c_{i,1}+c_{i,2})t_i^2-2(c_{i,0}-c_{i,1})t_i+c_{i,0}\\\\
c_{i,1}&amp;=\frac{p_i-(1-t_i)^2c_{i,0}-t^2c_{i,2}}{2t_i(1-t_i)}
\end{align}
</code></pre></div></div>

<p>※$t_i=0, 1$のときはそれぞれ$p_i=c_{i,0}, c_{i,2}$のときなので、個別に簡単に考えることができます。<br>
これを先程導出した$t_i$の式：</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>t_i=\frac{(c_{i,0}-c_{i,1})\cdot(c_{i,0}-2c_{i,1}+c_{i,2})}{\|c_{i,0}-2c_{i,1}+c_{i,2}\|^2}
</code></pre></div></div>

<p>に代入して気合で整理すると、以下の$t_i$の三次方程式が得られます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\|c_{i,2}-c_{i,0}\|^2t_i^3+3(c_{i,2}-c_{i,0})\cdot(c_{i,0}-p_i)t_i^2+(3c_{i,0}-2p_i-c_{i,2})\cdot(c_{i,0}-p_i)t_i-\|c_{i,0}-p_i\|^2=0
</code></pre></div></div>

<p>ただの３次方程式なので、<strong>解の公式（カルダノの公式）で解くことができます。</strong><br>
係数がごちゃごちゃしていますが、$c_{i,0}$から見たローカル座標で $c_{i,2}'=c_{i,2}-c_{i,0},\ p_i'=p_i-c_{i,0}$ と書き直せば、少し短くなります。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\|c'_{i,2}\|^2t_i^3-3c'_{i,2}p'_it_i^2+(2p_i'+c_{i,2}')p_i't_i-\|p_i'\|^2=0
</code></pre></div></div>

<h3>
<span id="綺麗にする" class="fragment"></span><a href="#%E7%B6%BA%E9%BA%97%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>綺麗にする</h3>

<p>もっと綺麗に整理するために、$p_i$から見たローカル座標で考えてみましょう。<br>
$v_0=c_{i,0}-p_i,\ v_2=c_{i,2}-p_i$とすると、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\|v_2-v_0\|^2t_i^3+3(v_2-v_0)v_0t_i^2+(3v_0-v_2)v_0t_i-\|v_0\|^2=0
</code></pre></div></div>

<p>ですが、これは以下のように変形できます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left(\begin{matrix}
\|v_0\|^2\\
v_0\cdot v_2\\
-v_0\cdot v_2\\
-\|v_2\|^2
\end{matrix}\right)
\cdot
\left(\begin{matrix}
(1-t_i)^3\\
t_i(1-t_i)^2\\
t_i^2(1-t_i)\\
t_i^3
\end{matrix}\right)
=0
</code></pre></div></div>

<p>対称的な形になりました。<br>
２つ目、３つ目の係数を調整すれば３次の<a href="https://ja.wikipedia.org/wiki/%E3%83%90%E3%83%BC%E3%83%B3%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%B3%E5%A4%9A%E9%A0%85%E5%BC%8F" rel="nofollow noopener" target="_blank">バーンスタイン多項式</a>として扱えます。</p>

<h3>
<span id="実解の範囲と個数" class="fragment"></span><a href="#%E5%AE%9F%E8%A7%A3%E3%81%AE%E7%AF%84%E5%9B%B2%E3%81%A8%E5%80%8B%E6%95%B0"><i class="fa fa-link"></i></a>実解の範囲と個数</h3>

<p>ところでこの方程式は、<strong>必ず$[0,1]$内にただ１つの実解を持ちます。</strong><br>
さすがに自明ではなく、論文にもAppendixに証明があります。概略は以下のとおり：</p>

<ol>
<li>まず<a href="https://ja.wikipedia.org/wiki/%E4%B8%AD%E9%96%93%E5%80%A4%E3%81%AE%E5%AE%9A%E7%90%86" rel="nofollow noopener" target="_blank">中間値の定理</a>より、$[0,1]$内に実解が一つ以上存在します。</li>
<li>
<a href="https://ja.wikipedia.org/wiki/%E3%83%87%E3%82%AB%E3%83%AB%E3%83%88%E3%81%AE%E7%AC%A6%E5%8F%B7%E6%B3%95%E5%89%87" rel="nofollow noopener" target="_blank">デカルトの符号律</a>はバーンスタイン多項式にも適用できる（らしい）ので、$v_0\cdot v_2\ge 0$であれば実解は１つだけです。</li>
<li>$v_0\cdot v_2&lt;0$の場合も、導関数の正負は$[0,1]$内で一定であることが示せるので、実解は１つだけです。</li>
</ol>

<h2>
<span id="制約２c連続" class="fragment"></span><a href="#%E5%88%B6%E7%B4%84%EF%BC%92c%E9%80%A3%E7%B6%9A"><i class="fa fa-link"></i></a>制約２：C⁰連続</h2>

<p>曲線<strong>全体</strong>の<strong>位置</strong>が連続であることを保証する制約です。<br>
各セグメント内が連続なのは自明として、隣り合うセグメントが端点で互いに接続していればよいので、<br>
任意の$i$について、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>c_{i,2}=c_{i+1,0}
</code></pre></div></div>

<p>が満たされればよいですね。簡単。次に行きましょう。</p>

<h2>
<span id="制約３g連続" class="fragment"></span><a href="#%E5%88%B6%E7%B4%84%EF%BC%93g%E9%80%A3%E7%B6%9A"><i class="fa fa-link"></i></a>制約３：G¹連続</h2>

<p>セグメントの<strong>接続点</strong>の<strong>傾き</strong>が連続であることを保証する制約です。<br>
これがないと、セグメントとセグメントの間で線が折れてしまいます。</p>

<p>任意の$i$について、ある$\lambda_i\in(0,1)$があって、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>c_{i,2}=(1-\lambda_i)c_{i,1}+\lambda_ic_{i+1,1}
</code></pre></div></div>

<p>が満たされれば、$c_{i,2}=c_{i+1,0}$における接線は$c_{i,1}$と$c_{i+1,1}$を結ぶ直線に定まります。<br>
κ-Curvesにおいてベジェ制御点は入力ではなく出力なので、これで全ての場合が網羅されています。</p>

<h3>
<span id="ユーザ制御点位置の別表示" class="fragment"></span><a href="#%E3%83%A6%E3%83%BC%E3%82%B6%E5%88%B6%E5%BE%A1%E7%82%B9%E4%BD%8D%E7%BD%AE%E3%81%AE%E5%88%A5%E8%A1%A8%E7%A4%BA"><i class="fa fa-link"></i></a>ユーザ制御点位置の別表示</h3>

<p>またこの制約のもとでは、ユーザ制御点の位置$p_i=c_i(t_i)$を、$c_{i,0}, c_{i,2}$を使わずに以下のように表現可能です。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>p_i=(1-\lambda_{i-1})(1-t_i)^2c_{i-1,1}+\big(\lambda_{i-1}(1-t_i)^2+(2-(1+\lambda_i)t_i)t_i\big)c_{i,1}+\lambda_it_i^2c_{i+1,1}
</code></pre></div></div>

<p>何でそんな変形を？　と思うかもしれませんが、後で使います。</p>

<h2>
<span id="制約４ほぼg連続" class="fragment"></span><a href="#%E5%88%B6%E7%B4%84%EF%BC%94%E3%81%BB%E3%81%BCg%E9%80%A3%E7%B6%9A"><i class="fa fa-link"></i></a>制約４：ほぼG²連続</h2>

<p>セグメントの<strong>接続点</strong>の<strong>曲率</strong>が（ほぼ）連続であることを保証する制約です。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\kappa_i(t)=\frac{\triangle(c_{i,0},c_{i,1},c_{i,2})}{\|(1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1})\|^3}
</code></pre></div></div>

<p>で、任意の$i$について$\kappa_i(1)=\kappa_{i+1}(0)$であればいいので、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
\kappa_i(1)&amp;=\kappa_{i+1}(0)\\\\
\frac{\triangle(c_{i,0},c_{i,1},c_{i,2})}{\|c_{i,2}-c_{i,1}\|^3}
&amp;=\frac{\triangle(c_{i+1,0},c_{i+1,1},c_{i+1,2})}{\|c_{i+1,1}-c_{i+1,0}\|^3}\\\\
\frac{\triangle(c_{i,0},c_{i,1},c_{i,2})}{\|c_{i,1}-c_{i+1,1}\|^3\lambda_i^3}
&amp;=\frac{\triangle(c_{i+1,0},c_{i+1,1},c_{i+1,2})}{\|c_{i,1}-c_{i+1,1}\|^3(1-\lambda_i)^3}\\\\
\frac{\triangle(c_{i,0},c_{i,1},c_{i+1,1})}{\lambda_i^2}
&amp;=\frac{\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})}{(1-\lambda_i)^2}
\end{align}
</code></pre></div></div>

<p>より（最後の式変形は図を書いて面積比に着目するとすぐ分かります）、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\lambda_i=\frac{\sqrt{\triangle(c_{i,0},c_{i,1},c_{i+1,1})}}{\sqrt{\triangle(c_{i,0},c_{i,1},c_{i+1,1})}+\sqrt{\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})}}
</code></pre></div></div>

<p>が得られます。</p>

<p>ところで、ベジェ曲線の曲率が０になることはないので、隣り合うセグメントの凹凸が逆である場合、曲率は必ず不連続になります。<br>
このとき、$\triangle(c_{i,0},c_{i,1},c_{i+1,1}),\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})$の符号が異なるので、$\lambda_i$は実数ではなくなります。</p>

<p>一致させられないのであれば、せめて絶対値の差を０にしましょう。<br>
つまり$|\kappa_i(1)|=|\kappa_{i+1}(0)|$を解くわけですが、$\kappa_i(1)$と$\kappa_{i+1}(0)$の符号は逆なので、$\kappa_i(1)=-\kappa_{i+1}(0)$を解けばいいことがわかります。<br>
すると、曲率が連続の場合とほぼ同様の手順で、以下が求まります。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\lambda_i=\frac{\sqrt{|\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}}{\sqrt{|\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}+\sqrt{|\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})|}}
</code></pre></div></div>

<p>これは先程の式も包含できているので、制約式としてはこちらのみを使えばよさそうです。</p>

<h2>
<span id="制約まとめ" class="fragment"></span><a href="#%E5%88%B6%E7%B4%84%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>制約まとめ</h2>

<p>制約とその関連式をまとめると、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left\{\begin{array}{ll}
(1)&amp;\|c'_{i,2}\|^2t_i^3-3c'_{i,2}p'_it_i^2+(2p_i'+c_{i,2}')p_i't_i-\|p_i'\|^2=0\\
&amp;(c_{i,2}'=c_{i,2}-c_{i,0},\ p_i'=p_i-c_{i,0})\\\\
(2)&amp;c_{i,2}=c_{i+1,0}=(1-\lambda_i)c_{i,1}+\lambda_ic_{i+1,1}\\\\
(3)&amp;p_i=(1-\lambda_{i-1})(1-t_i)^2c_{i-1,1}+\big(\lambda_{i-1}(1-t_i)^2+(2-(1+\lambda_i)t_i)t_i\big)c_{i,1}+\lambda_it_i^2c_{i+1,1}\\\\
(4)&amp;\lambda_i=\displaystyle\frac{\sqrt{|\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}}{\sqrt{|\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}+\sqrt{|\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})|}}\\
\end{array}\right.
</code></pre></div></div>

<p>が満たされるようにベジェ制御点$c_{i,j}$を定めればよいことになります。<br>
が、これをこのまま解析的に解くのは困難です。</p>

<h2>
<span id="アルゴリズム" class="fragment"></span><a href="#%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0"><i class="fa fa-link"></i></a>アルゴリズム</h2>

<p>式(1)～(4)を使ってできることを並べてみると、</p>

<ul>
<li>全ての$c_{i,0}, c_{i,2}$があれば、(1)で全ての$t_i$を求められる</li>
<li>全ての$\lambda_i, c_{i,1}$があれば、(2)で全ての$c_{i,0}, c_{i,2}$を求められる</li>
<li>全ての$\lambda_i, t_i$があれば、(3)で全ての$c_{i,1}$を求められる</li>
<li>全ての$c_{i,0},c_{i,1},c_{i,2}$があれば、(4)で全ての$\lambda_i$を求められる</li>
</ul>

<p>となります。<br>
これらをうまく組み合わせて、全ての$p_i$から全ての$c_{i,j}$を出力したいわけです。</p>

<h3>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h3>

<p>適当な初期値から始めて、何度も式を適用することで正解に近づけていく方針を取ります。</p>

<ul>
<li>
<strong>Step0.</strong> 各$\lambda_i,\ c_{i,j}$を初期化</li>
<li>
<strong>Step1.</strong> 式(4)で各$\lambda_i$を算出・更新</li>
<li>
<strong>Step2.</strong> 式(2)で各$c_{i,0}, c_{i,2}$を更新</li>
<li>
<strong>Step3.</strong> 式(1)で各$t_i$を算出・更新</li>
<li>
<strong>Step4.</strong> 式(3)で各$c_{i,1}$を更新</li>
<li>If 満足 

<ul>
<li>then <strong>return</strong> $c_{i,j}$ </li>
<li>else <strong>goto</strong> Step1.</li>
</ul>
</li>
</ul>

<p>各ステップに分けて見ていきましょう。</p>

<h3>
<span id="step0-初期化" class="fragment"></span><a href="#step0-%E5%88%9D%E6%9C%9F%E5%8C%96"><i class="fa fa-link"></i></a>Step0. 初期化</h3>

<p>以下のように初期化します。</p>

<ul>
<li>$\lambda_i=0.5$</li>
<li>$c_{i,1}=p_i$</li>
<li>$c_{i,2}=c_{i+1,0} = (1-\lambda_i)c_{i,1}+\lambda_ic_{i+1,1} =  (c_{i,1} + c_{i+1,1})/2$</li>
</ul>

<p>つまり、ユーザ制御点と中央のベジェ制御点が同じ場所にあり、<br>
その他のベジェ制御点は隣接制御点の中点にある状態から始まります。<br>
<a href="https://camo.qiitausercontent.com/7e1a3ed106963c9a059975d75bf0cfc514b75cd3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f62633461363331612d616639632d373733312d383563342d3063653438303630653562332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fbc4a631a-af9c-7731-85c4-0ce48060e5b3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=127067bc91622ef8b67d4151d2dcf985" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/bc4a631a-af9c-7731-85c4-0ce48060e5b3.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fbc4a631a-af9c-7731-85c4-0ce48060e5b3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0e579008625b868b1c4f4c87f5440127 1x" loading="lazy"></a><br>
これは論文から引用した図で、初期化時の状態の例です。<br>
黒い四角がユーザ制御点$p_i$で、$c_{i,1}$と一致しています。緑色の点は各セグメントの曲率極大点$c_i(t_i)$です。<br>
今はまだ$p_i$と$c_i(t_i)$が離れていますが、この後のStep1～4のイテレーションを回すことで近づけていきます。<br>
<a href="https://camo.qiitausercontent.com/1789a765b8cfe6751b9cd6eefcc4ba3632b28615/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f66343939333239632d626363352d313863342d646465632d3166646565613732643763392e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Ff499329c-bcc5-18c4-ddec-1fdeea72d7c9.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7f1374ee3d94938adbd1eaa18334c270" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/f499329c-bcc5-18c4-ddec-1fdeea72d7c9.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Ff499329c-bcc5-18c4-ddec-1fdeea72d7c9.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f3fd7a9d1910ba609ac293ee7a01df56 1x" loading="lazy"></a><br>
左から順に、初期状態、１ループ後、２ループ後、３０ループ後（完全収束）です。<br>
ループ数は誤植ではなく、本当に数ループでほとんど完全収束と同じような形になります。</p>

<h3>
<span id="step1-λの算出" class="fragment"></span><a href="#step1-%CE%BB%E3%81%AE%E7%AE%97%E5%87%BA"><i class="fa fa-link"></i></a>Step1. λの算出</h3>

<p>式(4):</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\lambda_i=\frac{\sqrt{|\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}}{\sqrt{|\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}+\sqrt{|\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})|}}
</code></pre></div></div>

<p>を適用します。やるだけ。</p>

<h3>
<span id="step2-ベジェ制御点両端の更新" class="fragment"></span><a href="#step2-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%A1%E7%AB%AF%E3%81%AE%E6%9B%B4%E6%96%B0"><i class="fa fa-link"></i></a>Step2. ベジェ制御点（両端）の更新</h3>

<p>式(2):</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>c_{i,2}=c_{i+1,0}=(1-\lambda_i)c_{i,1}+\lambda_ic_{i+1,1}
</code></pre></div></div>

<p>を計算します。これもやるだけ。</p>

<h3>
<span id="step3-曲率極大点の算出" class="fragment"></span><a href="#step3-%E6%9B%B2%E7%8E%87%E6%A5%B5%E5%A4%A7%E7%82%B9%E3%81%AE%E7%AE%97%E5%87%BA"><i class="fa fa-link"></i></a>Step3. 曲率極大点の算出</h3>

<p>式(1):</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\|c'_{i,2}\|^2t_i^3-3c'_{i,2}p'_it_i^2+(2p_i'+c_{i,2}')p_i't_i-\|p_i'\|^2=0\ \ \ (c_{i,2}'=c_{i,2}-c_{i,0},\ p_i'=p_i-c_{i,0})
</code></pre></div></div>

<p>を解きます。カルダノの公式（三次方程式の解の公式）を組みましょう。<br>
実解がただ一つ$[0,1]$に存在することが分かっています。</p>

<h3>
<span id="step4-ベジェ制御点中央の更新" class="fragment"></span><a href="#step4-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%AD%E5%A4%AE%E3%81%AE%E6%9B%B4%E6%96%B0"><i class="fa fa-link"></i></a>Step4. ベジェ制御点（中央）の更新</h3>

<p>式(3):</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>p_i=(1-\lambda_{i-1})(1-t_i)^2c_{i-1,1}+\big(\lambda_{i-1}(1-t_i)^2+(2-(1+\lambda_i)t_i)t_i\big)c_{i,1}+\lambda_it_i^2c_{i+1,1}
</code></pre></div></div>

<p>を、全ての$c_{i,1}$について解きます。n元連立１次方程式ですね。<br>
中学・高校の数学の範囲でも気合で解くことはできそうですが、行列を使うと簡単になります。</p>

<p>まず、係数を$\alpha_i, \beta_i, \gamma_i$として見やすく書き直しておきます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>p_i=\alpha_ic_{i-1,1}+\beta_ic_{i,1}+\gamma_ic_{i+1,1}
</code></pre></div></div>

<p>これは、以下のように行列表示の連立方程式にまとめることができます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left(\begin{matrix}
\beta_0&amp;\gamma_0&amp;&amp;&amp;\alpha_0\\
\alpha_1&amp;\beta_1&amp;\gamma_1&amp;&amp;\\
&amp;&amp;\ddots&amp;&amp;\\
&amp;&amp;\alpha_{n-2}&amp;\beta_{n-2}&amp;\gamma_{n-2}\\
\gamma_{n-1}&amp;&amp;&amp;\alpha_{n-1}&amp;\beta_{n-1}
\end{matrix}\right)
\left(\begin{matrix}
c_{0,1}\\
c_{1,1}\\
\vdots\\
c_{n-2,1}\\
c_{n-1,1}\\
\end{matrix}\right)
=
\left(\begin{matrix}
p_0\\
p_1\\
\vdots\\
p_{n-2}\\
p_{n-1}\\
\end{matrix}\right)
</code></pre></div></div>

<p>行列部分は<strong>三重対角行列＋角</strong>なので、高速に<strong>LU分解</strong>でき、解を$O(n)$で求めることができます。<br>
さらに、これを上下に（行列は上下左右に）１つずつ拡張して</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left(\begin{matrix}
1&amp;0&amp;&amp;&amp;\\
\alpha_0&amp;\beta_0&amp;\gamma_0&amp;&amp;\\
&amp;&amp;\ddots&amp;&amp;\\
&amp;&amp;\alpha_{n-1}&amp;\beta_{n-1}&amp;\gamma_{n-1}\\
&amp;&amp;&amp;0&amp;1
\end{matrix}\right)
\left(\begin{matrix}
c_{n-1,1}\\
c_{0,1}\\
\vdots\\
c_{n-1,1}\\
c_{0,1}\\
\end{matrix}\right)
=
\left(\begin{matrix}
c_{n-1,1}\\
p_0\\
\vdots\\
p_{n-1}\\
c_{0,1}\\
\end{matrix}\right)
</code></pre></div></div>

<p>という形にすれば、行列部分はただの三重対角行列になるので、さらに計算が楽になります。</p>

<p>また、$n\ge5$の場合は<strong>メモリ的にも有利になります。</strong><br>
角つき三重対角行列はLU分解のためにメモリを$n\times n$要素分、頑張って削減しても$5\times n$要素分くらい食うのに対し、上下に伸ばした三重対角行列は$3\times (n+2)$要素分で済むのです。</p>

<p>LU分解については記事の最後の付録で解説します。</p>

<h2>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h2>

<p>実際に実装していきましょう。<br>
言語はC#で、座標表現やfloatの各種演算にUnityのVector2クラス、Mathfクラスを借りています。<br>
Unity特有の何かがあるわけではないので、適宜好きな言語、好きなベクトル表現・数学ライブラリに置き換えてください。</p>

<h3>
<span id="ベジェ制御点用構造体" class="fragment"></span><a href="#%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E7%94%A8%E6%A7%8B%E9%80%A0%E4%BD%93"><i class="fa fa-link"></i></a>ベジェ制御点用構造体</h3>

<p>ただの配列のラッパーです。計算結果の出力もこのインスタンスで。<br>
ベジェ制御点は隣接セグメント間で重複するので、配列サイズは重複を除いた最低限の$2n+1$とします。<br>
ただ分かりにくいので、ここまでの解説に合わせて[i,j]でアクセスできるようにしておきます。<br>
また、$n&lt;3$の場合は点か直線を表示することが予想されるので、セグメント数を1とします。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">struct</span> <span class="nc">BezierControls</span>
<span class="p">{</span>
    <span class="c1">//ベジェ制御点群</span>
    <span class="c1">//c_{0,0}, c_{0,1}, c_{1,0}, ..., c_{n-1,0}, c_{n-1,1}, c_{n-1,2}の順</span>
    <span class="k">public</span> <span class="n">Vector2</span><span class="p">[]</span> <span class="n">Points</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">//セグメント数</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">SegmentCount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">//c_{i,j}</span>
    <span class="k">public</span> <span class="n">Vector2</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">Points</span><span class="p">[</span><span class="m">2</span> <span class="p">*</span> <span class="n">i</span> <span class="p">+</span> <span class="n">j</span><span class="p">];</span>
        <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">Points</span><span class="p">[</span><span class="m">2</span> <span class="p">*</span> <span class="n">i</span> <span class="p">+</span> <span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//コンストラクタ</span>
    <span class="k">public</span> <span class="nf">BezierControls</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">SegmentCount</span> <span class="p">=</span> <span class="n">n</span> <span class="p">&lt;</span> <span class="m">3</span> <span class="p">?</span> <span class="m">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">;</span>
        <span class="n">Points</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">[</span><span class="m">2</span> <span class="p">*</span> <span class="n">SegmentCount</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="計算空間の確保" class="fragment"></span><a href="#%E8%A8%88%E7%AE%97%E7%A9%BA%E9%96%93%E3%81%AE%E7%A2%BA%E4%BF%9D"><i class="fa fa-link"></i></a>計算空間の確保</h3>

<p>ユーザ制御点が移動する度に描画を更新するわけなので、計算空間は事前に確保して使い回しましょう。<br>
制御点が増減すると確保し直しになりますが、その辺りを考慮するとコードが煩雑になるのでここでは妥協。<br>
Step4の行列計算時に使うメモリは三重対角部分だけで済むので、配列は$3(n+2)$要素だけ確保します。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CalcSpace</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">N</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>              <span class="c1">//制御点数</span>
    <span class="k">internal</span> <span class="kt">float</span><span class="p">[]</span> <span class="n">L</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>        <span class="c1">//λ</span>
    <span class="k">internal</span> <span class="n">BezierControls</span> <span class="n">C</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">//ベジェ制御点（出力）</span>
    <span class="k">internal</span> <span class="kt">double</span><span class="p">[]</span> <span class="n">T</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>       <span class="c1">//t</span>
    <span class="k">internal</span> <span class="kt">double</span><span class="p">[]</span> <span class="n">A</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>       <span class="c1">//Step4の行列計算用メモリ</span>

    <span class="k">public</span> <span class="nf">CalcSpace</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">N</span> <span class="p">=</span> <span class="n">n</span><span class="p">;</span>
        <span class="n">L</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
        <span class="n">C</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BezierControls</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
        <span class="n">T</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
        <span class="n">A</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[(</span><span class="n">n</span> <span class="p">+</span> <span class="m">2</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="n">BezierControls</span> <span class="n">Result</span> <span class="p">=&gt;</span> <span class="n">C</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="ユーザ制御点ベジェ制御点の上下拡張" class="fragment"></span><a href="#%E3%83%A6%E3%83%BC%E3%82%B6%E5%88%B6%E5%BE%A1%E7%82%B9%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E3%81%AE%E4%B8%8A%E4%B8%8B%E6%8B%A1%E5%BC%B5"><i class="fa fa-link"></i></a>ユーザ制御点・ベジェ制御点の上下拡張</h3>

<p>Step4の行列計算時にユーザ制御点ベクトルとベジェ制御点ベクトルを上下拡張しますが、その際のメモリ確保をなくしつつちゃんと配列っぽく扱えるようにするためのラッパー構造体です。<br>
コンストラクタで上下拡張時の値の初期化もやっています。<br>
本質部分ではないしC#の人じゃないとたぶん意味が分からないので適当に読み飛ばしてください。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">struct</span> <span class="nc">ExtendedPlayerControls</span>
<span class="p">{</span>
    <span class="n">Vector2</span> <span class="n">top</span><span class="p">;</span>
    <span class="n">Vector2</span><span class="p">[]</span> <span class="n">ps</span><span class="p">;</span>
    <span class="n">Vector2</span> <span class="n">bottom</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">Vector2</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">i</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">i</span> <span class="p">==</span> <span class="m">0</span> <span class="p">?</span> <span class="n">top</span> <span class="p">:</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="n">ps</span><span class="p">.</span><span class="n">Length</span> <span class="p">?</span> <span class="n">ps</span><span class="p">[</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">bottom</span><span class="p">;</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="n">top</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;=</span> <span class="n">ps</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="n">ps</span><span class="p">[</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
            <span class="k">else</span> <span class="n">bottom</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">ExtendedPlayerControls</span><span class="p">(</span><span class="n">Vector2</span><span class="p">[]</span> <span class="n">ps</span><span class="p">,</span> <span class="n">BezierControls</span> <span class="n">cs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">top</span> <span class="p">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">cs</span><span class="p">.</span><span class="n">SegmentCount</span><span class="p">-</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="n">ps</span> <span class="p">=</span> <span class="n">ps</span><span class="p">;</span>
        <span class="n">bottom</span> <span class="p">=</span> <span class="n">cs</span><span class="p">[</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">struct</span> <span class="nc">ExtendedBezierControls</span>
<span class="p">{</span>
    <span class="n">Vector2</span> <span class="n">top</span><span class="p">;</span>
    <span class="n">Vector2</span><span class="p">[]</span> <span class="n">cs</span><span class="p">;</span>
    <span class="n">Vector2</span> <span class="n">bottom</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">Vector2</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">i</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">i</span> <span class="p">==</span> <span class="m">0</span> <span class="p">?</span> <span class="n">top</span> <span class="p">:</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="n">cs</span><span class="p">.</span><span class="n">Length</span> <span class="p">/</span> <span class="m">2</span> <span class="p">?</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span> <span class="p">*</span> <span class="m">2</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">bottom</span><span class="p">;</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="n">top</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;=</span> <span class="n">cs</span><span class="p">.</span><span class="n">Length</span> <span class="p">/</span> <span class="m">2</span><span class="p">)</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span> <span class="p">*</span> <span class="m">2</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
            <span class="k">else</span> <span class="n">bottom</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">ExtendedBezierControls</span><span class="p">(</span><span class="n">BezierControls</span> <span class="n">cs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">top</span> <span class="p">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">cs</span><span class="p">.</span><span class="n">SegmentCount</span> <span class="p">-</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="n">cs</span> <span class="p">=</span> <span class="n">cs</span><span class="p">.</span><span class="n">Points</span><span class="p">;</span>
        <span class="n">bottom</span> <span class="p">=</span> <span class="n">cs</span><span class="p">[</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="メソッドルート" class="fragment"></span><a href="#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%83%AB%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>メソッドルート</h3>

<p>処理の根本になる部分を作ります。</p>

<ul>
<li>ユーザ制御点 <code>points</code>
</li>
<li>計算空間 <code>space</code>
</li>
<li>イテレーション回数 <code>iteration</code>
</li>
<li>曲線をループさせるかどうか <code>isLoop</code>
</li>
</ul>

<p>を受け取り、Step0で初期化し、Step1～4でイテレーションを回し、最適化の結果を返します。<br>
ただしユーザ制御点が２つ以下の場合は、それぞれ点や直線となるように制御点を配置して返します。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">BezierControls</span> <span class="nf">CalcBezierControls</span><span class="p">(</span><span class="n">Vector2</span><span class="p">[]</span> <span class="n">points</span><span class="p">,</span> <span class="n">CalcSpace</span> <span class="n">space</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iteration</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLoop</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">points</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="n">space</span><span class="p">.</span><span class="n">N</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">$"The length of </span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">points</span><span class="p">)}</span><span class="s"> must equals to </span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">space</span><span class="p">)}</span><span class="s">.</span><span class="p">{</span><span class="k">nameof</span><span class="p">(</span><span class="n">space</span><span class="p">.</span><span class="n">N</span><span class="p">)}</span><span class="s">."</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">points</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">.</span><span class="n">Points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">points</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">.</span><span class="n">Points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">points</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
        <span class="k">return</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">points</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">.</span><span class="n">Points</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">points</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
        <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">.</span><span class="n">Points</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">+</span> <span class="n">points</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span>
        <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">.</span><span class="n">Points</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="n">points</span><span class="p">[</span><span class="m">1</span><span class="p">];</span>
        <span class="k">return</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nf">Step0</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iteration</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="nf">Step1</span><span class="p">(</span><span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>
        <span class="nf">Step2</span><span class="p">(</span><span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">L</span><span class="p">);</span>
        <span class="nf">Step3</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">);</span>
        <span class="nf">Step4</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>では、各Stepの実装をしましょう。<br>
ループしない場合の対応も一緒にやっていきます。</p>

<h3>
<span id="step0-初期化-1" class="fragment"></span><a href="#step0-%E5%88%9D%E6%9C%9F%E5%8C%96-1"><i class="fa fa-link"></i></a>Step0: 初期化</h3>

<p>初期化内容はこうでした。</p>

<ul>
<li>$\lambda_i=0.5$</li>
<li>$c_{i,1}=p_i$</li>
<li>$c_{i,2}=c_{i+1,0} = (1-\lambda_i)c_{i,1}+\lambda_ic_{i+1,1}$</li>
</ul>

<p>非ループの場合、始端と終端はユーザ制御点であってほしいので、初期化時に固定してしまいましょう。</p>

<ul>
<li>$\lambda_0=0$</li>
<li>$\lambda_{n-2}=1$</li>
<li>$\lambda_{n-1}=\rm{undefined}$</li>
</ul>

<p>非ループの場合、終端→始端のカーブは必要なくなるので、ループの場合より<strong>セグメントが２つ減る</strong>ことに注意してください。その結果、$\lambda_{n-1}$は参照されなくなります。</p>

<p>セグメントが１つではなく２つ減るのは直感的ではありませんが、実際に見れば納得できるでしょう。<br>
<a href="https://camo.qiitausercontent.com/e5236d2d663c6d73e6d58179487dfa5ec63447fb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f35363262336433302d326438632d353834642d343132622d3239323734386631303335392e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F562b3d30-2d8c-584d-412b-292748f10359.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e4f57d5c34c6a0506c210303daf45c15" alt="コメント 2020-02-04 122030.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/562b3d30-2d8c-584d-412b-292748f10359.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F562b3d30-2d8c-584d-412b-292748f10359.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=c90b6129ff411a67c7c670c5cff09622 1x" loading="lazy"></a><br>
黄色・水色・ピンクの線が各セグメントのベジェ制御点を結んだものです。<br>
非ループの場合、水色とピンクの線が潰れているのが分かるでしょうか。</p>

<p>ついでに、Step4で使う行列（の三重対角部分を保存するためのメモリ）の両端部の初期化もしてしまいます：</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>A=\left(\begin{matrix}
0&amp;1&amp;0\\
\alpha_0&amp;\beta_0&amp;\gamma_0\\
&amp;\vdots&amp;\\
\alpha_{n-1}&amp;\beta_{n-1}&amp;\gamma_{n-1}\\
0&amp;1&amp;0\\
\end{matrix}\right)
</code></pre></div></div>

<p>非ループの場合、$c_{0,1}=p_0,\ c_{n-1,1}=p_{n-1}$となればよいので、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>A=\left(\begin{matrix}
0&amp;1&amp;0\\
0&amp;1&amp;0\\
\alpha_1&amp;\beta_1&amp;\gamma_1\\
&amp;\vdots&amp;\\
\alpha_{n-2}&amp;\beta_{n-2}&amp;\gamma_{n-2}\\
0&amp;1&amp;0\\
0&amp;1&amp;0\\
\end{matrix}\right)
</code></pre></div></div>

<p>とします。</p>

<p>コードはこんな感じ。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="k">void</span> <span class="nf">Step0</span><span class="p">(</span><span class="n">Vector2</span><span class="p">[]</span> <span class="n">ps</span><span class="p">,</span> <span class="n">BezierControls</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">float</span><span class="p">[]</span> <span class="n">lambdas</span><span class="p">,</span> <span class="kt">double</span><span class="p">[]</span> <span class="n">A</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLoop</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">n</span> <span class="p">=</span> <span class="n">ps</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>

    <span class="c1">//全てのλを0.5で初期化</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>

    <span class="c1">//ループしない場合、最初と最後から２番目を0,1に変更（最後はそもそも使わない）</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">isLoop</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">lambdas</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">lambdas</span><span class="p">[</span><span class="n">n</span> <span class="p">-</span> <span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
        <span class="c1">//lambdas[n - 1] = undefined;</span>
    <span class="p">}</span>

    <span class="c1">//中央のベジェ制御点を全てユーザ制御点で初期化</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

    <span class="c1">//他のベジェ制御点を初期化</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">next</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">)</span> <span class="p">%</span> <span class="n">n</span><span class="p">;</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">next</span><span class="p">,</span> <span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">*</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">1</span><span class="p">]</span> <span class="p">+</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">*</span> <span class="n">cs</span><span class="p">[</span><span class="n">next</span><span class="p">,</span> <span class="m">1</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">//行列の端の値は固定</span>
    <span class="n">A</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">A</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">A</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">A</span><span class="p">[</span><span class="n">A</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">A</span><span class="p">[</span><span class="n">A</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="n">A</span><span class="p">[</span><span class="n">A</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">isLoop</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//非ループの場合はさらにもう一行ずつ固定</span>
        <span class="n">A</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">A</span><span class="p">[</span><span class="m">4</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
        <span class="n">A</span><span class="p">[</span><span class="m">5</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">A</span><span class="p">[</span><span class="n">A</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">4</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">A</span><span class="p">[</span><span class="n">A</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">5</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
        <span class="n">A</span><span class="p">[</span><span class="n">A</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">6</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3>
<span id="step1-λの算出-1" class="fragment"></span><a href="#step1-%CE%BB%E3%81%AE%E7%AE%97%E5%87%BA-1"><i class="fa fa-link"></i></a>Step1: λの算出</h3>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\lambda_i=\frac{\sqrt{|\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}}{\sqrt{|\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}+\sqrt{|\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})|}}
</code></pre></div></div>

<p>三角形の面積を求める解説は必要ないでしょう。外積の半分です。<br>
非ループ時は始端と終端のλは更新しません。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="k">void</span> <span class="nf">Step1</span><span class="p">(</span><span class="n">BezierControls</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">float</span><span class="p">[]</span> <span class="n">lambdas</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLoop</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//三角形の面積を求める関数</span>
    <span class="kt">float</span> <span class="nf">TriArea</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">p1</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">p2</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">p3</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">p1</span> <span class="p">-=</span> <span class="n">p3</span><span class="p">;</span> <span class="n">p2</span> <span class="p">-=</span> <span class="n">p3</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">p2</span><span class="p">.</span><span class="n">y</span> <span class="p">-</span> <span class="n">p2</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">/</span> <span class="m">2f</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">n</span> <span class="p">=</span> <span class="n">lambdas</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">begin</span> <span class="p">=</span> <span class="n">isLoop</span> <span class="p">?</span> <span class="m">0</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">end</span> <span class="p">=</span> <span class="n">isLoop</span> <span class="p">?</span> <span class="n">n</span> <span class="p">:</span> <span class="n">n</span> <span class="p">-</span> <span class="m">2</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="n">begin</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">next</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">)</span> <span class="p">%</span> <span class="n">n</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">c</span> <span class="p">=</span> <span class="n">cs</span><span class="p">.</span><span class="n">Points</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">t1</span> <span class="p">=</span> <span class="nf">TriArea</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">*</span><span class="m">2</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">*</span><span class="m">2</span><span class="p">+</span><span class="m">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">next</span><span class="p">*</span><span class="m">2</span><span class="p">+</span><span class="m">1</span><span class="p">]);</span>
        <span class="kt">var</span> <span class="n">t2</span> <span class="p">=</span> <span class="nf">TriArea</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">*</span><span class="m">2</span><span class="p">+</span><span class="m">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">next</span><span class="p">*</span><span class="m">2</span><span class="p">+</span><span class="m">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">next</span><span class="p">*</span><span class="m">2</span><span class="p">+</span> <span class="m">2</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">t1</span> <span class="p">-</span> <span class="n">t2</span><span class="p">)</span> <span class="p">&lt;</span> <span class="m">0.00001f</span><span class="p">)</span>
            <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">t1</span> <span class="p">-</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">t1</span> <span class="p">*</span> <span class="n">t2</span><span class="p">))</span> <span class="p">/</span> <span class="p">(</span><span class="n">t1</span> <span class="p">-</span> <span class="n">t2</span><span class="p">);</span>   
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Sqrt計算を減らすために一応有理化して、分母がほぼ0のときは計算させず0.5にしています。</p>

<p>なおκ-Curvesは３次元曲線にしても全く同じアルゴリズムで使えますが、外積の定義を３次元版（の絶対値）に変えるのを忘れないようにしましょう。</p>

<h3>
<span id="step2-ベジェ制御点両端の更新-1" class="fragment"></span><a href="#step2-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%A1%E7%AB%AF%E3%81%AE%E6%9B%B4%E6%96%B0-1"><i class="fa fa-link"></i></a>Step2: ベジェ制御点（両端）の更新</h3>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>c_{i,2}=c_{i+1,0}=(1-\lambda_i)c_{i,1}+\lambda_ic_{i+1,1}
</code></pre></div></div>

<p>やるだけです。<br>
$\lambda_i$の方で非ループ対応はしているので、ここでは特に何もしません。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="k">void</span> <span class="nf">Step2</span><span class="p">(</span><span class="n">BezierControls</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">float</span><span class="p">[]</span> <span class="n">lambdas</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">n</span> <span class="p">=</span> <span class="n">lambdas</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">cs</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">*</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">1</span><span class="p">]</span> <span class="p">+</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">*</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">cs</span><span class="p">[</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">n</span> <span class="p">-</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">n</span> <span class="p">-</span> <span class="m">1</span><span class="p">])</span> <span class="p">*</span> <span class="n">cs</span><span class="p">[</span><span class="n">n</span> <span class="p">-</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">]</span> <span class="p">+</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">n</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">*</span> <span class="n">cs</span><span class="p">[</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>※<code>BezierControls</code>の実体は最後以外の$c_{i,2}$を削った配列なので、最後以外は片方だけに代入しています。</p>

<h3>
<span id="step3-曲率極大点の算出-1" class="fragment"></span><a href="#step3-%E6%9B%B2%E7%8E%87%E6%A5%B5%E5%A4%A7%E7%82%B9%E3%81%AE%E7%AE%97%E5%87%BA-1"><i class="fa fa-link"></i></a>Step3: 曲率極大点の算出</h3>

<p>三次方程式：</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\|c'_{i,2}\|^2t_i^3-3c'_{i,2}p'_it_i^2+(2p_i'+c_{i,2}')p_i't_i-\|p_i'\|^2=0\ \ \ (c_{i,2}'=c_{i,2}-c_{i,0},\ p_i'=p_i-c_{i,0})
</code></pre></div></div>

<p>を解きます。<br>
三次方程式には解の公式（カルダノの公式）があるので、それを組みましょう。<br>
複素解や$[0,1]$範囲外の実解は無視します。</p>

<p>なお、実解の範囲が分かっているので二分探索などをしてもよいですが、全体の計算時間が５倍くらいに跳ね上がります。オススメしません。</p>

<p>$ax^3+bx^2+cx+d=0$の$[0,1]$内の実解のみを返すカルダノの公式：</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="kt">double</span> <span class="nf">SolveCubicEquation</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">,</span> <span class="kt">double</span> <span class="n">c</span><span class="p">,</span> <span class="kt">double</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//負の値に対応した３乗根</span>
    <span class="kt">double</span> <span class="nf">Cbrt</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">*</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Pow</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="m">1.0</span> <span class="p">/</span> <span class="m">3</span><span class="p">);</span>

    <span class="n">b</span> <span class="p">/=</span> <span class="n">a</span> <span class="p">*</span> <span class="m">3</span><span class="p">;</span>
    <span class="n">c</span> <span class="p">/=</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">d</span> <span class="p">/=</span> <span class="n">a</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="n">c</span> <span class="p">/</span> <span class="m">3</span> <span class="p">-</span> <span class="n">b</span> <span class="p">*</span> <span class="n">b</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">q</span> <span class="p">=</span> <span class="n">b</span> <span class="p">*</span> <span class="n">b</span> <span class="p">*</span> <span class="n">b</span> <span class="p">-</span> <span class="p">(</span><span class="n">b</span> <span class="p">*</span> <span class="n">c</span> <span class="p">-</span> <span class="n">d</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">D</span> <span class="p">=</span> <span class="n">q</span> <span class="p">*</span> <span class="n">q</span> <span class="p">+</span> <span class="n">p</span> <span class="p">*</span> <span class="n">p</span> <span class="p">*</span> <span class="n">p</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="p">&lt;</span> <span class="m">1.0E-12</span><span class="p">)</span> <span class="c1">//D = 0</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">ret</span> <span class="p">=</span> <span class="nf">Cbrt</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="p">-</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="n">ret</span> <span class="p">*</span> <span class="p">-</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">D</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">sqrtD</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">u</span> <span class="p">=</span> <span class="nf">Cbrt</span><span class="p">(-</span><span class="n">q</span> <span class="p">+</span> <span class="n">sqrtD</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">v</span> <span class="p">=</span> <span class="nf">Cbrt</span><span class="p">(-</span><span class="n">q</span> <span class="p">-</span> <span class="n">sqrtD</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">ret</span> <span class="p">=</span> <span class="n">u</span> <span class="p">+</span> <span class="n">v</span> <span class="p">-</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">return</span>  <span class="n">ret</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="p">?</span> <span class="m">0</span> <span class="p">:</span> <span class="n">ret</span> <span class="p">&gt;</span> <span class="m">1</span> <span class="p">?</span> <span class="m">1</span> <span class="p">:</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="c1">//D &lt; 0</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">tmp</span> <span class="p">=</span> <span class="m">2</span> <span class="p">*</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(-</span><span class="n">p</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">arg</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Atan2</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(-</span><span class="n">D</span><span class="p">),</span> <span class="p">-</span><span class="n">q</span><span class="p">)</span> <span class="p">/</span> <span class="m">3</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">double</span> <span class="n">pi2d3</span> <span class="p">=</span> <span class="m">2</span> <span class="p">*</span> <span class="n">Math</span><span class="p">.</span><span class="n">PI</span> <span class="p">/</span> <span class="m">3</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">ret1</span> <span class="p">=</span> <span class="n">tmp</span> <span class="p">*</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">-</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="m">0</span> <span class="p">&lt;=</span> <span class="n">ret1</span> <span class="p">&amp;&amp;</span> <span class="n">ret1</span> <span class="p">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret1</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">ret2</span> <span class="p">=</span> <span class="n">tmp</span> <span class="p">*</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">arg</span> <span class="p">+</span> <span class="n">pi2d3</span><span class="p">)</span> <span class="p">-</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="m">0</span> <span class="p">&lt;=</span> <span class="n">ret2</span> <span class="p">&amp;&amp;</span> <span class="n">ret2</span> <span class="p">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret2</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">ret3</span> <span class="p">=</span> <span class="n">tmp</span> <span class="p">*</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Cos</span><span class="p">(</span><span class="n">arg</span> <span class="p">-</span> <span class="n">pi2d3</span><span class="p">)</span> <span class="p">-</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="m">0</span> <span class="p">&lt;=</span> <span class="n">ret3</span> <span class="p">&amp;&amp;</span> <span class="n">ret3</span> <span class="p">&lt;=</span> <span class="m">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret3</span><span class="p">;</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Invalid solution: </span><span class="p">{</span><span class="n">ret1</span><span class="p">}</span><span class="s">, </span><span class="p">{</span><span class="n">ret2</span><span class="p">}</span><span class="s">, </span><span class="p">{</span><span class="n">ret3</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>参考：<a href="http://www.1728.org/cubic2.htm" rel="nofollow noopener" target="_blank">このページ</a></p>

<p>これを使って、全ての$i$について三次方程式を解きます。</p>

<p>ただし、そもそも三次方程式にならない場合の例外処理を忘れずに。<br>
セグメントが潰れている場合に$a=b=c=d=0$となり不定解となります。ここでは$0.5$を入れておきます。<br>
また、ユーザ制御点がセグメントの端にある場合には計算せずに$0,1$としましょう。</p>

<p>これらのフィルタリングの下では、$a$（と$d$）が非零であることが保証され、カルダノの公式が使えます。<br>
ただし<strong>桁落ち</strong>でたまに破綻するので、実数の精度に気をつけましょう。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="k">void</span> <span class="nf">Step3</span><span class="p">(</span><span class="n">Vector2</span><span class="p">[]</span> <span class="n">ps</span><span class="p">,</span> <span class="n">BezierControls</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">double</span><span class="p">[]</span> <span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">ts</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="c1">//セグメントが潰れている場合は不定解なので0.5とする</span>
        <span class="k">if</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">2</span><span class="p">])</span> <span class="p">{</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">0.5</span><span class="p">;</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>
        <span class="c1">//セグメントの端にユーザ制御点がある場合は図形的に自明</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">0</span><span class="p">])</span> <span class="p">{</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">2</span><span class="p">])</span> <span class="p">{</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="k">continue</span><span class="p">;</span> <span class="p">}</span>

        <span class="kt">var</span> <span class="n">c2</span> <span class="p">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">2</span><span class="p">]</span> <span class="p">-</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">0</span><span class="p">];</span>   <span class="c1">// != 0</span>
        <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="n">ps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">-</span> <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="m">0</span><span class="p">];</span>       <span class="c1">// != 0</span>

        <span class="kt">double</span> <span class="n">a</span> <span class="p">=</span> <span class="n">c2</span><span class="p">.</span><span class="n">sqrMagnitude</span><span class="p">;</span>             <span class="c1">// != 0</span>
        <span class="kt">double</span> <span class="n">b</span> <span class="p">=</span> <span class="p">-</span><span class="m">3</span> <span class="p">*</span> <span class="n">Vector2</span><span class="p">.</span><span class="nf">Dot</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>     
        <span class="kt">double</span> <span class="n">c</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="nf">Dot</span><span class="p">(</span><span class="m">2</span> <span class="p">*</span> <span class="n">p</span> <span class="p">+</span> <span class="n">c2</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>  
        <span class="kt">double</span> <span class="n">d</span> <span class="p">=</span> <span class="p">-</span><span class="n">p</span><span class="p">.</span><span class="n">sqrMagnitude</span><span class="p">;</span>             <span class="c1">// != 0</span>

        <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="nf">SolveCubicEquation</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>余談ですが、上のカルダノの公式が例外を吐く場合は大体、範囲外ではなくNaNになっています。<br>
不定解の例外処理を忘れているか、次のStep4でランク落ちを見過ごして発生したNaNがループで伝播してきている可能性が高いので、確認してみてください。</p>

<h3>
<span id="step4-ベジェ制御点中央の更新-1" class="fragment"></span><a href="#step4-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%AD%E5%A4%AE%E3%81%AE%E6%9B%B4%E6%96%B0-1"><i class="fa fa-link"></i></a>Step4: ベジェ制御点（中央）の更新</h3>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left(\begin{matrix}
1&amp;0&amp;&amp;&amp;\\
\alpha_0&amp;\beta_0&amp;\gamma_0&amp;&amp;\\
&amp;&amp;\ddots&amp;&amp;\\
&amp;&amp;\alpha_{n-1}&amp;\beta_{n-1}&amp;\gamma_{n-1}\\
&amp;&amp;&amp;0&amp;1
\end{matrix}\right)
\left(\begin{matrix}
c_{n-1,1}\\
c_{0,1}\\
\vdots\\
c_{n-1,1}\\
c_{0,1}\\
\end{matrix}\right)
=
\left(\begin{matrix}
c_{n-1,1}\\
p_0\\
\vdots\\
p_{n-1}\\
c_{0,1}\\
\end{matrix}\right)
</code></pre></div></div>

<p>を解きます。ただし、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
\alpha_i&amp;=(1-\lambda_{i-1})(1-t_i)^2\\
\beta_i&amp;=\lambda_{i-1}(1-t_i)^2+(2-(1+\lambda_i)t_i)t_i\\
\gamma_i&amp;=\lambda_it_i^2\\
\end{align}
</code></pre></div></div>

<p>です。<br>
なお非ループの場合、$i=0,n-1$についてはStep0で初期化したように</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
\alpha_0&amp;=\alpha_{n-1}=0\\
\beta_0&amp;=\beta_{n-1}=1\\
\gamma_0&amp;=\gamma_{n-1}=0\\
\end{align}
</code></pre></div></div>

<p>で固定なので、上書きしないようにします。</p>

<p>まずは三重対角行列の連立方程式を解く関数を作っておきます。<br>
三重対角行列のLU分解について、詳細は記事の最後に付録として載せてあります。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="k">void</span> <span class="nf">SolveTridiagonalEquation</span><span class="p">(</span><span class="kt">double</span><span class="p">[]</span> <span class="n">A</span><span class="p">,</span> <span class="n">ExtendedBezierControls</span> <span class="n">x</span><span class="p">,</span> <span class="n">ExtendedPlayerControls</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">n</span> <span class="p">=</span> <span class="n">A</span><span class="p">.</span><span class="n">Length</span> <span class="p">/</span> <span class="m">3</span> <span class="p">-</span> <span class="m">2</span><span class="p">;</span>

    <span class="cm">/* A=LU */</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">,</span> <span class="n">i3</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span><span class="p">++,</span> <span class="n">i3</span><span class="p">+=</span><span class="m">3</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i3</span> <span class="p">+</span> <span class="m">3</span><span class="p">]</span> <span class="p">/=</span> <span class="n">A</span><span class="p">[</span><span class="n">i3</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>                 <span class="c1">//l21  := a21/a11</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i3</span> <span class="p">+</span> <span class="m">4</span><span class="p">]</span> <span class="p">-=</span> <span class="n">A</span><span class="p">[</span><span class="n">i3</span> <span class="p">+</span> <span class="m">3</span><span class="p">]</span> <span class="p">*</span> <span class="n">A</span><span class="p">[</span><span class="n">i3</span> <span class="p">+</span> <span class="m">2</span><span class="p">];</span>     <span class="c1">//a'11 := a22-l21u12</span>
    <span class="p">}</span>

    <span class="cm">/* Ly=b */</span>            
    <span class="n">x</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">b</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>                    <span class="c1">//対角要素は全て1なので、最上行はそのまま            </span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="c1">//対角要素の左隣の要素を対応するx（計算済み）にかけて引く</span>
    <span class="p">{</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">-</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">A</span><span class="p">[</span><span class="n">i</span> <span class="p">*</span> <span class="m">3</span><span class="p">]</span> <span class="p">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="cm">/* Ux=y */</span>
    <span class="n">x</span><span class="p">[</span><span class="n">n</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">/=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">A</span><span class="p">[(</span><span class="n">n</span> <span class="p">+</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>              <span class="c1">//最下行はただ割るだけ</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">i3</span> <span class="p">=</span> <span class="n">n</span> <span class="p">*</span> <span class="m">3</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--,</span> <span class="n">i3</span> <span class="p">-=</span> <span class="m">3</span><span class="p">)</span>   <span class="c1">//対角要素の右隣の要素を対応するx（計算済み）にかけて引いて割る</span>
    <span class="p">{</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">-</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">A</span><span class="p">[</span><span class="n">i3</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">])</span> <span class="p">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">A</span><span class="p">[</span><span class="n">i3</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>


</code></pre></div></div>

<p>あとはAを組み立ててユーザ制御点・ベジェ制御点を上下拡張して実行するだけです。</p>

<p>が、一つ注意点として、上のアルゴリズムで解くためには<strong>$A$はフルランクである必要があります。</strong><br>
アルゴリズムに例外処理を加えてもいいですが、ここでは面倒なので$A$を微調整する方針でいきます。<br>
$t_i=1\wedge t_{i+1}=0$の場合にランクが落ちるので、少しだけずらしてしまいましょう。<br>
なおループしない場合、$t_{n-2}=1$や$t_1=0$でも同じことが起きます。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="k">void</span> <span class="nf">Step4</span><span class="p">(</span><span class="n">Vector2</span><span class="p">[]</span> <span class="n">ps</span><span class="p">,</span> <span class="n">BezierControls</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">float</span><span class="p">[]</span> <span class="n">lambdas</span><span class="p">,</span> <span class="kt">double</span><span class="p">[]</span> <span class="n">ts</span><span class="p">,</span> <span class="kt">double</span><span class="p">[]</span> <span class="n">A</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLoop</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">n</span> <span class="p">=</span> <span class="n">ps</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>

    <span class="c1">//係数行列Aを構成（端の部分はStep0で初期化済）</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">isLoop</span> <span class="p">?</span> <span class="m">0</span> <span class="p">:</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="p">(</span><span class="n">isLoop</span> <span class="p">?</span> <span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">n</span><span class="p">-</span><span class="m">1</span><span class="p">));</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">ofs</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span><span class="p">+</span><span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="m">3</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">next</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">)</span> <span class="p">%</span> <span class="n">n</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">prev</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span> <span class="p">+</span> <span class="n">n</span><span class="p">)</span> <span class="p">%</span> <span class="n">n</span><span class="p">;</span>

            <span class="c1">//ランクが下がってしまう場合微調整</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="n">ts</span><span class="p">[</span><span class="n">next</span><span class="p">]</span> <span class="p">==</span> <span class="m">0</span> <span class="p">||</span> <span class="p">!</span><span class="n">isLoop</span> <span class="p">&amp;&amp;</span> <span class="n">i</span> <span class="p">==</span> <span class="n">n</span> <span class="p">-</span> <span class="m">2</span> <span class="p">&amp;&amp;</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
                <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">0.99999f</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">isLoop</span> <span class="p">&amp;&amp;</span> <span class="n">i</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
                <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">0.00001f</span><span class="p">;</span>


            <span class="kt">var</span> <span class="n">tmp</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">*</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="n">A</span><span class="p">[</span><span class="n">ofs</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">prev</span><span class="p">])</span> <span class="p">*</span> <span class="n">tmp</span><span class="p">;</span>
            <span class="n">A</span><span class="p">[</span><span class="n">ofs</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">prev</span><span class="p">]</span> <span class="p">*</span> <span class="n">tmp</span> <span class="p">+</span> <span class="p">(</span><span class="m">2</span> <span class="p">-</span> <span class="p">(</span><span class="m">1</span> <span class="p">+</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">*</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">*</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">A</span><span class="p">[</span><span class="n">ofs</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="n">lambdas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">*</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">*</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">//入出力ベクトルを拡張</span>
    <span class="kt">var</span> <span class="n">extendedPs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ExtendedPlayerControls</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span><span class="n">cs</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">extendedCs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ExtendedBezierControls</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

    <span class="c1">//連立方程式を解く</span>
    <span class="nf">SolveTridiagonalEquation</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">extendedCs</span><span class="p">,</span> <span class="n">extendedPs</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h3>
<span id="プロット" class="fragment"></span><a href="#%E3%83%97%E3%83%AD%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>プロット</h3>

<p>これでκ-Curvesのシステムは完成ですが、まだベジェ曲線の制御点が算出できただけなので、描画する必要があります。<br>
実際に画面に映すのは各描画ライブラリにやってもらうとして、そのための点群を用意しなければなりません。</p>

<p>とは言っても、各セグメントについて、↓これにtを順番に突っ込めばいいだけです。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>c_i(t)=(1-t)^2c_{i,0} + 2(1-t)tc_{i,1} + t^2c_{i,2}
</code></pre></div></div>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="n">Vector2</span> <span class="nf">PlotSingle</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">c0</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">c1</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">c2</span><span class="p">,</span> <span class="kt">float</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">t</span><span class="p">)</span> <span class="p">*</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">t</span><span class="p">)</span> <span class="p">*</span> <span class="n">c0</span> <span class="p">+</span> <span class="m">2</span> <span class="p">*</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">t</span><span class="p">)</span> <span class="p">*</span> <span class="n">t</span> <span class="p">*</span> <span class="n">c1</span> <span class="p">+</span> <span class="n">t</span> <span class="p">*</span> <span class="n">t</span> <span class="p">*</span> <span class="n">c2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>計算スペースのときのように、プロット用のスペースも確保しておきましょう。<br>
セグメント数は非ループ時は<strong>２つ</strong>少なくなることに注意。<br>
ユーザ制御点が２つ以下の場合の例外処理も忘れずに。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PlotSpace</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">N</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">StepPerSegment</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Vector2</span><span class="p">[]</span> <span class="n">Plots</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">PlotSpace</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stepPerSegment</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLoop</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">N</span> <span class="p">=</span> <span class="n">n</span><span class="p">;</span>
        <span class="n">StepPerSegment</span> <span class="p">=</span> <span class="n">stepPerSegment</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">)</span>
            <span class="n">Plots</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">[</span><span class="n">stepPerSegment</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>
        <span class="k">else</span>
            <span class="n">Plots</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">[(</span><span class="n">isLoop</span> <span class="p">?</span> <span class="n">n</span> <span class="p">:</span> <span class="p">(</span><span class="n">n</span> <span class="p">-</span> <span class="m">2</span><span class="p">))</span> <span class="p">*</span> <span class="n">stepPerSegment</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>あとはプロッティングしていくだけ。<br>
ベジェ曲線のちゃんとしたプロッティング手法としては、de Casteljauのアルゴリズムを使って曲率に応じて適応的に密度を変えるものが挙げられますが、ここでは面倒なので等間隔プロットとします。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">Vector2</span><span class="p">[]</span> <span class="nf">CalcPlots</span><span class="p">(</span><span class="n">Vector2</span><span class="p">[]</span> <span class="n">points</span><span class="p">,</span> <span class="n">CalcSpace</span> <span class="n">calcSpace</span><span class="p">,</span> <span class="n">PlotSpace</span> <span class="n">plotSpace</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iteration</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stepPerSegment</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLoop</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//ベジェ制御点を計算</span>
    <span class="kt">var</span> <span class="n">cs</span> <span class="p">=</span> <span class="nf">CalcBezierControls</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">calcSpace</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>

    <span class="c1">//各セグメントについて、指定されたステップ数で分割した点を計算</span>
    <span class="k">return</span> <span class="nf">CalcPlots</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">plotSpace</span><span class="p">,</span> <span class="n">stepPerSegment</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="n">Vector2</span><span class="p">[]</span> <span class="nf">CalcPlots</span><span class="p">(</span><span class="n">BezierControls</span> <span class="n">cs</span><span class="p">,</span> <span class="n">PlotSpace</span> <span class="n">space</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stepPerSegment</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLoop</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">segCnt</span> <span class="p">=</span> <span class="n">isLoop</span> <span class="p">||</span> <span class="n">cs</span><span class="p">.</span><span class="n">SegmentCount</span> <span class="p">&lt;</span> <span class="m">3</span> <span class="p">?</span> <span class="n">cs</span><span class="p">.</span><span class="n">SegmentCount</span> <span class="p">:</span> <span class="n">cs</span><span class="p">.</span><span class="n">SegmentCount</span> <span class="p">-</span> <span class="m">2</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">k</span> <span class="p">&lt;</span> <span class="n">segCnt</span><span class="p">;</span> <span class="n">k</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">offset</span> <span class="p">=</span> <span class="n">k</span> <span class="p">*</span> <span class="n">stepPerSegment</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">nextk</span> <span class="p">=</span> <span class="p">(</span><span class="n">k</span> <span class="p">+</span> <span class="m">1</span><span class="p">)</span> <span class="p">%</span> <span class="n">cs</span><span class="p">.</span><span class="n">SegmentCount</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">stepPerSegment</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">space</span><span class="p">.</span><span class="n">Plots</span><span class="p">[</span><span class="n">offset</span> <span class="p">+</span> <span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="nf">CalcPlotSingle</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="n">nextk</span><span class="p">,</span> <span class="m">0</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="n">nextk</span><span class="p">,</span> <span class="m">1</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="n">nextk</span><span class="p">,</span> <span class="m">2</span><span class="p">],</span> <span class="n">i</span> <span class="p">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">stepPerSegment</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">var</span> <span class="n">last</span> <span class="p">=</span> <span class="n">isLoop</span> <span class="p">||</span> <span class="n">cs</span><span class="p">.</span><span class="n">SegmentCount</span> <span class="p">&lt;</span> <span class="m">3</span> <span class="p">?</span> <span class="m">0</span> <span class="p">:</span> <span class="n">k</span><span class="p">;</span>
    <span class="n">space</span><span class="p">.</span><span class="n">Plots</span><span class="p">[</span><span class="n">space</span><span class="p">.</span><span class="n">Plots</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="nf">CalcPlotSingle</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="n">last</span><span class="p">,</span> <span class="m">0</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="n">last</span><span class="p">,</span> <span class="m">1</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="n">last</span><span class="p">,</span> <span class="m">2</span><span class="p">],</span> <span class="m">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">space</span><span class="p">.</span><span class="n">Plots</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="実行側" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E5%81%B4"><i class="fa fa-link"></i></a>実行側</h3>

<p>以上を全て<code>KCurves</code>クラスに実装したとして、以下のようにすれば描画用の点群を取得できます。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">//イテレーション回数</span>
<span class="kt">var</span> <span class="n">iteration</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
<span class="c1">//ループするかどうか</span>
<span class="kt">var</span> <span class="n">isLoop</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="c1">//セグメントごとの分割数</span>
<span class="kt">var</span> <span class="n">step</span> <span class="p">=</span> <span class="m">20</span><span class="p">;</span>

<span class="c1">//ユーザ制御点を更新</span>
<span class="n">Vector2</span><span class="p">[]</span> <span class="n">input</span> <span class="p">=</span> <span class="cm">/*更新処理*/</span><span class="p">;</span>

<span class="c1">//計算用空間確保（本来はキャッシュしておく）</span>
<span class="kt">var</span> <span class="n">cSpace</span> <span class="p">=</span> <span class="k">new</span> <span class="n">KCurves</span><span class="p">.</span><span class="nf">CalcSpace</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
<span class="c1">//プロット用空間確保（本来はキャッシュしておく）</span>
<span class="kt">var</span> <span class="n">pSpace</span> <span class="p">=</span> <span class="k">new</span> <span class="n">KCurves</span><span class="p">.</span><span class="nf">PlotSpace</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>
<span class="c1">//実行</span>
<span class="kt">var</span> <span class="n">output</span> <span class="p">=</span> <span class="n">KCurves</span><span class="p">.</span><span class="nf">CalcPlots</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">cSpace</span><span class="p">,</span> <span class="n">pSpace</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>
</code></pre></div></div>

<p>お疲れさまでした。</p>

<h2>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h2>

<p>Unity上で、１セグメントにつき20ステップで描画してみた結果です。<br>
<a href="https://camo.qiitausercontent.com/883f03eff13ee41364b90447c03aafa6d069e07a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f38613231386431372d306466622d663133652d383532392d3435663433653931626163312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F8a218d17-0dfb-f13e-8529-45f43e91bac1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=007d5a9f4098d2d47fcdca3e53b127b8" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/8a218d17-0dfb-f13e-8529-45f43e91bac1.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F8a218d17-0dfb-f13e-8529-45f43e91bac1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=80c23af480cf68212d3ce84f5f3b3064 1x" loading="lazy"></a></p>

<p>ベジェ制御点も表示してみるとこんな感じ。<br>
<a href="https://camo.qiitausercontent.com/23ab07e27a969ea1c7c7c116e7dcc3167027df29/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f30633438623061632d313939662d643936362d363936382d6636333164366430346665372e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F0c48b0ac-199f-d966-6968-f631d6d04fe7.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=128d68a7b09b05b6773aa82ecddf19c4" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/0c48b0ac-199f-d966-6968-f631d6d04fe7.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F0c48b0ac-199f-d966-6968-f631d6d04fe7.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1970fa1c1d84711f79611b74ee97975a 1x" loading="lazy"></a></p>

<p>同じ配置でループさせるとこうなります。<br>
<a href="https://camo.qiitausercontent.com/04ca63af4998d82fcc03a14879a7f65e481727df/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f64333362346139382d373065322d323465662d383636332d3833633161613937373261362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fd33b4a98-70e2-24ef-8663-83c1aa9772a6.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2c3d2792493c7ba9d74fcb5cf919554e" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/d33b4a98-70e2-24ef-8663-83c1aa9772a6.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fd33b4a98-70e2-24ef-8663-83c1aa9772a6.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=2444055cfacc008509e0e693094af9d2 1x" loading="lazy"></a></p>

<h2>
<span id="バグ" class="fragment"></span><a href="#%E3%83%90%E3%82%B0"><i class="fa fa-link"></i></a>バグ？</h2>

<p>はい、まだ終わってません。<br>
ここまでの実装で実際に描画してみて、ユーザ制御点をめちゃくちゃ動かしまくってみると分かりますが、<strong>特定の状況下において適切な場所に収束しません</strong>。<br>
<a href="https://camo.qiitausercontent.com/b6c268a6e0da34568560bd7e5705d5bf5ebe2701/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f31623365643561612d343634342d343663612d663031312d3137373131643032396535312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F1b3ed5aa-4644-46ca-f011-17711d029e51.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=67b203ac214886cb328d85b85bdeb6a5" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/1b3ed5aa-4644-46ca-f011-17711d029e51.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F1b3ed5aa-4644-46ca-f011-17711d029e51.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=eb8e4c6fe6442d1647b49243410df0d9 1x" loading="lazy"></a><br>
なんか、飛び出しています。よく見ると接続点の傾きも不連続になっています。<br>
尖った領域かつユーザ制御点が近接している場合に起こりがちです。</p>

<p>この問題は、実は<strong>全ての条件を満たす解が存在しない場合がある</strong>（＝各条件を順番に解くだけでは収束しない）ことに起因します。</p>

<p>実用上は</p>

<ul>
<li>Step1の回数を抑える</li>
<li>最後にStep2を一度実行する</li>
</ul>

<p>ことで解決しますが、真の最適解に収束しているわけではないことに注意しましょう。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">BezierControls</span> <span class="nf">CalcBezierControls</span><span class="p">(</span><span class="n">Vector2</span><span class="p">[]</span> <span class="n">points</span><span class="p">,</span> <span class="n">CalcSpace</span> <span class="n">space</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iteration</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLoop</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//前略</span>
    <span class="nf">Step0</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iteration</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span> <span class="p">||</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iteration</span> <span class="p">/</span> <span class="m">2</span><span class="p">)</span>
            <span class="nf">Step1</span><span class="p">(</span><span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>
        <span class="nf">Step2</span><span class="p">(</span><span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">L</span><span class="p">);</span>
        <span class="nf">Step3</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">);</span>
        <span class="nf">Step4</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">L</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">A</span><span class="p">,</span> <span class="n">isLoop</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nf">Step2</span><span class="p">(</span><span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">,</span> <span class="n">space</span><span class="p">.</span><span class="n">L</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">space</span><span class="p">.</span><span class="n">C</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>結果：<br>
<a href="https://camo.qiitausercontent.com/73055e8866fdd764cddcbbbcbf31170710208cd4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f33646337626434642d303332342d653231312d343336392d3961613637633464393562382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F3dc7bd4d-0324-e211-4369-9aa67c4d95b8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=973a5ac2cf8a4a80ccead5eb123b23e1" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/3dc7bd4d-0324-e211-4369-9aa67c4d95b8.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F3dc7bd4d-0324-e211-4369-9aa67c4d95b8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=91c0619eda0ac4b1603c013ad8bad329 1x" loading="lazy"></a></p>

<h3>
<span id="それでも飛び出ることはある" class="fragment"></span><a href="#%E3%81%9D%E3%82%8C%E3%81%A7%E3%82%82%E9%A3%9B%E3%81%B3%E5%87%BA%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>それでも飛び出ることはある</h3>

<p>具体的には、極薄極小のセグメントの存在が問題のようです。<br>
例えばこんな場合。<br>
<a href="https://camo.qiitausercontent.com/056581f16479a4f284717fbecd87f3c8c1aef9b9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f65666639656163322d643138342d316261312d313630322d6432343234343566656631632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Feff9eac2-d184-1ba1-1602-d242445fef1c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=12cabb98d477078edebf5555be37ccbf" alt="新規キャンバス1.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/eff9eac2-d184-1ba1-1602-d242445fef1c.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Feff9eac2-d184-1ba1-1602-d242445fef1c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0dc2f36dc2495482101d276f4f04470a 1x" loading="lazy"></a></p>

<p>これはもう何というか、<strong>曲線ツールで鋭角を描こうとしているのが悪いです。</strong><br>
超鋭角の部分を検知して、その点で切断して２つのκ-Curvesに分けるといいかもしれません。</p>

<h2>
<span id="発展" class="fragment"></span><a href="#%E7%99%BA%E5%B1%95"><i class="fa fa-link"></i></a>発展</h2>

<p>記事公開から１年以上経ってもまだちょくちょく通知が来るので、新しい関連情報を少し追記します。</p>

<h3>
<span id="有理κ-curves" class="fragment"></span><a href="#%E6%9C%89%E7%90%86%CE%BA-curves"><i class="fa fa-link"></i></a>有理κ-Curves</h3>

<p>通常の二次ベジェ曲線で定義できるなら、有理二次ベジェ曲線でもできるのでは？　と考えるのが自然です。<br>
これは同じ筆頭著者の論文<a href="http://people.tamu.edu/%7Eyanzp/projects/ratkappa/ratk.pdf" title="Circle Reproduction with Interpolatory Curves at Local Maximal Curvature Points" rel="nofollow noopener" target="_blank">(Yan et al., 2019)</a>で後に導入されています。<br>
有理二次ベジェ曲線は円錐曲線全体をカバーするので、正確な円を描くこともできます（なので論文タイトルがCircle Reproduction～）。<br>
またこちらの実装では最適化を全条件をまとめた式のエネルギー最小化で定義しており、前項で挙げた不安定性への対処もされています。<br>
有理二次ベジェ曲線の（ほぼ）曲率連続な連結体なので、表現力はCAD等の用途でよく採用されるNURBS（非一様有理Bスプライン）と（ほぼ）同等と言えます。</p>

<h3>
<span id="a-class-of-c-interpolating-splines" class="fragment"></span><a href="#a-class-of-c-interpolating-splines"><i class="fa fa-link"></i></a>A Class of C² Interpolating Splines</h3>

<p>SIGGRAPH2020で、全く新しいスプライン曲線のクラスが提示されました。<a href="http://www.cemyuksel.com/research/interpolating_splines/a_class_of_c2_interpolating_splines.pdf" title="A Class of C² Interpolating Splines" rel="nofollow noopener" target="_blank">(Cem Yuksel, 2020)</a><br>
ざっくりまとめると、隣接する３制御点$P_{i-1},P_{i},P_{i+1}$を繋ぐ曲線$F_i$を三角関数を使ってブレンドすることで、$F_i$によらず「至る所$C^2$連続かつ全ての制御点を通る」ことが保証された曲線を出力するものです。</p>

<p>$F_i$を適切に選ぶことで、曲率極大点を制御点に<strong>近づける</strong>こともできます（一致させるのは相当難しく、もしできたら論文が一本書けると思います）。<br>
$F_i$としてκ-Curvesを用いるのが好例で、論文中でも紹介されています。</p>

<p>Yukselさんはこのクラスに特に名前をつけてくれておらず、論文等で引用する時に取り回しづらいのがちょっと難点。</p>

<h1>
<span id="使用上の注意" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>使用上の注意</h1>

<p><strong><a href="https://patents.google.com/patent/US9501848B2" title="Fitting a parametric curve using maximum curvature" rel="nofollow noopener" target="_blank">Adobeが特許を取っているので、無断の商用利用はNGです。</a></strong><br>
何かに使う場合、特許権侵害にあたらないかは確認しておきましょう。</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>κ-Curvesの実装は、大学で出た発展課題の一つでした。<br>
そこで存在を知ったわけですが、非常に便利なので趣味のゲーム開発（非営利）にも流用しています。<br>
修論のテーマにも影響したりと、個人的になかなか深く関わることになった曲線でした。<br>
<font color="silver"><sub>なお同じ講義を受けてググってこの記事に辿り着いた各位へ、脳死コピペはやめましょう。私はその講義の元TAです。</sub></font></p>

<p>パラメトリック曲線界隈、最近ちょっと活発になった気がします。この間の<a href="https://cgvi.jp/vc2020/program/oral/" rel="nofollow noopener" target="_blank">Visual Computing 2020</a>でもκ-Curves派生の新しいアイデアが発表されていましたね。<br>
興味のある方は研究テーマにしてみてはいかがでしょうか。</p>

<h1>
<span id="付録" class="fragment"></span><a href="#%E4%BB%98%E9%8C%B2"><i class="fa fa-link"></i></a>付録</h1>

<h3>
<span id="三重対角行列のlu分解" class="fragment"></span><a href="#%E4%B8%89%E9%87%8D%E5%AF%BE%E8%A7%92%E8%A1%8C%E5%88%97%E3%81%AElu%E5%88%86%E8%A7%A3"><i class="fa fa-link"></i></a>三重対角行列のLU分解</h3>

<p>まずLU分解とは、正方行列を下三角行列$L$と上三角行列$U$の積に分解する操作です。<br>
$Ax=b$という連立方程式があるとき、$A=LU$とLU分解することで、$Ly=b$と$Ux=y$という２つの連立方程式に分離することができます。<br>
三角行列の連立方程式は簡単に$O(n^2)$で解ける（前進代入・後退代入）ので、$A$がLU分解されていれば、ガウスの消去法を使った$O(n^3)$の解法より速くなります。<br>
一般のLU分解は$O(n^3)$かかってしまうので、これは同じAを何度も利用する際にのみ有効な手段ですが、<br>
$A$が<strong>三重対角行列</strong>の場合、<strong>LU分解もその後の計算も全て$O(n)$になります。</strong> </p>

<p>$L$の対角成分を1に固定しましょう。このとき、三重対角行列のLU分解$A=LU$の最初の様子は以下のように表せます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left(\begin{matrix}
a_{11}&amp;a_{12}&amp;&amp;O\\
a_{21}&amp;&amp;&amp;\\
&amp;&amp;A'&amp;\\
O&amp;&amp;&amp;
\end{matrix}\right)
=

\left(\begin{matrix}
1&amp;&amp;&amp;O\\
l_{21}&amp;&amp;&amp;\\
&amp;&amp;L'&amp;\\
O&amp;&amp;&amp;
\end{matrix}\right)

\left(\begin{matrix}
u_{11}&amp;u_{12}&amp;&amp;O\\
&amp;&amp;&amp;\\
&amp;&amp;U'&amp;\\
O&amp;&amp;&amp;
\end{matrix}\right)
</code></pre></div></div>

<p>成分を比較すると、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
a_{11}&amp;=u_{11}\\
a_{12}&amp;=u_{12}\\
a_{21}&amp;=u_{11}l_{21}\\
A'&amp;=L'U'+\left(\begin{matrix}
l_{21}u_{12}&amp;\\
&amp;O
\end{matrix}\right)
\end{align}
</code></pre></div></div>

<p>なので、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
u_{11}&amp;=a_{11}\\
u_{12}&amp;=a_{12}\\
l_{21}&amp;=\frac{a_{21}}{a_{11}}\\
\end{align}
</code></pre></div></div>

<p>として</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>A'-\left(\begin{matrix}
l_{21}u_{12}&amp;\\
&amp;O
\end{matrix}\right)=L'U'
</code></pre></div></div>

<p>を再帰的にLU分解していけばよいことが分かります。<br>
$O(1)$の$n$回ループなので$O(n)$です。</p>

<p>この計算では分解し終わった部分が後で必要になることはなく、さらに$L$の対角成分は全て1なので、$L$と$U$を重ね合わせることで$A$のメモリのみを使って分解できます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left(\begin{matrix}
a_{11}&amp;a_{12}&amp;&amp;O\\
a_{21}&amp;a_{22}&amp;a_{23}&amp;\\
&amp;a_{32}&amp;\ddots&amp;\\
O&amp;&amp;&amp;
\end{matrix}\right)
\rightarrow

\left(\begin{matrix}
u_{11}&amp;u_{12}&amp;&amp;O\\
l_{21}&amp;u_{22}&amp;u_{23}&amp;\\
&amp;l_{32}&amp;\ddots&amp;\\
O&amp;&amp;&amp;
\end{matrix}\right)
</code></pre></div></div>

<p>元が三重対角行列なので、$L,U$は共に各行２つ以下の要素しか持ちません。<br>
そのため、前進代入・後退代入の計算量も$O(n)$となります。</p>

<h3>
<span id="角つき三重対角行列のlu分解" class="fragment"></span><a href="#%E8%A7%92%E3%81%A4%E3%81%8D%E4%B8%89%E9%87%8D%E5%AF%BE%E8%A7%92%E8%A1%8C%E5%88%97%E3%81%AElu%E5%88%86%E8%A7%A3"><i class="fa fa-link"></i></a>角つき三重対角行列のLU分解</h3>

<p>右上と左下に角がついている場合（行列サイズを拡張しない場合）も、少し複雑にはなりますが$O(n)$で分解できます。</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left(\begin{matrix}
a_{11}&amp;a_{12}&amp;O&amp;a_{1n}\\
a_{21}&amp;&amp;&amp;\\
O&amp;&amp;A'&amp;\\
a_{n1}&amp;&amp;&amp;
\end{matrix}\right)
=

\left(\begin{matrix}
1&amp;&amp;&amp;O\\
l_{21}&amp;&amp;&amp;\\
O&amp;&amp;L'&amp;\\
l_{n1}&amp;&amp;&amp;
\end{matrix}\right)

\left(\begin{matrix}
u_{11}&amp;u_{12}&amp;O&amp;u_{1n}\\
&amp;&amp;&amp;\\
&amp;&amp;U'&amp;\\
O&amp;&amp;&amp;
\end{matrix}\right)
</code></pre></div></div>

<p>成分を比較すると、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\begin{align}
u_{11}&amp;=a_{11}\\
u_{12}&amp;=a_{12}\\
l_{21}&amp;=\frac{a_{21}}{a_{11}}\\
u_{1n}&amp;=a_{1n}\\
l_{n1}&amp;=\frac{a_{n1}}{a_{11}}\\
\end{align}
</code></pre></div></div>

<p>なので、</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>A'-\left(\begin{matrix}
\displaystyle\frac{a_{21}a_{12}}{a_{11}}&amp;O&amp;\displaystyle\frac{a_{21}a_{1n}}{a_{11}}\\
O&amp;O&amp;O\\
\displaystyle\frac{a_{n1}a_{12}}{a_{11}}&amp;O&amp;\displaystyle\frac{a_{n1}a_{1n}}{a_{11}}\\
\end{matrix}\right)=L'U'
</code></pre></div></div>

<p>となり、再帰的に分解できます。<br>
ただし、$A'$のサイズが1のときはこの四隅は同じ位置を指すので、重複して引いてしまわないよう注意が必要です。</p>

<p>また、前進代入・後退代入も変わらず$O(n)$ではありますが、$L$は最下一行、$U$は最右一列が追加で埋まっています。<br>
$L$も$U$も左からかけるので、この追加行・列の扱いは非対称的です。<br>
$4\times 4$行列くらいの具体例で実際に手を動かしてみると実感できると思います。</p>

<p>具体例：</p>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left(\begin{matrix}
2&amp;0&amp;0&amp;2\\
0&amp;1&amp;1&amp;0\\
0&amp;2&amp;4&amp;2\\
4&amp;0&amp;4&amp;9\\
\end{matrix}\right)
\left(\begin{matrix}
1\\
2\\
3\\
4\\
\end{matrix}\right)
=
\left(\begin{matrix}
10\\
5\\
24\\
52\\
\end{matrix}\right)
</code></pre></div></div>

<div class="code-frame" data-lang="math"><div class="highlight"><pre class="with-code"><code>\left(\begin{matrix}
2&amp;0&amp;0&amp;2\\
0&amp;1&amp;1&amp;0\\
0&amp;2&amp;4&amp;2\\
4&amp;0&amp;4&amp;9\\
\end{matrix}\right)
=
\left(\begin{matrix}
1&amp;0&amp;0&amp;0\\
0&amp;1&amp;0&amp;0\\
0&amp;2&amp;1&amp;0\\
2&amp;0&amp;2&amp;1\\
\end{matrix}\right)
\left(\begin{matrix}
2&amp;0&amp;0&amp;2\\
0&amp;1&amp;1&amp;0\\
0&amp;0&amp;2&amp;2\\
0&amp;0&amp;0&amp;1\\
\end{matrix}\right)
</code></pre></div></div>

<p>なお、一般の場合のLU分解や前進代入・後退代入については<a href="http://slis.tsukuba.ac.jp/%7Efujisawa.makoto.fu/cgi-bin/wiki/index.php?LU%CA%AC%B2%F2" rel="nofollow noopener" target="_blank">こちらのページ</a>などに詳しく載っています。</p>

<h3>
<span id="参考パフォーマンス計測結果" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E8%A8%88%E6%B8%AC%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>（参考）パフォーマンス計測結果</h3>

<p>私の環境でのパフォーマンス計測結果です。</p>

<table>
<thead>
<tr>
<th style="text-align: left">n</th>
<th style="text-align: left">iteration</th>
<th style="text-align: left">time(ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">30</td>
<td style="text-align: left">5</td>
<td style="text-align: left">0.1232</td>
</tr>
<tr>
<td style="text-align: left">15</td>
<td style="text-align: left">10</td>
<td style="text-align: left">0.1177</td>
</tr>
<tr>
<td style="text-align: left">30</td>
<td style="text-align: left">10</td>
<td style="text-align: left">0.2296</td>
</tr>
<tr>
<td style="text-align: left">60</td>
<td style="text-align: left">10</td>
<td style="text-align: left">0.4564</td>
</tr>
<tr>
<td style="text-align: left">120</td>
<td style="text-align: left">10</td>
<td style="text-align: left">0.9101</td>
</tr>
<tr>
<td style="text-align: left">1000</td>
<td style="text-align: left">10</td>
<td style="text-align: left">7.516</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th style="text-align: left">環境</th>
<th style="text-align: left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">OS</td>
<td style="text-align: left">Windows10 Home</td>
</tr>
<tr>
<td style="text-align: left">CPU</td>
<td style="text-align: left">Intel Core i7-8700</td>
</tr>
<tr>
<td style="text-align: left">RAM</td>
<td style="text-align: left">16GB</td>
</tr>
<tr>
<td style="text-align: left">GPU</td>
<td style="text-align: left">NVIDIA GeForce GTX 970</td>
</tr>
<tr>
<td style="text-align: left">その他</td>
<td style="text-align: left">Unity2019.3.0f6上で実行</td>
</tr>
</tbody>
</table>

<p>時間は10000回の平均値（四捨五入）で、<code>CalcBezierControls()</code>の時間のみを計測しています。</p>

<p>はい。$O(n\times \rm{iteration})$です。イテレーションは実用上は5～10回くらいで充分なので、C#実装でこれならそこそこ実用的な速度が出るかなと。</p>

<p>一応計測用コード（要Unity）：</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="p">[</span><span class="nf">MenuItem</span><span class="p">(</span><span class="s">"Tools/Test"</span><span class="p">)]</span>
<span class="k">static</span> <span class="k">void</span> <span class="nf">_</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="p">=</span> <span class="m">30</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">iter</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">loop</span> <span class="p">=</span> <span class="m">10000</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">path</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">bool</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="nf">Select</span><span class="p">(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">,</span> <span class="n">Random</span><span class="p">.</span><span class="k">value</span><span class="p">)).</span><span class="nf">ToArray</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">cSpace</span> <span class="p">=</span> <span class="k">new</span> <span class="n">KCurves</span><span class="p">.</span><span class="nf">CalcSpace</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">sw</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Stopwatch</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">KCurves</span><span class="p">.</span><span class="nf">CalcBezierControls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cSpace</span><span class="p">,</span> <span class="n">iter</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">sw</span><span class="p">.</span><span class="n">ElapsedTicks</span> <span class="p">/</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Stopwatch</span><span class="p">.</span><span class="n">Frequency</span> <span class="p">*</span> <span class="m">1000.0</span> <span class="p">/</span> <span class="n">loop</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h1>
<span id="参考文献" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><i class="fa fa-link"></i></a>参考文献</h1>

<p>元論文</p>

<blockquote>
<p>Zhipei Yan, Stephen Schiller, Gregg Wilensky, Nathan Carr, and Scott Schaefer.<br>
κ-curves: Interpolation at local maximum curvature.<br>
ACM Transactions on Graphics, 36(4):129:1–129:7, 2017.<br>
<a href="http://people.tamu.edu/~yanzp/projects/kCurves/kCurves.pdf" class="autolink" rel="nofollow noopener" target="_blank">http://people.tamu.edu/~yanzp/projects/kCurves/kCurves.pdf</a></p>
</blockquote>

<p>特許（Google Patents）</p>

<blockquote>
<p>Fitting a parametric curve using maximum curvature<br>
<a href="https://patents.google.com/patent/US9501848B2" class="autolink" rel="nofollow noopener" target="_blank">https://patents.google.com/patent/US9501848B2</a></p>
</blockquote>

<p>関連</p>

<blockquote>
<p>Zhipei Yan, Stephen Schiller, and Scott Schaefer.<br>
Circle reproduction with interpolatory curves at local maximal curvature points.<br>
Computer Aided Geometric Design, 72:98 – 110, 2019.<br>
<a href="http://people.tamu.edu/~yanzp/projects/ratkappa/ratk.pdf" class="autolink" rel="nofollow noopener" target="_blank">http://people.tamu.edu/~yanzp/projects/ratkappa/ratk.pdf</a></p>

<p>Cem Yuksel. <br>
A class of c2 interpolating splines. <br>
ACM Transactions on Graphics, 39(5):160:1–160:14, jul 2020.<br>
<a href="http://www.cemyuksel.com/research/interpolating_splines/" class="autolink" rel="nofollow noopener" target="_blank">http://www.cemyuksel.com/research/interpolating_splines/</a></p>

<p>わかりやすいNURBS解説<br>
<a href="https://www.unisys.co.jp/tec_info/tr114/11403.pdf" class="autolink" rel="nofollow noopener" target="_blank">https://www.unisys.co.jp/tec_info/tr114/11403.pdf</a></p>

<p>Solving Cubic Equations<br>
<a href="http://www.1728.org/cubic2.htm" class="autolink" rel="nofollow noopener" target="_blank">http://www.1728.org/cubic2.htm</a></p>
</blockquote>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>3D曲線の場合、曲率は絶対値を取って扱うことが多いようです。2D曲線でも絶対値つきで定義されていることがあるかもしれませんが、ここではκ-Curvesの論文に倣って符号付きとします。 <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FRijicho_nl%2Fitems%2F05ee4c8d77e99e29daa5&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FRijicho_nl%2Fitems%2F05ee4c8d77e99e29daa5&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5/likers" class="css-1iupg5d">285</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">252</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/05ee4c8d77e99e29daa5/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/Rijicho_nl/items/05ee4c8d77e99e29daa5.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-10bc0efa-d390-4249-8bae-2884f091c9cb">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-56a08ab2-2351-4517-90f4-22df721deb4d"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-56a08ab2-2351-4517-90f4-22df721deb4d">{}</script>
      
<div id="LoginModal-react-component-dfd387e8-265b-45f1-9775-01a5fe0db440"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-dfd387e8-265b-45f1-9775-01a5fe0db440">{}</script>
      
<div id="StockModal-react-component-e78c9ed7-483d-481c-8289-7cb2de82144f"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-e78c9ed7-483d-481c-8289-7cb2de82144f">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;WFhkwGzZ8gpoMxlQaljduajuCqzi16VQKmTh+8fEn5S+7yyGd3W7rNwaPhURzuioObVqsLOQAl11GXgkzaEhIg==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"tldr\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#tldr\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTL;DR\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e全てのユーザ制御点上を通り、\u003c/li\u003e\n\u003cli\u003e全ての曲率極大点がユーザ制御点上にある\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eそんな超便利なのにあまり知られていないパラメトリック曲線こと\u003cstrong\u003e「κ-Curves」\u003c/strong\u003e。\u003cbr\u003e\n\u003ca href=\"http://people.tamu.edu/%7Eyanzp/projects/kCurves/kCurves.pdf\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAdobe ResearchとテキサスA\u0026amp;M大学のYan氏らがSIGGRAPH 2017で発表した研究\u003c/a\u003eで、Adobe Illustratorに実装されており、Adobeが特許を取っています\u003cfont color=\"red\"\u003e（無断の商用利用はNG）\u003c/font\u003e。\u003cbr\u003e\n新しめなせいか、検索しても情報があまり出てきません。\u003cbr\u003e\nこの論文と同じ流れを、前提知識や行間を補いつつ日本語で追っていきます。\u003c/p\u003e\n\n\u003cp\u003eC#で実際に実装もしていきます。\u003cbr\u003e\n論文に忠実に実装するとちょっとバグるので、それについても少し。\u003c/p\u003e\n\n\u003cp\u003e※本記事では、上記論文から一部画像や式を引用しています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/9ccf43a6f5d496ee8a547a8b58f0c687d8336b3b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f39653130663735342d633435652d396632322d336537392d3638343835303330373635352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F9e10f754-c45e-9f22-3e79-684850307655.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=40bd60e0e3e52a59c0fb3c39c8a484bc\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/9e10f754-c45e-9f22-3e79-684850307655.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F9e10f754-c45e-9f22-3e79-684850307655.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=14b89912a42e6d2db7e6bb7912600002 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれは論文から引用した図で、他の様々なパラメトリック曲線とκ-Curvesの比較。\u003cbr\u003e\n左から順に、Interpolatory subdivision curve, Catmull-Romスプライン、Cubic B-スプライン、κ-Curvesです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"デモ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%A2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデモ\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://rijicho-k-curves.glitch.me/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWebGL(JavaScript)で実装したものをGlitchに公開しました。\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e注意：\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eループ非対応、最適化が雑です\n\n\u003cul\u003e\n\u003cli\u003eJSは専門外なのでゆるして\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e以下のライブラリを使用しました\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://bitbucket.org/kenshi84/legacygl.js\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://bitbucket.org/kenshi84/legacygl.js\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/toji/gl-matrix\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/toji/gl-matrix\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e初期値は某こころぴょんぴょんアニメのトレスです\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"事前知識\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BA%8B%E5%89%8D%E7%9F%A5%E8%AD%98\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e事前知識\u003c/h1\u003e\n\n\u003cp\u003e簡単のため、本記事ではxy平面上の曲線のみを考えます。\u003cbr\u003e\n高校レベルの数学＋行列の基礎知識で理解できる内容のはずです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"パラメトリック曲線\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E6%9B%B2%E7%B7%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eパラメトリック曲線\u003c/h2\u003e\n\n\u003cp\u003eパラメトリック曲線とは、X座標、Y座標がそれぞれパラメータ$t$によって決まる曲線です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\n\u0026amp;f:\\mathbb{R}\\rightarrow\\mathbb{R}^2\\\\\n\u0026amp;f(t)=\n\\left(\\begin{matrix}\nx(t)\\\\\ny(t)\n\\end{matrix}\\right)\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e世の中には様々なパラメトリック曲線があります。いくつか雑に紹介すると、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e（３次）エルミート曲線\n\n\u003cul\u003e\n\u003cli\u003e$f(0), f(1), f'(0),f'(1)$の値が制約として与えられ、それを満たすような$t$の３次式。\u003c/li\u003e\n\u003cli\u003eあんまり融通が効かない。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e（n次）ベジェ曲線\n\n\u003cul\u003e\n\u003cli\u003e連続する各セグメント$i$について、制御点$c_{i,0}, \\cdots, c_{i,n}$が与えられる。\u003c/li\u003e\n\u003cli\u003e$c_{i,0}, c_{i,n}$を結ぶ線をそれ以外の制御点がそれぞれ引っ張ったような曲線になる。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e曲線は$c_{i,0}, c_{i,n}$以外の制御点の上を通らない。\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eスプライン曲線\n\n\u003cul\u003e\n\u003cli\u003e３次曲線などをいくつも繋げたり重ねたりして一本の曲線を作るもの。\u003c/li\u003e\n\u003cli\u003eいろいろと種類がある。Catmull-Romスプライン、B-スプライン、NURBSなど。\u003c/li\u003e\n\u003cli\u003e接続点を制御点として動かすタイプの場合、\u003cstrong\u003e曲線は制御点上を通る。\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003eが、\u003cstrong\u003e通るだけで、期待した形になるとは限らない。\u003c/strong\u003e\n\u003c/li\u003e\n\u003cli\u003eなんかひん曲がってしまう例（Excelの曲線ツール）：\u003ca href=\"https://camo.qiitausercontent.com/d0a2e8660c37008dbd2e7736c8faa1f4e126e6ce/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f34646266343166612d383731322d346637382d373861322d3936653332613937363739322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F4dbf41fa-8712-4f78-78a2-96e32a976792.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=03bf6973db26303fd30f3dd4ffe4c006\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/4dbf41fa-8712-4f78-78a2-96e32a976792.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F4dbf41fa-8712-4f78-78a2-96e32a976792.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=7a8df30498faf626d9fe779dda4f5c6a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eと、他にもいろいろありますが、とにかくどれもこれも融通が効きません。\u003cbr\u003e\nイラストソフトなどでポチポチ\u003cstrong\u003eクリックした場所をいい感じになめらかに繋いで曲線を作ってほしい\u003c/strong\u003e場合、どれも力不足。\u003c/p\u003e\n\n\u003cp\u003eκ-Curvesは、\u003cstrong\u003e曲率\u003c/strong\u003eを制御することでこれを実現します。\u003cbr\u003e\n※ベースはベジェ曲線なので、ベジェ曲線以外のことは忘れて大丈夫です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"曲率\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9B%B2%E7%8E%87\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e曲率\u003c/h2\u003e\n\n\u003cp\u003eκ-Curvesは、「ユーザー制御点の\u003cstrong\u003e曲率\u003c/strong\u003eの絶対値が極大になる」という特徴を持つ曲線です。\u003cbr\u003e\n曲率（Curvature）とは、曲線上のある点の周りの微小区間を\u003cstrong\u003e円弧に近似\u003c/strong\u003eしたときの\u003cstrong\u003e円の半径\u003c/strong\u003eの\u003cstrong\u003e逆数\u003c/strong\u003e（符号付き\u003csup id=\"fnref1\"\u003e\u003ca href=\"#fn1\" title=\"3D曲線の場合、曲率は絶対値を取って扱うことが多いようです。2D曲線でも絶対値つきで定義されていることがあるかもしれませんが、ここではκ-Curvesの論文に倣って符号付きとします。\"\u003e1\u003c/a\u003e\u003c/sup\u003e）です。\u003cbr\u003e\n要は、曲線上のある点の周囲が\u003cstrong\u003eいかに急カーブか\u003c/strong\u003eを示す値ですね。絶対値が大きいほど急になります。\u003c/p\u003e\n\n\u003cp\u003e具体的には、2Dパラメトリック曲線においては以下の式で表される値です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\kappa(t)=\\frac{f'(t)\\times f''(t)}{\\|f'(t)\\|^3}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e軽く導出しておきましょう。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/cb039b83de8c1a0b6d3a3e68b25f027d3ef2c5f3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f30616464626432322d326361352d326265652d333435382d3834636261623863353632362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F0addbd22-2ca5-2bee-3458-84cbab8c5626.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=df21aa8541e804bf8e6d361942a980d5\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/0addbd22-2ca5-2bee-3458-84cbab8c5626.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F0addbd22-2ca5-2bee-3458-84cbab8c5626.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=4ed154a59a32f1e208c5217d47bf53ac 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e平面曲線$f:\\mathbb{R}\\rightarrow\\mathbb{R}^2$において、ある微小区間$f(t)$～$f(t+\\Delta t)$の長さを$\\Delta s$、それが円弧だとしたときの中心角を$\\Delta\\theta$、半径を$r$とすると、$\\Delta s=r\\Delta\\theta$が成り立ちます。これより、点$f(t)$における曲率$\\kappa(t)$は、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\kappa(t)=\\lim_{\\Delta t\\rightarrow0}\\frac{\\Delta \\theta}{\\Delta s}=\\frac{d\\theta}{ds}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eと表されます。\u003c/p\u003e\n\n\u003cp\u003eここで、$\\dot{x}=\\frac{dx}{dt},\\ \\dot{y}=\\frac{dy}{dt}$とすると、点$f(t)$における傾きは\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\tan\\theta=\\frac{dy}{dx}=\\frac{\\dot{y}}{\\dot{x}}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eですが、この両辺を$t$で微分すると、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\n\\frac{1}{\\cos^2\\theta}\\frac{d\\theta}{dt}\u0026amp;=\\frac{\\dot{x}\\ddot{y}-\\dot{y}\\ddot{x}}{\\dot{x}^2}\\\\\\\\\n\\frac{d\\theta}{dt}\u0026amp;=\\frac{1}{1+\\tan^2\\theta}\\frac{\\dot{x}\\ddot{y}-\\dot{y}\\ddot{x}}{\\dot{x}^2}\\\\\\\\\n\\frac{d\\theta}{dt}\u0026amp;=\\frac{\\dot{x}\\ddot{y}-\\dot{y}\\ddot{x}}{\\dot{x}^2 + \\dot{y}^2}\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eが得られます。ドット２つは$t$での二階微分です。\u003cbr\u003e\nまた、$\\Delta s$は微小区間の長さなので、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\frac{ds}{dt}=\\sqrt{\\dot{x}^2+\\dot{y}^2}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eであり、以上から\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\n\\kappa(t)\u0026amp;=\\frac{d\\theta}{ds}=\\frac{\\dot{x}\\ddot{y}-\\dot{y}\\ddot{x}}{(\\dot{x}^2 + \\dot{y}^2)^{\\frac{3}{2}}}\\\\\\\\\n\u0026amp;=\\frac{f'(t)\\times f''(t)}{\\|f'(t)\\|^3}\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eが導かれます。\u003c/p\u003e\n\n\u003cp\u003eκ-Curvesは、ユーザ制御点上でこの値（の絶対値）が極大値を取るような曲線である、ということです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ベジェ曲線\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%99%E3%82%B8%E3%82%A7%E6%9B%B2%E7%B7%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eベジェ曲線\u003c/h2\u003e\n\n\u003cp\u003e先程少し触れましたが、κ-Curvesはベジェ曲線がベースになっています。\u003cbr\u003e\nというか、\u003cstrong\u003e曲線の式自体はベジェ曲線そのもの\u003c/strong\u003eなのです。\u003cbr\u003e\nというわけで、まずはベジェ曲線について。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"表式\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A1%A8%E5%BC%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e表式\u003c/h3\u003e\n\n\u003cp\u003eいくつものベジェ曲線を連結して一本の曲線にすることを考えます。\u003cbr\u003e\nこの各ベジェ曲線をセグメントと呼ぶことにし、それぞれの$t$の変域を$[0,1]$とします。\u003c/p\u003e\n\n\u003cp\u003e一般の$d$次ベジェ曲線の$i$番目のセグメントは、$c_{i,j}$をそのセグメントのベジェ制御点とすると\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ec_i^d(t)=\\sum_{j=0}^d\\frac{d!}{(d-j)!j!}(1-t)^{d-j}t^jc_{i,j}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eで表されますが、κ-Curvesにおいては次に示す\u003cstrong\u003e2次ベジェ曲線\u003c/strong\u003eを前提とします。$d$のことは忘れてください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\nc_i(t)\u0026amp;=(1-t)^2c_{i,0} + 2(1-t)tc_{i,1} + t^2c_{i,2}\\\\\n\u0026amp;=(c_{i,0}-2c_{i,1}+c_{i,2})t^2-2(c_{i,0}-c_{i,1})t+c_{i,0}\\\\\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e二階微分まで求めておくと、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\nc_i'(t)\u0026amp;=2(c_{i,0}-2c_{i,1}+c_{i,2})t-2(c_{i,0}-c_{i,1})\\\\\n\u0026amp;=2((1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1}))\\\\\n\\\\\nc_i''(t)\u0026amp;=2(c_{i,0}-2c_{i,1}+c_{i,2})\\\\\n\u0026amp;=2((c_{i,0}-c_{i,1}) + (c_{i,2} - c_{i,1}))\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとなります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"曲率-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9B%B2%E7%8E%87-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e曲率\u003c/h3\u003e\n\n\u003cp\u003e$i番目の$セグメントの各点$c_i(t)$における曲率を$\\kappa_i(t)$とすると、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\n\\kappa_i(t)\u0026amp;=\\frac{c_i'(t)\\times c_i''(t)}{\\|c_i'(t)\\|^3}\\\\\n\u0026amp;=\\frac{\\triangle(c_{i,0},c_{i,1},c_{i,2})}{\\|(1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1})\\|^3}\\\\\n\\end{align}\\\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとなります。ここで$\\triangle(c_{i,0},c_{i,1},c_{i,2})$は\u003cstrong\u003e３つの制御点を結んだ三角形の符号付き面積\u003c/strong\u003eで、つまり\u003cstrong\u003e定数\u003c/strong\u003eです。\u003c/p\u003e\n\n\u003cp\u003e……何ともよく分からん式変形なので、図解します。\u003cbr\u003e\n同じ色の線分は平行です。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/b81607a57c7fb1b46e9f979d297624935d25f654/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f39303634383938332d383335312d356637632d356337642d3030333833336132653430352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F90648983-8351-5f7c-5c7d-003833a2e405.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7fca544ecfe6ac7ad242bad79ca55db5\" alt=\"k0.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/90648983-8351-5f7c-5c7d-003833a2e405.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F90648983-8351-5f7c-5c7d-003833a2e405.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6764dbb2cd87eadafa29735de9ae7390 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n$c_{i,0},c_{i,1},c_{i,2}$を３点とする平行四辺形の残りの点（$c_{i,1}$の対角位置）を$P$とし、\u003cbr\u003e\n$c_{i,0},c_{i,1},P$を３点とする平行四辺形の残りの点（$c_{i,1}$の対角位置）を$R$とします。\u003c/p\u003e\n\n\u003cp\u003e$c_{i,0}$を原点としたときに、$\\frac{1}{2}c_i'(t)=(1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1})$がどこを示す位置ベクトルになるかというと、見たまんま内分点なので図の点$Q$です。\u003c/p\u003e\n\n\u003cp\u003e同じように、$\\frac{1}{2}c_i''(t)=(c_{i,0}-c_{i,1}) + (c_{i,2} - c_{i,1})$は点$R$を示します。\u003c/p\u003e\n\n\u003cp\u003eよって、これらの外積$\\frac{1}{4}c_i'(t)\\times c_i''(t)$の絶対値は、以下の領域の面積になります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f717d4e75f742f25ea45120843895b4e76f6cc71/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f61363361643038652d376363352d613331632d376335302d6633613532333231306566622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fa63ad08e-7cc5-a31c-7c50-f3a523210efb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7be79a1312482c241e016e1b68b82a13\" alt=\"k1.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/a63ad08e-7cc5-a31c-7c50-f3a523210efb.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fa63ad08e-7cc5-a31c-7c50-f3a523210efb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=08e8ab62c7ed6b5b91d500a5934ab426 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれは、以下の領域の面積と等しいことが等積変形によってわかります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/7269b52c0b2e481f84e354a65ecaee86bfa27d38/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f66326534396661312d303163612d643037612d336461652d3865306531313031323238662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Ff2e49fa1-01ca-d07a-3dae-8e0e1101228f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3c9a71c6dabcdcd2b4f546b8c149e4d5\" alt=\"k2.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/f2e49fa1-01ca-d07a-3dae-8e0e1101228f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Ff2e49fa1-01ca-d07a-3dae-8e0e1101228f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=fe5a6fc0ea7028338704fe1f986a3f93 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nよって、$t$の値によらず、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\frac{1}{4}c_i'(t)\\times c_i''(t)=2\\triangle(c_{i,0},c_{i,1},c_{i,2})\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eであることが分かります。初等幾何は楽しいですね。\u003c/p\u003e\n\n\u003cp\u003eというわけで再掲すると、２次ベジェ曲線の$i$番目のセグメント上の点$c_i(t)$における曲率は、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\kappa_i(t)=\\frac{\\triangle(c_{i,0},c_{i,1},c_{i,2})}{\\|(1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1})\\|^3}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eで求められます。\u003c/p\u003e\n\n\u003cp\u003e※面積の符号については、最終的に絶対値で吸収されるのであまり気にしなくて大丈夫です。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"曲率極大点\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9B%B2%E7%8E%87%E6%A5%B5%E5%A4%A7%E7%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e曲率極大点\u003c/h3\u003e\n\n\u003cp\u003e曲率の絶対値が極大になるときの$t$を$t_i$とすると、$\\kappa'(t_i)=0$より、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\n\\kappa'(t_i)=-\\frac{\\triangle(c_{i,0},c_{i,1},c_{i,2})\\cdot 3(\\|c_i'(t_i)\\|)'}{\\|c_i'(t_i)\\|^4}\u0026amp;=0\\\\\\\\\n(\\|c_i'(t_i)\\|)'\u0026amp;=0\\\\\\\\\nc_i'(t_i)c_i''(t_i)\u0026amp;=0\\\\\\\\\n((c_{i,0}-2c_{i,1}+c_{i,2})t_i-(c_{i,0}-c_{i,1}))\\cdot(c_{i,0}-2c_{i,1}+c_{i,2})\u0026amp;=0\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eというわけで\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003et_i=\\frac{(c_{i,0}-c_{i,1})\\cdot(c_{i,0}-2c_{i,1}+c_{i,2})}{\\|c_{i,0}-2c_{i,1}+c_{i,2}\\|^2}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとなります。\u003cbr\u003e\n$c_{i,1}$から見たローカル座標として、$c_{i,0}'=c_{i,0}-c_{i,1},\\ c_{i,2}'=c_{i,2}-c_{i,1}$とおけば、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003et_i=\\frac{c_{i,0}'\\cdot(c_{i,0}'+c_{i,2}')}{\\|c_{i,0}'+c_{i,2}'\\|^2}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとそこそこ綺麗な形になります。\u003c/p\u003e\n\n\u003cp\u003eこのように、与えられたベジェ制御点から曲率極大点を求めるのは簡単です。\u003cbr\u003e\nκ-Curvesはこの逆、\u003cstrong\u003e与えられたユーザ制御点を曲率極大点$c_i(t_i)$とし、それを満たすベジェ制御点を逆算\u003c/strong\u003eするシステムです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"κ-curves\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%CE%BA-curves\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eκ-Curves\u003c/h1\u003e\n\n\u003cp\u003eいよいよκ-Curvesを構成していきます。\u003cbr\u003e\n問題の大枠は以下の通り：\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003e入力：$n$個のユーザ制御点$p_i\\ (0\\le i\u0026lt;n)$\u003cbr\u003e\n出力：$3n$個のベジェ制御点$c_{i,j}\\ (0\\le i\u0026lt;n,\\ j=0,1,2)$\u003c/p\u003e\n\n\u003cp\u003e制約１：ユーザ制御点で極大曲率\u003cbr\u003e\n制約２：$C^0$連続\u003cbr\u003e\n制約３：$G^1$連続\u003cbr\u003e\n制約４：ほぼ$G^2$連続\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e４つの制約を順に見ていきましょう。\u003c/p\u003e\n\n\u003cp\u003e※ベジェ制御点$c_{i,j}$の添字$i$については、ひとまずはループしているものとみなし、$\\rm{mod}\\ n$で考えます。\u003cbr\u003e\n　範囲制限をつけずに$i+1$とか$i-1$とか書きますが怒らないでください。非ループ版への拡張は簡単です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"制約１ユーザ制御点で極大曲率\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%B6%E7%B4%84%EF%BC%91%E3%83%A6%E3%83%BC%E3%82%B6%E5%88%B6%E5%BE%A1%E7%82%B9%E3%81%A7%E6%A5%B5%E5%A4%A7%E6%9B%B2%E7%8E%87\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e制約１：ユーザ制御点で極大曲率\u003c/h2\u003e\n\n\u003cp\u003e$p_i=c_i(t_i)$を、$c_{i,1}$について整理してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\np_i\u0026amp;=c_i(t_i)\\\\\np_i\u0026amp;=(c_{i,0}-2c_{i,1}+c_{i,2})t_i^2-2(c_{i,0}-c_{i,1})t_i+c_{i,0}\\\\\\\\\nc_{i,1}\u0026amp;=\\frac{p_i-(1-t_i)^2c_{i,0}-t^2c_{i,2}}{2t_i(1-t_i)}\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e※$t_i=0, 1$のときはそれぞれ$p_i=c_{i,0}, c_{i,2}$のときなので、個別に簡単に考えることができます。\u003cbr\u003e\nこれを先程導出した$t_i$の式：\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003et_i=\\frac{(c_{i,0}-c_{i,1})\\cdot(c_{i,0}-2c_{i,1}+c_{i,2})}{\\|c_{i,0}-2c_{i,1}+c_{i,2}\\|^2}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eに代入して気合で整理すると、以下の$t_i$の三次方程式が得られます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\|c_{i,2}-c_{i,0}\\|^2t_i^3+3(c_{i,2}-c_{i,0})\\cdot(c_{i,0}-p_i)t_i^2+(3c_{i,0}-2p_i-c_{i,2})\\cdot(c_{i,0}-p_i)t_i-\\|c_{i,0}-p_i\\|^2=0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eただの３次方程式なので、\u003cstrong\u003e解の公式（カルダノの公式）で解くことができます。\u003c/strong\u003e\u003cbr\u003e\n係数がごちゃごちゃしていますが、$c_{i,0}$から見たローカル座標で $c_{i,2}'=c_{i,2}-c_{i,0},\\ p_i'=p_i-c_{i,0}$ と書き直せば、少し短くなります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\|c'_{i,2}\\|^2t_i^3-3c'_{i,2}p'_it_i^2+(2p_i'+c_{i,2}')p_i't_i-\\|p_i'\\|^2=0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"綺麗にする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B6%BA%E9%BA%97%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e綺麗にする\u003c/h3\u003e\n\n\u003cp\u003eもっと綺麗に整理するために、$p_i$から見たローカル座標で考えてみましょう。\u003cbr\u003e\n$v_0=c_{i,0}-p_i,\\ v_2=c_{i,2}-p_i$とすると、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\|v_2-v_0\\|^2t_i^3+3(v_2-v_0)v_0t_i^2+(3v_0-v_2)v_0t_i-\\|v_0\\|^2=0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eですが、これは以下のように変形できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left(\\begin{matrix}\n\\|v_0\\|^2\\\\\nv_0\\cdot v_2\\\\\n-v_0\\cdot v_2\\\\\n-\\|v_2\\|^2\n\\end{matrix}\\right)\n\\cdot\n\\left(\\begin{matrix}\n(1-t_i)^3\\\\\nt_i(1-t_i)^2\\\\\nt_i^2(1-t_i)\\\\\nt_i^3\n\\end{matrix}\\right)\n=0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e対称的な形になりました。\u003cbr\u003e\n２つ目、３つ目の係数を調整すれば３次の\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%83%90%E3%83%BC%E3%83%B3%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%B3%E5%A4%9A%E9%A0%85%E5%BC%8F\" rel=\"nofollow noopener\" target=\"_blank\"\u003eバーンスタイン多項式\u003c/a\u003eとして扱えます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"実解の範囲と個数\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A7%A3%E3%81%AE%E7%AF%84%E5%9B%B2%E3%81%A8%E5%80%8B%E6%95%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実解の範囲と個数\u003c/h3\u003e\n\n\u003cp\u003eところでこの方程式は、\u003cstrong\u003e必ず$[0,1]$内にただ１つの実解を持ちます。\u003c/strong\u003e\u003cbr\u003e\nさすがに自明ではなく、論文にもAppendixに証明があります。概略は以下のとおり：\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eまず\u003ca href=\"https://ja.wikipedia.org/wiki/%E4%B8%AD%E9%96%93%E5%80%A4%E3%81%AE%E5%AE%9A%E7%90%86\" rel=\"nofollow noopener\" target=\"_blank\"\u003e中間値の定理\u003c/a\u003eより、$[0,1]$内に実解が一つ以上存在します。\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%83%87%E3%82%AB%E3%83%AB%E3%83%88%E3%81%AE%E7%AC%A6%E5%8F%B7%E6%B3%95%E5%89%87\" rel=\"nofollow noopener\" target=\"_blank\"\u003eデカルトの符号律\u003c/a\u003eはバーンスタイン多項式にも適用できる（らしい）ので、$v_0\\cdot v_2\\ge 0$であれば実解は１つだけです。\u003c/li\u003e\n\u003cli\u003e$v_0\\cdot v_2\u0026lt;0$の場合も、導関数の正負は$[0,1]$内で一定であることが示せるので、実解は１つだけです。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"制約２c連続\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%B6%E7%B4%84%EF%BC%92c%E9%80%A3%E7%B6%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e制約２：C⁰連続\u003c/h2\u003e\n\n\u003cp\u003e曲線\u003cstrong\u003e全体\u003c/strong\u003eの\u003cstrong\u003e位置\u003c/strong\u003eが連続であることを保証する制約です。\u003cbr\u003e\n各セグメント内が連続なのは自明として、隣り合うセグメントが端点で互いに接続していればよいので、\u003cbr\u003e\n任意の$i$について、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ec_{i,2}=c_{i+1,0}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eが満たされればよいですね。簡単。次に行きましょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"制約３g連続\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%B6%E7%B4%84%EF%BC%93g%E9%80%A3%E7%B6%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e制約３：G¹連続\u003c/h2\u003e\n\n\u003cp\u003eセグメントの\u003cstrong\u003e接続点\u003c/strong\u003eの\u003cstrong\u003e傾き\u003c/strong\u003eが連続であることを保証する制約です。\u003cbr\u003e\nこれがないと、セグメントとセグメントの間で線が折れてしまいます。\u003c/p\u003e\n\n\u003cp\u003e任意の$i$について、ある$\\lambda_i\\in(0,1)$があって、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ec_{i,2}=(1-\\lambda_i)c_{i,1}+\\lambda_ic_{i+1,1}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eが満たされれば、$c_{i,2}=c_{i+1,0}$における接線は$c_{i,1}$と$c_{i+1,1}$を結ぶ直線に定まります。\u003cbr\u003e\nκ-Curvesにおいてベジェ制御点は入力ではなく出力なので、これで全ての場合が網羅されています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ユーザ制御点位置の別表示\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%A6%E3%83%BC%E3%82%B6%E5%88%B6%E5%BE%A1%E7%82%B9%E4%BD%8D%E7%BD%AE%E3%81%AE%E5%88%A5%E8%A1%A8%E7%A4%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eユーザ制御点位置の別表示\u003c/h3\u003e\n\n\u003cp\u003eまたこの制約のもとでは、ユーザ制御点の位置$p_i=c_i(t_i)$を、$c_{i,0}, c_{i,2}$を使わずに以下のように表現可能です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ep_i=(1-\\lambda_{i-1})(1-t_i)^2c_{i-1,1}+\\big(\\lambda_{i-1}(1-t_i)^2+(2-(1+\\lambda_i)t_i)t_i\\big)c_{i,1}+\\lambda_it_i^2c_{i+1,1}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e何でそんな変形を？　と思うかもしれませんが、後で使います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"制約４ほぼg連続\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%B6%E7%B4%84%EF%BC%94%E3%81%BB%E3%81%BCg%E9%80%A3%E7%B6%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e制約４：ほぼG²連続\u003c/h2\u003e\n\n\u003cp\u003eセグメントの\u003cstrong\u003e接続点\u003c/strong\u003eの\u003cstrong\u003e曲率\u003c/strong\u003eが（ほぼ）連続であることを保証する制約です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\kappa_i(t)=\\frac{\\triangle(c_{i,0},c_{i,1},c_{i,2})}{\\|(1-t)(c_{i,1}-c_{i,0})+t(c_{i,2}-c_{i,1})\\|^3}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eで、任意の$i$について$\\kappa_i(1)=\\kappa_{i+1}(0)$であればいいので、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\n\\kappa_i(1)\u0026amp;=\\kappa_{i+1}(0)\\\\\\\\\n\\frac{\\triangle(c_{i,0},c_{i,1},c_{i,2})}{\\|c_{i,2}-c_{i,1}\\|^3}\n\u0026amp;=\\frac{\\triangle(c_{i+1,0},c_{i+1,1},c_{i+1,2})}{\\|c_{i+1,1}-c_{i+1,0}\\|^3}\\\\\\\\\n\\frac{\\triangle(c_{i,0},c_{i,1},c_{i,2})}{\\|c_{i,1}-c_{i+1,1}\\|^3\\lambda_i^3}\n\u0026amp;=\\frac{\\triangle(c_{i+1,0},c_{i+1,1},c_{i+1,2})}{\\|c_{i,1}-c_{i+1,1}\\|^3(1-\\lambda_i)^3}\\\\\\\\\n\\frac{\\triangle(c_{i,0},c_{i,1},c_{i+1,1})}{\\lambda_i^2}\n\u0026amp;=\\frac{\\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})}{(1-\\lambda_i)^2}\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eより（最後の式変形は図を書いて面積比に着目するとすぐ分かります）、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\lambda_i=\\frac{\\sqrt{\\triangle(c_{i,0},c_{i,1},c_{i+1,1})}}{\\sqrt{\\triangle(c_{i,0},c_{i,1},c_{i+1,1})}+\\sqrt{\\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})}}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eが得られます。\u003c/p\u003e\n\n\u003cp\u003eところで、ベジェ曲線の曲率が０になることはないので、隣り合うセグメントの凹凸が逆である場合、曲率は必ず不連続になります。\u003cbr\u003e\nこのとき、$\\triangle(c_{i,0},c_{i,1},c_{i+1,1}),\\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})$の符号が異なるので、$\\lambda_i$は実数ではなくなります。\u003c/p\u003e\n\n\u003cp\u003e一致させられないのであれば、せめて絶対値の差を０にしましょう。\u003cbr\u003e\nつまり$|\\kappa_i(1)|=|\\kappa_{i+1}(0)|$を解くわけですが、$\\kappa_i(1)$と$\\kappa_{i+1}(0)$の符号は逆なので、$\\kappa_i(1)=-\\kappa_{i+1}(0)$を解けばいいことがわかります。\u003cbr\u003e\nすると、曲率が連続の場合とほぼ同様の手順で、以下が求まります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\lambda_i=\\frac{\\sqrt{|\\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}}{\\sqrt{|\\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}+\\sqrt{|\\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})|}}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれは先程の式も包含できているので、制約式としてはこちらのみを使えばよさそうです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"制約まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%B6%E7%B4%84%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e制約まとめ\u003c/h2\u003e\n\n\u003cp\u003e制約とその関連式をまとめると、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left\\{\\begin{array}{ll}\n(1)\u0026amp;\\|c'_{i,2}\\|^2t_i^3-3c'_{i,2}p'_it_i^2+(2p_i'+c_{i,2}')p_i't_i-\\|p_i'\\|^2=0\\\\\n\u0026amp;(c_{i,2}'=c_{i,2}-c_{i,0},\\ p_i'=p_i-c_{i,0})\\\\\\\\\n(2)\u0026amp;c_{i,2}=c_{i+1,0}=(1-\\lambda_i)c_{i,1}+\\lambda_ic_{i+1,1}\\\\\\\\\n(3)\u0026amp;p_i=(1-\\lambda_{i-1})(1-t_i)^2c_{i-1,1}+\\big(\\lambda_{i-1}(1-t_i)^2+(2-(1+\\lambda_i)t_i)t_i\\big)c_{i,1}+\\lambda_it_i^2c_{i+1,1}\\\\\\\\\n(4)\u0026amp;\\lambda_i=\\displaystyle\\frac{\\sqrt{|\\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}}{\\sqrt{|\\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}+\\sqrt{|\\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})|}}\\\\\n\\end{array}\\right.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eが満たされるようにベジェ制御点$c_{i,j}$を定めればよいことになります。\u003cbr\u003e\nが、これをこのまま解析的に解くのは困難です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"アルゴリズム\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eアルゴリズム\u003c/h2\u003e\n\n\u003cp\u003e式(1)～(4)を使ってできることを並べてみると、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e全ての$c_{i,0}, c_{i,2}$があれば、(1)で全ての$t_i$を求められる\u003c/li\u003e\n\u003cli\u003e全ての$\\lambda_i, c_{i,1}$があれば、(2)で全ての$c_{i,0}, c_{i,2}$を求められる\u003c/li\u003e\n\u003cli\u003e全ての$\\lambda_i, t_i$があれば、(3)で全ての$c_{i,1}$を求められる\u003c/li\u003e\n\u003cli\u003e全ての$c_{i,0},c_{i,1},c_{i,2}$があれば、(4)で全ての$\\lambda_i$を求められる\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eとなります。\u003cbr\u003e\nこれらをうまく組み合わせて、全ての$p_i$から全ての$c_{i,j}$を出力したいわけです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"概要\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e概要\u003c/h3\u003e\n\n\u003cp\u003e適当な初期値から始めて、何度も式を適用することで正解に近づけていく方針を取ります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003eStep0.\u003c/strong\u003e 各$\\lambda_i,\\ c_{i,j}$を初期化\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eStep1.\u003c/strong\u003e 式(4)で各$\\lambda_i$を算出・更新\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eStep2.\u003c/strong\u003e 式(2)で各$c_{i,0}, c_{i,2}$を更新\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eStep3.\u003c/strong\u003e 式(1)で各$t_i$を算出・更新\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eStep4.\u003c/strong\u003e 式(3)で各$c_{i,1}$を更新\u003c/li\u003e\n\u003cli\u003eIf 満足 \n\n\u003cul\u003e\n\u003cli\u003ethen \u003cstrong\u003ereturn\u003c/strong\u003e $c_{i,j}$ \u003c/li\u003e\n\u003cli\u003eelse \u003cstrong\u003egoto\u003c/strong\u003e Step1.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e各ステップに分けて見ていきましょう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step0-初期化\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step0-%E5%88%9D%E6%9C%9F%E5%8C%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep0. 初期化\u003c/h3\u003e\n\n\u003cp\u003e以下のように初期化します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e$\\lambda_i=0.5$\u003c/li\u003e\n\u003cli\u003e$c_{i,1}=p_i$\u003c/li\u003e\n\u003cli\u003e$c_{i,2}=c_{i+1,0} = (1-\\lambda_i)c_{i,1}+\\lambda_ic_{i+1,1} =  (c_{i,1} + c_{i+1,1})/2$\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eつまり、ユーザ制御点と中央のベジェ制御点が同じ場所にあり、\u003cbr\u003e\nその他のベジェ制御点は隣接制御点の中点にある状態から始まります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/7e1a3ed106963c9a059975d75bf0cfc514b75cd3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f62633461363331612d616639632d373733312d383563342d3063653438303630653562332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fbc4a631a-af9c-7731-85c4-0ce48060e5b3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=127067bc91622ef8b67d4151d2dcf985\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/bc4a631a-af9c-7731-85c4-0ce48060e5b3.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fbc4a631a-af9c-7731-85c4-0ce48060e5b3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0e579008625b868b1c4f4c87f5440127 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれは論文から引用した図で、初期化時の状態の例です。\u003cbr\u003e\n黒い四角がユーザ制御点$p_i$で、$c_{i,1}$と一致しています。緑色の点は各セグメントの曲率極大点$c_i(t_i)$です。\u003cbr\u003e\n今はまだ$p_i$と$c_i(t_i)$が離れていますが、この後のStep1～4のイテレーションを回すことで近づけていきます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/1789a765b8cfe6751b9cd6eefcc4ba3632b28615/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f66343939333239632d626363352d313863342d646465632d3166646565613732643763392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Ff499329c-bcc5-18c4-ddec-1fdeea72d7c9.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7f1374ee3d94938adbd1eaa18334c270\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/f499329c-bcc5-18c4-ddec-1fdeea72d7c9.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Ff499329c-bcc5-18c4-ddec-1fdeea72d7c9.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f3fd7a9d1910ba609ac293ee7a01df56 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n左から順に、初期状態、１ループ後、２ループ後、３０ループ後（完全収束）です。\u003cbr\u003e\nループ数は誤植ではなく、本当に数ループでほとんど完全収束と同じような形になります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step1-λの算出\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step1-%CE%BB%E3%81%AE%E7%AE%97%E5%87%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep1. λの算出\u003c/h3\u003e\n\n\u003cp\u003e式(4):\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\lambda_i=\\frac{\\sqrt{|\\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}}{\\sqrt{|\\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}+\\sqrt{|\\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})|}}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eを適用します。やるだけ。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step2-ベジェ制御点両端の更新\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step2-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%A1%E7%AB%AF%E3%81%AE%E6%9B%B4%E6%96%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep2. ベジェ制御点（両端）の更新\u003c/h3\u003e\n\n\u003cp\u003e式(2):\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ec_{i,2}=c_{i+1,0}=(1-\\lambda_i)c_{i,1}+\\lambda_ic_{i+1,1}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eを計算します。これもやるだけ。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step3-曲率極大点の算出\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step3-%E6%9B%B2%E7%8E%87%E6%A5%B5%E5%A4%A7%E7%82%B9%E3%81%AE%E7%AE%97%E5%87%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep3. 曲率極大点の算出\u003c/h3\u003e\n\n\u003cp\u003e式(1):\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\|c'_{i,2}\\|^2t_i^3-3c'_{i,2}p'_it_i^2+(2p_i'+c_{i,2}')p_i't_i-\\|p_i'\\|^2=0\\ \\ \\ (c_{i,2}'=c_{i,2}-c_{i,0},\\ p_i'=p_i-c_{i,0})\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eを解きます。カルダノの公式（三次方程式の解の公式）を組みましょう。\u003cbr\u003e\n実解がただ一つ$[0,1]$に存在することが分かっています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step4-ベジェ制御点中央の更新\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step4-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%AD%E5%A4%AE%E3%81%AE%E6%9B%B4%E6%96%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep4. ベジェ制御点（中央）の更新\u003c/h3\u003e\n\n\u003cp\u003e式(3):\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ep_i=(1-\\lambda_{i-1})(1-t_i)^2c_{i-1,1}+\\big(\\lambda_{i-1}(1-t_i)^2+(2-(1+\\lambda_i)t_i)t_i\\big)c_{i,1}+\\lambda_it_i^2c_{i+1,1}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eを、全ての$c_{i,1}$について解きます。n元連立１次方程式ですね。\u003cbr\u003e\n中学・高校の数学の範囲でも気合で解くことはできそうですが、行列を使うと簡単になります。\u003c/p\u003e\n\n\u003cp\u003eまず、係数を$\\alpha_i, \\beta_i, \\gamma_i$として見やすく書き直しておきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ep_i=\\alpha_ic_{i-1,1}+\\beta_ic_{i,1}+\\gamma_ic_{i+1,1}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれは、以下のように行列表示の連立方程式にまとめることができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left(\\begin{matrix}\n\\beta_0\u0026amp;\\gamma_0\u0026amp;\u0026amp;\u0026amp;\\alpha_0\\\\\n\\alpha_1\u0026amp;\\beta_1\u0026amp;\\gamma_1\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;\\ddots\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;\\alpha_{n-2}\u0026amp;\\beta_{n-2}\u0026amp;\\gamma_{n-2}\\\\\n\\gamma_{n-1}\u0026amp;\u0026amp;\u0026amp;\\alpha_{n-1}\u0026amp;\\beta_{n-1}\n\\end{matrix}\\right)\n\\left(\\begin{matrix}\nc_{0,1}\\\\\nc_{1,1}\\\\\n\\vdots\\\\\nc_{n-2,1}\\\\\nc_{n-1,1}\\\\\n\\end{matrix}\\right)\n=\n\\left(\\begin{matrix}\np_0\\\\\np_1\\\\\n\\vdots\\\\\np_{n-2}\\\\\np_{n-1}\\\\\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e行列部分は\u003cstrong\u003e三重対角行列＋角\u003c/strong\u003eなので、高速に\u003cstrong\u003eLU分解\u003c/strong\u003eでき、解を$O(n)$で求めることができます。\u003cbr\u003e\nさらに、これを上下に（行列は上下左右に）１つずつ拡張して\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left(\\begin{matrix}\n1\u0026amp;0\u0026amp;\u0026amp;\u0026amp;\\\\\n\\alpha_0\u0026amp;\\beta_0\u0026amp;\\gamma_0\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;\\ddots\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;\\alpha_{n-1}\u0026amp;\\beta_{n-1}\u0026amp;\\gamma_{n-1}\\\\\n\u0026amp;\u0026amp;\u0026amp;0\u0026amp;1\n\\end{matrix}\\right)\n\\left(\\begin{matrix}\nc_{n-1,1}\\\\\nc_{0,1}\\\\\n\\vdots\\\\\nc_{n-1,1}\\\\\nc_{0,1}\\\\\n\\end{matrix}\\right)\n=\n\\left(\\begin{matrix}\nc_{n-1,1}\\\\\np_0\\\\\n\\vdots\\\\\np_{n-1}\\\\\nc_{0,1}\\\\\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eという形にすれば、行列部分はただの三重対角行列になるので、さらに計算が楽になります。\u003c/p\u003e\n\n\u003cp\u003eまた、$n\\ge5$の場合は\u003cstrong\u003eメモリ的にも有利になります。\u003c/strong\u003e\u003cbr\u003e\n角つき三重対角行列はLU分解のためにメモリを$n\\times n$要素分、頑張って削減しても$5\\times n$要素分くらい食うのに対し、上下に伸ばした三重対角行列は$3\\times (n+2)$要素分で済むのです。\u003c/p\u003e\n\n\u003cp\u003eLU分解については記事の最後の付録で解説します。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h2\u003e\n\n\u003cp\u003e実際に実装していきましょう。\u003cbr\u003e\n言語はC#で、座標表現やfloatの各種演算にUnityのVector2クラス、Mathfクラスを借りています。\u003cbr\u003e\nUnity特有の何かがあるわけではないので、適宜好きな言語、好きなベクトル表現・数学ライブラリに置き換えてください。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ベジェ制御点用構造体\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E7%94%A8%E6%A7%8B%E9%80%A0%E4%BD%93\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eベジェ制御点用構造体\u003c/h3\u003e\n\n\u003cp\u003eただの配列のラッパーです。計算結果の出力もこのインスタンスで。\u003cbr\u003e\nベジェ制御点は隣接セグメント間で重複するので、配列サイズは重複を除いた最低限の$2n+1$とします。\u003cbr\u003e\nただ分かりにくいので、ここまでの解説に合わせて[i,j]でアクセスできるようにしておきます。\u003cbr\u003e\nまた、$n\u0026lt;3$の場合は点か直線を表示することが予想されるので、セグメント数を1とします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eBezierControls\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//ベジェ制御点群\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//c_{0,0}, c_{0,1}, c_{1,0}, ..., c_{n-1,0}, c_{n-1,1}, c_{n-1,2}の順\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ePoints\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//セグメント数\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//c_{i,j}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eset\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//コンストラクタ\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eBezierControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ePoints\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"計算空間の確保\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A8%88%E7%AE%97%E7%A9%BA%E9%96%93%E3%81%AE%E7%A2%BA%E4%BF%9D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e計算空間の確保\u003c/h3\u003e\n\n\u003cp\u003eユーザ制御点が移動する度に描画を更新するわけなので、計算空間は事前に確保して使い回しましょう。\u003cbr\u003e\n制御点が増減すると確保し直しになりますが、その辺りを考慮するとコードが煩雑になるのでここでは妥協。\u003cbr\u003e\nStep4の行列計算時に使うメモリは三重対角部分だけで済むので、配列は$3(n+2)$要素だけ確保します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCalcSpace\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e              \u003cspan class=\"c1\"\u003e//制御点数\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eL\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e        \u003cspan class=\"c1\"\u003e//λ\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003eC\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e//ベジェ制御点（出力）\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e       \u003cspan class=\"c1\"\u003e//t\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e       \u003cspan class=\"c1\"\u003e//Step4の行列計算用メモリ\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eL\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eC\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eBezierControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003eResult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ユーザ制御点ベジェ制御点の上下拡張\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%A6%E3%83%BC%E3%82%B6%E5%88%B6%E5%BE%A1%E7%82%B9%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E3%81%AE%E4%B8%8A%E4%B8%8B%E6%8B%A1%E5%BC%B5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eユーザ制御点・ベジェ制御点の上下拡張\u003c/h3\u003e\n\n\u003cp\u003eStep4の行列計算時にユーザ制御点ベクトルとベジェ制御点ベクトルを上下拡張しますが、その際のメモリ確保をなくしつつちゃんと配列っぽく扱えるようにするためのラッパー構造体です。\u003cbr\u003e\nコンストラクタで上下拡張時の値の初期化もやっています。\u003cbr\u003e\n本質部分ではないしC#の人じゃないとたぶん意味が分からないので適当に読み飛ばしてください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eExtendedPlayerControls\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003etop\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ebottom\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003etop\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ebottom\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eset\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003etop\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"n\"\u003ebottom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eExtendedPlayerControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etop\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eps\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebottom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eExtendedBezierControls\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003etop\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ebottom\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003etop\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ebottom\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eset\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003etop\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"n\"\u003ebottom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eExtendedBezierControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etop\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebottom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"メソッドルート\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%83%AB%E3%83%BC%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eメソッドルート\u003c/h3\u003e\n\n\u003cp\u003e処理の根本になる部分を作ります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eユーザ制御点 \u003ccode\u003epoints\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003e計算空間 \u003ccode\u003espace\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eイテレーション回数 \u003ccode\u003eiteration\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003e曲線をループさせるかどうか \u003ccode\u003eisLoop\u003c/code\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eを受け取り、Step0で初期化し、Step1～4でイテレーションを回し、最適化の結果を返します。\u003cbr\u003e\nただしユーザ制御点が２つ以下の場合は、それぞれ点や直線となるように制御点を配置して返します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcBezierControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCalcSpace\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eiteration\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"The length of \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e must equals to \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e.\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ezero\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"nf\"\u003eStep0\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eiteration\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStep1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStep2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStep3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStep4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eでは、各Stepの実装をしましょう。\u003cbr\u003e\nループしない場合の対応も一緒にやっていきます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step0-初期化-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step0-%E5%88%9D%E6%9C%9F%E5%8C%96-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep0: 初期化\u003c/h3\u003e\n\n\u003cp\u003e初期化内容はこうでした。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e$\\lambda_i=0.5$\u003c/li\u003e\n\u003cli\u003e$c_{i,1}=p_i$\u003c/li\u003e\n\u003cli\u003e$c_{i,2}=c_{i+1,0} = (1-\\lambda_i)c_{i,1}+\\lambda_ic_{i+1,1}$\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e非ループの場合、始端と終端はユーザ制御点であってほしいので、初期化時に固定してしまいましょう。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e$\\lambda_0=0$\u003c/li\u003e\n\u003cli\u003e$\\lambda_{n-2}=1$\u003c/li\u003e\n\u003cli\u003e$\\lambda_{n-1}=\\rm{undefined}$\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e非ループの場合、終端→始端のカーブは必要なくなるので、ループの場合より\u003cstrong\u003eセグメントが２つ減る\u003c/strong\u003eことに注意してください。その結果、$\\lambda_{n-1}$は参照されなくなります。\u003c/p\u003e\n\n\u003cp\u003eセグメントが１つではなく２つ減るのは直感的ではありませんが、実際に見れば納得できるでしょう。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/e5236d2d663c6d73e6d58179487dfa5ec63447fb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f35363262336433302d326438632d353834642d343132622d3239323734386631303335392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F562b3d30-2d8c-584d-412b-292748f10359.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e4f57d5c34c6a0506c210303daf45c15\" alt=\"コメント 2020-02-04 122030.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/562b3d30-2d8c-584d-412b-292748f10359.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F562b3d30-2d8c-584d-412b-292748f10359.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=c90b6129ff411a67c7c670c5cff09622 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n黄色・水色・ピンクの線が各セグメントのベジェ制御点を結んだものです。\u003cbr\u003e\n非ループの場合、水色とピンクの線が潰れているのが分かるでしょうか。\u003c/p\u003e\n\n\u003cp\u003eついでに、Step4で使う行列（の三重対角部分を保存するためのメモリ）の両端部の初期化もしてしまいます：\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eA=\\left(\\begin{matrix}\n0\u0026amp;1\u0026amp;0\\\\\n\\alpha_0\u0026amp;\\beta_0\u0026amp;\\gamma_0\\\\\n\u0026amp;\\vdots\u0026amp;\\\\\n\\alpha_{n-1}\u0026amp;\\beta_{n-1}\u0026amp;\\gamma_{n-1}\\\\\n0\u0026amp;1\u0026amp;0\\\\\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e非ループの場合、$c_{0,1}=p_0,\\ c_{n-1,1}=p_{n-1}$となればよいので、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eA=\\left(\\begin{matrix}\n0\u0026amp;1\u0026amp;0\\\\\n0\u0026amp;1\u0026amp;0\\\\\n\\alpha_1\u0026amp;\\beta_1\u0026amp;\\gamma_1\\\\\n\u0026amp;\\vdots\u0026amp;\\\\\n\\alpha_{n-2}\u0026amp;\\beta_{n-2}\u0026amp;\\gamma_{n-2}\\\\\n0\u0026amp;1\u0026amp;0\\\\\n0\u0026amp;1\u0026amp;0\\\\\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとします。\u003c/p\u003e\n\n\u003cp\u003eコードはこんな感じ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStep0\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//全てのλを0.5で初期化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0.5f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//ループしない場合、最初と最後から２番目を0,1に変更（最後はそもそも使わない）\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//lambdas[n - 1] = undefined;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//中央のベジェ制御点を全てユーザ制御点で初期化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//他のベジェ制御点を初期化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//行列の端の値は固定\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//非ループの場合はさらにもう一行ずつ固定\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step1-λの算出-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step1-%CE%BB%E3%81%AE%E7%AE%97%E5%87%BA-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep1: λの算出\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\lambda_i=\\frac{\\sqrt{|\\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}}{\\sqrt{|\\triangle(c_{i,0},c_{i,1},c_{i+1,1})|}+\\sqrt{|\\triangle(c_{i,1},c_{i+1,1},c_{i+1,2})|}}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e三角形の面積を求める解説は必要ないでしょう。外積の半分です。\u003cbr\u003e\n非ループ時は始端と終端のλは更新しません。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStep1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//三角形の面積を求める関数\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"nf\"\u003eTriArea\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ep1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ep2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ep3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ep1\u003c/span\u003e \u003cspan class=\"p\"\u003e-=\u003c/span\u003e \u003cspan class=\"n\"\u003ep3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ep2\u003c/span\u003e \u003cspan class=\"p\"\u003e-=\u003c/span\u003e \u003cspan class=\"n\"\u003ep3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAbs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ep1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ep2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ep2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ep1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebegin\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePoints\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003et1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eTriArea\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e+\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e+\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003et2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eTriArea\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e+\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e+\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAbs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003et2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0.00001f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0.5f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et1\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et2\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003et2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e   \n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eSqrt計算を減らすために一応有理化して、分母がほぼ0のときは計算させず0.5にしています。\u003c/p\u003e\n\n\u003cp\u003eなおκ-Curvesは３次元曲線にしても全く同じアルゴリズムで使えますが、外積の定義を３次元版（の絶対値）に変えるのを忘れないようにしましょう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step2-ベジェ制御点両端の更新-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step2-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%A1%E7%AB%AF%E3%81%AE%E6%9B%B4%E6%96%B0-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep2: ベジェ制御点（両端）の更新\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ec_{i,2}=c_{i+1,0}=(1-\\lambda_i)c_{i,1}+\\lambda_ic_{i+1,1}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eやるだけです。\u003cbr\u003e\n$\\lambda_i$の方で非ループ対応はしているので、ここでは特に何もしません。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStep2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e※\u003ccode\u003eBezierControls\u003c/code\u003eの実体は最後以外の$c_{i,2}$を削った配列なので、最後以外は片方だけに代入しています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step3-曲率極大点の算出-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step3-%E6%9B%B2%E7%8E%87%E6%A5%B5%E5%A4%A7%E7%82%B9%E3%81%AE%E7%AE%97%E5%87%BA-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep3: 曲率極大点の算出\u003c/h3\u003e\n\n\u003cp\u003e三次方程式：\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\|c'_{i,2}\\|^2t_i^3-3c'_{i,2}p'_it_i^2+(2p_i'+c_{i,2}')p_i't_i-\\|p_i'\\|^2=0\\ \\ \\ (c_{i,2}'=c_{i,2}-c_{i,0},\\ p_i'=p_i-c_{i,0})\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eを解きます。\u003cbr\u003e\n三次方程式には解の公式（カルダノの公式）があるので、それを組みましょう。\u003cbr\u003e\n複素解や$[0,1]$範囲外の実解は無視します。\u003c/p\u003e\n\n\u003cp\u003eなお、実解の範囲が分かっているので二分探索などをしてもよいですが、全体の計算時間が５倍くらいに跳ね上がります。オススメしません。\u003c/p\u003e\n\n\u003cp\u003e$ax^3+bx^2+cx+d=0$の$[0,1]$内の実解のみを返すカルダノの公式：\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"nf\"\u003eSolveCubicEquation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//負の値に対応した３乗根\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"nf\"\u003eCbrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSign\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAbs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"m\"\u003e1.0\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e/=\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e/=\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ed\u003c/span\u003e \u003cspan class=\"p\"\u003e/=\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eq\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eD\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eq\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eq\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAbs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eD\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e1.0E-12\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e//D = 0\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCbrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eD\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esqrtD\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eD\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eu\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCbrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(-\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003esqrtD\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCbrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(-\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003esqrtD\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eu\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e  \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"c1\"\u003e//D \u0026lt; 0\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(-\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003earg\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAtan2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSqrt\u003c/span\u003e\u003cspan class=\"p\"\u003e(-\u003c/span\u003e\u003cspan class=\"n\"\u003eD\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003epi2d3\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePI\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eret1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eret1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eret1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eret2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003epi2d3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eret2\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eret2\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eret3\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003epi2d3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eret3\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eret3\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Invalid solution: \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eret1\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e, \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eret2\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e, \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eret3\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e参考：\u003ca href=\"http://www.1728.org/cubic2.htm\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこのページ\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれを使って、全ての$i$について三次方程式を解きます。\u003c/p\u003e\n\n\u003cp\u003eただし、そもそも三次方程式にならない場合の例外処理を忘れずに。\u003cbr\u003e\nセグメントが潰れている場合に$a=b=c=d=0$となり不定解となります。ここでは$0.5$を入れておきます。\u003cbr\u003e\nまた、ユーザ制御点がセグメントの端にある場合には計算せずに$0,1$としましょう。\u003c/p\u003e\n\n\u003cp\u003eこれらのフィルタリングの下では、$a$（と$d$）が非零であることが保証され、カルダノの公式が使えます。\u003cbr\u003e\nただし\u003cstrong\u003e桁落ち\u003c/strong\u003eでたまに破綻するので、実数の精度に気をつけましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStep3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//セグメントが潰れている場合は不定解なので0.5とする\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0.5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//セグメントの端にユーザ制御点がある場合は図形的に自明\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ec2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e   \u003cspan class=\"c1\"\u003e// != 0\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// != 0\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ec2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrMagnitude\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e             \u003cspan class=\"c1\"\u003e// != 0\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDot\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e     \n        \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDot\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ec2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \n        \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esqrMagnitude\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e             \u003cspan class=\"c1\"\u003e// != 0\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eSolveCubicEquation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e余談ですが、上のカルダノの公式が例外を吐く場合は大体、範囲外ではなくNaNになっています。\u003cbr\u003e\n不定解の例外処理を忘れているか、次のStep4でランク落ちを見過ごして発生したNaNがループで伝播してきている可能性が高いので、確認してみてください。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"step4-ベジェ制御点中央の更新-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#step4-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%AD%E5%A4%AE%E3%81%AE%E6%9B%B4%E6%96%B0-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStep4: ベジェ制御点（中央）の更新\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left(\\begin{matrix}\n1\u0026amp;0\u0026amp;\u0026amp;\u0026amp;\\\\\n\\alpha_0\u0026amp;\\beta_0\u0026amp;\\gamma_0\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;\\ddots\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;\\alpha_{n-1}\u0026amp;\\beta_{n-1}\u0026amp;\\gamma_{n-1}\\\\\n\u0026amp;\u0026amp;\u0026amp;0\u0026amp;1\n\\end{matrix}\\right)\n\\left(\\begin{matrix}\nc_{n-1,1}\\\\\nc_{0,1}\\\\\n\\vdots\\\\\nc_{n-1,1}\\\\\nc_{0,1}\\\\\n\\end{matrix}\\right)\n=\n\\left(\\begin{matrix}\nc_{n-1,1}\\\\\np_0\\\\\n\\vdots\\\\\np_{n-1}\\\\\nc_{0,1}\\\\\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eを解きます。ただし、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\n\\alpha_i\u0026amp;=(1-\\lambda_{i-1})(1-t_i)^2\\\\\n\\beta_i\u0026amp;=\\lambda_{i-1}(1-t_i)^2+(2-(1+\\lambda_i)t_i)t_i\\\\\n\\gamma_i\u0026amp;=\\lambda_it_i^2\\\\\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eです。\u003cbr\u003e\nなお非ループの場合、$i=0,n-1$についてはStep0で初期化したように\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\n\\alpha_0\u0026amp;=\\alpha_{n-1}=0\\\\\n\\beta_0\u0026amp;=\\beta_{n-1}=1\\\\\n\\gamma_0\u0026amp;=\\gamma_{n-1}=0\\\\\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eで固定なので、上書きしないようにします。\u003c/p\u003e\n\n\u003cp\u003eまずは三重対角行列の連立方程式を解く関数を作っておきます。\u003cbr\u003e\n三重対角行列のLU分解について、詳細は記事の最後に付録として載せてあります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eSolveTridiagonalEquation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eExtendedBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eExtendedPlayerControls\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"cm\"\u003e/* A=LU */\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ei3\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++,\u003c/span\u003e \u003cspan class=\"n\"\u003ei3\u003c/span\u003e\u003cspan class=\"p\"\u003e+=\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei3\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e/=\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei3\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e                 \u003cspan class=\"c1\"\u003e//l21  := a21/a11\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei3\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e-=\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei3\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei3\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e     \u003cspan class=\"c1\"\u003e//a'11 := a22-l21u12\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"cm\"\u003e/* Ly=b */\u003c/span\u003e            \n    \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e                    \u003cspan class=\"c1\"\u003e//対角要素は全て1なので、最上行はそのまま            \u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \u003cspan class=\"c1\"\u003e//対角要素の左隣の要素を対応するx（計算済み）にかけて引く\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"cm\"\u003e/* Ux=y */\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e/=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e              \u003cspan class=\"c1\"\u003e//最下行はただ割るだけ\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ei3\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e--,\u003c/span\u003e \u003cspan class=\"n\"\u003ei3\u003c/span\u003e \u003cspan class=\"p\"\u003e-=\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e   \u003cspan class=\"c1\"\u003e//対角要素の右隣の要素を対応するx（計算済み）にかけて引いて割る\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei3\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei3\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eあとはAを組み立ててユーザ制御点・ベジェ制御点を上下拡張して実行するだけです。\u003c/p\u003e\n\n\u003cp\u003eが、一つ注意点として、上のアルゴリズムで解くためには\u003cstrong\u003e$A$はフルランクである必要があります。\u003c/strong\u003e\u003cbr\u003e\nアルゴリズムに例外処理を加えてもいいですが、ここでは面倒なので$A$を微調整する方針でいきます。\u003cbr\u003e\n$t_i=1\\wedge t_{i+1}=0$の場合にランクが落ちるので、少しだけずらしてしまいましょう。\u003cbr\u003e\nなおループしない場合、$t_{n-2}=1$や$t_1=0$でも同じことが起きます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStep4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//係数行列Aを構成（端の部分はStep0で初期化済）\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eofs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e+\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eprev\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e//ランクが下がってしまう場合微調整\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0.99999f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0.00001f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eofs\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eprev\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eofs\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eprev\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eofs\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elambdas\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//入出力ベクトルを拡張\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eextendedPs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eExtendedPlayerControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eps\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eextendedCs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eExtendedBezierControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//連立方程式を解く\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eSolveTridiagonalEquation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eextendedCs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eextendedPs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"プロット\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%97%E3%83%AD%E3%83%83%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eプロット\u003c/h3\u003e\n\n\u003cp\u003eこれでκ-Curvesのシステムは完成ですが、まだベジェ曲線の制御点が算出できただけなので、描画する必要があります。\u003cbr\u003e\n実際に画面に映すのは各描画ライブラリにやってもらうとして、そのための点群を用意しなければなりません。\u003c/p\u003e\n\n\u003cp\u003eとは言っても、各セグメントについて、↓これにtを順番に突っ込めばいいだけです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ec_i(t)=(1-t)^2c_{i,0} + 2(1-t)tc_{i,1} + t^2c_{i,2}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"nf\"\u003ePlotSingle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ec0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ec1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ec2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ec0\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ec1\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ec2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e計算スペースのときのように、プロット用のスペースも確保しておきましょう。\u003cbr\u003e\nセグメント数は非ループ時は\u003cstrong\u003e２つ\u003c/strong\u003e少なくなることに注意。\u003cbr\u003e\nユーザ制御点が２つ以下の場合の例外処理も忘れずに。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePlotSpace\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eStepPerSegment\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ePlots\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003ePlotSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eN\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eStepPerSegment\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePlots\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePlots\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eあとはプロッティングしていくだけ。\u003cbr\u003e\nベジェ曲線のちゃんとしたプロッティング手法としては、de Casteljauのアルゴリズムを使って曲率に応じて適応的に密度を変えるものが挙げられますが、ここでは面倒なので等間隔プロットとします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcPlots\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCalcSpace\u003c/span\u003e \u003cspan class=\"n\"\u003ecalcSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePlotSpace\u003c/span\u003e \u003cspan class=\"n\"\u003eplotSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eiteration\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//ベジェ制御点を計算\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcBezierControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecalcSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eiteration\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e//各セグメントについて、指定されたステップ数で分割した点を計算\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcPlots\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eplotSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcPlots\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePlotSpace\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esegCnt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003esegCnt\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enextk\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlots\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eoffset\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcPlotSingle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enextk\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enextk\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enextk\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003estepPerSegment\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elast\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSegmentCount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlots\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlots\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcPlotSingle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003elast\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003elast\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003elast\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlots\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"実行側\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A1%8C%E5%81%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実行側\u003c/h3\u003e\n\n\u003cp\u003e以上を全て\u003ccode\u003eKCurves\u003c/code\u003eクラスに実装したとして、以下のようにすれば描画用の点群を取得できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e//イテレーション回数\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eiteration\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//ループするかどうか\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//セグメントごとの分割数\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estep\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e20\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//ユーザ制御点を更新\u003c/span\u003e\n\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003einput\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"cm\"\u003e/*更新処理*/\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e//計算用空間確保（本来はキャッシュしておく）\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecSpace\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eKCurves\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCalcSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//プロット用空間確保（本来はキャッシュしておく）\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epSpace\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eKCurves\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePlotSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e//実行\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eKCurves\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCalcPlots\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eiteration\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eお疲れさまでした。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結果\u003c/h2\u003e\n\n\u003cp\u003eUnity上で、１セグメントにつき20ステップで描画してみた結果です。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/883f03eff13ee41364b90447c03aafa6d069e07a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f38613231386431372d306466622d663133652d383532392d3435663433653931626163312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F8a218d17-0dfb-f13e-8529-45f43e91bac1.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=007d5a9f4098d2d47fcdca3e53b127b8\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/8a218d17-0dfb-f13e-8529-45f43e91bac1.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F8a218d17-0dfb-f13e-8529-45f43e91bac1.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=80c23af480cf68212d3ce84f5f3b3064 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eベジェ制御点も表示してみるとこんな感じ。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/23ab07e27a969ea1c7c7c116e7dcc3167027df29/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f30633438623061632d313939662d643936362d363936382d6636333164366430346665372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F0c48b0ac-199f-d966-6968-f631d6d04fe7.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=128d68a7b09b05b6773aa82ecddf19c4\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/0c48b0ac-199f-d966-6968-f631d6d04fe7.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F0c48b0ac-199f-d966-6968-f631d6d04fe7.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1970fa1c1d84711f79611b74ee97975a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e同じ配置でループさせるとこうなります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/04ca63af4998d82fcc03a14879a7f65e481727df/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f64333362346139382d373065322d323465662d383636332d3833633161613937373261362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fd33b4a98-70e2-24ef-8663-83c1aa9772a6.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2c3d2792493c7ba9d74fcb5cf919554e\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/d33b4a98-70e2-24ef-8663-83c1aa9772a6.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fd33b4a98-70e2-24ef-8663-83c1aa9772a6.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=2444055cfacc008509e0e693094af9d2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"バグ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%90%E3%82%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eバグ？\u003c/h2\u003e\n\n\u003cp\u003eはい、まだ終わってません。\u003cbr\u003e\nここまでの実装で実際に描画してみて、ユーザ制御点をめちゃくちゃ動かしまくってみると分かりますが、\u003cstrong\u003e特定の状況下において適切な場所に収束しません\u003c/strong\u003e。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/b6c268a6e0da34568560bd7e5705d5bf5ebe2701/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f31623365643561612d343634342d343663612d663031312d3137373131643032396535312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F1b3ed5aa-4644-46ca-f011-17711d029e51.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=67b203ac214886cb328d85b85bdeb6a5\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/1b3ed5aa-4644-46ca-f011-17711d029e51.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F1b3ed5aa-4644-46ca-f011-17711d029e51.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=eb8e4c6fe6442d1647b49243410df0d9 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nなんか、飛び出しています。よく見ると接続点の傾きも不連続になっています。\u003cbr\u003e\n尖った領域かつユーザ制御点が近接している場合に起こりがちです。\u003c/p\u003e\n\n\u003cp\u003eこの問題は、実は\u003cstrong\u003e全ての条件を満たす解が存在しない場合がある\u003c/strong\u003e（＝各条件を順番に解くだけでは収束しない）ことに起因します。\u003c/p\u003e\n\n\u003cp\u003e実用上は\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eStep1の回数を抑える\u003c/li\u003e\n\u003cli\u003e最後にStep2を一度実行する\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eことで解決しますが、真の最適解に収束しているわけではないことに注意しましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eBezierControls\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalcBezierControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCalcSpace\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eiteration\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//前略\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eStep0\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eiteration\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eiteration\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eStep1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStep2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStep3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eStep4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epoints\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eStep2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003espace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e結果：\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/73055e8866fdd764cddcbbbcbf31170710208cd4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f33646337626434642d303332342d653231312d343336392d3961613637633464393562382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F3dc7bd4d-0324-e211-4369-9aa67c4d95b8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=973a5ac2cf8a4a80ccead5eb123b23e1\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/3dc7bd4d-0324-e211-4369-9aa67c4d95b8.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2F3dc7bd4d-0324-e211-4369-9aa67c4d95b8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=91c0619eda0ac4b1603c013ad8bad329 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"それでも飛び出ることはある\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%82%8C%E3%81%A7%E3%82%82%E9%A3%9B%E3%81%B3%E5%87%BA%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%82%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eそれでも飛び出ることはある\u003c/h3\u003e\n\n\u003cp\u003e具体的には、極薄極小のセグメントの存在が問題のようです。\u003cbr\u003e\n例えばこんな場合。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/056581f16479a4f284717fbecd87f3c8c1aef9b9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f38343439392f65666639656163322d643138342d316261312d313630322d6432343234343566656631632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Feff9eac2-d184-1ba1-1602-d242445fef1c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=12cabb98d477078edebf5555be37ccbf\" alt=\"新規キャンバス1.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/eff9eac2-d184-1ba1-1602-d242445fef1c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Feff9eac2-d184-1ba1-1602-d242445fef1c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0dc2f36dc2495482101d276f4f04470a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれはもう何というか、\u003cstrong\u003e曲線ツールで鋭角を描こうとしているのが悪いです。\u003c/strong\u003e\u003cbr\u003e\n超鋭角の部分を検知して、その点で切断して２つのκ-Curvesに分けるといいかもしれません。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"発展\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%99%BA%E5%B1%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e発展\u003c/h2\u003e\n\n\u003cp\u003e記事公開から１年以上経ってもまだちょくちょく通知が来るので、新しい関連情報を少し追記します。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"有理κ-curves\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%89%E7%90%86%CE%BA-curves\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e有理κ-Curves\u003c/h3\u003e\n\n\u003cp\u003e通常の二次ベジェ曲線で定義できるなら、有理二次ベジェ曲線でもできるのでは？　と考えるのが自然です。\u003cbr\u003e\nこれは同じ筆頭著者の論文\u003ca href=\"http://people.tamu.edu/%7Eyanzp/projects/ratkappa/ratk.pdf\" title=\"Circle Reproduction with Interpolatory Curves at Local Maximal Curvature Points\" rel=\"nofollow noopener\" target=\"_blank\"\u003e(Yan et al., 2019)\u003c/a\u003eで後に導入されています。\u003cbr\u003e\n有理二次ベジェ曲線は円錐曲線全体をカバーするので、正確な円を描くこともできます（なので論文タイトルがCircle Reproduction～）。\u003cbr\u003e\nまたこちらの実装では最適化を全条件をまとめた式のエネルギー最小化で定義しており、前項で挙げた不安定性への対処もされています。\u003cbr\u003e\n有理二次ベジェ曲線の（ほぼ）曲率連続な連結体なので、表現力はCAD等の用途でよく採用されるNURBS（非一様有理Bスプライン）と（ほぼ）同等と言えます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"a-class-of-c-interpolating-splines\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#a-class-of-c-interpolating-splines\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eA Class of C² Interpolating Splines\u003c/h3\u003e\n\n\u003cp\u003eSIGGRAPH2020で、全く新しいスプライン曲線のクラスが提示されました。\u003ca href=\"http://www.cemyuksel.com/research/interpolating_splines/a_class_of_c2_interpolating_splines.pdf\" title=\"A Class of C² Interpolating Splines\" rel=\"nofollow noopener\" target=\"_blank\"\u003e(Cem Yuksel, 2020)\u003c/a\u003e\u003cbr\u003e\nざっくりまとめると、隣接する３制御点$P_{i-1},P_{i},P_{i+1}$を繋ぐ曲線$F_i$を三角関数を使ってブレンドすることで、$F_i$によらず「至る所$C^2$連続かつ全ての制御点を通る」ことが保証された曲線を出力するものです。\u003c/p\u003e\n\n\u003cp\u003e$F_i$を適切に選ぶことで、曲率極大点を制御点に\u003cstrong\u003e近づける\u003c/strong\u003eこともできます（一致させるのは相当難しく、もしできたら論文が一本書けると思います）。\u003cbr\u003e\n$F_i$としてκ-Curvesを用いるのが好例で、論文中でも紹介されています。\u003c/p\u003e\n\n\u003cp\u003eYukselさんはこのクラスに特に名前をつけてくれておらず、論文等で引用する時に取り回しづらいのがちょっと難点。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"使用上の注意\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%BF%E7%94%A8%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e使用上の注意\u003c/h1\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003ca href=\"https://patents.google.com/patent/US9501848B2\" title=\"Fitting a parametric curve using maximum curvature\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAdobeが特許を取っているので、無断の商用利用はNGです。\u003c/a\u003e\u003c/strong\u003e\u003cbr\u003e\n何かに使う場合、特許権侵害にあたらないかは確認しておきましょう。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おわりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおわりに\u003c/h1\u003e\n\n\u003cp\u003eκ-Curvesの実装は、大学で出た発展課題の一つでした。\u003cbr\u003e\nそこで存在を知ったわけですが、非常に便利なので趣味のゲーム開発（非営利）にも流用しています。\u003cbr\u003e\n修論のテーマにも影響したりと、個人的になかなか深く関わることになった曲線でした。\u003cbr\u003e\n\u003cfont color=\"silver\"\u003e\u003csub\u003eなお同じ講義を受けてググってこの記事に辿り着いた各位へ、脳死コピペはやめましょう。私はその講義の元TAです。\u003c/sub\u003e\u003c/font\u003e\u003c/p\u003e\n\n\u003cp\u003eパラメトリック曲線界隈、最近ちょっと活発になった気がします。この間の\u003ca href=\"https://cgvi.jp/vc2020/program/oral/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eVisual Computing 2020\u003c/a\u003eでもκ-Curves派生の新しいアイデアが発表されていましたね。\u003cbr\u003e\n興味のある方は研究テーマにしてみてはいかがでしょうか。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"付録\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BB%98%E9%8C%B2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e付録\u003c/h1\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"三重対角行列のlu分解\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%89%E9%87%8D%E5%AF%BE%E8%A7%92%E8%A1%8C%E5%88%97%E3%81%AElu%E5%88%86%E8%A7%A3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e三重対角行列のLU分解\u003c/h3\u003e\n\n\u003cp\u003eまずLU分解とは、正方行列を下三角行列$L$と上三角行列$U$の積に分解する操作です。\u003cbr\u003e\n$Ax=b$という連立方程式があるとき、$A=LU$とLU分解することで、$Ly=b$と$Ux=y$という２つの連立方程式に分離することができます。\u003cbr\u003e\n三角行列の連立方程式は簡単に$O(n^2)$で解ける（前進代入・後退代入）ので、$A$がLU分解されていれば、ガウスの消去法を使った$O(n^3)$の解法より速くなります。\u003cbr\u003e\n一般のLU分解は$O(n^3)$かかってしまうので、これは同じAを何度も利用する際にのみ有効な手段ですが、\u003cbr\u003e\n$A$が\u003cstrong\u003e三重対角行列\u003c/strong\u003eの場合、\u003cstrong\u003eLU分解もその後の計算も全て$O(n)$になります。\u003c/strong\u003e \u003c/p\u003e\n\n\u003cp\u003e$L$の対角成分を1に固定しましょう。このとき、三重対角行列のLU分解$A=LU$の最初の様子は以下のように表せます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left(\\begin{matrix}\na_{11}\u0026amp;a_{12}\u0026amp;\u0026amp;O\\\\\na_{21}\u0026amp;\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;A'\u0026amp;\\\\\nO\u0026amp;\u0026amp;\u0026amp;\n\\end{matrix}\\right)\n=\n\n\\left(\\begin{matrix}\n1\u0026amp;\u0026amp;\u0026amp;O\\\\\nl_{21}\u0026amp;\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;L'\u0026amp;\\\\\nO\u0026amp;\u0026amp;\u0026amp;\n\\end{matrix}\\right)\n\n\\left(\\begin{matrix}\nu_{11}\u0026amp;u_{12}\u0026amp;\u0026amp;O\\\\\n\u0026amp;\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;U'\u0026amp;\\\\\nO\u0026amp;\u0026amp;\u0026amp;\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e成分を比較すると、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\na_{11}\u0026amp;=u_{11}\\\\\na_{12}\u0026amp;=u_{12}\\\\\na_{21}\u0026amp;=u_{11}l_{21}\\\\\nA'\u0026amp;=L'U'+\\left(\\begin{matrix}\nl_{21}u_{12}\u0026amp;\\\\\n\u0026amp;O\n\\end{matrix}\\right)\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなので、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\nu_{11}\u0026amp;=a_{11}\\\\\nu_{12}\u0026amp;=a_{12}\\\\\nl_{21}\u0026amp;=\\frac{a_{21}}{a_{11}}\\\\\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとして\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eA'-\\left(\\begin{matrix}\nl_{21}u_{12}\u0026amp;\\\\\n\u0026amp;O\n\\end{matrix}\\right)=L'U'\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eを再帰的にLU分解していけばよいことが分かります。\u003cbr\u003e\n$O(1)$の$n$回ループなので$O(n)$です。\u003c/p\u003e\n\n\u003cp\u003eこの計算では分解し終わった部分が後で必要になることはなく、さらに$L$の対角成分は全て1なので、$L$と$U$を重ね合わせることで$A$のメモリのみを使って分解できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left(\\begin{matrix}\na_{11}\u0026amp;a_{12}\u0026amp;\u0026amp;O\\\\\na_{21}\u0026amp;a_{22}\u0026amp;a_{23}\u0026amp;\\\\\n\u0026amp;a_{32}\u0026amp;\\ddots\u0026amp;\\\\\nO\u0026amp;\u0026amp;\u0026amp;\n\\end{matrix}\\right)\n\\rightarrow\n\n\\left(\\begin{matrix}\nu_{11}\u0026amp;u_{12}\u0026amp;\u0026amp;O\\\\\nl_{21}\u0026amp;u_{22}\u0026amp;u_{23}\u0026amp;\\\\\n\u0026amp;l_{32}\u0026amp;\\ddots\u0026amp;\\\\\nO\u0026amp;\u0026amp;\u0026amp;\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e元が三重対角行列なので、$L,U$は共に各行２つ以下の要素しか持ちません。\u003cbr\u003e\nそのため、前進代入・後退代入の計算量も$O(n)$となります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"角つき三重対角行列のlu分解\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A7%92%E3%81%A4%E3%81%8D%E4%B8%89%E9%87%8D%E5%AF%BE%E8%A7%92%E8%A1%8C%E5%88%97%E3%81%AElu%E5%88%86%E8%A7%A3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e角つき三重対角行列のLU分解\u003c/h3\u003e\n\n\u003cp\u003e右上と左下に角がついている場合（行列サイズを拡張しない場合）も、少し複雑にはなりますが$O(n)$で分解できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left(\\begin{matrix}\na_{11}\u0026amp;a_{12}\u0026amp;O\u0026amp;a_{1n}\\\\\na_{21}\u0026amp;\u0026amp;\u0026amp;\\\\\nO\u0026amp;\u0026amp;A'\u0026amp;\\\\\na_{n1}\u0026amp;\u0026amp;\u0026amp;\n\\end{matrix}\\right)\n=\n\n\\left(\\begin{matrix}\n1\u0026amp;\u0026amp;\u0026amp;O\\\\\nl_{21}\u0026amp;\u0026amp;\u0026amp;\\\\\nO\u0026amp;\u0026amp;L'\u0026amp;\\\\\nl_{n1}\u0026amp;\u0026amp;\u0026amp;\n\\end{matrix}\\right)\n\n\\left(\\begin{matrix}\nu_{11}\u0026amp;u_{12}\u0026amp;O\u0026amp;u_{1n}\\\\\n\u0026amp;\u0026amp;\u0026amp;\\\\\n\u0026amp;\u0026amp;U'\u0026amp;\\\\\nO\u0026amp;\u0026amp;\u0026amp;\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e成分を比較すると、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\begin{align}\nu_{11}\u0026amp;=a_{11}\\\\\nu_{12}\u0026amp;=a_{12}\\\\\nl_{21}\u0026amp;=\\frac{a_{21}}{a_{11}}\\\\\nu_{1n}\u0026amp;=a_{1n}\\\\\nl_{n1}\u0026amp;=\\frac{a_{n1}}{a_{11}}\\\\\n\\end{align}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなので、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eA'-\\left(\\begin{matrix}\n\\displaystyle\\frac{a_{21}a_{12}}{a_{11}}\u0026amp;O\u0026amp;\\displaystyle\\frac{a_{21}a_{1n}}{a_{11}}\\\\\nO\u0026amp;O\u0026amp;O\\\\\n\\displaystyle\\frac{a_{n1}a_{12}}{a_{11}}\u0026amp;O\u0026amp;\\displaystyle\\frac{a_{n1}a_{1n}}{a_{11}}\\\\\n\\end{matrix}\\right)=L'U'\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eとなり、再帰的に分解できます。\u003cbr\u003e\nただし、$A'$のサイズが1のときはこの四隅は同じ位置を指すので、重複して引いてしまわないよう注意が必要です。\u003c/p\u003e\n\n\u003cp\u003eまた、前進代入・後退代入も変わらず$O(n)$ではありますが、$L$は最下一行、$U$は最右一列が追加で埋まっています。\u003cbr\u003e\n$L$も$U$も左からかけるので、この追加行・列の扱いは非対称的です。\u003cbr\u003e\n$4\\times 4$行列くらいの具体例で実際に手を動かしてみると実感できると思います。\u003c/p\u003e\n\n\u003cp\u003e具体例：\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left(\\begin{matrix}\n2\u0026amp;0\u0026amp;0\u0026amp;2\\\\\n0\u0026amp;1\u0026amp;1\u0026amp;0\\\\\n0\u0026amp;2\u0026amp;4\u0026amp;2\\\\\n4\u0026amp;0\u0026amp;4\u0026amp;9\\\\\n\\end{matrix}\\right)\n\\left(\\begin{matrix}\n1\\\\\n2\\\\\n3\\\\\n4\\\\\n\\end{matrix}\\right)\n=\n\\left(\\begin{matrix}\n10\\\\\n5\\\\\n24\\\\\n52\\\\\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"math\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\\left(\\begin{matrix}\n2\u0026amp;0\u0026amp;0\u0026amp;2\\\\\n0\u0026amp;1\u0026amp;1\u0026amp;0\\\\\n0\u0026amp;2\u0026amp;4\u0026amp;2\\\\\n4\u0026amp;0\u0026amp;4\u0026amp;9\\\\\n\\end{matrix}\\right)\n=\n\\left(\\begin{matrix}\n1\u0026amp;0\u0026amp;0\u0026amp;0\\\\\n0\u0026amp;1\u0026amp;0\u0026amp;0\\\\\n0\u0026amp;2\u0026amp;1\u0026amp;0\\\\\n2\u0026amp;0\u0026amp;2\u0026amp;1\\\\\n\\end{matrix}\\right)\n\\left(\\begin{matrix}\n2\u0026amp;0\u0026amp;0\u0026amp;2\\\\\n0\u0026amp;1\u0026amp;1\u0026amp;0\\\\\n0\u0026amp;0\u0026amp;2\u0026amp;2\\\\\n0\u0026amp;0\u0026amp;0\u0026amp;1\\\\\n\\end{matrix}\\right)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなお、一般の場合のLU分解や前進代入・後退代入については\u003ca href=\"http://slis.tsukuba.ac.jp/%7Efujisawa.makoto.fu/cgi-bin/wiki/index.php?LU%CA%AC%B2%F2\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこちらのページ\u003c/a\u003eなどに詳しく載っています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"参考パフォーマンス計測結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E8%A8%88%E6%B8%AC%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e（参考）パフォーマンス計測結果\u003c/h3\u003e\n\n\u003cp\u003e私の環境でのパフォーマンス計測結果です。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003en\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003eiteration\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003etime(ms)\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e30\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e5\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e0.1232\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e15\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e10\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e0.1177\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e30\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e10\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e0.2296\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e60\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e10\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e0.4564\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e120\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e10\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e0.9101\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e1000\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e10\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e7.516\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e環境\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eOS\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eWindows10 Home\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eCPU\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eIntel Core i7-8700\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eRAM\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e16GB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eGPU\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eNVIDIA GeForce GTX 970\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eその他\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eUnity2019.3.0f6上で実行\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e時間は10000回の平均値（四捨五入）で、\u003ccode\u003eCalcBezierControls()\u003c/code\u003eの時間のみを計測しています。\u003c/p\u003e\n\n\u003cp\u003eはい。$O(n\\times \\rm{iteration})$です。イテレーションは実用上は5～10回くらいで充分なので、C#実装でこれならそこそこ実用的な速度が出るかなと。\u003c/p\u003e\n\n\u003cp\u003e一応計測用コード（要Unity）：\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eMenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Tools/Test\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e30\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e10000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eRandom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRandom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecSpace\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eKCurves\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCalcSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartNew\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eKCurves\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCalcBezierControls\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eiter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003edouble\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsedTicks\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDiagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrequency\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e1000.0\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"参考文献\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考文献\u003c/h1\u003e\n\n\u003cp\u003e元論文\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eZhipei Yan, Stephen Schiller, Gregg Wilensky, Nathan Carr, and Scott Schaefer.\u003cbr\u003e\nκ-curves: Interpolation at local maximum curvature.\u003cbr\u003e\nACM Transactions on Graphics, 36(4):129:1–129:7, 2017.\u003cbr\u003e\n\u003ca href=\"http://people.tamu.edu/~yanzp/projects/kCurves/kCurves.pdf\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://people.tamu.edu/~yanzp/projects/kCurves/kCurves.pdf\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e特許（Google Patents）\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eFitting a parametric curve using maximum curvature\u003cbr\u003e\n\u003ca href=\"https://patents.google.com/patent/US9501848B2\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://patents.google.com/patent/US9501848B2\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e関連\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eZhipei Yan, Stephen Schiller, and Scott Schaefer.\u003cbr\u003e\nCircle reproduction with interpolatory curves at local maximal curvature points.\u003cbr\u003e\nComputer Aided Geometric Design, 72:98 – 110, 2019.\u003cbr\u003e\n\u003ca href=\"http://people.tamu.edu/~yanzp/projects/ratkappa/ratk.pdf\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://people.tamu.edu/~yanzp/projects/ratkappa/ratk.pdf\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eCem Yuksel. \u003cbr\u003e\nA class of c2 interpolating splines. \u003cbr\u003e\nACM Transactions on Graphics, 39(5):160:1–160:14, jul 2020.\u003cbr\u003e\n\u003ca href=\"http://www.cemyuksel.com/research/interpolating_splines/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://www.cemyuksel.com/research/interpolating_splines/\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eわかりやすいNURBS解説\u003cbr\u003e\n\u003ca href=\"https://www.unisys.co.jp/tec_info/tr114/11403.pdf\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.unisys.co.jp/tec_info/tr114/11403.pdf\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eSolving Cubic Equations\u003cbr\u003e\n\u003ca href=\"http://www.1728.org/cubic2.htm\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://www.1728.org/cubic2.htm\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\n\u003cli id=\"fn1\"\u003e\n\u003cp\u003e3D曲線の場合、曲率は絶対値を取って扱うことが多いようです。2D曲線でも絶対値つきで定義されていることがあるかもしれませんが、ここではκ-Curvesの論文に倣って符号付きとします。 \u003ca href=\"#fnref1\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003c/ol\u003e\n\u003c/div\u003e\n","createdAt":"2020-02-04T04:19:44Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"outxCZJO7XuN6Msvrkjn/AmpOIkPMVSyOQ==--tGps5hmaWL1q5kfU--r6HpY9O3ZAXhF448luef9g==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-04-09T12:31:32Z","likesCount":285,"linkUrl":"https://qiita.com/Rijicho_nl/items/05ee4c8d77e99e29daa5","organization":null,"originalId":1152820,"stockedCount":252,"title":"UX最強のベジェ曲線「κ-Curves」を完全に理解する","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#tldr\"\u003eTL;DR\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%A2\"\u003eデモ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BA%8B%E5%89%8D%E7%9F%A5%E8%AD%98\"\u003e事前知識\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E6%9B%B2%E7%B7%9A\"\u003eパラメトリック曲線\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9B%B2%E7%8E%87\"\u003e曲率\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%99%E3%82%B8%E3%82%A7%E6%9B%B2%E7%B7%9A\"\u003eベジェ曲線\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A1%A8%E5%BC%8F\"\u003e表式\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9B%B2%E7%8E%87-1\"\u003e曲率\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9B%B2%E7%8E%87%E6%A5%B5%E5%A4%A7%E7%82%B9\"\u003e曲率極大点\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%CE%BA-curves\"\u003eκ-Curves\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%B6%E7%B4%84%EF%BC%91%E3%83%A6%E3%83%BC%E3%82%B6%E5%88%B6%E5%BE%A1%E7%82%B9%E3%81%A7%E6%A5%B5%E5%A4%A7%E6%9B%B2%E7%8E%87\"\u003e制約１：ユーザ制御点で極大曲率\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B6%BA%E9%BA%97%E3%81%AB%E3%81%99%E3%82%8B\"\u003e綺麗にする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A7%A3%E3%81%AE%E7%AF%84%E5%9B%B2%E3%81%A8%E5%80%8B%E6%95%B0\"\u003e実解の範囲と個数\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%B6%E7%B4%84%EF%BC%92c%E9%80%A3%E7%B6%9A\"\u003e制約２：C⁰連続\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%B6%E7%B4%84%EF%BC%93g%E9%80%A3%E7%B6%9A\"\u003e制約３：G¹連続\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%A6%E3%83%BC%E3%82%B6%E5%88%B6%E5%BE%A1%E7%82%B9%E4%BD%8D%E7%BD%AE%E3%81%AE%E5%88%A5%E8%A1%A8%E7%A4%BA\"\u003eユーザ制御点位置の別表示\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%B6%E7%B4%84%EF%BC%94%E3%81%BB%E3%81%BCg%E9%80%A3%E7%B6%9A\"\u003e制約４：ほぼG²連続\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%B6%E7%B4%84%E3%81%BE%E3%81%A8%E3%82%81\"\u003e制約まとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0\"\u003eアルゴリズム\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e概要\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step0-%E5%88%9D%E6%9C%9F%E5%8C%96\"\u003eStep0. 初期化\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step1-%CE%BB%E3%81%AE%E7%AE%97%E5%87%BA\"\u003eStep1. λの算出\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step2-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%A1%E7%AB%AF%E3%81%AE%E6%9B%B4%E6%96%B0\"\u003eStep2. ベジェ制御点（両端）の更新\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step3-%E6%9B%B2%E7%8E%87%E6%A5%B5%E5%A4%A7%E7%82%B9%E3%81%AE%E7%AE%97%E5%87%BA\"\u003eStep3. 曲率極大点の算出\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step4-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%AD%E5%A4%AE%E3%81%AE%E6%9B%B4%E6%96%B0\"\u003eStep4. ベジェ制御点（中央）の更新\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E7%94%A8%E6%A7%8B%E9%80%A0%E4%BD%93\"\u003eベジェ制御点用構造体\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A8%88%E7%AE%97%E7%A9%BA%E9%96%93%E3%81%AE%E7%A2%BA%E4%BF%9D\"\u003e計算空間の確保\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%A6%E3%83%BC%E3%82%B6%E5%88%B6%E5%BE%A1%E7%82%B9%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E3%81%AE%E4%B8%8A%E4%B8%8B%E6%8B%A1%E5%BC%B5\"\u003eユーザ制御点・ベジェ制御点の上下拡張\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%83%AB%E3%83%BC%E3%83%88\"\u003eメソッドルート\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step0-%E5%88%9D%E6%9C%9F%E5%8C%96-1\"\u003eStep0: 初期化\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step1-%CE%BB%E3%81%AE%E7%AE%97%E5%87%BA-1\"\u003eStep1: λの算出\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step2-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%A1%E7%AB%AF%E3%81%AE%E6%9B%B4%E6%96%B0-1\"\u003eStep2: ベジェ制御点（両端）の更新\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step3-%E6%9B%B2%E7%8E%87%E6%A5%B5%E5%A4%A7%E7%82%B9%E3%81%AE%E7%AE%97%E5%87%BA-1\"\u003eStep3: 曲率極大点の算出\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#step4-%E3%83%99%E3%82%B8%E3%82%A7%E5%88%B6%E5%BE%A1%E7%82%B9%E4%B8%AD%E5%A4%AE%E3%81%AE%E6%9B%B4%E6%96%B0-1\"\u003eStep4: ベジェ制御点（中央）の更新\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%97%E3%83%AD%E3%83%83%E3%83%88\"\u003eプロット\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A1%8C%E5%81%B4\"\u003e実行側\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E6%9E%9C\"\u003e結果\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%90%E3%82%B0\"\u003eバグ？\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%82%8C%E3%81%A7%E3%82%82%E9%A3%9B%E3%81%B3%E5%87%BA%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AF%E3%81%82%E3%82%8B\"\u003eそれでも飛び出ることはある\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%99%BA%E5%B1%95\"\u003e発展\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%89%E7%90%86%CE%BA-curves\"\u003e有理κ-Curves\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#a-class-of-c-interpolating-splines\"\u003eA Class of C² Interpolating Splines\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%BF%E7%94%A8%E4%B8%8A%E3%81%AE%E6%B3%A8%E6%84%8F\"\u003e使用上の注意\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003eおわりに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BB%98%E9%8C%B2\"\u003e付録\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%89%E9%87%8D%E5%AF%BE%E8%A7%92%E8%A1%8C%E5%88%97%E3%81%AElu%E5%88%86%E8%A7%A3\"\u003e三重対角行列のLU分解\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A7%92%E3%81%A4%E3%81%8D%E4%B8%89%E9%87%8D%E5%AF%BE%E8%A7%92%E8%A1%8C%E5%88%97%E3%81%AElu%E5%88%86%E8%A7%A3\"\u003e角つき三重対角行列のLU分解\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E8%A8%88%E6%B8%AC%E7%B5%90%E6%9E%9C\"\u003e（参考）パフォーマンス計測結果\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\"\u003e参考文献\u003c/a\u003e\n\u003c/li\u003e\n\n","totalPv":18564,"uuid":"05ee4c8d77e99e29daa5","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"RKvF9qe+HFZnfk/Sdaxgs41J6Fs=--zrLpeCaOYJAa8/A0--HzK72msXnFWGqzk/DEmuow==","originalId":84499,"description":"東大の同人ゲーム制作サークル「ノンリニア」のプログラマ、絵師、シナリオライター。Unity界隈。","facebookUrl":null,"githubUrl":"https://github.com/Rijicho","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"りじちょー","profileImageUrl":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/84499/profile-images/1582773093","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fprofile-images%2F1582773093?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=f0379a07e8656506e70700d0ec747eb2","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F84499%2Fprofile-images%2F1582773093?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=10e5976ac4859ffb5f42ce8b7365e3be","urlName":"Rijicho_nl","websiteUrl":"","twitterUrl":"https://twitter.com/Rijicho_nl","twitterUrlName":"Rijicho_nl","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"},{"name":"ベジェ曲線","urlName":"%e3%83%99%e3%82%b8%e3%82%a7%e6%9b%b2%e7%b7%9a"},{"name":"SIGGRAPH","urlName":"siggraph"},{"name":"曲線","urlName":"%e6%9b%b2%e7%b7%9a"}],"followingLikers":{"edges":[]},"comments":{"totalCount":1}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
