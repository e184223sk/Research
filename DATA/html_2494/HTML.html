<!DOCTYPE html><html><head><meta charset="utf-8" /><title>設計要件をギッチギチに詰めたValueObjectで低凝集クラスを爆殺する - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/MinoDriven/items/5e69d9bd028aa350e2c4" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="A/XIkglWcHSNgeoxgtrZRktardlloqmiv9vGi+j2QMci8wgJclTrVTUdDcHYynP0LcEwNoWxYXjqlPABinADsA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@MinoDriven" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="設計要件をギッチギチに詰めたValueObjectで低凝集クラスを爆殺する - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND02S2l0NktpSTZLYUI1THUyNDRLUzQ0S3U0NE9ENDRPQjQ0S3U0NE9CNDRHcjZLbXc0NEtCNDRHZlZtRnNkV1ZQWW1wbFkzVGpnYWZrdlk3bGg1M3BtNGJqZ3Ffamc2bmpncm5qZ3BMbmlJYm1ycnJqZ1puamdvcyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz00NWNjNDc3NzBkNDU3ZjM2NjIwOTEzY2RlNDZiMzg4MA&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRTFwYm05RWNtbDJaVzQmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1mMmRmYjJkM2Y2YWY3Zjc1MDM2Nzk0OTMyOTYzZDdjZA&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=672a7b33c897cc1c1d3c6f8331c8c7bd"><meta property="og:description" content="

概要

関連のあるロジックが膨大なソースコードの中のあちこちに書き殴られ、散在し、追うのが大変な低凝集クラス。別名「スパゲッティコード」とも呼ばれ、無関係なロジックと絡み合い、変更を難しくしているアイツ。
そんな低凝集クラスの退治..."><meta content="https://qiita.com/MinoDriven/items/5e69d9bd028aa350e2c4" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,DDD,設計" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-9d1ed45a-b253-4c39-8977-dc128229586b"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FMinoDriven%2Fitems%2F5e69d9bd028aa350e2c4">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FMinoDriven%2Fitems%2F5e69d9bd028aa350e2c4">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-9d1ed45a-b253-4c39-8977-dc128229586b">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-11-05T07:38:26.000+09:00","dateModified":"2019-11-10T12:55:59.000+09:00","headline":"設計要件をギッチギチに詰めたValueObjectで低凝集クラスを爆殺する","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND02S2l0NktpSTZLYUI1THUyNDRLUzQ0S3U0NE9ENDRPQjQ0S3U0NE9CNDRHcjZLbXc0NEtCNDRHZlZtRnNkV1ZQWW1wbFkzVGpnYWZrdlk3bGg1M3BtNGJqZ3Ffamc2bmpncm5qZ3BMbmlJYm1ycnJqZ1puamdvcyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz00NWNjNDc3NzBkNDU3ZjM2NjIwOTEzY2RlNDZiMzg4MA\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRTFwYm05RWNtbDJaVzQmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1mMmRmYjJkM2Y2YWY3Zjc1MDM2Nzk0OTMyOTYzZDdjZA\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=672a7b33c897cc1c1d3c6f8331c8c7bd","mainEntityOfPage":"https://qiita.com/MinoDriven/items/5e69d9bd028aa350e2c4","author":{"@type":"Person","address":"","email":null,"identifier":"MinoDriven","name":"MinoDriven","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fprofile-images%2F1603102722?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=2768d24ca9e90f76b07881585cbc4dd5","url":"https://qiita.com/MinoDriven","description":"","memberOf":[{"@type":"Organization","address":"","legalName":"READYFOR株式会社","image":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/cb8c2147b444429c5850909f7a2d4b0f41d2fbae/original.jpg?1594792177","logo":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/a19a7aa0751aa585fcf71c2ae33b01dc8cbbdcda/original.jpg?1594792177","identifier":"readyfor","description":"想いをつなぎ、叶える未来を、つくる\r\nREADYFORのOrganizationです"}]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">CTO業務を積極的に権限移譲するユーザベースの開発組織とは</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"MinoDriven","type":"items","id":"5e69d9bd028aa350e2c4"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"MinoDriven","type":"items","id":"5e69d9bd028aa350e2c4"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"MinoDriven","type":"items","id":"5e69d9bd028aa350e2c4"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"CTO業務を積極的に権限移譲するユーザベースの開発組織とは","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/MinoDriven/items/5e69d9bd028aa350e2c4","location":"/MinoDriven/items/5e69d9bd028aa350e2c4","scheme":"https","host":"qiita.com","port":null,"pathname":"/MinoDriven/items/5e69d9bd028aa350e2c4","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"UFSV5Q38X0pvTwwzCCKpqnijaZAs0NS6GTUV/9O3G25xUlV+dv7Ea9fT68NSMgMYHjj0f8zDHGBMeiN1sTFYGQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-3c72a3ed-eac1-4a91-9743-98cbdfd6a0a3"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/MinoDriven/items/5e69d9bd028aa350e2c4/likers" class="css-1iupg5d">1022</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">847</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/5e69d9bd028aa350e2c4/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/MinoDriven/items/5e69d9bd028aa350e2c4/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/MinoDriven/items/5e69d9bd028aa350e2c4/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/MinoDriven/items/5e69d9bd028aa350e2c4/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/MinoDriven/items/5e69d9bd028aa350e2c4.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/MinoDriven"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/profile-images/1603102722" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/MinoDriven" class="css-10ougpm">@<!-- -->MinoDriven</a><div class="css-1ay9vb9"><span><meta content="2019-11-04T22:38:26Z"/><time dateTime="2019-11-10T03:55:59Z" class="css-m19uds">updated at 2019-11-10</time></span></div></div></div></div></div><h1 class="css-cgzq40">設計要件をギッチギチに詰めたValueObjectで低凝集クラスを爆殺する</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/ddd" class="css-4czcte">DDD</a><a href="/tags/%e8%a8%ad%e8%a8%88" class="css-4czcte">設計</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p>関連のあるロジックが膨大なソースコードの中のあちこちに書き殴られ、散在し、追うのが大変な低凝集クラス。別名「スパゲッティコード」とも呼ばれ、無関係なロジックと絡み合い、変更を難しくしているアイツ。<br>
そんな低凝集クラスの退治に有効な設計手法を紹介致します。</p>

<p>本記事の内容は <strong>ValueObject</strong> パターンと <strong>完全コンストラクタ</strong> パターンを用いた品質向上の設計手法です。低凝集に徹底対抗するため、<strong>かなりギッチギチに設計要件を詰め込んでいます。</strong></p>

<h1>
<span id="本設計手法による効果" class="fragment"></span><a href="#%E6%9C%AC%E8%A8%AD%E8%A8%88%E6%89%8B%E6%B3%95%E3%81%AB%E3%82%88%E3%82%8B%E5%8A%B9%E6%9E%9C"><i class="fa fa-link"></i></a>本設計手法による効果</h1>

<ul>
<li>生産性向上</li>
<li>修正漏れ低減</li>
<li>クローンコード低減</li>
<li>未初期化状態の防止</li>
<li>不正値の防止</li>
<li>異なる概念の値混入抑止</li>
<li>インスタンス生成の安全性向上</li>
<li>リスト操作に関する複雑度低減</li>
<li>理解容易性向上</li>
<li>コードのトレーサビリティ向上</li>
</ul>

<h1>
<span id="よくあるダメな例" class="fragment"></span><a href="#%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E3%83%80%E3%83%A1%E3%81%AA%E4%BE%8B"><i class="fa fa-link"></i></a>よくあるダメな例</h1>

<p>まずはValueObjectを用いていない、架空のコードを例に説明致します。<br>
ここではなるべく分かりやすいように、今ホットな消費税を例にします。</p>

<p>税込み金額と消費税率を単に格納するだけの契約金額クラスがあったとします。<br>
<strong>(※以下サンプルコードはC#にて記述)</strong></p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">ContractAmount.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;契約金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ContractAmount</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">AmountIncludingTax</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">decimal</span> <span class="n">SalesTaxRate</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>当然データの入れ物(以後<strong>データクラス</strong>と呼称)だけでなく、税込み金額を計算するロジックが必要です。ここであまり設計を考えないと、この手の演算ロジックはデータクラスとは別のクラスに実装されることが多いです。以下のようにControllerに実装されることが多いのではないでしょうか。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">ContractController.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;契約コントローラー&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ContractController</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">ContractAmount</span> <span class="n">_contractAmount</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;税込金額を計算する。&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="amountExcludingTax"&gt;税別金額。&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="salesTaxRate"&gt;消費税率。&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;税込金額。&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="nf">CalculateAmountIncludingTax</span><span class="p">(</span><span class="kt">int</span> <span class="n">amountExcludingTax</span><span class="p">,</span> <span class="kt">decimal</span> <span class="n">salesTaxRate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">amountExcludingTax</span> <span class="p">*</span> <span class="p">(</span><span class="m">1.0</span><span class="n">m</span> <span class="p">+</span> <span class="n">salesTaxRate</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;契約締結する。&lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Conclude</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 省略</span>
        <span class="kt">int</span> <span class="n">amountIncludingTax</span> <span class="p">=</span> <span class="nf">CalculateAmountIncludingTax</span><span class="p">(</span><span class="n">amountExcludingTax</span><span class="p">,</span> <span class="n">salesTaxRate</span><span class="p">);</span>
        <span class="n">_contractAmount</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ContractAmount</span><span class="p">();</span>
        <span class="n">_contractAmount</span><span class="p">.</span><span class="n">AmountIncludingTax</span> <span class="p">=</span> <span class="n">amountIncludingTax</span><span class="p">;</span>
        <span class="n">_contractAmount</span><span class="p">.</span><span class="n">SalesTaxRate</span> <span class="p">=</span> <span class="n">salesTaxRate</span><span class="p">;</span>
        <span class="c1">// 省略</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>クラス図にすると以下の関係となります。</p>

<p><a href="https://camo.qiitausercontent.com/63159b5dd3ceb6f86d202bd3880b063bc4cceb23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f37653862356530652d663631362d366136302d626135362d6464363161363732363532382e706e67" target="_blank" rel="nofollow noopener"><img width="200" alt="tax_uml_01.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F7e8b5e0e-f616-6a60-ba56-dd61a6726528.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f61957d14cdfcc986f6d736c6a1876a5" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/7e8b5e0e-f616-6a60-ba56-dd61a6726528.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F7e8b5e0e-f616-6a60-ba56-dd61a6726528.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=bc389ef9b4d06e6f30becb4ba7d3a28c 1x" loading="lazy"></a></p>

<p>ごく小規模なアプリであれば、この設計は特に問題にはならないでしょう。しかし大規模になるにつれ、この設計は様々な問題をはらむようになってきます。<br>
どんな問題が起こるのか順番に見ていきましょう。</p>

<h1>
<span id="課題" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a>課題</h1>

<h2>
<span id="課題1低凝集" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C1%E4%BD%8E%E5%87%9D%E9%9B%86"><i class="fa fa-link"></i></a>課題1：低凝集</h2>

<p>アプリが大きくなってきても、相変わらずデータを保持する場所(データクラス)とデータを操作するロジックを別々箇所に実装しているとどうなるでしょうか。<br>
例えば下記クラス図のように、消費税関連の演算メソッドが様々なContollerに定義されている場合はどうでしょう。</p>

<p><a href="https://camo.qiitausercontent.com/ebba3846361bb53bb66dfbfb6a72f53bcd813e1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f66336331323562342d323164362d666463332d376530352d6132363933313236393132382e706e67" target="_blank" rel="nofollow noopener"><img width="526" alt="tax_uml_02.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Ff3c125b4-21d6-fdc3-7e05-a26931269128.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7cb50d5837dfca6b71c4b40555d7efbd" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/f3c125b4-21d6-fdc3-7e05-a26931269128.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Ff3c125b4-21d6-fdc3-7e05-a26931269128.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5ac9a690d88df8d07baf69075ae6f507 1x" loading="lazy"></a></p>

<p>消費税関連のロジックが様々な箇所に分散してしまっていますね。<br>
このように関連するデータやロジック同士が分散してしまっているのを <strong>低凝集</strong> と言います。低凝集なコードではどんな課題が発生するのか以下に列挙します。</p>

<h3>
<span id="課題1-1生産性低下" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C1-1%E7%94%9F%E7%94%A3%E6%80%A7%E4%BD%8E%E4%B8%8B"><i class="fa fa-link"></i></a>課題1-1：生産性低下</h3>

<p>上図はまだなんとか関連を把握できますが、これが何千何万行のソースコードに分散すると、全て探し出すだけで一苦労で、時間と精神力をいたずらに消耗することになります。</p>

<h3>
<span id="課題1-2修正漏れ" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C1-2%E4%BF%AE%E6%AD%A3%E6%BC%8F%E3%82%8C"><i class="fa fa-link"></i></a>課題1-2：修正漏れ</h3>

<p>また、関連コードを全て探し出せるとは限りません。漏れが生じる可能性もあります。仮に洗い出しに漏れが生じると、消費税関連のバグが発生します。</p>

<h3>
<span id="課題1-3コードクローンコピペコード" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C1-3%E3%82%B3%E3%83%BC%E3%83%89%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%B3%E3%82%B3%E3%83%94%E3%83%9A%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>課題1-3：コードクローン（コピペコード）</h3>

<p>あらゆる箇所に分散していると把握が困難になります。例えば既に実装済みの機能があるのに、別の開発メンバに「この機能は未実装だ」と誤解される恐れがあり、同じようなロジックが至るところに複数実装されることになります。意図せずコードクローンが量産されることになります。</p>

<h2>
<span id="課題2不正状態" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C2%E4%B8%8D%E6%AD%A3%E7%8A%B6%E6%85%8B"><i class="fa fa-link"></i></a>課題2：不正状態</h2>

<p>課題1で挙げた低凝集に付随して、データクラス<code>ContractAmount</code>は以下に示す不正状態へ陥る可能性があります。</p>

<h3>
<span id="課題2-1未初期化状態生焼けオブジェクト" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C2-1%E6%9C%AA%E5%88%9D%E6%9C%9F%E5%8C%96%E7%8A%B6%E6%85%8B%E7%94%9F%E7%84%BC%E3%81%91%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88"><i class="fa fa-link"></i></a>課題2-1：未初期化状態（生焼けオブジェクト）</h3>

<p><code>ContractAmount</code>クラスは、newされた直後はインスタンス変数の初期化が済んでいません。<code>ContractController</code>で<code>Conclude()</code>が実行されるまでは不完全な状態、即ち不正状態です。</p>

<p><code>Conclude()</code>がコールされる前に<code>ContractAmount</code>インスタンスが何かに利用されるとバグになります。<br>
このように初期化が済んでおらず、使い物になってないオブジェクト、または未初期化状態を発生しうるオブジェクトを、アンチパターン <strong>生焼けオブジェクト</strong> と言います。</p>

<h3>
<span id="課題2-2不正値の混入" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C2-2%E4%B8%8D%E6%AD%A3%E5%80%A4%E3%81%AE%E6%B7%B7%E5%85%A5"><i class="fa fa-link"></i></a>課題2-2：不正値の混入</h3>

<p>その他、消費税率に負数を代入するなど、不正値を与えることも容易に出来てしまいます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">contractAmount</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ContractAmount</span><span class="p">();</span>
<span class="n">contractAmount</span><span class="p">.</span><span class="n">SalesTaxRate</span> <span class="p">=</span> <span class="p">-</span><span class="m">0.10</span><span class="n">m</span><span class="p">;</span>
</code></pre></div></div>

<h2>
<span id="課題まとめ" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>課題まとめ</h2>

<p>以上、低凝集であることにより以下の課題が発生します。</p>

<ul>
<li>生産性低下</li>
<li>修正漏れ</li>
<li>コードクローン</li>
<li>未初期化状態（生焼けオブジェクト）</li>
<li>不正値混入</li>
</ul>

<p>単にデータを保持するだけの、なんら処理ロジックを持たない <strong>データクラス</strong> は低凝集です。上記種々の問題を誘発させる <strong>アンチパターン「ドメインモデル貧血症」</strong> であり、 <strong>悪</strong> なのです(※CQRSパターンのQuery層でDTOとして利用するのは別の話)。<br>
こうした問題を発生させないための設計方法が、これから紹介する <strong>ValueObject</strong> 、及び <strong>完全コンストラクタ</strong> です。</p>

<h1>
<span id="valueobject" class="fragment"></span><a href="#valueobject"><i class="fa fa-link"></i></a>ValueObject</h1>

<p>ValueObjectとはデータのラッパーであり、正確には</p>

<ul>
<li>(原則的に)1個のインスタンス変数</li>
<li>インスタンス変数を初期化するコンストラクタ</li>
<li>インスタンス変数を<strong>正常に操作することを保証した</strong>メソッド</li>
</ul>

<p>から構成されるクラスです。</p>

<p><a href="https://camo.qiitausercontent.com/cc499d370f59e5a00b8526ed673084fc7376950d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f62353165653362332d376332372d373731302d383136352d3063383337613565663564612e706e67" target="_blank" rel="nofollow noopener"><img width="113" alt="tax_uml_03.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fb51ee3b3-7c27-7710-8165-0c837a5ef5da.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f0bcc3502215080c00a3ff3e24da7729" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/b51ee3b3-7c27-7710-8165-0c837a5ef5da.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fb51ee3b3-7c27-7710-8165-0c837a5ef5da.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=cd448e463a003d4a4b9fc4d51e1b824c 1x" loading="lazy"></a></p>

<p>値を単なる変数として実装するのではなく、クラスというひとつの型の単位として扱う、という考えに基づきます。<br>
では税抜き金額をValueObjectとして扱うことを例に考えてみます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;税抜き金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AmountExcludingTax</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">_amount</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 初期値はコンストラクタで与える</span>
        <span class="n">_amount</span> <span class="p">=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 税抜き金額1000円</span>
<span class="kt">var</span> <span class="n">amountExcludingTax</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
</code></pre></div></div>

<p>まずは基本形。ここから全てがスタートします。<br>
税抜き金額の値をコンストラクタで与え、インスタンス変数に格納します。<br>
しかしここまではアンチパターンである <strong>データクラス</strong> とあまり変わらないように見えますね。<br>
事実、以下のように不正値を混入可能です。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// 負の金額、即ち不正値を代入できてしまう。</span>
<span class="kt">var</span> <span class="n">amountExcludingTax</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AmountExcludingTax</span><span class="p">(-</span><span class="m">100</span><span class="p">);</span>
</code></pre></div></div>

<p>どうすれば良いでしょうか。これを解決するのが <strong>完全コンストラクタ</strong> です。</p>

<h1>
<span id="完全コンストラクタ" class="fragment"></span><a href="#%E5%AE%8C%E5%85%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF"><i class="fa fa-link"></i></a>完全コンストラクタ</h1>

<p>オブジェクトを「  <strong>newした時点で正しく利用可能な、即ち完全体</strong> 」となるよう適切な初期化ロジックをコンストラクタに実装する方法です。<br>
税抜き金額のあるべき姿、要件を考えてみましょう。</p>

<ul>
<li>0以上の整数であること</li>
</ul>

<p>となりますね。この要件を満たすもののみインスタンス変数に格納するようフィルタリングすれば良いのです。要件未達の値は例外を投げるよう実装します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;税抜き金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AmountExcludingTax</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">_amount</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// コンストラクタで不正値を除外</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">IsValid</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">_amount</span> <span class="p">=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 税抜き金額のバリデーションを用意</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsValid</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 正常値の要件を記述</span>
        <span class="k">return</span> <span class="m">0</span> <span class="p">&lt;=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これで正常値のみインスタンス変数に格納できるようになりました。</p>

<h2>
<span id="生まれながらにして完全体" class="fragment"></span><a href="#%E7%94%9F%E3%81%BE%E3%82%8C%E3%81%AA%E3%81%8C%E3%82%89%E3%81%AB%E3%81%97%E3%81%A6%E5%AE%8C%E5%85%A8%E4%BD%93"><i class="fa fa-link"></i></a>生まれながらにして完全体</h2>

<p>完全コンストラクタは更に利点があります。不正値が渡されるとコンストラクタで例外をスローするので、 <strong>不正値を持ったAmountExcludingTaxのインスタンスが存在できなくなります</strong> 。常に安全で正常なインスタンスのみが存在し、利用できるようになります。<br>
完全コンストラクタで設計したクラスのインスタンスは、 <strong>生まれながらにして完全体</strong> なのです。誕生した瞬間 <strong>セル完全体</strong> なのです。</p>

<p>一方不正値が混入すると例外をスローしAmountExcludingTaxのインスタンスが存在できなくなくなるので、 <strong>不完全な</strong> セル第１形態や第２形態は <strong>誕生前に即死</strong> することになります。これはスゴイ！！</p>

<p>ValueObjectと完全コンストラクタを利用せずに変数に対してバリデーションをかけることも当然可能ですが、ただの変数の場合、後から不正値を再代入できてしまう点において劣ります。</p>

<h2>
<span id="setterを用意しない" class="fragment"></span><a href="#setter%E3%82%92%E7%94%A8%E6%84%8F%E3%81%97%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>setterを用意しない</h2>

<p>再代入を容易に許すと折角完全コンストラクタで確保した安全があっさり崩れてしまいます。従ってsetterを用意してはいけません。<br>
getterのみ用意するようにしましょう(※より良い設計ではgetterすらない方が良い、後述)。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;税抜き金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AmountExcludingTax</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">_amount</span><span class="p">;</span>

    <span class="c1">// getterのみ用意する(※より良い設計ではgetterすら用意しない)</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_amount</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="immutable不変にする" class="fragment"></span><a href="#immutable%E4%B8%8D%E5%A4%89%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>immutable(不変)にする</h2>

<p>内部のインスタンス変数が変更可能な状態にあると、並列処理などにおいていつの間にか値がすり替わっているなど意図しない副作用が発生する可能性があります。より安全に倒すため、ValueObjectは不変にしましょう。インスタンス変数に<code>readonly</code>(Javaでいうfinal修飾子)を付与します。これでコンストラクタで初期化以後、変更できなくなります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;税抜き金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AmountExcludingTax</span>
<span class="p">{</span>
    <span class="c1">// これでコンストラクタ以後書き換えられなくなり、不変となる。</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">_amount</span><span class="p">;</span>
</code></pre></div></div>

<h2>
<span id="超重要許可された操作のみメソッド化する" class="fragment"></span><a href="#%E8%B6%85%E9%87%8D%E8%A6%81%E8%A8%B1%E5%8F%AF%E3%81%95%E3%82%8C%E3%81%9F%E6%93%8D%E4%BD%9C%E3%81%AE%E3%81%BF%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%8C%96%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>【！超重要！】許可された操作のみメソッド化する</h2>

<p>さて、不変にしたところで値を変更したい場合どうすればいいでしょう。<br>
例えば税抜き金額同士で加算したいケースがよくあるでしょう。その場合、加算結果を格納した新たなValueObjectのインスタンスを生成するよう設計します。ここでは加算メソッド<code>Add</code>を用意してみました。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;税抜き金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AmountExcludingTax</span>
<span class="p">{</span>
    <span class="c1">// 省略</span>

    <span class="k">public</span> <span class="n">AmountExcludingTax</span> <span class="nf">Add</span><span class="p">(</span><span class="n">AmountExcludingTax</span> <span class="n">amountExcludingTax</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 税抜き金額同士を加算する。</span>
        <span class="c1">// 引数には同じAmountExcludingTaxだけ渡せるよう設計。</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="n">_amount</span> <span class="p">+</span> <span class="n">amountExcludingTax</span><span class="p">.</span><span class="n">_amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 省略</span>
<span class="p">}</span>

<span class="c1">// 使用例</span>
<span class="kt">var</span> <span class="n">amount1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">amount2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">total</span> <span class="p">=</span> <span class="n">amount1</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">amount2</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">total</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>  <span class="c1">// 110が出力される</span>
</code></pre></div></div>

<p>これにより元のインスタンスの不変を維持したまま変更値を用意可能です。</p>

<p><strong>但し要注意です。</strong><br>
金額同士の加算は用途上考えられますが、乗算はないはずです。税抜き金額がValueObjectではなく単なるローカル変数である場合を考えてみて下さい。乗算どころか<strong>どんな計算でも制約なく出来てしまいます</strong>。<br>
金額ならば加算や減算だけなど、業務概念的に許可された操作だけをメソッドとして公開することで、<strong>不正な演算を許さない</strong>、頑強な設計となります。<br>
この設計思想からするとgetterで値取得可能な構造は、取得先の外部で勝手な演算が出来てしまうので、可能な限りgetterを実装しないのが望ましい姿です。但し、getterがないとUI表示や永続化の際値が取れなくなるので、バランス取りが難しいところです。</p>

<h2>
<span id="全てのクラスに備わる自己防衛責務" class="fragment"></span><a href="#%E5%85%A8%E3%81%A6%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E5%82%99%E3%82%8F%E3%82%8B%E8%87%AA%E5%B7%B1%E9%98%B2%E8%A1%9B%E8%B2%AC%E5%8B%99"><i class="fa fa-link"></i></a>全てのクラスに備わる「自己防衛責務」</h2>

<p>「詳細な初期化処理や事前準備をしないと使い物にならない」……あなたはこんなクラスやメソッドを使いたいと思いますか？<br>
そもそもの話として、ソフトウェアはメソッド、クラス、モジュール、どの粒度でも、それ <strong>自体が単体で</strong> バグがなく <strong>いつでも安全に</strong> 利用できる品質が求められます。<br>
クラスも各々が他に依存することなく単体で安全に利用できるよう設計されている必要があります。他のクラスに初期化して貰ったり、バリデートして貰っているようなクラスは未熟なクラスです。 <strong>自分の身は自分で守らせる</strong> 。 <strong>自己防衛責務</strong> を <strong>全てクラスが備える</strong> 、という考え方がソフトウェア品質を考える上で重要です。完全コンストラクタはその方針を設計に落としたもののひとつです。<br>
構成部品であるクラスひとつひとつが品質的に完結していることにより、ソフトウェア全体の品質が向上するのです。</p>

<h1>
<span id="課題は解決されたか" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C%E3%81%AF%E8%A7%A3%E6%B1%BA%E3%81%95%E3%82%8C%E3%81%9F%E3%81%8B"><i class="fa fa-link"></i></a>課題は解決されたか？</h1>

<p>ValueObjectと完全コンストラクタの基本は以上になります。<br>
さて、この記事の冒頭で低凝集による種々の課題を列挙しましたが、解決されたのでしょうか？<br>
今一度<code>AmountExcludingTax</code>のクラス図とソースコードを見てみましょう。</p>

<p><a href="https://camo.qiitausercontent.com/6746bf5bc863d53607122cfa2e55b4cfd88958d3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f31383636306233362d326235642d623136302d633463312d3237383337363665613533382e706e67" target="_blank" rel="nofollow noopener"><img width="182" alt="tax_uml_04.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F18660b36-2b5d-b160-c4c1-2783766ea538.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=179b970c996af8a93babfa1d2411668e" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/18660b36-2b5d-b160-c4c1-2783766ea538.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F18660b36-2b5d-b160-c4c1-2783766ea538.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e5e13fe5bb01a7c576f1d475a34f7e50 1x" loading="lazy"></a></p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;税抜き金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AmountExcludingTax</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">_amount</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_amount</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;コンストラクタ&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="amount"&gt;税抜き金額&lt;/param&gt;</span>
    <span class="k">public</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">IsValid</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">_amount</span> <span class="p">=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;税抜き金額を加算する&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="amountExcludingTax"&gt;税抜き金額&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;税抜き金額&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="n">AmountExcludingTax</span> <span class="nf">Add</span><span class="p">(</span><span class="n">AmountExcludingTax</span> <span class="n">amountExcludingTax</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="n">_amount</span> <span class="p">+</span> <span class="n">amountExcludingTax</span><span class="p">.</span><span class="n">_amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;有効な税抜き金額であるかを返す&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="amount"&gt;税抜き金額&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;有効な場合true&lt;/returns&gt;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsValid</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="m">0</span> <span class="p">&lt;=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>税抜き金額の単なるデータだけでなく、許容値や演算メソッド(<code>Add</code>)など、関連するロジックが凝集しているのがお分かり頂けますでしょうか。このようにデータとそれを処理するロジックが分散せず、一箇所に集められカプセル化されているのを <strong>高凝集</strong> と呼びます。<br>
では低凝集で生じる課題がどう解決されたか説明します。</p>

<table>
<thead>
<tr>
<th style="text-align: left">課題</th>
<th style="text-align: left">解決</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">生産性低下</td>
<td style="text-align: left">税抜き金額に関する定義はAmountExcludingTaxのみを見れば良い。他を探し回る労苦から解放され、生産性が向上する。</td>
</tr>
<tr>
<td style="text-align: left">修正漏れ</td>
<td style="text-align: left">税抜き金額に関して仕様変更が発生した場合、原則的にAmountExcludingTaxのみを修正すれば良い。修正漏れが生じにくい。</td>
</tr>
<tr>
<td style="text-align: left">コードクローン</td>
<td style="text-align: left">「税抜き金額に関する仕様はAmountExcludingTax内にのみ実装されている」「税抜き金額はAmountExcludingTaxインスタンスとして扱う」と約束付けることでクローンが発生しにくくなる。</td>
</tr>
<tr>
<td style="text-align: left">未初期化状態</td>
<td style="text-align: left">完全コンストラクタによりnewした時点で正常に初期化。未初期化な状態がそもそも存在しなくなる。</td>
</tr>
<tr>
<td style="text-align: left">不正値混入</td>
<td style="text-align: left">完全コンストラクタのバリデーションにより不正値を持ったインスタンスが存在できなくなる。</td>
</tr>
</tbody>
</table>

<h1>
<span id="更に発展応用させる" class="fragment"></span><a href="#%E6%9B%B4%E3%81%AB%E7%99%BA%E5%B1%95%E5%BF%9C%E7%94%A8%E3%81%95%E3%81%9B%E3%82%8B"><i class="fa fa-link"></i></a>更に発展応用させる</h1>

<p>以上がValueObjectの基本となります。上記だけでもかなりの設計要件が登場しましたが、更に様々なパターンに対応し応用できるよう発展させていきます。</p>

<p>以下では、 <strong>税込み金額</strong> の計算を題材に、ValueObjectパターンに関し更に深堀りしていきます。ぶっちゃけ税込み金額は「税抜き金額 x 消費税率」で算出できてしまうのですが、消費税率の適用ルール周りには様々な要件や業務知識が存在するので、そうした概念を踏まえた上で堅牢な設計をしていきます。</p>

<h1>
<span id="消費税率をvalueobject化してみる" class="fragment"></span><a href="#%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E3%82%92valueobject%E5%8C%96%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>消費税率をValueObject化してみる</h1>

<p>まずは消費税率をValueObjectとして設計してみます。<br>
とりあえず税抜き金額<code>AmountExcludingTax</code>と同様に、初期値をコンストラクタで与える形で作ってみます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;消費税率&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">SalesTaxRate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">decimal</span> <span class="n">_rate</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">SalesTaxRate</span><span class="p">(</span><span class="kt">decimal</span> <span class="n">rate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">IsValid</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">_rate</span> <span class="p">=</span> <span class="n">rate</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsValid</span><span class="p">(</span><span class="kt">decimal</span> <span class="n">rate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="m">0</span> <span class="p">&lt;=</span> <span class="n">rate</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>一応それらしいものができました。…ですがこれで良いのでしょうか？</p>

<h2>
<span id="再燃する課題低凝集" class="fragment"></span><a href="#%E5%86%8D%E7%87%83%E3%81%99%E3%82%8B%E8%AA%B2%E9%A1%8C%E4%BD%8E%E5%87%9D%E9%9B%86"><i class="fa fa-link"></i></a>再燃する課題…低凝集</h2>

<p>消費税率の値は、商品を購入した日時によって決まります。また、その値も固定です(例えば2019/10/01より10%)。ですが、この設計ではコンストラクタから任意の税率を代入できてしまいますし、そもそも税率を決定するロジックが存在しません。そのロジックはどこに実装されるのでしょうか。前の例のようにControllerクラスに実装されるのでしょうか。するとまた低凝集な設計になり、生産性低下など様々な問題を生み出してしまいます。</p>

<h2>
<span id="凝集しよう--完全コンストラクタのおさらい" class="fragment"></span><a href="#%E5%87%9D%E9%9B%86%E3%81%97%E3%82%88%E3%81%86--%E5%AE%8C%E5%85%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%81%AE%E3%81%8A%E3%81%95%E3%82%89%E3%81%84"><i class="fa fa-link"></i></a>凝集しよう － 完全コンストラクタのおさらい</h2>

<p>振り返ってみましょう。「 <strong>newした段階で使い物になるようにコンストラクタ内で初期化処理を完結する</strong> 」というのが完全コンストラクタの主旨です。つまり、 <strong>日付により消費税率を決めるロジックを消費税率クラスのコンストラクタ内に定義する</strong> のが自然、と考えられます。</p>

<h2>
<span id="消費税率周りのドメイン分析" class="fragment"></span><a href="#%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E5%91%A8%E3%82%8A%E3%81%AE%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%88%86%E6%9E%90"><i class="fa fa-link"></i></a>消費税率周りのドメイン分析</h2>

<p>ではどのように消費税率の値が決められるのか、一度消費税率に関する業務知識を確認してみましょう。</p>

<ul>
<li>消費税は施行日がある。法によって定められた <strong>消費税施行日</strong> 以降に <strong>当該消費税率</strong> が適用される。</li>
<li>売買契約が締結した時点の消費税率を適用する。</li>
<li>つまり、 <strong>契約日</strong> が所定の <strong>消費税施行日</strong> 以降である場合、 <strong>当該税率</strong> が適用される。</li>
<li>（※経過措置など難しい概念もあるが今回は割愛）</li>
</ul>

<p>ここでいくつか重要そうな概念が洗い出されました。</p>

<ul>
<li>消費税施行日（固定）</li>
<li>消費税率（固定）</li>
<li>契約日（任意）</li>
</ul>

<p>つまり契約日が決まってしまえば、あとは消費税施行日と照らし合わせて消費税率が決まる仕組みですね。「消費税率は契約日により一意に決まる」、ということが分かりました。<br>
つまり、</p>

<ul>
<li>コンストラクタで契約日を受け取る。</li>
<li>コンストラクタ内で契約日と消費税施行日を比較して消費税率を決定する。</li>
<li>得られた消費税率の値をインスタンス変数へ格納する。</li>
</ul>

<p>というロジックになれば良さそうです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;消費税率&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">SalesTaxRate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">decimal</span> <span class="n">_rate</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">SalesTaxRate</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">contractDate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 省略するがここで契約日と消費税施行日とを比較し、消費税率を決定する。</span>
        <span class="n">_rate</span> <span class="p">=</span> <span class="c1">// 決定した税率値を代入</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>税抜き金額<code>AmountExcludingTax</code>は、金額値をコンストラクタで受け取っていました。それはUIから任意金額値を入力するユースケースから考えても自然です。一方で、消費税率クラスのようにコンストラクタ引数の値が同一概念の値とは限りません。<br>
 <strong>何に依存してその値が決定するのか、しっかりドメイン分析することが肝要</strong> です。</p>

<h2>
<span id="契約日の扱い" class="fragment"></span><a href="#%E5%A5%91%E7%B4%84%E6%97%A5%E3%81%AE%E6%89%B1%E3%81%84"><i class="fa fa-link"></i></a>契約日の扱い</h2>

<p>ところで消費税率クラスのコンストラクタ引数となる契約日は、ただのDateTime型で良いのでしょうか？ものによりますが、アプリで扱われる日時は、例えば生年月日、注文日など多種にわたるでしょう。例えば以下のようなコードは許されるのでしょうか。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="n">DateTime</span> <span class="n">contractDate</span> <span class="p">=</span> <span class="n">birthday</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">salesTaxRate</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SalesTaxRate</span><span class="p">(</span><span class="n">contractDate</span><span class="p">);</span>
</code></pre></div></div>

<p>契約日に誕生日を代入してしまっており、どう見てもバグとなりますね。<br>
ここでも役立つのがValueObjectです。<br>
契約日をValueObjectとして設計し、コンストラクタ引数を契約日の型にすれば、異なる概念の値が混入してしまうのを防ぐことができます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;契約日&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ContractDate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">DateTime</span> <span class="n">_date</span><span class="p">;</span>
    <span class="c1">// 省略</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;消費税率&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">SalesTaxRate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">decimal</span> <span class="n">_rate</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">SalesTaxRate</span><span class="p">(</span><span class="n">ContractDate</span> <span class="n">contractDate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 省略</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">birthday</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Birthday</span><span class="p">(</span><span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1990</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">2</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">salesTaxRate</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SalesTaxRate</span><span class="p">(</span><span class="n">birthday</span><span class="p">);</span>  <span class="c1">// 型が異なるのでコンパイルが通らない</span>
</code></pre></div></div>

<h2>
<span id="あらゆる値をvalueobjectとして設計する" class="fragment"></span><a href="#%E3%81%82%E3%82%89%E3%82%86%E3%82%8B%E5%80%A4%E3%82%92valueobject%E3%81%A8%E3%81%97%E3%81%A6%E8%A8%AD%E8%A8%88%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>あらゆる値をValueObjectとして設計する</h2>

<p>ドメイン駆動設計のようにドメイン層を設ける設計であれば、ドメイン層では <strong>どんな値もなるべく全てValueObject</strong> で扱った方が良いです。そして <strong>プリミティブな型ではなくValueObject型</strong> でやり取りし、 <strong>全てのValueObjectで異なる型の代入を弾く設計実装</strong> すれば、 <strong>異なる概念の値混入に対して非常に強固な作り</strong> になります。<br>
ちなみに私の以前の開発現場では、こうした異なる概念の値混入によるバグがたびたび発生していました。一度に多くのパラメータを取り扱うユースケースで特に起こっていました。こうしたつまらないバグにつまづかないよう、こまめにValueObject化することが肝要だと考えます。</p>

<p>ここまでの検討により、インターフェースはだいたい決まりました。<br>
一度クラス図を起こします。</p>

<p><a href="https://camo.qiitausercontent.com/870edb0efab140aca4cfe745349cc3e97d522c71/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f61333731613263392d316233332d346664622d323130352d3536623033643363303039342e706e67" target="_blank" rel="nofollow noopener"><img width="339" alt="tax_uml_05.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fa371a2c9-1b33-4fdb-2105-56b03d3c0094.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f6fd84fa54a29fc16b9e7c5b516ae484" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/a371a2c9-1b33-4fdb-2105-56b03d3c0094.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fa371a2c9-1b33-4fdb-2105-56b03d3c0094.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=cbb35f1c322e8707ef5689e102baff3a 1x" loading="lazy"></a></p>

<p>このクラス構成に基づき、設計実装の細部を詰めていきます。</p>

<h1>
<span id="契約日クラス" class="fragment"></span><a href="#%E5%A5%91%E7%B4%84%E6%97%A5%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>契約日クラス</h1>

<p>契約日クラスを設計していきます。<br>
初期値を決めたいのですが、コンストラクタ引数で初期値となるDateTime型を渡してよいのでしょうか？低凝集の不安がありますね。一度ドメイン分析しましょう。</p>

<ul>
<li>売買契約が締結した日時である。</li>
<li>永続化対象である。(※本来ドメイン分析で考慮すべきことではない)</li>
</ul>

<p>まず締結日時ですが、締結したときに任意DateTimeを利用側から与えられるのではなく、契約日クラス側で決めてしまった方が良いですね。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;契約日&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ContractDate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">DateTime</span> <span class="n">_date</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ContractDate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_date</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>また、契約日は永続化対象なので、リポジトリから読み出した値を格納できるようにクチを設けておく必要があります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;契約日&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ContractDate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">DateTime</span> <span class="n">_date</span><span class="p">;</span>

    <span class="c1">// 契約締結時に呼び出す用</span>
    <span class="k">public</span> <span class="nf">ContractDate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_date</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// リポジトリからの読み出し用</span>
    <span class="k">public</span> <span class="nf">ContractDate</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">date</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_date</span> <span class="p">=</span> <span class="n">date</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ところでコンストラクタが複数あります。コメントで説明はしていますが、利用側からはどちらのコンストラクタが何の用途か非常に分かりにくいものなってしまいます。どうすれば良いのでしょうか。</p>

<h2>
<span id="factoryメソッドprivateコンストラクタ" class="fragment"></span><a href="#factory%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89private%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF"><i class="fa fa-link"></i></a>Factoryメソッド＋privateコンストラクタ</h2>

<p>こういう場合、用途ごとのFactoryメソッドを用意します。各Factoryメソッドには、用途に相応しい命名をします。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;契約日&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ContractDate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">DateTime</span> <span class="n">_date</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_date</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="c1">// 制約を無視した勝手なインスタンス生成を利用側にされないようprivateにする</span>
    <span class="k">private</span> <span class="nf">ContractDate</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">date</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_date</span> <span class="p">=</span> <span class="n">date</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 契約締結時に呼び出す用</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">ContractDate</span> <span class="nf">Conclude</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ContractDate</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// リポジトリからの読み出し用</span>
    <span class="c1">// リポジトリ以外からの生成に利用されないようinternalにする</span>
    <span class="k">internal</span> <span class="k">static</span> <span class="n">ContractDate</span> <span class="nf">Reconstruct</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">date</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ContractDate</span><span class="p">(</span><span class="n">date</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>そしてコンストラクタはprivateにします。こうすることで契約日ContractDateの <strong>生成方法を用途別に縛る</strong> ことができます。 <strong>クラス設計者の予想だにしない使われ方をさせない</strong>ことも、安全性を高める上で重要です。また、リポジトリから読み出した場合に用いられる<code>Reconstruct()</code>はinternalにすることでパッケージ内のみアクセス可能になり、アプリ層やView層などからコールされることがなくなります。</p>

<h1>
<span id="消費税率適用ルールの設計" class="fragment"></span><a href="#%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E9%81%A9%E7%94%A8%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E8%A8%88"><i class="fa fa-link"></i></a>消費税率適用ルールの設計</h1>

<p>先ほど「消費税率を決定するロジックを消費税率クラスのコンストラクタに定義する」と書きました。しかし「消費税施行日」など様々な概念が絡んでいそうです。単純に実装しただけでは <strong>複雑度が増大し、保守が難しくなりそう</strong> なので、小分けにしてボトムアップで考えていくことにします。</p>

<p>以下のようなロジックを元に考えてみます。</p>

<ul>
<li>消費税施行日とその適用税率をリストで持っておく。</li>
<li>消費税施行日が最新のものから順に契約日と比較する。契約日が消費税施行日以降であれば、その税率を適用する。</li>
</ul>

<h2>
<span id="消費税クラス" class="fragment"></span><a href="#%E6%B6%88%E8%B2%BB%E7%A8%8E%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>消費税クラス</h2>

<p>消費税に関しては、施行日と税率がセットになっているので、一緒にしてしまって良さそうです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;消費税&lt;/summary&gt;</span>
<span class="k">internal</span> <span class="k">class</span> <span class="nc">SalesTax</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;施行日&lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">DateTime</span> <span class="n">_enforcementDate</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;税率&lt;/summary&gt;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">decimal</span> <span class="n">_rate</span><span class="p">;</span>

    <span class="k">internal</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">enforcementDate</span><span class="p">,</span> <span class="kt">decimal</span> <span class="n">rate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">IsValidRate</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">_enforcementDate</span> <span class="p">=</span> <span class="n">enforcementDate</span><span class="p">;</span>
        <span class="n">_rate</span> <span class="p">=</span> <span class="n">rate</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsValidRate</span><span class="p">(</span><span class="kt">decimal</span> <span class="n">rate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="m">0</span><span class="n">m</span> <span class="p">&lt;=</span> <span class="n">rate</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="名前がカブった" class="fragment"></span><a href="#%E5%90%8D%E5%89%8D%E3%81%8C%E3%82%AB%E3%83%96%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>名前がカブった？？</h2>

<p>ちょっと話が外れますが、先ほど消費税率クラスを<code>SalesTaxRate</code>と命名しました。一方、上述の消費税クラス、インスタンス変数に<code>_rate</code>がいます。<code>SalesTax._rate</code>と<code>SalesTaxRate</code>、なんだか紛らわしいですね。どうも概念的に微妙に違っていそうです。命名をブラッシュアップしてみましょう。<br>
そもそも消費税率クラスは一体何なのでしょうか。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;消費税率&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">SalesTaxRate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">decimal</span> <span class="n">_rate</span><span class="p">;</span>

    <span class="c1">// コンストラクタで契約日を受け取る</span>
    <span class="k">public</span> <span class="nf">SalesTaxRate</span><span class="p">(</span><span class="n">ContractDate</span> <span class="n">contractDate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ここで契約日と消費税施行日とを比較し、消費税率を決定する。</span>
</code></pre></div></div>

<p>契約日により税率を決定しています。つまり完全コンストラクタの設計思想に基づけば、これは「契約日に <strong>適用された税率</strong> 」なのです。すると冒頭の消費税率クラスは「 <strong>適用された消費税率</strong> 」と名付けた方がより適切ですね。<code>SalesTaxRate</code>から<code>AppliedSalesTaxRate</code>へ <strong>命名をブラッシュアップ</strong> します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;適用された消費税率&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AppliedSalesTaxRate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">decimal</span> <span class="n">_rate</span><span class="p">;</span>

    <span class="c1">// コンストラクタで契約日を受け取る</span>
    <span class="k">public</span> <span class="nf">AppliedSalesTaxRate</span><span class="p">(</span><span class="n">ContractDate</span> <span class="n">contractDate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ここで契約日と消費税施行日とを比較し、消費税率を決定する。</span>
</code></pre></div></div>

<p>完全コンストラクタで設計したクラスの名前は「○○された△△」、「〜ed△△」というように、何かによって完成品 <strong>となった</strong> 命名をするのが望ましいです。</p>

<h2>
<span id="消費税適用ルールクラス" class="fragment"></span><a href="#%E6%B6%88%E8%B2%BB%E7%A8%8E%E9%81%A9%E7%94%A8%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>消費税適用ルールクラス</h2>

<p>消費税クラス<code>SalesTax</code>を用いて、消費税適用ルール<code>SalesTaxApplyRule</code>を設計します。<br>
上述の通り、「消費税の施行日と税率を消費税クラスとしてリストで持っておき、施行日が最新のものから順番に契約日と比較して、契約日が施行日以降であればその税率を適用する」としましょう。<br>
下記コードのようにコンストラクタでリスト生成して、<code>ApplyRule()</code>で適用税率を返します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;消費税適用ルール&lt;/summary&gt;</span>
<span class="k">internal</span> <span class="k">class</span> <span class="nc">SalesTaxApplyRule</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SalesTax</span><span class="p">&gt;</span> <span class="n">_salesTaxes</span><span class="p">;</span>

    <span class="k">internal</span> <span class="nf">SalesTaxApplyRule</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_salesTaxes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SalesTax</span><span class="p">&gt;();</span>
        <span class="c1">// 最新の施行日から順に格納すること。</span>
        <span class="c1">// (開発者が順番を気にしなくても良いように設計するのがホントは望ましい)</span>
        <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">enforcementDate</span><span class="p">:</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">2019</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">rate</span><span class="p">:</span> <span class="m">0.10</span><span class="n">m</span><span class="p">));</span>
        <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">enforcementDate</span><span class="p">:</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">2014</span><span class="p">,</span>  <span class="m">4</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">rate</span><span class="p">:</span> <span class="m">0.08</span><span class="n">m</span><span class="p">));</span>
        <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">enforcementDate</span><span class="p">:</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1997</span><span class="p">,</span>  <span class="m">4</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">rate</span><span class="p">:</span> <span class="m">0.05</span><span class="n">m</span><span class="p">));</span>
        <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">enforcementDate</span><span class="p">:</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1989</span><span class="p">,</span>  <span class="m">4</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">rate</span><span class="p">:</span> <span class="m">0.03</span><span class="n">m</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="kt">decimal</span> <span class="nf">ApplyRule</span><span class="p">(</span><span class="n">ContractDate</span> <span class="n">contractDate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">corresponded</span> <span class="p">=</span> <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">tax</span> <span class="p">=&gt;</span> <span class="n">tax</span><span class="p">.</span><span class="n">EnforcementDate</span> <span class="p">&lt;=</span> <span class="n">contractDate</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">corresponded</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="n">corresponded</span><span class="p">.</span><span class="n">Rate</span> <span class="p">:</span> <span class="m">0.00</span><span class="n">m</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ちなみにこの<code>SalesTaxApplyRule</code>の設計はValueObjectパターンの亜種で、リストに対しての業務ロジックをカプセル化する設計パターン「 <strong>ファーストクラスコレクション</strong> 」といいます。リスト操作は兎角ネスト構造になりがちでコードが <strong>複雑化</strong> しやすいので、是非覚えて下さい。 </p>

<h2>
<span id="適用された消費税率クラスへ組み込み" class="fragment"></span><a href="#%E9%81%A9%E7%94%A8%E3%81%95%E3%82%8C%E3%81%9F%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%B8%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>「適用された消費税率」クラスへ組み込み</h2>

<p>ここまでくれば税適用ルール<code>SalesTaxApplyRule</code>を<code>AppliedSalesTaxRate</code>へ組み込むことができますね。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;適用された消費税率&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AppliedSalesTaxRate</span>
<span class="p">{</span>
    <span class="c1">// 税適用ルールは1つあれば良く、複数生成させないようstatic readonlyとする。</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">SalesTaxApplyRule</span> <span class="n">_salesTaxApplyRule</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SalesTaxApplyRule</span><span class="p">();</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">decimal</span> <span class="n">_rate</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_rate</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">AppliedSalesTaxRate</span><span class="p">(</span><span class="n">ContractDate</span> <span class="n">contractDate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_rate</span> <span class="p">=</span> <span class="n">_salesTaxApplyRule</span><span class="p">.</span><span class="nf">ApplyRule</span><span class="p">(</span><span class="n">contractDate</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1>
<span id="税込み金額クラス" class="fragment"></span><a href="#%E7%A8%8E%E8%BE%BC%E3%81%BF%E9%87%91%E9%A1%8D%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>税込み金額クラス</h1>

<p>最後に税込み金額クラスです。<br>
これもValueObject+完全コンストラクタで設計します。<br>
税抜き金額クラスと適用された消費税率クラスのインスタンスを渡し、税込み金額を計算し格納します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;税込金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AmountIncludingTax</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">_amount</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_amount</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">AmountIncludingTax</span><span class="p">(</span>
        <span class="n">AmountExcludingTax</span> <span class="n">amountExcludingTax</span><span class="p">,</span>
        <span class="n">AppliedSalesTaxRate</span> <span class="n">appliedSalesTaxRate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_amount</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">amountExcludingTax</span><span class="p">.</span><span class="n">Value</span> <span class="p">*</span> <span class="p">(</span><span class="m">1</span><span class="n">m</span> <span class="p">+</span> <span class="n">appliedSalesTaxRate</span><span class="p">.</span><span class="n">Value</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これで目標である税込み金額クラスを設計できました。</p>

<h1>
<span id="おさらい" class="fragment"></span><a href="#%E3%81%8A%E3%81%95%E3%82%89%E3%81%84"><i class="fa fa-link"></i></a>おさらい</h1>

<p>最終的なクラス図とソースコードです。</p>

<p><a href="https://camo.qiitausercontent.com/0d6f2846591f54c0f2b5f2e6f909a81714475be7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f35306465613730382d666561622d303365382d363562332d3133393131633562393636302e706e67" target="_blank" rel="nofollow noopener"><img width="508" alt="tax_uml_06.png" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F50dea708-feab-03e8-65b3-13911c5b9660.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b591072bebc04626bbdf7bfcd1690b5b" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/50dea708-feab-03e8-65b3-13911c5b9660.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F50dea708-feab-03e8-65b3-13911c5b9660.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ff958213099536d3dad1164e0e5b5fc3 1x" loading="lazy"></a></p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">AmountExcludingTax.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;税抜き金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AmountExcludingTax</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">_amount</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_amount</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;コンストラクタ&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="amount"&gt;税抜き金額&lt;/param&gt;</span>
    <span class="k">public</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">IsValid</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">_amount</span> <span class="p">=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;税抜き金額を加算する&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="amountExcludingTax"&gt;税抜き金額&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;税抜き金額&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="n">AmountExcludingTax</span> <span class="nf">Add</span><span class="p">(</span><span class="n">AmountExcludingTax</span> <span class="n">amountExcludingTax</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AmountExcludingTax</span><span class="p">(</span><span class="n">_amount</span> <span class="p">+</span> <span class="n">amountExcludingTax</span><span class="p">.</span><span class="n">_amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;有効な税抜き金額であるかを返す&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="amount"&gt;税抜き金額&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;有効な場合true&lt;/returns&gt;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsValid</span><span class="p">(</span><span class="kt">int</span> <span class="n">amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="m">0</span> <span class="p">&lt;=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">ContractDate.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;契約日&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ContractDate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">DateTime</span> <span class="n">_date</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_date</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;コンストラクタ&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="date"&gt;契約日&lt;/param&gt;</span>
    <span class="c1">/// &lt;remarks&gt;制約を無視した勝手なインスタンス生成を利用側にされないようprivateにしている。&lt;/remarks&gt;</span>
    <span class="k">private</span> <span class="nf">ContractDate</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">date</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_date</span> <span class="p">=</span> <span class="n">date</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;契約締結時に呼び出す。&lt;/summary&gt;</span>
    <span class="c1">/// &lt;returns&gt;契約日&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">ContractDate</span> <span class="nf">Conclude</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ContractDate</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;リポジトリから読み出した時に呼び出す。&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="date"&gt;リポジトリから読み出した契約日&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;契約日&lt;/returns&gt;</span>
    <span class="c1">/// &lt;remarks&gt;リポジトリ以外からの生成に利用されないようinternalにしている。&lt;/remarks&gt;</span>
    <span class="k">internal</span> <span class="k">static</span> <span class="n">ContractDate</span> <span class="nf">Reconstruct</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">date</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ContractDate</span><span class="p">(</span><span class="n">date</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">SalesTax.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;消費税&lt;/summary&gt;</span>
<span class="k">internal</span> <span class="k">class</span> <span class="nc">SalesTax</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;施行日&lt;/summary&gt;</span>
    <span class="k">internal</span> <span class="k">readonly</span> <span class="n">DateTime</span> <span class="n">EnforcementDate</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;税率&lt;/summary&gt;</span>
    <span class="k">internal</span> <span class="k">readonly</span> <span class="kt">decimal</span> <span class="n">Rate</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;消費税&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="enforcementDate"&gt;施行日&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="rate"&gt;税率&lt;/param&gt;</span>
    <span class="k">internal</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">DateTime</span> <span class="n">enforcementDate</span><span class="p">,</span> <span class="kt">decimal</span> <span class="n">rate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">IsValidRate</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">EnforcementDate</span> <span class="p">=</span> <span class="n">enforcementDate</span><span class="p">;</span>
        <span class="n">Rate</span> <span class="p">=</span> <span class="n">rate</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;有効な税率かどうかを返す&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="rate"&gt;税率&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;有効な場合true&lt;/returns&gt;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsValidRate</span><span class="p">(</span><span class="kt">decimal</span> <span class="n">rate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="m">0</span><span class="n">m</span> <span class="p">&lt;=</span> <span class="n">rate</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">SalesTaxApplyRule.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;消費税適用ルール&lt;/summary&gt;</span>
<span class="k">internal</span> <span class="k">class</span> <span class="nc">SalesTaxApplyRule</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SalesTax</span><span class="p">&gt;</span> <span class="n">_salesTaxes</span><span class="p">;</span>

    <span class="k">internal</span> <span class="nf">SalesTaxApplyRule</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_salesTaxes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SalesTax</span><span class="p">&gt;();</span>
        <span class="c1">// 最新の施行日から順に格納すること。</span>
        <span class="c1">// (開発者が順番を気にしなくても良いように設計するのがホントは望ましい)</span>
        <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">enforcementDate</span><span class="p">:</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">2019</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">rate</span><span class="p">:</span> <span class="m">0.10</span><span class="n">m</span><span class="p">));</span>
        <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">enforcementDate</span><span class="p">:</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">2014</span><span class="p">,</span>  <span class="m">4</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">rate</span><span class="p">:</span> <span class="m">0.08</span><span class="n">m</span><span class="p">));</span>
        <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">enforcementDate</span><span class="p">:</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1997</span><span class="p">,</span>  <span class="m">4</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">rate</span><span class="p">:</span> <span class="m">0.05</span><span class="n">m</span><span class="p">));</span>
        <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">SalesTax</span><span class="p">(</span><span class="n">enforcementDate</span><span class="p">:</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1989</span><span class="p">,</span>  <span class="m">4</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">rate</span><span class="p">:</span> <span class="m">0.03</span><span class="n">m</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;消費税ルールを適用する&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="contractDate"&gt;契約日&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;適用された消費税率&lt;/returns&gt;</span>
    <span class="k">internal</span> <span class="kt">decimal</span> <span class="nf">ApplyRule</span><span class="p">(</span><span class="n">ContractDate</span> <span class="n">contractDate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">corresponded</span> <span class="p">=</span> <span class="n">_salesTaxes</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">tax</span> <span class="p">=&gt;</span> <span class="n">tax</span><span class="p">.</span><span class="n">EnforcementDate</span> <span class="p">&lt;=</span> <span class="n">contractDate</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">corresponded</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="n">corresponded</span><span class="p">.</span><span class="n">Rate</span> <span class="p">:</span> <span class="m">0.00</span><span class="n">m</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">AppliedSalesTaxRate.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;適用された消費税率&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AppliedSalesTaxRate</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">SalesTaxApplyRule</span> <span class="n">_salesTaxApplyRule</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SalesTaxApplyRule</span><span class="p">();</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">decimal</span> <span class="n">_rate</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_rate</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;コンストラクタ&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="contractDate"&gt;契約日&lt;/param&gt;</span>
    <span class="k">public</span> <span class="nf">AppliedSalesTaxRate</span><span class="p">(</span><span class="n">ContractDate</span> <span class="n">contractDate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_rate</span> <span class="p">=</span> <span class="n">_salesTaxApplyRule</span><span class="p">.</span><span class="nf">ApplyRule</span><span class="p">(</span><span class="n">contractDate</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">AmountIncludingTax.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;税込金額&lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AmountIncludingTax</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">_amount</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_amount</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;コンストラクタ&lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="amountExcludingTax"&gt;税抜き金額&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="appliedSalesTaxRate"&gt;適用された消費税率&lt;/param&gt;</span>
    <span class="k">public</span> <span class="nf">AmountIncludingTax</span><span class="p">(</span>
        <span class="n">AmountExcludingTax</span> <span class="n">amountExcludingTax</span><span class="p">,</span>
        <span class="n">AppliedSalesTaxRate</span> <span class="n">appliedSalesTaxRate</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_amount</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">amountExcludingTax</span><span class="p">.</span><span class="n">Value</span> <span class="p">*</span> <span class="p">(</span><span class="m">1</span><span class="n">m</span> <span class="p">+</span> <span class="n">appliedSalesTaxRate</span><span class="p">.</span><span class="n">Value</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>消費税の計算に関して、全て <strong>ValueObject(及びその亜種)+完全コンストラクタで設計</strong> できました。<br>
丁寧すぎるほど丁寧に設計しましたが、これらクラス図やソースコードをご覧になってどうでしょう、カンの良い方は以下4点に気づいたのではと思います。</p>

<ul>
<li>業務概念が見える化されている</li>
<li>クラスがその業務概念を説明している</li>
<li>クラスが小さい</li>
<li>internal(Javaでいうpackage private)の活用</li>
</ul>

<p>それぞれ説明していきます。</p>

<h2>
<span id="業務概念が見える化されている" class="fragment"></span><a href="#%E6%A5%AD%E5%8B%99%E6%A6%82%E5%BF%B5%E3%81%8C%E8%A6%8B%E3%81%88%E3%82%8B%E5%8C%96%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>業務概念が見える化されている</h2>

<p>業務概念がひとつひとつクラス化されているため、どんな業務概念を取り扱っているのか見える化されています。<br>
仮にこれがクラス化されていないことを想像してみて下さい。何千何万行ものソースコードの深い深い海の中のテキトーな変数として埋もれてしまい、 <strong>デバッグや仕様変更時のコード分析で多大な労苦を味わうことになる</strong> でしょう。</p>

<h2>
<span id="クラスがその業務概念を説明している" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8C%E3%81%9D%E3%81%AE%E6%A5%AD%E5%8B%99%E6%A6%82%E5%BF%B5%E3%82%92%E8%AA%AC%E6%98%8E%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B"><i class="fa fa-link"></i></a>クラスがその業務概念を説明している</h2>

<p>業務概念の名を冠したクラスひとつひとつが、その業務概念や仕様を説明するようにロジックが組まれています。このように、 <strong>クラス：業務概念：業務ロジック＝１：１：１</strong> となるように設計することが肝要です。<br>
国語辞典を思い出してみて下さい。例えば「消費税」を引くと「消費に対して課される租税」と出てきます。それと同じように、ValueObjectのように業務概念を表したクラスには、「○○とは△△である」のように、 <strong>その言葉の定義を表すようロジックを実装</strong> しましょう。 <strong>理解容易性</strong> が格段に向上します。まさに <strong>名は体を表す</strong> です。</p>

<h2>
<span id="クラスが小さい" class="fragment"></span><a href="#%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8C%E5%B0%8F%E3%81%95%E3%81%84"><i class="fa fa-link"></i></a>クラスが小さい</h2>

<p>ちゃんとドメイン分析してこまめに業務概念をクラス化すると、ひとつひとつのクラスが数十行程度の小さなものになります。<br>
 <strong>テスト容易性</strong> が向上し、安全品質が更に堅牢になります。<br>
また、「 <strong>チャンク</strong> 」でググると分かるかと思いますが、普通の人間が一度に知覚可能な概念の個数は <strong>4±1個</strong> だとされています。クラスを小さくし、 <strong>そのクラスに登場する概念が4±1個以内に設計する</strong> ことにより、やはり <strong>理解容易性</strong> の向上に貢献します。</p>

<p>こうして設計されたプログラムは、 <strong>トレーサビリティ</strong> が向上します。 <strong>どこに何が実装されてあるのか迅速に発見することができる</strong> ようになります。<br>
例えば、消費税法では「経過措置」という概念がありますが、今回の設計では考慮されていません。「消費税率の適用には『経過措置』も考慮しなければならない。消費税適用ルールが定義されるコードはどこだ！？」という事態が発生したとします。「業務概念が全てクラスとして設計されていること」が前提となっていれば、何千何万行ものソースコードを舐める必要がなく、クラス一覧から消費税適用ルールである<code>SalesTaxApplyRule</code>クラスを見つけ出せばよいことになります。また、ルールロジックが他のクラスに実装されておらず、<code>SalesTaxApplyRule</code>クラス内に閉じているので、<code>SalesTaxApplyRule</code>クラスだけを経過措置に関してロジック変更すれば良いことになります。変更が高速化し、 <strong>生産性が向上</strong> します。</p>

<h2>
<span id="internaljavaでいうpackage-privateの使用" class="fragment"></span><a href="#internaljava%E3%81%A7%E3%81%84%E3%81%86package-private%E3%81%AE%E4%BD%BF%E7%94%A8"><i class="fa fa-link"></i></a>internal(Javaでいうpackage private)の使用</h2>

<p>税抜き金額<code>AmountExcludingTax</code>や契約日<code>ContractDate</code>はView層での表示が想定されるため、可視性はpublicで設計しています。一方、消費税<code>SalesTax</code>や消費税適用ルール<code>SalesTaxApplyRule</code>は外部からアクセスされる必要性がないため、アクセスがパッケージ内だけで閉じるようinternalで設計しています。<br>
<strong>何でもかんでもpublicで定義してるのをプログラミング入門書で頻繁に見受けられます</strong>が、よく考えずに真似してしまうとpublic定義されたクラスはあらゆるクラスと関係し始めて影響範囲が拡大し、低凝集密結合を誘発する大きな要因となります。<br>
パッケージの粒度設計も然ることながら、クラスの可視性は基本的にinternalで設計し、パッケージ外に本当に公開が必要なクラスのみ、publicとして設計しましょう。(※なお、C#言語仕様では、クラスのアクセス修飾子を省略するとinternalになります。この意味をよく考えてみましょう。)</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<h2>
<span id="valueobject--完全コンストラクタ設計要件" class="fragment"></span><a href="#valueobject--%E5%AE%8C%E5%85%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E8%A8%AD%E8%A8%88%E8%A6%81%E4%BB%B6"><i class="fa fa-link"></i></a>ValueObject + 完全コンストラクタ　設計要件</h2>

<table>
<thead>
<tr>
<th style="text-align: left">設計要件</th>
<th style="text-align: left">理由</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">値そのものをクラス化すること。</td>
<td style="text-align: left">疎結合高凝集にするため。</td>
</tr>
<tr>
<td style="text-align: left">クラス名は値の名称であること。</td>
<td style="text-align: left">理解容易性向上のため。</td>
</tr>
<tr>
<td style="text-align: left">値を格納するインスタンス変数を(原則的に)1個用意すること。</td>
<td style="text-align: left">概念が異なる値と疎結合にするため。</td>
</tr>
<tr>
<td style="text-align: left">インスタンス変数への代入はコンストラクタ引数を介して行うこと。更に、代入前に不正値チェックし、不正値の場合例外をスローすること。</td>
<td style="text-align: left">正しい値を持ったインスタンスのみが存在できるようにするため。</td>
</tr>
<tr>
<td style="text-align: left">インスタンス変数にはreadonlyを付与し、不変にすること。</td>
<td style="text-align: left">並列処理に強くなるため。</td>
</tr>
<tr>
<td style="text-align: left">値を変更したい場合は、変更値を持ったインスタンスを新たに生成すること。その場合業務概念的に許される操作のみメソッドとして公開すること。</td>
<td style="text-align: left">不正な演算を防ぐため。</td>
</tr>
<tr>
<td style="text-align: left">業務概念を表す値は、可能な限り全てValueObjectで設計すること。</td>
<td style="text-align: left">概念の異なる値同士の取り違えを防ぐため。</td>
</tr>
<tr>
<td style="text-align: left">インスタンス生成の用途が複数ある場合、用途ごとにFactoryメソッドを用意し、コンストラクタをprivateにすること。</td>
<td style="text-align: left">利用側の不正なインスタンス生成を防ぐため。</td>
</tr>
<tr>
<td style="text-align: left">概念的に複雑なものは、ボトムアップでの設計を検討すること。</td>
<td style="text-align: left">トップダウンでは概念の洗い出しに漏れが生じやすい。概念を漏れなく洗い出して設計するため。</td>
</tr>
<tr>
<td style="text-align: left">名前が競合した場合、更にドメイン分析を重ね、名前のブラッシュアップを検討すること。</td>
<td style="text-align: left">理解容易性向上のため。</td>
</tr>
<tr>
<td style="text-align: left">リスト操作するロジックにはファーストクラスコレクションパターンを適用すること。</td>
<td style="text-align: left">リスト操作周りを単純化するため。</td>
</tr>
<tr>
<td style="text-align: left">クラスに登場する概念が4±1個以内になるよう設計すること。</td>
<td style="text-align: left">脳の負荷を下げ、混乱を避けるため。影響範囲低減のため。</td>
</tr>
<tr>
<td style="text-align: left">internalなどのアクセス修飾子を適切に使用すること。</td>
<td style="text-align: left">影響範囲低減のため。</td>
</tr>
</tbody>
</table>

<h2>
<span id="本記事の手法よる効果" class="fragment"></span><a href="#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AE%E6%89%8B%E6%B3%95%E3%82%88%E3%82%8B%E5%8A%B9%E6%9E%9C"><i class="fa fa-link"></i></a>本記事の手法よる効果</h2>

<ul>
<li>生産性向上</li>
<li>修正漏れ低減</li>
<li>クローンコード低減</li>
<li>未初期化状態の防止</li>
<li>不正値の防止</li>
<li>異なる概念の値混入抑止</li>
<li>インスタンス生成の安全性向上</li>
<li>リスト操作に関する複雑度低減</li>
<li>理解容易性向上</li>
<li>コードのトレーサビリティ向上</li>
</ul>

<h2>
<span id="基本ほど遠い道のり一歩ずつ極めていきませんか" class="fragment"></span><a href="#%E5%9F%BA%E6%9C%AC%E3%81%BB%E3%81%A9%E9%81%A0%E3%81%84%E9%81%93%E3%81%AE%E3%82%8A%E4%B8%80%E6%AD%A9%E3%81%9A%E3%81%A4%E6%A5%B5%E3%82%81%E3%81%A6%E3%81%84%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93%E3%81%8B"><i class="fa fa-link"></i></a>基本ほど遠い道のり、一歩ずつ極めていきませんか</h2>

<p>ValueObjectは1個たかだか数十行程度の規模ですが、大真面目にやろうとするといくつもの要件を満たすよう設計する必要があります。不慣れな方にとって、これら全てを満たすのはかなり骨の折れることになるでしょう。<br>
ですがValueObjectにはソフトウェア設計の基本が詰まっていると私は思っています。基本をひとつずつ踏み固め、一歩ずつ極めていくことで、高品質で高い開発生産性に繋がっていくことでしょう。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FMinoDriven%2Fitems%2F5e69d9bd028aa350e2c4&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FMinoDriven%2Fitems%2F5e69d9bd028aa350e2c4&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/MinoDriven/items/5e69d9bd028aa350e2c4/likers" class="css-1iupg5d">1022</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">847</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/5e69d9bd028aa350e2c4/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/MinoDriven/items/5e69d9bd028aa350e2c4/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/MinoDriven/items/5e69d9bd028aa350e2c4/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/MinoDriven/items/5e69d9bd028aa350e2c4/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/MinoDriven/items/5e69d9bd028aa350e2c4.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-3c72a3ed-eac1-4a91-9743-98cbdfd6a0a3">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-db241418-bb82-4ed2-99b1-a24596ea1ceb"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-db241418-bb82-4ed2-99b1-a24596ea1ceb">{}</script>
      
<div id="LoginModal-react-component-5da9d48b-8606-4876-9511-5debcf7f2c45"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-5da9d48b-8606-4876-9511-5debcf7f2c45">{}</script>
      
<div id="StockModal-react-component-52185381-54f7-4cd5-93ea-b1bfd3bf3e74"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-52185381-54f7-4cd5-93ea-b1bfd3bf3e74">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;EcuCdCemENZDOZ+HVbKSkEd4hkeeN1h34kBRbXkD/pgwzULvXKSL9/uleHcPojgiIeMbqH4kkK23D2fnG4W97w==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"概要\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e概要\u003c/h1\u003e\n\n\u003cp\u003e関連のあるロジックが膨大なソースコードの中のあちこちに書き殴られ、散在し、追うのが大変な低凝集クラス。別名「スパゲッティコード」とも呼ばれ、無関係なロジックと絡み合い、変更を難しくしているアイツ。\u003cbr\u003e\nそんな低凝集クラスの退治に有効な設計手法を紹介致します。\u003c/p\u003e\n\n\u003cp\u003e本記事の内容は \u003cstrong\u003eValueObject\u003c/strong\u003e パターンと \u003cstrong\u003e完全コンストラクタ\u003c/strong\u003e パターンを用いた品質向上の設計手法です。低凝集に徹底対抗するため、\u003cstrong\u003eかなりギッチギチに設計要件を詰め込んでいます。\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"本設計手法による効果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%AC%E8%A8%AD%E8%A8%88%E6%89%8B%E6%B3%95%E3%81%AB%E3%82%88%E3%82%8B%E5%8A%B9%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e本設計手法による効果\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e生産性向上\u003c/li\u003e\n\u003cli\u003e修正漏れ低減\u003c/li\u003e\n\u003cli\u003eクローンコード低減\u003c/li\u003e\n\u003cli\u003e未初期化状態の防止\u003c/li\u003e\n\u003cli\u003e不正値の防止\u003c/li\u003e\n\u003cli\u003e異なる概念の値混入抑止\u003c/li\u003e\n\u003cli\u003eインスタンス生成の安全性向上\u003c/li\u003e\n\u003cli\u003eリスト操作に関する複雑度低減\u003c/li\u003e\n\u003cli\u003e理解容易性向上\u003c/li\u003e\n\u003cli\u003eコードのトレーサビリティ向上\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"よくあるダメな例\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E3%83%80%E3%83%A1%E3%81%AA%E4%BE%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eよくあるダメな例\u003c/h1\u003e\n\n\u003cp\u003eまずはValueObjectを用いていない、架空のコードを例に説明致します。\u003cbr\u003e\nここではなるべく分かりやすいように、今ホットな消費税を例にします。\u003c/p\u003e\n\n\u003cp\u003e税込み金額と消費税率を単に格納するだけの契約金額クラスがあったとします。\u003cbr\u003e\n\u003cstrong\u003e(※以下サンプルコードはC#にて記述)\u003c/strong\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eContractAmount.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;契約金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eContractAmount\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eAmountIncludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003eSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e当然データの入れ物(以後\u003cstrong\u003eデータクラス\u003c/strong\u003eと呼称)だけでなく、税込み金額を計算するロジックが必要です。ここであまり設計を考えないと、この手の演算ロジックはデータクラスとは別のクラスに実装されることが多いです。以下のようにControllerに実装されることが多いのではないでしょうか。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eContractController.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;契約コントローラー\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eContractController\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eContractAmount\u003c/span\u003e \u003cspan class=\"n\"\u003e_contractAmount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税込金額を計算する。\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"amountExcludingTax\"\u0026gt;税別金額。\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"salesTaxRate\"\u0026gt;消費税率。\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;税込金額。\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalculateAmountIncludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003esalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1.0\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003esalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;契約締結する。\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConclude\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 省略\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eamountIncludingTax\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eCalculateAmountIncludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_contractAmount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractAmount\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_contractAmount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAmountIncludingTax\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eamountIncludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_contractAmount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSalesTaxRate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 省略\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eクラス図にすると以下の関係となります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/63159b5dd3ceb6f86d202bd3880b063bc4cceb23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f37653862356530652d663631362d366136302d626135362d6464363161363732363532382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"200\" alt=\"tax_uml_01.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F7e8b5e0e-f616-6a60-ba56-dd61a6726528.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f61957d14cdfcc986f6d736c6a1876a5\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/7e8b5e0e-f616-6a60-ba56-dd61a6726528.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F7e8b5e0e-f616-6a60-ba56-dd61a6726528.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=bc389ef9b4d06e6f30becb4ba7d3a28c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eごく小規模なアプリであれば、この設計は特に問題にはならないでしょう。しかし大規模になるにつれ、この設計は様々な問題をはらむようになってきます。\u003cbr\u003e\nどんな問題が起こるのか順番に見ていきましょう。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"課題\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"課題1低凝集\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C1%E4%BD%8E%E5%87%9D%E9%9B%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題1：低凝集\u003c/h2\u003e\n\n\u003cp\u003eアプリが大きくなってきても、相変わらずデータを保持する場所(データクラス)とデータを操作するロジックを別々箇所に実装しているとどうなるでしょうか。\u003cbr\u003e\n例えば下記クラス図のように、消費税関連の演算メソッドが様々なContollerに定義されている場合はどうでしょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ebba3846361bb53bb66dfbfb6a72f53bcd813e1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f66336331323562342d323164362d666463332d376530352d6132363933313236393132382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"526\" alt=\"tax_uml_02.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Ff3c125b4-21d6-fdc3-7e05-a26931269128.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7cb50d5837dfca6b71c4b40555d7efbd\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/f3c125b4-21d6-fdc3-7e05-a26931269128.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Ff3c125b4-21d6-fdc3-7e05-a26931269128.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5ac9a690d88df8d07baf69075ae6f507 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e消費税関連のロジックが様々な箇所に分散してしまっていますね。\u003cbr\u003e\nこのように関連するデータやロジック同士が分散してしまっているのを \u003cstrong\u003e低凝集\u003c/strong\u003e と言います。低凝集なコードではどんな課題が発生するのか以下に列挙します。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"課題1-1生産性低下\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C1-1%E7%94%9F%E7%94%A3%E6%80%A7%E4%BD%8E%E4%B8%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題1-1：生産性低下\u003c/h3\u003e\n\n\u003cp\u003e上図はまだなんとか関連を把握できますが、これが何千何万行のソースコードに分散すると、全て探し出すだけで一苦労で、時間と精神力をいたずらに消耗することになります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"課題1-2修正漏れ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C1-2%E4%BF%AE%E6%AD%A3%E6%BC%8F%E3%82%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題1-2：修正漏れ\u003c/h3\u003e\n\n\u003cp\u003eまた、関連コードを全て探し出せるとは限りません。漏れが生じる可能性もあります。仮に洗い出しに漏れが生じると、消費税関連のバグが発生します。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"課題1-3コードクローンコピペコード\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C1-3%E3%82%B3%E3%83%BC%E3%83%89%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%B3%E3%82%B3%E3%83%94%E3%83%9A%E3%82%B3%E3%83%BC%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題1-3：コードクローン（コピペコード）\u003c/h3\u003e\n\n\u003cp\u003eあらゆる箇所に分散していると把握が困難になります。例えば既に実装済みの機能があるのに、別の開発メンバに「この機能は未実装だ」と誤解される恐れがあり、同じようなロジックが至るところに複数実装されることになります。意図せずコードクローンが量産されることになります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"課題2不正状態\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C2%E4%B8%8D%E6%AD%A3%E7%8A%B6%E6%85%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題2：不正状態\u003c/h2\u003e\n\n\u003cp\u003e課題1で挙げた低凝集に付随して、データクラス\u003ccode\u003eContractAmount\u003c/code\u003eは以下に示す不正状態へ陥る可能性があります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"課題2-1未初期化状態生焼けオブジェクト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C2-1%E6%9C%AA%E5%88%9D%E6%9C%9F%E5%8C%96%E7%8A%B6%E6%85%8B%E7%94%9F%E7%84%BC%E3%81%91%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題2-1：未初期化状態（生焼けオブジェクト）\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003eContractAmount\u003c/code\u003eクラスは、newされた直後はインスタンス変数の初期化が済んでいません。\u003ccode\u003eContractController\u003c/code\u003eで\u003ccode\u003eConclude()\u003c/code\u003eが実行されるまでは不完全な状態、即ち不正状態です。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eConclude()\u003c/code\u003eがコールされる前に\u003ccode\u003eContractAmount\u003c/code\u003eインスタンスが何かに利用されるとバグになります。\u003cbr\u003e\nこのように初期化が済んでおらず、使い物になってないオブジェクト、または未初期化状態を発生しうるオブジェクトを、アンチパターン \u003cstrong\u003e生焼けオブジェクト\u003c/strong\u003e と言います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"課題2-2不正値の混入\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C2-2%E4%B8%8D%E6%AD%A3%E5%80%A4%E3%81%AE%E6%B7%B7%E5%85%A5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題2-2：不正値の混入\u003c/h3\u003e\n\n\u003cp\u003eその他、消費税率に負数を代入するなど、不正値を与えることも容易に出来てしまいます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econtractAmount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractAmount\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"n\"\u003econtractAmount\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSalesTaxRate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e0.10\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"課題まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題まとめ\u003c/h2\u003e\n\n\u003cp\u003e以上、低凝集であることにより以下の課題が発生します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e生産性低下\u003c/li\u003e\n\u003cli\u003e修正漏れ\u003c/li\u003e\n\u003cli\u003eコードクローン\u003c/li\u003e\n\u003cli\u003e未初期化状態（生焼けオブジェクト）\u003c/li\u003e\n\u003cli\u003e不正値混入\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e単にデータを保持するだけの、なんら処理ロジックを持たない \u003cstrong\u003eデータクラス\u003c/strong\u003e は低凝集です。上記種々の問題を誘発させる \u003cstrong\u003eアンチパターン「ドメインモデル貧血症」\u003c/strong\u003e であり、 \u003cstrong\u003e悪\u003c/strong\u003e なのです(※CQRSパターンのQuery層でDTOとして利用するのは別の話)。\u003cbr\u003e\nこうした問題を発生させないための設計方法が、これから紹介する \u003cstrong\u003eValueObject\u003c/strong\u003e 、及び \u003cstrong\u003e完全コンストラクタ\u003c/strong\u003e です。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"valueobject\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#valueobject\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eValueObject\u003c/h1\u003e\n\n\u003cp\u003eValueObjectとはデータのラッパーであり、正確には\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e(原則的に)1個のインスタンス変数\u003c/li\u003e\n\u003cli\u003eインスタンス変数を初期化するコンストラクタ\u003c/li\u003e\n\u003cli\u003eインスタンス変数を\u003cstrong\u003e正常に操作することを保証した\u003c/strong\u003eメソッド\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eから構成されるクラスです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/cc499d370f59e5a00b8526ed673084fc7376950d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f62353165653362332d376332372d373731302d383136352d3063383337613565663564612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"113\" alt=\"tax_uml_03.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fb51ee3b3-7c27-7710-8165-0c837a5ef5da.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f0bcc3502215080c00a3ff3e24da7729\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/b51ee3b3-7c27-7710-8165-0c837a5ef5da.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fb51ee3b3-7c27-7710-8165-0c837a5ef5da.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=cd448e463a003d4a4b9fc4d51e1b824c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e値を単なる変数として実装するのではなく、クラスというひとつの型の単位として扱う、という考えに基づきます。\u003cbr\u003e\nでは税抜き金額をValueObjectとして扱うことを例に考えてみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税抜き金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAmountExcludingTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 初期値はコンストラクタで与える\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 税抜き金額1000円\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまずは基本形。ここから全てがスタートします。\u003cbr\u003e\n税抜き金額の値をコンストラクタで与え、インスタンス変数に格納します。\u003cbr\u003e\nしかしここまではアンチパターンである \u003cstrong\u003eデータクラス\u003c/strong\u003e とあまり変わらないように見えますね。\u003cbr\u003e\n事実、以下のように不正値を混入可能です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 負の金額、即ち不正値を代入できてしまう。\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(-\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eどうすれば良いでしょうか。これを解決するのが \u003cstrong\u003e完全コンストラクタ\u003c/strong\u003e です。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"完全コンストラクタ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%8C%E5%85%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e完全コンストラクタ\u003c/h1\u003e\n\n\u003cp\u003eオブジェクトを「  \u003cstrong\u003enewした時点で正しく利用可能な、即ち完全体\u003c/strong\u003e 」となるよう適切な初期化ロジックをコンストラクタに実装する方法です。\u003cbr\u003e\n税抜き金額のあるべき姿、要件を考えてみましょう。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e0以上の整数であること\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eとなりますね。この要件を満たすもののみインスタンス変数に格納するようフィルタリングすれば良いのです。要件未達の値は例外を投げるよう実装します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税抜き金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAmountExcludingTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// コンストラクタで不正値を除外\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsValid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 税抜き金額のバリデーションを用意\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eIsValid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 正常値の要件を記述\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで正常値のみインスタンス変数に格納できるようになりました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"生まれながらにして完全体\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%94%9F%E3%81%BE%E3%82%8C%E3%81%AA%E3%81%8C%E3%82%89%E3%81%AB%E3%81%97%E3%81%A6%E5%AE%8C%E5%85%A8%E4%BD%93\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e生まれながらにして完全体\u003c/h2\u003e\n\n\u003cp\u003e完全コンストラクタは更に利点があります。不正値が渡されるとコンストラクタで例外をスローするので、 \u003cstrong\u003e不正値を持ったAmountExcludingTaxのインスタンスが存在できなくなります\u003c/strong\u003e 。常に安全で正常なインスタンスのみが存在し、利用できるようになります。\u003cbr\u003e\n完全コンストラクタで設計したクラスのインスタンスは、 \u003cstrong\u003e生まれながらにして完全体\u003c/strong\u003e なのです。誕生した瞬間 \u003cstrong\u003eセル完全体\u003c/strong\u003e なのです。\u003c/p\u003e\n\n\u003cp\u003e一方不正値が混入すると例外をスローしAmountExcludingTaxのインスタンスが存在できなくなくなるので、 \u003cstrong\u003e不完全な\u003c/strong\u003e セル第１形態や第２形態は \u003cstrong\u003e誕生前に即死\u003c/strong\u003e することになります。これはスゴイ！！\u003c/p\u003e\n\n\u003cp\u003eValueObjectと完全コンストラクタを利用せずに変数に対してバリデーションをかけることも当然可能ですが、ただの変数の場合、後から不正値を再代入できてしまう点において劣ります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"setterを用意しない\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#setter%E3%82%92%E7%94%A8%E6%84%8F%E3%81%97%E3%81%AA%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003esetterを用意しない\u003c/h2\u003e\n\n\u003cp\u003e再代入を容易に許すと折角完全コンストラクタで確保した安全があっさり崩れてしまいます。従ってsetterを用意してはいけません。\u003cbr\u003e\ngetterのみ用意するようにしましょう(※より良い設計ではgetterすらない方が良い、後述)。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税抜き金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAmountExcludingTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// getterのみ用意する(※より良い設計ではgetterすら用意しない)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"immutable不変にする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#immutable%E4%B8%8D%E5%A4%89%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eimmutable(不変)にする\u003c/h2\u003e\n\n\u003cp\u003e内部のインスタンス変数が変更可能な状態にあると、並列処理などにおいていつの間にか値がすり替わっているなど意図しない副作用が発生する可能性があります。より安全に倒すため、ValueObjectは不変にしましょう。インスタンス変数に\u003ccode\u003ereadonly\u003c/code\u003e(Javaでいうfinal修飾子)を付与します。これでコンストラクタで初期化以後、変更できなくなります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税抜き金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAmountExcludingTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// これでコンストラクタ以後書き換えられなくなり、不変となる。\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"超重要許可された操作のみメソッド化する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%B6%85%E9%87%8D%E8%A6%81%E8%A8%B1%E5%8F%AF%E3%81%95%E3%82%8C%E3%81%9F%E6%93%8D%E4%BD%9C%E3%81%AE%E3%81%BF%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%8C%96%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e【！超重要！】許可された操作のみメソッド化する\u003c/h2\u003e\n\n\u003cp\u003eさて、不変にしたところで値を変更したい場合どうすればいいでしょう。\u003cbr\u003e\n例えば税抜き金額同士で加算したいケースがよくあるでしょう。その場合、加算結果を格納した新たなValueObjectのインスタンスを生成するよう設計します。ここでは加算メソッド\u003ccode\u003eAdd\u003c/code\u003eを用意してみました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税抜き金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAmountExcludingTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 省略\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eAmountExcludingTax\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAmountExcludingTax\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 税抜き金額同士を加算する。\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 引数には同じAmountExcludingTaxだけ渡せるよう設計。\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_amount\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 省略\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 使用例\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eamount1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eamount2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etotal\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eamount1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eamount2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etotal\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 110が出力される\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれにより元のインスタンスの不変を維持したまま変更値を用意可能です。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e但し要注意です。\u003c/strong\u003e\u003cbr\u003e\n金額同士の加算は用途上考えられますが、乗算はないはずです。税抜き金額がValueObjectではなく単なるローカル変数である場合を考えてみて下さい。乗算どころか\u003cstrong\u003eどんな計算でも制約なく出来てしまいます\u003c/strong\u003e。\u003cbr\u003e\n金額ならば加算や減算だけなど、業務概念的に許可された操作だけをメソッドとして公開することで、\u003cstrong\u003e不正な演算を許さない\u003c/strong\u003e、頑強な設計となります。\u003cbr\u003e\nこの設計思想からするとgetterで値取得可能な構造は、取得先の外部で勝手な演算が出来てしまうので、可能な限りgetterを実装しないのが望ましい姿です。但し、getterがないとUI表示や永続化の際値が取れなくなるので、バランス取りが難しいところです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"全てのクラスに備わる自己防衛責務\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%85%A8%E3%81%A6%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E5%82%99%E3%82%8F%E3%82%8B%E8%87%AA%E5%B7%B1%E9%98%B2%E8%A1%9B%E8%B2%AC%E5%8B%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e全てのクラスに備わる「自己防衛責務」\u003c/h2\u003e\n\n\u003cp\u003e「詳細な初期化処理や事前準備をしないと使い物にならない」……あなたはこんなクラスやメソッドを使いたいと思いますか？\u003cbr\u003e\nそもそもの話として、ソフトウェアはメソッド、クラス、モジュール、どの粒度でも、それ \u003cstrong\u003e自体が単体で\u003c/strong\u003e バグがなく \u003cstrong\u003eいつでも安全に\u003c/strong\u003e 利用できる品質が求められます。\u003cbr\u003e\nクラスも各々が他に依存することなく単体で安全に利用できるよう設計されている必要があります。他のクラスに初期化して貰ったり、バリデートして貰っているようなクラスは未熟なクラスです。 \u003cstrong\u003e自分の身は自分で守らせる\u003c/strong\u003e 。 \u003cstrong\u003e自己防衛責務\u003c/strong\u003e を \u003cstrong\u003e全てクラスが備える\u003c/strong\u003e 、という考え方がソフトウェア品質を考える上で重要です。完全コンストラクタはその方針を設計に落としたもののひとつです。\u003cbr\u003e\n構成部品であるクラスひとつひとつが品質的に完結していることにより、ソフトウェア全体の品質が向上するのです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"課題は解決されたか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C%E3%81%AF%E8%A7%A3%E6%B1%BA%E3%81%95%E3%82%8C%E3%81%9F%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題は解決されたか？\u003c/h1\u003e\n\n\u003cp\u003eValueObjectと完全コンストラクタの基本は以上になります。\u003cbr\u003e\nさて、この記事の冒頭で低凝集による種々の課題を列挙しましたが、解決されたのでしょうか？\u003cbr\u003e\n今一度\u003ccode\u003eAmountExcludingTax\u003c/code\u003eのクラス図とソースコードを見てみましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/6746bf5bc863d53607122cfa2e55b4cfd88958d3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f31383636306233362d326235642d623136302d633463312d3237383337363665613533382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"182\" alt=\"tax_uml_04.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F18660b36-2b5d-b160-c4c1-2783766ea538.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=179b970c996af8a93babfa1d2411668e\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/18660b36-2b5d-b160-c4c1-2783766ea538.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F18660b36-2b5d-b160-c4c1-2783766ea538.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e5e13fe5bb01a7c576f1d475a34f7e50 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税抜き金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAmountExcludingTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;コンストラクタ\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"amount\"\u0026gt;税抜き金額\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsValid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税抜き金額を加算する\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"amountExcludingTax\"\u0026gt;税抜き金額\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;税抜き金額\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eAmountExcludingTax\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAmountExcludingTax\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_amount\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;有効な税抜き金額であるかを返す\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"amount\"\u0026gt;税抜き金額\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;有効な場合true\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eIsValid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e税抜き金額の単なるデータだけでなく、許容値や演算メソッド(\u003ccode\u003eAdd\u003c/code\u003e)など、関連するロジックが凝集しているのがお分かり頂けますでしょうか。このようにデータとそれを処理するロジックが分散せず、一箇所に集められカプセル化されているのを \u003cstrong\u003e高凝集\u003c/strong\u003e と呼びます。\u003cbr\u003e\nでは低凝集で生じる課題がどう解決されたか説明します。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e課題\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e解決\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e生産性低下\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e税抜き金額に関する定義はAmountExcludingTaxのみを見れば良い。他を探し回る労苦から解放され、生産性が向上する。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e修正漏れ\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e税抜き金額に関して仕様変更が発生した場合、原則的にAmountExcludingTaxのみを修正すれば良い。修正漏れが生じにくい。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eコードクローン\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e「税抜き金額に関する仕様はAmountExcludingTax内にのみ実装されている」「税抜き金額はAmountExcludingTaxインスタンスとして扱う」と約束付けることでクローンが発生しにくくなる。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e未初期化状態\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e完全コンストラクタによりnewした時点で正常に初期化。未初期化な状態がそもそも存在しなくなる。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e不正値混入\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e完全コンストラクタのバリデーションにより不正値を持ったインスタンスが存在できなくなる。\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"更に発展応用させる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9B%B4%E3%81%AB%E7%99%BA%E5%B1%95%E5%BF%9C%E7%94%A8%E3%81%95%E3%81%9B%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e更に発展応用させる\u003c/h1\u003e\n\n\u003cp\u003e以上がValueObjectの基本となります。上記だけでもかなりの設計要件が登場しましたが、更に様々なパターンに対応し応用できるよう発展させていきます。\u003c/p\u003e\n\n\u003cp\u003e以下では、 \u003cstrong\u003e税込み金額\u003c/strong\u003e の計算を題材に、ValueObjectパターンに関し更に深堀りしていきます。ぶっちゃけ税込み金額は「税抜き金額 x 消費税率」で算出できてしまうのですが、消費税率の適用ルール周りには様々な要件や業務知識が存在するので、そうした概念を踏まえた上で堅牢な設計をしていきます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"消費税率をvalueobject化してみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E3%82%92valueobject%E5%8C%96%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e消費税率をValueObject化してみる\u003c/h1\u003e\n\n\u003cp\u003eまずは消費税率をValueObjectとして設計してみます。\u003cbr\u003e\nとりあえず税抜き金額\u003ccode\u003eAmountExcludingTax\u003c/code\u003eと同様に、初期値をコンストラクタで与える形で作ってみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税率\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSalesTaxRate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsValid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eIsValid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e一応それらしいものができました。…ですがこれで良いのでしょうか？\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"再燃する課題低凝集\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%86%8D%E7%87%83%E3%81%99%E3%82%8B%E8%AA%B2%E9%A1%8C%E4%BD%8E%E5%87%9D%E9%9B%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e再燃する課題…低凝集\u003c/h2\u003e\n\n\u003cp\u003e消費税率の値は、商品を購入した日時によって決まります。また、その値も固定です(例えば2019/10/01より10%)。ですが、この設計ではコンストラクタから任意の税率を代入できてしまいますし、そもそも税率を決定するロジックが存在しません。そのロジックはどこに実装されるのでしょうか。前の例のようにControllerクラスに実装されるのでしょうか。するとまた低凝集な設計になり、生産性低下など様々な問題を生み出してしまいます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"凝集しよう--完全コンストラクタのおさらい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%87%9D%E9%9B%86%E3%81%97%E3%82%88%E3%81%86--%E5%AE%8C%E5%85%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%81%AE%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e凝集しよう － 完全コンストラクタのおさらい\u003c/h2\u003e\n\n\u003cp\u003e振り返ってみましょう。「 \u003cstrong\u003enewした段階で使い物になるようにコンストラクタ内で初期化処理を完結する\u003c/strong\u003e 」というのが完全コンストラクタの主旨です。つまり、 \u003cstrong\u003e日付により消費税率を決めるロジックを消費税率クラスのコンストラクタ内に定義する\u003c/strong\u003e のが自然、と考えられます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"消費税率周りのドメイン分析\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E5%91%A8%E3%82%8A%E3%81%AE%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%88%86%E6%9E%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e消費税率周りのドメイン分析\u003c/h2\u003e\n\n\u003cp\u003eではどのように消費税率の値が決められるのか、一度消費税率に関する業務知識を確認してみましょう。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e消費税は施行日がある。法によって定められた \u003cstrong\u003e消費税施行日\u003c/strong\u003e 以降に \u003cstrong\u003e当該消費税率\u003c/strong\u003e が適用される。\u003c/li\u003e\n\u003cli\u003e売買契約が締結した時点の消費税率を適用する。\u003c/li\u003e\n\u003cli\u003eつまり、 \u003cstrong\u003e契約日\u003c/strong\u003e が所定の \u003cstrong\u003e消費税施行日\u003c/strong\u003e 以降である場合、 \u003cstrong\u003e当該税率\u003c/strong\u003e が適用される。\u003c/li\u003e\n\u003cli\u003e（※経過措置など難しい概念もあるが今回は割愛）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eここでいくつか重要そうな概念が洗い出されました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e消費税施行日（固定）\u003c/li\u003e\n\u003cli\u003e消費税率（固定）\u003c/li\u003e\n\u003cli\u003e契約日（任意）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eつまり契約日が決まってしまえば、あとは消費税施行日と照らし合わせて消費税率が決まる仕組みですね。「消費税率は契約日により一意に決まる」、ということが分かりました。\u003cbr\u003e\nつまり、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eコンストラクタで契約日を受け取る。\u003c/li\u003e\n\u003cli\u003eコンストラクタ内で契約日と消費税施行日を比較して消費税率を決定する。\u003c/li\u003e\n\u003cli\u003e得られた消費税率の値をインスタンス変数へ格納する。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eというロジックになれば良さそうです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税率\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSalesTaxRate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 省略するがここで契約日と消費税施行日とを比較し、消費税率を決定する。\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 決定した税率値を代入\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e税抜き金額\u003ccode\u003eAmountExcludingTax\u003c/code\u003eは、金額値をコンストラクタで受け取っていました。それはUIから任意金額値を入力するユースケースから考えても自然です。一方で、消費税率クラスのようにコンストラクタ引数の値が同一概念の値とは限りません。\u003cbr\u003e\n \u003cstrong\u003e何に依存してその値が決定するのか、しっかりドメイン分析することが肝要\u003c/strong\u003e です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"契約日の扱い\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A5%91%E7%B4%84%E6%97%A5%E3%81%AE%E6%89%B1%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e契約日の扱い\u003c/h2\u003e\n\n\u003cp\u003eところで消費税率クラスのコンストラクタ引数となる契約日は、ただのDateTime型で良いのでしょうか？ものによりますが、アプリで扱われる日時は、例えば生年月日、注文日など多種にわたるでしょう。例えば以下のようなコードは許されるのでしょうか。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebirthday\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esalesTaxRate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e契約日に誕生日を代入してしまっており、どう見てもバグとなりますね。\u003cbr\u003e\nここでも役立つのがValueObjectです。\u003cbr\u003e\n契約日をValueObjectとして設計し、コンストラクタ引数を契約日の型にすれば、異なる概念の値が混入してしまうのを防ぐことができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;契約日\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eContractDate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003e_date\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 省略\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税率\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSalesTaxRate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 省略\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebirthday\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eBirthday\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1990\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esalesTaxRate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebirthday\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 型が異なるのでコンパイルが通らない\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"あらゆる値をvalueobjectとして設計する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%82%E3%82%89%E3%82%86%E3%82%8B%E5%80%A4%E3%82%92valueobject%E3%81%A8%E3%81%97%E3%81%A6%E8%A8%AD%E8%A8%88%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eあらゆる値をValueObjectとして設計する\u003c/h2\u003e\n\n\u003cp\u003eドメイン駆動設計のようにドメイン層を設ける設計であれば、ドメイン層では \u003cstrong\u003eどんな値もなるべく全てValueObject\u003c/strong\u003e で扱った方が良いです。そして \u003cstrong\u003eプリミティブな型ではなくValueObject型\u003c/strong\u003e でやり取りし、 \u003cstrong\u003e全てのValueObjectで異なる型の代入を弾く設計実装\u003c/strong\u003e すれば、 \u003cstrong\u003e異なる概念の値混入に対して非常に強固な作り\u003c/strong\u003e になります。\u003cbr\u003e\nちなみに私の以前の開発現場では、こうした異なる概念の値混入によるバグがたびたび発生していました。一度に多くのパラメータを取り扱うユースケースで特に起こっていました。こうしたつまらないバグにつまづかないよう、こまめにValueObject化することが肝要だと考えます。\u003c/p\u003e\n\n\u003cp\u003eここまでの検討により、インターフェースはだいたい決まりました。\u003cbr\u003e\n一度クラス図を起こします。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/870edb0efab140aca4cfe745349cc3e97d522c71/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f61333731613263392d316233332d346664622d323130352d3536623033643363303039342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"339\" alt=\"tax_uml_05.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fa371a2c9-1b33-4fdb-2105-56b03d3c0094.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f6fd84fa54a29fc16b9e7c5b516ae484\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/a371a2c9-1b33-4fdb-2105-56b03d3c0094.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fa371a2c9-1b33-4fdb-2105-56b03d3c0094.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=cbb35f1c322e8707ef5689e102baff3a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこのクラス構成に基づき、設計実装の細部を詰めていきます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"契約日クラス\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A5%91%E7%B4%84%E6%97%A5%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e契約日クラス\u003c/h1\u003e\n\n\u003cp\u003e契約日クラスを設計していきます。\u003cbr\u003e\n初期値を決めたいのですが、コンストラクタ引数で初期値となるDateTime型を渡してよいのでしょうか？低凝集の不安がありますね。一度ドメイン分析しましょう。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e売買契約が締結した日時である。\u003c/li\u003e\n\u003cli\u003e永続化対象である。(※本来ドメイン分析で考慮すべきことではない)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eまず締結日時ですが、締結したときに任意DateTimeを利用側から与えられるのではなく、契約日クラス側で決めてしまった方が良いですね。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;契約日\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eContractDate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003e_date\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_date\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNow\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまた、契約日は永続化対象なので、リポジトリから読み出した値を格納できるようにクチを設けておく必要があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;契約日\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eContractDate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003e_date\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 契約締結時に呼び出す用\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_date\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNow\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// リポジトリからの読み出し用\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_date\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eところでコンストラクタが複数あります。コメントで説明はしていますが、利用側からはどちらのコンストラクタが何の用途か非常に分かりにくいものなってしまいます。どうすれば良いのでしょうか。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"factoryメソッドprivateコンストラクタ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#factory%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89private%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFactoryメソッド＋privateコンストラクタ\u003c/h2\u003e\n\n\u003cp\u003eこういう場合、用途ごとのFactoryメソッドを用意します。各Factoryメソッドには、用途に相応しい命名をします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;契約日\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eContractDate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003e_date\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_date\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 制約を無視した勝手なインスタンス生成を利用側にされないようprivateにする\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_date\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 契約締結時に呼び出す用\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"nf\"\u003eConclude\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNow\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// リポジトリからの読み出し用\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// リポジトリ以外からの生成に利用されないようinternalにする\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"nf\"\u003eReconstruct\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eそしてコンストラクタはprivateにします。こうすることで契約日ContractDateの \u003cstrong\u003e生成方法を用途別に縛る\u003c/strong\u003e ことができます。 \u003cstrong\u003eクラス設計者の予想だにしない使われ方をさせない\u003c/strong\u003eことも、安全性を高める上で重要です。また、リポジトリから読み出した場合に用いられる\u003ccode\u003eReconstruct()\u003c/code\u003eはinternalにすることでパッケージ内のみアクセス可能になり、アプリ層やView層などからコールされることがなくなります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"消費税率適用ルールの設計\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E9%81%A9%E7%94%A8%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E8%A8%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e消費税率適用ルールの設計\u003c/h1\u003e\n\n\u003cp\u003e先ほど「消費税率を決定するロジックを消費税率クラスのコンストラクタに定義する」と書きました。しかし「消費税施行日」など様々な概念が絡んでいそうです。単純に実装しただけでは \u003cstrong\u003e複雑度が増大し、保守が難しくなりそう\u003c/strong\u003e なので、小分けにしてボトムアップで考えていくことにします。\u003c/p\u003e\n\n\u003cp\u003e以下のようなロジックを元に考えてみます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e消費税施行日とその適用税率をリストで持っておく。\u003c/li\u003e\n\u003cli\u003e消費税施行日が最新のものから順に契約日と比較する。契約日が消費税施行日以降であれば、その税率を適用する。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"消費税クラス\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e消費税クラス\u003c/h2\u003e\n\n\u003cp\u003e消費税に関しては、施行日と税率がセットになっているので、一緒にしてしまって良さそうです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSalesTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;施行日\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003e_enforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税率\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsValidRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_enforcementDate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eIsValidRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"名前がカブった\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%90%8D%E5%89%8D%E3%81%8C%E3%82%AB%E3%83%96%E3%81%A3%E3%81%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e名前がカブった？？\u003c/h2\u003e\n\n\u003cp\u003eちょっと話が外れますが、先ほど消費税率クラスを\u003ccode\u003eSalesTaxRate\u003c/code\u003eと命名しました。一方、上述の消費税クラス、インスタンス変数に\u003ccode\u003e_rate\u003c/code\u003eがいます。\u003ccode\u003eSalesTax._rate\u003c/code\u003eと\u003ccode\u003eSalesTaxRate\u003c/code\u003e、なんだか紛らわしいですね。どうも概念的に微妙に違っていそうです。命名をブラッシュアップしてみましょう。\u003cbr\u003e\nそもそも消費税率クラスは一体何なのでしょうか。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税率\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSalesTaxRate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// コンストラクタで契約日を受け取る\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ここで契約日と消費税施行日とを比較し、消費税率を決定する。\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e契約日により税率を決定しています。つまり完全コンストラクタの設計思想に基づけば、これは「契約日に \u003cstrong\u003e適用された税率\u003c/strong\u003e 」なのです。すると冒頭の消費税率クラスは「 \u003cstrong\u003e適用された消費税率\u003c/strong\u003e 」と名付けた方がより適切ですね。\u003ccode\u003eSalesTaxRate\u003c/code\u003eから\u003ccode\u003eAppliedSalesTaxRate\u003c/code\u003eへ \u003cstrong\u003e命名をブラッシュアップ\u003c/strong\u003e します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;適用された消費税率\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAppliedSalesTaxRate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// コンストラクタで契約日を受け取る\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAppliedSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ここで契約日と消費税施行日とを比較し、消費税率を決定する。\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e完全コンストラクタで設計したクラスの名前は「○○された△△」、「〜ed△△」というように、何かによって完成品 \u003cstrong\u003eとなった\u003c/strong\u003e 命名をするのが望ましいです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"消費税適用ルールクラス\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E9%81%A9%E7%94%A8%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e消費税適用ルールクラス\u003c/h2\u003e\n\n\u003cp\u003e消費税クラス\u003ccode\u003eSalesTax\u003c/code\u003eを用いて、消費税適用ルール\u003ccode\u003eSalesTaxApplyRule\u003c/code\u003eを設計します。\u003cbr\u003e\n上述の通り、「消費税の施行日と税率を消費税クラスとしてリストで持っておき、施行日が最新のものから順番に契約日と比較して、契約日が施行日以降であればその税率を適用する」としましょう。\u003cbr\u003e\n下記コードのようにコンストラクタでリスト生成して、\u003ccode\u003eApplyRule()\u003c/code\u003eで適用税率を返します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税適用ルール\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSalesTaxApplyRule\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 最新の施行日から順に格納すること。\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// (開発者が順番を気にしなくても良いように設計するのがホントは望ましい)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2019\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.10\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2014\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.08\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1997\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.05\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1989\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.03\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"nf\"\u003eApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecorresponded\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etax\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnforcementDate\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ecorresponded\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003ecorresponded\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRate\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.00\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eちなみにこの\u003ccode\u003eSalesTaxApplyRule\u003c/code\u003eの設計はValueObjectパターンの亜種で、リストに対しての業務ロジックをカプセル化する設計パターン「 \u003cstrong\u003eファーストクラスコレクション\u003c/strong\u003e 」といいます。リスト操作は兎角ネスト構造になりがちでコードが \u003cstrong\u003e複雑化\u003c/strong\u003e しやすいので、是非覚えて下さい。 \u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"適用された消費税率クラスへ組み込み\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%81%A9%E7%94%A8%E3%81%95%E3%82%8C%E3%81%9F%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%B8%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「適用された消費税率」クラスへ組み込み\u003c/h2\u003e\n\n\u003cp\u003eここまでくれば税適用ルール\u003ccode\u003eSalesTaxApplyRule\u003c/code\u003eを\u003ccode\u003eAppliedSalesTaxRate\u003c/code\u003eへ組み込むことができますね。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;適用された消費税率\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAppliedSalesTaxRate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 税適用ルールは1つあれば良く、複数生成させないようstatic readonlyとする。\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eSalesTaxApplyRule\u003c/span\u003e \u003cspan class=\"n\"\u003e_salesTaxApplyRule\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAppliedSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_salesTaxApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"税込み金額クラス\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%A8%8E%E8%BE%BC%E3%81%BF%E9%87%91%E9%A1%8D%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e税込み金額クラス\u003c/h1\u003e\n\n\u003cp\u003e最後に税込み金額クラスです。\u003cbr\u003e\nこれもValueObject+完全コンストラクタで設計します。\u003cbr\u003e\n税抜き金額クラスと適用された消費税率クラスのインスタンスを渡し、税込み金額を計算し格納します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税込金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAmountIncludingTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountIncludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eAmountExcludingTax\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eAppliedSalesTaxRate\u003c/span\u003e \u003cspan class=\"n\"\u003eappliedSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eappliedSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで目標である税込み金額クラスを設計できました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おさらい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおさらい\u003c/h1\u003e\n\n\u003cp\u003e最終的なクラス図とソースコードです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/0d6f2846591f54c0f2b5f2e6f909a81714475be7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3339333030302f35306465613730382d666561622d303365382d363562332d3133393131633562393636302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg width=\"508\" alt=\"tax_uml_06.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F50dea708-feab-03e8-65b3-13911c5b9660.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b591072bebc04626bbdf7bfcd1690b5b\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/50dea708-feab-03e8-65b3-13911c5b9660.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2F50dea708-feab-03e8-65b3-13911c5b9660.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=ff958213099536d3dad1164e0e5b5fc3 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eAmountExcludingTax.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税抜き金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAmountExcludingTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;コンストラクタ\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"amount\"\u0026gt;税抜き金額\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsValid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税抜き金額を加算する\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"amountExcludingTax\"\u0026gt;税抜き金額\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;税抜き金額\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eAmountExcludingTax\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAmountExcludingTax\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_amount\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;有効な税抜き金額であるかを返す\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"amount\"\u0026gt;税抜き金額\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;有効な場合true\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eIsValid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eamount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eContractDate.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;契約日\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eContractDate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003e_date\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_date\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;コンストラクタ\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"date\"\u0026gt;契約日\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;remarks\u0026gt;制約を無視した勝手なインスタンス生成を利用側にされないようprivateにしている。\u0026lt;/remarks\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_date\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;契約締結時に呼び出す。\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;契約日\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"nf\"\u003eConclude\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNow\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;リポジトリから読み出した時に呼び出す。\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"date\"\u0026gt;リポジトリから読み出した契約日\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;契約日\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;remarks\u0026gt;リポジトリ以外からの生成に利用されないようinternalにしている。\u0026lt;/remarks\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"nf\"\u003eReconstruct\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSalesTax.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSalesTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;施行日\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003eEnforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税率\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003eRate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"enforcementDate\"\u0026gt;施行日\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"rate\"\u0026gt;税率\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsValidRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eEnforcementDate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;有効な税率かどうかを返す\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"rate\"\u0026gt;税率\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;有効な場合true\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eIsValidRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eSalesTaxApplyRule.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税適用ルール\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSalesTaxApplyRule\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 最新の施行日から順に格納すること。\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// (開発者が順番を気にしなくても良いように設計するのがホントは望ましい)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2019\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.10\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2014\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.08\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1997\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.05\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenforcementDate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1989\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003erate\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.03\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;消費税ルールを適用する\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"contractDate\"\u0026gt;契約日\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;適用された消費税率\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"nf\"\u003eApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecorresponded\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_salesTaxes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etax\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnforcementDate\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ecorresponded\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003ecorresponded\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRate\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.00\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eAppliedSalesTaxRate.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;適用された消費税率\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAppliedSalesTaxRate\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eSalesTaxApplyRule\u003c/span\u003e \u003cspan class=\"n\"\u003e_salesTaxApplyRule\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSalesTaxApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003edecimal\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;コンストラクタ\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"contractDate\"\u0026gt;契約日\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAppliedSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContractDate\u003c/span\u003e \u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_rate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_salesTaxApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eApplyRule\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtractDate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eAmountIncludingTax.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;税込金額\u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAmountIncludingTax\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;コンストラクタ\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"amountExcludingTax\"\u0026gt;税抜き金額\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"appliedSalesTaxRate\"\u0026gt;適用された消費税率\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAmountIncludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eAmountExcludingTax\u003c/span\u003e \u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eAppliedSalesTaxRate\u003c/span\u003e \u003cspan class=\"n\"\u003eappliedSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_amount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003eamountExcludingTax\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eappliedSalesTaxRate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e消費税の計算に関して、全て \u003cstrong\u003eValueObject(及びその亜種)+完全コンストラクタで設計\u003c/strong\u003e できました。\u003cbr\u003e\n丁寧すぎるほど丁寧に設計しましたが、これらクラス図やソースコードをご覧になってどうでしょう、カンの良い方は以下4点に気づいたのではと思います。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e業務概念が見える化されている\u003c/li\u003e\n\u003cli\u003eクラスがその業務概念を説明している\u003c/li\u003e\n\u003cli\u003eクラスが小さい\u003c/li\u003e\n\u003cli\u003einternal(Javaでいうpackage private)の活用\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eそれぞれ説明していきます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"業務概念が見える化されている\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A5%AD%E5%8B%99%E6%A6%82%E5%BF%B5%E3%81%8C%E8%A6%8B%E3%81%88%E3%82%8B%E5%8C%96%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e業務概念が見える化されている\u003c/h2\u003e\n\n\u003cp\u003e業務概念がひとつひとつクラス化されているため、どんな業務概念を取り扱っているのか見える化されています。\u003cbr\u003e\n仮にこれがクラス化されていないことを想像してみて下さい。何千何万行ものソースコードの深い深い海の中のテキトーな変数として埋もれてしまい、 \u003cstrong\u003eデバッグや仕様変更時のコード分析で多大な労苦を味わうことになる\u003c/strong\u003e でしょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"クラスがその業務概念を説明している\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8C%E3%81%9D%E3%81%AE%E6%A5%AD%E5%8B%99%E6%A6%82%E5%BF%B5%E3%82%92%E8%AA%AC%E6%98%8E%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eクラスがその業務概念を説明している\u003c/h2\u003e\n\n\u003cp\u003e業務概念の名を冠したクラスひとつひとつが、その業務概念や仕様を説明するようにロジックが組まれています。このように、 \u003cstrong\u003eクラス：業務概念：業務ロジック＝１：１：１\u003c/strong\u003e となるように設計することが肝要です。\u003cbr\u003e\n国語辞典を思い出してみて下さい。例えば「消費税」を引くと「消費に対して課される租税」と出てきます。それと同じように、ValueObjectのように業務概念を表したクラスには、「○○とは△△である」のように、 \u003cstrong\u003eその言葉の定義を表すようロジックを実装\u003c/strong\u003e しましょう。 \u003cstrong\u003e理解容易性\u003c/strong\u003e が格段に向上します。まさに \u003cstrong\u003e名は体を表す\u003c/strong\u003e です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"クラスが小さい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8C%E5%B0%8F%E3%81%95%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eクラスが小さい\u003c/h2\u003e\n\n\u003cp\u003eちゃんとドメイン分析してこまめに業務概念をクラス化すると、ひとつひとつのクラスが数十行程度の小さなものになります。\u003cbr\u003e\n \u003cstrong\u003eテスト容易性\u003c/strong\u003e が向上し、安全品質が更に堅牢になります。\u003cbr\u003e\nまた、「 \u003cstrong\u003eチャンク\u003c/strong\u003e 」でググると分かるかと思いますが、普通の人間が一度に知覚可能な概念の個数は \u003cstrong\u003e4±1個\u003c/strong\u003e だとされています。クラスを小さくし、 \u003cstrong\u003eそのクラスに登場する概念が4±1個以内に設計する\u003c/strong\u003e ことにより、やはり \u003cstrong\u003e理解容易性\u003c/strong\u003e の向上に貢献します。\u003c/p\u003e\n\n\u003cp\u003eこうして設計されたプログラムは、 \u003cstrong\u003eトレーサビリティ\u003c/strong\u003e が向上します。 \u003cstrong\u003eどこに何が実装されてあるのか迅速に発見することができる\u003c/strong\u003e ようになります。\u003cbr\u003e\n例えば、消費税法では「経過措置」という概念がありますが、今回の設計では考慮されていません。「消費税率の適用には『経過措置』も考慮しなければならない。消費税適用ルールが定義されるコードはどこだ！？」という事態が発生したとします。「業務概念が全てクラスとして設計されていること」が前提となっていれば、何千何万行ものソースコードを舐める必要がなく、クラス一覧から消費税適用ルールである\u003ccode\u003eSalesTaxApplyRule\u003c/code\u003eクラスを見つけ出せばよいことになります。また、ルールロジックが他のクラスに実装されておらず、\u003ccode\u003eSalesTaxApplyRule\u003c/code\u003eクラス内に閉じているので、\u003ccode\u003eSalesTaxApplyRule\u003c/code\u003eクラスだけを経過措置に関してロジック変更すれば良いことになります。変更が高速化し、 \u003cstrong\u003e生産性が向上\u003c/strong\u003e します。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"internaljavaでいうpackage-privateの使用\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#internaljava%E3%81%A7%E3%81%84%E3%81%86package-private%E3%81%AE%E4%BD%BF%E7%94%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003einternal(Javaでいうpackage private)の使用\u003c/h2\u003e\n\n\u003cp\u003e税抜き金額\u003ccode\u003eAmountExcludingTax\u003c/code\u003eや契約日\u003ccode\u003eContractDate\u003c/code\u003eはView層での表示が想定されるため、可視性はpublicで設計しています。一方、消費税\u003ccode\u003eSalesTax\u003c/code\u003eや消費税適用ルール\u003ccode\u003eSalesTaxApplyRule\u003c/code\u003eは外部からアクセスされる必要性がないため、アクセスがパッケージ内だけで閉じるようinternalで設計しています。\u003cbr\u003e\n\u003cstrong\u003e何でもかんでもpublicで定義してるのをプログラミング入門書で頻繁に見受けられます\u003c/strong\u003eが、よく考えずに真似してしまうとpublic定義されたクラスはあらゆるクラスと関係し始めて影響範囲が拡大し、低凝集密結合を誘発する大きな要因となります。\u003cbr\u003e\nパッケージの粒度設計も然ることながら、クラスの可視性は基本的にinternalで設計し、パッケージ外に本当に公開が必要なクラスのみ、publicとして設計しましょう。(※なお、C#言語仕様では、クラスのアクセス修飾子を省略するとinternalになります。この意味をよく考えてみましょう。)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"valueobject--完全コンストラクタ設計要件\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#valueobject--%E5%AE%8C%E5%85%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E8%A8%AD%E8%A8%88%E8%A6%81%E4%BB%B6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eValueObject + 完全コンストラクタ　設計要件\u003c/h2\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e設計要件\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e理由\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e値そのものをクラス化すること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e疎結合高凝集にするため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eクラス名は値の名称であること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e理解容易性向上のため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e値を格納するインスタンス変数を(原則的に)1個用意すること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e概念が異なる値と疎結合にするため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eインスタンス変数への代入はコンストラクタ引数を介して行うこと。更に、代入前に不正値チェックし、不正値の場合例外をスローすること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e正しい値を持ったインスタンスのみが存在できるようにするため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eインスタンス変数にはreadonlyを付与し、不変にすること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e並列処理に強くなるため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e値を変更したい場合は、変更値を持ったインスタンスを新たに生成すること。その場合業務概念的に許される操作のみメソッドとして公開すること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e不正な演算を防ぐため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e業務概念を表す値は、可能な限り全てValueObjectで設計すること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e概念の異なる値同士の取り違えを防ぐため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eインスタンス生成の用途が複数ある場合、用途ごとにFactoryメソッドを用意し、コンストラクタをprivateにすること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e利用側の不正なインスタンス生成を防ぐため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e概念的に複雑なものは、ボトムアップでの設計を検討すること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eトップダウンでは概念の洗い出しに漏れが生じやすい。概念を漏れなく洗い出して設計するため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e名前が競合した場合、更にドメイン分析を重ね、名前のブラッシュアップを検討すること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e理解容易性向上のため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eリスト操作するロジックにはファーストクラスコレクションパターンを適用すること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003eリスト操作周りを単純化するため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eクラスに登場する概念が4±1個以内になるよう設計すること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e脳の負荷を下げ、混乱を避けるため。影響範囲低減のため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003einternalなどのアクセス修飾子を適切に使用すること。\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e影響範囲低減のため。\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"本記事の手法よる効果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AE%E6%89%8B%E6%B3%95%E3%82%88%E3%82%8B%E5%8A%B9%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e本記事の手法よる効果\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e生産性向上\u003c/li\u003e\n\u003cli\u003e修正漏れ低減\u003c/li\u003e\n\u003cli\u003eクローンコード低減\u003c/li\u003e\n\u003cli\u003e未初期化状態の防止\u003c/li\u003e\n\u003cli\u003e不正値の防止\u003c/li\u003e\n\u003cli\u003e異なる概念の値混入抑止\u003c/li\u003e\n\u003cli\u003eインスタンス生成の安全性向上\u003c/li\u003e\n\u003cli\u003eリスト操作に関する複雑度低減\u003c/li\u003e\n\u003cli\u003e理解容易性向上\u003c/li\u003e\n\u003cli\u003eコードのトレーサビリティ向上\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"基本ほど遠い道のり一歩ずつ極めていきませんか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%9F%BA%E6%9C%AC%E3%81%BB%E3%81%A9%E9%81%A0%E3%81%84%E9%81%93%E3%81%AE%E3%82%8A%E4%B8%80%E6%AD%A9%E3%81%9A%E3%81%A4%E6%A5%B5%E3%82%81%E3%81%A6%E3%81%84%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e基本ほど遠い道のり、一歩ずつ極めていきませんか\u003c/h2\u003e\n\n\u003cp\u003eValueObjectは1個たかだか数十行程度の規模ですが、大真面目にやろうとするといくつもの要件を満たすよう設計する必要があります。不慣れな方にとって、これら全てを満たすのはかなり骨の折れることになるでしょう。\u003cbr\u003e\nですがValueObjectにはソフトウェア設計の基本が詰まっていると私は思っています。基本をひとつずつ踏み固め、一歩ずつ極めていくことで、高品質で高い開発生産性に繋がっていくことでしょう。\u003c/p\u003e\n","createdAt":"2019-11-04T22:38:26Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"pJQddzBsbkJ8amzgzHvMycHazmDa3ZlpWw==--CwT+GkI2tdg8RnZf--5SWpxIJVACmjXcUszASNSA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-11-10T03:55:59Z","likesCount":1022,"linkUrl":"https://qiita.com/MinoDriven/items/5e69d9bd028aa350e2c4","organization":null,"originalId":1068552,"stockedCount":847,"title":"設計要件をギッチギチに詰めたValueObjectで低凝集クラスを爆殺する","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e概要\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%AC%E8%A8%AD%E8%A8%88%E6%89%8B%E6%B3%95%E3%81%AB%E3%82%88%E3%82%8B%E5%8A%B9%E6%9E%9C\"\u003e本設計手法による効果\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E3%83%80%E3%83%A1%E3%81%AA%E4%BE%8B\"\u003eよくあるダメな例\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C\"\u003e課題\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C1%E4%BD%8E%E5%87%9D%E9%9B%86\"\u003e課題1：低凝集\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C1-1%E7%94%9F%E7%94%A3%E6%80%A7%E4%BD%8E%E4%B8%8B\"\u003e課題1-1：生産性低下\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C1-2%E4%BF%AE%E6%AD%A3%E6%BC%8F%E3%82%8C\"\u003e課題1-2：修正漏れ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C1-3%E3%82%B3%E3%83%BC%E3%83%89%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%B3%E3%82%B3%E3%83%94%E3%83%9A%E3%82%B3%E3%83%BC%E3%83%89\"\u003e課題1-3：コードクローン（コピペコード）\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C2%E4%B8%8D%E6%AD%A3%E7%8A%B6%E6%85%8B\"\u003e課題2：不正状態\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C2-1%E6%9C%AA%E5%88%9D%E6%9C%9F%E5%8C%96%E7%8A%B6%E6%85%8B%E7%94%9F%E7%84%BC%E3%81%91%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88\"\u003e課題2-1：未初期化状態（生焼けオブジェクト）\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C2-2%E4%B8%8D%E6%AD%A3%E5%80%A4%E3%81%AE%E6%B7%B7%E5%85%A5\"\u003e課題2-2：不正値の混入\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C%E3%81%BE%E3%81%A8%E3%82%81\"\u003e課題まとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#valueobject\"\u003eValueObject\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%8C%E5%85%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF\"\u003e完全コンストラクタ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%94%9F%E3%81%BE%E3%82%8C%E3%81%AA%E3%81%8C%E3%82%89%E3%81%AB%E3%81%97%E3%81%A6%E5%AE%8C%E5%85%A8%E4%BD%93\"\u003e生まれながらにして完全体\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#setter%E3%82%92%E7%94%A8%E6%84%8F%E3%81%97%E3%81%AA%E3%81%84\"\u003esetterを用意しない\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#immutable%E4%B8%8D%E5%A4%89%E3%81%AB%E3%81%99%E3%82%8B\"\u003eimmutable(不変)にする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%B6%85%E9%87%8D%E8%A6%81%E8%A8%B1%E5%8F%AF%E3%81%95%E3%82%8C%E3%81%9F%E6%93%8D%E4%BD%9C%E3%81%AE%E3%81%BF%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E5%8C%96%E3%81%99%E3%82%8B\"\u003e【！超重要！】許可された操作のみメソッド化する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%85%A8%E3%81%A6%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AB%E5%82%99%E3%82%8F%E3%82%8B%E8%87%AA%E5%B7%B1%E9%98%B2%E8%A1%9B%E8%B2%AC%E5%8B%99\"\u003e全てのクラスに備わる「自己防衛責務」\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C%E3%81%AF%E8%A7%A3%E6%B1%BA%E3%81%95%E3%82%8C%E3%81%9F%E3%81%8B\"\u003e課題は解決されたか？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9B%B4%E3%81%AB%E7%99%BA%E5%B1%95%E5%BF%9C%E7%94%A8%E3%81%95%E3%81%9B%E3%82%8B\"\u003e更に発展応用させる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E3%82%92valueobject%E5%8C%96%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e消費税率をValueObject化してみる\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%86%8D%E7%87%83%E3%81%99%E3%82%8B%E8%AA%B2%E9%A1%8C%E4%BD%8E%E5%87%9D%E9%9B%86\"\u003e再燃する課題…低凝集\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%87%9D%E9%9B%86%E3%81%97%E3%82%88%E3%81%86--%E5%AE%8C%E5%85%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%81%AE%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\"\u003e凝集しよう － 完全コンストラクタのおさらい\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E5%91%A8%E3%82%8A%E3%81%AE%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%88%86%E6%9E%90\"\u003e消費税率周りのドメイン分析\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A5%91%E7%B4%84%E6%97%A5%E3%81%AE%E6%89%B1%E3%81%84\"\u003e契約日の扱い\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%82%E3%82%89%E3%82%86%E3%82%8B%E5%80%A4%E3%82%92valueobject%E3%81%A8%E3%81%97%E3%81%A6%E8%A8%AD%E8%A8%88%E3%81%99%E3%82%8B\"\u003eあらゆる値をValueObjectとして設計する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A5%91%E7%B4%84%E6%97%A5%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e契約日クラス\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#factory%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89private%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF\"\u003eFactoryメソッド＋privateコンストラクタ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E9%81%A9%E7%94%A8%E3%83%AB%E3%83%BC%E3%83%AB%E3%81%AE%E8%A8%AD%E8%A8%88\"\u003e消費税率適用ルールの設計\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e消費税クラス\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%90%8D%E5%89%8D%E3%81%8C%E3%82%AB%E3%83%96%E3%81%A3%E3%81%9F\"\u003e名前がカブった？？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B6%88%E8%B2%BB%E7%A8%8E%E9%81%A9%E7%94%A8%E3%83%AB%E3%83%BC%E3%83%AB%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e消費税適用ルールクラス\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%81%A9%E7%94%A8%E3%81%95%E3%82%8C%E3%81%9F%E6%B6%88%E8%B2%BB%E7%A8%8E%E7%8E%87%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%B8%E7%B5%84%E3%81%BF%E8%BE%BC%E3%81%BF\"\u003e「適用された消費税率」クラスへ組み込み\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%A8%8E%E8%BE%BC%E3%81%BF%E9%87%91%E9%A1%8D%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e税込み金額クラス\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%81%95%E3%82%89%E3%81%84\"\u003eおさらい\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A5%AD%E5%8B%99%E6%A6%82%E5%BF%B5%E3%81%8C%E8%A6%8B%E3%81%88%E3%82%8B%E5%8C%96%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B\"\u003e業務概念が見える化されている\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8C%E3%81%9D%E3%81%AE%E6%A5%AD%E5%8B%99%E6%A6%82%E5%BF%B5%E3%82%92%E8%AA%AC%E6%98%8E%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B\"\u003eクラスがその業務概念を説明している\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%8C%E5%B0%8F%E3%81%95%E3%81%84\"\u003eクラスが小さい\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#internaljava%E3%81%A7%E3%81%84%E3%81%86package-private%E3%81%AE%E4%BD%BF%E7%94%A8\"\u003einternal(Javaでいうpackage private)の使用\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#valueobject--%E5%AE%8C%E5%85%A8%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E8%A8%AD%E8%A8%88%E8%A6%81%E4%BB%B6\"\u003eValueObject + 完全コンストラクタ　設計要件\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%AC%E8%A8%98%E4%BA%8B%E3%81%AE%E6%89%8B%E6%B3%95%E3%82%88%E3%82%8B%E5%8A%B9%E6%9E%9C\"\u003e本記事の手法よる効果\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%9F%BA%E6%9C%AC%E3%81%BB%E3%81%A9%E9%81%A0%E3%81%84%E9%81%93%E3%81%AE%E3%82%8A%E4%B8%80%E6%AD%A9%E3%81%9A%E3%81%A4%E6%A5%B5%E3%82%81%E3%81%A6%E3%81%84%E3%81%8D%E3%81%BE%E3%81%9B%E3%82%93%E3%81%8B\"\u003e基本ほど遠い道のり、一歩ずつ極めていきませんか\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":50691,"uuid":"5e69d9bd028aa350e2c4","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"6tads3hyA5e/Bv07xk+x86uK0w38--T48haT4bGUE6Dc4g--XHSvB25s1G5qy94pT+KRaw==","originalId":393000,"description":"","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"ミノ駆動","profileImageUrl":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/393000/profile-images/1603102722","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fprofile-images%2F1603102722?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=ba60629cf7477beb8ac0c04d46d9175d","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F393000%2Fprofile-images%2F1603102722?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=2768d24ca9e90f76b07881585cbc4dd5","urlName":"MinoDriven","websiteUrl":"","twitterUrl":"https://twitter.com/MinoDriven","twitterUrlName":"MinoDriven","revealedOrganizations":{"edges":[{"node":{"encryptedId":"5AHoAZ2OUdRHqXTcbIWL4bgMDczBUTjJi2tL--07+i6I+7k7vDhTFy--KqFleSLO/SU2BFYFNofPFw==","isBetaReleaseEnabled":false,"isFollowableByViewer":false,"isFollowedByViewer":false,"name":"READYFOR株式会社","logoUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/a19a7aa0751aa585fcf71c2ae33b01dc8cbbdcda/original.jpg?1594792177","urlName":"readyfor","description":"想いをつなぎ、叶える未来を、つくる\r\nREADYFORのOrganizationです","url":"https://tech.readyfor.jp/"}}]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"DDD","urlName":"ddd"},{"name":"設計","urlName":"%e8%a8%ad%e8%a8%88"}],"followingLikers":{"edges":[]},"comments":{"totalCount":7}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
