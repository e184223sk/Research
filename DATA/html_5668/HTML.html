<!DOCTYPE html><html><head><meta charset="utf-8" /><title>HttpClientをマルチスレッドで運用する場合の注意点 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/skitoy4321/items/dc6bd2b62b62c2414642" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="wTdXM+5PvOfmgBFxfTnHZkKygaDWtZ2H0wmATdecH7gZmRCywAKsBs1EXT18XYZB2U+tRBwQRhSNdssJz2GJeA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@skitoy4321" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="HttpClientをマルチスレッドで運用する場合の注意点 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1TSFIwY0VOc2FXVnVkT09Da3VPRG51T0RxLU9EZ2VPQ3VlT0RyT09EZy1PRGllT0JwLW1CaS1lVXFPT0JtZU9DaS1XZ3RPV1FpT09CcnVhenFPYUVqLWVDdVEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YWVhNTE3YTNkYTU4MWUzMmMzNDk4OTAxNWYzYTA3Y2I&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=7ccf43ce8b5763fe3c3b7364cc35dea8"><meta property="og:description" content="

始めに

HttpClientをマルチスレッドかつ高負荷で回す時、少々ハマった点があったので、注意するべき点について書く。


シングルスレッドの場合

https://aspnetmonsters.com/2016/08/201..."><meta content="https://qiita.com/skitoy4321/items/dc6bd2b62b62c2414642" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,HttpClient" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-43e3d0f1-2cb5-4801-abcc-829933fe909d"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fskitoy4321%2Fitems%2Fdc6bd2b62b62c2414642">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fskitoy4321%2Fitems%2Fdc6bd2b62b62c2414642">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-43e3d0f1-2cb5-4801-abcc-829933fe909d">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2017-12-24T16:52:44.000+09:00","dateModified":"2018-09-26T10:59:01.000+09:00","headline":"HttpClientをマルチスレッドで運用する場合の注意点","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1TSFIwY0VOc2FXVnVkT09Da3VPRG51T0RxLU9EZ2VPQ3VlT0RyT09EZy1PRGllT0JwLW1CaS1lVXFPT0JtZU9DaS1XZ3RPV1FpT09CcnVhenFPYUVqLWVDdVEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YWVhNTE3YTNkYTU4MWUzMmMzNDk4OTAxNWYzYTA3Y2I\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=7ccf43ce8b5763fe3c3b7364cc35dea8","mainEntityOfPage":"https://qiita.com/skitoy4321/items/dc6bd2b62b62c2414642","author":{"@type":"Person","address":"","email":null,"identifier":"skitoy4321","name":"skitoy4321","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","url":"https://qiita.com/skitoy4321","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"dc6bd2b62b62c2414642"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"dc6bd2b62b62c2414642"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"dc6bd2b62b62c2414642"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/skitoy4321/items/dc6bd2b62b62c2414642","location":"/skitoy4321/items/dc6bd2b62b62c2414642","scheme":"https","host":"qiita.com","port":null,"pathname":"/skitoy4321/items/dc6bd2b62b62c2414642","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"stOr/mIHAXgrjotx46KlUvOuYHEnR6cZj7kOZqWdX6Rqfex/TEoRmQBKxz3ixuR1aFNMle3ifIrRxkUivWDJZA==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-64b9de9a-5ff3-4066-bc1e-6095591f826b"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/dc6bd2b62b62c2414642/likers" class="css-1iupg5d">60</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">62</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/dc6bd2b62b62c2414642/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/dc6bd2b62b62c2414642/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/dc6bd2b62b62c2414642/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/dc6bd2b62b62c2414642/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/dc6bd2b62b62c2414642.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/skitoy4321"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/skitoy4321" class="css-10ougpm">@<!-- -->skitoy4321</a><div class="css-1ay9vb9"><span><meta content="2017-12-24T07:52:44Z"/><time dateTime="2018-09-26T01:59:01Z" class="css-m19uds">updated at 2018-09-26</time></span></div></div></div></div></div><h1 class="css-cgzq40">HttpClientをマルチスレッドで運用する場合の注意点</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/httpclient" class="css-4czcte">HttpClient</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="始めに" class="fragment"></span><a href="#%E5%A7%8B%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>始めに</h1>

<p>HttpClientをマルチスレッドかつ高負荷で回す時、少々ハマった点があったので、注意するべき点について書く。</p>

<h2>
<span id="シングルスレッドの場合" class="fragment"></span><a href="#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>シングルスレッドの場合</h2>

<p><a href="https://aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/" class="autolink" rel="nofollow noopener" target="_blank">https://aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/</a> にもある通り、できる限り一つのHttpClientインスタンスで使いまわすという方法で問題はない。<br>
実際自分もこういう風に使っていた。</p>

<h2>
<span id="マルチスレッドの場合" class="fragment"></span><a href="#%E3%83%9E%E3%83%AB%E3%83%81%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>マルチスレッドの場合</h2>

<p>しかし、マルチスレッドでこれを行うと少々厄介なことになる。<br>
実際に以下のようなメソッドを適当なWindowsマシン上で実行してみよう。(要dotnet-sdk-2.0以上)</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="c1">// 予めhttp://localhost:10001で適当なhttpサーバーを動かしておく</span>
<span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">MutliThreadedHttpRequest</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="c1">// Do 1000 concurrent tasks, loop 100 times</span>
    <span class="kt">var</span> <span class="n">tasks</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1000</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="k">async</span> <span class="n">idx</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">res</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="s">"http://localhost:10001"</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">res</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"error(</span><span class="p">{</span><span class="n">idx</span><span class="p">}</span><span class="s">,</span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="s">): </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"done</span><span class="p">{</span><span class="n">idx</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}).</span><span class="nf">ToArray</span><span class="p">();</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"all done"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ここで、実行中に<code>netstat -n</code>コマンドを実行してみると、環境によってはアドレスがIPv6だったり、ESTABLISHEDがTIME_WAITになっていたりと細部が異なる可能性もあるが、おそらく以下のような行が数百～数千程度表示されることになる。<br>
<code><br>
TCP 127.0.0.1:[ランダムポート] 127.0.0.1:10001 ESTABLISHED<br>
</code><br>
これはまさに"シングルスレッドの場合"の記事URLで指摘された、ソケットを大量に作る現象となる。<br>
正直上記のような、HTTPリクエストを1000もの並列タスクで同時展開するというのはあまり無い状況だとは思うが、問題が出る閾値が場合によっては異なるので、実際注意は必要。</p>

<h3>
<span id="なぜ接続が爆発するのか" class="fragment"></span><a href="#%E3%81%AA%E3%81%9C%E6%8E%A5%E7%B6%9A%E3%81%8C%E7%88%86%E7%99%BA%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>なぜ接続が爆発するのか</h3>

<p>さて、気になるのは今回接続が爆発した原因である。<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.net.servicepointmanager.defaultconnectionlimit?view=netframework-4.7.1#System_Net_ServicePointManager_DefaultConnectionLimit" rel="nofollow noopener" target="_blank">ServicePointManager.DefaultConnectionLimit</a>、あるいは<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.net.http.httpclienthandler.maxconnectionsperserver?view=netcore-2.0#System_Net_Http_HttpClientHandler_MaxConnectionsPerServer" rel="nofollow noopener" target="_blank">HttpClientHandler.MaxConnectionsPerServer</a>で制御できるらしいとの話は見つかる(自分の場合はコメントで教えてもらったけど(<a href="/inasync" class="user-mention js-hovercard" title="inasync" data-hovercard-target-type="user" data-hovercard-target-name="inasync">@inasync</a> さん感謝))。しかし、上記のコードは実際にソケットを爆発させているのは事実だ。</p>

<h4>
<span id="corefxの場合netcoreapp" class="fragment"></span><a href="#corefx%E3%81%AE%E5%A0%B4%E5%90%88netcoreapp"><i class="fa fa-link"></i></a>corefxの場合(netcoreapp)</h4>

<p>最大接続数の既定値がどこから来ているか探してみると、corefxの場合は大体 <a href="https://github.com/dotnet/corefx/blob/1a5cdbe1af7a5befe16bb4581f29f0af64f4a101/src/Common/src/System/Net/Http/HttpHandlerDefaults.cs" rel="nofollow noopener" target="_blank">HttpHandlerDefaults.DefaultMaxConnectionsPerServer </a>に行き着く。<br>
値は <code>int.MaxValue</code> である。というわけで、corefxの場合は常に設定を気を付けておいた方がいいということになる。</p>

<p>ちなみに corefx版のHttpWebRequestについては、 <strong><a href="https://github.com/dotnet/corefx/blob/cf191eb22e762ad740ae8a91a3fdb948d29a7b0c/src/System.Net.Requests/src/System/Net/HttpWebRequest.cs#L1111" rel="nofollow noopener" target="_blank">常にHttpClientをnewしてアクセスしているようなので</a>、そもそも使うべきではないという結論になる。</strong> 一応HttpWebRequestについては、 <a href="https://github.com/dotnet/platform-compat/blob/master/docs/DE0003.md" rel="nofollow noopener" target="_blank">使うなという明言もされている。</a></p>

<h4>
<span id="netframeworkの場合net4x" class="fragment"></span><a href="#netframework%E3%81%AE%E5%A0%B4%E5%90%88net4x"><i class="fa fa-link"></i></a>netframeworkの場合(net4x)</h4>

<p>さて、では.NET Frameworkの場合はどのようになっているだろうか。<a href="https://referencesource.microsoft.com/#System/net/System/Net/ServicePoint.cs,697" rel="nofollow noopener" target="_blank">リファレンスソース</a>を見てみると、色々処理はされているが、つまるところ <strong>ローカルアドレスの場合はint.MaxValue、それ以外の場合は2</strong> ということらしい。</p>

<p>(正直ここは無条件に2にして欲しかった...)</p>

<h4>
<span id="monoの場合54" class="fragment"></span><a href="#mono%E3%81%AE%E5%A0%B4%E5%90%8854"><i class="fa fa-link"></i></a>monoの場合(5.4)</h4>

<p><a href="https://github.com/mono/mono/blob/95b0698304cbc54fdfd2eac00692c9c8c3c8875d/mcs/class/System/System.Net/ServicePointManager.cs" rel="nofollow noopener" target="_blank">monoのServicePointManager</a>を見てみると、デフォルトは10のようである。<br>
しかし、実際に試してみると、シングルスレッドだったとしてもTIME_WAITが多くなってしまった。この辺りの原因は不明である(そもそも問題がない?)。</p>

<h2>
<span id="対処法" class="fragment"></span><a href="#%E5%AF%BE%E5%87%A6%E6%B3%95"><i class="fa fa-link"></i></a>対処法</h2>

<p>この問題に対する対処法を書く</p>

<h3>
<span id="同時接続数を明示的に設定する" class="fragment"></span><a href="#%E5%90%8C%E6%99%82%E6%8E%A5%E7%B6%9A%E6%95%B0%E3%82%92%E6%98%8E%E7%A4%BA%E7%9A%84%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>同時接続数を明示的に設定する</h3>

<p>コメントで教えていただいた事だが、HttpClient(というより多分ハンドラだと思うけど)の最大同時接続数を設定するという方法が一つ。</p>

<h4>
<span id="net-framework-471以降またはnetcoreapp20の場合" class="fragment"></span><a href="#net-framework-471%E4%BB%A5%E9%99%8D%E3%81%BE%E3%81%9F%E3%81%AFnetcoreapp20%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>.NET Framework 4.7.1以降またはnetcoreapp2.0の場合</h4>

<p>net471、netcoreapp(1.0以降)で使用できるやり方(多分net471はnetcoreappからの輸入品)。<br>
これらのバージョンの場合は、<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.net.http.httpclienthandler.maxconnectionsperserver?view=netcore-2.0" rel="nofollow noopener" target="_blank">HttpClientHandler.MaxConnectionsPerServer</a>を、HttpClientのコンストラクタで渡せばOK。<br>
この方法だと影響範囲はそのインスタンスのみで、排他等考えずとも設定できるので、可能ならばこのやり方で設定するのが簡単だろう。<br>
ただし、<strong>netstandard2.0では使えない方法</strong>なので、その場合は後述の静的プロパティに設定する必要がある。</p>

<h4>
<span id="net-framework-47以前netstandard20以前の場合" class="fragment"></span><a href="#net-framework-47%E4%BB%A5%E5%89%8Dnetstandard20%E4%BB%A5%E5%89%8D%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>.NET Framework 4.7以前、netstandard2.0以前の場合</h4>

<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.servicepointmanager.defaultconnectionlimit?view=netframework-4.7.1#System_Net_ServicePointManager_DefaultConnectionLimit" rel="nofollow noopener" target="_blank">ServicePointManager.DefaultConnectionLimit</a>を設定する。<br>
注意点としては、この値はHttpClient生成前に設定しておく必要があり、生成後に設定しても意味はないというところ。<br>
HttpWebRequestなどからも間接的に参照されている静的プロパティなので、アプリケーション全体に影響する項目であることは注意する必要がある。<br>
ライブラリで設定すると、アプリケーション側の動作にも影響を及ぼすかもしれないので、ライブラリ側ではあまり設定しない方がいいだろう。<br>
ただし、現行のほとんどの環境で使用できるやり方となるため、実際はこちらを使用することの方が多いかもしれない。</p>

<p>また、.NET Framework 4.7以前ならば、<a href="https://www.nuget.org/packages/System.Net.Http/" rel="nofollow noopener" target="_blank">System.Net.Httpパッケージ</a>を追加すれば、HttpClientHandlerにMaxConnectionsPerServerが追加される。しかし、<em>netstandard2.0に関しては追加されない</em>ので注意。<br>
また、将来的なことを考えると、System.Net.Httpパッケージ自体は今後メンテされる可能性は非常に低いので、あくまで限定的な回避方法として扱うべきだろう。</p>

<h3>
<span id="httpwebrequestgetresponseを使う" class="fragment"></span><a href="#httpwebrequestgetresponse%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a>HttpWebRequest.GetResponseを使う</h3>

<p>とりあえずの対処法としては、<a href="https://msdn.microsoft.com/ja-jp/library/system.net.httpwebrequest(v=vs.110).aspx" rel="nofollow noopener" target="_blank">HttpWebRequest.GetResponse</a>を使用して、同期的なアクセスをするというものがある。<br>
実際似たような処理をHttpWebRequestに置き換えたところ、大体の環境では<code>netstat -n</code>で観測できるソケット数はほぼ1-2程度に収まった。</p>

<p>ちなみに、HttpWebRequestにはGetResponseAsyncという、非同期版のAPIがあるが、 <strong>localhostに設定なしで接続すると接続が爆発するので要注意</strong></p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="c1">// 予めhttp://localhost:10001で適当なhttpサーバーを動かしておく</span>
<span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">MultiThreadedHttpWebRequest</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Do 1000 concurrent tasks, loop 10 times</span>
    <span class="kt">var</span> <span class="n">tasks</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1000</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="k">async</span> <span class="n">idx</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="c1">// HttpWebRequestはそのリクエストごとに毎回インスタンスを作成する</span>
                <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">HttpWebRequest</span><span class="p">.</span><span class="nf">CreateHttp</span><span class="p">(</span><span class="s">"http://localhost:10001"</span><span class="p">);</span>
                <span class="k">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">res</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetResponse</span><span class="p">()</span> <span class="k">as</span> <span class="n">HttpWebResponse</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">res</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">&lt;</span> <span class="m">200</span> <span class="p">||</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">res</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">&gt;=</span> <span class="m">300</span> <span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"http response failed:</span><span class="p">{</span><span class="n">res</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"error(</span><span class="p">{</span><span class="n">idx</span><span class="p">}</span><span class="s">,</span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="s">): </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"done</span><span class="p">{</span><span class="n">idx</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}).</span><span class="nf">ToArray</span><span class="p">();</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"all done"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ただし、ASP.NET(coreではない)内部で実行した場合等は、同じようにソケットが大量に作成された。<br>
この辺りは推測の域を出ないが、ASP.NETの方が、リクエストごとに少々特殊な処理をしているためではないかと考えている。</p>

<p>また、<strong>netcoreapp2.0では非推奨なので、netcoreapp2.0ではこの手は使えない</strong>。</p>

<h3>
<span id="シングルスレッドにリクエストをまとめる" class="fragment"></span><a href="#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E3%81%BE%E3%81%A8%E3%82%81%E3%82%8B"><i class="fa fa-link"></i></a>シングルスレッドにリクエストをまとめる</h3>

<p>シングルスレッドに行いたい処理をまとめ、その上で順次処理を回していくという方法。イメージとしては<a href="http://www.hyuki.com/dp/dpinfo.html#ProducerConsumer" rel="nofollow noopener" target="_blank">Producer-Consumerパターン</a>に近い。Producer(HTTPリクエストを送りたいスレッド):Consumer(リクエストを順次処理するスレッド)=n:1という関係になる。</p>

<p>プラットフォームを選ばないやり方だが、実装が複雑になりやすく、またデッドロック等のマルチスレッド固有の危険性もあるので、入念なテストを行うことをお勧めする。</p>

<p><a href="https://github.com/dotnet/corefx/tree/master/src/System.Threading.Channels" rel="nofollow noopener" target="_blank">System.Threading.Channels</a>があるとかなり実装も楽になると思う。</p>

<h3>
<span id="monoの場合" class="fragment"></span><a href="#mono%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>monoの場合</h3>

<p>なぜかmonoの場合、シングルスレッドを含めてどの方法を試してみても、TIME_WAITが増加してしまった。<br>
(最初netstatのオプションを間違えて指定していたため、網に引っかからなかった)<br>
この辺り、自分のやり方が良くないせいもあるかもしれないので、引き続き調査を行う必要がある。</p>

<h2>
<span id="各プラットフォームランタイムでの状況最大同時接続数未設定時" class="fragment"></span><a href="#%E5%90%84%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E3%81%A7%E3%81%AE%E7%8A%B6%E6%B3%81%E6%9C%80%E5%A4%A7%E5%90%8C%E6%99%82%E6%8E%A5%E7%B6%9A%E6%95%B0%E6%9C%AA%E8%A8%AD%E5%AE%9A%E6%99%82"><i class="fa fa-link"></i></a>各プラットフォーム、ランタイムでの状況(最大同時接続数未設定時)</h2>

<p>以下に表としてまとめる。なお、unityやmacも環境としては考えられるが、自分では持っていないため今回は調べていない。</p>

<p>実際に使ったコードは <a href="https://github.com/itn3000/multihttpclienttest" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/itn3000/multihttpclienttest</a> にまとめてある。</p>

<table>
<thead>
<tr>
<th>OS</th>
<th>ランタイム</th>
<th>リクエスト方法</th>
<th>結果(OK=ソケットが1-2程度、NG=ソケットが大量)</th>
</tr>
</thead>
<tbody>
<tr>
<td>windows-8.1</td>
<td>net461</td>
<td>HttpClient+マルチスレッド</td>
<td>NG</td>
</tr>
<tr>
<td>windows-8.1</td>
<td>net461</td>
<td>HttpWebRequest(同期)</td>
<td>OK</td>
</tr>
<tr>
<td>windows-8.1</td>
<td>net461</td>
<td>HttpWebRequest(非同期)</td>
<td>NG</td>
</tr>
<tr>
<td>windows-8.1</td>
<td>net461</td>
<td>HttpClient+シングルスレッド</td>
<td>OK</td>
</tr>
<tr>
<td>linux(docker)</td>
<td>mono-5.4</td>
<td>HttpClient+マルチスレッド</td>
<td>NG</td>
</tr>
<tr>
<td>linux(docker)</td>
<td>mono-5.4</td>
<td>HttpWebRequest</td>
<td>NG</td>
</tr>
<tr>
<td>linux(docker)</td>
<td>mono-5.4</td>
<td>HttpClient+シングルスレッド</td>
<td>NG</td>
</tr>
<tr>
<td>windows-8.1</td>
<td>netcoreapp2.0</td>
<td>HttpClient+マルチスレッド</td>
<td>NG</td>
</tr>
<tr>
<td>windows-8.1</td>
<td>netcoreapp2.0</td>
<td>HttpWebRequest</td>
<td>NG</td>
</tr>
<tr>
<td>windows-8.1</td>
<td>netcoreapp2.0</td>
<td>HttpClient+シングルスレッド</td>
<td>OK</td>
</tr>
<tr>
<td>linux(docker)</td>
<td>netcoreapp2.0</td>
<td>HttpClient+マルチスレッド</td>
<td>NG</td>
</tr>
<tr>
<td>linux(docker)</td>
<td>netcoreapp2.0</td>
<td>HttpWebRequest</td>
<td>NG</td>
</tr>
<tr>
<td>linux(docker)</td>
<td>netcoreapp2.0</td>
<td>HttpClient+シングルスレッド</td>
<td>OK</td>
</tr>
</tbody>
</table>

<p>monoで試す場合の注意点としては、事前に<a href="https://linux.die.net/man/1/mono" rel="nofollow noopener" target="_blank">MONO_THREADS_PER_CPU</a>環境変数を2000等の大きい数字にしておかないと、かなり遅くなってしまうので、<strong>必ず実行前にはMONO_THREADS_PER_CPU環境変数を設定しておくこと。</strong></p>

<p>なお、netcoreapp+win+HttpWebRequestでNGな事については、 <a href="https://github.com/dotnet/corefx/issues/15460" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/dotnet/corefx/issues/15460</a> で既に報告されている。</p>

<h2>
<span id="最大同時接続数を設定したときの挙動比較" class="fragment"></span><a href="#%E6%9C%80%E5%A4%A7%E5%90%8C%E6%99%82%E6%8E%A5%E7%B6%9A%E6%95%B0%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E6%8C%99%E5%8B%95%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>最大同時接続数を設定したときの挙動比較</h2>

<h3>
<span id="測定内容" class="fragment"></span><a href="#%E6%B8%AC%E5%AE%9A%E5%86%85%E5%AE%B9"><i class="fa fa-link"></i></a>測定内容</h3>

<p>それぞれ以下の三つの場合について、最大同時接続数を変化させた場合の完了までの時間を調べた。</p>

<ol>
<li>HttpWebRequest.GetResponseを使用した場合</li>
<li>シングルスレッドでHttpClientを使用した場合</li>
<li>マルチスレッドでHttpClientを使用した場合</li>
</ol>

<p>また、フレームワークについては、以下の場合について調べた</p>

<ul>
<li>Win+netcoreapp2.0</li>
<li>Win+net461</li>
<li>Linux+netcoreapp2.0</li>
<li>Linux+mono-5.4(net461と対応)</li>
</ul>

<p>なお、実験に使用したWinとLinuxはマシン自体にかなり性能差があり(Winは実機、Linuxは仮想)、同じ量のリクエストを行うと時間がかなりかかってしまったため、処理量自体を変えてある。<br>
そのため、WinとLinux間の同条件の速度差については今回は考慮しない。<br>
また、HttpClientの場合はハンドラごとにまた違った結果を出すかもしれないが、今回は測定していない。</p>

<p>ソースは <a href="https://github.com/itn3000/multihttpclienttest" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/itn3000/multihttpclienttest</a> を参照</p>

<h3>
<span id="測定結果" class="fragment"></span><a href="#%E6%B8%AC%E5%AE%9A%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>測定結果</h3>

<p>長くなったので、Google SpreadSheetにした。</p>

<ul>
<li>
<a href="https://docs.google.com/spreadsheets/d/1QADTNrEPzU5DPyB0fiMLz1xYNlmZ5Lfqs5eAqksK2T8/edit?usp=sharing" rel="nofollow noopener" target="_blank">Windows版</a>

<ul>
<li>win+core+httpwebrequestは実行したらプロセスが終わらなくなったため、途中で強制終了した</li>
</ul>
</li>
<li><a href="https://docs.google.com/spreadsheets/d/1bbPLuFh8tEvAv89WeLG5vxNuRS_UzgxotTKg8ShaGjQ/edit?usp=sharing" rel="nofollow noopener" target="_blank">Linux版</a></li>
</ul>

<h3>
<span id="考察" class="fragment"></span><a href="#%E8%80%83%E5%AF%9F"><i class="fa fa-link"></i></a>考察</h3>

<p>net461の場合、WinでもLinuxでもHttpWebRequestはかなり安定した性能を出していた。<br>
最大同時接続数を大きくした場合(100)は、場合によってはMultiThreadに一歩譲る場合もあるものの、それでも<br>
HttpWebRequestはソケットをほとんど作らないのに対して、MultiThreadは<br>
設定値分ソケットを作成していたので、安定性はやはりHttpWebRequestの方が上と言えると思う。<br>
古くからあるクラスなので、それだけ枯れているということだろうか。<br>
対してnetcoreapp2.0の場合、HttpWebRequestを使用するとWindowsで期待通り動作しないということが分かった。</p>

<p>HttpClient+MultiThreadは同時接続数を上げていくにつれ、性能が向上していった。<br>
特にnetcoreapp2.0でもnet461でもLinux版でその傾向が顕著だった。</p>

<h3>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h3>

<p>多くの場合、 <strong>HttpClient+MultiThreadで、かつ最大同時接続数をある程度の値に設定するのが正解</strong> だということになる。大きすぎてもソケットを作りすぎて動作が不安定になってしまうが、小さすぎても性能がかなり落ちてしまう(特にLinux版)ので、この辺りはそれぞれの環境で実測して調整をするのが良いと思う。<br>
ただし、グローバルな静的変数を設定するのがNGで、かつ.net frameworkあるいはmonoで動かすのが分かっている場合は、HttpWebRequestで動かすというのも一つの手かもしれない。<br>
ただし、 <a href="https://github.com/dotnet/corefx/issues/15460" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/dotnet/corefx/issues/15460</a> の問題があり、かつ<a href="https://github.com/dotnet/platform-compat/blob/master/docs/DE0003.md" rel="nofollow noopener" target="_blank">互換性のために残されているだけ</a>とのことなので、netcoreappなアプリ、及び今後何か新しく作る場合はHttpWebRequestは基本的に使用しない方がいいだろう。</p>

<h1>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h1>

<p>実際HTTPリクエストを並列で回さなければならない場合というのは限られてくるとは思う。<br>
しかも、ソケットが大量に作られてもただちに影響はない場合も多いので、うっかり見過ごしてしまう場合も多い。<br>
しかし、これが原因でハマるとなかなか辛い状況になるので、この辺りに気を使っても損はないと思う。<br>
HTTPに限らず、TCP通信を使うプログラムは、ソケット数には気を付けようという話。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2Fdc6bd2b62b62c2414642&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2Fdc6bd2b62b62c2414642&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/dc6bd2b62b62c2414642/likers" class="css-1iupg5d">60</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">62</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/dc6bd2b62b62c2414642/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/dc6bd2b62b62c2414642/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/dc6bd2b62b62c2414642/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/dc6bd2b62b62c2414642/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/dc6bd2b62b62c2414642.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-64b9de9a-5ff3-4066-bc1e-6095591f826b">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-5472574b-a4c7-48cd-97d4-25e001bb0dc0"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-5472574b-a4c7-48cd-97d4-25e001bb0dc0">{}</script>
      
<div id="LoginModal-react-component-5c8ab56f-5937-4b49-aa3a-0692f8773f9a"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-5c8ab56f-5937-4b49-aa3a-0692f8773f9a">{}</script>
      
<div id="StockModal-react-component-fd89f2ff-c1e3-4650-9bea-c93143f0fcfa"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-fd89f2ff-c1e3-4650-9bea-c93143f0fcfa">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;+YyFwjdJClpoI94ZpWtPDJwtpW80NBSe/sYmqsrx6aQhIsJDGQQau0PnklWkDw4rB9CJi/6Rzw2guW3u0gx/ZA==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"始めに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A7%8B%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e始めに\u003c/h1\u003e\n\n\u003cp\u003eHttpClientをマルチスレッドかつ高負荷で回す時、少々ハマった点があったので、注意するべき点について書く。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"シングルスレッドの場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eシングルスレッドの場合\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://aspnetmonsters.com/2016/08/2016-08-27-httpclientwrong/\u003c/a\u003e にもある通り、できる限り一つのHttpClientインスタンスで使いまわすという方法で問題はない。\u003cbr\u003e\n実際自分もこういう風に使っていた。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"マルチスレッドの場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9E%E3%83%AB%E3%83%81%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eマルチスレッドの場合\u003c/h2\u003e\n\n\u003cp\u003eしかし、マルチスレッドでこれを行うと少々厄介なことになる。\u003cbr\u003e\n実際に以下のようなメソッドを適当なWindowsマシン上で実行してみよう。(要dotnet-sdk-2.0以上)\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Net\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Linq\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Net.Http\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading.Tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 予めhttp://localhost:10001で適当なhttpサーバーを動かしておく\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eMutliThreadedHttpRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eHttpClient\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Do 1000 concurrent tasks, loop 100 times\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etasks\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://localhost:10001\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnsureSuccessStatusCode\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"error(\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e,\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e): \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"done\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhenAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etasks\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"all done\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここで、実行中に\u003ccode\u003enetstat -n\u003c/code\u003eコマンドを実行してみると、環境によってはアドレスがIPv6だったり、ESTABLISHEDがTIME_WAITになっていたりと細部が異なる可能性もあるが、おそらく以下のような行が数百～数千程度表示されることになる。\u003cbr\u003e\n\u003ccode\u003e\u003cbr\u003e\nTCP 127.0.0.1:[ランダムポート] 127.0.0.1:10001 ESTABLISHED\u003cbr\u003e\n\u003c/code\u003e\u003cbr\u003e\nこれはまさに\"シングルスレッドの場合\"の記事URLで指摘された、ソケットを大量に作る現象となる。\u003cbr\u003e\n正直上記のような、HTTPリクエストを1000もの並列タスクで同時展開するというのはあまり無い状況だとは思うが、問題が出る閾値が場合によっては異なるので、実際注意は必要。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"なぜ接続が爆発するのか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AA%E3%81%9C%E6%8E%A5%E7%B6%9A%E3%81%8C%E7%88%86%E7%99%BA%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eなぜ接続が爆発するのか\u003c/h3\u003e\n\n\u003cp\u003eさて、気になるのは今回接続が爆発した原因である。\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/api/system.net.servicepointmanager.defaultconnectionlimit?view=netframework-4.7.1#System_Net_ServicePointManager_DefaultConnectionLimit\" rel=\"nofollow noopener\" target=\"_blank\"\u003eServicePointManager.DefaultConnectionLimit\u003c/a\u003e、あるいは\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/api/system.net.http.httpclienthandler.maxconnectionsperserver?view=netcore-2.0#System_Net_Http_HttpClientHandler_MaxConnectionsPerServer\" rel=\"nofollow noopener\" target=\"_blank\"\u003eHttpClientHandler.MaxConnectionsPerServer\u003c/a\u003eで制御できるらしいとの話は見つかる(自分の場合はコメントで教えてもらったけど(\u003ca href=\"/inasync\" class=\"user-mention js-hovercard\" title=\"inasync\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"inasync\"\u003e@inasync\u003c/a\u003e さん感謝))。しかし、上記のコードは実際にソケットを爆発させているのは事実だ。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"corefxの場合netcoreapp\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#corefx%E3%81%AE%E5%A0%B4%E5%90%88netcoreapp\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ecorefxの場合(netcoreapp)\u003c/h4\u003e\n\n\u003cp\u003e最大接続数の既定値がどこから来ているか探してみると、corefxの場合は大体 \u003ca href=\"https://github.com/dotnet/corefx/blob/1a5cdbe1af7a5befe16bb4581f29f0af64f4a101/src/Common/src/System/Net/Http/HttpHandlerDefaults.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eHttpHandlerDefaults.DefaultMaxConnectionsPerServer \u003c/a\u003eに行き着く。\u003cbr\u003e\n値は \u003ccode\u003eint.MaxValue\u003c/code\u003e である。というわけで、corefxの場合は常に設定を気を付けておいた方がいいということになる。\u003c/p\u003e\n\n\u003cp\u003eちなみに corefx版のHttpWebRequestについては、 \u003cstrong\u003e\u003ca href=\"https://github.com/dotnet/corefx/blob/cf191eb22e762ad740ae8a91a3fdb948d29a7b0c/src/System.Net.Requests/src/System/Net/HttpWebRequest.cs#L1111\" rel=\"nofollow noopener\" target=\"_blank\"\u003e常にHttpClientをnewしてアクセスしているようなので\u003c/a\u003e、そもそも使うべきではないという結論になる。\u003c/strong\u003e 一応HttpWebRequestについては、 \u003ca href=\"https://github.com/dotnet/platform-compat/blob/master/docs/DE0003.md\" rel=\"nofollow noopener\" target=\"_blank\"\u003e使うなという明言もされている。\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"netframeworkの場合net4x\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#netframework%E3%81%AE%E5%A0%B4%E5%90%88net4x\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003enetframeworkの場合(net4x)\u003c/h4\u003e\n\n\u003cp\u003eさて、では.NET Frameworkの場合はどのようになっているだろうか。\u003ca href=\"https://referencesource.microsoft.com/#System/net/System/Net/ServicePoint.cs,697\" rel=\"nofollow noopener\" target=\"_blank\"\u003eリファレンスソース\u003c/a\u003eを見てみると、色々処理はされているが、つまるところ \u003cstrong\u003eローカルアドレスの場合はint.MaxValue、それ以外の場合は2\u003c/strong\u003e ということらしい。\u003c/p\u003e\n\n\u003cp\u003e(正直ここは無条件に2にして欲しかった...)\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"monoの場合54\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#mono%E3%81%AE%E5%A0%B4%E5%90%8854\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003emonoの場合(5.4)\u003c/h4\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/mono/mono/blob/95b0698304cbc54fdfd2eac00692c9c8c3c8875d/mcs/class/System/System.Net/ServicePointManager.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003emonoのServicePointManager\u003c/a\u003eを見てみると、デフォルトは10のようである。\u003cbr\u003e\nしかし、実際に試してみると、シングルスレッドだったとしてもTIME_WAITが多くなってしまった。この辺りの原因は不明である(そもそも問題がない?)。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"対処法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AF%BE%E5%87%A6%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e対処法\u003c/h2\u003e\n\n\u003cp\u003eこの問題に対する対処法を書く\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"同時接続数を明示的に設定する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%90%8C%E6%99%82%E6%8E%A5%E7%B6%9A%E6%95%B0%E3%82%92%E6%98%8E%E7%A4%BA%E7%9A%84%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e同時接続数を明示的に設定する\u003c/h3\u003e\n\n\u003cp\u003eコメントで教えていただいた事だが、HttpClient(というより多分ハンドラだと思うけど)の最大同時接続数を設定するという方法が一つ。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"net-framework-471以降またはnetcoreapp20の場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#net-framework-471%E4%BB%A5%E9%99%8D%E3%81%BE%E3%81%9F%E3%81%AFnetcoreapp20%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e.NET Framework 4.7.1以降またはnetcoreapp2.0の場合\u003c/h4\u003e\n\n\u003cp\u003enet471、netcoreapp(1.0以降)で使用できるやり方(多分net471はnetcoreappからの輸入品)。\u003cbr\u003e\nこれらのバージョンの場合は、\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/api/system.net.http.httpclienthandler.maxconnectionsperserver?view=netcore-2.0\" rel=\"nofollow noopener\" target=\"_blank\"\u003eHttpClientHandler.MaxConnectionsPerServer\u003c/a\u003eを、HttpClientのコンストラクタで渡せばOK。\u003cbr\u003e\nこの方法だと影響範囲はそのインスタンスのみで、排他等考えずとも設定できるので、可能ならばこのやり方で設定するのが簡単だろう。\u003cbr\u003e\nただし、\u003cstrong\u003enetstandard2.0では使えない方法\u003c/strong\u003eなので、その場合は後述の静的プロパティに設定する必要がある。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"net-framework-47以前netstandard20以前の場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#net-framework-47%E4%BB%A5%E5%89%8Dnetstandard20%E4%BB%A5%E5%89%8D%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e.NET Framework 4.7以前、netstandard2.0以前の場合\u003c/h4\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/en-us/dotnet/api/system.net.servicepointmanager.defaultconnectionlimit?view=netframework-4.7.1#System_Net_ServicePointManager_DefaultConnectionLimit\" rel=\"nofollow noopener\" target=\"_blank\"\u003eServicePointManager.DefaultConnectionLimit\u003c/a\u003eを設定する。\u003cbr\u003e\n注意点としては、この値はHttpClient生成前に設定しておく必要があり、生成後に設定しても意味はないというところ。\u003cbr\u003e\nHttpWebRequestなどからも間接的に参照されている静的プロパティなので、アプリケーション全体に影響する項目であることは注意する必要がある。\u003cbr\u003e\nライブラリで設定すると、アプリケーション側の動作にも影響を及ぼすかもしれないので、ライブラリ側ではあまり設定しない方がいいだろう。\u003cbr\u003e\nただし、現行のほとんどの環境で使用できるやり方となるため、実際はこちらを使用することの方が多いかもしれない。\u003c/p\u003e\n\n\u003cp\u003eまた、.NET Framework 4.7以前ならば、\u003ca href=\"https://www.nuget.org/packages/System.Net.Http/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eSystem.Net.Httpパッケージ\u003c/a\u003eを追加すれば、HttpClientHandlerにMaxConnectionsPerServerが追加される。しかし、\u003cem\u003enetstandard2.0に関しては追加されない\u003c/em\u003eので注意。\u003cbr\u003e\nまた、将来的なことを考えると、System.Net.Httpパッケージ自体は今後メンテされる可能性は非常に低いので、あくまで限定的な回避方法として扱うべきだろう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"httpwebrequestgetresponseを使う\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#httpwebrequestgetresponse%E3%82%92%E4%BD%BF%E3%81%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eHttpWebRequest.GetResponseを使う\u003c/h3\u003e\n\n\u003cp\u003eとりあえずの対処法としては、\u003ca href=\"https://msdn.microsoft.com/ja-jp/library/system.net.httpwebrequest(v=vs.110).aspx\" rel=\"nofollow noopener\" target=\"_blank\"\u003eHttpWebRequest.GetResponse\u003c/a\u003eを使用して、同期的なアクセスをするというものがある。\u003cbr\u003e\n実際似たような処理をHttpWebRequestに置き換えたところ、大体の環境では\u003ccode\u003enetstat -n\u003c/code\u003eで観測できるソケット数はほぼ1-2程度に収まった。\u003c/p\u003e\n\n\u003cp\u003eちなみに、HttpWebRequestにはGetResponseAsyncという、非同期版のAPIがあるが、 \u003cstrong\u003elocalhostに設定なしで接続すると接続が爆発するので要注意\u003c/strong\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Net\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Linq\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Net.Http\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading.Tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 予めhttp://localhost:10001で適当なhttpサーバーを動かしておく\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eMultiThreadedHttpWebRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Do 1000 concurrent tasks, loop 10 times\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etasks\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// HttpWebRequestはそのリクエストごとに毎回インスタンスを作成する\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eHttpWebRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateHttp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://localhost:10001\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003eHttpWebResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStatusCode\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e200\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStatusCode\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e300\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"http response failed:\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStatusCode\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"error(\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e,\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e): \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"done\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhenAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etasks\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"all done\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eただし、ASP.NET(coreではない)内部で実行した場合等は、同じようにソケットが大量に作成された。\u003cbr\u003e\nこの辺りは推測の域を出ないが、ASP.NETの方が、リクエストごとに少々特殊な処理をしているためではないかと考えている。\u003c/p\u003e\n\n\u003cp\u003eまた、\u003cstrong\u003enetcoreapp2.0では非推奨なので、netcoreapp2.0ではこの手は使えない\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"シングルスレッドにリクエストをまとめる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E3%81%BE%E3%81%A8%E3%82%81%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eシングルスレッドにリクエストをまとめる\u003c/h3\u003e\n\n\u003cp\u003eシングルスレッドに行いたい処理をまとめ、その上で順次処理を回していくという方法。イメージとしては\u003ca href=\"http://www.hyuki.com/dp/dpinfo.html#ProducerConsumer\" rel=\"nofollow noopener\" target=\"_blank\"\u003eProducer-Consumerパターン\u003c/a\u003eに近い。Producer(HTTPリクエストを送りたいスレッド):Consumer(リクエストを順次処理するスレッド)=n:1という関係になる。\u003c/p\u003e\n\n\u003cp\u003eプラットフォームを選ばないやり方だが、実装が複雑になりやすく、またデッドロック等のマルチスレッド固有の危険性もあるので、入念なテストを行うことをお勧めする。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/dotnet/corefx/tree/master/src/System.Threading.Channels\" rel=\"nofollow noopener\" target=\"_blank\"\u003eSystem.Threading.Channels\u003c/a\u003eがあるとかなり実装も楽になると思う。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"monoの場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#mono%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003emonoの場合\u003c/h3\u003e\n\n\u003cp\u003eなぜかmonoの場合、シングルスレッドを含めてどの方法を試してみても、TIME_WAITが増加してしまった。\u003cbr\u003e\n(最初netstatのオプションを間違えて指定していたため、網に引っかからなかった)\u003cbr\u003e\nこの辺り、自分のやり方が良くないせいもあるかもしれないので、引き続き調査を行う必要がある。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"各プラットフォームランタイムでの状況最大同時接続数未設定時\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%90%84%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E3%81%A7%E3%81%AE%E7%8A%B6%E6%B3%81%E6%9C%80%E5%A4%A7%E5%90%8C%E6%99%82%E6%8E%A5%E7%B6%9A%E6%95%B0%E6%9C%AA%E8%A8%AD%E5%AE%9A%E6%99%82\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e各プラットフォーム、ランタイムでの状況(最大同時接続数未設定時)\u003c/h2\u003e\n\n\u003cp\u003e以下に表としてまとめる。なお、unityやmacも環境としては考えられるが、自分では持っていないため今回は調べていない。\u003c/p\u003e\n\n\u003cp\u003e実際に使ったコードは \u003ca href=\"https://github.com/itn3000/multihttpclienttest\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/itn3000/multihttpclienttest\u003c/a\u003e にまとめてある。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eOS\u003c/th\u003e\n\u003cth\u003eランタイム\u003c/th\u003e\n\u003cth\u003eリクエスト方法\u003c/th\u003e\n\u003cth\u003e結果(OK=ソケットが1-2程度、NG=ソケットが大量)\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003ewindows-8.1\u003c/td\u003e\n\u003ctd\u003enet461\u003c/td\u003e\n\u003ctd\u003eHttpClient+マルチスレッド\u003c/td\u003e\n\u003ctd\u003eNG\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ewindows-8.1\u003c/td\u003e\n\u003ctd\u003enet461\u003c/td\u003e\n\u003ctd\u003eHttpWebRequest(同期)\u003c/td\u003e\n\u003ctd\u003eOK\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ewindows-8.1\u003c/td\u003e\n\u003ctd\u003enet461\u003c/td\u003e\n\u003ctd\u003eHttpWebRequest(非同期)\u003c/td\u003e\n\u003ctd\u003eNG\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ewindows-8.1\u003c/td\u003e\n\u003ctd\u003enet461\u003c/td\u003e\n\u003ctd\u003eHttpClient+シングルスレッド\u003c/td\u003e\n\u003ctd\u003eOK\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003elinux(docker)\u003c/td\u003e\n\u003ctd\u003emono-5.4\u003c/td\u003e\n\u003ctd\u003eHttpClient+マルチスレッド\u003c/td\u003e\n\u003ctd\u003eNG\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003elinux(docker)\u003c/td\u003e\n\u003ctd\u003emono-5.4\u003c/td\u003e\n\u003ctd\u003eHttpWebRequest\u003c/td\u003e\n\u003ctd\u003eNG\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003elinux(docker)\u003c/td\u003e\n\u003ctd\u003emono-5.4\u003c/td\u003e\n\u003ctd\u003eHttpClient+シングルスレッド\u003c/td\u003e\n\u003ctd\u003eNG\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ewindows-8.1\u003c/td\u003e\n\u003ctd\u003enetcoreapp2.0\u003c/td\u003e\n\u003ctd\u003eHttpClient+マルチスレッド\u003c/td\u003e\n\u003ctd\u003eNG\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ewindows-8.1\u003c/td\u003e\n\u003ctd\u003enetcoreapp2.0\u003c/td\u003e\n\u003ctd\u003eHttpWebRequest\u003c/td\u003e\n\u003ctd\u003eNG\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ewindows-8.1\u003c/td\u003e\n\u003ctd\u003enetcoreapp2.0\u003c/td\u003e\n\u003ctd\u003eHttpClient+シングルスレッド\u003c/td\u003e\n\u003ctd\u003eOK\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003elinux(docker)\u003c/td\u003e\n\u003ctd\u003enetcoreapp2.0\u003c/td\u003e\n\u003ctd\u003eHttpClient+マルチスレッド\u003c/td\u003e\n\u003ctd\u003eNG\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003elinux(docker)\u003c/td\u003e\n\u003ctd\u003enetcoreapp2.0\u003c/td\u003e\n\u003ctd\u003eHttpWebRequest\u003c/td\u003e\n\u003ctd\u003eNG\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003elinux(docker)\u003c/td\u003e\n\u003ctd\u003enetcoreapp2.0\u003c/td\u003e\n\u003ctd\u003eHttpClient+シングルスレッド\u003c/td\u003e\n\u003ctd\u003eOK\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003emonoで試す場合の注意点としては、事前に\u003ca href=\"https://linux.die.net/man/1/mono\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMONO_THREADS_PER_CPU\u003c/a\u003e環境変数を2000等の大きい数字にしておかないと、かなり遅くなってしまうので、\u003cstrong\u003e必ず実行前にはMONO_THREADS_PER_CPU環境変数を設定しておくこと。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eなお、netcoreapp+win+HttpWebRequestでNGな事については、 \u003ca href=\"https://github.com/dotnet/corefx/issues/15460\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/dotnet/corefx/issues/15460\u003c/a\u003e で既に報告されている。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"最大同時接続数を設定したときの挙動比較\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%80%E5%A4%A7%E5%90%8C%E6%99%82%E6%8E%A5%E7%B6%9A%E6%95%B0%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E6%8C%99%E5%8B%95%E6%AF%94%E8%BC%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e最大同時接続数を設定したときの挙動比較\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"測定内容\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B8%AC%E5%AE%9A%E5%86%85%E5%AE%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e測定内容\u003c/h3\u003e\n\n\u003cp\u003eそれぞれ以下の三つの場合について、最大同時接続数を変化させた場合の完了までの時間を調べた。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eHttpWebRequest.GetResponseを使用した場合\u003c/li\u003e\n\u003cli\u003eシングルスレッドでHttpClientを使用した場合\u003c/li\u003e\n\u003cli\u003eマルチスレッドでHttpClientを使用した場合\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eまた、フレームワークについては、以下の場合について調べた\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eWin+netcoreapp2.0\u003c/li\u003e\n\u003cli\u003eWin+net461\u003c/li\u003e\n\u003cli\u003eLinux+netcoreapp2.0\u003c/li\u003e\n\u003cli\u003eLinux+mono-5.4(net461と対応)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eなお、実験に使用したWinとLinuxはマシン自体にかなり性能差があり(Winは実機、Linuxは仮想)、同じ量のリクエストを行うと時間がかなりかかってしまったため、処理量自体を変えてある。\u003cbr\u003e\nそのため、WinとLinux間の同条件の速度差については今回は考慮しない。\u003cbr\u003e\nまた、HttpClientの場合はハンドラごとにまた違った結果を出すかもしれないが、今回は測定していない。\u003c/p\u003e\n\n\u003cp\u003eソースは \u003ca href=\"https://github.com/itn3000/multihttpclienttest\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/itn3000/multihttpclienttest\u003c/a\u003e を参照\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"測定結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B8%AC%E5%AE%9A%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e測定結果\u003c/h3\u003e\n\n\u003cp\u003e長くなったので、Google SpreadSheetにした。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://docs.google.com/spreadsheets/d/1QADTNrEPzU5DPyB0fiMLz1xYNlmZ5Lfqs5eAqksK2T8/edit?usp=sharing\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWindows版\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003ewin+core+httpwebrequestは実行したらプロセスが終わらなくなったため、途中で強制終了した\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.google.com/spreadsheets/d/1bbPLuFh8tEvAv89WeLG5vxNuRS_UzgxotTKg8ShaGjQ/edit?usp=sharing\" rel=\"nofollow noopener\" target=\"_blank\"\u003eLinux版\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"考察\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%80%83%E5%AF%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e考察\u003c/h3\u003e\n\n\u003cp\u003enet461の場合、WinでもLinuxでもHttpWebRequestはかなり安定した性能を出していた。\u003cbr\u003e\n最大同時接続数を大きくした場合(100)は、場合によってはMultiThreadに一歩譲る場合もあるものの、それでも\u003cbr\u003e\nHttpWebRequestはソケットをほとんど作らないのに対して、MultiThreadは\u003cbr\u003e\n設定値分ソケットを作成していたので、安定性はやはりHttpWebRequestの方が上と言えると思う。\u003cbr\u003e\n古くからあるクラスなので、それだけ枯れているということだろうか。\u003cbr\u003e\n対してnetcoreapp2.0の場合、HttpWebRequestを使用するとWindowsで期待通り動作しないということが分かった。\u003c/p\u003e\n\n\u003cp\u003eHttpClient+MultiThreadは同時接続数を上げていくにつれ、性能が向上していった。\u003cbr\u003e\n特にnetcoreapp2.0でもnet461でもLinux版でその傾向が顕著だった。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"結論\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E8%AB%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結論\u003c/h3\u003e\n\n\u003cp\u003e多くの場合、 \u003cstrong\u003eHttpClient+MultiThreadで、かつ最大同時接続数をある程度の値に設定するのが正解\u003c/strong\u003e だということになる。大きすぎてもソケットを作りすぎて動作が不安定になってしまうが、小さすぎても性能がかなり落ちてしまう(特にLinux版)ので、この辺りはそれぞれの環境で実測して調整をするのが良いと思う。\u003cbr\u003e\nただし、グローバルな静的変数を設定するのがNGで、かつ.net frameworkあるいはmonoで動かすのが分かっている場合は、HttpWebRequestで動かすというのも一つの手かもしれない。\u003cbr\u003e\nただし、 \u003ca href=\"https://github.com/dotnet/corefx/issues/15460\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/dotnet/corefx/issues/15460\u003c/a\u003e の問題があり、かつ\u003ca href=\"https://github.com/dotnet/platform-compat/blob/master/docs/DE0003.md\" rel=\"nofollow noopener\" target=\"_blank\"\u003e互換性のために残されているだけ\u003c/a\u003eとのことなので、netcoreappなアプリ、及び今後何か新しく作る場合はHttpWebRequestは基本的に使用しない方がいいだろう。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"終わりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e終わりに\u003c/h1\u003e\n\n\u003cp\u003e実際HTTPリクエストを並列で回さなければならない場合というのは限られてくるとは思う。\u003cbr\u003e\nしかも、ソケットが大量に作られてもただちに影響はない場合も多いので、うっかり見過ごしてしまう場合も多い。\u003cbr\u003e\nしかし、これが原因でハマるとなかなか辛い状況になるので、この辺りに気を使っても損はないと思う。\u003cbr\u003e\nHTTPに限らず、TCP通信を使うプログラムは、ソケット数には気を付けようという話。\u003c/p\u003e\n","createdAt":"2017-12-24T07:52:44Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"p2ViAtfVt7EsDsx0dUvM2E56c7XfQXkD--DdgQm0IYk3iXWjrR--ocg5QufQ8GnZzT3I5jA5Cw==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2018-09-26T01:59:01Z","likesCount":60,"linkUrl":"https://qiita.com/skitoy4321/items/dc6bd2b62b62c2414642","organization":null,"originalId":593584,"stockedCount":62,"title":"HttpClientをマルチスレッドで運用する場合の注意点","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A7%8B%E3%82%81%E3%81%AB\"\u003e始めに\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E5%A0%B4%E5%90%88\"\u003eシングルスレッドの場合\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9E%E3%83%AB%E3%83%81%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E5%A0%B4%E5%90%88\"\u003eマルチスレッドの場合\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AA%E3%81%9C%E6%8E%A5%E7%B6%9A%E3%81%8C%E7%88%86%E7%99%BA%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B\"\u003eなぜ接続が爆発するのか\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#corefx%E3%81%AE%E5%A0%B4%E5%90%88netcoreapp\"\u003ecorefxの場合(netcoreapp)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#netframework%E3%81%AE%E5%A0%B4%E5%90%88net4x\"\u003enetframeworkの場合(net4x)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#mono%E3%81%AE%E5%A0%B4%E5%90%8854\"\u003emonoの場合(5.4)\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AF%BE%E5%87%A6%E6%B3%95\"\u003e対処法\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%90%8C%E6%99%82%E6%8E%A5%E7%B6%9A%E6%95%B0%E3%82%92%E6%98%8E%E7%A4%BA%E7%9A%84%E3%81%AB%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\"\u003e同時接続数を明示的に設定する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#net-framework-471%E4%BB%A5%E9%99%8D%E3%81%BE%E3%81%9F%E3%81%AFnetcoreapp20%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e.NET Framework 4.7.1以降またはnetcoreapp2.0の場合\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#net-framework-47%E4%BB%A5%E5%89%8Dnetstandard20%E4%BB%A5%E5%89%8D%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e.NET Framework 4.7以前、netstandard2.0以前の場合\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#httpwebrequestgetresponse%E3%82%92%E4%BD%BF%E3%81%86\"\u003eHttpWebRequest.GetResponseを使う\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AB%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E3%81%BE%E3%81%A8%E3%82%81%E3%82%8B\"\u003eシングルスレッドにリクエストをまとめる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#mono%E3%81%AE%E5%A0%B4%E5%90%88\"\u003emonoの場合\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%90%84%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E3%81%A7%E3%81%AE%E7%8A%B6%E6%B3%81%E6%9C%80%E5%A4%A7%E5%90%8C%E6%99%82%E6%8E%A5%E7%B6%9A%E6%95%B0%E6%9C%AA%E8%A8%AD%E5%AE%9A%E6%99%82\"\u003e各プラットフォーム、ランタイムでの状況(最大同時接続数未設定時)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%80%E5%A4%A7%E5%90%8C%E6%99%82%E6%8E%A5%E7%B6%9A%E6%95%B0%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%9F%E3%81%A8%E3%81%8D%E3%81%AE%E6%8C%99%E5%8B%95%E6%AF%94%E8%BC%83\"\u003e最大同時接続数を設定したときの挙動比較\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B8%AC%E5%AE%9A%E5%86%85%E5%AE%B9\"\u003e測定内容\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B8%AC%E5%AE%9A%E7%B5%90%E6%9E%9C\"\u003e測定結果\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%80%83%E5%AF%9F\"\u003e考察\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E8%AB%96\"\u003e結論\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e終わりに\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":23814,"uuid":"dc6bd2b62b62c2414642","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"pDDBb/AWaH2F+/y8eLm3ySrmlACs--enlDXglW3FpfDt4N--PFFN4sCx0xWwP83mi31iJg==","originalId":103253,"description":"","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=a7dce827dc16582e1b8e9c7a52216638","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","urlName":"skitoy4321","websiteUrl":"","twitterUrl":"https://twitter.com/skitoy4321","twitterUrlName":"skitoy4321","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"HttpClient","urlName":"httpclient"}],"followingLikers":{"edges":[]},"comments":{"totalCount":9}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
