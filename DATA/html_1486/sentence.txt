More than 1 year has passed since last update.コーディングをする中で T4 を使うシーンが出たため, 備忘録代わりに記事にしていきます.T4 とはなんぞや？？という方は, 公式の概要ページ を一読してみてください.今回は, 2種類ある T4テキストテンプレート の中の デザイン時T4テキストテンプレート について記述します.かなり部分的な内容しか記述しませんが, 今回の記事内容のことを把握していればやりたいことはだいたいできると思います.もし, やりたいことに対して記事内容が不足している場合は辺りを参考にしていただくと、やりたいことを実現するための情報が得られるかもしれないです.こういう練習にはすでに存在しているものを再発明するのがわかりやすくて良いので, Action を自前実装した MyAction というものを作っていきたいと思います.ご存知の方が多いとは思いますが, Action の定義は以下のような煩雑なコードの繰り返しとなっているため, 手で書くのは非常に面倒です.そこで今回はこれを T4 を利用して作成してみます.イメージとしては, 以下のようなコードが生成されるのが今回のゴールです.プロジェクト を右クリックして, 新しい項目の追加 から テキストテンプレート を追加します.
今回は MyActionTemplate.tt という名称で追加しました.    無事追加できればプロジェクト以下にファイルが追加されると思います.  MyActionTemplate.tt を開くと以下のようになっていると思います.この最終行の output extension の値を変更することで, 出力時の拡張子を変更することができます.
今回はもちろん .cs とします.また, 今回は利用しませんが System.IO などをテンプレート作成時に利用したい場合, import namespace を追加してあげます.修正した状態で上書き保存をすると, 以下のように MyActionTemplate.cs が .tt に紐づく形で追加されると思います.
もし, 紐づく形で表示されない場合は, 一度 MyActionTemplate.cs を削除したあとに, MyActionTemplate.tt を上書き保存をすると正しく表示されると思います.テンプレート内では定義されている 変数 や メソッド を利用することが可能です.これらは利用したいときに定義可能ですが, 情報が散乱すると後でテンプレートを修正するときに泣きをみるので, おとなしく一まとめにしておきましょう.今回は最上部で一括定義することにします.定義する際には コントロールブロック と呼ばれる &lt;# ～ #&gt; で囲まれた中に C# コードを記述していきます.それでは, 実際に出力するテンプレートを記述していきます.と言っても大部分は通常の .cs と同様に記述ができます.試しに, 以下のような普通のコードを記述し, 上書き保存してみましょう.そうすると, MyActionTemplate.cs に以下のようにそのままC#のコードが出力されていると思います.この普通の C#コード と T4テンプレート用の記述方法 を組み合わせることで, MyAction を作成します.それではまず 1~16 までの値をループするためのコードを追加します.
これには先ほどの コントロールブロック を利用します.コントロールブロックを利用することで, ブロック内に C# の forループ を記述することができます.
もちろん foreachループ や if文 などの制御構文を利用することもできます.} もコントロールブロックで囲む必要があることに注意してください.では, do something の位置に, 実際に MyAction を定義してみます.型パラメータ と パラメータ を作成するためにそれぞれメソッドを利用しています.
コントロールブロック では メソッドの結果を利用することができない ため, ここでは 式コントロールブロック と呼ばれる &lt;#= ～ #&gt; で囲まれた式の結果を文字列として出力する機能を利用しています.上記のような変更を加えてから上書き保存をすることで, MyActionTemplate.cs は以下のようになっていると思います.これで引数を必要とする MyAction は定義できましたが, 引数がいらない MyAction は定義できていないので, 最後に一行差し込んでおきます.for文の外に追記していることに注意してください.
上記の変更を加えてから上書き保存をすることで, MyActionTemplate.cs は以下のようになっていると思います.これで MyAction の完成です！今回紹介した機能は T4テキストテンプレート機能 のごくごく一部のものだけです.
もっと詳しく知りたい方は, 公式リファレンス を熟読することをオススメします.


