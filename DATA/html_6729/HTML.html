<!DOCTYPE html><html><head><meta charset="utf-8" /><title>[Unity] C# JobSystem を利用してテキストファイルを非同期でパースする - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/kawai125/items/13390f25700dd89c0f2e" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="s+mu8crTDru1XAXxTqaRt98rS/vBkhhVszBkE19s3qX/dcqddCYosvmh/dZozUzDxoguABf1bT0SkaBhXs0Naw==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="[Unity] C# JobSystem を利用してテキストファイルを非同期でパースする - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XMVZ1YVhSNVhTQkRJeUJLYjJKVGVYTjBaVzBnNDRLUzVZaXA1NVNvNDRHWDQ0R200NE9HNDRLdDQ0SzU0NE9JNDRPVjQ0S2g0NEtrNDRPcjQ0S1M2WjJlNVpDTTVweWY0NEduNDRPUjQ0Tzg0NEs1NDRHWjQ0S0wmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9M2E4YTNhNTg5YzNiMWEzOWUwNzBlOGVhNTFhMDQwMmM&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3RoZDJGcE1USTEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1lMDdlNDFiOTUxYTFjMDBjNzIwZDg2MmQ2MzljOTVmMg&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=e394e450f270ddde02a0f1588762bb5e"><meta property="og:description" content="一定時間ごとにある程度の大きさのテキストファイルを読み込んで、その内容を反映させるプロジェクトのため、Unity(C#)で使える高速なファイルアクセスAPIを調べて AsyncReadManager に行きつきました。

偉大なる先駆..."><meta content="https://qiita.com/kawai125/items/13390f25700dd89c0f2e" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity,JobSystem" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-2eae71b1-6974-494d-bdf0-a62464645654"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fkawai125%2Fitems%2F13390f25700dd89c0f2e">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fkawai125%2Fitems%2F13390f25700dd89c0f2e">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-2eae71b1-6974-494d-bdf0-a62464645654">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2021-02-21T14:13:45.000+09:00","dateModified":"2021-04-27T00:50:55.000+09:00","headline":"[Unity] C# JobSystem を利用してテキストファイルを非同期でパースする","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XMVZ1YVhSNVhTQkRJeUJLYjJKVGVYTjBaVzBnNDRLUzVZaXA1NVNvNDRHWDQ0R200NE9HNDRLdDQ0SzU0NE9JNDRPVjQ0S2g0NEtrNDRPcjQ0S1M2WjJlNVpDTTVweWY0NEduNDRPUjQ0Tzg0NEs1NDRHWjQ0S0wmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9M2E4YTNhNTg5YzNiMWEzOWUwNzBlOGVhNTFhMDQwMmM\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3RoZDJGcE1USTEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1lMDdlNDFiOTUxYTFjMDBjNzIwZDg2MmQ2MzljOTVmMg\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=e394e450f270ddde02a0f1588762bb5e","mainEntityOfPage":"https://qiita.com/kawai125/items/13390f25700dd89c0f2e","author":{"@type":"Person","address":null,"email":null,"identifier":"kawai125","name":"kawai125","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F31260712%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cc4d90d3da39dfe34da7cb961991ce8d","url":"https://qiita.com/kawai125","description":null,"memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"kawai125","type":"items","id":"13390f25700dd89c0f2e"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"kawai125","type":"items","id":"13390f25700dd89c0f2e"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"kawai125","type":"items","id":"13390f25700dd89c0f2e"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/kawai125/items/13390f25700dd89c0f2e","location":"/kawai125/items/13390f25700dd89c0f2e","scheme":"https","host":"qiita.com","port":null,"pathname":"/kawai125/items/13390f25700dd89c0f2e","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"gIn1mix4wWgaBV9TD3R/yy/RiNxJu+7c/qMkC7FwnhzMFZH2ko3nYVb4p3QpH6K/NnLtJ5/cm7RfAuB5sNFN0g==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-e97846bd-26f9-40b3-bb2d-372a6589d46b"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/kawai125/items/13390f25700dd89c0f2e/likers" class="css-1iupg5d">16</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">15</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/13390f25700dd89c0f2e/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/kawai125/items/13390f25700dd89c0f2e/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/kawai125/items/13390f25700dd89c0f2e/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/kawai125/items/13390f25700dd89c0f2e/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/kawai125/items/13390f25700dd89c0f2e.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2020/unity3" class="it-AdcalRibbon_title">Unity #3<!-- --> Advent Calendar<!-- --> <!-- -->2020</a>Day 14</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/kawai125"><img class="css-100alwu eyfquo10" src="https://avatars.githubusercontent.com/u/31260712?v=4" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/kawai125" class="css-10ougpm">@<!-- -->kawai125</a><div class="css-1ay9vb9"><span><meta content="2021-02-21T05:13:45Z"/><time dateTime="2021-04-26T15:50:55Z" class="css-m19uds">updated at 2021-04-26</time></span></div></div></div></div></div><h1 class="css-cgzq40">[Unity] C# JobSystem を利用してテキストファイルを非同期でパースする</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/jobsystem" class="css-4czcte">JobSystem</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>一定時間ごとにある程度の大きさのテキストファイルを読み込んで、その内容を反映させるプロジェクトのため、Unity(C#)で使える高速なファイルアクセスAPIを調べて <code>AsyncReadManager</code> に行きつきました。</p>

<p>偉大なる先駆者様 :<br>
<a href="https://qiita.com/mao_/items/8f95bc9dbeb3179ba4b9" id="reference-b90dc243d5620f34f3c3">【Unity】ファイルを非同期で読み込んでアンマネージドメモリに展開できるAsyncReadManagerを試してみた</a></p>

<p>この先行研究ではメインスレッド上での動作確認とメモリ負荷の検証が主で、本文でさらっと</p>

<blockquote>
<p>アンマネージドメモリにデータをキャッシュすると言いつつも、実装としてはJob等で並列化せずに愚直にメインスレッド上でパースを行っております。。(もう少し工夫すればJob化出来そうな気がしなくもなく。。要検証)</p>
</blockquote>

<p>との表記に誘われて四苦八苦した結果、どうにか動くようになりましたので紹介させていただきます。<br>
Unityプロジェクトなのに外部ファイル(しかもテキスト)をたくさん使うとか、非常にニッチな需要だとは思いますがそんな誰かの役にも立てばいいな……</p>

<p>Unityアドカレに1個未投稿の枠があったので、今更ながら滑り込ませていただきました。</p>

<h1>
<span id="成果物" class="fragment"></span><a href="#%E6%88%90%E6%9E%9C%E7%89%A9"><i class="fa fa-link"></i></a>成果物</h1>

<p>C# JobSystem で文字列の類をいい感じに扱うツールセットは最終的に以下のようになりました。<br>
最新版は Burst による最適化に対応しました。<a href="https://qiita.com/kawai125/items/540dd8e5d2b4c7c1fa3b" id="reference-2e47aebe179aa3d3036a">Burstの利用方法と性能評価についてはBurst編を参照してください。</a></p>

<p>GitHub<br>
<a href="https://github.com/kawai125/NativeStringCollections" rel="nofollow noopener" target="_blank">NativeStringCollections</a></p>

<h1>
<span id="動作環境" class="fragment"></span><a href="#%E5%8B%95%E4%BD%9C%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>動作環境</h1>

<ul>
<li>Unity 2019.4.24f1

<ul>
<li>Collections 0.9.0-preview.6</li>
</ul>
</li>
</ul>

<h1>
<span id="使い方" class="fragment"></span><a href="#%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>使い方</h1>

<p>雰囲気はこんな感じ。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">NativeStringCollections</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">TextData</span> <span class="p">:</span> <span class="n">ITextFileParser</span>
<span class="p">{</span>
    <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">DataElement</span><span class="p">&gt;</span> <span class="n">Data</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Init</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="cm">/* クラス初期化。 new() 後に一度だけ呼ばれる */</span>
        <span class="cm">/* ここだけはメインスレッドで実行されるのでマネージ型を使ってもいい */</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Clear</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="cm">/* パース準備。 ParseLines(lines) が始まる前に一度呼ばれる */</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">ParseLines</span><span class="p">(</span><span class="n">NativeStringList</span> <span class="n">lines</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span><span class="n">lines</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">line</span> <span class="p">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="cm">/* line を解析する。 次の行も読みたいなら true を返す */</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">PostProc</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="cm">/* 後処理。 ParseLines(lines) が終わったら一度呼ばれる */</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">UnLoad</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="cm">/* 一時的にデータを破棄したいときにここに処理を書く */</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Hoge</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="n">AsyncTextFileReader</span><span class="p">&lt;</span><span class="n">TextData</span><span class="p">&gt;</span> <span class="n">reader</span><span class="p">;</span>

    <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AsyncTextFileReader</span><span class="p">&lt;</span><span class="n">TextData</span><span class="p">&gt;(</span><span class="n">Allocator</span><span class="p">.</span><span class="n">Persistent</span><span class="p">);</span> <span class="p">}</span>

    <span class="k">void</span> <span class="nf">OnClickLoadFile</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// どこかでファイル読み込みの指示を出す (必要なら Encoding も指定する)</span>
        <span class="n">reader</span><span class="p">.</span><span class="n">Encoding</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">;</span>
        <span class="n">reader</span><span class="p">.</span><span class="nf">LoadFile</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 進捗を表示できる (Read, Length ともに BlockSize単位のint)</span>
        <span class="kt">var</span> <span class="n">info</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetState</span>
        <span class="kt">float</span> <span class="n">progress</span> <span class="p">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">info</span><span class="p">.</span><span class="n">Read</span> <span class="p">/</span> <span class="n">info</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>

        <span class="c1">// 終わってたら Complete()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">JobState</span> <span class="p">==</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">WaitForCallingComplete</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">reader</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

            <span class="c1">// 読み込みにかかった時間も出せる  [ms]</span>
            <span class="kt">double</span> <span class="n">delay</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">GetState</span><span class="p">.</span><span class="n">Delay</span><span class="p">;</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">$" file loading completed. time = </span><span class="p">{</span><span class="n">delay</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"F2"</span><span class="p">)}</span><span class="s"> [ms]."</span><span class="p">);</span>

            <span class="c1">// データを取り出して何かする</span>
            <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Data</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">OnDestroy</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// データのDispose() は外で行う。 reader だけ先に Dispose() してもよい</span>
        <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Data</span><span class="p">;</span>  
        <span class="n">reader</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>

        <span class="n">data</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>文字列の具体的な変換はこんな感じ</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">NativeStringCollections</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">TextData</span> <span class="p">:</span> <span class="n">ITextFileParser</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">DataElement</span><span class="p">&gt;</span> <span class="n">Data</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">NativeStringList</span> <span class="n">mark_list</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">StringEntity</span> <span class="n">check_mark</span><span class="p">;</span>

    <span class="c1">// パース中に string を使いたい場合は</span>
    <span class="c1">// Init() 内で NativeStringList や NativeList&lt;char&gt; に格納しておく</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Init</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Data</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">DataElement</span><span class="p">&gt;(</span><span class="n">Allocator</span><span class="p">.</span><span class="n">Persistent</span><span class="p">);</span>
        <span class="n">mark_list</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NativeStringList</span><span class="p">(</span><span class="n">Allocator</span><span class="p">.</span><span class="n">Persistent</span><span class="p">);</span>

        <span class="n">mark_list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"STRONG"</span><span class="p">);</span>
        <span class="n">mark_list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Normal"</span><span class="p">)</span>

        <span class="c1">// NativeStringList から StringEntity を取り出すのは値を全て格納してから</span>
        <span class="c1">// あるいは全ての文字列を格納しきれるようあらかじめ大きな Capacity を設定しておく</span>
        <span class="c1">// (StringEntity を取り出した後にバッファが再確保されると不正メモリ参照でクラッシュ)</span>
        <span class="n">check_mark</span> <span class="p">=</span> <span class="n">mark_list</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">// 改行コードはあらかじめ解析されて NativeStringList に格納される</span>
    <span class="c1">// List&lt;string&gt; のような感覚で使う</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">ParseLines</span><span class="p">(</span><span class="n">NativeStringList</span> <span class="n">lines</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">bool</span> <span class="n">continueRead</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span><span class="n">lines</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">line</span> <span class="p">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">continueRead</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">ParseLineImpl</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="kt">bool</span> <span class="nf">ParseLineImpl</span><span class="p">(</span><span class="n">ReadOnlyStringEntity</span> <span class="n">line</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// StringEntity.Split() の結果を受け取るリスト</span>
        <span class="kt">var</span> <span class="n">str_list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">ReadOnlyStringEntity</span><span class="p">&gt;(</span><span class="n">Allocator</span><span class="p">.</span><span class="n">Temp</span><span class="p">);</span>

        <span class="c1">// カンマ区切りで "CharaName_STRONG,11,64,15.7,1.295e+3" みたいなデータだったなら</span>
        <span class="n">line</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sc">','</span><span class="p">,</span> <span class="n">str_list</span><span class="p">);</span>

        <span class="c1">// こんな風に</span>
        <span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">str_list</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>

        <span class="kt">bool</span> <span class="n">success</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">success</span> <span class="p">=</span> <span class="n">success</span> <span class="p">&amp;&amp;</span> <span class="n">str_list</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="nf">TryParse</span><span class="p">(</span><span class="k">out</span> <span class="kt">long</span> <span class="n">ID</span><span class="p">);</span>
        <span class="n">success</span> <span class="p">=</span> <span class="n">success</span> <span class="p">&amp;&amp;</span> <span class="n">str_list</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="nf">TryParse</span><span class="p">(</span><span class="k">out</span> <span class="kt">int</span> <span class="n">HP</span><span class="p">);</span>
        <span class="n">success</span> <span class="p">=</span> <span class="n">success</span> <span class="p">&amp;&amp;</span> <span class="n">str_list</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="nf">TryParse</span><span class="p">(</span><span class="k">out</span> <span class="kt">float</span> <span class="n">Attack</span><span class="p">);</span>
        <span class="n">success</span> <span class="p">=</span> <span class="n">success</span> <span class="p">&amp;&amp;</span> <span class="n">str_list</span><span class="p">[</span><span class="m">4</span><span class="p">].</span><span class="nf">TryParse</span><span class="p">(</span><span class="k">out</span> <span class="kt">double</span> <span class="n">Speed</span><span class="p">);</span>

        <span class="c1">// こんなことも</span>
        <span class="kt">int</span> <span class="n">mark_index</span> <span class="p">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="n">check_mark</span><span class="p">);</span>  <span class="c1">// "STRONG" を検索</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mark_index</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* このキャラ特有の何か */</span>
        <span class="p">}</span>

        <span class="n">str_list</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">()</span>

        <span class="c1">// 正しいフォーマットとして解析できたか</span>
        <span class="k">if</span><span class="p">(!</span><span class="n">success</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>  <span class="c1">// 解釈できなかったのでパース中止</span>

        <span class="n">Data</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">DataElement</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">HP</span><span class="p">,</span> <span class="n">Attack</span><span class="p">,</span> <span class="n">Speed</span><span class="p">));</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>  <span class="c1">// 解釈できたので次の行に進む</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>このような具合に。<br>
実際には JobSystem の中で処理されますが、ユーザーが書く部分は通常のC#にだいぶ近い感じに設計できたと思います。</p>

<p>また、上記 <code>class TextData</code> は各プロジェクトにおいて適宜差し替えて使用することが前提ですが、常に JobSystem で実行されるとデバッグが面倒です。なのでメインスレッドでの実行を強制する下記のAPIもあります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AsyncTextFileReader</span><span class="p">&lt;</span><span class="n">NewProjectData</span><span class="p">&gt;(</span><span class="n">Allocator</span><span class="p">.</span><span class="n">Persistent</span><span class="p">);</span>
<span class="n">reader</span><span class="p">.</span><span class="n">Encoding</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">;</span>
<span class="n">reader</span><span class="p">.</span><span class="n">Path</span> <span class="p">=</span> <span class="n">path</span><span class="p">;</span>

<span class="c1">// この場合 ParseLine(line) 内で Debug.Log() が使える。</span>
<span class="c1">// また、 var sb = new StringBuilder() や (obj).ToString() をしてもよい。</span>
<span class="n">reader</span><span class="p">.</span><span class="nf">LoadFileInMainThread</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">JobState</span> <span class="p">==</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">WaitForCallingComplete</span><span class="p">)</span> <span class="n">reader</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="c1">// データを取り出してデバッグする</span>
<span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">Data</span><span class="p">;</span>

<span class="n">reader</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
</code></pre></div></div>

<p>ちなみに、<a href="https://qiita.com/mao_/items/8f95bc9dbeb3179ba4b9" title="【Unity】ファイルを非同期で読み込んでアンマネージドメモリに展開できるAsyncReadManagerを試してみた">先駆者様の例</a>と同等のサイズの 50万キャラクターのファイルについて、当方の環境では</p>

<table>
<thead>
<tr>
<th style="text-align: left">処理内容</th>
<th style="text-align: center">経過時間</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">File.ReadAllLines()から解析</td>
<td style="text-align: center">710~850ms</td>
</tr>
<tr>
<td style="text-align: left">CharaDataParser.ParseLines(lines)で解析</td>
<td style="text-align: center">460~480ms</td>
</tr>
<tr>
<td style="text-align: left">CharaDataParser.ParseLines(lines)を<a href="https://qiita.com/kawai125/items/540dd8e5d2b4c7c1fa3b#burst-%E7%89%88%E3%81%AE%E6%80%A7%E8%83%BD%E8%A9%95%E4%BE%A1" id="reference-2e47aebe179aa3d3036a">Burst</a>
</td>
<td style="text-align: center">240~250ms</td>
</tr>
</tbody>
</table>

<p>となっており、 C# string と高速化の相性の悪さが如実に表れています。<br>
これで <code>File.ReadAllLines()</code> を使わずに済むようになるでしょう。</p>

<h1>
<span id="中身のお話-あるいは四苦八苦の記録" class="fragment"></span><a href="#%E4%B8%AD%E8%BA%AB%E3%81%AE%E3%81%8A%E8%A9%B1-%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E5%9B%9B%E8%8B%A6%E5%85%AB%E8%8B%A6%E3%81%AE%E8%A8%98%E9%8C%B2"><i class="fa fa-link"></i></a>中身のお話 (あるいは四苦八苦の記録)</h1>

<h2>
<span id="asyncreadmanagerをnativecontainer風にラップしておく" class="fragment"></span><a href="#asyncreadmanager%E3%82%92nativecontainer%E9%A2%A8%E3%81%AB%E3%83%A9%E3%83%83%E3%83%97%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F"><i class="fa fa-link"></i></a>▽AsyncReadManagerをNativeContainer風にラップしておく</h2>

<p><code>AsyncReadManager.Read()</code> はファイルデータのバッファ先や読み込みに関する制御情報(<code>ReadCommand</code>や<code>ReadHandle</code>)の管理が必要で、APIをそのまま使うのは面倒なのでこれらをまとめて管理する<code>AsyncByteReader</code>としてラップします。</p>

<p></p>

<p><details><summary> <code>AsyncByteReader</code> の実装(抜粋) </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">AsyncByteReader.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">internal</span> <span class="k">struct</span> <span class="nc">AsyncByteReaderInfo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">dataSize</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">Boolean</span> <span class="n">allocated</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">Boolean</span> <span class="n">_haveReadHandle</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">ReadHandle</span> <span class="n">_readHandle</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">ReadHandle</span> <span class="n">ReadHandle</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_readHandle</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">DisposeReadHandle</span><span class="p">();</span>
            <span class="n">_readHandle</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
            <span class="n">_haveReadHandle</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DisposeReadHandle</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_haveReadHandle</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_readHandle</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
            <span class="n">_haveReadHandle</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">HaveReadHandle</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_haveReadHandle</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ここで使用している PtrHandle&lt;T&gt; については後述</span>
<span class="k">public</span> <span class="k">unsafe</span> <span class="k">struct</span> <span class="nc">AsyncByteReader</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span> <span class="n">_byteBuffer</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">AsyncByteReaderInfo</span><span class="p">&gt;</span> <span class="n">_info</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">ReadCommand</span><span class="p">&gt;</span> <span class="n">_readCmd</span><span class="p">;</span>


    <span class="k">public</span> <span class="kt">int</span> <span class="n">BufferSize</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">bufferSize</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Length</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">dataSize</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// the constructor must be called by main thread only.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="nf">AsyncByteReader</span><span class="p">(</span><span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_byteBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;(</span><span class="n">Define</span><span class="p">.</span><span class="n">MinByteBufferSize</span><span class="p">,</span> <span class="n">alloc</span><span class="p">);</span>
        <span class="n">_info</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">AsyncByteReaderInfo</span><span class="p">&gt;(</span><span class="n">alloc</span><span class="p">);</span>

        <span class="n">_readCmd</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">ReadCommand</span><span class="p">&gt;(</span><span class="n">alloc</span><span class="p">);</span>

        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">bufferSize</span> <span class="p">=</span> <span class="n">Define</span><span class="p">.</span><span class="n">MinByteBufferSize</span><span class="p">;</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">dataSize</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">allocated</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_byteBuffer</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>

        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="nf">DisposeReadHandle</span><span class="p">();</span>
        <span class="n">_info</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>

        <span class="n">_readCmd</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">JobHandle</span> <span class="nf">ReadFileAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">CheckPreviousJob</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">fileInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="nf">FileInfo</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">fileInfo</span><span class="p">.</span><span class="n">Exists</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"the file '"</span> <span class="p">+</span> <span class="n">path</span> <span class="p">+</span> <span class="s">"'is not found."</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">Reallocate</span><span class="p">(</span><span class="n">fileInfo</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

        <span class="p">*</span><span class="n">_readCmd</span><span class="p">.</span><span class="n">Target</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ReadCommand</span>
        <span class="p">{</span>
            <span class="n">Offset</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
            <span class="n">Size</span> <span class="p">=</span> <span class="n">fileInfo</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span>
            <span class="n">Buffer</span> <span class="p">=</span> <span class="n">_byteBuffer</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">(),</span>
        <span class="p">};</span>

        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">dataSize</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fileInfo</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">ReadHandle</span> <span class="p">=</span> <span class="n">AsyncReadManager</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_readCmd</span><span class="p">.</span><span class="n">Target</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">ReadHandle</span><span class="p">.</span><span class="n">JobHandle</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">CheckPreviousJob</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">HaveReadHandle</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">ReadHandle</span><span class="p">.</span><span class="n">JobHandle</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"previous read job is still running. call Complete()."</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="nf">DisposeReadHandle</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Complete</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">ReadHandle</span><span class="p">.</span><span class="n">JobHandle</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span><span class="p">*</span> <span class="nf">GetUnsafePtr</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_byteBuffer</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">byte</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_byteBuffer</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
</div>

<p></p>
</div></details></p>

<p>これを用いることで、以下のようにNativeContainerに近い感覚で<code>AsyncReadManager.Read()</code>を使えるようになります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// reader を作成</span>
<span class="kt">var</span> <span class="n">byte_reader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AsyncByteReader</span><span class="p">(</span><span class="n">Allocator</span><span class="p">.</span><span class="n">Persistent</span><span class="p">);</span>

<span class="c1">// 読み込み開始</span>
<span class="n">JobHandle</span> <span class="n">job</span> <span class="p">=</span> <span class="n">byte_reader</span><span class="p">.</span><span class="nf">ReadFileAsync</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

<span class="c1">// 読み込んだバッファにアクセス</span>
<span class="n">job</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>  <span class="c1">// byte_reader.Complete() でも可</span>
<span class="k">void</span><span class="p">*</span> <span class="n">ptr</span> <span class="p">=</span> <span class="n">byte_reader</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">length</span> <span class="p">=</span> <span class="n">byte_reader</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>

<span class="c1">// reader を破棄</span>
<span class="n">byte_reader</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
</code></pre></div></div>

<h2>
<span id="string-使用禁止-しかし-encoding-や-parse--split-は欲しい" class="fragment"></span><a href="#string-%E4%BD%BF%E7%94%A8%E7%A6%81%E6%AD%A2-%E3%81%97%E3%81%8B%E3%81%97-encoding-%E3%82%84-parse--split-%E3%81%AF%E6%AC%B2%E3%81%97%E3%81%84"><i class="fa fa-link"></i></a>▽string 使用禁止！ しかし Encoding や Parse() 、 Split() は欲しい……</h2>

<h3>
<span id="c-string-と-jobsystem-の相克" class="fragment"></span><a href="#c-string-%E3%81%A8-jobsystem-%E3%81%AE%E7%9B%B8%E5%85%8B"><i class="fa fa-link"></i></a>C# string と JobSystem の相克</h3>

<p>C# における文字列解析、というと、よくある例としては <code>Files.ReadAllLines()</code> で string[] を受け取り、イテレータで行ごとに回してそこから望みのフォーマットに <code>split()</code> で切り出した後、数値に変換するなら <code>Parse()</code> メソッドを使用する、というパターンかと思います。<br><br>
しかしこのデザインの根幹である <code>string</code> は参照型で、たとえ <code>GCHandle</code> などを使用し JobSystem に持ち込んでも string インスタンスの生成は当然できないので <code>String.Split()</code> が使えません。<br><br>
そこで本実装では <a href="https://qiita.com/mao_/items/220ccf3b2ef929388036#unity2019%E7%B3%BB%E7%B5%B1%E3%81%8B%E3%82%89%E3%81%AF%E5%B0%91%E3%81%97%E6%89%B1%E3%81%84%E3%81%8C%E7%95%B0%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%8D%E3%81%A6%E3%81%84%E3%82%8B" id="reference-c808051f601980b82aa7">Unity 2019.1 より char 型の NativeContainer を作成できるようになった</a> ことを利用して、文字列はまるっと <code>NativeList&lt;char&gt;</code> に保持して、これに <code>string</code> のように扱えるインターフェイスを被せることにしました。<br><br>
まず文字列全体の管理として、 <code>string</code> (のようなもの)が集合した <code>char</code> についての<a href="https://docs.microsoft.com/ja-jp/dotnet/csharp/programming-guide/arrays/jagged-arrays#:%7E:text=%E3%82%B8%E3%83%A3%E3%82%B0%E9%85%8D%E5%88%97%E3%81%AF%E3%80%81%E3%81%9D%E3%81%AE%E8%A6%81%E7%B4%A0,%E9%85%8D%E5%88%97%E3%81%8B%E3%82%89%E3%81%AA%E3%82%8B%E9%85%8D%E5%88%97%E3%81%A7%E3%81%99%E3%80%82" title="C# プログラミング ガイド ジャグ配列は、その要素,配列からなる配列です。" rel="nofollow noopener" target="_blank">ジャグ配列</a> に相当するコンテナにデータ本体を保持し、外側配列のインデックスアクセスで当該部分のスライスを取り出す、という形にします。 <code>List&lt;string&gt;</code> のように使えることを目標とします。<br><br>
大本の管理 struct は何となくジェネリックにします。</p>

<p><details><summary> ジェネリックなデータ本体部 <code>NativeJaggedArray&lt;T&gt;</code> の実装(抜粋) </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">NativeJaggedArray.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">struct</span> <span class="nc">NativeJaggedArray</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IDisposable</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">unmanaged</span><span class="p">,</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">struct</span> <span class="nc">ElemIndex</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Start</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Length</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">End</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Start</span> <span class="p">+</span> <span class="k">this</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

        <span class="k">public</span> <span class="nf">ElemIndex</span><span class="p">(</span><span class="kt">int</span> <span class="n">st</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">Start</span> <span class="p">=</span> <span class="n">st</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="n">Length</span> <span class="p">=</span> <span class="n">len</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">_buff</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">ElemIndex</span><span class="p">&gt;</span> <span class="n">_elemIndexList</span><span class="p">;</span>

<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>    <span class="k">private</span> <span class="n">NativeArray</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;</span> <span class="n">genTrace</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;</span> <span class="n">genSignature</span><span class="p">;</span>
<span class="cp">#endif
</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="nf">NativeJaggedArray</span><span class="p">(</span><span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_buff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">alloc</span><span class="p">);</span>
        <span class="n">_elemIndexList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">ElemIndex</span><span class="p">&gt;(</span><span class="n">alloc</span><span class="p">);</span>
        <span class="n">_alloc</span> <span class="p">=</span> <span class="n">alloc</span><span class="p">;</span>

<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>        <span class="n">genTrace</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeArray</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;(</span><span class="m">1</span><span class="p">,</span> <span class="n">alloc</span><span class="p">);</span>
        <span class="n">genSignature</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;((</span><span class="kt">long</span><span class="p">)</span><span class="n">_buff</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">(),</span> <span class="n">alloc</span><span class="p">);</span>  <span class="c1">// sigunature = address value of ptr for char_arr.</span>
<span class="cp">#endif
</span>    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Clear</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_buff</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_elemIndexList</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Length</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">_elemIndexList</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Size</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">_buff</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">elem_index</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">_elemIndexList</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
            <span class="n">T</span><span class="p">*</span> <span class="n">elem_ptr</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">*)</span><span class="k">this</span><span class="p">.</span><span class="n">_buff</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">()</span> <span class="p">+</span> <span class="n">elem_index</span><span class="p">.</span><span class="n">Start</span><span class="p">;</span>
<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>            <span class="k">return</span> <span class="k">new</span> <span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">elem_ptr</span><span class="p">,</span> <span class="n">elem_index</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetGenPtr</span><span class="p">(),</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetGen</span><span class="p">());</span>
<span class="cp">#else
</span>            <span class="k">return</span> <span class="k">new</span> <span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">elem_ptr</span><span class="p">,</span> <span class="n">elem_index</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
<span class="cp">#endif
</span>        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">T</span><span class="p">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">Start</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">_buff</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_buff</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">((</span><span class="k">void</span><span class="p">*)</span><span class="n">ptr</span><span class="p">,</span> <span class="n">Length</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_elemIndexList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">ElemIndex</span><span class="p">(</span><span class="n">Start</span><span class="p">,</span> <span class="n">Length</span><span class="p">));</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">UpdateSignature</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// specialize for NativeJaggedArraySlice&lt;T&gt;</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="slice"&gt;&lt;/param&gt;</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">slice</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="n">T</span><span class="p">*)</span><span class="n">slice</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">(),</span> <span class="n">slice</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveAt</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">CheckElemIndex</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">_elemIndexList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">_elemIndexList</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_elemIndexList</span><span class="p">.</span><span class="nf">RemoveAtSwapBack</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">gap</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nf">NextGen</span><span class="p">();</span>
<span class="cp">#endif
</span>    <span class="p">}</span>

    <span class="p">[</span><span class="nf">Conditional</span><span class="p">(</span><span class="s">"ENABLE_UNITY_COLLECTIONS_CHECKS"</span><span class="p">)]</span>
    <span class="k">unsafe</span> <span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateSignature</span><span class="p">()</span>
    <span class="p">{</span>
<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>        <span class="kt">long</span> <span class="n">now_sig</span> <span class="p">=</span> <span class="nf">GetGenSigneture</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">now_sig</span> <span class="p">!=</span> <span class="k">this</span><span class="p">.</span><span class="n">genSignature</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">NextGen</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="n">genSignature</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">now_sig</span><span class="p">;</span>
        <span class="p">}</span>
<span class="cp">#endif
</span>    <span class="p">}</span>
<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>    <span class="k">private</span> <span class="k">void</span> <span class="nf">NextGen</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">long</span> <span class="n">now_gen</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">genTrace</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="n">genTrace</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">now_gen</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="k">unsafe</span> <span class="kt">long</span> <span class="nf">GetGenSigneture</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">_buff</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">private</span> <span class="kt">long</span> <span class="nf">GetGen</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">genTrace</span><span class="p">[</span><span class="m">0</span><span class="p">];</span> <span class="p">}</span>
    <span class="k">unsafe</span> <span class="k">private</span> <span class="kt">long</span><span class="p">*</span> <span class="nf">GetGenPtr</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">*)</span><span class="k">this</span><span class="p">.</span><span class="n">genTrace</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">();</span> <span class="p">}</span>
<span class="cp">#endif
</span><span class="p">}</span> 
</code></pre></div>
</div>

<p></p>
</div></details></p>

<p><details><summary> ジェネリックなスライス部分 <code>NativeJaggedArraySlice&lt;T&gt;</code> の実装(抜粋) </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">NativeJaggedArraySlice.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">unsafe</span> <span class="k">public</span> <span class="k">interface</span> <span class="nc">IJaggedArraySliceBase</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">T</span><span class="p">:</span> <span class="n">unmanaged</span><span class="p">,</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">Length</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">T</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">slice</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">ReadOnlyNativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">slice</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">T</span><span class="p">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Length</span><span class="p">);</span>
    <span class="k">void</span><span class="p">*</span> <span class="nf">GetUnsafePtr</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">interface</span> <span class="nc">ISlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="n">T</span> <span class="nf">Slice</span><span class="p">(</span><span class="kt">int</span> <span class="n">begin</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">readonly</span> <span class="k">unsafe</span> <span class="k">struct</span> <span class="nc">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span>
    <span class="n">IJaggedArraySliceBase</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span>
    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span>
    <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;,</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span>
    <span class="n">ISlice</span><span class="p">&lt;</span><span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span>
    <span class="k">where</span> <span class="n">T</span><span class="p">:</span> <span class="n">unmanaged</span><span class="p">,</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">NativeDisableUnsafePtrRestriction</span><span class="p">]</span>
    <span class="k">internal</span> <span class="k">readonly</span> <span class="n">T</span><span class="p">*</span> <span class="n">_ptr</span><span class="p">;</span>
    <span class="k">internal</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">_len</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Length</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_len</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>    <span class="p">[</span><span class="n">NativeDisableUnsafePtrRestriction</span><span class="p">]</span>
    <span class="k">internal</span> <span class="k">readonly</span> <span class="kt">long</span><span class="p">*</span> <span class="n">_gen_ptr</span><span class="p">;</span>
    <span class="k">internal</span> <span class="k">readonly</span> <span class="kt">long</span> <span class="n">_gen_entity</span><span class="p">;</span>
<span class="cp">#endif
</span>
<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>    <span class="k">public</span> <span class="nf">NativeJaggedArraySlice</span><span class="p">(</span><span class="n">T</span><span class="p">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Length</span><span class="p">,</span> <span class="kt">long</span><span class="p">*</span> <span class="n">gen_ptr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">gen_entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_ptr</span> <span class="p">=</span> <span class="n">ptr</span><span class="p">;</span>
        <span class="n">_len</span> <span class="p">=</span> <span class="n">Length</span><span class="p">;</span>
        <span class="n">_gen_ptr</span> <span class="p">=</span> <span class="n">gen_ptr</span><span class="p">;</span>
        <span class="n">_gen_entity</span> <span class="p">=</span> <span class="n">gen_entity</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#else
</span>    <span class="k">public</span> <span class="nf">NativeJaggedArraySlice</span><span class="p">(</span><span class="n">T</span><span class="p">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_ptr</span> <span class="p">=</span> <span class="n">ptr</span><span class="p">;</span>
        <span class="n">_len</span> <span class="p">=</span> <span class="n">Length</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif
</span>
    <span class="k">public</span> <span class="n">T</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">CheckReallocate</span><span class="p">();</span>
            <span class="k">return</span> <span class="p">*(</span><span class="n">_ptr</span> <span class="p">+</span> <span class="n">index</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">CheckReallocate</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">CheckElemIndex</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
            <span class="p">*(</span><span class="n">_ptr</span> <span class="p">+</span> <span class="n">index</span><span class="p">)</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="nf">Slice</span><span class="p">(</span><span class="kt">int</span> <span class="n">begin</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">begin</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">end</span> <span class="p">=</span> <span class="n">_len</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">CheckSliceRange</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">new_len</span> <span class="p">=</span> <span class="n">end</span> <span class="p">-</span> <span class="n">begin</span><span class="p">;</span>
<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>        <span class="k">this</span><span class="p">.</span><span class="nf">CheckReallocate</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">_ptr</span> <span class="p">+</span> <span class="n">begin</span><span class="p">,</span> <span class="n">new_len</span><span class="p">,</span> <span class="n">_gen_ptr</span><span class="p">,</span> <span class="n">_gen_entity</span><span class="p">);</span>
<span class="cp">#else
</span>        <span class="k">return</span> <span class="k">new</span> <span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">_ptr</span> <span class="p">+</span> <span class="n">begin</span><span class="p">,</span> <span class="n">new_len</span><span class="p">);</span>
<span class="cp">#endif
</span>    <span class="p">}</span>
    <span class="p">[</span><span class="nf">Conditional</span><span class="p">(</span><span class="s">"ENABLE_UNITY_COLLECTIONS_CHECKS"</span><span class="p">)]</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">CheckReallocate</span><span class="p">()</span>
    <span class="p">{</span>
<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>        <span class="k">if</span><span class="p">(</span><span class="n">_gen_ptr</span> <span class="p">==</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">_gen_entity</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  <span class="c1">// ignore case for NativeJaggedArraySliceGeneratorExt</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">*(</span><span class="n">_gen_ptr</span><span class="p">)</span> <span class="p">!=</span> <span class="n">_gen_entity</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"this slice is invalid reference."</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif
</span>    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span><span class="p">*</span> <span class="nf">GetUnsafePtr</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_ptr</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p></p>
</div></details></p>

<p>スライスは本当にポインタと長さしか持ちません (release build 時)。<br><br>
<code>Unity.Collections</code> で <code>NativeArray&lt;T&gt;</code> から <code>NativeSlice&lt;T&gt;</code> は作れるのに対して <code>NativeList&lt;T&gt;</code> からは作れないのは、 List の伸縮に伴い内部バッファの再確保が行われた場合、メモリ上の位置が変わってそれまでに作ったポインタによる参照が無効になってしまうため、安全なスライスを作れないことが理由の一つとして考えられます。<br><br>
今回の実装では、文字列の取り扱いとして最初にデータ全体の構築を行い、その後は要素の追加をせずにスライスの切り出しのみを行うことを基本方針としてちょっと危なめな設計にしました。<br><br>
そうはいってもついやっちゃうこともあり得るので、要素の追加時に内部バッファの <code>_buff.GetUnsafePtr()</code> の値が変化したかどうかを確認し、それにより世代確認を行う関数 <code>CheckReallocate()</code> を実装してあります。<br>
<strong>UnityEditor 上であればやらかしを検知できます。</strong></p>

<p>これに文字列に特化したインターフェイスを被せてジャグ配列の <code>NativeStringList</code> とスライスの <code>StringEntity</code> とします。(今更だけど怒られそうな名前を付けてしまった……)</p>

<p><details><summary> <code>NativeStringList</code> の実装(抜粋) </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">NativeStringList.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">struct</span> <span class="nc">NativeStringList</span> <span class="p">:</span> <span class="n">IDisposable</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">StringEntity</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">NativeJaggedArray</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">_jarr</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="nf">NativeStringList</span><span class="p">(</span><span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span> <span class="p">{</span> <span class="n">_jarr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeJaggedArray</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;(</span><span class="n">alloc</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="n">_jarr</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="n">StringEntity</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">StringEntity</span> <span class="n">Last</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">// string のようなものへの特殊化</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">str</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_jarr</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">char</span><span class="p">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_jarr</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">Length</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">StringEntity</span> <span class="n">entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">char</span><span class="p">*)</span><span class="n">entity</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">(),</span> <span class="n">entity</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">ReadOnlyStringEntity</span> <span class="n">entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">char</span><span class="p">*)</span><span class="n">entity</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">(),</span> <span class="n">entity</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">NativeList</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">str</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">char</span><span class="p">*)</span><span class="n">str</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">NativeArray</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">str</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">char</span><span class="p">*)</span><span class="n">str</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p></p>
</div></details></p>

<p><details><summary> <code>StringEntity</code> の実装(抜粋) </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">StringEntity.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">unsafe</span> <span class="k">readonly</span> <span class="k">struct</span> <span class="nc">StringEntity</span> <span class="p">:</span>
    <span class="n">IParseExt</span><span class="p">,</span>
    <span class="n">IJaggedArraySliceBase</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;,</span>
    <span class="n">ISlice</span><span class="p">&lt;</span><span class="n">StringEntity</span><span class="p">&gt;,</span>
    <span class="n">IEquatable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;,</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">[</span><span class="k">]&gt;</span><span class="p">,</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;&gt;,</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;,</span>
    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="cm">/* 中略 */</span>

    <span class="cm">/* string のようなものへの特殊化 */</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="kt">char</span><span class="p">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">Length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">CheckReallocate</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_len</span> <span class="p">!=</span> <span class="n">Length</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

        <span class="c1">// pointing same target</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_ptr</span> <span class="p">==</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_len</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">!=</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">StringEntity</span> <span class="n">entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">CheckReallocate</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">entity</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">_ptr</span><span class="p">,</span> <span class="n">_len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">ReadOnlyStringEntity</span> <span class="n">entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">CheckReallocate</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">entity</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">_ptr</span><span class="p">,</span> <span class="n">_len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">NativeJaggedArraySlice</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">slice</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">CheckReallocate</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">slice</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">_ptr</span><span class="p">,</span> <span class="n">_len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">ReadOnlyNativeJaggedArraySlice</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">slice</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">CheckReallocate</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">slice</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">_ptr</span><span class="p">,</span> <span class="n">_len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="n">str</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">SequenceEqual</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;(</span><span class="n">str</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="kt">char</span><span class="p">[]</span> <span class="n">c_arr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="n">c_arr</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">SequenceEqual</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;(</span><span class="n">c_arr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="k">this</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">in_itr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">CheckReallocate</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">SequenceEqual</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;(</span><span class="n">in_itr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="p">==(</span><span class="n">StringEntity</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">StringEntity</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="p">!=(</span><span class="n">StringEntity</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">StringEntity</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">!</span><span class="n">lhs</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="p">==(</span><span class="n">StringEntity</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">ReadOnlyStringEntity</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="p">!=(</span><span class="n">StringEntity</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">ReadOnlyStringEntity</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">!</span><span class="n">lhs</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="p">==(</span><span class="n">StringEntity</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="k">operator</span> <span class="p">!=(</span><span class="n">StringEntity</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">!</span><span class="n">lhs</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="k">is</span> <span class="n">StringEntity</span> <span class="p">&amp;&amp;</span> <span class="p">((</span><span class="n">IJaggedArraySliceBase</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;)</span><span class="n">obj</span><span class="p">).</span><span class="nf">Equals</span><span class="p">(</span><span class="n">_ptr</span><span class="p">,</span> <span class="n">_len</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">ReadOnlyStringEntity</span> <span class="nf">GetReadOnly</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ReadOnlyStringEntity</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span><span class="p">*</span> <span class="nf">GetUnsafePtr</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_ptr</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p></p>
</div></details></p>

<p>これで <code>string</code> のようなもの同士で比較したり、スライスを切り出したりやりたい放題できるようになりました。<br>
なお、 <code>NativeJaggedArray&lt;T&gt;</code> のほうを使えば任意の <code>struct</code> についてユーザー管理の共通バッファへの参照を JobSystem と GameObject の両方にばらまくことができてしまいます。ポインタ無法地帯へはあと一歩のぎりぎりのラインにいるので、ご利用は計画的に。</p>

<h3>
<span id="encoder-の自力実装は勘弁してほしい" class="fragment"></span><a href="#encoder-%E3%81%AE%E8%87%AA%E5%8A%9B%E5%AE%9F%E8%A3%85%E3%81%AF%E5%8B%98%E5%BC%81%E3%81%97%E3%81%A6%E3%81%BB%E3%81%97%E3%81%84"><i class="fa fa-link"></i></a>Encoder の自力実装は勘弁してほしい</h3>

<ul>
<li>なので <code>GCHandle</code> で JobSystem の中に持っていく<br>
 <code>Encoder</code> , <code>Decoder</code> をバグなく実装する自信はないですし、さらに日本語の文字コードは Unicode系列 (UTF-8, UTF-16, UTF-32)のほかに Shift-JISやらEUC-JP、 ISO-2022-JPなどどんなデータを読む羽目になるか分かったものではありません。(特に古いシステムの吐いたデータほど。)<br>
 幸い C# 標準に <code>Decoder.GetChars(byte*, int, char* ,int)</code> 関数が用意されており、 <code>GCHandle</code> で持ち込みさえすれば JobSystem で使えます。</li>
<li>日本ローカルの Encoding に注意！<br>
 上で上げたエンコーディングのうち、Shift-JIS、EUC-JP、ISO-2022-JP の３つは <a href="https://helpdesk.unity3d.co.jp/hc/ja/articles/204694010-System-Text-Encoding-%E3%81%A7-Shift-JIS-%E3%82%92%E4%BD%BF%E3%81%84%E3%81%9F%E3%81%84" title="System.Text.Encoding で Shift JIS を使いたい" rel="nofollow noopener" target="_blank">UnityEditor上では普通に使えますがビルドすると必要なDLLが欠けるためプレイヤーがこけます。</a><br>
  上の記事で対応は可能ですが、レガシーの文字エンコードの対応が適当……<br>
  (いやゲームエンジンとしては不要なモノなのでまっとうな設計ではあるのですが)</li>
</ul>

<h3>
<span id="tryparse-split-strip-は自力実装" class="fragment"></span><a href="#tryparse-split-strip-%E3%81%AF%E8%87%AA%E5%8A%9B%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>TryParse(), Split(), Strip() は自力実装</h3>

<p>文字列解析用データ構造として <code>StringEntity</code> を自作してしまったので、これらのユーティリティも当然自作します。<br><br>
実装の単純化のため、C#では<code>Parse()</code> メソッドで一緒くたになっていた十進表記と１６進数表記の解析を <code>TryParse()</code> と <code>TryParseHex()</code> に分離します。パーサーを作るにあたって、どちらの表記かわからない、なんてことはないでしょうし、そもそもHexフォーマットを使う状況というのは <code>float</code> や <code>double</code> の値を確実に読み書きしたい状況ぐらいでしょう。<br><br>
<code>Split()</code> , <code>Strip()</code> については、さっそく <code>StringEntity.Slice()</code> の出番です。普通に線形探索して結果を切り出します。</p>

<h3>
<span id="base64-の変換もできると便利" class="fragment"></span><a href="#base64-%E3%81%AE%E5%A4%89%E6%8F%9B%E3%82%82%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%A8%E4%BE%BF%E5%88%A9"><i class="fa fa-link"></i></a>Base64 の変換もできると便利</h3>

<p>前節で <code>TryParseHex()</code> を用意したものの、データの利用効率が劣悪(4bit -&gt; 8bit と必要分で単純に倍、プリフィックスに <code>0x</code> をつければ 2B 追加。ASCIIコード換算で <code>float</code> が 4B -&gt; 10B = 250% になる)なので配列や構造体の生バイト列などの大きなものには正直向いていません。<br><br>
というわけで由緒正しき <a href="https://ja.wikipedia.org/wiki/Base64" rel="nofollow noopener" target="_blank">Base64</a> のコンバータを用意しましょう。<br>
<a href="https://referencesource.microsoft.com/#System/net/System/Net/mail/Base64Stream.cs,18795287b9fa8fd2" rel="nofollow noopener" target="_blank">C# Reference Source</a> の実装を参考に、テーブル変換なので中身は単純です。</p>

<p><details><summary> Base64コンバータの実装(抜粋) </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">StringParser.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// The Encoder for MIME Base64 (RFC 2045).</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">NativeBase64Encoder</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">Base64EncodeMap</span> <span class="n">_map</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">Base64Info</span><span class="p">&gt;</span> <span class="n">_info</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// convert bytes into chars in Base64 format.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="buff"&gt;output&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="byte_ptr"&gt;source ptr&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="byte_len"&gt;source length&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="splitData"&gt;additional bytes will be input or not. (false: call Terminate() internally.&lt;/param&gt;</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">GetChars</span><span class="p">(</span><span class="n">NativeList</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">buff</span><span class="p">,</span> <span class="kt">byte</span><span class="p">*</span> <span class="n">byte_ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">byte_len</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">splitData</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">byte_len</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="s">"invalid bytes length."</span><span class="p">);</span>

        <span class="kt">uint</span> <span class="n">store</span> <span class="p">=</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">store</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">bytePos</span> <span class="p">=</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">bytePos</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">charcount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">uint</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span><span class="n">byte_len</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">insertLF</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">charcount</span> <span class="p">==</span> <span class="n">Base64Const</span><span class="p">.</span><span class="n">LineBreakPos</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="sc">'\r'</span><span class="p">);</span>
                    <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
                    <span class="n">charcount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">store</span> <span class="p">=</span> <span class="p">(</span><span class="n">store</span> <span class="p">&lt;&lt;</span> <span class="m">8</span><span class="p">)</span> <span class="p">|</span> <span class="n">byte_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">bytePos</span><span class="p">++;</span>

            <span class="c1">// encoding 3 bytes -&gt; 4 chars</span>
            <span class="k">if</span><span class="p">(</span><span class="n">bytePos</span> <span class="p">==</span> <span class="m">3</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[(</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0xfc0000</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="m">18</span><span class="p">]);</span>
                <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[(</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0x03f000</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="m">12</span><span class="p">]);</span>
                <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[(</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0x000fc0</span><span class="p">)</span> <span class="p">&gt;&gt;</span>  <span class="m">6</span><span class="p">]);</span>
                <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[(</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0x00003f</span><span class="p">)]);</span>
                <span class="n">charcount</span> <span class="p">+=</span> <span class="m">4</span><span class="p">;</span>

                <span class="n">store</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                <span class="n">bytePos</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span><span class="p">;</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">bytePos</span> <span class="p">=</span> <span class="n">bytePos</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(!</span><span class="n">splitData</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nf">Terminate</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// apply termination treatment.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="buff"&gt;output&lt;/param&gt;</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Terminate</span><span class="p">(</span><span class="n">NativeList</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">&gt;</span> <span class="n">buff</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">tmp</span> <span class="p">=</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">store</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">bytePos</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="m">0</span><span class="p">:</span>
            <span class="c1">// do nothing</span>
            <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="m">1</span><span class="p">:</span>
            <span class="c1">// two character padding needed</span>
            <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[(</span><span class="n">tmp</span> <span class="p">&amp;</span> <span class="m">0xfc</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="m">2</span><span class="p">]);</span>
            <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[(</span><span class="n">tmp</span> <span class="p">&amp;</span> <span class="m">0x03</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="m">4</span><span class="p">]);</span>
            <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[</span><span class="m">64</span><span class="p">]);</span>  <span class="c1">// pad</span>
            <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[</span><span class="m">64</span><span class="p">]);</span>  <span class="c1">// pad</span>
            <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="m">2</span><span class="p">:</span>
            <span class="c1">// one character padding needed</span>
            <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[(</span><span class="n">tmp</span> <span class="p">&amp;</span> <span class="m">0xfc00</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="m">10</span><span class="p">]);</span>
            <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[(</span><span class="n">tmp</span> <span class="p">&amp;</span> <span class="m">0x03f0</span><span class="p">)</span> <span class="p">&gt;&gt;</span>  <span class="m">4</span><span class="p">]);</span>
            <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[(</span><span class="n">tmp</span> <span class="p">&amp;</span> <span class="m">0x000f</span><span class="p">)</span> <span class="p">&lt;&lt;</span>  <span class="m">2</span><span class="p">]);</span>
            <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">_map</span><span class="p">[</span><span class="m">64</span><span class="p">]);</span>  <span class="c1">// pad</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">store</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">bytePos</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_map</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="n">_info</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// The Decoder for MIME Base64 (RFC 2045).</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">NativeBase64Decoder</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">Base64DecodeMap</span> <span class="n">_map</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">Base64Info</span><span class="p">&gt;</span> <span class="n">_info</span><span class="p">;</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// convert Base64 format chars into bytes.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;param name="buff"&gt;output&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="char_ptr"&gt;source ptr&lt;/param&gt;</span>
    <span class="c1">/// &lt;param name="char_len"&gt;source length&lt;/param&gt;</span>
    <span class="c1">/// &lt;returns&gt;convert successfull or not&lt;/returns&gt;</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="kt">bool</span> <span class="nf">GetBytes</span><span class="p">(</span><span class="n">NativeList</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span> <span class="n">buff</span><span class="p">,</span> <span class="kt">char</span><span class="p">*</span> <span class="n">char_ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">char_len</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">char_len</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
<span class="cp">#if UNITY_EDITOR
</span>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="s">"invalid chars length."</span><span class="p">);</span>
<span class="cp">#else
</span>            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="cp">#endif
</span>        <span class="p">}</span>

        <span class="kt">uint</span> <span class="n">store</span> <span class="p">=</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">store</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">bytePos</span> <span class="p">=</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">bytePos</span><span class="p">;</span>

        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span><span class="n">char_len</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">char</span> <span class="n">c</span> <span class="p">=</span> <span class="n">char_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">IsWhiteSpace</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="p">==</span> <span class="sc">'='</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">bytePos</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">case</span> <span class="m">0</span><span class="p">:</span>
                    <span class="k">case</span> <span class="m">1</span><span class="p">:</span>
<span class="cp">#if UNITY_EDITOR
</span>                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"invalid padding detected."</span><span class="p">);</span>
<span class="cp">#else
</span>                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="cp">#endif
</span>                    <span class="k">case</span> <span class="m">2</span><span class="p">:</span>
                    <span class="c1">// pick 1 byte from "**==" code</span>
                    <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">byte</span><span class="p">)((</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0x0ff0</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="m">4</span><span class="p">));</span>
                    <span class="n">bytePos</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="m">3</span><span class="p">:</span>
                    <span class="c1">// pick 2 byte from "***=" code</span>
                    <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">byte</span><span class="p">)((</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0x03fc00</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="m">10</span><span class="p">));</span>
                    <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">byte</span><span class="p">)((</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0x0003fc</span><span class="p">)</span> <span class="p">&gt;&gt;</span>  <span class="m">2</span><span class="p">));</span>
                    <span class="n">bytePos</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="kt">uint</span> <span class="n">b</span> <span class="p">=</span> <span class="n">_map</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="p">!=</span> <span class="m">255</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">store</span> <span class="p">=</span> <span class="p">(</span><span class="n">store</span> <span class="p">&lt;&lt;</span> <span class="m">6</span><span class="p">)</span> <span class="p">|</span> <span class="p">(</span><span class="n">b</span> <span class="p">&amp;</span> <span class="m">0x3f</span><span class="p">);</span>
                    <span class="n">bytePos</span><span class="p">++;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="n">bytePos</span> <span class="p">==</span> <span class="m">4</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">byte</span><span class="p">)((</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0xff0000</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="m">16</span><span class="p">));</span>
                <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">byte</span><span class="p">)((</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0x00ff00</span><span class="p">)</span> <span class="p">&gt;&gt;</span>  <span class="m">8</span><span class="p">));</span>
                <span class="n">buff</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="kt">byte</span><span class="p">)((</span><span class="n">store</span> <span class="p">&amp;</span> <span class="m">0x0000ff</span><span class="p">)));</span>
                <span class="n">store</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                <span class="n">bytePos</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">store</span> <span class="p">=</span> <span class="n">store</span><span class="p">;</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">bytePos</span> <span class="p">=</span> <span class="n">bytePos</span><span class="p">;</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="kt">bool</span> <span class="nf">IsWhiteSpace</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">c</span> <span class="p">==</span> <span class="sc">' '</span> <span class="p">||</span> <span class="n">c</span> <span class="p">==</span> <span class="sc">'\t'</span> <span class="p">||</span> <span class="n">c</span> <span class="p">==</span> <span class="sc">'\n'</span> <span class="p">||</span> <span class="n">c</span> <span class="p">==</span> <span class="sc">'\r'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">internal</span> <span class="k">struct</span> <span class="nc">Base64EncodeMap</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">NativeArray</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span> <span class="n">_map</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">Base64EncodeMap</span><span class="p">(</span><span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_map</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeArray</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;(</span><span class="m">65</span><span class="p">,</span> <span class="n">alloc</span><span class="p">);</span>

        <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">byte</span> <span class="n">j</span><span class="p">=</span><span class="m">65</span><span class="p">;</span> <span class="n">j</span><span class="p">&lt;=</span><span class="m">90</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>  <span class="c1">// 'A' ~ 'Z'</span>
        <span class="p">{</span>
            <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="n">i</span><span class="p">++;</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">byte</span> <span class="n">j</span><span class="p">=</span><span class="m">97</span><span class="p">;</span> <span class="n">j</span><span class="p">&lt;=</span><span class="m">122</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span> <span class="c1">// 'a' ~ 'z'</span>
        <span class="p">{</span>
            <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="n">i</span><span class="p">++;</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">byte</span> <span class="n">j</span><span class="p">=</span><span class="m">48</span><span class="p">;</span> <span class="n">j</span><span class="p">&lt;=</span><span class="m">57</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>  <span class="c1">// '0' ~ '9'</span>
        <span class="p">{</span>
            <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="n">i</span><span class="p">++;</span>
        <span class="p">}</span>
        <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">43</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span> <span class="c1">// '+'</span>
        <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">47</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span> <span class="c1">// '/'</span>
        <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">61</span><span class="p">;</span>      <span class="c1">// '='</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">char</span> <span class="k">this</span><span class="p">[</span><span class="kt">uint</span> <span class="n">index</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&gt;</span> <span class="m">65</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="s">"input byte must be in range [0x00, 0x40]."</span><span class="p">);</span>
            <span class="k">return</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">_map</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">index</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">internal</span> <span class="k">struct</span> <span class="nc">Base64DecodeMap</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">NativeArray</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;</span> <span class="n">_map</span><span class="p">;</span>
    <span class="k">public</span> <span class="nf">Base64DecodeMap</span><span class="p">(</span><span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_map</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeArray</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">&gt;(</span><span class="m">80</span><span class="p">,</span> <span class="n">alloc</span><span class="p">);</span>

        <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">62</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span>       <span class="c1">// 0x2b, '+'</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">j</span><span class="p">&lt;</span><span class="m">3</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">255</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span>  <span class="c1">// invalid code</span>
        <span class="p">}</span>
        <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">63</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span>       <span class="c1">// 0x2f, '/'</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">byte</span> <span class="n">j</span><span class="p">=</span><span class="m">52</span><span class="p">;</span> <span class="n">j</span><span class="p">&lt;=</span><span class="m">61</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span>    <span class="c1">// '0' ~ '9'</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">byte</span> <span class="n">j</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">j</span><span class="p">&lt;</span><span class="m">7</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">255</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span>  <span class="c1">// invalid code</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">byte</span> <span class="n">j</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">j</span><span class="p">&lt;=</span><span class="m">25</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span>    <span class="c1">// 'A' ~ 'Z'</span>
        <span class="p">}</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">byte</span> <span class="n">j</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">j</span><span class="p">&lt;</span><span class="m">6</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="m">255</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span>  <span class="c1">// invalid code</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">byte</span> <span class="n">j</span> <span class="p">=</span> <span class="m">26</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;=</span> <span class="m">51</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="p">++;</span>    <span class="c1">// 'a' ~ 'z'</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">byte</span> <span class="k">this</span><span class="p">[</span><span class="kt">uint</span> <span class="n">index</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&lt;</span> <span class="m">0x2b</span><span class="p">)</span> <span class="k">return</span> <span class="m">255</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">&gt;</span> <span class="m">0x7a</span><span class="p">)</span> <span class="k">return</span> <span class="m">255</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">_map</span><span class="p">[(</span><span class="kt">int</span><span class="p">)(</span><span class="n">index</span> <span class="p">-</span> <span class="m">0x2b</span><span class="p">)];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
</div>

<p></p>
</div></details></p>

<p>元のリファレンスでは全ビットパターン分(16*16=256)テーブルが作ってありましたが、有効な値は64種類、いくつか途中にある無効な値を考慮しても端から端まで長さ80あれば足りるので、今回の実装ではせっかくなので小さくしてみました。</p>

<h2>
<span id="どうせならユーザー定義データも-class-にしてしまえばいい" class="fragment"></span><a href="#%E3%81%A9%E3%81%86%E3%81%9B%E3%81%AA%E3%82%89%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%AE%9A%E7%BE%A9%E3%83%87%E3%83%BC%E3%82%BF%E3%82%82-class-%E3%81%AB%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%88%E3%81%B0%E3%81%84%E3%81%84"><i class="fa fa-link"></i></a>▽どうせならユーザー定義データも class にしてしまえばいい</h2>

<p><code>Encoding</code> を持ち込むと決めた段階で、byte列 -&gt; char列の変換処理に Burst を使えないことが確定しました。<br>
ジョブ丸ごとの struct 化とかもう気にしなくていいので、ユーザー定義のデータコンテナも class ということにして、これも <code>GCHandle</code> でJobSystemへ持って行きます。<br>
ただしこの設計により、誤って struct のデータコンテナを渡したところ当然ながら GCHandle の取得でコケたので、最終的に class のみを受け取る形にしました。</p>

<h2>
<span id="ポインタがすべてを解決する" class="fragment"></span><a href="#%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%8C%E3%81%99%E3%81%B9%E3%81%A6%E3%82%92%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>▽ポインタがすべてを解決する</h2>

<h3>
<span id="高速化" class="fragment"></span><a href="#%E9%AB%98%E9%80%9F%E5%8C%96"><i class="fa fa-link"></i></a>高速化</h3>

<p>実は実装初期のパース速度は Chara 50万体のデータに ~ 1300 ms 程度とだいぶ遅かったのですが、プロファイラを確認したところ主要な処理負荷がインデクサ <code>this[index]</code> や <code>Length</code> フィールドから値を取り出すところだったので、ライブラリ内の処理実装部分では最初に <code>void*</code> と <code>Length</code> を取り出してポインタで直接処理するようにしました。その高速化の経過は下記の通り。</p>

<table>
<thead>
<tr>
<th style="text-align: left">処置した関数</th>
<th style="text-align: center">速度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">StringSplitter.Split()</td>
<td style="text-align: center">~1000 ms</td>
</tr>
<tr>
<td style="text-align: left">上記に加え、 TextDecoder.ParseLineImpl()</td>
<td style="text-align: center">700 ~ 800 ms</td>
</tr>
<tr>
<td style="text-align: left">上記に加え、 StringParserExt.TryParse()</td>
<td style="text-align: center">600 ~ 700 ms</td>
</tr>
<tr>
<td style="text-align: left">そのほかBoxingの除去など</td>
<td style="text-align: center">500 ~ 550 ms</td>
</tr>
</tbody>
</table>

<p>見やすいプロファイラは素晴らしい。</p>

<h3>
<span id="共有変数の管理" class="fragment"></span><a href="#%E5%85%B1%E6%9C%89%E5%A4%89%E6%95%B0%E3%81%AE%E7%AE%A1%E7%90%86"><i class="fa fa-link"></i></a>共有変数の管理</h3>

<p>また、欲しい関数の追加や処理のバッファとして内部的に使う、などにより <code>NativeContiner</code> に似たものを多数作成しましたが、状態管理用の変数ごとにポインタを作るのは手間がかかる上に事故の危険もコピーコストも増大する挙句、データがメモリ上に分散して性能に悪影響を及ぼします。<br>
よって、ジェネリックなポインタ管理ヘルパー <code>PtrHandle&lt;T&gt;</code> を作りましょう。</p>

<p><details><summary> ポインタ管理ヘルパー <code>PtrHandle&lt;T&gt;</code> の実装 </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">PtrHandle.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">unsafe</span> <span class="k">struct</span> <span class="nc">PtrHandle</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">unmanaged</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">NativeDisableUnsafePtrRestriction</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">T</span><span class="p">*</span> <span class="n">_ptr</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Allocator</span> <span class="n">_alloc</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Boolean</span> <span class="n">_isCreated</span><span class="p">;</span>

<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>    <span class="p">[</span><span class="n">NativeSetClassTypeToNullOnSchedule</span><span class="p">]</span>
    <span class="k">private</span> <span class="n">DisposeSentinel</span> <span class="n">_disposeSentinel</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">AtomicSafetyHandle</span> <span class="n">_safety</span><span class="p">;</span>
<span class="cp">#endif
</span>
    <span class="k">public</span> <span class="nf">PtrHandle</span><span class="p">(</span><span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">alloc</span> <span class="p">&lt;=</span> <span class="n">Allocator</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"Allocator must be Temp, TempJob or Persistent"</span><span class="p">,</span> <span class="k">nameof</span><span class="p">(</span><span class="n">alloc</span><span class="p">));</span>

        <span class="n">_alloc</span> <span class="p">=</span> <span class="n">alloc</span><span class="p">;</span>
        <span class="n">_ptr</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">*)</span><span class="n">UnsafeUtility</span><span class="p">.</span><span class="nf">Malloc</span><span class="p">(</span><span class="n">UnsafeUtility</span><span class="p">.</span><span class="n">SizeOf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(),</span> <span class="n">UnsafeUtility</span><span class="p">.</span><span class="n">AlignOf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(),</span> <span class="n">_alloc</span><span class="p">);</span>
        <span class="n">_isCreated</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>        <span class="n">DisposeSentinel</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="k">out</span> <span class="n">_safety</span><span class="p">,</span> <span class="k">out</span> <span class="n">_disposeSentinel</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">_alloc</span><span class="p">);</span>
<span class="cp">#endif
</span>    <span class="p">}</span>
    <span class="k">public</span> <span class="nf">PtrHandle</span><span class="p">(</span><span class="n">T</span> <span class="k">value</span><span class="p">,</span> <span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">alloc</span> <span class="p">&lt;=</span> <span class="n">Allocator</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"Allocator must be Temp, TempJob or Persistent"</span><span class="p">,</span> <span class="k">nameof</span><span class="p">(</span><span class="n">alloc</span><span class="p">));</span>

        <span class="n">_alloc</span> <span class="p">=</span> <span class="n">alloc</span><span class="p">;</span>
        <span class="n">_ptr</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">*)</span><span class="n">UnsafeUtility</span><span class="p">.</span><span class="nf">Malloc</span><span class="p">(</span><span class="n">UnsafeUtility</span><span class="p">.</span><span class="n">SizeOf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(),</span> <span class="n">UnsafeUtility</span><span class="p">.</span><span class="n">AlignOf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(),</span> <span class="n">_alloc</span><span class="p">);</span>
        <span class="n">_isCreated</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

        <span class="p">*</span><span class="n">_ptr</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>

<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>        <span class="n">DisposeSentinel</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="k">out</span> <span class="n">_safety</span><span class="p">,</span> <span class="k">out</span> <span class="n">_disposeSentinel</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">_alloc</span><span class="p">);</span>
<span class="cp">#endif
</span>    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Boolean</span> <span class="n">IsCreated</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">_isCreated</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IsCreated</span><span class="p">)</span>
        <span class="p">{</span>
<span class="cp">#if ENABLE_UNITY_COLLECTIONS_CHECKS
</span>            <span class="n">DisposeSentinel</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">(</span><span class="k">ref</span> <span class="n">_safety</span><span class="p">,</span> <span class="k">ref</span> <span class="n">_disposeSentinel</span><span class="p">);</span>
<span class="cp">#endif
</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">CheckAllocator</span><span class="p">();</span>
            <span class="n">UnsafeUtility</span><span class="p">.</span><span class="nf">Free</span><span class="p">((</span><span class="k">void</span><span class="p">*)</span><span class="n">_ptr</span><span class="p">,</span> <span class="n">_alloc</span><span class="p">);</span>
            <span class="n">_ptr</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">_isCreated</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"Dispose() was called twise, or not initialized target."</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">T</span><span class="p">*</span> <span class="n">Target</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_isCreated</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"target is not allocated."</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">_ptr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="n">T</span> <span class="n">Value</span>
    <span class="p">{</span>
        <span class="k">set</span> <span class="p">{</span> <span class="p">*</span><span class="n">_ptr</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="p">*</span><span class="n">_ptr</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">T</span><span class="p">(</span><span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">*</span><span class="k">value</span><span class="p">.</span><span class="n">_ptr</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">CheckAllocator</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">UnsafeUtility</span><span class="p">.</span><span class="nf">IsValidAllocator</span><span class="p">(</span><span class="n">_alloc</span><span class="p">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"The buffer can not be Disposed because it was not allocated with a valid allocator."</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p></p>
</div></details></p>

<p>この <code>PtrHandle&lt;T&gt;</code> を使用して、<code>NativeContiner</code> に似た struct の状態変数は以下のように一括管理ができるようになります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="k">struct</span> <span class="nc">MyInfo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Size</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">Flag</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">MyStateEnum</span> <span class="n">State</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">struct</span> <span class="nc">MyProcessor</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IDisposable</span>
    <span class="k">where</span> <span class="n">T</span><span class="p">:</span> <span class="n">unmanaged</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">_buffer</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">MyInfo</span><span class="p">&gt;</span> <span class="n">_info</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">MyProcessor</span><span class="p">(</span><span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">alloc</span><span class="p">);</span>
        <span class="n">_info</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">alloc</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_buffer</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="n">_info</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">State</span> <span class="p">==</span> <span class="n">MyStateEnum</span><span class="p">.</span><span class="n">Default</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* 何か処理 */</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code>PtrHandle&lt;T&gt;</code> は GameObject 側と JobSystem 側での変数の共有を想定しており、(ライブラリの外部に渡す場合には内容を別の出力専用 <code>readonly struct</code> に値をコピーしてから返すなどの安全対策をしておけば) Job の管理にも有用です。<br>
デモでファイル読み込みの進捗状況を取得して表示させていますが、内部的には <code>PtrHandle&lt;T&gt;</code> を利用しています。</p>

<p>struct へのポインタを安全に保持したいだけなら大きさ1の<code>NativeArray</code>を作ることも考えられますが、Unity標準のNativeContainerはJobSystemの安全装置によってJobSystemで使用中はメインスレッドからのアクセスが禁止されてしまうため、Job実行中の共有情報の参照には使えません。</p>

<p>よって、NativeContainerの安全装置のうち意図的にアクセッサの安全装置だけを殺したものとして <code>PtrHandle&lt;T&gt;</code> をつくり、これを各種管理情報の保持、参照に使います。</p>

<p>ライブラリに閉じ込めるなどしてポインタが暴れださないようにできれば、<strong>ポインタはすべてを解決する。</strong></p>

<h2>
<span id="in-readonly-struct-で速くならない" class="fragment"></span><a href="#in-readonly-struct-%E3%81%A7%E9%80%9F%E3%81%8F%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>▽in readonly struct で速くな……らない！</h2>

<p>実はしれっとスライスの実装を <code>readonly struct</code> で定義していたので、さらなるコピー削減のため <code>StringEntity</code> を引数に渡している部分に <code>in</code> をつけてみます。その結果……<strong>100 ms 程遅くなりました。</strong><br>
そもそも最初に頑張ってスライスを軽量化した結果、パディングの具合にもよりますがリリースビルドでは 8 byte ~ 16 byte のフットプリントしかありません。小さい struct では <a href="https://blog.meilcli.net/2018/06/big-size-structin.html" title="【C#】Big Size Structが値コピーでつらいならin引数で値コピーしなければいいじゃない！！ ＜ それ本当？" rel="nofollow noopener" target="_blank">in readonly struct を渡して低速化する報告</a>もあり、常々言われることではありますがやはり最適化に計測と確認は必須です。</p>

<h2>
<span id="文字列デコードのブロック処理" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E3%83%87%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>▽文字列デコードのブロック処理</h2>

<p>C# における <code>char</code> は最小データサイズが 2 byte になる UTF-16 が採用されています。ここで、例えば UTF-8 でエンコードされた、ほぼASCIIコードのテキストファイル(=ファイル上ではほぼ全て 1 byte)を一気にデコードすると、メモリ上にファイルサイズの倍の大きさの char配列が出現します。元のファイルサイズがMBクラスの大きさならあっという間にCPUのキャッシュからはみ出して処理速度が悲しいことになります。<br><br>
というわけで、キャッシュ内でパース処理をするためにブロック単位で char に変換し、改行コードを解析して line を示すスライスに切り出し、ブロック内の切り出しが終わったら出来上がった line を <code>ITextFilePaser.ParseLine(line)</code> に流し込みます。<br>
この line の切り出しの表現に、先頭部分のカタマリの挿入、削除に対応するラッパーを被せた <code>NativeHeadRemovableList&lt;T&gt;</code> を使用します。</p>

<p><details><summary> <code>NativeHeadRemovableList&lt;T&gt;</code> の実装(抜粋) </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">NativeHeadRemovableList.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">internal</span> <span class="k">struct</span> <span class="nc">NativeHeadRemovableList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">unmanaged</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">_list</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">_start</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="nf">NativeHeadRemovableList</span><span class="p">(</span><span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="n">T</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">index</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_list</span><span class="p">[</span><span class="n">_start</span> <span class="p">+</span> <span class="n">index</span><span class="p">];</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="n">_list</span><span class="p">[</span><span class="n">_start</span> <span class="p">+</span> <span class="n">index</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="kt">int</span> <span class="n">Length</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_list</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">_start</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="cm">/* 中略 */</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">RemoveHead</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="m">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&lt;</span> <span class="m">1</span> <span class="p">||</span> <span class="n">Length</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="s">"invalid length of remove target."</span><span class="p">);</span>

        <span class="n">_start</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">_start</span> <span class="p">+</span> <span class="n">count</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">InsertHead</span><span class="p">(</span><span class="n">T</span><span class="p">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="s">"invalid size"</span><span class="p">);</span>

        <span class="c1">// when enough space exists in head</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="p">&lt;=</span> <span class="n">_start</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_start</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">_start</span> <span class="p">-</span> <span class="n">length</span><span class="p">;</span>
            <span class="n">UnsafeUtility</span><span class="p">.</span><span class="nf">MemCpy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">(),</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">UnsafeUtility</span><span class="p">.</span><span class="n">SizeOf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="p">*</span> <span class="n">length</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// slide internal data</span>
        <span class="kt">int</span> <span class="n">new_length</span> <span class="p">=</span> <span class="n">length</span> <span class="p">+</span> <span class="k">this</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">len_move</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
        <span class="n">_list</span><span class="p">.</span><span class="nf">ResizeUninitialized</span><span class="p">(</span><span class="n">new_length</span><span class="p">);</span>
        <span class="n">T</span><span class="p">*</span> <span class="n">dest</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">*)</span><span class="n">_list</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">()</span> <span class="p">+</span> <span class="n">length</span><span class="p">;</span>
        <span class="n">T</span><span class="p">*</span> <span class="n">source</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">*)</span><span class="n">_list</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">()</span> <span class="p">+</span> <span class="n">_start</span><span class="p">;</span>
        <span class="n">UnsafeUtility</span><span class="p">.</span><span class="nf">MemMove</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">UnsafeUtility</span><span class="p">.</span><span class="n">SizeOf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="p">*</span> <span class="n">len_move</span><span class="p">);</span>

        <span class="c1">// insert data</span>
        <span class="n">_start</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">UnsafeUtility</span><span class="p">.</span><span class="nf">MemCpy</span><span class="p">((</span><span class="k">void</span><span class="p">*)</span><span class="n">_list</span><span class="p">.</span><span class="nf">GetUnsafePtr</span><span class="p">(),</span> <span class="p">(</span><span class="k">void</span><span class="p">*)</span><span class="n">ptr</span><span class="p">,</span> <span class="n">UnsafeUtility</span><span class="p">.</span><span class="n">SizeOf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="p">*</span> <span class="n">length</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p></p>
</div></details></p>

<p>改行を見つけたら当該部分のコピー後に <code>NativeHeadRemovableList&lt;T&gt;.RemoveHead(int)</code> で１行分ごそっと消しますが、内部的には <code>_start</code> に長さ分足しているだけです。</p>

<p>また、ブロック処理の都合上末尾に未処理のデータ片が残り、これを次回の処理開始時に配列の先頭に移動させねばなりません。そのために <code>NativeHeadRemovableList&lt;T&gt;.InsertHead(T*, int)</code> を実装した……のですが、処理手順を考えると char配列の受け取り前に残ったデータを <code>UnsafeUtility.MemMove()</code> で先頭に移動して、 <code>Decoder.GetChars(byte*, int, char* ,int)</code> に渡すポインタをその続きにすれば一番効率的だったことにこれを書いてる今気づきました。<br>
現状で性能にほぼ影響がないので放置していますが、これから似たようなことをやる人はご注意ください。<br>
いまどきこんな低レベルなところを弄る人がどのくらいいるかわかりませんが……</p>

<p>具体的なブロックサイズについては、当方の検証では 2kB ~ 4kB 程度が一番よさげでしたので、2kB を規定値として採用しました。</p>

<h2>
<span id="注文も非同期な感じで受け付けてほしい" class="fragment"></span><a href="#%E6%B3%A8%E6%96%87%E3%82%82%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%81%AA%E6%84%9F%E3%81%98%E3%81%A7%E5%8F%97%E3%81%91%E4%BB%98%E3%81%91%E3%81%A6%E3%81%BB%E3%81%97%E3%81%84"><i class="fa fa-link"></i></a>▽注文も非同期な感じで受け付けてほしい</h2>

<p>さて、これでそこそこの速度でテキストファイルをパースできるようになったわけですが、せっかく非同期なので追加の要求です。複数の GameObject から好き勝手に Load, UnLoad の要求が出される状況に対応しましょう。<br>
複数ファイルへの複数のユーザーからの問い合わせに対応するバージョンとして<br>
<code>AsyncTextFileLoader&lt;T&gt;</code> を作ります。</p>

<p><details><summary> <code>AsyncTextFileLoader&lt;T&gt;</code> の実装(抜粋) </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">AsyncTextFileLoader.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">AsyncTextFileLoader</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">ITextFileParser</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_pathList</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Encoding</span> <span class="n">_encoding</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">Allocator</span> <span class="n">_alloc</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">ParseJob</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">_parserPool</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">_gen</span><span class="p">;</span>

    <span class="k">private</span> <span class="kt">int</span> <span class="n">_blockSize</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">_maxJobCount</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">RunningJobInfo</span><span class="p">&gt;</span> <span class="n">_runningJob</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">ReadStateImpl</span><span class="p">&gt;&gt;</span> <span class="n">_state</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">_data</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">struct</span> <span class="nc">RunningJobInfo</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">FileIndex</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">ParserID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="nf">RunningJobInfo</span><span class="p">(</span><span class="kt">int</span> <span class="n">file_index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">parser_index</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">FileIndex</span> <span class="p">=</span> <span class="n">file_index</span><span class="p">;</span>
            <span class="n">ParserID</span> <span class="p">=</span> <span class="n">parser_index</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="k">enum</span> <span class="n">FileAction</span>
    <span class="p">{</span>
        <span class="n">Store</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
        <span class="n">UnLoad</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="k">struct</span> <span class="nc">Request</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">fileIndex</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="n">FileAction</span> <span class="n">action</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="nf">Request</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">FileAction</span> <span class="n">action</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">fileIndex</span> <span class="p">=</span> <span class="n">index</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="n">action</span> <span class="p">=</span> <span class="n">action</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">NativeQueue</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">_parserAvail</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">Request</span><span class="p">&gt;</span> <span class="n">_requestList</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">_updateLoadTgtTmp</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">_updateUnLoadTgtTmp</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">UnLoadJob</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">_unLoadJob</span><span class="p">;</span>

    <span class="cm">/* 中略 */</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">MaxJobCount</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_maxJobCount</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="k">value</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">_maxJobCount</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">LoadWaitingQueue</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_loadWaitingQueueNum</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">FlushLoadJobs</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">// 管理対象のファイルが追加されたら担当のデータクラス T を生成</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">AddFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_pathList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

        <span class="n">_data</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">T</span><span class="p">());</span>
        <span class="n">_data</span><span class="p">[</span><span class="n">_data</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">].</span><span class="nf">Init</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">s_tmp</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">ReadStateImpl</span><span class="p">&gt;(</span><span class="n">_alloc</span><span class="p">);</span>
        <span class="n">s_tmp</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="nf">Clear</span><span class="p">();</span>
        <span class="n">_state</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">s_tmp</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// データとJobの状態について index でアクセス</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="n">T</span> <span class="k">this</span><span class="p">[</span><span class="kt">int</span> <span class="n">fileIndex</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_state</span><span class="p">[</span><span class="n">fileIndex</span><span class="p">].</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">IsStandby</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">$"the job running now for fileIndex = </span><span class="p">{</span><span class="n">fileIndex</span><span class="p">}</span><span class="s">."</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">_data</span><span class="p">[</span><span class="n">fileIndex</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="n">ReadState</span> <span class="nf">GetState</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_state</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">Target</span><span class="p">-&gt;</span><span class="nf">GetState</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Load, UnLoad ともに外部からの注文はいったんリストにためて Update() で処理</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">LoadFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_loadWaitingQueueNum</span><span class="p">++;</span>
        <span class="n">_requestList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Request</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">FileAction</span><span class="p">.</span><span class="n">Store</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">UnLoadFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_requestList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Request</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">FileAction</span><span class="p">.</span><span class="n">UnLoad</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">UpdateImpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">FlushLoadJobs</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">FlushLoadJobs</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// リストにためた注文を一気に処理する</span>
    <span class="k">private</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">UpdateImpl</span><span class="p">(</span><span class="kt">bool</span> <span class="n">flush_all_jobs</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// check job completed or not</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span> <span class="n">_runningJob</span><span class="p">.</span><span class="n">Length</span><span class="p">-</span><span class="m">1</span><span class="p">;</span> <span class="n">i</span><span class="p">&gt;=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">job_info</span> <span class="p">=</span> <span class="n">_runningJob</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="kt">var</span> <span class="n">read_state</span> <span class="p">=</span> <span class="n">_state</span><span class="p">[</span><span class="n">job_info</span><span class="p">.</span><span class="n">FileIndex</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">read_state</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">JobState</span> <span class="p">==</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">WaitForCallingComplete</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_parserPool</span><span class="p">[</span><span class="n">job_info</span><span class="p">.</span><span class="n">ParserID</span><span class="p">].</span><span class="nf">Complete</span><span class="p">();</span>
                <span class="n">read_state</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">JobState</span> <span class="p">=</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">Completed</span><span class="p">;</span>

                <span class="k">this</span><span class="p">.</span><span class="nf">ReleaseParser</span><span class="p">(</span><span class="n">job_info</span><span class="p">.</span><span class="n">ParserID</span><span class="p">);</span>
                <span class="n">_runningJob</span><span class="p">.</span><span class="nf">RemoveAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">_unLoadJob</span><span class="p">.</span><span class="n">JobState</span> <span class="p">==</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">WaitForCallingComplete</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_unLoadJob</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>
            <span class="n">_unLoadJob</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// no requests. or all available parser were running. retry in next Update().</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_requestList</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">0</span> <span class="p">||</span> <span class="p">(</span><span class="n">_maxJobCount</span> <span class="p">-</span> <span class="n">_runningJob</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;=</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">flush_all_jobs</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//--- extract action</span>
        <span class="n">_updateLoadTgtTmp</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
        <span class="n">_updateUnLoadTgtTmp</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span><span class="n">_requestList</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">act</span> <span class="p">=</span> <span class="n">_requestList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">act</span><span class="p">.</span><span class="n">action</span> <span class="p">==</span> <span class="n">FileAction</span><span class="p">.</span><span class="n">Store</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">tgt_state</span> <span class="p">=</span> <span class="n">_state</span><span class="p">[</span><span class="n">act</span><span class="p">.</span><span class="n">fileIndex</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tgt_state</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">RefCount</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_updateLoadTgtTmp</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">act</span><span class="p">.</span><span class="n">fileIndex</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">tgt_state</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">RefCount</span><span class="p">++;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">_updateUnLoadTgtTmp</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">act</span><span class="p">.</span><span class="n">fileIndex</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">_requestList</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>

        <span class="c1">//--- preprocess unload action</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span> <span class="n">_updateUnLoadTgtTmp</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">id</span> <span class="p">=</span> <span class="n">_updateUnLoadTgtTmp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="kt">var</span> <span class="n">tgt_state</span> <span class="p">=</span> <span class="n">_state</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
            <span class="n">tgt_state</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">RefCount</span><span class="p">--;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">tgt_state</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">RefCount</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">found_index</span> <span class="p">=</span> <span class="n">_updateLoadTgtTmp</span><span class="p">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">found_index</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// remove from loading order (file loading is not performed)</span>
                    <span class="n">_updateLoadTgtTmp</span><span class="p">.</span><span class="nf">RemoveAtSwapBack</span><span class="p">(</span><span class="n">found_index</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">// remove from loaded data</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">_unLoadJob</span><span class="p">.</span><span class="n">JobState</span> <span class="p">==</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">Completed</span> <span class="p">&amp;&amp;</span> <span class="n">tgt_state</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">IsStandby</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">//--- unload in job (workaround for LargeAllocation.Free() cost in T.UnLoad().)</span>
                        <span class="n">_unLoadJob</span><span class="p">.</span><span class="nf">AddUnLoadTarget</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">_data</span><span class="p">[</span><span class="n">id</span><span class="p">],</span> <span class="n">_state</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Target</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="c1">// now loading. unload request will try in next update.</span>
                        <span class="n">tgt_state</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">RefCount</span><span class="p">++;</span>  <span class="c1">// reset ref count</span>
                        <span class="k">this</span><span class="p">.</span><span class="nf">UnLoadFile</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tgt_state</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">RefCount</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">$"invalid UnLoading for index = </span><span class="p">{</span><span class="n">id</span><span class="p">}</span><span class="s">."</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">_updateUnLoadTgtTmp</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>

        <span class="c1">// schedule jobs</span>
        <span class="c1">//--- unload job</span>
        <span class="n">_unLoadJob</span><span class="p">.</span><span class="nf">UnLoadAsync</span><span class="p">();</span>

        <span class="c1">//--- supply parsers for load job</span>
        <span class="kt">int</span> <span class="n">n_add_parser</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="n">_updateLoadTgtTmp</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">_parserAvail</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">flush_all_jobs</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">n_add_parser</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">MaxJobCount</span> <span class="p">-</span> <span class="n">_parserPool</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">n_add_parser</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n_add_parser</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="k">this</span><span class="p">.</span><span class="nf">GenerateParser</span><span class="p">();</span>

        <span class="c1">//--- run jobs</span>
        <span class="kt">int</span> <span class="n">n_job</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="n">_parserAvail</span><span class="p">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">_updateLoadTgtTmp</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span><span class="n">n_job</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">file_index</span> <span class="p">=</span> <span class="n">_updateLoadTgtTmp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="kt">int</span> <span class="n">p_id</span> <span class="p">=</span> <span class="n">_parserAvail</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">p_tmp</span> <span class="p">=</span> <span class="n">_parserPool</span><span class="p">[</span><span class="n">p_id</span><span class="p">];</span>
            <span class="kt">var</span> <span class="n">p_state</span> <span class="p">=</span> <span class="n">_state</span><span class="p">[</span><span class="n">file_index</span><span class="p">];</span>
            <span class="n">p_tmp</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="n">_blockSize</span><span class="p">;</span>
            <span class="n">p_tmp</span><span class="p">.</span><span class="nf">ReadFileAsync</span><span class="p">(</span><span class="n">_pathList</span><span class="p">[</span><span class="n">file_index</span><span class="p">],</span> <span class="n">_encoding</span><span class="p">,</span> <span class="n">_data</span><span class="p">[</span><span class="n">file_index</span><span class="p">],</span> <span class="n">p_state</span><span class="p">);</span>
            <span class="n">_runningJob</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">RunningJobInfo</span><span class="p">(</span><span class="n">file_index</span><span class="p">,</span> <span class="n">p_id</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="c1">//--- write back excessive queue</span>
        <span class="n">_loadWaitingQueueNum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">=</span><span class="n">n_job</span><span class="p">;</span> <span class="n">i</span><span class="p">&lt;</span><span class="n">_updateLoadTgtTmp</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">id</span> <span class="p">=</span> <span class="n">_updateLoadTgtTmp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">_state</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">RefCount</span><span class="p">--;</span> <span class="c1">// reset ref count</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">LoadFile</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
            <span class="n">_loadWaitingQueueNum</span><span class="p">++;</span>
        <span class="p">}</span>
        <span class="n">_updateLoadTgtTmp</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p></p>
</div></details></p>

<p>大まかな流れとしては、</p>

<ol>
<li>( <code>Update()</code> が呼ばれるまで) 任意の Load, UnLoad を受け付けてすべてリストにためる</li>
<li>たまった注文を Load と UnLoad に分ける</li>
<li>まず Load だけを取り出し、各ファイルの参照カウントをインクリメントし、<br>
 ここで参照カウントが0→1になったなら LoadJob の予約表に書きこむ</li>
<li>次に UnLoad だけを取り出し、各ファイルの参照カウントをデクリメントし、<br>
 ここで参照カウントが1→0になったなら、

<ol>
<li>LoadJob の予約表に該当ファイルの予約があれば、それを消す (その結果何もしない)</li>
<li>予約がなければ UnLoadJob の対象リストに入れる</li>
</ol>
</li>
<li>UnLoadJob を <code>schedule()</code> する。</li>
<li>LoadJob を <code>schedule()</code> する。</li>
</ol>

<p>Load だけでなく UnLoad も Job にしてしまっていますが、これについては次節で説明します。</p>

<p>ここにさらに同時に動作する LoadJob の最大数 <code>MaxJobCount</code> に合わせて、同時に保持するパーサーの数とジョブの割り当てを管理しています。<br>
パーサーは一度動かすとファイル丸ごとをバッファすること、またそもそもファイルのロードは多数を同時に走らせることは稀という前提で、メモリ消費の削減の観点からこのような設計にしました。しかし、後述の課題により <code>MaxJobCount</code> はせいぜい 1 ~ 2 ぐらいまでしかまともに動かないことが判明しました。</p>

<p>実際の運用では、 LoadJob 待機中の注文数を取得するプロパティ <code>AsyncTextFileLoader&lt;T&gt;.LoadWaitingQueue</code> を参照して注文する GameObject 側がタイミングを調節する形になるでしょう。</p>

<h2>
<span id="大きなデータのunload" class="fragment"></span><a href="#%E5%A4%A7%E3%81%8D%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AEunload"><i class="fa fa-link"></i></a>▽大きなデータのUnLoad</h2>

<p>大きなファイルの読み込みもそうですが、メモリ領域の破棄にもそれなりにコストがかかります。<br>
大容量のデータをいくつも一気に UnLoad したりすると <code>LargeAllocation.Free()</code> に ms 単位で持っていかれかねません。せっかくパース処理そのものはワーカースレッドに追い出したのに、これでメインスレッドが遅くなったら片手落ちです。<br><br>
幸い <code>NativeContainer</code> のアロケータはワーカースレッドでも動くので、多数のファイルを管理する <code>AsyncTextFileLoader&lt;T&gt;</code> では <code>UnLoad()</code> もワーカースレッドにやらせてメインスレッドを身軽にします。<br>
ここで、 <code>JobHandle.Schedule()</code> の呼び出しコストを削減するため、 <code>UnLoad()</code> 対象のデータ (の <code>GCHandle</code> )のリストを1つの Job に渡して一気に UnLoad させます。<br>
UnLoad 用の Job は以下のようになります。</p>

<p><details><summary> <code>UnLoadJob&lt;T&gt;</code> の実装(抜粋) </summary><div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">ParseJob.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">internal</span> <span class="k">unsafe</span> <span class="k">struct</span> <span class="nc">UnLoadJobTarget</span><span class="p">&lt;</span><span class="n">Tdata</span><span class="p">&gt;</span>
    <span class="k">where</span> <span class="n">Tdata</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">ITextFileParser</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="n">GCHandle</span><span class="p">&lt;</span><span class="n">Tdata</span><span class="p">&gt;</span> <span class="n">data</span><span class="p">;</span>
    <span class="k">internal</span> <span class="n">ReadStateImpl</span><span class="p">*</span> <span class="n">state_ptr</span><span class="p">;</span>  <span class="c1">// UnLoad 対象の State. 書き換えだけ行うので生ポインタを渡す</span>
    <span class="k">internal</span> <span class="kt">int</span> <span class="n">file_index</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">UnLoadJobTarget</span><span class="p">(</span><span class="kt">int</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">Tdata</span> <span class="n">data</span><span class="p">,</span> <span class="n">ReadStateImpl</span><span class="p">*</span> <span class="n">state_ptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GCHandle</span><span class="p">&lt;</span><span class="n">Tdata</span><span class="p">&gt;();</span>

        <span class="k">this</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">state_ptr</span> <span class="p">=</span> <span class="n">state_ptr</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">file_index</span> <span class="p">=</span> <span class="n">file_index</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">UnLoad</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">state_ptr</span><span class="p">-&gt;</span><span class="n">JobState</span> <span class="p">=</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">UnLoaded</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Target</span><span class="p">.</span><span class="nf">UnLoad</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">internal</span> <span class="k">struct</span> <span class="nc">UnLoadJobInfo</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="n">ReadJobState</span> <span class="n">job_state</span><span class="p">;</span>
    <span class="k">internal</span> <span class="n">JobHandle</span> <span class="n">job_handle</span><span class="p">;</span>
    <span class="k">internal</span> <span class="n">Boolean</span> <span class="n">alloc_handle</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">internal</span> <span class="k">struct</span> <span class="nc">UnLoadJob</span><span class="p">&lt;</span><span class="n">Tdata</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IJob</span><span class="p">,</span> <span class="n">IDisposable</span>
    <span class="k">where</span> <span class="n">Tdata</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">ITextFileParser</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">UnLoadJobTarget</span><span class="p">&lt;</span><span class="n">Tdata</span><span class="p">&gt;&gt;</span> <span class="n">_target</span><span class="p">;</span>
    <span class="k">internal</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">UnLoadJobInfo</span><span class="p">&gt;</span> <span class="n">_info</span><span class="p">;</span>               <span class="c1">// UnLoadJob の管理情報</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="nf">UnLoadJob</span><span class="p">(</span><span class="n">Allocator</span> <span class="n">alloc</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_target</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NativeList</span><span class="p">&lt;</span><span class="n">UnLoadJobTarget</span><span class="p">&lt;</span><span class="n">Tdata</span><span class="p">&gt;&gt;(</span><span class="n">alloc</span><span class="p">);</span>
        <span class="n">_info</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PtrHandle</span><span class="p">&lt;</span><span class="n">UnLoadJobInfo</span><span class="p">&gt;(</span><span class="n">alloc</span><span class="p">);</span>

        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">job_state</span> <span class="p">=</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">Completed</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">DisposeHandle</span><span class="p">();</span>
        <span class="n">_target</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="n">_info</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">DisposeHandle</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">alloc_handle</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_target</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="n">_target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
            <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">alloc_handle</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Clear</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">DisposeHandle</span><span class="p">();</span>
        <span class="n">_target</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">AddUnLoadTarget</span><span class="p">(</span><span class="kt">int</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">Tdata</span> <span class="n">data</span><span class="p">,</span> <span class="n">ReadStateImpl</span><span class="p">*</span> <span class="n">state_ptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_target</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span> <span class="k">new</span> <span class="n">UnLoadJobTarget</span><span class="p">&lt;</span><span class="n">Tdata</span><span class="p">&gt;(</span><span class="n">file_index</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state_ptr</span><span class="p">)</span> <span class="p">);</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">alloc_handle</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">unsafe</span> <span class="n">JobHandle</span> <span class="nf">UnLoadAsync</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">_target</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">job_state</span> <span class="p">=</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">UnLoadJob</span><span class="p">;</span>
            <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">job_handle</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">Schedule</span><span class="p">();</span>
            <span class="k">return</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">job_handle</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="c1">// no action</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">JobHandle</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="n">ReadJobState</span> <span class="n">JobState</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">job_state</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_target</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="n">_target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">UnLoad</span><span class="p">();</span>

        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">job_state</span> <span class="p">=</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">WaitForCallingComplete</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">unsafe</span> <span class="k">void</span> <span class="nf">Complete</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">job_handle</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>
        <span class="n">_info</span><span class="p">.</span><span class="n">Target</span><span class="p">-&gt;</span><span class="n">job_state</span> <span class="p">=</span> <span class="n">ReadJobState</span><span class="p">.</span><span class="n">Completed</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p></p>
</div></details></p>

<p>このジョブを1つインスタンス化しておいて、 UnLoad の注文が来たら <code>UnLoadJob&lt;T&gt;.AddUnLoadTarget(int, T, PtrHandle&lt;ReadStateImpl&gt;)</code> で対象の data を渡し、 <code>UnLoadJob&lt;T&gt;.UnLoadAsync()</code> で後始末させます。</p>

<h1>
<span id="課題" class="fragment"></span><a href="#%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a>課題</h1>

<h2>
<span id="burst-でもっと速くならない対応済" class="fragment"></span><a href="#burst-%E3%81%A7%E3%82%82%E3%81%A3%E3%81%A8%E9%80%9F%E3%81%8F%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84%E5%AF%BE%E5%BF%9C%E6%B8%88"><i class="fa fa-link"></i></a>◎Burst でもっと速くならない？(対応済)</h2>

<h3>
<span id="2021425現行版でburstに対応しました" class="fragment"></span><a href="#2021425%E7%8F%BE%E8%A1%8C%E7%89%88%E3%81%A7burst%E3%81%AB%E5%AF%BE%E5%BF%9C%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F"><i class="fa fa-link"></i></a>(2021/4/25)<a href="https://qiita.com/kawai125/items/540dd8e5d2b4c7c1fa3b">現行版でBurstに対応しました。</a>
</h3>

<p>いつになるかは不明ですが、<a href="https://docs.unity3d.com/Packages/com.unity.burst@1.5/manual/docs/CSharpLanguageSupport_Types.html" title="Burst User Guide" rel="nofollow noopener" target="_blank">公式</a>の案内では <code>char</code> には対応する予定らしいので、その暁にはもっと早くなるはず。  </p>

<blockquote>
<p>Burst does not support the following types:<br>
  - char (this will be supported in a future release)<br>
  - string as this is a managed type</p>
</blockquote>

<p>ライブラリ内部ではASCII範囲の値しか検索、比較していないので、 <code>char</code> をすべて <code>unit16</code> あたりにキャストして、<a href="https://qiita.com/mao_/items/876fa56fb42bc5110345" title="【Unity】BurstCompilerをJobSystem以外でも使いたい" id="reference-6014f21d5ee451364599">関数ポインタ経由でBurstさせれば</a>もっと早くなる可能性は大いにあります。<br><br>
しかし、公式が対応すると明言していますし、上記の手法で Burst による高速化が特に期待されるホットスポットは <code>TryParse()</code> や <code>Split()</code> 関数なので、Burst が <code>char</code> に対応したならユーザーデータクラスの <code>ParseLine(line)</code> をまるごと適用したほうがはるかに効果的でしょう。</p>

<h2>
<span id="複数のファイルを同時に読ませると途端に遅くなる解決済" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%90%8C%E6%99%82%E3%81%AB%E8%AA%AD%E3%81%BE%E3%81%9B%E3%82%8B%E3%81%A8%E9%80%94%E7%AB%AF%E3%81%AB%E9%81%85%E3%81%8F%E3%81%AA%E3%82%8B%E8%A7%A3%E6%B1%BA%E6%B8%88"><i class="fa fa-link"></i></a>◎複数のファイルを同時に読ませると途端に遅くなる(解決済)</h2>

<h3>
<span id="2021425-split-関数内の-boxing-を除去した現行版では解消しました" class="fragment"></span><a href="#2021425-split-%E9%96%A2%E6%95%B0%E5%86%85%E3%81%AE-boxing-%E3%82%92%E9%99%A4%E5%8E%BB%E3%81%97%E3%81%9F%E7%8F%BE%E8%A1%8C%E7%89%88%E3%81%A7%E3%81%AF%E8%A7%A3%E6%B6%88%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F"><i class="fa fa-link"></i></a>(2021/4/25) Split() 関数内の Boxing を除去した現行版では解消しました。</h3>

<p>デモシーン<br>
<code>/Assets/NativeStringCollections/Demo/Scenes/Demo_AsyncMultiFileManagement.unity</code> で、<br>
<code>AsyncTextFileLoader&lt;T&gt;</code> を使用して <strong>n個 のファイルを同時に読み込む</strong>指示を出すと、<strong>同時に始まった個々のジョブの処理時間が n倍</strong> になり、結局速くなくなるどころか遅延時間の分だけ1個ずつ読ませていたほうがまし、という症状が出ています。<br><br>
ストレージ &lt;-&gt; メモリ間、あるいは CPU &lt;-&gt; メモリ間の転送速度に引っかかったかとも思いましたが、プロファイラで確認したところメモリ転送負荷になりそうな <code>AsyncReadManager.Read()</code> や <code>NativeList&lt;T&gt;.Add()</code> の処理時間をはじめ、 <del>ジョブの処理時間全体がプロファイラ上では 1ジョブの状態とほぼ同じ時間でした。しかし<code>AsyncTextFileReader&lt;T&gt;</code> 内部の <code>System.Diagnotics.Stopwatch</code> による処理時間の計測結果、および実時間では一気に動作が遅くなります。</del><br>
<strong>小さなファイルで試すとプロファイラの経過時間と実時間が一致しました。1秒を超えるような長時間のジョブはプロファイラ内の経過時間がバグります。</strong></p>

<p>flushingの有無による変化を下記に示します。(Deep Profile)</p>

<ul>
<li><p>flushing なし (MaxJobCount = 1)<br>
<a href="https://camo.qiitausercontent.com/1a1c205c5ba7f0ff1ef98b0e371c6689ce83aa6c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f313133313233382f63643765613466312d316363352d333538302d373637302d6530393434633338643338612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F1131238%2Fcd7ea4f1-1cc5-3580-7670-e0944c38d38a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=bb3d2141f8e9688c543f6d7ad68f1f7f" alt="NSL_max_job_1.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1131238/cd7ea4f1-1cc5-3580-7670-e0944c38d38a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F1131238%2Fcd7ea4f1-1cc5-3580-7670-e0944c38d38a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ace969ba94246cdc6471cfed4607e60b 1x" loading="lazy"></a></p></li>
<li><p>flushing<br>
<a href="https://camo.qiitausercontent.com/8f1eca6b3c4884046ab5db9e263dad38757a1392/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f313133313233382f32313630613636642d396362372d306636342d313431352d6632303134653139613032322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F1131238%2F2160a66d-9cb7-0f64-1415-f2014e19a022.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=01a100544fcdeb03a7b5fae2b1b84bad" alt="NSL_flushing_queue.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1131238/2160a66d-9cb7-0f64-1415-f2014e19a022.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F1131238%2F2160a66d-9cb7-0f64-1415-f2014e19a022.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ca0480f71f746e2d9fce12b67ed4ec04 1x" loading="lazy"></a></p></li>
</ul>

<p>LoadJob を flush している場合の、ParseJob 内の各関数の経過時間は下記の通りです。<br>
(数値は 6 Job の総和)</p>

<ul>
<li>
<strong>0.211 ms</strong> File.Read() (間に隙間はあるものの合計 1.0 ms 以下)</li>
<li>
<strong>4751.49 ms</strong> ParseText()

<ul>
<li>
<strong>704.39 ms</strong> ParseLinesFromBuffer()</li>
<li>
<strong>3684.18 ms</strong> CharaDataParser.ParseLine()

<ul>
<li>
<strong>165.25 ms</strong> ReadOnlyStringEntity.op_Equality()</li>
<li>
<strong>348.70 ms</strong> ReadOnlyStringEntity.Slice()</li>
<li>
<strong>904.67 ms</strong> StringSplitterExt.Split()</li>
<li>
<strong>1071.26 ms</strong> StringParserExt.TryParse()</li>
<li>
<strong>329.31 ms</strong> NativeBase64Decoder.GetBytes()</li>
<li>
<strong>552.84 ms</strong> NativeStringList.Add()</li>
<li>
<strong>155.91 ms</strong> NativeStringList.get_Last</li>
<li>(<strong>156.24 ms</strong> others)</li>
</ul>
</li>
</ul>
</li>
<li>
<strong>35.30 ms</strong> PostReadProc()</li>
</ul>

<p>一方で  job を1つずつ実行した場合の経過時間の一例は下記のとおりです。</p>

<ul>
<li>
<strong>0.035 ms</strong> File.Read()</li>
<li>
<strong>150.33 ms</strong> ParseText()

<ul>
<li>
<strong>22.24 ms</strong> ParseLinesFromBuffer()</li>
<li>
<strong>116.83 ms</strong> CharaDataParser.ParseLine()

<ul>
<li>
<strong>5.11 ms</strong> ReadOnlyStringEntity.op_Equality()</li>
<li>
<strong>10.82 ms</strong> ReadOnlyStringEntity.Slice()</li>
<li>
<strong>29.93 ms</strong> StringSplitterExt.Split()</li>
<li>
<strong>34.11 ms</strong> StringParserExt.TryParse()</li>
<li>
<strong>8.65 ms</strong> NativeBase64Decoder.GetBytes()</li>
<li>
<strong>17.01 ms</strong> NativeStringList.Add()</li>
<li>
<strong>4.66 ms</strong> NativeStringList.get_Last</li>
<li>(<strong>6.54 ms</strong> others)</li>
</ul>
</li>
</ul>
</li>
<li>
<strong>0.013 ms</strong> PostReadProc()</li>
</ul>

<p>そして各関数の <code>ParseText()</code> 内の相対実行時間を比較すると下表のようになります。</p>

<table>
<thead>
<tr>
<th style="text-align: left">関数名</th>
<th style="text-align: right">t[ms]_1Job</th>
<th style="text-align: right">ratio_1Job</th>
<th style="text-align: right">t[ms]_6Job</th>
<th style="text-align: right">ratio_6Job</th>
<th style="text-align: right">slower/Job</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">File.Read()</td>
<td style="text-align: right">0.035</td>
<td style="text-align: right">-</td>
<td style="text-align: right">0.211</td>
<td style="text-align: right">-</td>
<td style="text-align: right">1.00x</td>
</tr>
<tr>
<td style="text-align: left">ParseText()</td>
<td style="text-align: right">150.33</td>
<td style="text-align: right">100.0%</td>
<td style="text-align: right">4751.49</td>
<td style="text-align: right">100.0%</td>
<td style="text-align: right">5.27x</td>
</tr>
<tr>
<td style="text-align: left">ParseLinesFromBuffer()</td>
<td style="text-align: right">22.24</td>
<td style="text-align: right">14.8%</td>
<td style="text-align: right">704.39</td>
<td style="text-align: right">14.8%</td>
<td style="text-align: right">5.29x</td>
</tr>
<tr>
<td style="text-align: left">CharaDataParser.ParseLine()</td>
<td style="text-align: right">116.83</td>
<td style="text-align: right">78%</td>
<td style="text-align: right">3684.18</td>
<td style="text-align: right">77.5%</td>
<td style="text-align: right">5.26x</td>
</tr>
<tr>
<td style="text-align: left">ReadOnlyStringEntity.op_Equality()</td>
<td style="text-align: right">5.11</td>
<td style="text-align: right">3.40%</td>
<td style="text-align: right">165.25</td>
<td style="text-align: right">3.48%</td>
<td style="text-align: right">5.39x</td>
</tr>
<tr>
<td style="text-align: left">ReadOnlyStringEntity.Slice()</td>
<td style="text-align: right">10.82</td>
<td style="text-align: right">7.20%</td>
<td style="text-align: right">348.70</td>
<td style="text-align: right">7.34%</td>
<td style="text-align: right">5.37x</td>
</tr>
<tr>
<td style="text-align: left">StringSplitterExt.Split()</td>
<td style="text-align: right">29.93</td>
<td style="text-align: right">19.9%</td>
<td style="text-align: right">904.67</td>
<td style="text-align: right">19.0%</td>
<td style="text-align: right">5.04x</td>
</tr>
<tr>
<td style="text-align: left">StringParserExt.TryParse()</td>
<td style="text-align: right">34.11</td>
<td style="text-align: right">22.7%</td>
<td style="text-align: right">1071.26</td>
<td style="text-align: right">22.5%</td>
<td style="text-align: right">5.23x</td>
</tr>
<tr>
<td style="text-align: left">NativeBase64Decoder.GetBytes()</td>
<td style="text-align: right">8.65</td>
<td style="text-align: right">5.75%</td>
<td style="text-align: right">329.31</td>
<td style="text-align: right">6.90%</td>
<td style="text-align: right">6.35x</td>
</tr>
<tr>
<td style="text-align: left">NativeStringList.Add()</td>
<td style="text-align: right">17.01</td>
<td style="text-align: right">11.3%</td>
<td style="text-align: right">552.84</td>
<td style="text-align: right">11.6%</td>
<td style="text-align: right">5.42x</td>
</tr>
<tr>
<td style="text-align: left">NativeStringList.get_Last</td>
<td style="text-align: right">4.66</td>
<td style="text-align: right">3.10%</td>
<td style="text-align: right">155.91</td>
<td style="text-align: right">3.28%</td>
<td style="text-align: right">5.58x</td>
</tr>
<tr>
<td style="text-align: left">(others)</td>
<td style="text-align: right">6.54</td>
<td style="text-align: right">4.35%</td>
<td style="text-align: right">156.24</td>
<td style="text-align: right">3.29%</td>
<td style="text-align: right">3.98x</td>
</tr>
<tr>
<td style="text-align: left">PostReadProc()</td>
<td style="text-align: right">0.013</td>
<td style="text-align: right">-</td>
<td style="text-align: right">35.30</td>
<td style="text-align: right">-</td>
<td style="text-align: right">452x</td>
</tr>
</tbody>
</table>

<p>表右端の <code>slower/Job</code> は6Jobの実行時間を1Jobの実行時間で割った後、さらに6で除して Job 1つあたり何倍遅くなったかの比です。<br>
不思議なことに関数全体にわたって均等に遅くなっています。</p>

<p>プロファイラによる観測データの転送でメモリ帯域を食われた可能性も考えましたが、<br>
リリースビルドで同じ 4096 サイズに対し、LoadJob 1つの処理時間は</p>

<p>約 <strong>6.5 ms</strong> (@ 1 Job)-&gt; 約 <strong>80 ms</strong> (@ 6 Job)</p>

<p>とむしろ比率的にはよりひどい状態で同様の現象が見られます。</p>

<p>また、 <code>PostReadProc()</code> はファイル先頭部分に Base64 で埋め込んだ全データのIDのリストを <code>ParseLine()</code> で実際に解析した <code>CharaData</code> のIDと照合して読み込みエラーがないか確認をするのと、 <code>NativeStringList.Add()</code> の繰り返しでバッファが伸長し、各 <code>CharaData</code> の name の参照先が無効になっているはずなのでその再構築をしています。<br>
つまりほぼ計算なしに全データを走査して long の比較とchar配列のコピーをしているだけなので、真にメモリバウンドな処理をするとここまで遅くなるということを示していると考えられます。</p>

<p>以上から、やはりキャッシュミスとは異なる現象が起きているように思われ、<br>
自明並列の部分が並列化でなぜ遅くなるのか私の頭では原因がつかめません……</p>

<p><code>AsyncReadManager</code> 自体あまり公式 script reference 以外の情報がなく、そもそもアセットバンドル等のひとまとめにしたバイナリデータをロードするのに用意されたAPIで、完全に用途が違うものを変な使い方している、と言われればそれまでですが……<br><br>
Unityの中の人に聞ければ解決するかもしれませんが、ちょっとそこまでのお金はないのでだれか解決してくれるとすごくたすかります(他力本願)</p>

<h1>
<span id="参考記事" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E8%A8%98%E4%BA%8B"><i class="fa fa-link"></i></a>参考記事</h1>

<p>Qiita:<br>
<a href="https://qiita.com/mao_/items/8f95bc9dbeb3179ba4b9">【Unity】ファイルを非同期で読み込んでアンマネージドメモリに展開できるAsyncReadManagerを試してみた</a><br>
<a href="https://qiita.com/mao_/items/220ccf3b2ef929388036" id="reference-c808051f601980b82aa7">【Unity】NativeArrayについての解説及び実装コードを読んでみる</a><br>
<a href="https://qiita.com/mao_/items/fc9b4340b05e7e83c3ff" id="reference-2aa0fe074e221ba0e2e9">【Unity】UnsafeUtilityについて纏めてみる</a><br>
<a href="https://qiita.com/mao_/items/876fa56fb42bc5110345">【Unity】BurstCompilerをJobSystem以外でも使いたい</a><br>
<a href="https://qiita.com/tatsunoru/items/611d0378086dc5986249" id="reference-9419eeb83046638f899e">Unity C# Job Systemに参照型を持ち込む</a><br>
<a href="https://qiita.com/papparapa/items/a692714c47a7c602215e" id="reference-a8c680704a7328fff3c7">【Unity】スタックトレースを有効にしてNativeArrayのメモリリークを探す</a><br>
<a href="https://qiita.com/pCYSl5EDgo/items/4b5a5e089eabc8f4387d" id="reference-da9f541362be1f5e9f50">【Unity】UnsafeUtility基礎論【入門者向け】</a></p>

<p>Blog:<br>
<a href="https://helpdesk.unity3d.co.jp/hc/ja/articles/204694010-System-Text-Encoding-%E3%81%A7-Shift-JIS-%E3%82%92%E4%BD%BF%E3%81%84%E3%81%9F%E3%81%84" rel="nofollow noopener" target="_blank">System.Text.Encoding で Shift JIS を使いたい</a><br>
<a href="https://blog.meilcli.net/2018/06/big-size-structin.html" rel="nofollow noopener" target="_blank">【C#】Big Size Structが値コピーでつらいならin引数で値コピーしなければいいじゃない！！ ＜ それ本当？</a></p>

<p>Official:<br>
<a href="https://referencesource.microsoft.com/" rel="nofollow noopener" target="_blank">C# Reference Source</a></p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fkawai125%2Fitems%2F13390f25700dd89c0f2e&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fkawai125%2Fitems%2F13390f25700dd89c0f2e&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/kawai125/items/13390f25700dd89c0f2e/likers" class="css-1iupg5d">16</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">15</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/13390f25700dd89c0f2e/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/kawai125/items/13390f25700dd89c0f2e/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/kawai125/items/13390f25700dd89c0f2e/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/kawai125/items/13390f25700dd89c0f2e/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/kawai125/items/13390f25700dd89c0f2e.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-e97846bd-26f9-40b3-bb2d-372a6589d46b">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-0ec3419b-6b1d-4631-bf42-d170c01bf6c1"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-0ec3419b-6b1d-4631-bf42-d170c01bf6c1">{}</script>
      
<div id="LoginModal-react-component-bd7a3394-4ae8-4bac-909a-a8cbd32883e4"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-bd7a3394-4ae8-4bac-909a-a8cbd32883e4">{}</script>
      
<div id="StockModal-react-component-b28f784f-d2b2-497e-b051-4a03fa8e04e5"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-b28f784f-d2b2-497e-b051-4a03fa8e04e5">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;bhk5nBK2oTGVsEQBvjVSZS6vWxb/bAlP/BNjgGcnY1QihV3wrEOHONlNvCaYXo8RNww+7SkLfCddsqfyZoawmg==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e一定時間ごとにある程度の大きさのテキストファイルを読み込んで、その内容を反映させるプロジェクトのため、Unity(C#)で使える高速なファイルアクセスAPIを調べて \u003ccode\u003eAsyncReadManager\u003c/code\u003e に行きつきました。\u003c/p\u003e\n\n\u003cp\u003e偉大なる先駆者様 :\u003cbr\u003e\n\u003ca href=\"https://qiita.com/mao_/items/8f95bc9dbeb3179ba4b9\" id=\"reference-b90dc243d5620f34f3c3\"\u003e【Unity】ファイルを非同期で読み込んでアンマネージドメモリに展開できるAsyncReadManagerを試してみた\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこの先行研究ではメインスレッド上での動作確認とメモリ負荷の検証が主で、本文でさらっと\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eアンマネージドメモリにデータをキャッシュすると言いつつも、実装としてはJob等で並列化せずに愚直にメインスレッド上でパースを行っております。。(もう少し工夫すればJob化出来そうな気がしなくもなく。。要検証)\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eとの表記に誘われて四苦八苦した結果、どうにか動くようになりましたので紹介させていただきます。\u003cbr\u003e\nUnityプロジェクトなのに外部ファイル(しかもテキスト)をたくさん使うとか、非常にニッチな需要だとは思いますがそんな誰かの役にも立てばいいな……\u003c/p\u003e\n\n\u003cp\u003eUnityアドカレに1個未投稿の枠があったので、今更ながら滑り込ませていただきました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"成果物\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%88%90%E6%9E%9C%E7%89%A9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e成果物\u003c/h1\u003e\n\n\u003cp\u003eC# JobSystem で文字列の類をいい感じに扱うツールセットは最終的に以下のようになりました。\u003cbr\u003e\n最新版は Burst による最適化に対応しました。\u003ca href=\"https://qiita.com/kawai125/items/540dd8e5d2b4c7c1fa3b\" id=\"reference-2e47aebe179aa3d3036a\"\u003eBurstの利用方法と性能評価についてはBurst編を参照してください。\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eGitHub\u003cbr\u003e\n\u003ca href=\"https://github.com/kawai125/NativeStringCollections\" rel=\"nofollow noopener\" target=\"_blank\"\u003eNativeStringCollections\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"動作環境\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8B%95%E4%BD%9C%E7%92%B0%E5%A2%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e動作環境\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eUnity 2019.4.24f1\n\n\u003cul\u003e\n\u003cli\u003eCollections 0.9.0-preview.6\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"使い方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%BF%E3%81%84%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e使い方\u003c/h1\u003e\n\n\u003cp\u003e雰囲気はこんな感じ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNativeStringCollections\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTextData\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eITextFileParser\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDataElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eInit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"cm\"\u003e/* クラス初期化。 new() 後に一度だけ呼ばれる */\u003c/span\u003e\n        \u003cspan class=\"cm\"\u003e/* ここだけはメインスレッドで実行されるのでマネージ型を使ってもいい */\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"cm\"\u003e/* パース準備。 ParseLines(lines) が始まる前に一度呼ばれる */\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eParseLines\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeStringList\u003c/span\u003e \u003cspan class=\"n\"\u003elines\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003elines\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elines\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"cm\"\u003e/* line を解析する。 次の行も読みたいなら true を返す */\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003ePostProc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"cm\"\u003e/* 後処理。 ParseLines(lines) が終わったら一度呼ばれる */\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnLoad\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"cm\"\u003e/* 一時的にデータを破棄したいときにここに処理を書く */\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHoge\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eAsyncTextFileReader\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTextData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eAsyncTextFileReader\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTextData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePersistent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnClickLoadFile\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// どこかでファイル読み込みの指示を出す (必要なら Encoding も指定する)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLoadFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 進捗を表示できる (Read, Length ともに BlockSize単位のint)\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003einfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetState\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eprogress\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRead\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 終わってたら Complete()\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJobState\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWaitForCallingComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 読み込みにかかった時間も出せる  [ms]\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003edelay\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\" file loading completed. time = \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003edelay\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"F2\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e [ms].\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// データを取り出して何かする\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnDestroy\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// データのDispose() は外で行う。 reader だけ先に Dispose() してもよい\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \n        \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e文字列の具体的な変換はこんな感じ\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNativeStringCollections\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eTextData\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eITextFileParser\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDataElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeStringList\u003c/span\u003e \u003cspan class=\"n\"\u003emark_list\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003echeck_mark\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// パース中に string を使いたい場合は\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Init() 内で NativeStringList や NativeList\u0026lt;char\u0026gt; に格納しておく\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eInit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDataElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePersistent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003emark_list\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNativeStringList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePersistent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003emark_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"STRONG\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003emark_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Normal\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// NativeStringList から StringEntity を取り出すのは値を全て格納してから\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// あるいは全ての文字列を格納しきれるようあらかじめ大きな Capacity を設定しておく\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// (StringEntity を取り出した後にバッファが再確保されると不正メモリ参照でクラッシュ)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003echeck_mark\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emark_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 改行コードはあらかじめ解析されて NativeStringList に格納される\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// List\u0026lt;string\u0026gt; のような感覚で使う\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eParseLines\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeStringList\u003c/span\u003e \u003cspan class=\"n\"\u003elines\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003econtinueRead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003elines\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elines\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003econtinueRead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eParseLineImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eParseLineImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eReadOnlyStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// StringEntity.Split() の結果を受け取るリスト\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estr_list\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadOnlyStringEntity\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTemp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// カンマ区切りで \"CharaName_STRONG,11,64,15.7,1.295e+3\" みたいなデータだったなら\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003esplit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e','\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estr_list\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// こんな風に\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estr_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003estr_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryParse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003eID\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003estr_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryParse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eHP\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003estr_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryParse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eAttack\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003estr_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryParse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"n\"\u003eSpeed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// こんなことも\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003emark_index\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIndexOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echeck_mark\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// \"STRONG\" を検索\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emark_index\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"cm\"\u003e/* このキャラ特有の何か */\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003estr_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 正しいフォーマットとして解析できたか\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003esuccess\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 解釈できなかったのでパース中止\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDataElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eHP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eAttack\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSpeed\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 解釈できたので次の行に進む\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのような具合に。\u003cbr\u003e\n実際には JobSystem の中で処理されますが、ユーザーが書く部分は通常のC#にだいぶ近い感じに設計できたと思います。\u003c/p\u003e\n\n\u003cp\u003eまた、上記 \u003ccode\u003eclass TextData\u003c/code\u003e は各プロジェクトにおいて適宜差し替えて使用することが前提ですが、常に JobSystem で実行されるとデバッグが面倒です。なのでメインスレッドでの実行を強制する下記のAPIもあります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eAsyncTextFileReader\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNewProjectData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePersistent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUTF8\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// この場合 ParseLine(line) 内で Debug.Log() が使える。\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// また、 var sb = new StringBuilder() や (obj).ToString() をしてもよい。\u003c/span\u003e\n\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLoadFileInMainThread\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJobState\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWaitForCallingComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// データを取り出してデバッグする\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eちなみに、\u003ca href=\"https://qiita.com/mao_/items/8f95bc9dbeb3179ba4b9\" title=\"【Unity】ファイルを非同期で読み込んでアンマネージドメモリに展開できるAsyncReadManagerを試してみた\"\u003e先駆者様の例\u003c/a\u003eと同等のサイズの 50万キャラクターのファイルについて、当方の環境では\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e処理内容\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e経過時間\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eFile.ReadAllLines()から解析\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e710~850ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eCharaDataParser.ParseLines(lines)で解析\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e460~480ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eCharaDataParser.ParseLines(lines)を\u003ca href=\"https://qiita.com/kawai125/items/540dd8e5d2b4c7c1fa3b#burst-%E7%89%88%E3%81%AE%E6%80%A7%E8%83%BD%E8%A9%95%E4%BE%A1\" id=\"reference-2e47aebe179aa3d3036a\"\u003eBurst\u003c/a\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e240~250ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eとなっており、 C# string と高速化の相性の悪さが如実に表れています。\u003cbr\u003e\nこれで \u003ccode\u003eFile.ReadAllLines()\u003c/code\u003e を使わずに済むようになるでしょう。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"中身のお話-あるいは四苦八苦の記録\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%AD%E8%BA%AB%E3%81%AE%E3%81%8A%E8%A9%B1-%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E5%9B%9B%E8%8B%A6%E5%85%AB%E8%8B%A6%E3%81%AE%E8%A8%98%E9%8C%B2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e中身のお話 (あるいは四苦八苦の記録)\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"asyncreadmanagerをnativecontainer風にラップしておく\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#asyncreadmanager%E3%82%92nativecontainer%E9%A2%A8%E3%81%AB%E3%83%A9%E3%83%83%E3%83%97%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e▽AsyncReadManagerをNativeContainer風にラップしておく\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eAsyncReadManager.Read()\u003c/code\u003e はファイルデータのバッファ先や読み込みに関する制御情報(\u003ccode\u003eReadCommand\u003c/code\u003eや\u003ccode\u003eReadHandle\u003c/code\u003e)の管理が必要で、APIをそのまま使うのは面倒なのでこれらをまとめて管理する\u003ccode\u003eAsyncByteReader\u003c/code\u003eとしてラップします。\u003c/p\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e \u003ccode\u003eAsyncByteReader\u003c/code\u003e の実装(抜粋) \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eAsyncByteReader.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eAsyncByteReaderInfo\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebufferSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edataSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003eallocated\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003e_haveReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eReadHandle\u003c/span\u003e \u003cspan class=\"n\"\u003e_readHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eReadHandle\u003c/span\u003e \u003cspan class=\"n\"\u003eReadHandle\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_readHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eset\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDisposeReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_readHandle\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_haveReadHandle\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDisposeReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_haveReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_readHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_haveReadHandle\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eHaveReadHandle\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_haveReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// ここで使用している PtrHandle\u0026lt;T\u0026gt; については後述\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eAsyncByteReader\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_byteBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAsyncByteReaderInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_readCmd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eBufferSize\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebufferSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edataSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// the constructor must be called by main thread only.\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eAsyncByteReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_byteBuffer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eDefine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMinByteBufferSize\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAsyncByteReaderInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_readCmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebufferSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDefine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMinByteBufferSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edataSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eallocated\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_byteBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nf\"\u003eDisposeReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_readCmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eJobHandle\u003c/span\u003e \u003cspan class=\"nf\"\u003eReadFileAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckPreviousJob\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efileInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFileInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003efileInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eExists\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"the file '\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\"'is not found.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efileInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003e_readCmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eReadCommand\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eOffset\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efileInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eBuffer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_byteBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edataSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003efileInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadHandle\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eAsyncReadManager\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_readCmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJobHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eCheckPreviousJob\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHaveReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJobHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInvalidOperationException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"previous read job is still running. call Complete().\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nf\"\u003eDisposeReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJobHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_byteBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_byteBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003eこれを用いることで、以下のようにNativeContainerに近い感覚で\u003ccode\u003eAsyncReadManager.Read()\u003c/code\u003eを使えるようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// reader を作成\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebyte_reader\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAsyncByteReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePersistent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 読み込み開始\u003c/span\u003e\n\u003cspan class=\"n\"\u003eJobHandle\u003c/span\u003e \u003cspan class=\"n\"\u003ejob\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebyte_reader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadFileAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 読み込んだバッファにアクセス\u003c/span\u003e\n\u003cspan class=\"n\"\u003ejob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// byte_reader.Complete() でも可\u003c/span\u003e\n\u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebyte_reader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebyte_reader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// reader を破棄\u003c/span\u003e\n\u003cspan class=\"n\"\u003ebyte_reader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"string-使用禁止-しかし-encoding-や-parse--split-は欲しい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#string-%E4%BD%BF%E7%94%A8%E7%A6%81%E6%AD%A2-%E3%81%97%E3%81%8B%E3%81%97-encoding-%E3%82%84-parse--split-%E3%81%AF%E6%AC%B2%E3%81%97%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e▽string 使用禁止！ しかし Encoding や Parse() 、 Split() は欲しい……\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"c-string-と-jobsystem-の相克\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#c-string-%E3%81%A8-jobsystem-%E3%81%AE%E7%9B%B8%E5%85%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eC# string と JobSystem の相克\u003c/h3\u003e\n\n\u003cp\u003eC# における文字列解析、というと、よくある例としては \u003ccode\u003eFiles.ReadAllLines()\u003c/code\u003e で string[] を受け取り、イテレータで行ごとに回してそこから望みのフォーマットに \u003ccode\u003esplit()\u003c/code\u003e で切り出した後、数値に変換するなら \u003ccode\u003eParse()\u003c/code\u003e メソッドを使用する、というパターンかと思います。\u003cbr\u003e\u003cbr\u003e\nしかしこのデザインの根幹である \u003ccode\u003estring\u003c/code\u003e は参照型で、たとえ \u003ccode\u003eGCHandle\u003c/code\u003e などを使用し JobSystem に持ち込んでも string インスタンスの生成は当然できないので \u003ccode\u003eString.Split()\u003c/code\u003e が使えません。\u003cbr\u003e\u003cbr\u003e\nそこで本実装では \u003ca href=\"https://qiita.com/mao_/items/220ccf3b2ef929388036#unity2019%E7%B3%BB%E7%B5%B1%E3%81%8B%E3%82%89%E3%81%AF%E5%B0%91%E3%81%97%E6%89%B1%E3%81%84%E3%81%8C%E7%95%B0%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%8D%E3%81%A6%E3%81%84%E3%82%8B\" id=\"reference-c808051f601980b82aa7\"\u003eUnity 2019.1 より char 型の NativeContainer を作成できるようになった\u003c/a\u003e ことを利用して、文字列はまるっと \u003ccode\u003eNativeList\u0026lt;char\u0026gt;\u003c/code\u003e に保持して、これに \u003ccode\u003estring\u003c/code\u003e のように扱えるインターフェイスを被せることにしました。\u003cbr\u003e\u003cbr\u003e\nまず文字列全体の管理として、 \u003ccode\u003estring\u003c/code\u003e (のようなもの)が集合した \u003ccode\u003echar\u003c/code\u003e についての\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/csharp/programming-guide/arrays/jagged-arrays#:%7E:text=%E3%82%B8%E3%83%A3%E3%82%B0%E9%85%8D%E5%88%97%E3%81%AF%E3%80%81%E3%81%9D%E3%81%AE%E8%A6%81%E7%B4%A0,%E9%85%8D%E5%88%97%E3%81%8B%E3%82%89%E3%81%AA%E3%82%8B%E9%85%8D%E5%88%97%E3%81%A7%E3%81%99%E3%80%82\" title=\"C# プログラミング ガイド ジャグ配列は、その要素,配列からなる配列です。\" rel=\"nofollow noopener\" target=\"_blank\"\u003eジャグ配列\u003c/a\u003e に相当するコンテナにデータ本体を保持し、外側配列のインデックスアクセスで当該部分のスライスを取り出す、という形にします。 \u003ccode\u003eList\u0026lt;string\u0026gt;\u003c/code\u003e のように使えることを目標とします。\u003cbr\u003e\u003cbr\u003e\n大本の管理 struct は何となくジェネリックにします。\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e ジェネリックなデータ本体部 \u003ccode\u003eNativeJaggedArray\u0026lt;T\u0026gt;\u003c/code\u003e の実装(抜粋) \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eNativeJaggedArray.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eNativeJaggedArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ewhere\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eunmanaged\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEquatable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eElemIndex\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eStart\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eEnd\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStart\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eElemIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003est\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStart\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003est\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_buff\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eElemIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_elemIndexList\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003egenTrace\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003egenSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"nf\"\u003eNativeJaggedArray\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_buff\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_elemIndexList\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eElemIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e        \u003cspan class=\"n\"\u003egenTrace\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egenSignature\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003e_buff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// sigunature = address value of ptr for char_arr.\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_buff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_elemIndexList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_elemIndexList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eSize\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_buff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eelem_index\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_elemIndexList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eelem_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_buff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eelem_index\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eelem_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eelem_index\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetGenPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetGen\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#else\n\u003c/span\u003e            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eelem_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eelem_index\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eStart\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_buff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_buff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddRange\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_elemIndexList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eElemIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdateSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// specialize for NativeJaggedArraySlice\u0026lt;T\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"slice\"\u0026gt;\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRemoveAt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckElemIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_elemIndexList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_elemIndexList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_elemIndexList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveAtSwapBack\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egap\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eNextGen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eConditional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ENABLE_UNITY_COLLECTIONS_CHECKS\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdateSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e        \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003enow_sig\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetGenSigneture\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enow_sig\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egenSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eNextGen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egenSignature\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enow_sig\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eNextGen\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003enow_gen\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egenTrace\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egenTrace\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enow_gen\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetGenSigneture\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_buff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetGen\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egenTrace\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetGenPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egenTrace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e ジェネリックなスライス部分 \u003ccode\u003eNativeJaggedArraySlice\u0026lt;T\u0026gt;\u003c/code\u003e の実装(抜粋) \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eNativeJaggedArraySlice.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eIJaggedArraySliceBase\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ewhere\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eunmanaged\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEquatable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eReadOnlyNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eISlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"nf\"\u003eSlice\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebegin\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eStructLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLayoutKind\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSequential\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIJaggedArraySliceBase\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIEquatable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEquatable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eISlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ewhere\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eunmanaged\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEquatable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeDisableUnsafePtrRestriction\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeDisableUnsafePtrRestriction\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e_gen_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003e_gen_entity\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003egen_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003egen_entity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_len\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_gen_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egen_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_gen_entity\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egen_entity\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#else\n\u003c/span\u003e    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_len\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e*(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eset\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckElemIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e*(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eSlice\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebegin\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebegin\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ebegin\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckSliceRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003enew_len\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enew_len\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_gen_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_gen_entity\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#else\n\u003c/span\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enew_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eConditional\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ENABLE_UNITY_COLLECTIONS_CHECKS\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_gen_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003e_gen_entity\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ignore case for NativeJaggedArraySliceGeneratorExt\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"p\"\u003e*(\u003c/span\u003e\u003cspan class=\"n\"\u003e_gen_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003e_gen_entity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInvalidOperationException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"this slice is invalid reference.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003eスライスは本当にポインタと長さしか持ちません (release build 時)。\u003cbr\u003e\u003cbr\u003e\n\u003ccode\u003eUnity.Collections\u003c/code\u003e で \u003ccode\u003eNativeArray\u0026lt;T\u0026gt;\u003c/code\u003e から \u003ccode\u003eNativeSlice\u0026lt;T\u0026gt;\u003c/code\u003e は作れるのに対して \u003ccode\u003eNativeList\u0026lt;T\u0026gt;\u003c/code\u003e からは作れないのは、 List の伸縮に伴い内部バッファの再確保が行われた場合、メモリ上の位置が変わってそれまでに作ったポインタによる参照が無効になってしまうため、安全なスライスを作れないことが理由の一つとして考えられます。\u003cbr\u003e\u003cbr\u003e\n今回の実装では、文字列の取り扱いとして最初にデータ全体の構築を行い、その後は要素の追加をせずにスライスの切り出しのみを行うことを基本方針としてちょっと危なめな設計にしました。\u003cbr\u003e\u003cbr\u003e\nそうはいってもついやっちゃうこともあり得るので、要素の追加時に内部バッファの \u003ccode\u003e_buff.GetUnsafePtr()\u003c/code\u003e の値が変化したかどうかを確認し、それにより世代確認を行う関数 \u003ccode\u003eCheckReallocate()\u003c/code\u003e を実装してあります。\u003cbr\u003e\n\u003cstrong\u003eUnityEditor 上であればやらかしを検知できます。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eこれに文字列に特化したインターフェイスを被せてジャグ配列の \u003ccode\u003eNativeStringList\u003c/code\u003e とスライスの \u003ccode\u003eStringEntity\u003c/code\u003e とします。(今更だけど怒られそうな名前を付けてしまった……)\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e \u003ccode\u003eNativeStringList\u003c/code\u003e の実装(抜粋) \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eNativeStringList.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eNativeStringList\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeJaggedArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_jarr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"nf\"\u003eNativeStringList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003e_jarr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeJaggedArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003e_jarr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003eLast\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// string のようなものへの特殊化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_jarr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_jarr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eReadOnlyStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e \u003ccode\u003eStringEntity\u003c/code\u003e の実装(抜粋) \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eStringEntity.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIParseExt\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIJaggedArraySliceBase\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eISlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIEquatable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEquatable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"k\"\u003e]\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEquatable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEquatable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* 中略 */\u003c/span\u003e\n\n    \u003cspan class=\"cm\"\u003e/* string のようなものへの特殊化 */\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_len\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// pointing same target\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eReadOnlyStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eentity\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eReadOnlyNativeJaggedArraySlice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSequenceEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003ec_arr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003ec_arr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSequenceEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ec_arr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ein_itr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckReallocate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSequenceEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ein_itr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e==(\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e!=(\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e==(\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eReadOnlyStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e!=(\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eReadOnlyStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e==(\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"p\"\u003e!=(\u003c/span\u003e\u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003elhs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eStringEntity\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eIJaggedArraySliceBase\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;)\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eEquals\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eReadOnlyStringEntity\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetReadOnly\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eReadOnlyStringEntity\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003eこれで \u003ccode\u003estring\u003c/code\u003e のようなもの同士で比較したり、スライスを切り出したりやりたい放題できるようになりました。\u003cbr\u003e\nなお、 \u003ccode\u003eNativeJaggedArray\u0026lt;T\u0026gt;\u003c/code\u003e のほうを使えば任意の \u003ccode\u003estruct\u003c/code\u003e についてユーザー管理の共通バッファへの参照を JobSystem と GameObject の両方にばらまくことができてしまいます。ポインタ無法地帯へはあと一歩のぎりぎりのラインにいるので、ご利用は計画的に。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"encoder-の自力実装は勘弁してほしい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#encoder-%E3%81%AE%E8%87%AA%E5%8A%9B%E5%AE%9F%E8%A3%85%E3%81%AF%E5%8B%98%E5%BC%81%E3%81%97%E3%81%A6%E3%81%BB%E3%81%97%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eEncoder の自力実装は勘弁してほしい\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eなので \u003ccode\u003eGCHandle\u003c/code\u003e で JobSystem の中に持っていく\u003cbr\u003e\n \u003ccode\u003eEncoder\u003c/code\u003e , \u003ccode\u003eDecoder\u003c/code\u003e をバグなく実装する自信はないですし、さらに日本語の文字コードは Unicode系列 (UTF-8, UTF-16, UTF-32)のほかに Shift-JISやらEUC-JP、 ISO-2022-JPなどどんなデータを読む羽目になるか分かったものではありません。(特に古いシステムの吐いたデータほど。)\u003cbr\u003e\n 幸い C# 標準に \u003ccode\u003eDecoder.GetChars(byte*, int, char* ,int)\u003c/code\u003e 関数が用意されており、 \u003ccode\u003eGCHandle\u003c/code\u003e で持ち込みさえすれば JobSystem で使えます。\u003c/li\u003e\n\u003cli\u003e日本ローカルの Encoding に注意！\u003cbr\u003e\n 上で上げたエンコーディングのうち、Shift-JIS、EUC-JP、ISO-2022-JP の３つは \u003ca href=\"https://helpdesk.unity3d.co.jp/hc/ja/articles/204694010-System-Text-Encoding-%E3%81%A7-Shift-JIS-%E3%82%92%E4%BD%BF%E3%81%84%E3%81%9F%E3%81%84\" title=\"System.Text.Encoding で Shift JIS を使いたい\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnityEditor上では普通に使えますがビルドすると必要なDLLが欠けるためプレイヤーがこけます。\u003c/a\u003e\u003cbr\u003e\n  上の記事で対応は可能ですが、レガシーの文字エンコードの対応が適当……\u003cbr\u003e\n  (いやゲームエンジンとしては不要なモノなのでまっとうな設計ではあるのですが)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"tryparse-split-strip-は自力実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#tryparse-split-strip-%E3%81%AF%E8%87%AA%E5%8A%9B%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTryParse(), Split(), Strip() は自力実装\u003c/h3\u003e\n\n\u003cp\u003e文字列解析用データ構造として \u003ccode\u003eStringEntity\u003c/code\u003e を自作してしまったので、これらのユーティリティも当然自作します。\u003cbr\u003e\u003cbr\u003e\n実装の単純化のため、C#では\u003ccode\u003eParse()\u003c/code\u003e メソッドで一緒くたになっていた十進表記と１６進数表記の解析を \u003ccode\u003eTryParse()\u003c/code\u003e と \u003ccode\u003eTryParseHex()\u003c/code\u003e に分離します。パーサーを作るにあたって、どちらの表記かわからない、なんてことはないでしょうし、そもそもHexフォーマットを使う状況というのは \u003ccode\u003efloat\u003c/code\u003e や \u003ccode\u003edouble\u003c/code\u003e の値を確実に読み書きしたい状況ぐらいでしょう。\u003cbr\u003e\u003cbr\u003e\n\u003ccode\u003eSplit()\u003c/code\u003e , \u003ccode\u003eStrip()\u003c/code\u003e については、さっそく \u003ccode\u003eStringEntity.Slice()\u003c/code\u003e の出番です。普通に線形探索して結果を切り出します。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"base64-の変換もできると便利\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#base64-%E3%81%AE%E5%A4%89%E6%8F%9B%E3%82%82%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%A8%E4%BE%BF%E5%88%A9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eBase64 の変換もできると便利\u003c/h3\u003e\n\n\u003cp\u003e前節で \u003ccode\u003eTryParseHex()\u003c/code\u003e を用意したものの、データの利用効率が劣悪(4bit -\u0026gt; 8bit と必要分で単純に倍、プリフィックスに \u003ccode\u003e0x\u003c/code\u003e をつければ 2B 追加。ASCIIコード換算で \u003ccode\u003efloat\u003c/code\u003e が 4B -\u0026gt; 10B = 250% になる)なので配列や構造体の生バイト列などの大きなものには正直向いていません。\u003cbr\u003e\u003cbr\u003e\nというわけで由緒正しき \u003ca href=\"https://ja.wikipedia.org/wiki/Base64\" rel=\"nofollow noopener\" target=\"_blank\"\u003eBase64\u003c/a\u003e のコンバータを用意しましょう。\u003cbr\u003e\n\u003ca href=\"https://referencesource.microsoft.com/#System/net/System/Net/mail/Base64Stream.cs,18795287b9fa8fd2\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC# Reference Source\u003c/a\u003e の実装を参考に、テーブル変換なので中身は単純です。\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e Base64コンバータの実装(抜粋) \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eStringParser.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// The Encoder for MIME Base64 (RFC 2045).\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eNativeBase64Encoder\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eBase64EncodeMap\u003c/span\u003e \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBase64Info\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// convert bytes into chars in Base64 format.\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"buff\"\u0026gt;output\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"byte_ptr\"\u0026gt;source ptr\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"byte_len\"\u0026gt;source length\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"splitData\"\u0026gt;additional bytes will be input or not. (false: call Terminate() internally.\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetChars\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ebyte_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebyte_len\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003esplitData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyte_len\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"invalid bytes length.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003echarcount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebyte_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003einsertLF\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echarcount\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eBase64Const\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLineBreakPos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'\\r'\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sc\"\u003e'\\n'\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003echarcount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003ebyte_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// encoding 3 bytes -\u0026gt; 4 chars\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0xfc0000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e18\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x03f000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e12\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x000fc0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e  \u003cspan class=\"m\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x00003f\u003c/span\u003e\u003cspan class=\"p\"\u003e)]);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003echarcount\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003esplitData\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTerminate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// apply termination treatment.\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"buff\"\u0026gt;output\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eTerminate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// do nothing\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// two character padding needed\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0xfc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x03\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// pad\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// pad\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// one character padding needed\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0xfc00\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x03f0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e  \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x000f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e  \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// pad\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// The Decoder for MIME Base64 (RFC 2045).\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eNativeBase64Decoder\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eBase64DecodeMap\u003c/span\u003e \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBase64Info\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// convert Base64 format chars into bytes.\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"buff\"\u0026gt;output\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"char_ptr\"\u0026gt;source ptr\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"char_len\"\u0026gt;source length\u0026lt;/param\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;returns\u0026gt;convert successfull or not\u0026lt;/returns\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003echar_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003echar_len\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echar_len\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#if UNITY_EDITOR\n\u003c/span\u003e            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"invalid chars length.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#else\n\u003c/span\u003e            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003echar_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003echar_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsWhiteSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'='\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#if UNITY_EDITOR\n\u003c/span\u003e                    \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"invalid padding detected.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#else\n\u003c/span\u003e                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// pick 1 byte from \"**==\" code\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e)((\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x0ff0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// pick 2 byte from \"***=\" code\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e)((\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x03fc00\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e)((\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x0003fc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e  \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"m\"\u003e255\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x3f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e)((\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0xff0000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e16\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e)((\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x00ff00\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e  \u003cspan class=\"m\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e)((\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x0000ff\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n                \u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebytePos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eIsWhiteSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e' '\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'\\t'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'\\n'\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e'\\r'\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase64EncodeMap\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eBase64EncodeMap\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_map\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"m\"\u003e65\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e65\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e\u003cspan class=\"m\"\u003e90\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 'A' ~ 'Z'\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e97\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e\u003cspan class=\"m\"\u003e122\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 'a' ~ 'z'\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e48\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e\u003cspan class=\"m\"\u003e57\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// '0' ~ '9'\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e43\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// '+'\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e47\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// '/'\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e61\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// '='\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e65\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"input byte must be in range [0x00, 0x40].\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eBase64DecodeMap\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eBase64DecodeMap\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_map\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeArray\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"m\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e62\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// 0x2b, '+'\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e255\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// invalid code\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e63\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// 0x2f, '/'\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e52\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e\u003cspan class=\"m\"\u003e61\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// '0' ~ '9'\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"m\"\u003e7\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e255\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// invalid code\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e\u003cspan class=\"m\"\u003e25\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 'A' ~ 'Z'\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"m\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e255\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// invalid code\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e26\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e51\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 'a' ~ 'z'\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x2b\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e255\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x7a\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e255\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_map\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e0x2b\u003c/span\u003e\u003cspan class=\"p\"\u003e)];\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003e元のリファレンスでは全ビットパターン分(16*16=256)テーブルが作ってありましたが、有効な値は64種類、いくつか途中にある無効な値を考慮しても端から端まで長さ80あれば足りるので、今回の実装ではせっかくなので小さくしてみました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"どうせならユーザー定義データも-class-にしてしまえばいい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%A9%E3%81%86%E3%81%9B%E3%81%AA%E3%82%89%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%AE%9A%E7%BE%A9%E3%83%87%E3%83%BC%E3%82%BF%E3%82%82-class-%E3%81%AB%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%88%E3%81%B0%E3%81%84%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e▽どうせならユーザー定義データも class にしてしまえばいい\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eEncoding\u003c/code\u003e を持ち込むと決めた段階で、byte列 -\u0026gt; char列の変換処理に Burst を使えないことが確定しました。\u003cbr\u003e\nジョブ丸ごとの struct 化とかもう気にしなくていいので、ユーザー定義のデータコンテナも class ということにして、これも \u003ccode\u003eGCHandle\u003c/code\u003e でJobSystemへ持って行きます。\u003cbr\u003e\nただしこの設計により、誤って struct のデータコンテナを渡したところ当然ながら GCHandle の取得でコケたので、最終的に class のみを受け取る形にしました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ポインタがすべてを解決する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%8C%E3%81%99%E3%81%B9%E3%81%A6%E3%82%92%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e▽ポインタがすべてを解決する\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"高速化\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%AB%98%E9%80%9F%E5%8C%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e高速化\u003c/h3\u003e\n\n\u003cp\u003e実は実装初期のパース速度は Chara 50万体のデータに ~ 1300 ms 程度とだいぶ遅かったのですが、プロファイラを確認したところ主要な処理負荷がインデクサ \u003ccode\u003ethis[index]\u003c/code\u003e や \u003ccode\u003eLength\u003c/code\u003e フィールドから値を取り出すところだったので、ライブラリ内の処理実装部分では最初に \u003ccode\u003evoid*\u003c/code\u003e と \u003ccode\u003eLength\u003c/code\u003e を取り出してポインタで直接処理するようにしました。その高速化の経過は下記の通り。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e処置した関数\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e速度\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eStringSplitter.Split()\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e~1000 ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e上記に加え、 TextDecoder.ParseLineImpl()\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e700 ~ 800 ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e上記に加え、 StringParserExt.TryParse()\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e600 ~ 700 ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eそのほかBoxingの除去など\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e500 ~ 550 ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e見やすいプロファイラは素晴らしい。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"共有変数の管理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%85%B1%E6%9C%89%E5%A4%89%E6%95%B0%E3%81%AE%E7%AE%A1%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e共有変数の管理\u003c/h3\u003e\n\n\u003cp\u003eまた、欲しい関数の追加や処理のバッファとして内部的に使う、などにより \u003ccode\u003eNativeContiner\u003c/code\u003e に似たものを多数作成しましたが、状態管理用の変数ごとにポインタを作るのは手間がかかる上に事故の危険もコピーコストも増大する挙句、データがメモリ上に分散して性能に悪影響を及ぼします。\u003cbr\u003e\nよって、ジェネリックなポインタ管理ヘルパー \u003ccode\u003ePtrHandle\u0026lt;T\u0026gt;\u003c/code\u003e を作りましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e ポインタ管理ヘルパー \u003ccode\u003ePtrHandle\u0026lt;T\u0026gt;\u003c/code\u003e の実装 \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ePtrHandle.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e \u003cspan class=\"k\"\u003ewhere\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eunmanaged\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeDisableUnsafePtrRestriction\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003e_isCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eNativeSetClassTypeToNullOnSchedule\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eDisposeSentinel\u003c/span\u003e \u003cspan class=\"n\"\u003e_disposeSentinel\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAtomicSafetyHandle\u003c/span\u003e \u003cspan class=\"n\"\u003e_safety\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNone\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Allocator must be Temp, TempJob or Persistent\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSizeOf\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(),\u003c/span\u003e \u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlignOf\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(),\u003c/span\u003e \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_isCreated\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e        \u003cspan class=\"n\"\u003eDisposeSentinel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003e_safety\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003e_disposeSentinel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNone\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Allocator must be Temp, TempJob or Persistent\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSizeOf\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(),\u003c/span\u003e \u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlignOf\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(),\u003c/span\u003e \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_isCreated\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e        \u003cspan class=\"n\"\u003eDisposeSentinel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003e_safety\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003e_disposeSentinel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003eIsCreated\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_isCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIsCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#if ENABLE_UNITY_COLLECTIONS_CHECKS\n\u003c/span\u003e            \u003cspan class=\"n\"\u003eDisposeSentinel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003e_safety\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003e_disposeSentinel\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCheckAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFree\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_isCreated\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInvalidOperationException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Dispose() was called twise, or not initialized target.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003e_isCreated\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInvalidOperationException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"target is not allocated.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"n\"\u003eValue\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eset\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eimplicit\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e \u003cspan class=\"nf\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eCheckAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsValidAllocator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInvalidOperationException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"The buffer can not be Disposed because it was not allocated with a valid allocator.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003eこの \u003ccode\u003ePtrHandle\u0026lt;T\u0026gt;\u003c/code\u003e を使用して、\u003ccode\u003eNativeContiner\u003c/code\u003e に似た struct の状態変数は以下のように一括管理ができるようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eMyInfo\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eFlag\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eMyStateEnum\u003c/span\u003e \u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eMyProcessor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ewhere\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eunmanaged\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMyInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eMyProcessor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_buffer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_buffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eMyStateEnum\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDefault\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"cm\"\u003e/* 何か処理 */\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003ePtrHandle\u0026lt;T\u0026gt;\u003c/code\u003e は GameObject 側と JobSystem 側での変数の共有を想定しており、(ライブラリの外部に渡す場合には内容を別の出力専用 \u003ccode\u003ereadonly struct\u003c/code\u003e に値をコピーしてから返すなどの安全対策をしておけば) Job の管理にも有用です。\u003cbr\u003e\nデモでファイル読み込みの進捗状況を取得して表示させていますが、内部的には \u003ccode\u003ePtrHandle\u0026lt;T\u0026gt;\u003c/code\u003e を利用しています。\u003c/p\u003e\n\n\u003cp\u003estruct へのポインタを安全に保持したいだけなら大きさ1の\u003ccode\u003eNativeArray\u003c/code\u003eを作ることも考えられますが、Unity標準のNativeContainerはJobSystemの安全装置によってJobSystemで使用中はメインスレッドからのアクセスが禁止されてしまうため、Job実行中の共有情報の参照には使えません。\u003c/p\u003e\n\n\u003cp\u003eよって、NativeContainerの安全装置のうち意図的にアクセッサの安全装置だけを殺したものとして \u003ccode\u003ePtrHandle\u0026lt;T\u0026gt;\u003c/code\u003e をつくり、これを各種管理情報の保持、参照に使います。\u003c/p\u003e\n\n\u003cp\u003eライブラリに閉じ込めるなどしてポインタが暴れださないようにできれば、\u003cstrong\u003eポインタはすべてを解決する。\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"in-readonly-struct-で速くならない\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#in-readonly-struct-%E3%81%A7%E9%80%9F%E3%81%8F%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e▽in readonly struct で速くな……らない！\u003c/h2\u003e\n\n\u003cp\u003e実はしれっとスライスの実装を \u003ccode\u003ereadonly struct\u003c/code\u003e で定義していたので、さらなるコピー削減のため \u003ccode\u003eStringEntity\u003c/code\u003e を引数に渡している部分に \u003ccode\u003ein\u003c/code\u003e をつけてみます。その結果……\u003cstrong\u003e100 ms 程遅くなりました。\u003c/strong\u003e\u003cbr\u003e\nそもそも最初に頑張ってスライスを軽量化した結果、パディングの具合にもよりますがリリースビルドでは 8 byte ~ 16 byte のフットプリントしかありません。小さい struct では \u003ca href=\"https://blog.meilcli.net/2018/06/big-size-structin.html\" title=\"【C#】Big Size Structが値コピーでつらいならin引数で値コピーしなければいいじゃない！！ ＜ それ本当？\" rel=\"nofollow noopener\" target=\"_blank\"\u003ein readonly struct を渡して低速化する報告\u003c/a\u003eもあり、常々言われることではありますがやはり最適化に計測と確認は必須です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"文字列デコードのブロック処理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%96%87%E5%AD%97%E5%88%97%E3%83%87%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E5%87%A6%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e▽文字列デコードのブロック処理\u003c/h2\u003e\n\n\u003cp\u003eC# における \u003ccode\u003echar\u003c/code\u003e は最小データサイズが 2 byte になる UTF-16 が採用されています。ここで、例えば UTF-8 でエンコードされた、ほぼASCIIコードのテキストファイル(=ファイル上ではほぼ全て 1 byte)を一気にデコードすると、メモリ上にファイルサイズの倍の大きさの char配列が出現します。元のファイルサイズがMBクラスの大きさならあっという間にCPUのキャッシュからはみ出して処理速度が悲しいことになります。\u003cbr\u003e\u003cbr\u003e\nというわけで、キャッシュ内でパース処理をするためにブロック単位で char に変換し、改行コードを解析して line を示すスライスに切り出し、ブロック内の切り出しが終わったら出来上がった line を \u003ccode\u003eITextFilePaser.ParseLine(line)\u003c/code\u003e に流し込みます。\u003cbr\u003e\nこの line の切り出しの表現に、先頭部分のカタマリの挿入、削除に対応するラッパーを被せた \u003ccode\u003eNativeHeadRemovableList\u0026lt;T\u0026gt;\u003c/code\u003e を使用します。\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e \u003ccode\u003eNativeHeadRemovableList\u0026lt;T\u0026gt;\u003c/code\u003e の実装(抜粋) \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eNativeHeadRemovableList.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eNativeHeadRemovableList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e \u003cspan class=\"k\"\u003ewhere\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eunmanaged\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_list\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_start\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"nf\"\u003eNativeHeadRemovableList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003e_start\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eset\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003e_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003e_start\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003e_start\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"cm\"\u003e/* 中略 */\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRemoveHead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"invalid length of remove target.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_start\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_start\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eInsertHead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"invalid size\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// when enough space exists in head\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003e_start\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_start\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_start\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMemCpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSizeOf\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// slide internal data\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003enew_length\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elen_move\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eResizeUninitialized\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enew_length\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edest\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003e_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003e_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003e_start\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMemMove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSizeOf\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elen_move\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// insert data\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_start\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMemCpy\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003e_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUnsafePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e*)\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUnsafeUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSizeOf\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003e改行を見つけたら当該部分のコピー後に \u003ccode\u003eNativeHeadRemovableList\u0026lt;T\u0026gt;.RemoveHead(int)\u003c/code\u003e で１行分ごそっと消しますが、内部的には \u003ccode\u003e_start\u003c/code\u003e に長さ分足しているだけです。\u003c/p\u003e\n\n\u003cp\u003eまた、ブロック処理の都合上末尾に未処理のデータ片が残り、これを次回の処理開始時に配列の先頭に移動させねばなりません。そのために \u003ccode\u003eNativeHeadRemovableList\u0026lt;T\u0026gt;.InsertHead(T*, int)\u003c/code\u003e を実装した……のですが、処理手順を考えると char配列の受け取り前に残ったデータを \u003ccode\u003eUnsafeUtility.MemMove()\u003c/code\u003e で先頭に移動して、 \u003ccode\u003eDecoder.GetChars(byte*, int, char* ,int)\u003c/code\u003e に渡すポインタをその続きにすれば一番効率的だったことにこれを書いてる今気づきました。\u003cbr\u003e\n現状で性能にほぼ影響がないので放置していますが、これから似たようなことをやる人はご注意ください。\u003cbr\u003e\nいまどきこんな低レベルなところを弄る人がどのくらいいるかわかりませんが……\u003c/p\u003e\n\n\u003cp\u003e具体的なブロックサイズについては、当方の検証では 2kB ~ 4kB 程度が一番よさげでしたので、2kB を規定値として採用しました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"注文も非同期な感じで受け付けてほしい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%B3%A8%E6%96%87%E3%82%82%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%81%AA%E6%84%9F%E3%81%98%E3%81%A7%E5%8F%97%E3%81%91%E4%BB%98%E3%81%91%E3%81%A6%E3%81%BB%E3%81%97%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e▽注文も非同期な感じで受け付けてほしい\u003c/h2\u003e\n\n\u003cp\u003eさて、これでそこそこの速度でテキストファイルをパースできるようになったわけですが、せっかく非同期なので追加の要求です。複数の GameObject から好き勝手に Load, UnLoad の要求が出される状況に対応しましょう。\u003cbr\u003e\n複数ファイルへの複数のユーザーからの問い合わせに対応するバージョンとして\u003cbr\u003e\n\u003ccode\u003eAsyncTextFileLoader\u0026lt;T\u0026gt;\u003c/code\u003e を作ります。\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e \u003ccode\u003eAsyncTextFileLoader\u0026lt;T\u0026gt;\u003c/code\u003e の実装(抜粋) \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eAsyncTextFileLoader.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAsyncTextFileLoader\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e\u003cspan class=\"err\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eITextFileParser\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_pathList\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eEncoding\u003c/span\u003e \u003cspan class=\"n\"\u003e_encoding\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eParseJob\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_parserPool\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_gen\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_blockSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_maxJobCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRunningJobInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_runningJob\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadStateImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_data\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eRunningJobInfo\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eFileIndex\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eParserID\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eRunningJobInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eparser_index\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eFileIndex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eParserID\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eparser_index\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAction\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eStore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eUnLoad\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eRequest\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efileIndex\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAction\u003c/span\u003e \u003cspan class=\"n\"\u003eaction\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAction\u003c/span\u003e \u003cspan class=\"n\"\u003eaction\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efileIndex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eaction\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eaction\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeQueue\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_parserAvail\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_requestList\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_updateUnLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eUnLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_unLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"cm\"\u003e/* 中略 */\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eMaxJobCount\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_maxJobCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eset\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003e_maxJobCount\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eLoadWaitingQueue\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_loadWaitingQueueNum\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eFlushLoadJobs\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 管理対象のファイルが追加されたら担当のデータクラス T を生成\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_pathList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_data\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_data\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003e_data\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eInit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003es_tmp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eReadStateImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003e_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003es_tmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es_tmp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// データとJobの状態について index でアクセス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efileIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003efileIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIsStandby\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInvalidOperationException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"the job running now for fileIndex = \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003efileIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_data\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003efileIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"n\"\u003eReadState\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetState\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetState\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Load, UnLoad ともに外部からの注文はいったんリストにためて Update() で処理\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eLoadFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_loadWaitingQueueNum\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_requestList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStore\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnLoadFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_requestList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnLoad\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdateImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFlushLoadJobs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFlushLoadJobs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// リストにためた注文を一気に処理する\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdateImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eflush_all_jobs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// check job completed or not\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_runningJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e--)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ejob_info\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_runningJob\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eread_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFileIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eread_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eJobState\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWaitForCallingComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_parserPool\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParserID\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eread_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eJobState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReleaseParser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParserID\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_runningJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveAt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_unLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJobState\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWaitForCallingComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_unLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_unLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// no requests. or all available parser were running. retry in next Update().\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_requestList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_maxJobCount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003e_runningJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eflush_all_jobs\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//--- extract action\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_updateUnLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003e_requestList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eact\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_requestList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eact\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eaction\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStore\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etgt_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eact\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efileIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etgt_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRefCount\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eact\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efileIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"n\"\u003etgt_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRefCount\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_updateUnLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eact\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efileIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_requestList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//--- preprocess unload action\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_updateUnLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_updateUnLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etgt_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etgt_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRefCount\u003c/span\u003e\u003cspan class=\"p\"\u003e--;\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etgt_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRefCount\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efound_index\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIndexOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efound_index\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// remove from loading order (file loading is not performed)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveAtSwapBack\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efound_index\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// remove from loaded data\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_unLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJobState\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003etgt_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIsStandby\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"c1\"\u003e//--- unload in job (workaround for LargeAllocation.Free() cost in T.UnLoad().)\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_unLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddUnLoadTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_data\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"c1\"\u003e// now loading. unload request will try in next update.\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003etgt_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRefCount\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// reset ref count\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnLoadFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etgt_state\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRefCount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInvalidOperationException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"invalid UnLoading for index = \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_updateUnLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// schedule jobs\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//--- unload job\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_unLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnLoadAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//--- supply parsers for load job\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003en_add_parser\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003e_parserAvail\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eflush_all_jobs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003en_add_parser\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMaxJobCount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003e_parserPool\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003en_add_parser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003en_add_parser\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGenerateParser\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//--- run jobs\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003en_job\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_parserAvail\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003en_job\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efile_index\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ep_id\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_parserAvail\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDequeue\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ep_tmp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_parserPool\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ep_id\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ep_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ep_tmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBlockSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_blockSize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ep_tmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadFileAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_pathList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003e_encoding\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_data\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ep_state\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_runningJob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRunningJobInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ep_id\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e//--- write back excessive queue\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_loadWaitingQueueNum\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003en_job\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRefCount\u003c/span\u003e\u003cspan class=\"p\"\u003e--;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// reset ref count\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLoadFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_loadWaitingQueueNum\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_updateLoadTgtTmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003e大まかな流れとしては、\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e( \u003ccode\u003eUpdate()\u003c/code\u003e が呼ばれるまで) 任意の Load, UnLoad を受け付けてすべてリストにためる\u003c/li\u003e\n\u003cli\u003eたまった注文を Load と UnLoad に分ける\u003c/li\u003e\n\u003cli\u003eまず Load だけを取り出し、各ファイルの参照カウントをインクリメントし、\u003cbr\u003e\n ここで参照カウントが0→1になったなら LoadJob の予約表に書きこむ\u003c/li\u003e\n\u003cli\u003e次に UnLoad だけを取り出し、各ファイルの参照カウントをデクリメントし、\u003cbr\u003e\n ここで参照カウントが1→0になったなら、\n\n\u003col\u003e\n\u003cli\u003eLoadJob の予約表に該当ファイルの予約があれば、それを消す (その結果何もしない)\u003c/li\u003e\n\u003cli\u003e予約がなければ UnLoadJob の対象リストに入れる\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003eUnLoadJob を \u003ccode\u003eschedule()\u003c/code\u003e する。\u003c/li\u003e\n\u003cli\u003eLoadJob を \u003ccode\u003eschedule()\u003c/code\u003e する。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eLoad だけでなく UnLoad も Job にしてしまっていますが、これについては次節で説明します。\u003c/p\u003e\n\n\u003cp\u003eここにさらに同時に動作する LoadJob の最大数 \u003ccode\u003eMaxJobCount\u003c/code\u003e に合わせて、同時に保持するパーサーの数とジョブの割り当てを管理しています。\u003cbr\u003e\nパーサーは一度動かすとファイル丸ごとをバッファすること、またそもそもファイルのロードは多数を同時に走らせることは稀という前提で、メモリ消費の削減の観点からこのような設計にしました。しかし、後述の課題により \u003ccode\u003eMaxJobCount\u003c/code\u003e はせいぜい 1 ~ 2 ぐらいまでしかまともに動かないことが判明しました。\u003c/p\u003e\n\n\u003cp\u003e実際の運用では、 LoadJob 待機中の注文数を取得するプロパティ \u003ccode\u003eAsyncTextFileLoader\u0026lt;T\u0026gt;.LoadWaitingQueue\u003c/code\u003e を参照して注文する GameObject 側がタイミングを調節する形になるでしょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"大きなデータのunload\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A4%A7%E3%81%8D%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AEunload\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e▽大きなデータのUnLoad\u003c/h2\u003e\n\n\u003cp\u003e大きなファイルの読み込みもそうですが、メモリ領域の破棄にもそれなりにコストがかかります。\u003cbr\u003e\n大容量のデータをいくつも一気に UnLoad したりすると \u003ccode\u003eLargeAllocation.Free()\u003c/code\u003e に ms 単位で持っていかれかねません。せっかくパース処理そのものはワーカースレッドに追い出したのに、これでメインスレッドが遅くなったら片手落ちです。\u003cbr\u003e\u003cbr\u003e\n幸い \u003ccode\u003eNativeContainer\u003c/code\u003e のアロケータはワーカースレッドでも動くので、多数のファイルを管理する \u003ccode\u003eAsyncTextFileLoader\u0026lt;T\u0026gt;\u003c/code\u003e では \u003ccode\u003eUnLoad()\u003c/code\u003e もワーカースレッドにやらせてメインスレッドを身軽にします。\u003cbr\u003e\nここで、 \u003ccode\u003eJobHandle.Schedule()\u003c/code\u003e の呼び出しコストを削減するため、 \u003ccode\u003eUnLoad()\u003c/code\u003e 対象のデータ (の \u003ccode\u003eGCHandle\u003c/code\u003e )のリストを1つの Job に渡して一気に UnLoad させます。\u003cbr\u003e\nUnLoad 用の Job は以下のようになります。\u003c/p\u003e\n\n\u003cp\u003e\u003cdetails\u003e\u003csummary\u003e \u003ccode\u003eUnLoadJob\u0026lt;T\u0026gt;\u003c/code\u003e の実装(抜粋) \u003c/summary\u003e\u003cdiv\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eParseJob.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eUnLoadJobTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTdata\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ewhere\u003c/span\u003e \u003cspan class=\"n\"\u003eTdata\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e\u003cspan class=\"err\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eITextFileParser\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"n\"\u003eGCHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTdata\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"n\"\u003eReadStateImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003estate_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// UnLoad 対象の State. 書き換えだけ行うので生ポインタを渡す\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnLoadJobTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTdata\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eReadStateImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003estate_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eGCHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTdata\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estate_ptr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estate_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efile_index\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnLoad\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estate_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eJobState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnLoaded\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnLoad\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eUnLoadJobInfo\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e \u003cspan class=\"n\"\u003ejob_state\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"n\"\u003eJobHandle\u003c/span\u003e \u003cspan class=\"n\"\u003ejob_handle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"n\"\u003eBoolean\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc_handle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eUnLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTdata\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIJob\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ewhere\u003c/span\u003e \u003cspan class=\"n\"\u003eTdata\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e\u003cspan class=\"err\"\u003e,\u003c/span\u003e \u003cspan class=\"nc\"\u003eITextFileParser\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eUnLoadJobTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTdata\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_target\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eUnLoadJobInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e               \u003cspan class=\"c1\"\u003e// UnLoadJob の管理情報\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAllocator\u003c/span\u003e \u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_target\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eNativeList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eUnLoadJobTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTdata\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003ePtrHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eUnLoadJobInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDisposeHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_target\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDisposeHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc_handle\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_target\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \u003cspan class=\"n\"\u003e_target\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc_handle\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDisposeHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_target\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddUnLoadTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTdata\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eReadStateImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003estate_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_target\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eUnLoadJobTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTdata\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003efile_index\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estate_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ealloc_handle\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"n\"\u003eJobHandle\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnLoadAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_target\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnLoadJob\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_handle\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSchedule\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_handle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// no action\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eJobHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e \u003cspan class=\"n\"\u003eJobState\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_state\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eExecute\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_target\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e \u003cspan class=\"n\"\u003e_target\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnLoad\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWaitForCallingComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eunsafe\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_handle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ejob_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReadJobState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003c/p\u003e\n\u003c/div\u003e\u003c/details\u003e\u003c/p\u003e\n\n\u003cp\u003eこのジョブを1つインスタンス化しておいて、 UnLoad の注文が来たら \u003ccode\u003eUnLoadJob\u0026lt;T\u0026gt;.AddUnLoadTarget(int, T, PtrHandle\u0026lt;ReadStateImpl\u0026gt;)\u003c/code\u003e で対象の data を渡し、 \u003ccode\u003eUnLoadJob\u0026lt;T\u0026gt;.UnLoadAsync()\u003c/code\u003e で後始末させます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"課題\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%B2%E9%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e課題\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"burst-でもっと速くならない対応済\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#burst-%E3%81%A7%E3%82%82%E3%81%A3%E3%81%A8%E9%80%9F%E3%81%8F%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84%E5%AF%BE%E5%BF%9C%E6%B8%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◎Burst でもっと速くならない？(対応済)\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"2021425現行版でburstに対応しました\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2021425%E7%8F%BE%E8%A1%8C%E7%89%88%E3%81%A7burst%E3%81%AB%E5%AF%BE%E5%BF%9C%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e(2021/4/25)\u003ca href=\"https://qiita.com/kawai125/items/540dd8e5d2b4c7c1fa3b\"\u003e現行版でBurstに対応しました。\u003c/a\u003e\n\u003c/h3\u003e\n\n\u003cp\u003eいつになるかは不明ですが、\u003ca href=\"https://docs.unity3d.com/Packages/com.unity.burst@1.5/manual/docs/CSharpLanguageSupport_Types.html\" title=\"Burst User Guide\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式\u003c/a\u003eの案内では \u003ccode\u003echar\u003c/code\u003e には対応する予定らしいので、その暁にはもっと早くなるはず。  \u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eBurst does not support the following types:\u003cbr\u003e\n  - char (this will be supported in a future release)\u003cbr\u003e\n  - string as this is a managed type\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eライブラリ内部ではASCII範囲の値しか検索、比較していないので、 \u003ccode\u003echar\u003c/code\u003e をすべて \u003ccode\u003eunit16\u003c/code\u003e あたりにキャストして、\u003ca href=\"https://qiita.com/mao_/items/876fa56fb42bc5110345\" title=\"【Unity】BurstCompilerをJobSystem以外でも使いたい\" id=\"reference-6014f21d5ee451364599\"\u003e関数ポインタ経由でBurstさせれば\u003c/a\u003eもっと早くなる可能性は大いにあります。\u003cbr\u003e\u003cbr\u003e\nしかし、公式が対応すると明言していますし、上記の手法で Burst による高速化が特に期待されるホットスポットは \u003ccode\u003eTryParse()\u003c/code\u003e や \u003ccode\u003eSplit()\u003c/code\u003e 関数なので、Burst が \u003ccode\u003echar\u003c/code\u003e に対応したならユーザーデータクラスの \u003ccode\u003eParseLine(line)\u003c/code\u003e をまるごと適用したほうがはるかに効果的でしょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"複数のファイルを同時に読ませると途端に遅くなる解決済\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A4%87%E6%95%B0%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%90%8C%E6%99%82%E3%81%AB%E8%AA%AD%E3%81%BE%E3%81%9B%E3%82%8B%E3%81%A8%E9%80%94%E7%AB%AF%E3%81%AB%E9%81%85%E3%81%8F%E3%81%AA%E3%82%8B%E8%A7%A3%E6%B1%BA%E6%B8%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◎複数のファイルを同時に読ませると途端に遅くなる(解決済)\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"2021425-split-関数内の-boxing-を除去した現行版では解消しました\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2021425-split-%E9%96%A2%E6%95%B0%E5%86%85%E3%81%AE-boxing-%E3%82%92%E9%99%A4%E5%8E%BB%E3%81%97%E3%81%9F%E7%8F%BE%E8%A1%8C%E7%89%88%E3%81%A7%E3%81%AF%E8%A7%A3%E6%B6%88%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e(2021/4/25) Split() 関数内の Boxing を除去した現行版では解消しました。\u003c/h3\u003e\n\n\u003cp\u003eデモシーン\u003cbr\u003e\n\u003ccode\u003e/Assets/NativeStringCollections/Demo/Scenes/Demo_AsyncMultiFileManagement.unity\u003c/code\u003e で、\u003cbr\u003e\n\u003ccode\u003eAsyncTextFileLoader\u0026lt;T\u0026gt;\u003c/code\u003e を使用して \u003cstrong\u003en個 のファイルを同時に読み込む\u003c/strong\u003e指示を出すと、\u003cstrong\u003e同時に始まった個々のジョブの処理時間が n倍\u003c/strong\u003e になり、結局速くなくなるどころか遅延時間の分だけ1個ずつ読ませていたほうがまし、という症状が出ています。\u003cbr\u003e\u003cbr\u003e\nストレージ \u0026lt;-\u0026gt; メモリ間、あるいは CPU \u0026lt;-\u0026gt; メモリ間の転送速度に引っかかったかとも思いましたが、プロファイラで確認したところメモリ転送負荷になりそうな \u003ccode\u003eAsyncReadManager.Read()\u003c/code\u003e や \u003ccode\u003eNativeList\u0026lt;T\u0026gt;.Add()\u003c/code\u003e の処理時間をはじめ、 \u003cdel\u003eジョブの処理時間全体がプロファイラ上では 1ジョブの状態とほぼ同じ時間でした。しかし\u003ccode\u003eAsyncTextFileReader\u0026lt;T\u0026gt;\u003c/code\u003e 内部の \u003ccode\u003eSystem.Diagnotics.Stopwatch\u003c/code\u003e による処理時間の計測結果、および実時間では一気に動作が遅くなります。\u003c/del\u003e\u003cbr\u003e\n\u003cstrong\u003e小さなファイルで試すとプロファイラの経過時間と実時間が一致しました。1秒を超えるような長時間のジョブはプロファイラ内の経過時間がバグります。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eflushingの有無による変化を下記に示します。(Deep Profile)\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003eflushing なし (MaxJobCount = 1)\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/1a1c205c5ba7f0ff1ef98b0e371c6689ce83aa6c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f313133313233382f63643765613466312d316363352d333538302d373637302d6530393434633338643338612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F1131238%2Fcd7ea4f1-1cc5-3580-7670-e0944c38d38a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=bb3d2141f8e9688c543f6d7ad68f1f7f\" alt=\"NSL_max_job_1.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1131238/cd7ea4f1-1cc5-3580-7670-e0944c38d38a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F1131238%2Fcd7ea4f1-1cc5-3580-7670-e0944c38d38a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=ace969ba94246cdc6471cfed4607e60b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eflushing\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/8f1eca6b3c4884046ab5db9e263dad38757a1392/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f313133313233382f32313630613636642d396362372d306636342d313431352d6632303134653139613032322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F1131238%2F2160a66d-9cb7-0f64-1415-f2014e19a022.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=01a100544fcdeb03a7b5fae2b1b84bad\" alt=\"NSL_flushing_queue.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1131238/2160a66d-9cb7-0f64-1415-f2014e19a022.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F1131238%2F2160a66d-9cb7-0f64-1415-f2014e19a022.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=ca0480f71f746e2d9fce12b67ed4ec04 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eLoadJob を flush している場合の、ParseJob 内の各関数の経過時間は下記の通りです。\u003cbr\u003e\n(数値は 6 Job の総和)\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e0.211 ms\u003c/strong\u003e File.Read() (間に隙間はあるものの合計 1.0 ms 以下)\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e4751.49 ms\u003c/strong\u003e ParseText()\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e704.39 ms\u003c/strong\u003e ParseLinesFromBuffer()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e3684.18 ms\u003c/strong\u003e CharaDataParser.ParseLine()\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e165.25 ms\u003c/strong\u003e ReadOnlyStringEntity.op_Equality()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e348.70 ms\u003c/strong\u003e ReadOnlyStringEntity.Slice()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e904.67 ms\u003c/strong\u003e StringSplitterExt.Split()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e1071.26 ms\u003c/strong\u003e StringParserExt.TryParse()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e329.31 ms\u003c/strong\u003e NativeBase64Decoder.GetBytes()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e552.84 ms\u003c/strong\u003e NativeStringList.Add()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e155.91 ms\u003c/strong\u003e NativeStringList.get_Last\u003c/li\u003e\n\u003cli\u003e(\u003cstrong\u003e156.24 ms\u003c/strong\u003e others)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e35.30 ms\u003c/strong\u003e PostReadProc()\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e一方で  job を1つずつ実行した場合の経過時間の一例は下記のとおりです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e0.035 ms\u003c/strong\u003e File.Read()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e150.33 ms\u003c/strong\u003e ParseText()\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e22.24 ms\u003c/strong\u003e ParseLinesFromBuffer()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e116.83 ms\u003c/strong\u003e CharaDataParser.ParseLine()\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e5.11 ms\u003c/strong\u003e ReadOnlyStringEntity.op_Equality()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e10.82 ms\u003c/strong\u003e ReadOnlyStringEntity.Slice()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e29.93 ms\u003c/strong\u003e StringSplitterExt.Split()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e34.11 ms\u003c/strong\u003e StringParserExt.TryParse()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e8.65 ms\u003c/strong\u003e NativeBase64Decoder.GetBytes()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e17.01 ms\u003c/strong\u003e NativeStringList.Add()\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e4.66 ms\u003c/strong\u003e NativeStringList.get_Last\u003c/li\u003e\n\u003cli\u003e(\u003cstrong\u003e6.54 ms\u003c/strong\u003e others)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e0.013 ms\u003c/strong\u003e PostReadProc()\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eそして各関数の \u003ccode\u003eParseText()\u003c/code\u003e 内の相対実行時間を比較すると下表のようになります。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e関数名\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003et[ms]_1Job\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003eratio_1Job\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003et[ms]_6Job\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003eratio_6Job\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003eslower/Job\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eFile.Read()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.035\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e-\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.211\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e-\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e1.00x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eParseText()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e150.33\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e100.0%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e4751.49\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e100.0%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.27x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eParseLinesFromBuffer()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e22.24\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e14.8%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e704.39\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e14.8%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.29x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eCharaDataParser.ParseLine()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e116.83\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e78%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3684.18\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e77.5%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.26x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eReadOnlyStringEntity.op_Equality()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.11\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.40%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e165.25\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.48%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.39x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eReadOnlyStringEntity.Slice()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e10.82\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.20%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e348.70\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.34%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.37x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eStringSplitterExt.Split()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e29.93\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e19.9%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e904.67\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e19.0%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.04x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eStringParserExt.TryParse()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e34.11\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e22.7%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e1071.26\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e22.5%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.23x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eNativeBase64Decoder.GetBytes()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e8.65\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.75%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e329.31\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.90%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.35x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eNativeStringList.Add()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e17.01\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e11.3%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e552.84\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e11.6%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.42x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eNativeStringList.get_Last\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e4.66\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.10%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e155.91\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.28%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5.58x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003e(others)\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.54\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e4.35%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e156.24\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.29%\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.98x\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003ePostReadProc()\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.013\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e-\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e35.30\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e-\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e452x\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e表右端の \u003ccode\u003eslower/Job\u003c/code\u003e は6Jobの実行時間を1Jobの実行時間で割った後、さらに6で除して Job 1つあたり何倍遅くなったかの比です。\u003cbr\u003e\n不思議なことに関数全体にわたって均等に遅くなっています。\u003c/p\u003e\n\n\u003cp\u003eプロファイラによる観測データの転送でメモリ帯域を食われた可能性も考えましたが、\u003cbr\u003e\nリリースビルドで同じ 4096 サイズに対し、LoadJob 1つの処理時間は\u003c/p\u003e\n\n\u003cp\u003e約 \u003cstrong\u003e6.5 ms\u003c/strong\u003e (@ 1 Job)-\u0026gt; 約 \u003cstrong\u003e80 ms\u003c/strong\u003e (@ 6 Job)\u003c/p\u003e\n\n\u003cp\u003eとむしろ比率的にはよりひどい状態で同様の現象が見られます。\u003c/p\u003e\n\n\u003cp\u003eまた、 \u003ccode\u003ePostReadProc()\u003c/code\u003e はファイル先頭部分に Base64 で埋め込んだ全データのIDのリストを \u003ccode\u003eParseLine()\u003c/code\u003e で実際に解析した \u003ccode\u003eCharaData\u003c/code\u003e のIDと照合して読み込みエラーがないか確認をするのと、 \u003ccode\u003eNativeStringList.Add()\u003c/code\u003e の繰り返しでバッファが伸長し、各 \u003ccode\u003eCharaData\u003c/code\u003e の name の参照先が無効になっているはずなのでその再構築をしています。\u003cbr\u003e\nつまりほぼ計算なしに全データを走査して long の比較とchar配列のコピーをしているだけなので、真にメモリバウンドな処理をするとここまで遅くなるということを示していると考えられます。\u003c/p\u003e\n\n\u003cp\u003e以上から、やはりキャッシュミスとは異なる現象が起きているように思われ、\u003cbr\u003e\n自明並列の部分が並列化でなぜ遅くなるのか私の頭では原因がつかめません……\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eAsyncReadManager\u003c/code\u003e 自体あまり公式 script reference 以外の情報がなく、そもそもアセットバンドル等のひとまとめにしたバイナリデータをロードするのに用意されたAPIで、完全に用途が違うものを変な使い方している、と言われればそれまでですが……\u003cbr\u003e\u003cbr\u003e\nUnityの中の人に聞ければ解決するかもしれませんが、ちょっとそこまでのお金はないのでだれか解決してくれるとすごくたすかります(他力本願)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"参考記事\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E8%A8%98%E4%BA%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考記事\u003c/h1\u003e\n\n\u003cp\u003eQiita:\u003cbr\u003e\n\u003ca href=\"https://qiita.com/mao_/items/8f95bc9dbeb3179ba4b9\"\u003e【Unity】ファイルを非同期で読み込んでアンマネージドメモリに展開できるAsyncReadManagerを試してみた\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/mao_/items/220ccf3b2ef929388036\" id=\"reference-c808051f601980b82aa7\"\u003e【Unity】NativeArrayについての解説及び実装コードを読んでみる\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/mao_/items/fc9b4340b05e7e83c3ff\" id=\"reference-2aa0fe074e221ba0e2e9\"\u003e【Unity】UnsafeUtilityについて纏めてみる\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/mao_/items/876fa56fb42bc5110345\"\u003e【Unity】BurstCompilerをJobSystem以外でも使いたい\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/tatsunoru/items/611d0378086dc5986249\" id=\"reference-9419eeb83046638f899e\"\u003eUnity C# Job Systemに参照型を持ち込む\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/papparapa/items/a692714c47a7c602215e\" id=\"reference-a8c680704a7328fff3c7\"\u003e【Unity】スタックトレースを有効にしてNativeArrayのメモリリークを探す\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/pCYSl5EDgo/items/4b5a5e089eabc8f4387d\" id=\"reference-da9f541362be1f5e9f50\"\u003e【Unity】UnsafeUtility基礎論【入門者向け】\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eBlog:\u003cbr\u003e\n\u003ca href=\"https://helpdesk.unity3d.co.jp/hc/ja/articles/204694010-System-Text-Encoding-%E3%81%A7-Shift-JIS-%E3%82%92%E4%BD%BF%E3%81%84%E3%81%9F%E3%81%84\" rel=\"nofollow noopener\" target=\"_blank\"\u003eSystem.Text.Encoding で Shift JIS を使いたい\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://blog.meilcli.net/2018/06/big-size-structin.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e【C#】Big Size Structが値コピーでつらいならin引数で値コピーしなければいいじゃない！！ ＜ それ本当？\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eOfficial:\u003cbr\u003e\n\u003ca href=\"https://referencesource.microsoft.com/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC# Reference Source\u003c/a\u003e\u003c/p\u003e\n","createdAt":"2021-02-21T05:13:45Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"uWhpCQpSKL1LEda9S89CPAkIDbnWac4hAQ==--lToR17jGmOf3uySc--FIK+BZHZoKAKzyFymvocOg==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-04-26T15:50:55Z","likesCount":16,"linkUrl":"https://qiita.com/kawai125/items/13390f25700dd89c0f2e","organization":null,"originalId":1395658,"stockedCount":15,"title":"[Unity] C# JobSystem を利用してテキストファイルを非同期でパースする","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%88%90%E6%9E%9C%E7%89%A9\"\u003e成果物\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8B%95%E4%BD%9C%E7%92%B0%E5%A2%83\"\u003e動作環境\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%BF%E3%81%84%E6%96%B9\"\u003e使い方\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%AD%E8%BA%AB%E3%81%AE%E3%81%8A%E8%A9%B1-%E3%81%82%E3%82%8B%E3%81%84%E3%81%AF%E5%9B%9B%E8%8B%A6%E5%85%AB%E8%8B%A6%E3%81%AE%E8%A8%98%E9%8C%B2\"\u003e中身のお話 (あるいは四苦八苦の記録)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#asyncreadmanager%E3%82%92nativecontainer%E9%A2%A8%E3%81%AB%E3%83%A9%E3%83%83%E3%83%97%E3%81%97%E3%81%A6%E3%81%8A%E3%81%8F\"\u003e▽AsyncReadManagerをNativeContainer風にラップしておく\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#string-%E4%BD%BF%E7%94%A8%E7%A6%81%E6%AD%A2-%E3%81%97%E3%81%8B%E3%81%97-encoding-%E3%82%84-parse--split-%E3%81%AF%E6%AC%B2%E3%81%97%E3%81%84\"\u003e▽string 使用禁止！ しかし Encoding や Parse() 、 Split() は欲しい……\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#c-string-%E3%81%A8-jobsystem-%E3%81%AE%E7%9B%B8%E5%85%8B\"\u003eC# string と JobSystem の相克\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#encoder-%E3%81%AE%E8%87%AA%E5%8A%9B%E5%AE%9F%E8%A3%85%E3%81%AF%E5%8B%98%E5%BC%81%E3%81%97%E3%81%A6%E3%81%BB%E3%81%97%E3%81%84\"\u003eEncoder の自力実装は勘弁してほしい\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#tryparse-split-strip-%E3%81%AF%E8%87%AA%E5%8A%9B%E5%AE%9F%E8%A3%85\"\u003eTryParse(), Split(), Strip() は自力実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#base64-%E3%81%AE%E5%A4%89%E6%8F%9B%E3%82%82%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%A8%E4%BE%BF%E5%88%A9\"\u003eBase64 の変換もできると便利\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%A9%E3%81%86%E3%81%9B%E3%81%AA%E3%82%89%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%AE%9A%E7%BE%A9%E3%83%87%E3%83%BC%E3%82%BF%E3%82%82-class-%E3%81%AB%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%88%E3%81%B0%E3%81%84%E3%81%84\"\u003e▽どうせならユーザー定義データも class にしてしまえばいい\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%8C%E3%81%99%E3%81%B9%E3%81%A6%E3%82%92%E8%A7%A3%E6%B1%BA%E3%81%99%E3%82%8B\"\u003e▽ポインタがすべてを解決する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%AB%98%E9%80%9F%E5%8C%96\"\u003e高速化\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%85%B1%E6%9C%89%E5%A4%89%E6%95%B0%E3%81%AE%E7%AE%A1%E7%90%86\"\u003e共有変数の管理\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#in-readonly-struct-%E3%81%A7%E9%80%9F%E3%81%8F%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84\"\u003e▽in readonly struct で速くな……らない！\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%96%87%E5%AD%97%E5%88%97%E3%83%87%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E5%87%A6%E7%90%86\"\u003e▽文字列デコードのブロック処理\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%B3%A8%E6%96%87%E3%82%82%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%81%AA%E6%84%9F%E3%81%98%E3%81%A7%E5%8F%97%E3%81%91%E4%BB%98%E3%81%91%E3%81%A6%E3%81%BB%E3%81%97%E3%81%84\"\u003e▽注文も非同期な感じで受け付けてほしい\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A4%A7%E3%81%8D%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AEunload\"\u003e▽大きなデータのUnLoad\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%B2%E9%A1%8C\"\u003e課題\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#burst-%E3%81%A7%E3%82%82%E3%81%A3%E3%81%A8%E9%80%9F%E3%81%8F%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84%E5%AF%BE%E5%BF%9C%E6%B8%88\"\u003e◎Burst でもっと速くならない？(対応済)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#2021425%E7%8F%BE%E8%A1%8C%E7%89%88%E3%81%A7burst%E3%81%AB%E5%AF%BE%E5%BF%9C%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F\"\u003e(2021/4/25)現行版でBurstに対応しました。\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A4%87%E6%95%B0%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%90%8C%E6%99%82%E3%81%AB%E8%AA%AD%E3%81%BE%E3%81%9B%E3%82%8B%E3%81%A8%E9%80%94%E7%AB%AF%E3%81%AB%E9%81%85%E3%81%8F%E3%81%AA%E3%82%8B%E8%A7%A3%E6%B1%BA%E6%B8%88\"\u003e◎複数のファイルを同時に読ませると途端に遅くなる(解決済)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#2021425-split-%E9%96%A2%E6%95%B0%E5%86%85%E3%81%AE-boxing-%E3%82%92%E9%99%A4%E5%8E%BB%E3%81%97%E3%81%9F%E7%8F%BE%E8%A1%8C%E7%89%88%E3%81%A7%E3%81%AF%E8%A7%A3%E6%B6%88%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F\"\u003e(2021/4/25) Split() 関数内の Boxing を除去した現行版では解消しました。\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E8%A8%98%E4%BA%8B\"\u003e参考記事\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":7409,"uuid":"13390f25700dd89c0f2e","banReason":null,"adventCalendarItem":{"day":14,"calendar":{"name":"Unity #3","urlName":"unity3","year":2020,"organization":null}},"author":{"encryptedId":"5xb9/XBSnDw5j1sohviWtKX8SfSFHg==--PeUTlU9oVJd/j9u4--4IAjPCsjbkVro4Y6tYKtdw==","originalId":1131238,"description":"","facebookUrl":null,"githubUrl":"https://github.com/kawai125","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://avatars.githubusercontent.com/u/31260712?v=4","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F31260712%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=8347dd646880d40f7baaf8fe139dec58","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F31260712%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cc4d90d3da39dfe34da7cb961991ce8d","urlName":"kawai125","websiteUrl":null,"twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"},{"name":"JobSystem","urlName":"jobsystem"}],"followingLikers":{"edges":[]},"comments":{"totalCount":2}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
