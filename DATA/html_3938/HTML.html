<!DOCTYPE html><html><head><meta charset="utf-8" /><title>【図解】C#のasync/awaitの内部挙動を理解する - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/mrngsht/items/7d280c9f161f6d9855e2" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="6ohOfhT9s8dGcpFvkcVHK8ASp87RyRxSFaZ/W+/MPpUWM+/sm7x0M+cI0pLW5gNtKaNb0OUDqHJgXz/dOduYgg==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="【図解】C#のasync/awaitの内部挙動を理解する - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRNVp1ejZLZWo0NENSUXlQamdhNWhjM2x1WXk5aGQyRnBkT09CcnVXR2hlbURxT2FNbWVXTGxlT0NrdWVRaHVpbm8tT0JtZU9DaXcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YjcxOTU2NTlhOGI5ZWFhMDczMmRkOGZmYzJlZWFlMWU&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzF5Ym1kemFIUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTU4N2EzY2RhYTRkY2I3NDUxMWY2YTI2YTFhZWNmOTNj&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=f5e33d860164a3421a78b0618d5d657a"><meta property="og:description" content="

はじめに


async/awaitとは？

一言でいうと、本来Begin/Endパターンやコールバック関数を使用して非同期的に書かなければいけない処理を同期的に書ける技術です。
非同期的な書き方と異なり、プログラムで実現しようと..."><meta content="https://qiita.com/mrngsht/items/7d280c9f161f6d9855e2" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,.NET,async,AsyncAwait" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-3f0ceb21-146e-450b-96a6-23ccc7bfe907"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fmrngsht%2Fitems%2F7d280c9f161f6d9855e2">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fmrngsht%2Fitems%2F7d280c9f161f6d9855e2">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-3f0ceb21-146e-450b-96a6-23ccc7bfe907">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-01-31T19:35:55.000+09:00","dateModified":"2019-02-12T21:08:47.000+09:00","headline":"【図解】C#のasync/awaitの内部挙動を理解する","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRNVp1ejZLZWo0NENSUXlQamdhNWhjM2x1WXk5aGQyRnBkT09CcnVXR2hlbURxT2FNbWVXTGxlT0NrdWVRaHVpbm8tT0JtZU9DaXcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YjcxOTU2NTlhOGI5ZWFhMDczMmRkOGZmYzJlZWFlMWU\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzF5Ym1kemFIUSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTU4N2EzY2RhYTRkY2I3NDUxMWY2YTI2YTFhZWNmOTNj\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=f5e33d860164a3421a78b0618d5d657a","mainEntityOfPage":"https://qiita.com/mrngsht/items/7d280c9f161f6d9855e2","author":{"@type":"Person","address":"","email":"mrngsht@gmail.com","identifier":"mrngsht","name":"mrngsht","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F237650%2F59d1f541109393df0bfe9fcf544c6202ad3a7bfa%2Fx_large.png%3F1613990552?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=6a78134350bc36038cd883e8c5e48be3","url":"https://qiita.com/mrngsht","description":"フリーランスのITエンジニアです。世の中いろんな意見があっていいと思います。私も個人的な意見を書いていきます。別の意見があれば優しくコメントいただけると嬉しいです。今の夢は、ROWE・ほぼリモートで働きながら多拠点に居住しながら、日光を浴びて生活することです。zennもはじめました。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mrngsht","type":"items","id":"7d280c9f161f6d9855e2"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mrngsht","type":"items","id":"7d280c9f161f6d9855e2"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mrngsht","type":"items","id":"7d280c9f161f6d9855e2"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/mrngsht/items/7d280c9f161f6d9855e2","location":"/mrngsht/items/7d280c9f161f6d9855e2","scheme":"https","host":"qiita.com","port":null,"pathname":"/mrngsht/items/7d280c9f161f6d9855e2","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"qJhxh/pG2c2XRH8/QVMaV9cEDDruO4L0H3fDJpyzXj1UI9AVdQceOTY+PMIGcF4RPrXwJNrxNtRqjoOgSqT4Kg==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-119b9137-bfc6-41ef-9983-2dc33ed9cb09"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mrngsht/items/7d280c9f161f6d9855e2/likers" class="css-1iupg5d">42</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">41</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/7d280c9f161f6d9855e2/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mrngsht/items/7d280c9f161f6d9855e2/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mrngsht/items/7d280c9f161f6d9855e2/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mrngsht/items/7d280c9f161f6d9855e2/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mrngsht/items/7d280c9f161f6d9855e2.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/mrngsht"><img class="css-100alwu eyfquo10" src="https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/237650/59d1f541109393df0bfe9fcf544c6202ad3a7bfa/x_large.png?1613990552" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/mrngsht" class="css-10ougpm">@<!-- -->mrngsht</a><div class="css-1ay9vb9"><span><meta content="2019-01-31T10:35:55Z"/><time dateTime="2019-02-12T12:08:47Z" class="css-m19uds">updated at 2019-02-12</time></span></div></div></div></div></div><h1 class="css-cgzq40">【図解】C#のasync/awaitの内部挙動を理解する</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/.net" class="css-4czcte">.NET</a><a href="/tags/async" class="css-4czcte">async</a><a href="/tags/asyncawait" class="css-4czcte">AsyncAwait</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h2>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h2>

<h3>
<span id="asyncawaitとは" class="fragment"></span><a href="#asyncawait%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>async/awaitとは？</h3>

<p>一言でいうと、本来Begin/Endパターンやコールバック関数を使用して非同期的に書かなければいけない処理を同期的に書ける技術です。<br>
非同期的な書き方と異なり、プログラムで実現しようとしているロジックを一連の流れで追いやすくなるという意味で活気的な書き方ができ、非常に魅力があります。その一方で、実際の内部挙動、スレッドの使い方は隠蔽されてしまうため、イメージがつかみにくいという面もあると思います。</p>

<h3>
<span id="この記事で書きたいこと" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E6%9B%B8%E3%81%8D%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事で書きたいこと</h3>

<p>ある程度async/awaitの書き方を知っている方向けに、内部的な動きを深堀りしてみたいと思います。</p>

<h2>
<span id="本題" class="fragment"></span><a href="#%E6%9C%AC%E9%A1%8C"><i class="fa fa-link"></i></a>本題</h2>

<h2>
<span id="ソースコードサンプルを見てみる" class="fragment"></span><a href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%92%E8%A6%8B%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>ソースコードサンプルを見てみる</h2>

<p>早速ですが。<br>
まず、サンプルとしてasync/awaitを使って記述したものがこちら。<br>
（処理内容の意味は皆無です。ただ前処理の結果を受けて連続呼び出しをしたかっただけです。）</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SampleClass</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">SampleMethodAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">filepath1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">filepath2</span> <span class="p">=</span> <span class="k">await</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllTextAsync</span><span class="p">(</span><span class="n">filepath1</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">await</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllBytesAsync</span><span class="p">(</span><span class="n">filepath2</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">bytes</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これを、async/awaitを使わずに書いてみるとこうなります<sup id="fnref1"><a href="#fn1" title="このコードは実際にコンパイラが出力するものとは異なります。できるだけ本物に忠実に書いてみましたが、（だから長いのですが）、何箇所かは解説用に修正しています。実際にコンパイラが出力するコードを見てみたい場合は、ILSpyというツールを使って見ることができます（Visual Studioの拡張機能にもあります）。ILSpyを使うと、C#をビルドした結果のMSILから逆コンパイルしたC#を見ることができます。そのC#のバージョンをasync/awaitのないC# 4.0まで下げてやれば、上のようなコードを見ることができると思います。">1</a></sup>。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SampleClass</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">SampleMethodAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">filepath1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">stateMachine</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SampleMethodAsyncStateMachine</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_arg_filepath1</span> <span class="p">=</span> <span class="n">filepath1</span><span class="p">,</span>
            <span class="n">_state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">stateMachine</span><span class="p">.</span><span class="n">_tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">SampleMethodAsyncStateMachine</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">_state</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">_arg_filepath1</span><span class="p">;</span>
        <span class="k">public</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">_tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>

        <span class="k">private</span> <span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_awaiter1</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">TaskAwaiter</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[</span><span class="k">]&gt;</span> <span class="n">_awaiter2</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">MoveNext</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">label_state0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">label_state1</span><span class="p">;</span>

                <span class="n">_awaiter1</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllTextAsync</span><span class="p">(</span><span class="n">_arg_filepath1</span><span class="p">).</span><span class="nf">GetAwaiter</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">_awaiter1</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_state</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                    <span class="n">_awaiter1</span><span class="p">.</span><span class="nf">OnCompleted</span><span class="p">(</span><span class="n">MoveNext</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">label_state0</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">awaiterResult1</span> <span class="p">=</span> <span class="n">_awaiter1</span><span class="p">.</span><span class="nf">GetResult</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">filepath2</span> <span class="p">=</span> <span class="n">awaiterResult1</span><span class="p">;</span>
                <span class="n">_awaiter2</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllBytesAsync</span><span class="p">(</span><span class="n">filepath2</span><span class="p">).</span><span class="nf">GetAwaiter</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">_awaiter2</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_state</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
                    <span class="n">_awaiter1</span><span class="p">.</span><span class="nf">OnCompleted</span><span class="p">(</span><span class="n">MoveNext</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">label_state1</span><span class="p">:</span>
                <span class="kt">var</span> <span class="n">awaiterResult2</span> <span class="p">=</span> <span class="n">_awaiter2</span><span class="p">.</span><span class="nf">GetResult</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">awaiterResult2</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
                <span class="n">_state</span> <span class="p">=</span> <span class="p">-</span><span class="m">2</span><span class="p">;</span>
                <span class="n">_tcs</span><span class="p">.</span><span class="nf">SetResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_state</span> <span class="p">=</span> <span class="p">-</span><span class="m">2</span><span class="p">;</span>
                <span class="n">_tcs</span><span class="p">.</span><span class="nf">SetException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>いかがでしょうか？<br>
まずは詳細に使用しているクラスやメソッドの意味を追求する必要はないです。<br>
是非、クラス名やメソッド名の英語から感じ取れる範囲で眺めてみてください。</p>

<p>ざっと説明してみると下記のようなイメージでしょうか。</p>

<ul>
<li>awaitする処理がIsCompletedでない場合（同期的に完了しない場合）

<ul>
<li>awaitする処理の完了時点で発火するイベントハンドラとしてMoveNext(自身のメソッド)を登録して、</li>
<li>今のstateをフィールドに保存して、</li>
<li>即時returnする。</li>
<li>その後、awaitする処理が完了した場合、</li>
<li>完了イベントが発火して、イベントハンドラ経由でMoveNextが、</li>
<li>前回保存したstateで実行される</li>
</ul>
</li>
<li>awaitする処理がIsCompletedである場合（同期的に完了した場合）

<ul>
<li>次のstateへ処理を進める</li>
</ul>
</li>
</ul>

<p>ポイントは、IsCompletedじゃなかった場合に即時returnしてしまうところ、です。私はこれでやっとawaitの動きがわかった気になれました。</p>

<h2>
<span id="asyncawaitは状態遷移機械を作る" class="fragment"></span><a href="#asyncawait%E3%81%AF%E7%8A%B6%E6%85%8B%E9%81%B7%E7%A7%BB%E6%A9%9F%E6%A2%B0%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>async/awaitは状態遷移機械を作る</h2>

<p>上記で見たことをまとめると、async/awaitは状態遷移機械を作ります。<br>
（コンパイラが吐くコードからもStateMachine等のキーワードが見て取れます）</p>

<p><a href="https://camo.qiitausercontent.com/ca3bc1481ef391b11009ccf5ab01ebf0fc32983a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f35626662376439622d346465382d633936342d353465322d3464613033373235363439322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F5bfb7d9b-4de8-c964-54e2-4da037256492.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=810b3cd8eabec61047f67b746c64fdb5" alt="statemachine.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/237650/5bfb7d9b-4de8-c964-54e2-4da037256492.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F5bfb7d9b-4de8-c964-54e2-4da037256492.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=9060e3f520d7e56c8129e0d72783dff8 1x" loading="lazy"></a></p>

<p>awaitの個数に比例して状態が作られます。<br>
このように進捗を記録することで、制御上は一旦returnしても、途中の状態から処理を再開できます。<br>
このようにすることで、実際には非同期的に実行している処理も、プログラム上は同期的に見せかけることができるのです。</p>

<h2>
<span id="awaitの動きをシーケンスで俯瞰する" class="fragment"></span><a href="#await%E3%81%AE%E5%8B%95%E3%81%8D%E3%82%92%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9%E3%81%A7%E4%BF%AF%E7%9E%B0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>awaitの動きをシーケンスで俯瞰する</h2>

<p>1個のメソッド内の動きはだいたい上の部分で把握できたと思います。<br>
awaitをした処理の呼び出し先を考えてみましょう。<br>
何らかの処理をawaitをしているかもしれません。<br>
もしそうだとしたら、その何らかの処理のその呼び出し先は？<br>
さらにその先は？その果てには何が待っているでしょう？</p>

<p>次のどれかになるはずです。</p>

<ul>
<li>OSに依頼するI/O処理<sup id="fnref2"><a href="#fn2" title="例えばキー入力を取得したり、ネットワークからデータを送受信したりする場合等。先ほどのサンプルコードで扱ったファイル処理もこれです。ライブラリを使っていて一番よく出くわすのはこれだと思います。">2</a></sup>
</li>
<li>明示的に他のスレッドを使って並列化した処理</li>
<li>単なる普通の同期的な処理</li>
</ul>

<p>まず前者2つを見てみます。これらは性質の全く異なるものですが、</p>

<ul>
<li>自分のスレッド以外の他スレッドに処理を依頼する</li>
<li>他スレッドの処理の完了を検知できる（完了イベントで発火するイベントハンドラを登録できる）</li>
</ul>

<p>という部分は共通項として括ることができそうです（ここでは強引に括ります）。<br><br>
この場合、呼び出し関係のシーケンスは下のようになります<sup id="fnref3"><a href="#fn3" title="とても単純化しています。具体的には呼び出し先の全てのメソッドでawaitは1回しかしていないものと仮定しています。">3</a></sup>。  </p>

<p><a href="https://camo.qiitausercontent.com/bd86f0906e8243e5cb2473d80dae898b1069516c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f30383366616633372d643731382d616266302d663532342d6565326266653235363336632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F083faf37-d718-abf0-f524-ee2bfe25636c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=07b169b4320035ce7363a44f38744fd8" alt="basic.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/237650/083faf37-d718-abf0-f524-ee2bfe25636c.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F083faf37-d718-abf0-f524-ee2bfe25636c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=bec0bd08fc5f8bd9ef0d6197db9d46b9 1x" loading="lazy"></a></p>

<p>色が付いた角が丸い囲いは、囲いの中の処理はすべて同じスレッドで処理されることを示しています。<br>
また、囲い同士はそれぞれ異なるスレッドとなる可能性があります。<br>
（実際に、どういう風にスレッドが選択されるかについては次の節で説明しようと思います）</p>

<p>最後に「単なる普通の同期的な処理」です。これは意外と見落としがちかもしれませんが、</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="kt">string</span> <span class="n">cache</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetCachedData</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">cache</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">cache</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">GetDataAsync</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">cache</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>みたいなメソッドがをあった時、2回目以降のアクセスでcacheがnullでない場合などはこれに当てはまります。</p>

<p>この場合、awaitの内部挙動で言うところのIsCompletedがtrueで評価されるパターンとなり、即座に同じスレッドで後続処理が続行されます。結果的に、最初から最後まで同じスレッドで、同期的に実行されることになります。</p>

<p>同様にシーケンスで示すと以下のようになります。</p>

<p><a href="https://camo.qiitausercontent.com/a1fb685671a3516ab71f56f449f3562e9a169cf9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f34333132383639652d656632322d376636362d393164612d3161316466623736346534382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F4312869e-ef22-7f66-91da-1a1dfb764e48.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c85c94f6f2ab3eca51107acee3bf79ab" alt="sync.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/237650/4312869e-ef22-7f66-91da-1a1dfb764e48.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F4312869e-ef22-7f66-91da-1a1dfb764e48.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3c94f39d69faf2505d17ced62ee892da 1x" loading="lazy"></a></p>

<p>また、最後に参考として、asyncメソッドをawaitではなくWait()またはResultを使用して同期的に待ってみた場合、どのようなシーケンスになるかを見てみましょう。</p>

<p><a href="https://camo.qiitausercontent.com/3cecb78585cdaf17ca112dac3fc157ffd1a1eac0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f62666432396630342d636236632d626334312d646233652d3566666564363634616662632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Fbfd29f04-cb6c-bc41-db3e-5ffed664afbc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=388f2710d4600407941f89fdf8e2ba14" alt="block-non-gui.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/237650/bfd29f04-cb6c-bc41-db3e-5ffed664afbc.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Fbfd29f04-cb6c-bc41-db3e-5ffed664afbc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=73135a322a089fdf609979b8b1880788 1x" loading="lazy"></a></p>

<p>このように呼び出し元を実行していたスレッドが最後まで使用され続けます。<br>
待っている間はスレッドがブロックされている状態となり、</p>

<ul>
<li>この間はこのスレッドがスレッドプールに戻れなくなり（他の作業に活用することができない）</li>
<li>それによって他のスレッドが作られやすくなり（スレッドを作ることにコストがかかる）</li>
<li>さらにスレッドが増えることによりコンテキストスイッチのコストも増える可能性があります</li>
</ul>

<p>asyncメソッドはできるだけawaitするほうがよいといえるでしょう。</p>

<h2>
<span id="awaitする前後で使用されるスレッドの関係" class="fragment"></span><a href="#await%E3%81%99%E3%82%8B%E5%89%8D%E5%BE%8C%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%95%E3%82%8C%E3%82%8B%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E9%96%A2%E4%BF%82"><i class="fa fa-link"></i></a>awaitする前後で使用されるスレッドの関係</h2>

<p>もう一度、最初のシーケンスを見てみましょう。</p>

<p><a href="https://camo.qiitausercontent.com/bd86f0906e8243e5cb2473d80dae898b1069516c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f30383366616633372d643731382d616266302d663532342d6565326266653235363336632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F083faf37-d718-abf0-f524-ee2bfe25636c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=07b169b4320035ce7363a44f38744fd8" alt="basic.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/237650/083faf37-d718-abf0-f524-ee2bfe25636c.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F083faf37-d718-abf0-f524-ee2bfe25636c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=bec0bd08fc5f8bd9ef0d6197db9d46b9 1x" loading="lazy"></a></p>

<p>この色が異なる角が丸い囲いは、囲いの中の処理はすべて同じスレッドで処理されることを示していて、また、囲い同士はそれぞれ異なるスレッドとなる可能性がある、ということでした。</p>

<p>ここでは、これらのスレッドの関係がどのようになるか見ていきます。<br><br>
おおまかに言えば、次のようになります<sup id="fnref4"><a href="#fn4" title="厳密にはSynchronizationContextを使って判定されます。">4</a></sup>。</p>

<ul>
<li>「前のスレッド」がGUIスレッドである場合は、「後のスレッド」もGUIスレッドとなる。</li>
<li>「前のスレッド」がGUIスレッドでない場合は、スレッドプールから渡されるスレッドが「後のスレッド」となる。</li>
</ul>

<p>GUIスレッドは、WindowsFormやWPFなどのクライアントアプリケーションで特別扱いされるスレッドです。ユーザからの入力を受け取ったり、画面に表示しているUI部品を更新したりするのはこのGUIスレッドしか行うことができません。</p>

<p>GUIスレッドで時間のかかる処理をしてしまった場合、その間ユーザの入力を受け付けることができないため、ユーザエクスペリエンスはとても悪いものになります。そのため、このようなクライアントアプリケーションで非同期処理を扱うことは非常に重要となります。</p>

<p>また、UI部品を更新できるのはGUIスレッドのみであるため、他のスレッドからUI部品を直接更新しようとしても、実際に更新することはできません。<br>
それでは時間のかかる処理の結果を、ユーザエクスペリエンスを損なうことなく画面に反映するためにはどうすればよいのか、ということになります。<br>
そこで、これらのアプリケーションではSynchronizationContextという仕組みを使うことにより、どのスレッドからでもGUIスレッドに作業を依頼できるようになっています。</p>

<p>そしてこのSynchronizationContextの仕組みを表からは見えない形で利用しているのがawaitなのです。冒頭に書いたように、awaitの前の処理を実行するスレッドがGUIスレッドである場合は、awaitの処理が完了した後の後続処理を実行するスレッドもGUIスレッドとなるように、awaitが取り計らってくれるのです。これにより、クライアントアプリケーションの開発者はSynchronizationContextを意識せずとも、awaitした処理の結果を使って画面を更新することができます。ほぼ同期処理を同じ書き方で、時間のかかる処理を非同期で実行し、その結果を画面に反映させることができるのです。次のようなイメージです。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">button1_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">GetResultAsync</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="n">Label</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>このことを踏まえて、先ほどの図を眺めてみましょう。内容に合わせて少し色を変えています。</p>

<p><a href="https://camo.qiitausercontent.com/3b89d851162c53103c2833c1404de623a5d34fef/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f66363365643134382d306631312d333035322d316130642d6239343833316437303363632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Ff63ed148-0f11-3052-1a0d-b94831d703cc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8a7f8c23131eb7f120daa26efb57064b" alt="gui-basic.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/237650/f63ed148-0f11-3052-1a0d-b94831d703cc.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Ff63ed148-0f11-3052-1a0d-b94831d703cc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=c47be869493f86bce402d94b24e2f235 1x" loading="lazy"></a></p>

<p>呼び出し元のスレッドがGUIスレッドであるとします。そうするとawait前の処理を全てGUIスレッドが実行することになります。そのあと、呼び出し先の末端まで進んで、IsCompletedでないことを確認して戻ってきて、呼び出し元まで戻ってきたとします。<br>
そうするとGUIスレッドは現時点で処理することがなくなり、ユーザからの入力を待機する状態となります。<br>
その後、呼び出し先の末端部分の時間のかかる処理が完了した後、各Asyncメソッドの後続処理が実行されていきますが、そのとき使用されるスレッドが全てGUIスレッドとなります。</p>

<p>結果として、呼び出し先の末端部分以外はすべてGUIスレッドで実行されますが、同期的にWait()またはResultを呼んだ場合と異なり、呼び出し先の末端が処理をしている間はGUIスレッドは、他の作業ができる状態となっています。</p>

<p>かなり、前者の「前のスレッド」がGUIスレッドである場合の話が長くなってしまいました。<br>
後者の「前のスレッド」がGUIスレッドでない場合は、awaitした処理が完了した時点で、後続の作業がスレッドプールのキューに入り、順次スレッドプールのスレッドに処理されていきます。<br>
そのため、先ほどのGUIのスレッドと異なり、awaitの後の処理は、全て異なるスレッドで処理される可能性があります。</p>

<h2>
<span id="デッドロックとconfigureawait" class="fragment"></span><a href="#%E3%83%87%E3%83%83%E3%83%89%E3%83%AD%E3%83%83%E3%82%AF%E3%81%A8configureawait"><i class="fa fa-link"></i></a>デッドロックとConfigureAwait</h2>

<p>上の節で、awaitの前がGUIスレッドであった場合、awaitの後もGUIスレッドになり、そのおかげでUI部品の更新が可能になっている、という話をしました。この話には裏があります。</p>

<p>負の側面として、デッドロックを引き起こす原因となりうる、というものがあります。<br>
具体例を見てみましょう。GUIスレッド上で実行している呼び出し元のメソッドが、AsyncメソッドをawaitではなくWait()またはResultで同期的に待つことにしたとしましょう。</p>

<p>呼び出し先の末端部分が長時間の処理を行っている間、GUIスレッドは呼び出し元のWait()またはResultでブロックされた状態となっています。</p>

<p>呼び出し先の末端部分の処理が完了したとします。<br>
この完了を起点として、末端部分を直接呼び出したAsyncメソッドの後続処理が実行されます。どのスレッドで実行しようとするかというと、上の節の内容からするとGUIスレッドでしたね。</p>

<ul>
<li>GUIスレッドは呼び出し元が呼んだAsyncメソッドの完了を待っている</li>
<li>末端部分を直接呼んだAsyncメソッドはGUIスレッドが空くのを待っている</li>
</ul>

<p>これだけでデッドロックが発生してしまいます。怖いですね。<br>
しつこいですが、また例のシーケンス図を載せておきます。</p>

<p><a href="https://camo.qiitausercontent.com/1f1851e1851f27e32616d0ede13691003120e91c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f31626334663932612d646665652d363631612d616162342d3136336131343330313937652e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F1bc4f92a-dfee-661a-aab4-163a1430197e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7c113618a9d3d444c92adafcb0290a98" alt="block-deadlock.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/237650/1bc4f92a-dfee-661a-aab4-163a1430197e.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F1bc4f92a-dfee-661a-aab4-163a1430197e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=47533d905ce19d7e39f6b073253b39b4 1x" loading="lazy"></a></p>

<p>このデッドロックを回避するためにはどうすればよいでしょうか。一つには、呼び出し元がWait()やResultをできるだけ使わないようにして、できるだけawaitで待つということが挙げられます。ユーザエクスペリエンスを損なわないためにもこれがベターな回避策です。</p>

<p>ですが、とはいっても、何らかの理由で同期的に待たなければいけない可能性を排除できません。また、Asyncメソッドをpublicとして公開したいライブラリの開発者の立場に立つと、同期的に待つだけで簡単にデッドロックしてしまうような機能を公開したくはないですよね。</p>

<p>そこで、 <code>ConfigureAwait(bool continueOnCapturedContext)</code> というTaskクラスのメソッドを使って、Asyncメソッドの作成者側からこの問題を回避することができます。次のように使います。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">GetResultAsync</span><span class="p">().</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</code></pre></div></div>

<p>引数にtrueを渡すとConfigureAwaitを使わなかった場合と同じ挙動になり、falseを渡すと異なる挙動となります。どのような挙動になるかというと、awaitの後の処理がGUIスレッドではなく、スレッドプールから渡されるスレッドによて実行されるようになります。これにより、デッドロックを回避することができます。後続処理がGUIスレッドを必要としない場合や、ライブラリを開発する場合にはConfigureAwait(false)を付けるようにしておくとよいでしょう。</p>

<p>また、例によってシーケンス図で確認しておきます。</p>

<p><a href="https://camo.qiitausercontent.com/7655874f251cce50cd10dc07384aca04adb942b4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f65653064663937392d666237612d636334622d653036382d3536656239376636393363392e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Fee0df979-fb7a-cc4b-e068-56eb97f693c9.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e1bae09dcbf346bd754eb629983caf23" alt="block-gui-configure.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/237650/ee0df979-fb7a-cc4b-e068-56eb97f693c9.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Fee0df979-fb7a-cc4b-e068-56eb97f693c9.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=13cfdb9750c2ae65f05cae1cc255cd2c 1x" loading="lazy"></a></p>

<p>ConfigureAwai(false)をつけることによって、GUIスレッドではなくスレッドプールのスレッドを使うようになったため、デッドロックを起こさず最後まで処理を完遂することができました。注意としては、全てのawaitの箇所でConfigureAwait(false)を呼び出さないとデッドロックに陥ってしまうということです。awaitの前の処理を全てGUIスレッドで実行しているので、全てのawaitの後の処理は何もしなければ全てGUIスレッドに戻ろうとしてしまいます。</p>

<p>また、呼び出し元がWait()やResultを使用せずにawaitを使用した場合は、ConfigureAwait(false)をつけることでGUIスレッドの占有時間を減らすことができます。</p>

<p><a href="https://camo.qiitausercontent.com/7f837e6b06baa2b6fa2f31f85d4172462b746c51/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f38646538326136382d646635322d346365642d353330392d3866333832363465373066652e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F8de82a68-df52-4ced-5309-8f38264e70fe.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=861df856924dfd36090f8b0b96fd0a2f" alt="gui-configure.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/237650/8de82a68-df52-4ced-5309-8f38264e70fe.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F8de82a68-df52-4ced-5309-8f38264e70fe.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8fe0654e6697948358376180e287084b 1x" loading="lazy"></a></p>

<p>この図では青い囲いの部分のみがGUIスレッドとなっています。<br>
このように、呼び出し元メソッドの後続処理以外はGUIスレッドでない別のスレッドで処理させることができます。その結果、別のスレッドで処理している間はGUIスレッドは別の作業を待機することができることになります。</p>

<p>ただ、勢い余ってUI部品を更新したい場合にまで <code>ConfigureAwait(false)</code> をしないように注意してくださいね。この場合は逆にGUIスレッドを使わないと反映できなくなってしまいます。</p>

<h2>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h2>

<p>最後まで読んでいただき、ありがとうございました！<br>
うっかりとても長くなってしまいました。。。</p>

<p>いざ書き始めてみると自分自身もわかっていないことが多くあり、調べたり勉強したりしながらなんとか書き終えました。まだ理解が足りず曖昧になってしまっている部分もあったりするかと思います。学びながら追記、または新記事を書くなどしてみようと思います！<br>
あと、もっと書くこと整理しなければ、、ですね。</p>

<p>もし誤りやよくない記述、改善コメントがありましたら、是非コメントお願いいたします！</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>このコードは実際にコンパイラが出力するものとは異なります。できるだけ本物に忠実に書いてみましたが、（だから長いのですが）、何箇所かは解説用に修正しています。実際にコンパイラが出力するコードを見てみたい場合は、ILSpyというツールを使って見ることができます（Visual Studioの拡張機能にもあります）。ILSpyを使うと、C#をビルドした結果のMSILから逆コンパイルしたC#を見ることができます。そのC#のバージョンをasync/awaitのないC# 4.0まで下げてやれば、上のようなコードを見ることができると思います。 <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p>例えばキー入力を取得したり、ネットワークからデータを送受信したりする場合等。先ほどのサンプルコードで扱ったファイル処理もこれです。ライブラリを使っていて一番よく出くわすのはこれだと思います。 <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p>とても単純化しています。具体的には呼び出し先の全てのメソッドでawaitは1回しかしていないものと仮定しています。 <a href="#fnref3">↩</a></p>
</li>

<li id="fn4">
<p>厳密にはSynchronizationContextを使って判定されます。 <a href="#fnref4">↩</a></p>
</li>

</ol>
</div>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fmrngsht%2Fitems%2F7d280c9f161f6d9855e2&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fmrngsht%2Fitems%2F7d280c9f161f6d9855e2&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mrngsht/items/7d280c9f161f6d9855e2/likers" class="css-1iupg5d">42</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">41</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/7d280c9f161f6d9855e2/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mrngsht/items/7d280c9f161f6d9855e2/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mrngsht/items/7d280c9f161f6d9855e2/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mrngsht/items/7d280c9f161f6d9855e2/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mrngsht/items/7d280c9f161f6d9855e2.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-119b9137-bfc6-41ef-9983-2dc33ed9cb09">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-9d922138-20e7-42b6-bd3d-bb89e4117540"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-9d922138-20e7-42b6-bd3d-bb89e4117540">{}</script>
      
<div id="LoginModal-react-component-3e7ebeff-6c03-4c87-966c-c4eaa2550764"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-3e7ebeff-6c03-4c87-966c-c4eaa2550764">{}</script>
      
<div id="StockModal-react-component-9659b061-e4a7-4890-8809-5108efdb27aa"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-9659b061-e4a7-4890-8809-5108efdb27aa">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;GAlDEfe5XfeMpAS44LL99VImm1/4M6jBBHFHAdum6/XksuKDePiaAy3eR0Wnkbmzu5dnQcz5HOFxiAeHDbFN4g==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch2\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"asyncawaitとは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#asyncawait%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003easync/awaitとは？\u003c/h3\u003e\n\n\u003cp\u003e一言でいうと、本来Begin/Endパターンやコールバック関数を使用して非同期的に書かなければいけない処理を同期的に書ける技術です。\u003cbr\u003e\n非同期的な書き方と異なり、プログラムで実現しようとしているロジックを一連の流れで追いやすくなるという意味で活気的な書き方ができ、非常に魅力があります。その一方で、実際の内部挙動、スレッドの使い方は隠蔽されてしまうため、イメージがつかみにくいという面もあると思います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"この記事で書きたいこと\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E6%9B%B8%E3%81%8D%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこの記事で書きたいこと\u003c/h3\u003e\n\n\u003cp\u003eある程度async/awaitの書き方を知っている方向けに、内部的な動きを深堀りしてみたいと思います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"本題\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%AC%E9%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e本題\u003c/h2\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ソースコードサンプルを見てみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%92%E8%A6%8B%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eソースコードサンプルを見てみる\u003c/h2\u003e\n\n\u003cp\u003e早速ですが。\u003cbr\u003e\nまず、サンプルとしてasync/awaitを使って記述したものがこちら。\u003cbr\u003e\n（処理内容の意味は皆無です。ただ前処理の結果を受けて連続呼び出しをしたかっただけです。）\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSampleClass\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eSampleMethodAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003efilepath1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efilepath2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAllTextAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efilepath1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAllBytesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efilepath2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれを、async/awaitを使わずに書いてみるとこうなります\u003csup id=\"fnref1\"\u003e\u003ca href=\"#fn1\" title=\"このコードは実際にコンパイラが出力するものとは異なります。できるだけ本物に忠実に書いてみましたが、（だから長いのですが）、何箇所かは解説用に修正しています。実際にコンパイラが出力するコードを見てみたい場合は、ILSpyというツールを使って見ることができます（Visual Studioの拡張機能にもあります）。ILSpyを使うと、C#をビルドした結果のMSILから逆コンパイルしたC#を見ることができます。そのC#のバージョンをasync/awaitのないC# 4.0まで下げてやれば、上のようなコードを見ることができると思います。\"\u003e1\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSampleClass\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eSampleMethodAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003efilepath1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSampleMethodAsyncStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_arg_filepath1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efilepath1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_tcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSampleMethodAsyncStateMachine\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_arg_filepath1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskCompletionSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_tcs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskCompletionSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskAwaiter\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_awaiter1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskAwaiter\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"k\"\u003e]\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_awaiter2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003egoto\u003c/span\u003e \u003cspan class=\"n\"\u003elabel_state0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003egoto\u003c/span\u003e \u003cspan class=\"n\"\u003elabel_state1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003e_awaiter1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAllTextAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_arg_filepath1\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAwaiter\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003e_awaiter1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_awaiter1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003elabel_state0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eawaiterResult1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_awaiter1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetResult\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efilepath2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eawaiterResult1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_awaiter2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAllBytesAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efilepath2\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAwaiter\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003e_awaiter2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_awaiter1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnCompleted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003elabel_state1\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eawaiterResult2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_awaiter2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetResult\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eawaiterResult2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_tcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_tcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eいかがでしょうか？\u003cbr\u003e\nまずは詳細に使用しているクラスやメソッドの意味を追求する必要はないです。\u003cbr\u003e\n是非、クラス名やメソッド名の英語から感じ取れる範囲で眺めてみてください。\u003c/p\u003e\n\n\u003cp\u003eざっと説明してみると下記のようなイメージでしょうか。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eawaitする処理がIsCompletedでない場合（同期的に完了しない場合）\n\n\u003cul\u003e\n\u003cli\u003eawaitする処理の完了時点で発火するイベントハンドラとしてMoveNext(自身のメソッド)を登録して、\u003c/li\u003e\n\u003cli\u003e今のstateをフィールドに保存して、\u003c/li\u003e\n\u003cli\u003e即時returnする。\u003c/li\u003e\n\u003cli\u003eその後、awaitする処理が完了した場合、\u003c/li\u003e\n\u003cli\u003e完了イベントが発火して、イベントハンドラ経由でMoveNextが、\u003c/li\u003e\n\u003cli\u003e前回保存したstateで実行される\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eawaitする処理がIsCompletedである場合（同期的に完了した場合）\n\n\u003cul\u003e\n\u003cli\u003e次のstateへ処理を進める\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eポイントは、IsCompletedじゃなかった場合に即時returnしてしまうところ、です。私はこれでやっとawaitの動きがわかった気になれました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"asyncawaitは状態遷移機械を作る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#asyncawait%E3%81%AF%E7%8A%B6%E6%85%8B%E9%81%B7%E7%A7%BB%E6%A9%9F%E6%A2%B0%E3%82%92%E4%BD%9C%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003easync/awaitは状態遷移機械を作る\u003c/h2\u003e\n\n\u003cp\u003e上記で見たことをまとめると、async/awaitは状態遷移機械を作ります。\u003cbr\u003e\n（コンパイラが吐くコードからもStateMachine等のキーワードが見て取れます）\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ca3bc1481ef391b11009ccf5ab01ebf0fc32983a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f35626662376439622d346465382d633936342d353465322d3464613033373235363439322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F5bfb7d9b-4de8-c964-54e2-4da037256492.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=810b3cd8eabec61047f67b746c64fdb5\" alt=\"statemachine.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/237650/5bfb7d9b-4de8-c964-54e2-4da037256492.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F5bfb7d9b-4de8-c964-54e2-4da037256492.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=9060e3f520d7e56c8129e0d72783dff8 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eawaitの個数に比例して状態が作られます。\u003cbr\u003e\nこのように進捗を記録することで、制御上は一旦returnしても、途中の状態から処理を再開できます。\u003cbr\u003e\nこのようにすることで、実際には非同期的に実行している処理も、プログラム上は同期的に見せかけることができるのです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"awaitの動きをシーケンスで俯瞰する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#await%E3%81%AE%E5%8B%95%E3%81%8D%E3%82%92%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9%E3%81%A7%E4%BF%AF%E7%9E%B0%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eawaitの動きをシーケンスで俯瞰する\u003c/h2\u003e\n\n\u003cp\u003e1個のメソッド内の動きはだいたい上の部分で把握できたと思います。\u003cbr\u003e\nawaitをした処理の呼び出し先を考えてみましょう。\u003cbr\u003e\n何らかの処理をawaitをしているかもしれません。\u003cbr\u003e\nもしそうだとしたら、その何らかの処理のその呼び出し先は？\u003cbr\u003e\nさらにその先は？その果てには何が待っているでしょう？\u003c/p\u003e\n\n\u003cp\u003e次のどれかになるはずです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eOSに依頼するI/O処理\u003csup id=\"fnref2\"\u003e\u003ca href=\"#fn2\" title=\"例えばキー入力を取得したり、ネットワークからデータを送受信したりする場合等。先ほどのサンプルコードで扱ったファイル処理もこれです。ライブラリを使っていて一番よく出くわすのはこれだと思います。\"\u003e2\u003c/a\u003e\u003c/sup\u003e\n\u003c/li\u003e\n\u003cli\u003e明示的に他のスレッドを使って並列化した処理\u003c/li\u003e\n\u003cli\u003e単なる普通の同期的な処理\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eまず前者2つを見てみます。これらは性質の全く異なるものですが、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e自分のスレッド以外の他スレッドに処理を依頼する\u003c/li\u003e\n\u003cli\u003e他スレッドの処理の完了を検知できる（完了イベントで発火するイベントハンドラを登録できる）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eという部分は共通項として括ることができそうです（ここでは強引に括ります）。\u003cbr\u003e\u003cbr\u003e\nこの場合、呼び出し関係のシーケンスは下のようになります\u003csup id=\"fnref3\"\u003e\u003ca href=\"#fn3\" title=\"とても単純化しています。具体的には呼び出し先の全てのメソッドでawaitは1回しかしていないものと仮定しています。\"\u003e3\u003c/a\u003e\u003c/sup\u003e。  \u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/bd86f0906e8243e5cb2473d80dae898b1069516c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f30383366616633372d643731382d616266302d663532342d6565326266653235363336632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F083faf37-d718-abf0-f524-ee2bfe25636c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=07b169b4320035ce7363a44f38744fd8\" alt=\"basic.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/237650/083faf37-d718-abf0-f524-ee2bfe25636c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F083faf37-d718-abf0-f524-ee2bfe25636c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=bec0bd08fc5f8bd9ef0d6197db9d46b9 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e色が付いた角が丸い囲いは、囲いの中の処理はすべて同じスレッドで処理されることを示しています。\u003cbr\u003e\nまた、囲い同士はそれぞれ異なるスレッドとなる可能性があります。\u003cbr\u003e\n（実際に、どういう風にスレッドが選択されるかについては次の節で説明しようと思います）\u003c/p\u003e\n\n\u003cp\u003e最後に「単なる普通の同期的な処理」です。これは意外と見落としがちかもしれませんが、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecache\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetCachedData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecache\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n       \u003cspan class=\"n\"\u003ecache\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetDataAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n   \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n   \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ecache\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eみたいなメソッドがをあった時、2回目以降のアクセスでcacheがnullでない場合などはこれに当てはまります。\u003c/p\u003e\n\n\u003cp\u003eこの場合、awaitの内部挙動で言うところのIsCompletedがtrueで評価されるパターンとなり、即座に同じスレッドで後続処理が続行されます。結果的に、最初から最後まで同じスレッドで、同期的に実行されることになります。\u003c/p\u003e\n\n\u003cp\u003e同様にシーケンスで示すと以下のようになります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/a1fb685671a3516ab71f56f449f3562e9a169cf9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f34333132383639652d656632322d376636362d393164612d3161316466623736346534382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F4312869e-ef22-7f66-91da-1a1dfb764e48.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c85c94f6f2ab3eca51107acee3bf79ab\" alt=\"sync.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/237650/4312869e-ef22-7f66-91da-1a1dfb764e48.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F4312869e-ef22-7f66-91da-1a1dfb764e48.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=3c94f39d69faf2505d17ced62ee892da 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eまた、最後に参考として、asyncメソッドをawaitではなくWait()またはResultを使用して同期的に待ってみた場合、どのようなシーケンスになるかを見てみましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/3cecb78585cdaf17ca112dac3fc157ffd1a1eac0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f62666432396630342d636236632d626334312d646233652d3566666564363634616662632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Fbfd29f04-cb6c-bc41-db3e-5ffed664afbc.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=388f2710d4600407941f89fdf8e2ba14\" alt=\"block-non-gui.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/237650/bfd29f04-cb6c-bc41-db3e-5ffed664afbc.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Fbfd29f04-cb6c-bc41-db3e-5ffed664afbc.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=73135a322a089fdf609979b8b1880788 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこのように呼び出し元を実行していたスレッドが最後まで使用され続けます。\u003cbr\u003e\n待っている間はスレッドがブロックされている状態となり、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eこの間はこのスレッドがスレッドプールに戻れなくなり（他の作業に活用することができない）\u003c/li\u003e\n\u003cli\u003eそれによって他のスレッドが作られやすくなり（スレッドを作ることにコストがかかる）\u003c/li\u003e\n\u003cli\u003eさらにスレッドが増えることによりコンテキストスイッチのコストも増える可能性があります\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003easyncメソッドはできるだけawaitするほうがよいといえるでしょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"awaitする前後で使用されるスレッドの関係\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#await%E3%81%99%E3%82%8B%E5%89%8D%E5%BE%8C%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%95%E3%82%8C%E3%82%8B%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E9%96%A2%E4%BF%82\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eawaitする前後で使用されるスレッドの関係\u003c/h2\u003e\n\n\u003cp\u003eもう一度、最初のシーケンスを見てみましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/bd86f0906e8243e5cb2473d80dae898b1069516c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f30383366616633372d643731382d616266302d663532342d6565326266653235363336632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F083faf37-d718-abf0-f524-ee2bfe25636c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=07b169b4320035ce7363a44f38744fd8\" alt=\"basic.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/237650/083faf37-d718-abf0-f524-ee2bfe25636c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F083faf37-d718-abf0-f524-ee2bfe25636c.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=bec0bd08fc5f8bd9ef0d6197db9d46b9 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこの色が異なる角が丸い囲いは、囲いの中の処理はすべて同じスレッドで処理されることを示していて、また、囲い同士はそれぞれ異なるスレッドとなる可能性がある、ということでした。\u003c/p\u003e\n\n\u003cp\u003eここでは、これらのスレッドの関係がどのようになるか見ていきます。\u003cbr\u003e\u003cbr\u003e\nおおまかに言えば、次のようになります\u003csup id=\"fnref4\"\u003e\u003ca href=\"#fn4\" title=\"厳密にはSynchronizationContextを使って判定されます。\"\u003e4\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e「前のスレッド」がGUIスレッドである場合は、「後のスレッド」もGUIスレッドとなる。\u003c/li\u003e\n\u003cli\u003e「前のスレッド」がGUIスレッドでない場合は、スレッドプールから渡されるスレッドが「後のスレッド」となる。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eGUIスレッドは、WindowsFormやWPFなどのクライアントアプリケーションで特別扱いされるスレッドです。ユーザからの入力を受け取ったり、画面に表示しているUI部品を更新したりするのはこのGUIスレッドしか行うことができません。\u003c/p\u003e\n\n\u003cp\u003eGUIスレッドで時間のかかる処理をしてしまった場合、その間ユーザの入力を受け付けることができないため、ユーザエクスペリエンスはとても悪いものになります。そのため、このようなクライアントアプリケーションで非同期処理を扱うことは非常に重要となります。\u003c/p\u003e\n\n\u003cp\u003eまた、UI部品を更新できるのはGUIスレッドのみであるため、他のスレッドからUI部品を直接更新しようとしても、実際に更新することはできません。\u003cbr\u003e\nそれでは時間のかかる処理の結果を、ユーザエクスペリエンスを損なうことなく画面に反映するためにはどうすればよいのか、ということになります。\u003cbr\u003e\nそこで、これらのアプリケーションではSynchronizationContextという仕組みを使うことにより、どのスレッドからでもGUIスレッドに作業を依頼できるようになっています。\u003c/p\u003e\n\n\u003cp\u003eそしてこのSynchronizationContextの仕組みを表からは見えない形で利用しているのがawaitなのです。冒頭に書いたように、awaitの前の処理を実行するスレッドがGUIスレッドである場合は、awaitの処理が完了した後の後続処理を実行するスレッドもGUIスレッドとなるように、awaitが取り計らってくれるのです。これにより、クライアントアプリケーションの開発者はSynchronizationContextを意識せずとも、awaitした処理の結果を使って画面を更新することができます。ほぼ同期処理を同じ書き方で、時間のかかる処理を非同期で実行し、その結果を画面に反映させることができるのです。次のようなイメージです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003ebutton1_Click\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetResultAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのことを踏まえて、先ほどの図を眺めてみましょう。内容に合わせて少し色を変えています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/3b89d851162c53103c2833c1404de623a5d34fef/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f66363365643134382d306631312d333035322d316130642d6239343833316437303363632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Ff63ed148-0f11-3052-1a0d-b94831d703cc.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=8a7f8c23131eb7f120daa26efb57064b\" alt=\"gui-basic.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/237650/f63ed148-0f11-3052-1a0d-b94831d703cc.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Ff63ed148-0f11-3052-1a0d-b94831d703cc.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=c47be869493f86bce402d94b24e2f235 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e呼び出し元のスレッドがGUIスレッドであるとします。そうするとawait前の処理を全てGUIスレッドが実行することになります。そのあと、呼び出し先の末端まで進んで、IsCompletedでないことを確認して戻ってきて、呼び出し元まで戻ってきたとします。\u003cbr\u003e\nそうするとGUIスレッドは現時点で処理することがなくなり、ユーザからの入力を待機する状態となります。\u003cbr\u003e\nその後、呼び出し先の末端部分の時間のかかる処理が完了した後、各Asyncメソッドの後続処理が実行されていきますが、そのとき使用されるスレッドが全てGUIスレッドとなります。\u003c/p\u003e\n\n\u003cp\u003e結果として、呼び出し先の末端部分以外はすべてGUIスレッドで実行されますが、同期的にWait()またはResultを呼んだ場合と異なり、呼び出し先の末端が処理をしている間はGUIスレッドは、他の作業ができる状態となっています。\u003c/p\u003e\n\n\u003cp\u003eかなり、前者の「前のスレッド」がGUIスレッドである場合の話が長くなってしまいました。\u003cbr\u003e\n後者の「前のスレッド」がGUIスレッドでない場合は、awaitした処理が完了した時点で、後続の作業がスレッドプールのキューに入り、順次スレッドプールのスレッドに処理されていきます。\u003cbr\u003e\nそのため、先ほどのGUIのスレッドと異なり、awaitの後の処理は、全て異なるスレッドで処理される可能性があります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"デッドロックとconfigureawait\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%83%E3%83%89%E3%83%AD%E3%83%83%E3%82%AF%E3%81%A8configureawait\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデッドロックとConfigureAwait\u003c/h2\u003e\n\n\u003cp\u003e上の節で、awaitの前がGUIスレッドであった場合、awaitの後もGUIスレッドになり、そのおかげでUI部品の更新が可能になっている、という話をしました。この話には裏があります。\u003c/p\u003e\n\n\u003cp\u003e負の側面として、デッドロックを引き起こす原因となりうる、というものがあります。\u003cbr\u003e\n具体例を見てみましょう。GUIスレッド上で実行している呼び出し元のメソッドが、AsyncメソッドをawaitではなくWait()またはResultで同期的に待つことにしたとしましょう。\u003c/p\u003e\n\n\u003cp\u003e呼び出し先の末端部分が長時間の処理を行っている間、GUIスレッドは呼び出し元のWait()またはResultでブロックされた状態となっています。\u003c/p\u003e\n\n\u003cp\u003e呼び出し先の末端部分の処理が完了したとします。\u003cbr\u003e\nこの完了を起点として、末端部分を直接呼び出したAsyncメソッドの後続処理が実行されます。どのスレッドで実行しようとするかというと、上の節の内容からするとGUIスレッドでしたね。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eGUIスレッドは呼び出し元が呼んだAsyncメソッドの完了を待っている\u003c/li\u003e\n\u003cli\u003e末端部分を直接呼んだAsyncメソッドはGUIスレッドが空くのを待っている\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこれだけでデッドロックが発生してしまいます。怖いですね。\u003cbr\u003e\nしつこいですが、また例のシーケンス図を載せておきます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/1f1851e1851f27e32616d0ede13691003120e91c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f31626334663932612d646665652d363631612d616162342d3136336131343330313937652e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F1bc4f92a-dfee-661a-aab4-163a1430197e.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7c113618a9d3d444c92adafcb0290a98\" alt=\"block-deadlock.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/237650/1bc4f92a-dfee-661a-aab4-163a1430197e.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F1bc4f92a-dfee-661a-aab4-163a1430197e.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=47533d905ce19d7e39f6b073253b39b4 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこのデッドロックを回避するためにはどうすればよいでしょうか。一つには、呼び出し元がWait()やResultをできるだけ使わないようにして、できるだけawaitで待つということが挙げられます。ユーザエクスペリエンスを損なわないためにもこれがベターな回避策です。\u003c/p\u003e\n\n\u003cp\u003eですが、とはいっても、何らかの理由で同期的に待たなければいけない可能性を排除できません。また、Asyncメソッドをpublicとして公開したいライブラリの開発者の立場に立つと、同期的に待つだけで簡単にデッドロックしてしまうような機能を公開したくはないですよね。\u003c/p\u003e\n\n\u003cp\u003eそこで、 \u003ccode\u003eConfigureAwait(bool continueOnCapturedContext)\u003c/code\u003e というTaskクラスのメソッドを使って、Asyncメソッドの作成者側からこの問題を回避することができます。次のように使います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetResultAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e引数にtrueを渡すとConfigureAwaitを使わなかった場合と同じ挙動になり、falseを渡すと異なる挙動となります。どのような挙動になるかというと、awaitの後の処理がGUIスレッドではなく、スレッドプールから渡されるスレッドによて実行されるようになります。これにより、デッドロックを回避することができます。後続処理がGUIスレッドを必要としない場合や、ライブラリを開発する場合にはConfigureAwait(false)を付けるようにしておくとよいでしょう。\u003c/p\u003e\n\n\u003cp\u003eまた、例によってシーケンス図で確認しておきます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/7655874f251cce50cd10dc07384aca04adb942b4/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f65653064663937392d666237612d636334622d653036382d3536656239376636393363392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Fee0df979-fb7a-cc4b-e068-56eb97f693c9.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e1bae09dcbf346bd754eb629983caf23\" alt=\"block-gui-configure.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/237650/ee0df979-fb7a-cc4b-e068-56eb97f693c9.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2Fee0df979-fb7a-cc4b-e068-56eb97f693c9.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=13cfdb9750c2ae65f05cae1cc255cd2c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eConfigureAwai(false)をつけることによって、GUIスレッドではなくスレッドプールのスレッドを使うようになったため、デッドロックを起こさず最後まで処理を完遂することができました。注意としては、全てのawaitの箇所でConfigureAwait(false)を呼び出さないとデッドロックに陥ってしまうということです。awaitの前の処理を全てGUIスレッドで実行しているので、全てのawaitの後の処理は何もしなければ全てGUIスレッドに戻ろうとしてしまいます。\u003c/p\u003e\n\n\u003cp\u003eまた、呼び出し元がWait()やResultを使用せずにawaitを使用した場合は、ConfigureAwait(false)をつけることでGUIスレッドの占有時間を減らすことができます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/7f837e6b06baa2b6fa2f31f85d4172462b746c51/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233373635302f38646538326136382d646635322d346365642d353330392d3866333832363465373066652e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F8de82a68-df52-4ced-5309-8f38264e70fe.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=861df856924dfd36090f8b0b96fd0a2f\" alt=\"gui-configure.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/237650/8de82a68-df52-4ced-5309-8f38264e70fe.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F237650%2F8de82a68-df52-4ced-5309-8f38264e70fe.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8fe0654e6697948358376180e287084b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこの図では青い囲いの部分のみがGUIスレッドとなっています。\u003cbr\u003e\nこのように、呼び出し元メソッドの後続処理以外はGUIスレッドでない別のスレッドで処理させることができます。その結果、別のスレッドで処理している間はGUIスレッドは別の作業を待機することができることになります。\u003c/p\u003e\n\n\u003cp\u003eただ、勢い余ってUI部品を更新したい場合にまで \u003ccode\u003eConfigureAwait(false)\u003c/code\u003e をしないように注意してくださいね。この場合は逆にGUIスレッドを使わないと反映できなくなってしまいます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"最後に\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e最後に\u003c/h2\u003e\n\n\u003cp\u003e最後まで読んでいただき、ありがとうございました！\u003cbr\u003e\nうっかりとても長くなってしまいました。。。\u003c/p\u003e\n\n\u003cp\u003eいざ書き始めてみると自分自身もわかっていないことが多くあり、調べたり勉強したりしながらなんとか書き終えました。まだ理解が足りず曖昧になってしまっている部分もあったりするかと思います。学びながら追記、または新記事を書くなどしてみようと思います！\u003cbr\u003e\nあと、もっと書くこと整理しなければ、、ですね。\u003c/p\u003e\n\n\u003cp\u003eもし誤りやよくない記述、改善コメントがありましたら、是非コメントお願いいたします！\u003c/p\u003e\n\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\n\u003cli id=\"fn1\"\u003e\n\u003cp\u003eこのコードは実際にコンパイラが出力するものとは異なります。できるだけ本物に忠実に書いてみましたが、（だから長いのですが）、何箇所かは解説用に修正しています。実際にコンパイラが出力するコードを見てみたい場合は、ILSpyというツールを使って見ることができます（Visual Studioの拡張機能にもあります）。ILSpyを使うと、C#をビルドした結果のMSILから逆コンパイルしたC#を見ることができます。そのC#のバージョンをasync/awaitのないC# 4.0まで下げてやれば、上のようなコードを見ることができると思います。 \u003ca href=\"#fnref1\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn2\"\u003e\n\u003cp\u003e例えばキー入力を取得したり、ネットワークからデータを送受信したりする場合等。先ほどのサンプルコードで扱ったファイル処理もこれです。ライブラリを使っていて一番よく出くわすのはこれだと思います。 \u003ca href=\"#fnref2\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn3\"\u003e\n\u003cp\u003eとても単純化しています。具体的には呼び出し先の全てのメソッドでawaitは1回しかしていないものと仮定しています。 \u003ca href=\"#fnref3\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn4\"\u003e\n\u003cp\u003e厳密にはSynchronizationContextを使って判定されます。 \u003ca href=\"#fnref4\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003c/ol\u003e\n\u003c/div\u003e\n","createdAt":"2019-01-31T10:35:55Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"7JASdhzbUY54n5C1moGbXG4CUcQoghf8--tyeSEE8UuebbzVhX--mxTZkVipkefZJ3tKE1328Q==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-02-12T12:08:47Z","likesCount":42,"linkUrl":"https://qiita.com/mrngsht/items/7d280c9f161f6d9855e2","organization":null,"originalId":777809,"stockedCount":41,"title":"【図解】C#のasync/awaitの内部挙動を理解する","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#asyncawait%E3%81%A8%E3%81%AF\"\u003easync/awaitとは？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E6%9B%B8%E3%81%8D%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8\"\u003eこの記事で書きたいこと\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%AC%E9%A1%8C\"\u003e本題\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%92%E8%A6%8B%E3%81%A6%E3%81%BF%E3%82%8B\"\u003eソースコードサンプルを見てみる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#asyncawait%E3%81%AF%E7%8A%B6%E6%85%8B%E9%81%B7%E7%A7%BB%E6%A9%9F%E6%A2%B0%E3%82%92%E4%BD%9C%E3%82%8B\"\u003easync/awaitは状態遷移機械を作る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#await%E3%81%AE%E5%8B%95%E3%81%8D%E3%82%92%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9%E3%81%A7%E4%BF%AF%E7%9E%B0%E3%81%99%E3%82%8B\"\u003eawaitの動きをシーケンスで俯瞰する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#await%E3%81%99%E3%82%8B%E5%89%8D%E5%BE%8C%E3%81%A7%E4%BD%BF%E7%94%A8%E3%81%95%E3%82%8C%E3%82%8B%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E9%96%A2%E4%BF%82\"\u003eawaitする前後で使用されるスレッドの関係\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%83%E3%83%89%E3%83%AD%E3%83%83%E3%82%AF%E3%81%A8configureawait\"\u003eデッドロックとConfigureAwait\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"\u003e最後に\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":8235,"uuid":"7d280c9f161f6d9855e2","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"PS4OPQszgf3RfZiY9WC/USfR/gLn--t8SVkl/G425VSv7x--Sfy4PuKoqPbJa9nZ9plvZQ==","originalId":237650,"description":"フリーランスのITエンジニアです。世の中いろんな意見があっていいと思います。私も個人的な意見を書いていきます。別の意見があれば優しくコメントいただけると嬉しいです。今の夢は、ROWE・ほぼリモートで働きながら多拠点に居住しながら、日光を浴びて生活することです。zennもはじめました。","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/237650/59d1f541109393df0bfe9fcf544c6202ad3a7bfa/x_large.png?1613990552","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F237650%2F59d1f541109393df0bfe9fcf544c6202ad3a7bfa%2Fx_large.png%3F1613990552?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=01e470ef51d5d6262e86a9e0d2910055","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F237650%2F59d1f541109393df0bfe9fcf544c6202ad3a7bfa%2Fx_large.png%3F1613990552?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=6a78134350bc36038cd883e8c5e48be3","urlName":"mrngsht","websiteUrl":"https://zenn.dev/mrngsht","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":".NET","urlName":".net"},{"name":"async","urlName":"async"},{"name":"AsyncAwait","urlName":"asyncawait"}],"followingLikers":{"edges":[]},"comments":{"totalCount":1}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
