More than 1 year has passed since last update.CP932の環境依存文字（機種依存文字）を、JIS X 0208（JIS基本漢字）の異字体・俗字に置き換えるソフトを C# で作ったので記事にする。本稿では、次の知識があるものとして話を進める。一般に「文字コード」と言われれば文字符号化方式を指すが、厳密には異なる。
もし新人SEがUnicodeとUTF-8の違いを質問してきたら、それは「文字コード」が文字符号化方式と符号化文字集合で構成されていることを理解していないということなので、丁寧に説明してあげよう。なお、CP932については、
https://qiita.com/kasei-san/items/cfb993786153231e5413
の記事が詳しいので、そちらを参照して欲しい。今のeLTAX（地方税の電子申告システム）では、JIS X 0208で定義されていない環境依存文字、半角カナ、JIS第3水準漢字、JIS第4水準漢字を扱えないので、これらを似たような文字に置き換えてしまおうというのが開発の発端。
ちなみに総務省発表によると、扱える文字の不足問題は2019年9月に改善される予定とのことで今後に期待するとしよう。
現在は e-Tax（国税の電子申告システム）と同水準に改善され、この問題は解消している。

なお、e-Tax（国税の電子申告システム）では、JIS X 0221をUTF-8で符号化した文字コードを扱えるため上図に示した文字では問題は発生しない。ただし、「𠮷」（土の下に口。某牛丼チェーンでも使われている文字）のようなサロゲートペアの文字はやはり扱えない。異字体・俗字に明確な定義づけがあるわけではない。
同じ意味の漢字ではあるものの、字体が少し異なっているものとし、ここでは、旧字体や古字も異字体に含まれると定義する。ソフトの性質上、人名と地名で使われる漢字に集中するわけだが、まずは該当文字を洗い出し、文字単位で変換辞書を作成するところから始めた。
CP932で拡張された文字が対象なので、JIS X 0208に存在する文字は除外する。JIS X 0208に存在しないので変換する。旧字体ではあるがJIS X 0208にも存在する漢字なので変換しない。日本国内で流通していない漢字、中国の一部の人名用漢字については、ピンイン、中国語読みのカナ表記、日本語読みのカナ表記のいずれかに変換できるようにした。
日本に伝えられた漢字の読み方（音読み）には、呉音（主に百済人によって伝えられた中国南方系の読み方）、漢音（奈良～平安時代に伝えられた中国北方系の読み方）、唐音（主に鎌倉時代に伝えられた江南浙江地方の読み方）があるが、中国の人名を日本語で読む場合は漢音が多いので、ソフトでは漢音に統一した。苗字の棈松（アベマツ）の「棈」、地名の荢千場（ウホシバ）の「荢」、苗字と地名の双方に使われている橳島（ヌデシマ）の「橳」などは、JIS X 0208の中に適当な文字が見つからなかった。「橳」の俗字として「椦」を確認できたものの、典拠が不明な幽霊文字なので採用しなかった。
また、岩手県には霻霳（ホウリョウ）という、JIS X 0208にない文字だけで構成された地名があり「豊隆」と書き換えた文献も確認しているが、ソフトは単語単位ではなく文字単位で見るので「豊隆」には変換されない。変換が必要なのに変換できなかった文字、つまり辞書に無い文字は、ユーザーの判断に委ねることにした。C# のソースコードを一部だが抜粋する。CP932で拡張された文字なら 0 以外を返す。
EncodingにShift_JISを指定しているが、これは .NET Framework に該当するコードページが無いからで、要はCP932と同じである。
.NET で CP932とShift_JISを区別する関数としても使えるだろう。上述の文字チェック関数で 0 以外を返した文字は、文字変換関数に渡す。
これでJIS X 0208で表現できる文字列となる。定義が無ければ null を返す。なお、完成したソフトの方は、オンラインソフトウェア流通サイト Vector で無償配布させていただいた。
興味のある人は使ってみて欲しい。
https://www.vector.co.jp/soft/winnt/business/se518540.html

※人名・住所は架空のもの。


