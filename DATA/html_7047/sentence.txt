More than 5 years have passed since last update.AzureにはAzure FunctionsというAWS Lambdaのようなサービスがあります。
Azure FunctionsはLambdaと同じく、一定時間毎やあるWebHookが呼ばれた際など、なんらかのイベントが発生したときに、サーバー上にあるC#やJavaScript（NodeJS）のコードが実行されるというものです。その際、Functions自体の動作ログをApplication Insightsに送信しておき、Application Insights上で見られたら良いなと思ったので、その方法を調べました。上手く送信出来るようになると、下図のようにApplication Insightsでログが見られるようになります。
まずは、Azure FunctionsでApplication Insightsのライブラリを読み込めるようにします。
wwwroot以下に対象Function名の付いたフォルダがあります。そのフォルダ内にproject.jsonを作成し、次のような内容を書いておきます。project.jsonを保存すると、勝手にライブラリがNuGetからダウンロードされ、当該Functionで利用可能になります。
今のところ、Azure Portal上ではproject.jsonを作成できないので、ここだけはKuduを利用したり、Visual Studio経由でアップロードするなどの手間がかかります。Azure FunctionsのApp Service Settingsを開き、『アプリケーション設定』の項目でAPPINSIGHTS_INSTRUMENTATIONKEYというキーを作成し、値にはApplication InsightsのINSTRUMENTATIONKEYを設定します。
ここで設定したキーはEnvironment.GetEnvironmentVariable("APPINSIGHTS_INSTRUMENTATIONKEY")というコードで参照出来ます。実際のコードは次のような形です。
ポイントとして、TelemetryClientのContext.Operation.Idに、当該FunctionのInvocationId（呼び出しID）を設定しています。
このInvocationIdはFunctionが呼び出される度にユニークな値となるので、どの呼び出しに関するテレメトリかを後から追跡しやすくなります。Application Insightsも、Operation.Id毎にテレメトリをグルーピングしてくれます。


