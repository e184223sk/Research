作成しているアプリケーションを別のPCに実装することになりました。その中で、システム環境変数Pathへの登録が前提となっているソフトがあるので、どうせならその設定を自動で行ってくれるアプリを作成しようと考えました。システム環境変数の変更なので管理者権限での実行が必要となります。追加を選択し、その中の「新しい項目」を左クリックする
Visual C# アイテムから「アプリケーション マニフェスト ファイル」を追加する（名前はデフォルトのままでOK）
app.manifestは下のような構成をしています。このうち19行目付近にあるrequestedExecutionLevel level="asInvoker"内「asInvoker」を「requireAdministrator」に変更することでアプリケーション実行前に付与の確認を行うウィンドウを出すことができます。
このほかコードで処理ごとに付与の確認をする方法もありますが、実行時に挙動がおかしくなったのでおすすめしません。さて本題。システム環境変数への追加はEnvironment.SetEnvironmentVariableを使うと楽に設定が可能です。こんな風に。しかし、追加と言っても実際はPathといった既に変数が存在する場合は値を上書きしてしまいます。システム環境変数を変更前に戻すには修復ポイントからのシステム修復くらいしか方法がないため、非常に面倒。そこで変更前のPath内の値を取得し、それに追加したいパスを付け加えた値を新たに定義する必要があります。
という事で、以下がパスの追加に関するコード。C:\\softalk\\の部分は適宜変えてください。2/11改訂：文字列取得した場合、複数の値の場合は「;」で区切っているため追加したいパスの前に「;」を追加した方がいいようです。コードは修正済み。管理者権限の付与方法
https://www.ipentec.com/document/csharp-run-as-administrator-using-manifest-file
システム環境変数への追加方法
http://hensa40.cutegirl.jp/archives/2733


