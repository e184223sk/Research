More than 1 year has passed since last update.Xamarin.FormsでPrismを使ってAndroid限定のアプリを作っていたのですが、手持ちのWindows10Mobile端末でも使えるようにしたいと思い、UWPプロジェクトを追加することにしました。参考にしたのはstackoverflowのこちらのスレッドです。
Prismではない通常のXamarin.FormsソリューションにおけるUWPプロジェクトの追加方法ですが、MainPage.xaml.csの変更内容に少し違いがあるだけでほぼ同じです。
Prismを使わない場合はstackoverflowの手順に従えばOKです。ちなみにUWPプロジェクトを追加するアプリケーションのメインページはこんな感じです。Visual Studioで「ユニバーサルWindowsプラットフォーム開発」のワークロードをインストールしておいてください。ご覧のとおり、Androidプロジェクトしかありません。
ソリューションエクスプローラーで、ソリューション名で右クリックして追加→新しいプロジェクトを選択します。
追加するプロジェクトは空白のアプリ　（ユニバーサル　Windows）です。
プロジェクトの名前と追加する場所を入力しますが、ここで注意が必要です。UWPプロジェクトの名前はソリューション名.UWPとする必要があり、今回の例ではTakeMeThereXamarinForms.UWPとなります。Xamarin.Formsのフォルダ構成では、ソリューションフォルダの下にもう一つ同名のフォルダがあり、その中に各プロジェクトのフォルダが入っているので、今回の例ではプロジェクトを追加する場所としてC:\temp\TakeMeThereXamarinForms\TakeMeThereXamarinFormsを指定します。OKボタンを押すと、次にUWPプロジェクトのターゲットバージョンの指定を求められます。
2019年1月23日時点で、Xamarin.Formsは.Net Standard 2.0のライブラリを使うようになっていて、そのため、プラットフォームの最小バージョンとしてWindows 10 Fall Creators Update(10.0;ビルド 16299)以上を選択する必要があります。ソリューションエクスプローラーにUWPプロジェクトが追加されました。
アプリのソリューションのフォルダを見てみると、以下のようにAndroidプロジェクトと同じ階層にUWPプロジェクトができています。UWPプロジェクトにXamarin.Formsパッケージをインストールします。
UWPプロジェクト名の上で右クリックしてNuGetパッケージの管理を選択します。参照タブで「xamarin.forms」を検索してインストールします。このとき、インストールするXamarin.Formsのバージョンは他のプラットフォームのプロジェクトにインストールされているバージョンと同じバージョンを選択してください。
すべてのプラットフォームのプロジェクトで同じバージョンのXamarin.Formsを使用することが重要です。UWPプロジェクトのApp.xaml.csに以下の変更を加えます。
rootFrame.NavigationFailed += OnNavigationFailed; の下にXamarin.Forms.Forms.Init(e);を追加します。次にUWPプロジェクトのMainPage.xamlに変更を加えます。
xmlns:forms="using:Xamarin.Forms.Platform.UWP"を追加し、Pageタグをforms:WindowsPageとします。変更後は以下のとおりです。UWPプロジェクトのMainPage.xaml.csに以下の変更を加えます。
まず、MainPageクラスがPageクラスを継承していますが、その継承を削除します。次にMainPageメソッドにLoadApplication(new TakeMeThereXamarinForms.App(new UwpInitializer()));を追加します。そしてUwpInitializerクラスを追加します。最後に、IPlatformInitializerとIContainerRegistryのために以下の2つをusingで追加します。最終的にMainPage.xaml.csは以下のようになります。UWPプロジェクトをローカルコンピュータで実行すると、以下のように表示されました。
ターゲットプラットフォームとしてUWPを追加することができました。


