More than 3 years have passed since last update.golangにはdeferという機能があります。
deferを使うと関数を抜けるときに処理を実行することができます。以下にサンプルを示します。実行結果を見ると以下のことが分かります。C++に慣れている方ならクラスのデストラクタをイメージしていただければよいです。
これをC#でも実現してみます。
(先に書いておきますが実用的ではありません。あくまで同じようなことを実現するだけです。)実装を見ればとてもシンプルなのであまり書くことはありませんがポイントはDefer&lt;T&gt;とExecuteAllでしょうか。
Defer&lt;T&gt;は引数にアクションだけではなく引数も受け取ります。
これによってDefer&lt;T&gt;を呼び出したときの値をコピーすることができます。
ExecuteAllではDeferを呼び出した順番と逆順になるようにアクションを実行しています。C#でもdeferっぽいものを作成することはできました。
DeferrableやListなどといった一時オブジェクトが作成されてしまうためノーコストとは呼べません。
(golangのdeferもdeferを使用せずに書いた時と比べて完全にノーコストというわけではありませんがこの実装よりかは圧倒的に低いコストです。)


