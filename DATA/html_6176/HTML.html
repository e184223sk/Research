<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Azure Functions と KeyVault を連携させてみる - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="bGqPvY4YLlzdVz3M4AGcCgo4oBCVTZ0YMC2qxA6t+gcBBvP3Xco6ajCDtxjMUvqge/WeHaFqUbnEJ2BnQSF60Q==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="Azure Functions と KeyVault を連携させてみる - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RWHAxY21VZ1JuVnVZM1JwYjI1eklPT0JxQ0JMWlhsV1lYVnNkQ0RqZ3BMcGdLUG1rTHJqZ1pYamdadmpnYWJqZ2JfamdvcyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1iM2M4NTUzNmQzYTlmZWNkYzM5MzI4MzIzOTg4MDUzNQ&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=665feed1b20876b5e5d8e3dcb03bd059"><meta property="og:description" content="今日は、プロジェクトで関係している、Azure Functions で KeyVault を使ってみるということを試してみた。Key Vault は、アプリケーションで使用するキーやシークレットの安全性を守ってくれるサービスだ。HSM..."><meta content="https://qiita.com/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Azure,AzureFunctions" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-c8b0d1aa-3ada-499f-af78-3dcb877886e5"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F8ac6cffe0fe923abf7cc">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F8ac6cffe0fe923abf7cc">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-c8b0d1aa-3ada-499f-af78-3dcb877886e5">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2017-07-27T15:08:41.000+09:00","dateModified":"2017-07-27T15:08:41.000+09:00","headline":"Azure Functions と KeyVault を連携させてみる","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RWHAxY21VZ1JuVnVZM1JwYjI1eklPT0JxQ0JMWlhsV1lYVnNkQ0RqZ3BMcGdLUG1rTHJqZ1pYamdadmpnYWJqZ2JfamdvcyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1iM2M4NTUzNmQzYTlmZWNkYzM5MzI4MzIzOTg4MDUzNQ\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=665feed1b20876b5e5d8e3dcb03bd059","mainEntityOfPage":"https://qiita.com/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc","author":{"@type":"Person","address":"Kanagwa, Japan","email":null,"identifier":"TsuyoshiUshio@github","name":"TsuyoshiUshio@github","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","url":"https://qiita.com/TsuyoshiUshio@github","description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">プロダクト全体の「エコシステム」を考えるユーザベースの開発手法とは？</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"8ac6cffe0fe923abf7cc"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"プロダクト全体の「エコシステム」を考えるユーザベースの開発手法とは？","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"8ac6cffe0fe923abf7cc"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"プロダクト全体の「エコシステム」を考えるユーザベースの開発手法とは？","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"8ac6cffe0fe923abf7cc"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"プロダクト全体の「エコシステム」を考えるユーザベースの開発手法とは？","url":"https://zine.qiita.com/interview/202105-uzabase/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc","location":"/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc","scheme":"https","host":"qiita.com","port":null,"pathname":"/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"NzN/vktKTvU4YJ1R9drCMDK5hvY8VzLLvCeygQk6sblaXwP0mJhaw9W0F4XZiaSaQ3S4+whw/mpILXgiRrYxbw==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-a1c02f38-bf5a-424f-b798-5786aaf01ee9"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc/likers" class="css-1iupg5d">11</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">11</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/8ac6cffe0fe923abf7cc/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/TsuyoshiUshio@github"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/TsuyoshiUshio@github" class="css-10ougpm">@<!-- -->TsuyoshiUshio@github</a><div class="css-1ay9vb9"><time dateTime="2017-07-27T06:08:41Z" class="css-m19uds">posted at 2017-07-27</time></div></div></div></div></div><h1 class="css-cgzq40">Azure Functions と KeyVault を連携させてみる</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/azure" class="css-4czcte">Azure</a><a href="/tags/azurefunctions" class="css-4czcte">AzureFunctions</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>今日は、プロジェクトで関係している、Azure Functions で <a href="https://azure.microsoft.com/en-us/services/key-vault/" rel="nofollow noopener" target="_blank">KeyVault</a> を使ってみるということを試してみた。Key Vault は、アプリケーションで使用するキーやシークレットの安全性を守ってくれるサービスだ。HSM というキーやシークレットを守るための専用のハードも使われている。</p>

<p>　今回は、Azure Functions で使われているキーやシークレットの情報を Key Vault に格納して、取得するための方法について書いてみる。</p>

<h1>
<span id="1-keyvault-の作成" class="fragment"></span><a href="#1-keyvault-%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>1. KeyVault の作成</h1>

<p>Key Vault は、Azure CLI, PowerShell 等様々な方法で作成できるが、ここでは簡単に Portal から、作成してしまおう。特に難しいことは何もない。</p>

<p><a href="https://camo.qiitausercontent.com/73e89868a2fc6f0658dafaee9de759ea5b62500e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62346162643034632d666166322d383837392d383137632d3136613334383533646637362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fb4abd04c-faf2-8879-817c-16a34853df76.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f62c12fca75c6e7f234b5f946ff02ef6" alt="KeyVault01.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/b4abd04c-faf2-8879-817c-16a34853df76.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fb4abd04c-faf2-8879-817c-16a34853df76.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6f22438df90b3fdff137ffe90377a8e6 1x" loading="lazy"></a></p>

<h1>
<span id="2-keyvault-へのデータのセット" class="fragment"></span><a href="#2-keyvault-%E3%81%B8%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88"><i class="fa fa-link"></i></a>2. KeyVault へのデータのセット</h1>

<p>これまた様々な方法が可能ですが、簡単に Portal でいっときましょう。</p>

<p><a href="https://camo.qiitausercontent.com/89effbb27f7b66c9f5cf4d771931fda04b3b5551/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63643132636537322d363031372d313132622d643536332d3439613763386565643032342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fcd12ce72-6017-112b-d563-49a7c8eed024.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=01787f862834e2e3d71e11c944ae93bf" alt="KeyVault02.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/cd12ce72-6017-112b-d563-49a7c8eed024.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fcd12ce72-6017-112b-d563-49a7c8eed024.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e772ab50c2f45c1722043d812c221433 1x" loading="lazy"></a></p>

<p>ポータルから選びます。今回はキーではなく、シークレットを登録してみましたが、Certificate というファイル形式と、Manual というテキストを入力するのと両方選べます。今回簡単に、<code>SomeSecret / ushio</code> みたいなシークレットを登録してみました。</p>

<p><a href="https://camo.qiitausercontent.com/76ef2eb273f551563e7212b3e2a7c5c684e00525/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38333661616466372d366434662d393236612d653338642d6466396337613134383937392e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F836aadf7-6d4f-926a-e38d-df9c7a148979.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b8f712eb38f8b6aefd4bcd40507f1653" alt="KeyVault03.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/836aadf7-6d4f-926a-e38d-df9c7a148979.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F836aadf7-6d4f-926a-e38d-df9c7a148979.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e2ff9a7edd8f82ca44c03a4192bafec9 1x" loading="lazy"></a></p>

<h1>
<span id="3-service-principle-password-で-keyvault-に接続する" class="fragment"></span><a href="#3-service-principle-password-%E3%81%A7-keyvault-%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. Service Principle (password) で KeyVault に接続する</h1>

<p>Azure Functions から Key Vault に接続するためには２つの方法があります。基本的には、Service Principle を作成して、それを、KeyVault に紐づけて、権限を振るという考えです。その Service Principle の作り方で、よく使うパスワードを使う方法、Certificate を使う方法があります。まずは、<br>
簡単な方で、Azure Function (Visual Studio で開発) に対して、Service Principle (password) で接続するための設定とコードを書いてみます。</p>

<h2>
<span id="31-service-principle-を作成する" class="fragment"></span><a href="#31-service-principle-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3.1. Service Principle を作成する。</h2>

<p>Service Principle は、Active Directory が、あるアプリケーションを、管理し、それに対して様々な権限を設定するための仕組みです。Azure を操作したい場合は、大体これを使います。</p>

<p>最近では、Azure CLI 2.0 を使うと、ワンコマンドで、Service Principle が作れます。<a href="https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli?toc=%2fazure%2fazure-resource-manager%2ftoc.json" rel="nofollow noopener" target="_blank">Create an Azure service principal with Azure CLI 2.0</a>ところが、インターネットで見たどの手順もこれを使わず、PowerShell と、Azure でゴリゴリに設定して、作る方法が採用されています。おそらく、CLI でサービスプリンシプルを作って、Azure CLI で、KeyVault に紐づけて権限をつければたぶん一番簡単だと思います。（ただし、Service Principle + certificate の方法は、Azure CLI で出来るかどうかは不明です）いづれにしても、今度 Azure CLI でも試してみたいと思います。</p>

<p>　さて、<a href="http://www.rahulpnath.com/blog/azure-key-vault-from-azure-functions/" rel="nofollow noopener" target="_blank">Azure Key Vault From Azure Functions</a>の手順を踏襲してやってみます。大体そのままでいけました。しかし、Azure 上で、Service Principle をゴリゴリに作るのは久々ですが、勉強がてらやっていましょう。</p>

<h3>
<span id="311-久々にazure-旧-portal-から-service-principle-を作ってみる" class="fragment"></span><a href="#311-%E4%B9%85%E3%80%85%E3%81%ABazure-%E6%97%A7-portal-%E3%81%8B%E3%82%89-service-principle-%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>3.1.1. 久々に、Azure 旧 Portal から Service Principle を作ってみる。</h3>

<p>Service Principle の作りは簡単です。<a href="https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli?toc=%2fazure%2fazure-resource-manager%2ftoc.json" rel="nofollow noopener" target="_blank">Create an Azure service principal with Azure CLI 2.0</a>が一番簡単ですが、ポータルで作るとこんな感じ。細かく制御できます。</p>

<p>Azure Active Directory から、アプリケーションを追加します。すると、サインオン URL、アプリケーションID/URL が要求されます。これは、今回のアプリの場合は、ユニークであればいいので、適当に入力してみてください。（おそらく、本当にシングルサインオンする案件とかでは考える必要あり）</p>

<p><a href="https://camo.qiitausercontent.com/5dbb4031b1d14db8226dc49a0793d740bf45226e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35653530306166322d346566632d613931322d393136642d3439323133343737393630312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F5e500af2-4efc-a912-916d-492134779601.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=325e86850fd0e06bfe5a1418034763c4" alt="AD01.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/5e500af2-4efc-a912-916d-492134779601.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F5e500af2-4efc-a912-916d-492134779601.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=31497a717217d1077d1244f59c6f1c84 1x" loading="lazy"></a></p>

<p>アプリケーションの名前も、実際のアプリではあまりつかいませんので、分かりやすい名前を付けてください。</p>

<p><a href="https://camo.qiitausercontent.com/96ba38af5caa51e322af4ee913402cbddd4a16b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39376362303837332d636565662d333134362d613462342d3362373265313463313336312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F97cb0873-ceef-3146-a4b4-3b72e14c1361.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e210d7746904ab22aabbe4ad6861c691" alt="AD02.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/97cb0873-ceef-3146-a4b4-3b72e14c1361.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F97cb0873-ceef-3146-a4b4-3b72e14c1361.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=70474c9342727613a5d629aca4b11002 1x" loading="lazy"></a></p>

<p><a href="https://camo.qiitausercontent.com/69b4ed27f664d011b3c9e79fe6148aa23981b90e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38323533653437362d313638312d313264322d346639392d3530356339656630633161662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F8253e476-1681-12d2-4f99-505c9ef0c1af.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=38af19b5dbc830d12a402e7b04cb00ea" alt="AD03.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/8253e476-1681-12d2-4f99-505c9ef0c1af.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F8253e476-1681-12d2-4f99-505c9ef0c1af.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3a75ffd5597e5a962d8043fcba079b54 1x" loading="lazy"></a></p>

<p>すると Azure Function に相当する、アプリケーションが出来ました。ただ、アプリケーションが出来ただけでなんの、関連付けもありませんし、なんのアクセス権限もありません。</p>

<p><a href="https://camo.qiitausercontent.com/b5d3645aa11f76400c66590f6997c4825e43d74c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34646136386130382d363161662d646336642d333966322d6662323139393635616335642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4da68a08-61af-dc6d-39f2-fb219965ac5d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=eed0f8d4b43fa9570dfdf8a7cbc048e3" alt="AD04e.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/4da68a08-61af-dc6d-39f2-fb219965ac5d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4da68a08-61af-dc6d-39f2-fb219965ac5d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=fc791a2e9bc7efbca447d887c644f4ff 1x" loading="lazy"></a></p>

<p>最後の画面で、1. クライアント ID が表示されます。これが、CLIENT_ID と呼ばれる Service Principle の設定に必要となるIDなので保存しておいてください。また、キーの項目は最初何もありませんが、キーをここで生成することで、このサービスプリンシパルがいつから、いつまで有効かを設定できて、キーの値が表示されます。１回しか表示されないので、これも保存しておいてください。</p>

<p>　ちなみに、アプリケーションは、Service Principle によって、Azure などへのアクセスが許可されますが、不正利用とかあると、この「アプリケーション」を削除すれば、そのアプリケーションは、Azure に接続できなくなるので、便利です。</p>

<p>　さて、Application と、その Service Principle は作りました。次は、それをKey Vault と紐づけます。これは元のブログでたぶん間違っていたところですが、下記のコマンドレット(PowerShell) を使います。<br>
ちなみに、この PowerShell に相当することも、Azure CLI で可能っぽいです。<a href="https://docs.microsoft.com/en-us/azure/key-vault/key-vault-manage-with-cli" rel="nofollow noopener" target="_blank">Manage Key Vault using CLI</a></p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>Set-AzureRmKeyVaultAccessPolicy -VaultName 'SpikeKey' -ServicePrincipalName '{ここに、CLIENT_IDを}' -PermissionsToSecret all -PermissionsToKey
</code></pre></div></div>

<p>という感じで、KeyVault と Service Principle を紐づけて権限 (Secret と、Key へのアクセスを、all　として与える) 付与しています。</p>

<p>さて、最後は、コードですが、Visual Studio でコードを書いてみました。Azure Functions のタイプは、Web Trigger の C# にしてみました。 ちなみに、Manage Nuget Packages... を選択して、 専用のライブラリを取得しておきます。<code>Microsoft.Azure.KeyVault</code>　と  <code>Microsoft.IndentityModel.Clients.ActiveDirectory</code>です。あとはコーディングし放題！</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Net.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Azure.WebJobs</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Azure.WebJobs.Extensions.Http</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Azure.WebJobs.Host</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Azure.KeyVault</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.IdentityModel.Clients.ActiveDirectory</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">KeyVaultIntegration</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">KeyVaultIntegration</span>
    <span class="p">{</span>

        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">applicationId</span> <span class="p">=</span> <span class="s">"{CLIENT_IDをここに}"</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">applicationSecret</span> <span class="p">=</span> <span class="s">"{取得したキーをここに}"</span><span class="p">;</span>
        <span class="p">[</span><span class="nf">FunctionName</span><span class="p">(</span><span class="s">"KeyVaultSpike"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">HttpTrigger</span><span class="p">(</span><span class="n">AuthorizationLevel</span><span class="p">.</span><span class="n">Function</span><span class="p">,</span> <span class="s">"get"</span><span class="p">,</span> <span class="s">"post"</span><span class="p">,</span> <span class="n">Route</span> <span class="p">=</span> <span class="k">null</span><span class="p">)]</span><span class="n">HttpRequestMessage</span> <span class="n">req</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">"C# HTTP trigger function processed a request."</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">keyClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">KeyVaultClient</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="n">authority</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">adCredential</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ClientCredential</span><span class="p">(</span><span class="n">applicationId</span><span class="p">,</span> <span class="n">applicationSecret</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">authenticationContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AuthenticationContext</span><span class="p">(</span><span class="n">authority</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="n">authenticationContext</span><span class="p">.</span><span class="nf">AcquireTokenAsync</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">adCredential</span><span class="p">)).</span><span class="n">AccessToken</span><span class="p">;</span>

            <span class="p">});</span>

            <span class="kt">var</span> <span class="n">secretIdentifier</span> <span class="p">=</span> <span class="s">"https://spikekey.vault.azure.net/secrets/SomeSecret/"</span><span class="p">;</span><span class="err">　</span><span class="c1">// KeyVault の Secret Identifier を入れる。</span>
            <span class="kt">var</span> <span class="n">secret</span> <span class="p">=</span> <span class="k">await</span> <span class="n">keyClient</span><span class="p">.</span><span class="nf">GetSecretAsync</span><span class="p">(</span><span class="n">secretIdentifier</span><span class="p">);</span>

            <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"Secret is </span><span class="p">{</span><span class="n">secret</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>


            <span class="k">return</span> <span class="n">secret</span> <span class="p">==</span> <span class="k">null</span>
                <span class="p">?</span> <span class="n">req</span><span class="p">.</span><span class="nf">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">BadRequest</span><span class="p">,</span> <span class="s">"Please pass a secret on the query string or in the request body"</span><span class="p">)</span>
                <span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="nf">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="s">"Your secret is "</span> <span class="p">+</span> <span class="n">secret</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ちなみに、Secret Identifier は次のページで取れます。<br>
<a href="https://camo.qiitausercontent.com/f9a99502f822379ebc14c93a420aa93210685ef5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63666662366634342d616263382d363737652d353236352d6239663038373561333261652e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fcffb6f44-abc8-677e-5265-b9f0875a32ae.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7a230f72a82f096f5e7cc0effb2f44ad" alt="KeyVault04.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/cffb6f44-abc8-677e-5265-b9f0875a32ae.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fcffb6f44-abc8-677e-5265-b9f0875a32ae.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f9eb281104cc2b849273a37fe630e05d 1x" loading="lazy"></a></p>

<p><code>https://spikekey.vault.azure.net/secrets/SomeSecret/{英数字の羅列}</code>なのですが、最後の英数字は、バージョン番号のようで、なくしたら最新を撮ってくるという仕様なので、このように、SomeSecretというシークレット名の後のバージョンは取らないようにしています。</p>

<p>これで、Azure Functions をローカルで起動して、指示されたURLを単純にリクエストすると、ちゃんとシークレットが取得できています。</p>

<p><a href="https://camo.qiitausercontent.com/5b5d7825d2fc34450e9cc9458adf3ae910141e90/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32366330316664342d303164642d396433382d613165622d3234373730643966653534612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F26c01fd4-01dd-9d38-a1eb-24770d9fe54a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=598406cc887087551f52252369c6e3a4" alt="AF01.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/26c01fd4-01dd-9d38-a1eb-24770d9fe54a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F26c01fd4-01dd-9d38-a1eb-24770d9fe54a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=891a7da0edf0c590baf74b79a4525302 1x" loading="lazy"></a></p>

<p>基本的にサービスプリンシパルの、CLIENT_ID と、キー（パスワード)があり、Key Vault と紐づければ、アクセスできるみたいですね。簡単！</p>

<h1>
<span id="4-service-principle-certificate-で-keyvault-に接続する" class="fragment"></span><a href="#4-service-principle-certificate-%E3%81%A7-keyvault-%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>4. Service Principle (certificate) で KeyVault に接続する</h1>

<p>次に、Service Principle を キー（パスワード）ではなくて、Certificate で認証する方法を試してみます。<br>
こっちのほうがセキュリティ的に硬いですが、手順は面倒です。</p>

<h2>
<span id="41-winodws-sdk-のダウンロード" class="fragment"></span><a href="#41-winodws-sdk-%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>4.1. Winodws SDK のダウンロード</h2>

<p>最初に、Private Key, Certificate, pfx ファイルを作る必要があります。Verisign とかにお金を払って試すのもいいですが、最初は、オレオレ証明書でやってみましょう。オレオレ証明書は <a href="https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk" rel="nofollow noopener" target="_blank">WIndows 10 SDK</a> をダウンロードすれば、 makecert/pvk2pfx というキー関連のツールが取得できます。しかし、なんということか、pvk2pfx の方はどこを探してもありませんでした。あまりよくありませんが、<a href="http://www.pconlife.com/viewfileinfo/pvk2pfx-exe/" rel="nofollow noopener" target="_blank">このサイト</a>から落としました。自己責任で。ただ、昔を思い出すと、たしか、<a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm" rel="nofollow noopener" target="_blank">PowerShell だけで、自己証明書を作る手順</a>があったと思います。だから、たぶんこれらのコマンドなしでも大丈夫だと思います。今回はこのコマンドを使って作る手順を。</p>

<p>なんと、これらのコマンドは、コマンドプロンプトでしか動きません。</p>

<h2>
<span id="42-private-key-と-certificate-を作成する" class="fragment"></span><a href="#42-private-key-%E3%81%A8-certificate-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>4.2. Private Key と、 Certificate を作成する</h2>

<p>下記のコマンドで、Private Key と、Certificate を作成しています。<code>mykey.pvk</code>が、Private Key で、 <code>ADTestVaultApplication.cer</code> がセルフサインのCertificate (証明書) です。オレオレ証明書ですね。パスワードを聞かれますので、入力しましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>"C:\Program Files (x86)\Windows Kits\10\bin\10.0.15063.0\x64\makecert.exe"  -sv mykey.pvk -n "cn=AD Test Vault Application" ADTestVaultApplication.cer -b 01/01/2014 -e 01/01/2019 -r
Succeeded
</code></pre></div></div>

<p>そして、これらを、pfx ファイルにまとめます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>C:\Users\tsushi\Downloads\pvk2pfx.exe  -pvk mykey.pvk -spc ADTestVaultApplication.cer -pfx ADTestVaultApplication.pfx -po test
</code></pre></div></div>

<p>private key と、certificate から、pfx ファイル（バイナリで、Private Key, Certificate が格納されている形式) に変換して、パスワード <code>test</code> をつけています。</p>

<h2>
<span id="43-pfx-ファイルの-azure-functions-への登録" class="fragment"></span><a href="#43-pfx-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE-azure-functions-%E3%81%B8%E3%81%AE%E7%99%BB%E9%8C%B2"><i class="fa fa-link"></i></a>4.3. pfx ファイルの Azure Functions への登録</h2>

<p>次に、Azure Functions に、作った pfx ファイルを登録してみましょう。</p>

<p>Azure Functions のこの画面から</p>

<p><a href="https://camo.qiitausercontent.com/b5f650b89cbdb72de25b5d8ebbfd2b50a8bbe39d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36653465636532662d626230612d616536622d383032322d6166633333343835313431392e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F6e4ece2f-bb0a-ae6b-8022-afc334851419.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=74ef0d3c815331ff6c10880b67b98d14" alt="AF02.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/6e4ece2f-bb0a-ae6b-8022-afc334851419.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F6e4ece2f-bb0a-ae6b-8022-afc334851419.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1cbd7d2a94ee436f63972de54d7a1c6d 1x" loading="lazy"></a></p>

<p>先ほど作った、ADTestValueApplication.pfx を登録してみましょう。パスワードは、先ほど <code>-po</code> オプションで渡した<code>test</code>です。<br>
<a href="https://camo.qiitausercontent.com/f7bb62ab743d1a9254ea8e63b6e1a3b31557855e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37633761623863612d643466622d343530352d376663392d6361666339353032336237382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F7c7ab8ca-d4fb-4505-7fc9-cafc95023b78.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=118a891598eab5fb47038a4916e1940b" alt="AF04.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/7c7ab8ca-d4fb-4505-7fc9-cafc95023b78.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F7c7ab8ca-d4fb-4505-7fc9-cafc95023b78.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=092b7ab345c8f7fb4b849b0df7a9bf72 1x" loading="lazy"></a></p>

<h2>
<span id="43-service-principle-の作成" class="fragment"></span><a href="#43-service-principle-%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>4.3. Service Principle の作成</h2>

<p>先ほど作成した、Certificate を元に、Service Principle を作ります。<br>
```<br>
$certificateFilePath = "C:\Users\tsushi\Codes\certs\ADTestVaultApplication.cer" // ここ<br>
$certificate = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2<br>
$certificate.Import($certificateFilePath)<br>
$rawCertificateData = $certificate.GetRawCertData()<br>
$credential = [System.Convert]::ToBase64String($rawCertificateData)<br>
$startDate= [System.DateTime]::Now<br>
$endDate = $startDate.AddYears(1)<br>
$adApplication = New-AzureRmADApplication -DisplayName "CertAdApplication" -HomePage  "<a href="http://www.kvtest.co.jp" class="autolink" rel="nofollow noopener" target="_blank">http://www.kvtest.co.jp</a>" -IdentifierUris "<a href="http://www.kvtest.co.jp" class="autolink" rel="nofollow noopener" target="_blank">http://www.kvtest.co.jp</a>" -CertValue $credential  -StartDate $startDate -EndDate $endDate // ここ</p>

<p>$servicePrincipal = New-AzureRmADServicePrincipal -ApplicationId $adApplication.ApplicationId</p>

<p>Set-AzureRmKeyVaultAccessPolicy -VaultName 'SpikeKey' -ServicePrincipalName $servicePrincipal.ServicePrincipalNames[0] -PermissionsToSecrets all -PermissionsToKeys all<br>
```</p>

<p>「ここ」と書いている２行が変更可能性のある場所です。具体的にはたいしたことをやっていなくて、Certificate を読み込んで、New-AzureRmADApplication というコマンドレットで、Application　を作って、New-AzureADServicePrincipal というコマンドレットで、Service Principle を作っています。先ほどとの違いは、Azure Portal でこの部分を実行したので、CLIENT_ID や、キーは、画面から取得しました。</p>

<p>今回は上記のコマンドを実行後、次のように取得できます。</p>

<p>CLIENT_ID<br>
<code><br>
$adApplication.ApplicationId<br>
</code><br>
キーは、今回はCertificate を使うので取得不要です。</p>

<h2>
<span id="44-website_load_certificates-環境変数の設定" class="fragment"></span><a href="#44-website_load_certificates-%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>4.4. WEBSITE_LOAD_CERTIFICATES 環境変数の設定</h2>

<p>簡単にアップロードできました。次に Application Settingsに移ります。ここで、Certificate のThumbnail を取得します。Thumbprint は親指の指紋という意味です。実体は、Hashのようで、これにより、Certficate を一位に特定できます。</p>

<p>先ほどのコマンドを実行したのち、次のコマンドを実行すれば取得できます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>$certificate.Thumbprint
</code></pre></div></div>

<p><a href="https://camo.qiitausercontent.com/ccc2d52a5eb16b6031fffa03770678b3a7c194c6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39303662313731352d636639342d303061382d326431332d6630666631333264663238642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F906b1715-cf94-00a8-2d13-f0ff132df28d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f33a20b5cdad590697c471343ed399f2" alt="Af05.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/906b1715-cf94-00a8-2d13-f0ff132df28d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F906b1715-cf94-00a8-2d13-f0ff132df28d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6b50cae5fc9e3af5627a332e4175cde0 1x" loading="lazy"></a></p>

<h2>
<span id="45-azure-functions-を-portal-で作ってみる" class="fragment"></span><a href="#45-azure-functions-%E3%82%92-portal-%E3%81%A7%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>4.5. Azure Functions を Portal で作ってみる。</h2>

<p>さて、この構成だと、クライアントで 実行するのは難しそうなので、Portal で実行を試してみました。Nuget で取得するライブラリは、<code>Microsoft.Azure.KeyVault</code>と<code>Microsoft.IndentityModel.Clients.ActiveDirectory</code>ですが、Portal から実行する場合は、<code>project.json</code> に書いておきます。</p>

<p><a href="https://camo.qiitausercontent.com/68aae6691585712b7d63d3291ccfc7af31e035d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65666436356566302d316662622d366434622d303130382d6363363332343237376161342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fefd65ef0-1fbb-6d4b-0108-cc6324277aa4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=14395b20bf93eda13ac058b0f3f63a13" alt="AF06.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/efd65ef0-1fbb-6d4b-0108-cc6324277aa4.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fefd65ef0-1fbb-6d4b-0108-cc6324277aa4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4e5eca81d304425abd5be2a30a0307d5 1x" loading="lazy"></a></p>

<p>そして、いよいよコードです。Certificate 周りのコードは面倒になりましたが、本質的には、KeyVault クライアントを取得して、実行しているだけです。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Azure.KeyVault</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.IdentityModel.Clients.ActiveDirectory</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography.X509Certificates</span><span class="p">;</span>

<span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">applicationId</span> <span class="p">=</span> <span class="s">"{ここに、CLIENT_ID}"</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="nf">Run</span><span class="p">(</span><span class="n">HttpRequestMessage</span> <span class="n">req</span><span class="p">,</span> <span class="n">TraceWriter</span> <span class="n">log</span><span class="p">)</span>
<span class="p">{</span>


<span class="kt">string</span> <span class="n">certificateThumbprint</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"WEBSITE_LOAD_CERTIFICATES"</span><span class="p">);</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">"C# HTTP trigger function processed a request."</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">keyClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">KeyVaultClient</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="n">authority</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">scope</span><span class="p">)=&gt;</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">authenticationContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AuthenticationContext</span><span class="p">(</span><span class="n">authority</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
        <span class="n">X509Certificate2</span> <span class="n">certificate</span><span class="p">;</span>
        <span class="n">X509Store</span> <span class="n">store</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509Store</span><span class="p">(</span><span class="n">StoreName</span><span class="p">.</span><span class="n">My</span><span class="p">,</span> <span class="n">StoreLocation</span><span class="p">.</span><span class="n">CurrentUser</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">store</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">OpenFlags</span><span class="p">.</span><span class="n">ReadOnly</span><span class="p">);</span>
            <span class="n">X509Certificate2Collection</span> <span class="n">certificateCollection</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">Certificates</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">X509FindType</span><span class="p">.</span><span class="n">FindByThumbprint</span><span class="p">,</span> <span class="n">certificateThumbprint</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">certificateCollection</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">certificateCollection</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span><span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Certificate not installed in the store"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">certificate</span> <span class="p">=</span> <span class="n">certificateCollection</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">finally</span>
        <span class="p">{</span>
            <span class="n">store</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="kt">var</span> <span class="n">clientAssertionCertificate</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ClientAssertionCertificate</span><span class="p">(</span><span class="n">applicationId</span><span class="p">,</span> <span class="n">certificate</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">authenticationContext</span><span class="p">.</span><span class="nf">AcquireTokenAsync</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">clientAssertionCertificate</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="n">AccessToken</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="kt">var</span> <span class="n">secretIdentifier</span> <span class="p">=</span> <span class="s">"https://spikekey.vault.azure.net/secrets/SomeSecret/"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">secret</span> <span class="p">=</span> <span class="k">await</span> <span class="n">keyClient</span><span class="p">.</span><span class="nf">GetSecretAsync</span><span class="p">(</span><span class="n">secretIdentifier</span><span class="p">);</span>

            <span class="n">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">$"Secret is </span><span class="p">{</span><span class="n">secret</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">secret</span> <span class="p">==</span> <span class="k">null</span>
        <span class="p">?</span> <span class="n">req</span><span class="p">.</span><span class="nf">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">BadRequest</span><span class="p">,</span> <span class="s">"Please store a secret"</span><span class="p">)</span>
        <span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="nf">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="s">"Secret is "</span> <span class="p">+</span> <span class="n">secret</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>テスト実行するとうまく動いています。</p>

<p><a href="https://camo.qiitausercontent.com/42d7b29224a37323393bfe48f3e548d8967d3f7b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36343338336636332d383764632d646631622d663761622d6131393831643939313938392e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F64383f63-87dc-df1b-f7ab-a1981d991989.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f4e3aaf96acf0358a244c144ef7f268c" alt="AF07.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/64383f63-87dc-df1b-f7ab-a1981d991989.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F64383f63-87dc-df1b-f7ab-a1981d991989.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f81e5501437efd48de11c2f7e8f56c26 1x" loading="lazy"></a></p>

<p>お疲れさまでした。明日はこれをテストしやすいようにして実装して終了です。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F8ac6cffe0fe923abf7cc&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F8ac6cffe0fe923abf7cc&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc/likers" class="css-1iupg5d">11</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">11</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/8ac6cffe0fe923abf7cc/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-a1c02f38-bf5a-424f-b798-5786aaf01ee9">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-d7ff9423-22ee-4627-bc9a-d0870197b254"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-d7ff9423-22ee-4627-bc9a-d0870197b254">{}</script>
      
<div id="LoginModal-react-component-4a91c5f2-006e-40e9-8314-edc7068dfc8b"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-4a91c5f2-006e-40e9-8314-edc7068dfc8b">{}</script>
      
<div id="StockModal-react-component-65474092-358d-421e-bb4a-6bb60764b5e7"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-65474092-358d-421e-bb4a-6bb60764b5e7">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;jRYcZbyX4dyDvWx6KiBXHV9yvyR6eHkSoyAjlvNe5V7gemAvb0X16m5p5q4GczG3Lr+BKU5ftbNXKuk1vNJliA==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e今日は、プロジェクトで関係している、Azure Functions で \u003ca href=\"https://azure.microsoft.com/en-us/services/key-vault/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eKeyVault\u003c/a\u003e を使ってみるということを試してみた。Key Vault は、アプリケーションで使用するキーやシークレットの安全性を守ってくれるサービスだ。HSM というキーやシークレットを守るための専用のハードも使われている。\u003c/p\u003e\n\n\u003cp\u003e　今回は、Azure Functions で使われているキーやシークレットの情報を Key Vault に格納して、取得するための方法について書いてみる。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"1-keyvault-の作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-keyvault-%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. KeyVault の作成\u003c/h1\u003e\n\n\u003cp\u003eKey Vault は、Azure CLI, PowerShell 等様々な方法で作成できるが、ここでは簡単に Portal から、作成してしまおう。特に難しいことは何もない。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/73e89868a2fc6f0658dafaee9de759ea5b62500e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f62346162643034632d666166322d383837392d383137632d3136613334383533646637362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fb4abd04c-faf2-8879-817c-16a34853df76.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f62c12fca75c6e7f234b5f946ff02ef6\" alt=\"KeyVault01.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/b4abd04c-faf2-8879-817c-16a34853df76.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fb4abd04c-faf2-8879-817c-16a34853df76.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6f22438df90b3fdff137ffe90377a8e6 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"2-keyvault-へのデータのセット\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2-keyvault-%E3%81%B8%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2. KeyVault へのデータのセット\u003c/h1\u003e\n\n\u003cp\u003eこれまた様々な方法が可能ですが、簡単に Portal でいっときましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/89effbb27f7b66c9f5cf4d771931fda04b3b5551/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63643132636537322d363031372d313132622d643536332d3439613763386565643032342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fcd12ce72-6017-112b-d563-49a7c8eed024.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=01787f862834e2e3d71e11c944ae93bf\" alt=\"KeyVault02.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/cd12ce72-6017-112b-d563-49a7c8eed024.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fcd12ce72-6017-112b-d563-49a7c8eed024.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e772ab50c2f45c1722043d812c221433 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eポータルから選びます。今回はキーではなく、シークレットを登録してみましたが、Certificate というファイル形式と、Manual というテキストを入力するのと両方選べます。今回簡単に、\u003ccode\u003eSomeSecret / ushio\u003c/code\u003e みたいなシークレットを登録してみました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/76ef2eb273f551563e7212b3e2a7c5c684e00525/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38333661616466372d366434662d393236612d653338642d6466396337613134383937392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F836aadf7-6d4f-926a-e38d-df9c7a148979.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b8f712eb38f8b6aefd4bcd40507f1653\" alt=\"KeyVault03.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/836aadf7-6d4f-926a-e38d-df9c7a148979.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F836aadf7-6d4f-926a-e38d-df9c7a148979.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e2ff9a7edd8f82ca44c03a4192bafec9 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"3-service-principle-password-で-keyvault-に接続する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3-service-principle-password-%E3%81%A7-keyvault-%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3. Service Principle (password) で KeyVault に接続する\u003c/h1\u003e\n\n\u003cp\u003eAzure Functions から Key Vault に接続するためには２つの方法があります。基本的には、Service Principle を作成して、それを、KeyVault に紐づけて、権限を振るという考えです。その Service Principle の作り方で、よく使うパスワードを使う方法、Certificate を使う方法があります。まずは、\u003cbr\u003e\n簡単な方で、Azure Function (Visual Studio で開発) に対して、Service Principle (password) で接続するための設定とコードを書いてみます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"31-service-principle-を作成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#31-service-principle-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.1. Service Principle を作成する。\u003c/h2\u003e\n\n\u003cp\u003eService Principle は、Active Directory が、あるアプリケーションを、管理し、それに対して様々な権限を設定するための仕組みです。Azure を操作したい場合は、大体これを使います。\u003c/p\u003e\n\n\u003cp\u003e最近では、Azure CLI 2.0 を使うと、ワンコマンドで、Service Principle が作れます。\u003ca href=\"https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli?toc=%2fazure%2fazure-resource-manager%2ftoc.json\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCreate an Azure service principal with Azure CLI 2.0\u003c/a\u003eところが、インターネットで見たどの手順もこれを使わず、PowerShell と、Azure でゴリゴリに設定して、作る方法が採用されています。おそらく、CLI でサービスプリンシプルを作って、Azure CLI で、KeyVault に紐づけて権限をつければたぶん一番簡単だと思います。（ただし、Service Principle + certificate の方法は、Azure CLI で出来るかどうかは不明です）いづれにしても、今度 Azure CLI でも試してみたいと思います。\u003c/p\u003e\n\n\u003cp\u003e　さて、\u003ca href=\"http://www.rahulpnath.com/blog/azure-key-vault-from-azure-functions/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAzure Key Vault From Azure Functions\u003c/a\u003eの手順を踏襲してやってみます。大体そのままでいけました。しかし、Azure 上で、Service Principle をゴリゴリに作るのは久々ですが、勉強がてらやっていましょう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"311-久々にazure-旧-portal-から-service-principle-を作ってみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#311-%E4%B9%85%E3%80%85%E3%81%ABazure-%E6%97%A7-portal-%E3%81%8B%E3%82%89-service-principle-%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.1.1. 久々に、Azure 旧 Portal から Service Principle を作ってみる。\u003c/h3\u003e\n\n\u003cp\u003eService Principle の作りは簡単です。\u003ca href=\"https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli?toc=%2fazure%2fazure-resource-manager%2ftoc.json\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCreate an Azure service principal with Azure CLI 2.0\u003c/a\u003eが一番簡単ですが、ポータルで作るとこんな感じ。細かく制御できます。\u003c/p\u003e\n\n\u003cp\u003eAzure Active Directory から、アプリケーションを追加します。すると、サインオン URL、アプリケーションID/URL が要求されます。これは、今回のアプリの場合は、ユニークであればいいので、適当に入力してみてください。（おそらく、本当にシングルサインオンする案件とかでは考える必要あり）\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/5dbb4031b1d14db8226dc49a0793d740bf45226e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f35653530306166322d346566632d613931322d393136642d3439323133343737393630312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F5e500af2-4efc-a912-916d-492134779601.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=325e86850fd0e06bfe5a1418034763c4\" alt=\"AD01.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/5e500af2-4efc-a912-916d-492134779601.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F5e500af2-4efc-a912-916d-492134779601.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=31497a717217d1077d1244f59c6f1c84 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eアプリケーションの名前も、実際のアプリではあまりつかいませんので、分かりやすい名前を付けてください。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/96ba38af5caa51e322af4ee913402cbddd4a16b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39376362303837332d636565662d333134362d613462342d3362373265313463313336312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F97cb0873-ceef-3146-a4b4-3b72e14c1361.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e210d7746904ab22aabbe4ad6861c691\" alt=\"AD02.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/97cb0873-ceef-3146-a4b4-3b72e14c1361.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F97cb0873-ceef-3146-a4b4-3b72e14c1361.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=70474c9342727613a5d629aca4b11002 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/69b4ed27f664d011b3c9e79fe6148aa23981b90e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f38323533653437362d313638312d313264322d346639392d3530356339656630633161662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F8253e476-1681-12d2-4f99-505c9ef0c1af.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=38af19b5dbc830d12a402e7b04cb00ea\" alt=\"AD03.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/8253e476-1681-12d2-4f99-505c9ef0c1af.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F8253e476-1681-12d2-4f99-505c9ef0c1af.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=3a75ffd5597e5a962d8043fcba079b54 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eすると Azure Function に相当する、アプリケーションが出来ました。ただ、アプリケーションが出来ただけでなんの、関連付けもありませんし、なんのアクセス権限もありません。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/b5d3645aa11f76400c66590f6997c4825e43d74c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f34646136386130382d363161662d646336642d333966322d6662323139393635616335642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4da68a08-61af-dc6d-39f2-fb219965ac5d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=eed0f8d4b43fa9570dfdf8a7cbc048e3\" alt=\"AD04e.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/4da68a08-61af-dc6d-39f2-fb219965ac5d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F4da68a08-61af-dc6d-39f2-fb219965ac5d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=fc791a2e9bc7efbca447d887c644f4ff 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e最後の画面で、1. クライアント ID が表示されます。これが、CLIENT_ID と呼ばれる Service Principle の設定に必要となるIDなので保存しておいてください。また、キーの項目は最初何もありませんが、キーをここで生成することで、このサービスプリンシパルがいつから、いつまで有効かを設定できて、キーの値が表示されます。１回しか表示されないので、これも保存しておいてください。\u003c/p\u003e\n\n\u003cp\u003e　ちなみに、アプリケーションは、Service Principle によって、Azure などへのアクセスが許可されますが、不正利用とかあると、この「アプリケーション」を削除すれば、そのアプリケーションは、Azure に接続できなくなるので、便利です。\u003c/p\u003e\n\n\u003cp\u003e　さて、Application と、その Service Principle は作りました。次は、それをKey Vault と紐づけます。これは元のブログでたぶん間違っていたところですが、下記のコマンドレット(PowerShell) を使います。\u003cbr\u003e\nちなみに、この PowerShell に相当することも、Azure CLI で可能っぽいです。\u003ca href=\"https://docs.microsoft.com/en-us/azure/key-vault/key-vault-manage-with-cli\" rel=\"nofollow noopener\" target=\"_blank\"\u003eManage Key Vault using CLI\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eSet-AzureRmKeyVaultAccessPolicy -VaultName 'SpikeKey' -ServicePrincipalName '{ここに、CLIENT_IDを}' -PermissionsToSecret all -PermissionsToKey\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eという感じで、KeyVault と Service Principle を紐づけて権限 (Secret と、Key へのアクセスを、all　として与える) 付与しています。\u003c/p\u003e\n\n\u003cp\u003eさて、最後は、コードですが、Visual Studio でコードを書いてみました。Azure Functions のタイプは、Web Trigger の C# にしてみました。 ちなみに、Manage Nuget Packages... を選択して、 専用のライブラリを取得しておきます。\u003ccode\u003eMicrosoft.Azure.KeyVault\u003c/code\u003e　と  \u003ccode\u003eMicrosoft.IndentityModel.Clients.ActiveDirectory\u003c/code\u003eです。あとはコーディングし放題！\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Linq\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Net\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Net.Http\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading.Tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.Azure.WebJobs\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.Azure.WebJobs.Extensions.Http\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.Azure.WebJobs.Host\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.Azure.KeyVault\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.IdentityModel.Clients.ActiveDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eKeyVaultIntegration\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eKeyVaultIntegration\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eapplicationId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"{CLIENT_IDをここに}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eapplicationSecret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"{取得したキーをここに}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eFunctionName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"KeyVaultSpike\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpResponseMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"nf\"\u003eHttpTrigger\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAuthorizationLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFunction\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"get\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"post\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRoute\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpRequestMessage\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTraceWriter\u003c/span\u003e \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"C# HTTP trigger function processed a request.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyClient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eKeyVaultClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eauthority\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eresource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003escope\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eadCredential\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eClientCredential\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eapplicationId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eapplicationSecret\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eauthenticationContext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAuthenticationContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eauthority\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eauthenticationContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAcquireTokenAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eadCredential\u003c/span\u003e\u003cspan class=\"p\"\u003e)).\u003c/span\u003e\u003cspan class=\"n\"\u003eAccessToken\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecretIdentifier\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"https://spikekey.vault.azure.net/secrets/SomeSecret/\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"err\"\u003e　\u003c/span\u003e\u003cspan class=\"c1\"\u003e// KeyVault の Secret Identifier を入れる。\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSecretAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esecretIdentifier\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Secret is \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003esecret\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpStatusCode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBadRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Please pass a secret on the query string or in the request body\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpStatusCode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOK\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Your secret is \"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eちなみに、Secret Identifier は次のページで取れます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f9a99502f822379ebc14c93a420aa93210685ef5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f63666662366634342d616263382d363737652d353236352d6239663038373561333261652e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fcffb6f44-abc8-677e-5265-b9f0875a32ae.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7a230f72a82f096f5e7cc0effb2f44ad\" alt=\"KeyVault04.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/cffb6f44-abc8-677e-5265-b9f0875a32ae.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fcffb6f44-abc8-677e-5265-b9f0875a32ae.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f9eb281104cc2b849273a37fe630e05d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ehttps://spikekey.vault.azure.net/secrets/SomeSecret/{英数字の羅列}\u003c/code\u003eなのですが、最後の英数字は、バージョン番号のようで、なくしたら最新を撮ってくるという仕様なので、このように、SomeSecretというシークレット名の後のバージョンは取らないようにしています。\u003c/p\u003e\n\n\u003cp\u003eこれで、Azure Functions をローカルで起動して、指示されたURLを単純にリクエストすると、ちゃんとシークレットが取得できています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/5b5d7825d2fc34450e9cc9458adf3ae910141e90/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32366330316664342d303164642d396433382d613165622d3234373730643966653534612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F26c01fd4-01dd-9d38-a1eb-24770d9fe54a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=598406cc887087551f52252369c6e3a4\" alt=\"AF01.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/26c01fd4-01dd-9d38-a1eb-24770d9fe54a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F26c01fd4-01dd-9d38-a1eb-24770d9fe54a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=891a7da0edf0c590baf74b79a4525302 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e基本的にサービスプリンシパルの、CLIENT_ID と、キー（パスワード)があり、Key Vault と紐づければ、アクセスできるみたいですね。簡単！\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"4-service-principle-certificate-で-keyvault-に接続する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4-service-principle-certificate-%E3%81%A7-keyvault-%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4. Service Principle (certificate) で KeyVault に接続する\u003c/h1\u003e\n\n\u003cp\u003e次に、Service Principle を キー（パスワード）ではなくて、Certificate で認証する方法を試してみます。\u003cbr\u003e\nこっちのほうがセキュリティ的に硬いですが、手順は面倒です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"41-winodws-sdk-のダウンロード\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#41-winodws-sdk-%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.1. Winodws SDK のダウンロード\u003c/h2\u003e\n\n\u003cp\u003e最初に、Private Key, Certificate, pfx ファイルを作る必要があります。Verisign とかにお金を払って試すのもいいですが、最初は、オレオレ証明書でやってみましょう。オレオレ証明書は \u003ca href=\"https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWIndows 10 SDK\u003c/a\u003e をダウンロードすれば、 makecert/pvk2pfx というキー関連のツールが取得できます。しかし、なんということか、pvk2pfx の方はどこを探してもありませんでした。あまりよくありませんが、\u003ca href=\"http://www.pconlife.com/viewfileinfo/pvk2pfx-exe/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこのサイト\u003c/a\u003eから落としました。自己責任で。ただ、昔を思い出すと、たしか、\u003ca href=\"https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm\" rel=\"nofollow noopener\" target=\"_blank\"\u003ePowerShell だけで、自己証明書を作る手順\u003c/a\u003eがあったと思います。だから、たぶんこれらのコマンドなしでも大丈夫だと思います。今回はこのコマンドを使って作る手順を。\u003c/p\u003e\n\n\u003cp\u003eなんと、これらのコマンドは、コマンドプロンプトでしか動きません。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"42-private-key-と-certificate-を作成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#42-private-key-%E3%81%A8-certificate-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.2. Private Key と、 Certificate を作成する\u003c/h2\u003e\n\n\u003cp\u003e下記のコマンドで、Private Key と、Certificate を作成しています。\u003ccode\u003emykey.pvk\u003c/code\u003eが、Private Key で、 \u003ccode\u003eADTestVaultApplication.cer\u003c/code\u003e がセルフサインのCertificate (証明書) です。オレオレ証明書ですね。パスワードを聞かれますので、入力しましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\"C:\\Program Files (x86)\\Windows Kits\\10\\bin\\10.0.15063.0\\x64\\makecert.exe\"  -sv mykey.pvk -n \"cn=AD Test Vault Application\" ADTestVaultApplication.cer -b 01/01/2014 -e 01/01/2019 -r\nSucceeded\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eそして、これらを、pfx ファイルにまとめます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eC:\\Users\\tsushi\\Downloads\\pvk2pfx.exe  -pvk mykey.pvk -spc ADTestVaultApplication.cer -pfx ADTestVaultApplication.pfx -po test\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eprivate key と、certificate から、pfx ファイル（バイナリで、Private Key, Certificate が格納されている形式) に変換して、パスワード \u003ccode\u003etest\u003c/code\u003e をつけています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"43-pfx-ファイルの-azure-functions-への登録\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#43-pfx-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE-azure-functions-%E3%81%B8%E3%81%AE%E7%99%BB%E9%8C%B2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.3. pfx ファイルの Azure Functions への登録\u003c/h2\u003e\n\n\u003cp\u003e次に、Azure Functions に、作った pfx ファイルを登録してみましょう。\u003c/p\u003e\n\n\u003cp\u003eAzure Functions のこの画面から\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/b5f650b89cbdb72de25b5d8ebbfd2b50a8bbe39d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36653465636532662d626230612d616536622d383032322d6166633333343835313431392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F6e4ece2f-bb0a-ae6b-8022-afc334851419.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=74ef0d3c815331ff6c10880b67b98d14\" alt=\"AF02.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/6e4ece2f-bb0a-ae6b-8022-afc334851419.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F6e4ece2f-bb0a-ae6b-8022-afc334851419.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1cbd7d2a94ee436f63972de54d7a1c6d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e先ほど作った、ADTestValueApplication.pfx を登録してみましょう。パスワードは、先ほど \u003ccode\u003e-po\u003c/code\u003e オプションで渡した\u003ccode\u003etest\u003c/code\u003eです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f7bb62ab743d1a9254ea8e63b6e1a3b31557855e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f37633761623863612d643466622d343530352d376663392d6361666339353032336237382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F7c7ab8ca-d4fb-4505-7fc9-cafc95023b78.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=118a891598eab5fb47038a4916e1940b\" alt=\"AF04.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/7c7ab8ca-d4fb-4505-7fc9-cafc95023b78.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F7c7ab8ca-d4fb-4505-7fc9-cafc95023b78.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=092b7ab345c8f7fb4b849b0df7a9bf72 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"43-service-principle-の作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#43-service-principle-%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.3. Service Principle の作成\u003c/h2\u003e\n\n\u003cp\u003e先ほど作成した、Certificate を元に、Service Principle を作ります。\u003cbr\u003e\n```\u003cbr\u003e\n$certificateFilePath = \"C:\\Users\\tsushi\\Codes\\certs\\ADTestVaultApplication.cer\" // ここ\u003cbr\u003e\n$certificate = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2\u003cbr\u003e\n$certificate.Import($certificateFilePath)\u003cbr\u003e\n$rawCertificateData = $certificate.GetRawCertData()\u003cbr\u003e\n$credential = [System.Convert]::ToBase64String($rawCertificateData)\u003cbr\u003e\n$startDate= [System.DateTime]::Now\u003cbr\u003e\n$endDate = $startDate.AddYears(1)\u003cbr\u003e\n$adApplication = New-AzureRmADApplication -DisplayName \"CertAdApplication\" -HomePage  \"\u003ca href=\"http://www.kvtest.co.jp\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://www.kvtest.co.jp\u003c/a\u003e\" -IdentifierUris \"\u003ca href=\"http://www.kvtest.co.jp\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttp://www.kvtest.co.jp\u003c/a\u003e\" -CertValue $credential  -StartDate $startDate -EndDate $endDate // ここ\u003c/p\u003e\n\n\u003cp\u003e$servicePrincipal = New-AzureRmADServicePrincipal -ApplicationId $adApplication.ApplicationId\u003c/p\u003e\n\n\u003cp\u003eSet-AzureRmKeyVaultAccessPolicy -VaultName 'SpikeKey' -ServicePrincipalName $servicePrincipal.ServicePrincipalNames[0] -PermissionsToSecrets all -PermissionsToKeys all\u003cbr\u003e\n```\u003c/p\u003e\n\n\u003cp\u003e「ここ」と書いている２行が変更可能性のある場所です。具体的にはたいしたことをやっていなくて、Certificate を読み込んで、New-AzureRmADApplication というコマンドレットで、Application　を作って、New-AzureADServicePrincipal というコマンドレットで、Service Principle を作っています。先ほどとの違いは、Azure Portal でこの部分を実行したので、CLIENT_ID や、キーは、画面から取得しました。\u003c/p\u003e\n\n\u003cp\u003e今回は上記のコマンドを実行後、次のように取得できます。\u003c/p\u003e\n\n\u003cp\u003eCLIENT_ID\u003cbr\u003e\n\u003ccode\u003e\u003cbr\u003e\n$adApplication.ApplicationId\u003cbr\u003e\n\u003c/code\u003e\u003cbr\u003e\nキーは、今回はCertificate を使うので取得不要です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"44-website_load_certificates-環境変数の設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#44-website_load_certificates-%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.4. WEBSITE_LOAD_CERTIFICATES 環境変数の設定\u003c/h2\u003e\n\n\u003cp\u003e簡単にアップロードできました。次に Application Settingsに移ります。ここで、Certificate のThumbnail を取得します。Thumbprint は親指の指紋という意味です。実体は、Hashのようで、これにより、Certficate を一位に特定できます。\u003c/p\u003e\n\n\u003cp\u003e先ほどのコマンドを実行したのち、次のコマンドを実行すれば取得できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e$certificate.Thumbprint\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ccc2d52a5eb16b6031fffa03770678b3a7c194c6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f39303662313731352d636639342d303061382d326431332d6630666631333264663238642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F906b1715-cf94-00a8-2d13-f0ff132df28d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f33a20b5cdad590697c471343ed399f2\" alt=\"Af05.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/906b1715-cf94-00a8-2d13-f0ff132df28d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F906b1715-cf94-00a8-2d13-f0ff132df28d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6b50cae5fc9e3af5627a332e4175cde0 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"45-azure-functions-を-portal-で作ってみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#45-azure-functions-%E3%82%92-portal-%E3%81%A7%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.5. Azure Functions を Portal で作ってみる。\u003c/h2\u003e\n\n\u003cp\u003eさて、この構成だと、クライアントで 実行するのは難しそうなので、Portal で実行を試してみました。Nuget で取得するライブラリは、\u003ccode\u003eMicrosoft.Azure.KeyVault\u003c/code\u003eと\u003ccode\u003eMicrosoft.IndentityModel.Clients.ActiveDirectory\u003c/code\u003eですが、Portal から実行する場合は、\u003ccode\u003eproject.json\u003c/code\u003e に書いておきます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/68aae6691585712b7d63d3291ccfc7af31e035d0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f65666436356566302d316662622d366434622d303130382d6363363332343237376161342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fefd65ef0-1fbb-6d4b-0108-cc6324277aa4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=14395b20bf93eda13ac058b0f3f63a13\" alt=\"AF06.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/efd65ef0-1fbb-6d4b-0108-cc6324277aa4.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fefd65ef0-1fbb-6d4b-0108-cc6324277aa4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=4e5eca81d304425abd5be2a30a0307d5 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eそして、いよいよコードです。Certificate 周りのコードは面倒になりましたが、本質的には、KeyVault クライアントを取得して、実行しているだけです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Net\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.Azure.KeyVault\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eMicrosoft.IdentityModel.Clients.ActiveDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Security.Cryptography\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Security.Cryptography.X509Certificates\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eapplicationId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"{ここに、CLIENT_ID}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpResponseMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpRequestMessage\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTraceWriter\u003c/span\u003e \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n\n\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ecertificateThumbprint\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEnvironmentVariable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"WEBSITE_LOAD_CERTIFICATES\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"C# HTTP trigger function processed a request.\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyClient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eKeyVaultClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eauthority\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eresource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003escope\u003c/span\u003e\u003cspan class=\"p\"\u003e)=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eauthenticationContext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAuthenticationContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eauthority\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eX509Certificate2\u003c/span\u003e \u003cspan class=\"n\"\u003ecertificate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eX509Store\u003c/span\u003e \u003cspan class=\"n\"\u003estore\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eX509Store\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStoreName\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMy\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStoreLocation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentUser\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOpenFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReadOnly\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eX509Certificate2Collection\u003c/span\u003e \u003cspan class=\"n\"\u003ecertificateCollection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCertificates\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eX509FindType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFindByThumbprint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecertificateThumbprint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecertificateCollection\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ecertificateCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Certificate not installed in the store\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003ecertificate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecertificateCollection\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efinally\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eclientAssertionCertificate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eClientAssertionCertificate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eapplicationId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecertificate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eauthenticationContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAcquireTokenAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eclientAssertionCertificate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAccessToken\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecretIdentifier\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"https://spikekey.vault.azure.net/secrets/SomeSecret/\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSecretAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esecretIdentifier\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"Secret is \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003esecret\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpStatusCode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBadRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Please store a secret\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpStatusCode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOK\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Secret is \"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eテスト実行するとうまく動いています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/42d7b29224a37323393bfe48f3e548d8967d3f7b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f36343338336636332d383764632d646631622d663761622d6131393831643939313938392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F64383f63-87dc-df1b-f7ab-a1981d991989.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f4e3aaf96acf0358a244c144ef7f268c\" alt=\"AF07.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/64383f63-87dc-df1b-f7ab-a1981d991989.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F64383f63-87dc-df1b-f7ab-a1981d991989.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f81e5501437efd48de11c2f7e8f56c26 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eお疲れさまでした。明日はこれをテストしやすいようにして実装して終了です。\u003c/p\u003e\n","createdAt":"2017-07-27T06:08:41Z","elapsedYearsFromLastModifiedAt":4,"encryptedId":"BHUcqz6PUMz0IYg3YFhJgMHTH8L1aTLn--6zzVwOL2WkmvFK43--TFYpgvH6qSe5tY3cIFkupg==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2017-07-27T06:08:41Z","likesCount":11,"linkUrl":"https://qiita.com/TsuyoshiUshio@github/items/8ac6cffe0fe923abf7cc","organization":null,"originalId":511509,"stockedCount":11,"title":"Azure Functions と KeyVault を連携させてみる","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1-keyvault-%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e1. KeyVault の作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2-keyvault-%E3%81%B8%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88\"\u003e2. KeyVault へのデータのセット\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3-service-principle-password-%E3%81%A7-keyvault-%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B\"\u003e3. Service Principle (password) で KeyVault に接続する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#31-service-principle-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e3.1. Service Principle を作成する。\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#311-%E4%B9%85%E3%80%85%E3%81%ABazure-%E6%97%A7-portal-%E3%81%8B%E3%82%89-service-principle-%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e3.1.1. 久々に、Azure 旧 Portal から Service Principle を作ってみる。\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4-service-principle-certificate-%E3%81%A7-keyvault-%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B\"\u003e4. Service Principle (certificate) で KeyVault に接続する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#41-winodws-sdk-%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89\"\u003e4.1. Winodws SDK のダウンロード\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#42-private-key-%E3%81%A8-certificate-%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B\"\u003e4.2. Private Key と、 Certificate を作成する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#43-pfx-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE-azure-functions-%E3%81%B8%E3%81%AE%E7%99%BB%E9%8C%B2\"\u003e4.3. pfx ファイルの Azure Functions への登録\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#43-service-principle-%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e4.3. Service Principle の作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#44-website_load_certificates-%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003e4.4. WEBSITE_LOAD_CERTIFICATES 環境変数の設定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#45-azure-functions-%E3%82%92-portal-%E3%81%A7%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e4.5. Azure Functions を Portal で作ってみる。\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":5006,"uuid":"8ac6cffe0fe923abf7cc","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"LG+yRji3aO0kPcp9GE5BXWI0lw==--UVkssXC3w3pWN7tk--YRtGtpG5olBKjSBlwR+EaA==","originalId":3470,"description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","facebookUrl":null,"githubUrl":"https://github.com/TsuyoshiUshio","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"Ushio Tsuyoshi","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=f09fda0ad182a04e6357e901c2c45fb7","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","urlName":"TsuyoshiUshio@github","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Azure","urlName":"azure"},{"name":"AzureFunctions","urlName":"azurefunctions"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
