<!DOCTYPE html><html><head><meta charset="utf-8" /><title>[ASP.NET]多層システムにおけるDbContextのバケツリレーをDIコンテナで解消する - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/jun1s/items/484cb55e7b6023e8fd23" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="qvEWH3MLo6kzXdglJkSv8sVNdYN9nHglfO/F80gNqad5/hWyFtDLbi0BIiJlyZALlWFeN/lJCCyV+ovtdGcnmQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@jun1s" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="[ASP.NET]多層システムにおけるDbContextのバケツリレーをDIコンテナで解消する - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XMEZUVUM1T1JWUmQ1YVNhNWJHazQ0SzM0NEs1NDRPRzQ0T2c0NEdyNDRHSzQ0R1I0NEtMUkdKRGIyNTBaWGgwNDRHdTQ0T1E0NEt4NDRPRTQ0T3E0NE9zNDRPODQ0S1NSRW5qZ3JQamc3UGpnNGJqZzRyamdhZm9wNlBtdG9qamdabmpnb3MmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZTlmMzBlMDEzYjFlNjEwNzk2OTk0Zjc1Njc1NThiYzg&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3AxYmpGeiZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTVjNzg1Nzg4ZDY1ODM1OTk1OTAxMDFmNjk2Y2I1ZTZk&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=22b71b6728b1a6989ef9e7a3a625aecf"><meta property="og:description" content="

はじめに

基本、自分用のメモです。

多層システムで構築されたウェブアプリケーションにおいて、DbContextやLoginInfoのようなリクエスト毎に生成・破棄し、全体で共有するオブジェクトを誰が生成し誰が破棄する責務をもつ..."><meta content="https://qiita.com/jun1s/items/484cb55e7b6023e8fd23" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="VB.Net,C#,ASP.NET,DI,ASP.NET_Core" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-76aee532-788e-486f-a44c-ca6b20899be4"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fjun1s%2Fitems%2F484cb55e7b6023e8fd23">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fjun1s%2Fitems%2F484cb55e7b6023e8fd23">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-76aee532-788e-486f-a44c-ca6b20899be4">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/vb.net","name":"VB.Net"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2021-08-03T22:11:18.000+09:00","dateModified":"2021-09-03T13:10:28.000+09:00","headline":"[ASP.NET]多層システムにおけるDbContextのバケツリレーをDIコンテナで解消する","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1XMEZUVUM1T1JWUmQ1YVNhNWJHazQ0SzM0NEs1NDRPRzQ0T2c0NEdyNDRHSzQ0R1I0NEtMUkdKRGIyNTBaWGgwNDRHdTQ0T1E0NEt4NDRPRTQ0T3E0NE9zNDRPODQ0S1NSRW5qZ3JQamc3UGpnNGJqZzRyamdhZm9wNlBtdG9qamdabmpnb3MmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZTlmMzBlMDEzYjFlNjEwNzk2OTk0Zjc1Njc1NThiYzg\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3AxYmpGeiZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTVjNzg1Nzg4ZDY1ODM1OTk1OTAxMDFmNjk2Y2I1ZTZk\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=22b71b6728b1a6989ef9e7a3a625aecf","mainEntityOfPage":"https://qiita.com/jun1s/items/484cb55e7b6023e8fd23","author":{"@type":"Person","address":"Echizen-shi, Fukui, Japan","email":null,"identifier":"jun1s","name":"jun1s","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F207038%2Fprofile-images%2F1626694207?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=d32024917eddb4431b54a590dd0309cd","url":"https://qiita.com/jun1s","description":"福井県越前市在住のプログラマーです。\r\n主にマイクロソフト系の技術者であり、javascript系のweb技術もフォローしています。\r\nVB.NET、C#、ASP.NET MVC(.NET Framework 又は.NET 5)の新規開発、古いVB資産の最新システムへのリプレース案件等を得意としています。\r\nお仕事の依頼や開発チームへの参加要請がありましたらお気軽にご連絡下さい。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita&amp;utm_medium=header-banner">LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"jun1s","type":"items","id":"484cb55e7b6023e8fd23"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから","url":"https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"jun1s","type":"items","id":"484cb55e7b6023e8fd23"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから","url":"https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"jun1s","type":"items","id":"484cb55e7b6023e8fd23"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから","url":"https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/jun1s/items/484cb55e7b6023e8fd23","location":"/jun1s/items/484cb55e7b6023e8fd23","scheme":"https","host":"qiita.com","port":null,"pathname":"/jun1s/items/484cb55e7b6023e8fd23","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"NAfodKqu7cdr+Mo5qe21emGa9pSe532YtsWRjEv0HAnnCOvZz3WFAHWkMD7qYIqDMbbdIBoyDZFf0N+Sd56SNw==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-b2a4b1ef-ed0b-4fe4-ae79-58618f0e217a"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/jun1s/items/484cb55e7b6023e8fd23/likers" class="css-1iupg5d">6</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">9</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/484cb55e7b6023e8fd23/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/jun1s/items/484cb55e7b6023e8fd23/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/jun1s/items/484cb55e7b6023e8fd23/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/jun1s/items/484cb55e7b6023e8fd23/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/jun1s/items/484cb55e7b6023e8fd23.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/jun1s"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/207038/profile-images/1626694207" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/jun1s" class="css-10ougpm">@<!-- -->jun1s</a><div class="css-1ay9vb9"><span><meta content="2021-08-03T13:11:18Z"/><time dateTime="2021-09-03T04:10:28Z" class="css-m19uds">updated at 2021-09-03</time></span></div></div></div></div></div><h1 class="css-cgzq40">[ASP.NET]多層システムにおけるDbContextのバケツリレーをDIコンテナで解消する</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/vb.net" class="css-4czcte">VB.Net</a><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/asp.net" class="css-4czcte">ASP.NET</a><a href="/tags/di" class="css-4czcte">DI</a><a href="/tags/asp.net_core" class="css-4czcte">ASP.NET_Core</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>基本、自分用のメモです。</p>

<p>多層システムで構築されたウェブアプリケーションにおいて、DbContextやLoginInfoのような<strong>リクエスト毎に生成・破棄し、全体で共有するオブジェクト</strong>を誰が生成し誰が破棄する責務をもつのか、またそれらを各オブジェクトがどこから取得するのかという問題を、<strong>DI（依存性オブジェクトの注入）</strong>を使って解決する、という記事になります。</p>

<p>既にDIを使い倒している方には今更な内容かと思いますが、私のように古いシステムのメンテナンスをしていた人には有用かと思います。</p>

<h1>
<span id="この記事をかいた理由" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E3%81%8B%E3%81%84%E3%81%9F%E7%90%86%E7%94%B1"><i class="fa fa-link"></i></a>この記事をかいた理由</h1>

<p>ASP.NETでDIコンテナ使ってDbContextを注入するサンプルをいくら検索しても、ControllerでDbContextを受け取っていきなりそこでDBにアクセスする初歩的な実装例しか出てこなくて、「<strong>コントローラでDB層にアクセスするとか、そんないい加減なシステムがあってたまるか！</strong> 普通データアクセス層はコントローラから隠蔽されてるだろ！！ DAO層にどうやってDbContextを注入するのか知りたいんだよ！ DIコンテナ使ったことないからわかんねぇんだよ…ｳｯｳｯ」と<strong>嗚咽を漏らしながら</strong>海外のブログ記事などを読み漁った結果、「こうするのかな？」ということは分かったのですが、同じように悩んでる人はいるかもしれないと、自分でこの記事をまとめるに至りました。</p>

<h1>
<span id="この記事でわかること" class="fragment"></span><a href="#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E3%82%8F%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8"><i class="fa fa-link"></i></a>この記事でわかること</h1>

<ul>
<li>DIコンテナを使わない昔の多層システムでどういう課題があったか</li>
<li>ASP.NET Coreの標準DIコンテナで、どうその課題を解決するか</li>
<li>ASP.NET(無印) でDIコンテナ「AutoFac」を使って同じことをする為の情報</li>
<li>おまけで、トランザクションスクリプトの話</li>
<li>おまけで、オブジェクトマッパー「Mapster」の話</li>
</ul>

<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p>ASP.NET MVC 5を使って何年も前に構築されたシステムをなるべく最新の環境でリプレースしていくにあたり、それまで課題だった部分を解決していきます。ASP.NET Core と、ASP.NET無印に両対応しています。</p>

<p>ASP.NETのソースコードはVB.NETですが、ASP.NET CoreのサンプルはC#になっています。</p>

<h1>
<span id="現在の構成" class="fragment"></span><a href="#%E7%8F%BE%E5%9C%A8%E3%81%AE%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>現在の構成</h1>

<p>対象となるソリューションは、ASP.NET MVC 5、データアクセス層とビジネスロジック層を分離する為に以下の多層構造を取っており、Entity Framework 6(EF6)のDbContextの生成と破棄の責務をどうするかという問題を抱えています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre><code>Controller -&gt; Logic -&gt; DAO(Data Access Object) -&gt; EF6 or SQL
</code></pre></div></div>

<p>EF6のDbContextは、EF6のツールによって既存のDBから自動生成されたものです。</p>

<p>規定のコンストラクタでconfigファイルから接続文字列名(以下の例では"MyDbContext")経由で接続文字列を取得するようになっており、例えばテスト用のDBに接続先を切り替えたい場合には、Debug用の環境設定を用意することで、コードを修正せずに対応できるようになっています。</p>

<div class="code-frame" data-lang="vb">
<div class="code-lang"><span class="bold">MyDbContext.vb</span></div>
<div class="highlight"><pre><code><span class="k">Partial</span> <span class="k">Public</span> <span class="k">Class</span> <span class="nc">MyDbContext</span>
    <span class="k">Inherits</span> <span class="n">DbContext</span>

    <span class="k">Public</span> <span class="k">Sub</span> <span class="nf">New</span><span class="p">()</span>
        <span class="k">MyBase</span><span class="p">.</span><span class="n">New</span><span class="p">(</span><span class="s">"name=MyDbContext"</span><span class="p">)</span>
    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Public</span> <span class="k">Overridable</span> <span class="k">Property</span> <span class="nf">Employee</span> <span class="ow">As</span> <span class="n">DbSet</span><span class="p">(</span><span class="k">Of</span> <span class="n">Employee</span><span class="p">)</span>
    <span class="p">:</span>

</code></pre></div>
</div>

<p>DbContextはDAO内でしか利用せず、Logic層からは隠ぺいする為、DAOクラスのメンバ変数としてDbContextを持ち、DAOクラスが生成された時に一緒にDbContextが生成される、という作りになっています。</p>

<div class="code-frame" data-lang="vb">
<div class="code-lang"><span class="bold">P101Dao.vb</span></div>
<div class="highlight"><pre><code><span class="k">Public</span> <span class="k">Class</span> <span class="nc">P101Dao</span>
    <span class="k">Private</span> <span class="n">db</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">MyDbContext</span>   <span class="c1">' MyDbContextの生成を各Daoが受け持つ</span>

    <span class="k">Public</span> <span class="k">Function</span> <span class="nf">GetEmployees</span><span class="p">()</span> <span class="ow">As</span> <span class="n">List</span><span class="p">(</span><span class="k">Of</span> <span class="n">EmployeeDto</span><span class="p">)</span>
        <span class="k">Return</span> <span class="n">db</span><span class="p">.</span><span class="n">Employee</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="err">条件</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span>
            <span class="k">Function</span><span class="err">(</span><span class="nf">row</span><span class="p">)</span> <span class="k">New</span> <span class="n">EmployeeDto</span> <span class="k">With</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">EmpId</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">EmpId</span>
                <span class="p">.</span><span class="n">EmpName</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">EmpName</span>
                 <span class="p">:</span>
            <span class="p">}).</span><span class="n">ToList</span><span class="p">()</span>
    <span class="k">End</span> <span class="k">Function</span>

</code></pre></div>
</div>

<p>そして、ControllerがアクションメソッドからLogicを生成し、処理を委譲します。LogicはDAOからDTOとしてデータを取得し、ViewModelに転写して返します。</p>

<div class="code-frame" data-lang="vb">
<div class="code-lang"><span class="bold">P101Controller.vb</span></div>
<div class="highlight"><pre><code><span class="k">Public</span> <span class="k">Class</span> <span class="nc">P101Controller</span>
    <span class="k">Inherits</span> <span class="n">Controller</span>

    <span class="k">Public</span> <span class="k">Function</span> <span class="nf">EmployeeList</span><span class="p">()</span> <span class="ow">As</span> <span class="n">ActionResult</span>
        <span class="k">Dim</span> <span class="nv">logic</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">P101Logic</span>
        <span class="k">Dim</span> <span class="nv">viewmodel</span> <span class="o">=</span> <span class="n">logic</span><span class="p">.</span><span class="n">GetEmployees</span><span class="p">()</span>
        <span class="k">Return</span> <span class="n">View</span><span class="p">(</span><span class="n">viewmodel</span><span class="p">)</span>
    <span class="k">End</span> <span class="k">Function</span>
<span class="k">End</span> <span class="k">Class</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="vb">
<div class="code-lang"><span class="bold">P101Logic.vb</span></div>
<div class="highlight"><pre><code><span class="k">Public</span> <span class="k">Class</span> <span class="nc">P101Logic</span>
    <span class="k">Public</span> <span class="k">Function</span> <span class="nf">GetEmployees</span><span class="p">()</span> <span class="ow">As</span> <span class="n">List</span><span class="p">(</span><span class="k">Of</span> <span class="n">EmployeeViewModel</span><span class="p">)</span>
        <span class="k">Dim</span> <span class="nv">dao</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">P101Dao</span>
        <span class="k">Return</span> <span class="n">dao</span><span class="p">.</span><span class="n">GetEmployees</span><span class="p">().</span><span class="n">Select</span><span class="p">(</span>
            <span class="k">Function</span><span class="err">(</span><span class="nf">row</span><span class="p">)</span> <span class="k">New</span> <span class="n">EmployeeViewModel</span> <span class="k">With</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">EmpId</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">EmpId</span>
                <span class="p">.</span><span class="n">EmpName</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">EmpName</span>
                 <span class="p">:</span>
            <span class="p">}).</span><span class="n">ToList</span><span class="p">()</span>

    <span class="k">End</span> <span class="k">Function</span>
<span class="k">End</span> <span class="k">Class</span>
</code></pre></div>
</div>

<p>ロジック層がコントローラーに直接ViewModelを渡している部分などは気になる方もいらっしゃるかと思うのですが、今回はMVCアーキテクチャで、画面側ではこのViewModelをJSON形式で受け取った上でjavascriptライブラリを利用して画面を構築・処理しており、ここで渡されるViewModelはUIに直接依存するというよりは、ビジネスドメインの外部との入出力DTOに近いものです。問題が無いとは言えませんが、そもそもトランザクションスクリプトで作られていますし、落としどころとしては妥当かと思います。</p>

<p>Controllerはほぼ、入力をLogicに渡して出力されるViewModelをView（*.vbhtml）に渡すのみとなっています。<br>
処理の多くはLogicとDaoが中心となり、Logicはビジネスロジックというよりは、DBに依存する部分をDAOに移した残りという感じです。</p>

<h1>
<span id="トランザクションスクリプトアーキテクチャ余談" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E4%BD%99%E8%AB%87"><i class="fa fa-link"></i></a>トランザクションスクリプト・アーキテクチャ（余談）</h1>

<p>対象となるシステムは、ドメインモデルではなくトランザクションスクリプトというアーキテクチャを採用しています。トランザクションスクリプトとは、トランザクション単位で設計を行う、オブジェクト指向設計とは異なる考え方のアーキテクチャです。</p>

<p>ですので、Logic層は基本的に状態を持たず、逆にモデルはフィールドのみ、つまりDTO(Data Transfer Object)としての役割しか持っていません。</p>

<p>余談になりますが、最初私は、このシステムでオブジェクト指向設計が成されていない事に落胆しました。しかしメンテナンスしていくにつれて、トランザクションスクリプト・アーキテクチャが徹底されたこの構成にも利点はあるのだと理解するに至りました。</p>

<p>トランザクションスクリプト・アーキテクチャでは、View-&gt;Controller-&gt;Logic-&gt;Daoという流れが全て一本道で独立して一貫しており、適切な画面IDを用いてクラス名を管理すれば、ある画面の変更がどのLogicやDaoに関係するのかが一目でわかります。つまりP101Viewの修正は、P101LogicやP101Daoにのみ影響し、その逆もまたしかり、ということです。システムはシンプルな縦割りの階層構造をなしており、横の連携はほぼ起きません。</p>

<p>ですので、初めてそのシステムをメンテナンスする人も、その画面IDがついた各層のクラスだけ見ていけばよく、処理の流れも把握しやすいのです。</p>

<p>縦割りの弊害として、トランザクションスクリプトで良く言われる「処理の重複」については実際に発生しており、これがメンテナンス性の低下を引き起こしていることは否めません。また、ビジネスドメインという視点で機能が分割されていない為、ある業務仕様の変更がどのLogicに影響しているのか把握するのは困難です（トランザクションスクリプトにおいてビジネスドメインに最も似ているのはDBのテーブル構成である為、テーブル名や列名でソース全文検索を行い、検出されたDAOから遡って画面への影響範囲を調べます）。これはビジネスドメインのコア部分の変更時ほど顕著で、トランザクションスクリプトの大きな欠点だと思います。</p>

<p>もしドメインモデルで設計されていたならば、このビジネスドメインの変更はたった一か所の変更で済んだだろうに、と思うことはよくあります。</p>

<p>しかし、それを差し引いても、「画面単位」、良く言えばユースケース単位で設計されたシステムを機械的に実装に落とし込む手法として、トランザクションスクリプト・アーキテクチャのシンプルな考え方は優れているように思います。この方法ならば、難易度の高いオブジェクト指向モデリングに精通した人材がいなくとも、誰でもシステムを構築し、メンテナンスしていけると思います。安価で安全確実、というわけです。</p>

<p>但し、やはりトランザクションスクリプトは、他のシステムに応用が利かない「その場限りのコード」が大量に生産されがちです。前述の通り機能の重複も多く、システムが大きくなればなるほどこの重複部分の修正漏れのリスクが増大し、システムの修正はしにくくなっていきます。処理の流れが分かりやすいとは書きましたが、あくまでも「その流れでの処理」について分かるだけで、システム全体として何がしたいのかは、いつまで経ってもコードから読み取ることはできません。</p>

<p>個人的には、オブジェクト指向モデリングに精通した人材を確保した上で、ドメインモデル・アーキテクチャを採用した方が、システムが長期に渡って再利用できる「資産」になりうるとは思います。</p>

<p>以上、余談でした。</p>

<h1>
<span id="現在の課題" class="fragment"></span><a href="#%E7%8F%BE%E5%9C%A8%E3%81%AE%E8%AA%B2%E9%A1%8C"><i class="fa fa-link"></i></a>現在の課題</h1>

<p>DAOが個別にDbContextの生成を行っている為、以下の問題点があります。</p>

<ol>
<li>複数のDaoを同時に利用した場合、無駄にDbContextが生成される</li>
<li>複数のDaoをまたいだトランザクション管理ができない（UnitOfWorkの実現が面倒）</li>
<li>DbContextのDisposeがGC任せになっており非効率</li>
</ol>

<p>1.については、リソース管理がシビアでなければ問題とはならない（実際、現在の運用では特に問題になっていない）のですが、2.は割と面倒で、そのような場合には単一のDbContextインスタンスを各DAOにコンストラクタ経由で渡すようにしなければなりません。そして、そのコンストラクタにDbContextを生成して渡す責務は誰が追うのかというと、また別の上位のDAOクラスとなります（UnitOfWork的な役割のクラスです）。</p>

<p>その場合、「今利用しているDbContextは誰が責務を負っているのか」という問題が常に付きまとい、無用なバグの温床になりかねません。</p>

<p>このうち 3.については、DAOクラスおよびLogicクラスをDisposableにして、ControllerのDispose()が呼びされた時にDbContextのDisposeを確実に呼び出すようにするという方法もあります（ControllerのDispose()は、URLのレスポンスが返った後に必ず呼び出されます）。しかし、いちいちDisposeの連鎖を作るのは正直しんどいわけです。</p>

<h1>
<span id="解決方法" class="fragment"></span><a href="#%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>解決方法（？）</h1>

<div class="note info">
<span class="fa fa-fw fa-check-circle"></span><p>DbContextをControllerで生成し、そこから呼び出す各オブジェクトへとコンストラクタ経由でdbcontextのインスタンスを伝搬させていく（DbContextのバケツリレー）。DbContextの生成と破棄をControllerの責務とする。
</p>
</div>

<p>具体的には次のような感じです。</p>

<div class="code-frame" data-lang="vb">
<div class="code-lang"><span class="bold">P101Controller.vb</span></div>
<div class="highlight"><pre><code><span class="k">Public</span> <span class="k">Class</span> <span class="nc">P101Controller</span>
    <span class="k">Inherits</span> <span class="n">Controller</span>

    <span class="k">Private</span> <span class="n">db</span> <span class="ow">As</span> <span class="n">MyDbContext</span>

    <span class="k">Public</span> <span class="k">New</span> <span class="k">Sub</span><span class="err">()</span>
        <span class="nf">db</span> <span class="o">=</span> <span class="k">New</span> <span class="n">MyDbContext</span>
    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Public</span> <span class="k">Function</span> <span class="nf">EmployeeList</span><span class="p">()</span> <span class="ow">As</span> <span class="n">ActionResult</span>
        <span class="k">Dim</span> <span class="nv">logic</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">P101Logic</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">Dim</span> <span class="nv">viewmodel</span> <span class="o">=</span> <span class="n">logic</span><span class="p">.</span><span class="n">GetEmployees</span><span class="p">()</span>
        <span class="k">Return</span> <span class="n">View</span><span class="p">(</span><span class="n">viewmodel</span><span class="p">)</span>
    <span class="k">End</span> <span class="k">Function</span>

    <span class="k">Public</span> <span class="k">Sub</span> <span class="nf">Dispose</span><span class="p">()</span> <span class="k">Implements</span> <span class="n">IDisposable</span><span class="p">.</span><span class="n">Dispose</span>
        <span class="n">db</span><span class="p">.</span><span class="n">Dispose</span><span class="p">()</span>
    <span class="k">End</span> <span class="k">Sub</span> 

<span class="k">End</span> <span class="k">Class</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="vb">
<div class="code-lang"><span class="bold">P101Logic.vb</span></div>
<div class="highlight"><pre><code><span class="k">Public</span> <span class="k">Class</span> <span class="nc">P101Logic</span>
    <span class="k">Private</span> <span class="n">db</span> <span class="ow">As</span> <span class="n">MyDbContext</span>
    <span class="k">Public</span> <span class="k">Sub</span> <span class="nf">New</span><span class="p">(</span><span class="n">pdb</span> <span class="ow">As</span> <span class="n">MyDbContext</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">pdb</span>
    <span class="k">End</span> <span class="k">Sub</span>

    <span class="k">Public</span> <span class="k">Function</span> <span class="nf">GetEmployees</span><span class="p">()</span> <span class="ow">As</span> <span class="n">List</span><span class="p">(</span><span class="k">Of</span> <span class="n">EmployeeViewModel</span><span class="p">)</span>
        <span class="k">Dim</span> <span class="nv">dao</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">P101Dao</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">Return</span> <span class="n">dao</span><span class="p">.</span><span class="n">GetEmployees</span><span class="p">().</span><span class="n">Select</span><span class="p">(</span>
            <span class="k">Function</span><span class="err">(</span><span class="nf">row</span><span class="p">)</span> <span class="k">New</span> <span class="n">EmployeeViewModel</span> <span class="k">With</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">EmpId</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">EmpId</span>
                <span class="p">.</span><span class="n">EmpName</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">EmpName</span>
                 <span class="p">:</span>
            <span class="p">}).</span><span class="n">ToList</span><span class="p">()</span>

    <span class="k">End</span> <span class="k">Function</span>
<span class="k">End</span> <span class="k">Class</span>
</code></pre></div>
</div>

<p>P101Daoの実装までは書きませんが、P101Daoも、コンストラクタで渡されたdbを内部でそのまま使うようになります。これで、DbContextのインスタンスはリクエスト毎に1つとなり、トランザクション管理もＯＫ、生成と破棄についても、Controllerに任せておけば安心、という事になります。</p>

<p>ただ、ここで一つ問題があります。</p>

<div class="note warn">
<span class="fa fa-fw fa-exclamation-circle"></span><p>ControllerやLogicがMyDbContextに依存するようになっている
</p>
</div>

<p>本来、ControllerやLogicはdbを意識する必要はありません。ここで無駄な依存関係が発生してしまうと、もし将来DBの変更が起こった時、いちいちControllerやLogicまで影響を受けてしまいますし、下手をすると、よくわかっていない開発者が「コントローラーでDbContextを触れるじゃないか。じゃあ直接ここでDBにアクセスしちゃおう」と考えかねません。</p>

<h1>
<span id="aspnet-core-ではdiを使って解決できる" class="fragment"></span><a href="#aspnet-core-%E3%81%A7%E3%81%AFdi%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E8%A7%A3%E6%B1%BA%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>ASP.NET Core ではDIを使って解決できる</h1>

<p>調べていくと、ASP.NET CoreではDIコンテナがフレームワークとして用意されており、これを使って解決できるようです。</p>

<p>DIとは依存性注入(dependency injection)の略で、あるクラスが依存している別のオブジェクトの生成と破棄を、DIコンテナにお任せしてしまおう、というものです。ですので、DIコンテナを使いたい場合には、もうNew MyDbContextとは書きません。MyDbContextのインスタンスは常に外部から与えてもらうようにします。</p>

<p>DIコンテナについては、登場当時から便利だという話は聞いていたものの、これまでDIコンテナを使ったシステムに携わったことがなく、どのようにして使うのか、改めて調べてみました。</p>

<p>検索すると、基本的にほとんどのサイトで次のようなサンプルコードがヒットします。<br>
（サンプルはC#のみでした。VB.NETは本当に消えゆく言語ですね）</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Startup.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="nf">AddControllers</span><span class="p">();</span>

    <span class="n">services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;(</span>
        <span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlServer</span><span class="p">(</span><span class="s">"name=ConnectionStrings:DefaultConnection"</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">P101Controller.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">P101Controller</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MyDbContext</span> <span class="n">_context</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">P101Controller</span><span class="p">(</span><span class="n">MyDbContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>どういうことかというと、Controllerのインスタンス生成時に、Controllerのコンストラクタ引数のMyDbContextを、DIコンテナが自動的に生成して渡してくれるということです。コンストラクタ引数を全部生成してくれるわけではなく、Startupで指定した型（ここではMyDbContext）のみ、指定した具象型で生成して渡してくれます。</p>

<p>これは、ASP.NET Coreに搭載されているMicrosoft Dependency InjectionというDIコンテナの機能です。本来は、生成するオブジェクトのインタフェースのみを依存する側が参照し、そのインタフェースに対応する具象クラスをDIコンテナ側に設定してインスタンスを切り替えるという使い方が本筋かと思いますが、この記事では「インスタンスの生成と破棄の責務」のみをDIコンテナに委譲する目的で使う為、インタフェースは定義していません。</p>

<p>DbContextについてはAddDbContextという専用のDIコンテナへの追加メソッドが用意されていますが、例えばP101Logicをここに登録することもできます。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Startup.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="nf">AddControllers</span><span class="p">();</span>

    <span class="n">services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;(</span>
        <span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlServer</span><span class="p">(</span><span class="s">"name=ConnectionStrings:DefaultConnection"</span><span class="p">));</span>

    <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">P101Logic</span><span class="p">&gt;();</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">P101Dao</span><span class="p">&gt;();</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>AddTransient()は、Tで指定したクラスがControllerのコンストラクタ引数にあった場合に、「その都度」インスタンスを生成して渡してくれるというものです。</p>

<p>他にも、リクエスト毎に1つのインスタンスを生成してくれるAddScoped()や、システム全体で1つのインスタンスを渡してくれるAddSingleton()もあります。</p>

<p>DbContextのようにDisposableなものは、AddScopedでライフタイム管理をしたほうが良いでしょう。</p>

<p>ともかくも、こう書く事で、P101LogicとかP101Daoという型のパラメータがControllerのコンストラクタ引数にあれば、リクエストの際に自動的にDIコンテナがインスタンスを生成して渡してくれるようになりました。</p>

<p>依存性注入をされる側の各クラスは、次のようになります。コンストラクタ引数のツリー構造が形成されています。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">P101Controller.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">P101Controller</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">P101Logic</span> <span class="n">_logic</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">P101Controller</span><span class="p">(</span><span class="n">P101Logic</span> <span class="n">logic</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_logic</span> <span class="p">=</span> <span class="n">logic</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">P101Logic.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">P101Logic</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">P101Dao</span> <span class="n">_dao</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">P101Logic</span><span class="p">(</span><span class="n">P101Dao</span> <span class="n">dao</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_dao</span> <span class="p">=</span> <span class="n">dao</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">P101Dao.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">P101Dao</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">MyDbContext</span> <span class="n">_db</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">P101Dao</span><span class="p">(</span><span class="n">MyDbContext</span> <span class="n">db</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_db</span> <span class="p">=</span> <span class="n">db</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>P101Controllerに対するリクエストが発生した時、DIコンテナが裏で何をするかというと、こんな感じでしょうか。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="k">new</span> <span class="nf">P101Controler</span><span class="p">(</span>
    <span class="k">new</span> <span class="nf">P101Logic</span><span class="p">(</span>
        <span class="k">new</span> <span class="nf">P101Dao</span><span class="p">(</span>
            <span class="k">new</span> <span class="nf">MyDbContext</span><span class="p">(</span><span class="n">options</span><span class="p">))));</span>
</code></pre></div></div>

<p>マトリョーシカですね。<br>
見事に全てのオブジェクトが、自分が依存するインスタンスの生成責任を外部に丸投げしています。<br>
そして、その責任を一身に背負うのが、DIコンテナというわけです。</p>

<p>DIコンテナがP101ControllerのコンストラクタにP101Logicがあるのを見つけると、「P101LogicはDIコンテナで生成するんだったな」と、今度はP101Logicのコンストラクタ引数も見に行きます。そこにP101Daoがあるのを見つけて、「それも確かDIしろって言われてたな」と判断し、自動的に生成してくれるのです。</p>

<p>さらにはなんと、DIコンテナは、コンテナが生成したDisposableなインスタンス、例えばここではMyDbContextを、適切なタイミングでDisposeしてくれます。至れり尽くせりですね。</p>

<p>上記のP101Controllerを見てみると、MyDbContextへの依存が消えています。Logicへの依存のみとなり、すっきりしました。P101Logicもしかりです。</p>

<p>結果、各クラスに存在する依存性は、全て単一の場所（ここではStartup.cs）に集約されるようになりました。</p>

<p>また各クラスは単に自分に渡されるインスタンスを黙って使って、使いっぱなしにすればOKになりました。依存オブジェクトの管理という責務から解き放たれたわけです。</p>

<h1>
<span id="アクションメソッドに依存性注入する" class="fragment"></span><a href="#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E4%BE%9D%E5%AD%98%E6%80%A7%E6%B3%A8%E5%85%A5%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>アクションメソッドに依存性注入する</h1>

<p>しかし正直なところ、P101Controllerが使うlogicは、コンストラクタで受け取ってわざわざメンバ変数に格納しておくほどのスコープを必要としません。アクションメソッド単位で依存性の注入を行ってくれないものでしょうか？</p>

<p>調べると、ASP.NET Core ならそれも可能でした。アクションメソッドの引数に[FromServices]を付けると、DIコンテナがよきに計らってくれます。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">P101Controller.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">P101Controller</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">EmployeeList</span><span class="p">([</span><span class="n">FromServices</span><span class="p">]</span> <span class="n">P101Logic</span> <span class="n">_logic</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">viewmodel</span> <span class="p">=</span> <span class="n">_logic</span><span class="p">.</span><span class="nf">GetEmployees</span><span class="p">();</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">viewmodel</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>ただ、調べるとコンストラクタでの依存性注入の方が一般的で、メソッドへの注入はあまりメジャーではないようです。<br>
理由はテストのし易さのようです。コンストラクタでの注入にしておけばインスタンス生成のみをDIコンテナに任せておけばよいが、メソッドでの注入にするとメソッド呼び出しもDIコンテナ任せになって煩雑になる、ということのようです。</p>

<p>個人的にはそれでそこまで煩雑になるとも思いませんし、明らかに便利な技術だと思いますので、積極的に使っていきたいと思いました。</p>

<h1>
<span id="diコンテナを使えば複雑な依存性注入もシンプルに管理できる" class="fragment"></span><a href="#di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%BF%E3%81%88%E3%81%B0%E8%A4%87%E9%9B%91%E3%81%AA%E4%BE%9D%E5%AD%98%E6%80%A7%E6%B3%A8%E5%85%A5%E3%82%82%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AB%E7%AE%A1%E7%90%86%E3%81%A7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a>DIコンテナを使えば複雑な依存性注入もシンプルに管理できる</h1>

<p>ところで、MyDbContextだけだと、「別にDIコンテナなんて使わなくてもコンストラクタ経由で渡していけばいいのでは」と思うかもしれません。</p>

<p>しかし、共通のロジックやログイン情報など、システム全体で共有したいオブジェクトは結構あります。ログイン情報は通常、HttpContext.Sessionに保持しておくべきものかもしれませんが、かといって、LogicがHttpContextに依存するのは違うでしょう。それらはLogicの外部から渡される必要があります。ControllerはHttpContextへの依存を持っていておかしくありませんから、Controllerがその責務を負うのも良いと思いますが、定形的な処理になるので、そういうものの生成はどこか他のクラスにお願いしたいところです。</p>

<p>こういうものは共通関数やSingletonパターンを使ってどこからでも取得できるようにするのがDI以前のやり方だったかもしれませんが、そのやり方をするとテストが非常にしにくくなりますし、特定のシステムに依存した、移植性の低いコードになってしまいます。</p>

<p>ですから、これらも全てDIを使うやり方に切り替えていった方が良いでしょう。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Startup.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="nf">AddControllers</span><span class="p">();</span>

    <span class="n">services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;(</span>
        <span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlServer</span><span class="p">(</span><span class="s">"name=ConnectionStrings:DefaultConnection"</span><span class="p">));</span>

    <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">P101Logic</span><span class="p">&gt;();</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">CommonLogic</span><span class="p">&gt;();</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">LoginInfo</span><span class="p">&gt;();</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">P101Controller.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">P101Controller</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">EmployeeList</span><span class="p">([</span><span class="n">FromServices</span><span class="p">]</span> <span class="n">P101Logic</span> <span class="n">_logic</span><span class="p">,</span> <span class="p">[</span><span class="n">FromServices</span><span class="p">]</span> <span class="n">CommonLogic</span> <span class="n">_comlogic</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">viewmodel</span> <span class="p">=</span> <span class="n">_logic</span><span class="p">.</span><span class="nf">GetEmployees</span><span class="p">();</span>
        <span class="n">viewmodel</span><span class="p">.</span><span class="nf">SetColorConfig</span><span class="p">(</span><span class="n">_comlogic</span><span class="p">.</span><span class="nf">GetColorConfig</span><span class="p">());</span>
        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">viewmodel</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">P101Logic.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">P101Logic</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">P101Dao</span> <span class="n">_dao</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">LoginInfo</span> <span class="n">_loginInfo</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">P101Logic</span><span class="p">(</span><span class="n">LoginInfo</span> <span class="n">loginInfo</span><span class="p">,</span> <span class="n">P101Dao</span> <span class="n">dao</span><span class="p">){</span>
        <span class="n">_dao</span> <span class="p">=</span> <span class="n">dao</span><span class="p">;</span>
        <span class="n">_loginInfo</span> <span class="p">=</span> <span class="n">loginInfo</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>こんな感じでどんどん依存性を外部に出していき、DIコンテナに生成と破棄の責任を担当して貰えば、各機能の独立性が向上し、テストもしやすくなることでしょう。</p>

<p>今回はAddTransientに直接具象クラスを指定していますが、インタフェースを定義して次のように指定すれば、テスト時にテスト用のドライバやスタブを使うのも簡単になります。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Startup.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="nf">AddControllers</span><span class="p">();</span>

    <span class="n">services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;(</span>
        <span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlServer</span><span class="p">(</span><span class="s">"name=ConnectionStrings:DefaultConnection"</span><span class="p">));</span>

    <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">IP101Logic</span><span class="p">,</span> <span class="n">P101Logic</span><span class="p">&gt;();</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">ICommonLogic</span><span class="p">,</span> <span class="n">CommonLogic</span><span class="p">&gt;();</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">ILoginInfo</span><span class="p">,</span> <span class="n">LoginInfo</span><span class="p">&gt;();</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h1>
<span id="aspnetcoreじゃない方ではどうするのか" class="fragment"></span><a href="#aspnetcore%E3%81%98%E3%82%83%E3%81%AA%E3%81%84%E6%96%B9%E3%81%A7%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>ASP.NET(Coreじゃない方)ではどうするのか</h1>

<p>ASP.NETには、ASP.NET CoreのようなDIコンテナが標準ではついていません。</p>

<p>今回の記事と同じことをするには、どのようなDIコンテナを導入すればよいでしょうか。</p>

<ul>
<li>Controllerのコントラクタに依存性注入ができる</li>
<li>Controllerのアクションメソッドに依存性注入ができる</li>
<li>インスタンスのライフサイクル管理方法として「リクエスト単位」「都度生成」が選べる</li>
<li>.NET Frameworkと.NET Core/5+両方に対応している。</li>
</ul>

<p>こんなところでしょうか。</p>

<p>調べてみると、<a href="https://autofac.org/" rel="nofollow noopener" target="_blank">AutoFac</a>というDIコンテナが上記全てに対応しており、利用者も多く、メンテナンスも活発のようです。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">global.asax</span></div>
<div class="highlight"><pre><code><span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ContainerBuilder</span><span class="p">();</span>

  <span class="c1">// Register your MVC controllers. (MvcApplication is the name of</span>
  <span class="c1">// the class in Global.asax.)</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">RegisterControllers</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">MvcApplication</span><span class="p">).</span><span class="n">Assembly</span><span class="p">);</span>

  <span class="c1">// OPTIONAL: Register model binders that require DI.</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">RegisterModelBinders</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">MvcApplication</span><span class="p">).</span><span class="n">Assembly</span><span class="p">);</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">RegisterModelBinderProvider</span><span class="p">();</span>

  <span class="c1">// OPTIONAL: Register web abstractions like HttpContextBase.</span>
  <span class="n">builder</span><span class="p">.</span><span class="n">RegisterModule</span><span class="p">&lt;</span><span class="n">AutofacWebTypesModule</span><span class="p">&gt;();</span>

  <span class="c1">// OPTIONAL: Enable property injection in view pages.</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">RegisterSource</span><span class="p">(</span><span class="k">new</span> <span class="nf">ViewRegistrationSource</span><span class="p">());</span>

  <span class="c1">// OPTIONAL: Enable property injection into action filters.</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">RegisterFilterProvider</span><span class="p">();</span>

  <span class="c1">// OPTIONAL: Enable action method parameter injection (RARE).</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">InjectActionInvoker</span><span class="p">();</span>

  <span class="c1">// Set the dependency resolver to be Autofac.</span>
  <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
  <span class="n">DependencyResolver</span><span class="p">.</span><span class="nf">SetResolver</span><span class="p">(</span><span class="k">new</span> <span class="nf">AutofacDependencyResolver</span><span class="p">(</span><span class="n">container</span><span class="p">));</span>
<span class="p">}</span>

</code></pre></div>
</div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;().</span><span class="nf">InstancePerLifetimeScope</span><span class="p">();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">P101Logic</span><span class="p">&gt;().</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IP101Logic</span><span class="p">&gt;();</span>
<span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">LoginInfo</span><span class="p">&gt;()</span> 
</code></pre></div></div>

<p>AutoFacをASP.NET Coreで使う方法については、以下の英語記事が参考になりそうです。<br>
<a href="https://danylomeister.blog/2021/01/31/tips-on-using-autofac-in-net-core-3-x/" rel="nofollow noopener" target="_blank">Tips on using Autofac in .NET Core 3.x</a></p>

<h1>
<span id="その他の懸念事項" class="fragment"></span><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%87%B8%E5%BF%B5%E4%BA%8B%E9%A0%85"><i class="fa fa-link"></i></a>その他の懸念事項</h1>

<h2>
<span id="diコンテナの初期化処理の増大" class="fragment"></span><a href="#di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96%E5%87%A6%E7%90%86%E3%81%AE%E5%A2%97%E5%A4%A7"><i class="fa fa-link"></i></a>DIコンテナの初期化処理の増大</h2>

<p>システムが膨大になってくると、これらのクラスを全てDIコンテナに登録していくのはかなり大変です。<br>
Logicが百個近くなってくると、新しいLogicの登録し忘れなども起きてくるでしょう。<br>
複数人で開発している場合、Git等のチーム開発において、単一のファイルを全員で編集することになり、コンフリクトの発生率も上がってしまいます。</p>

<p>調べると、AutoFacにはRegisterAssemblyTypes(asm)というメソッドが用意されており、例えば以下のように使うことで、指定したアセンブリに含まれる、DI対象のクラスをまとめて登録することができるようです（Microsoft Dependency Injectionには同等の機能を見つけられませんでしたが、恐らく外部ライブラリで対応できるものと思われます）。</p>

<p><a href="https://autofac.readthedocs.io/en/latest/register/scanning.html" rel="nofollow noopener" target="_blank">Assembly Scannin</a></p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="kt">var</span> <span class="n">dataAccess</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">();</span>

<span class="n">builder</span><span class="p">.</span><span class="nf">RegisterAssemblyTypes</span><span class="p">(</span><span class="n">dataAccess</span><span class="p">)</span>
       <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">EndsWith</span><span class="p">(</span><span class="s">"Logic"</span><span class="p">))</span>
       <span class="p">.</span><span class="nf">AsImplementedInterfaces</span><span class="p">();</span>
</code></pre></div></div>

<p>上記の処理は、現在実行中のアセンブリを取得し、その中に含まれる全てのパブリックなクラスのうち、クラス名が「"Logic"で終わるクラス全てについてDIコンテナに登録する、というものです。</p>

<p>DAOやLogicが別のプロジェクトにパッケージングされている場合には、<code>AppDomain.CurrentDomain.GetAssemblies()</code>を使って、アプリケーションドメインに読み込まれているすべてのアセンブリを取得し、このやり方でDIに登録することができるのではないかと思います（未確認）。</p>

<h2>
<span id="diコンテナへの依存を単一の場所に集約する" class="fragment"></span><a href="#di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%B8%E3%81%AE%E4%BE%9D%E5%AD%98%E3%82%92%E5%8D%98%E4%B8%80%E3%81%AE%E5%A0%B4%E6%89%80%E3%81%AB%E9%9B%86%E7%B4%84%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>DIコンテナへの依存を単一の場所に集約する</h2>

<p>DIコンテナへの依存部分は、ここでは「Startup.cs」のDIコンテナの初期化コードのことです。この場所に、今回DIコンテナを使用するにあたっての解決すべき依存性が全て記述されているようにしなければなりません。この単一の場所に、依存性を集約するのです。</p>

<p>例えば今回、P101Logicから使うDAOをP101Daoとしていますが、特定のメソッドがCommonDaoみたいな他のオブジェクトを必要とする場面はあるかもしれません。</p>

<p>その際には、P101LogicのコンストラクタにCommonDaoを追加します。もちろんDIコンテナの初期化にもservices.AddTransient();を追加します。</p>

<p>しかし、実は次のような事もできてしまいます。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">P101Logic.cs</span></div>
<div class="highlight"><pre><code><span class="k">public</span> <span class="k">class</span> <span class="nc">P101Logic</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">IServiceProvider</span> <span class="n">_serviceProvider</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">LoginInfo</span> <span class="n">_loginInfo</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">P101Logic</span><span class="p">(</span><span class="n">LoginInfo</span> <span class="n">loginInfo</span><span class="p">,</span> <span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">){</span>
        <span class="n">_serviceProvider</span> <span class="p">=</span> <span class="n">serviceProvider</span><span class="p">;</span>
        <span class="n">_loginInfo</span> <span class="p">=</span> <span class="n">loginInfo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">P101ViewModel</span> <span class="nf">GetSpecialInfo</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">CommonDao</span> <span class="n">comDao</span> <span class="p">=</span> <span class="n">_serviceProvider</span><span class="p">.</span><span class="nf">GetService</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CommonDao</span><span class="p">));</span>
        <span class="n">P101ViewModel</span> <span class="n">vm</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
        <span class="n">vm</span><span class="p">.</span><span class="n">UserLevel</span> <span class="p">=</span> <span class="n">comDao</span><span class="p">.</span><span class="nf">GetUserLevel</span><span class="p">(</span><span class="n">_loginInfo</span><span class="p">.</span><span class="n">UserId</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">vm</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>コンストラクタ引数で、DIコンテナのサービスプロバイダを受け取って、自らDIコンテナを操り、インスタンスを取得しています。Logic内で自由に好きなDaoをDIコンテナから取得できるので、柔軟性があって良いように思えます。</p>

<p>しかしこれは、Logicから依存性を排除するというそもそもの目的に反してDIコンテナにLogicを依存させてしまっている為、避けるべきやり方です。</p>

<p>別の言い方をするならば、依存性を注入される側は、自分が依存性注入されているという意識を持ってはいけないということです。依存オブジェクトは、あくまでも「ただコンストラクタから渡される」だけであり、DIコンテナなどなくてもテスト可能でなくてはなりません。</p>

<p>ちなみにこれを「サービスロケーターパターン」と呼び、依存性を注入するという目的に反する使い方である為、アンチパターンだといわれています。<br>
サービスロケーターパターンを使ってまでオブジェクトの生成をDIコンテナに任せたい場合、果たしてそこまでする価値があるのかよく考えるべきでしょう。</p>

<h2>
<span id="dtoオブジェクトの転写についてオブジェクトマッパーの利用" class="fragment"></span><a href="#dto%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E8%BB%A2%E5%86%99%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%83%9E%E3%83%83%E3%83%91%E3%83%BC%E3%81%AE%E5%88%A9%E7%94%A8"><i class="fa fa-link"></i></a>DTOオブジェクトの転写について（オブジェクトマッパーの利用）</h2>

<p>今回の記事には関係ありませんが、DTOオブジェクトの転写は毎回面倒だと思います。<br>
まったく同じプロパティならば、1行で全部転写してほしいものです。</p>

<div class="code-frame" data-lang="vb">
<div class="code-lang"><span class="bold">P101Dao.vb</span></div>
<div class="highlight"><pre><code><span class="k">Public</span> <span class="k">Class</span> <span class="nc">P101Dao</span>
    <span class="k">Private</span> <span class="n">db</span> <span class="ow">As</span> <span class="k">New</span> <span class="n">MyDbContext</span>

    <span class="k">Public</span> <span class="k">Function</span> <span class="nf">GetEmployees</span><span class="p">()</span> <span class="ow">As</span> <span class="n">List</span><span class="p">(</span><span class="k">Of</span> <span class="n">EmployeeDto</span><span class="p">)</span>
        <span class="k">Return</span> <span class="n">db</span><span class="p">.</span><span class="n">Employee</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="err">条件</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span>
            <span class="k">Function</span><span class="err">(</span><span class="nf">row</span><span class="p">)</span> <span class="k">New</span> <span class="n">EmployeeDto</span> <span class="k">With</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">EmpId</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">EmpId</span>
                <span class="p">.</span><span class="n">EmpName</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="n">EmpName</span>
                 <span class="p">:</span>
            <span class="p">}).</span><span class="n">ToList</span><span class="p">()</span>
    <span class="k">End</span> <span class="k">Function</span>

</code></pre></div>
</div>

<p>その為のライブラリとして有名なものに「<a href="https://automapper.org/" rel="nofollow noopener" target="_blank">AutoMapper</a>」があります。<br>
しかしこれは、マッピングする側とされる側のクラスを事前に登録してやる必要があります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="kt">var</span> <span class="n">config</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MapperConfiguration</span><span class="p">(</span><span class="n">cfg</span> <span class="p">=&gt;</span> <span class="n">cfg</span><span class="p">.</span><span class="n">CreateMap</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">,</span> <span class="n">OrderDto</span><span class="p">&gt;());</span>
</code></pre></div></div>

<p>これは正直面倒です。特に、多層システムとして複数のレイヤーに分割している場合、誰がこの登録処理の責務を負うのかという問題があります。プロパティのマッピングなどというものはソースコード上の問題であって、DLLの利用者にお願いしなければいけないようなものであってはならないでしょう。</p>

<p>かといって、上記の初期化処理をDLL側で責務を負って行うには、「アセンブリがロードされた時に行う初期化時処理」とでもいうようなものが存在しなければならず、これは.NETでは今のところまだ現実的ではないようです（「<a href="https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/proposals/csharp-9.0/module-initializers" rel="nofollow noopener" target="_blank">モジュール初期化子</a>」）。</p>

<p>現実的には、各DLL側にProfileクラスを継承したpublicな「初期化処理用のクラス」を用意し、そのクラスをアセンブリ参照を用いて生成する、という、結構面倒なやり方になるようです。（<a href="https://docs.automapper.org/en/latest/Configuration.html#profile-instances" rel="nofollow noopener" target="_blank">Assembly Scanning for auto configuration</a>）</p>

<p>どちらにせよ、使う側が予めこの処理を行わないとそのDLLが使えないとうのはあまり好ましくないと思います。また、同様の理由から、この初期化処理をDIコンテナを使って行うべきものでもないと感じます。</p>

<p>調べてみると、このあたりについて改善した、「<a href="https://github.com/MapsterMapper/Mapster" rel="nofollow noopener" target="_blank">Mapster</a>」というオブジェクトマッパーがあるようです。</p>

<p>初期化処理は不要で、いきなりこう書けます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="kt">var</span> <span class="n">destObject</span> <span class="p">=</span> <span class="n">sourceObject</span><span class="p">.</span><span class="n">Adapt</span><span class="p">&lt;</span><span class="n">Destination</span><span class="p">&gt;();</span>
</code></pre></div></div>

<p>TDestination .Adapt() の形式で使える拡張メソッドがObjectに対して定義されています。<br>
もちろん、マッピング時に細かい調整をすることもできます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="n">TypeAdapterConfig</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TDestination</span><span class="p">&gt;</span>
    <span class="p">.</span><span class="nf">NewConfig</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">Map</span><span class="p">(</span><span class="n">dest</span> <span class="p">=&gt;</span> <span class="n">dest</span><span class="p">.</span><span class="n">FullName</span><span class="p">,</span>
        <span class="n">src</span> <span class="p">=&gt;</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0} {1}"</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">FirstName</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">LastName</span><span class="p">));</span>
</code></pre></div></div>

<p>NewConfig()というのが面白くて、過去の設定を全てクリアするというものなので、常に「今、ここで設定したもの」以外の影響を受けない独立したコードが書けます。</p>

<p>ただ、やはりせっかくのConfigは一か所にまとめたいですよね。<br>
そんな場合には、以下の書き方ができそうです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="k">class</span> <span class="nc">MapperConfig</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">TypeAdapterConfig</span>  <span class="n">config</span><span class="p">;</span>

    <span class="k">static</span> <span class="nf">MapperConfig</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">MapperConfig</span><span class="p">.</span><span class="n">config</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TypeAdapterConfig</span><span class="p">();</span>
        <span class="n">MapperConfig</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="nf">ForType</span><span class="p">(</span><span class="n">Of</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Destination</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Map</span><span class="p">(</span>
                <span class="n">dest</span> <span class="p">=&gt;</span> <span class="n">dest</span><span class="p">.</span><span class="n">FullName</span><span class="p">,</span>
                <span class="n">src</span> <span class="p">=&gt;</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0} {1}"</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">FirstName</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">TypeAdapterConfig</span> <span class="n">Instance</span> <span class="p">=&gt;</span> <span class="n">config</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre><code><span class="kt">var</span> <span class="n">destObject</span> <span class="p">=</span> <span class="n">sourceObject</span><span class="p">.</span><span class="n">Adapt</span><span class="p">&lt;</span><span class="n">Destination</span><span class="p">&gt;(</span><span class="n">MapperConfig</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
</code></pre></div></div>

<p>MapperConfigクラスはモジュール内プライベートにしておいて、各モジュール内でこのconfigを使えば、モジュール内に閉じた形で運用できそうです。</p>

<h2>
<span id="本当に全ての依存関係をdiコンテナに任せられるか" class="fragment"></span><a href="#%E6%9C%AC%E5%BD%93%E3%81%AB%E5%85%A8%E3%81%A6%E3%81%AE%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%82%92di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AB%E4%BB%BB%E3%81%9B%E3%82%89%E3%82%8C%E3%82%8B%E3%81%8B"><i class="fa fa-link"></i></a>本当に全ての依存関係をDIコンテナに任せられるか？</h2>

<p>中には、条件に応じて異なるLogicに分岐をするようなケースもあるでしょう。そのような場合に、分岐の可能性のある全てのLogicのインスタンスをControllerのコンストラクタなりアクションメソッドなりに列挙するのでしょうか？</p>

<p>それともそういう場合には、Logicを集約する親Logicクラスを作ってそこにカプセル化する、などするのでしょうか。</p>

<p>DIコンテナを使うと、大元となる処理のエントリポイント（ASP.NETではController）を起点として、全てのインスタンスを一気に生成してオブジェクトの構造を作ってしまってから、処理を開始するようなイメージがあります。</p>

<p>しかし、中には処理の開始時には必要かどうか未定で、入力パラメータの条件によっては必要になるオブジェクト、というようなものもあるでしょう。</p>

<p>そういう場合には、ひょっとして遅延実行というか、オブジェクトを返す関数のみを注入したりして、必要な時はその関数を実行してインスタンスを得るような形にするのでしょうか。</p>

<p>この辺どうすべきなのかよくわからず少し不安なところはありますが、なんとかなるような気もします。</p>

<hr>

<p>以上、調べた内容をつらつらとまとめてみました。<br>
ある程度サンプルプロジェクトを作って動作を確かめていますが、想像で書いたコードも多い為、間違っていたらご指摘下さい。</p>

<p>また、そもそも考え方が違う、もっとこうした方がいいなどありましたら、ご教授頂ければ幸いです。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fjun1s%2Fitems%2F484cb55e7b6023e8fd23&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fjun1s%2Fitems%2F484cb55e7b6023e8fd23&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/jun1s/items/484cb55e7b6023e8fd23/likers" class="css-1iupg5d">6</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">9</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/484cb55e7b6023e8fd23/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/jun1s/items/484cb55e7b6023e8fd23/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/jun1s/items/484cb55e7b6023e8fd23/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/jun1s/items/484cb55e7b6023e8fd23/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/jun1s/items/484cb55e7b6023e8fd23.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-b2a4b1ef-ed0b-4fe4-ae79-58618f0e217a">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-0076ffe8-590a-4374-ad35-50ae566b4c67"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-0076ffe8-590a-4374-ad35-50ae566b4c67">{}</script>
      
<div id="LoginModal-react-component-abed8dcf-07c2-4f42-9315-3010ca92abfb"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-abed8dcf-07c2-4f42-9315-3010ca92abfb">{}</script>
      
<div id="StockModal-react-component-4f40c335-e631-46dc-82a4-54cd30f922d0"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-4f40c335-e631-46dc-82a4-54cd30f922d0">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;Md6w7dsqVE4/tQz5uypnQFwNtkK/PFH8+Nv8n47Mlzji0bNAvvE8iSHp9v74p1i5DCGd9jvpIfURzrKBsqYZBg==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003e基本、自分用のメモです。\u003c/p\u003e\n\n\u003cp\u003e多層システムで構築されたウェブアプリケーションにおいて、DbContextやLoginInfoのような\u003cstrong\u003eリクエスト毎に生成・破棄し、全体で共有するオブジェクト\u003c/strong\u003eを誰が生成し誰が破棄する責務をもつのか、またそれらを各オブジェクトがどこから取得するのかという問題を、\u003cstrong\u003eDI（依存性オブジェクトの注入）\u003c/strong\u003eを使って解決する、という記事になります。\u003c/p\u003e\n\n\u003cp\u003e既にDIを使い倒している方には今更な内容かと思いますが、私のように古いシステムのメンテナンスをしていた人には有用かと思います。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"この記事をかいた理由\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E3%81%8B%E3%81%84%E3%81%9F%E7%90%86%E7%94%B1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこの記事をかいた理由\u003c/h1\u003e\n\n\u003cp\u003eASP.NETでDIコンテナ使ってDbContextを注入するサンプルをいくら検索しても、ControllerでDbContextを受け取っていきなりそこでDBにアクセスする初歩的な実装例しか出てこなくて、「\u003cstrong\u003eコントローラでDB層にアクセスするとか、そんないい加減なシステムがあってたまるか！\u003c/strong\u003e 普通データアクセス層はコントローラから隠蔽されてるだろ！！ DAO層にどうやってDbContextを注入するのか知りたいんだよ！ DIコンテナ使ったことないからわかんねぇんだよ…ｳｯｳｯ」と\u003cstrong\u003e嗚咽を漏らしながら\u003c/strong\u003e海外のブログ記事などを読み漁った結果、「こうするのかな？」ということは分かったのですが、同じように悩んでる人はいるかもしれないと、自分でこの記事をまとめるに至りました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"この記事でわかること\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E3%82%8F%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこの記事でわかること\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eDIコンテナを使わない昔の多層システムでどういう課題があったか\u003c/li\u003e\n\u003cli\u003eASP.NET Coreの標準DIコンテナで、どうその課題を解決するか\u003c/li\u003e\n\u003cli\u003eASP.NET(無印) でDIコンテナ「AutoFac」を使って同じことをする為の情報\u003c/li\u003e\n\u003cli\u003eおまけで、トランザクションスクリプトの話\u003c/li\u003e\n\u003cli\u003eおまけで、オブジェクトマッパー「Mapster」の話\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"概要\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e概要\u003c/h1\u003e\n\n\u003cp\u003eASP.NET MVC 5を使って何年も前に構築されたシステムをなるべく最新の環境でリプレースしていくにあたり、それまで課題だった部分を解決していきます。ASP.NET Core と、ASP.NET無印に両対応しています。\u003c/p\u003e\n\n\u003cp\u003eASP.NETのソースコードはVB.NETですが、ASP.NET CoreのサンプルはC#になっています。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"現在の構成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%8F%BE%E5%9C%A8%E3%81%AE%E6%A7%8B%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e現在の構成\u003c/h1\u003e\n\n\u003cp\u003e対象となるソリューションは、ASP.NET MVC 5、データアクセス層とビジネスロジック層を分離する為に以下の多層構造を取っており、Entity Framework 6(EF6)のDbContextの生成と破棄の責務をどうするかという問題を抱えています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003eController -\u0026gt; Logic -\u0026gt; DAO(Data Access Object) -\u0026gt; EF6 or SQL\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eEF6のDbContextは、EF6のツールによって既存のDBから自動生成されたものです。\u003c/p\u003e\n\n\u003cp\u003e規定のコンストラクタでconfigファイルから接続文字列名(以下の例では\"MyDbContext\")経由で接続文字列を取得するようになっており、例えばテスト用のDBに接続先を切り替えたい場合には、Debug用の環境設定を用意することで、コードを修正せずに対応できるようになっています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"vb\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMyDbContext.vb\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ePartial\u003c/span\u003e \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMyDbContext\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eInherits\u003c/span\u003e \u003cspan class=\"n\"\u003eDbContext\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eSub\u003c/span\u003e \u003cspan class=\"nf\"\u003eNew\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eMyBase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"name=MyDbContext\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eSub\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eOverridable\u003c/span\u003e \u003cspan class=\"k\"\u003eProperty\u003c/span\u003e \u003cspan class=\"nf\"\u003eEmployee\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eDbSet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eOf\u003c/span\u003e \u003cspan class=\"n\"\u003eEmployee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eDbContextはDAO内でしか利用せず、Logic層からは隠ぺいする為、DAOクラスのメンバ変数としてDbContextを持ち、DAOクラスが生成された時に一緒にDbContextが生成される、という作りになっています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"vb\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Dao.vb\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Dao\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ePrivate\u003c/span\u003e \u003cspan class=\"n\"\u003edb\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e   \u003cspan class=\"c1\"\u003e' MyDbContextの生成を各Daoが受け持つ\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eOf\u003c/span\u003e \u003cspan class=\"n\"\u003eEmployeeDto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eReturn\u003c/span\u003e \u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmployee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"err\"\u003e条件\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\u003cspan class=\"err\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eEmployeeDto\u003c/span\u003e \u003cspan class=\"k\"\u003eWith\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpId\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpId\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpName\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"n\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eそして、ControllerがアクションメソッドからLogicを生成し、処理を委譲します。LogicはDAOからDTOとしてデータを取得し、ViewModelに転写して返します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"vb\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Controller.vb\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Controller\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eInherits\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e \u003cspan class=\"nf\"\u003eEmployeeList\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eActionResult\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eDim\u003c/span\u003e \u003cspan class=\"nv\"\u003elogic\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eDim\u003c/span\u003e \u003cspan class=\"nv\"\u003eviewmodel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elogic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eReturn\u003c/span\u003e \u003cspan class=\"n\"\u003eView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eviewmodel\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\n\u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"vb\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Logic.vb\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Logic\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eOf\u003c/span\u003e \u003cspan class=\"n\"\u003eEmployeeViewModel\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eDim\u003c/span\u003e \u003cspan class=\"nv\"\u003edao\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Dao\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eReturn\u003c/span\u003e \u003cspan class=\"n\"\u003edao\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\u003cspan class=\"err\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eEmployeeViewModel\u003c/span\u003e \u003cspan class=\"k\"\u003eWith\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpId\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpId\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpName\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"n\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\n\u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eロジック層がコントローラーに直接ViewModelを渡している部分などは気になる方もいらっしゃるかと思うのですが、今回はMVCアーキテクチャで、画面側ではこのViewModelをJSON形式で受け取った上でjavascriptライブラリを利用して画面を構築・処理しており、ここで渡されるViewModelはUIに直接依存するというよりは、ビジネスドメインの外部との入出力DTOに近いものです。問題が無いとは言えませんが、そもそもトランザクションスクリプトで作られていますし、落としどころとしては妥当かと思います。\u003c/p\u003e\n\n\u003cp\u003eControllerはほぼ、入力をLogicに渡して出力されるViewModelをView（*.vbhtml）に渡すのみとなっています。\u003cbr\u003e\n処理の多くはLogicとDaoが中心となり、Logicはビジネスロジックというよりは、DBに依存する部分をDAOに移した残りという感じです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"トランザクションスクリプトアーキテクチャ余談\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E4%BD%99%E8%AB%87\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eトランザクションスクリプト・アーキテクチャ（余談）\u003c/h1\u003e\n\n\u003cp\u003e対象となるシステムは、ドメインモデルではなくトランザクションスクリプトというアーキテクチャを採用しています。トランザクションスクリプトとは、トランザクション単位で設計を行う、オブジェクト指向設計とは異なる考え方のアーキテクチャです。\u003c/p\u003e\n\n\u003cp\u003eですので、Logic層は基本的に状態を持たず、逆にモデルはフィールドのみ、つまりDTO(Data Transfer Object)としての役割しか持っていません。\u003c/p\u003e\n\n\u003cp\u003e余談になりますが、最初私は、このシステムでオブジェクト指向設計が成されていない事に落胆しました。しかしメンテナンスしていくにつれて、トランザクションスクリプト・アーキテクチャが徹底されたこの構成にも利点はあるのだと理解するに至りました。\u003c/p\u003e\n\n\u003cp\u003eトランザクションスクリプト・アーキテクチャでは、View-\u0026gt;Controller-\u0026gt;Logic-\u0026gt;Daoという流れが全て一本道で独立して一貫しており、適切な画面IDを用いてクラス名を管理すれば、ある画面の変更がどのLogicやDaoに関係するのかが一目でわかります。つまりP101Viewの修正は、P101LogicやP101Daoにのみ影響し、その逆もまたしかり、ということです。システムはシンプルな縦割りの階層構造をなしており、横の連携はほぼ起きません。\u003c/p\u003e\n\n\u003cp\u003eですので、初めてそのシステムをメンテナンスする人も、その画面IDがついた各層のクラスだけ見ていけばよく、処理の流れも把握しやすいのです。\u003c/p\u003e\n\n\u003cp\u003e縦割りの弊害として、トランザクションスクリプトで良く言われる「処理の重複」については実際に発生しており、これがメンテナンス性の低下を引き起こしていることは否めません。また、ビジネスドメインという視点で機能が分割されていない為、ある業務仕様の変更がどのLogicに影響しているのか把握するのは困難です（トランザクションスクリプトにおいてビジネスドメインに最も似ているのはDBのテーブル構成である為、テーブル名や列名でソース全文検索を行い、検出されたDAOから遡って画面への影響範囲を調べます）。これはビジネスドメインのコア部分の変更時ほど顕著で、トランザクションスクリプトの大きな欠点だと思います。\u003c/p\u003e\n\n\u003cp\u003eもしドメインモデルで設計されていたならば、このビジネスドメインの変更はたった一か所の変更で済んだだろうに、と思うことはよくあります。\u003c/p\u003e\n\n\u003cp\u003eしかし、それを差し引いても、「画面単位」、良く言えばユースケース単位で設計されたシステムを機械的に実装に落とし込む手法として、トランザクションスクリプト・アーキテクチャのシンプルな考え方は優れているように思います。この方法ならば、難易度の高いオブジェクト指向モデリングに精通した人材がいなくとも、誰でもシステムを構築し、メンテナンスしていけると思います。安価で安全確実、というわけです。\u003c/p\u003e\n\n\u003cp\u003e但し、やはりトランザクションスクリプトは、他のシステムに応用が利かない「その場限りのコード」が大量に生産されがちです。前述の通り機能の重複も多く、システムが大きくなればなるほどこの重複部分の修正漏れのリスクが増大し、システムの修正はしにくくなっていきます。処理の流れが分かりやすいとは書きましたが、あくまでも「その流れでの処理」について分かるだけで、システム全体として何がしたいのかは、いつまで経ってもコードから読み取ることはできません。\u003c/p\u003e\n\n\u003cp\u003e個人的には、オブジェクト指向モデリングに精通した人材を確保した上で、ドメインモデル・アーキテクチャを採用した方が、システムが長期に渡って再利用できる「資産」になりうるとは思います。\u003c/p\u003e\n\n\u003cp\u003e以上、余談でした。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"現在の課題\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%8F%BE%E5%9C%A8%E3%81%AE%E8%AA%B2%E9%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e現在の課題\u003c/h1\u003e\n\n\u003cp\u003eDAOが個別にDbContextの生成を行っている為、以下の問題点があります。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e複数のDaoを同時に利用した場合、無駄にDbContextが生成される\u003c/li\u003e\n\u003cli\u003e複数のDaoをまたいだトランザクション管理ができない（UnitOfWorkの実現が面倒）\u003c/li\u003e\n\u003cli\u003eDbContextのDisposeがGC任せになっており非効率\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e1.については、リソース管理がシビアでなければ問題とはならない（実際、現在の運用では特に問題になっていない）のですが、2.は割と面倒で、そのような場合には単一のDbContextインスタンスを各DAOにコンストラクタ経由で渡すようにしなければなりません。そして、そのコンストラクタにDbContextを生成して渡す責務は誰が追うのかというと、また別の上位のDAOクラスとなります（UnitOfWork的な役割のクラスです）。\u003c/p\u003e\n\n\u003cp\u003eその場合、「今利用しているDbContextは誰が責務を負っているのか」という問題が常に付きまとい、無用なバグの温床になりかねません。\u003c/p\u003e\n\n\u003cp\u003eこのうち 3.については、DAOクラスおよびLogicクラスをDisposableにして、ControllerのDispose()が呼びされた時にDbContextのDisposeを確実に呼び出すようにするという方法もあります（ControllerのDispose()は、URLのレスポンスが返った後に必ず呼び出されます）。しかし、いちいちDisposeの連鎖を作るのは正直しんどいわけです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"解決方法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e解決方法（？）\u003c/h1\u003e\n\n\u003cdiv class=\"note info\"\u003e\n\u003cspan class=\"fa fa-fw fa-check-circle\"\u003e\u003c/span\u003e\u003cp\u003eDbContextをControllerで生成し、そこから呼び出す各オブジェクトへとコンストラクタ経由でdbcontextのインスタンスを伝搬させていく（DbContextのバケツリレー）。DbContextの生成と破棄をControllerの責務とする。\n\u003c/p\u003e\n\u003c/div\u003e\n\n\u003cp\u003e具体的には次のような感じです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"vb\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Controller.vb\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Controller\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eInherits\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePrivate\u003c/span\u003e \u003cspan class=\"n\"\u003edb\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"k\"\u003eSub\u003c/span\u003e\u003cspan class=\"err\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003edb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eSub\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e \u003cspan class=\"nf\"\u003eEmployeeList\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eActionResult\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eDim\u003c/span\u003e \u003cspan class=\"nv\"\u003elogic\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eDim\u003c/span\u003e \u003cspan class=\"nv\"\u003eviewmodel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elogic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eReturn\u003c/span\u003e \u003cspan class=\"n\"\u003eView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eviewmodel\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eSub\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"k\"\u003eImplements\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispose\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eSub\u003c/span\u003e \n\n\u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"vb\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Logic.vb\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Logic\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ePrivate\u003c/span\u003e \u003cspan class=\"n\"\u003edb\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eSub\u003c/span\u003e \u003cspan class=\"nf\"\u003eNew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epdb\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epdb\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eSub\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eOf\u003c/span\u003e \u003cspan class=\"n\"\u003eEmployeeViewModel\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eDim\u003c/span\u003e \u003cspan class=\"nv\"\u003edao\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Dao\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eReturn\u003c/span\u003e \u003cspan class=\"n\"\u003edao\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\u003cspan class=\"err\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eEmployeeViewModel\u003c/span\u003e \u003cspan class=\"k\"\u003eWith\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpId\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpId\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpName\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"n\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\n\u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eP101Daoの実装までは書きませんが、P101Daoも、コンストラクタで渡されたdbを内部でそのまま使うようになります。これで、DbContextのインスタンスはリクエスト毎に1つとなり、トランザクション管理もＯＫ、生成と破棄についても、Controllerに任せておけば安心、という事になります。\u003c/p\u003e\n\n\u003cp\u003eただ、ここで一つ問題があります。\u003c/p\u003e\n\n\u003cdiv class=\"note warn\"\u003e\n\u003cspan class=\"fa fa-fw fa-exclamation-circle\"\u003e\u003c/span\u003e\u003cp\u003eControllerやLogicがMyDbContextに依存するようになっている\n\u003c/p\u003e\n\u003c/div\u003e\n\n\u003cp\u003e本来、ControllerやLogicはdbを意識する必要はありません。ここで無駄な依存関係が発生してしまうと、もし将来DBの変更が起こった時、いちいちControllerやLogicまで影響を受けてしまいますし、下手をすると、よくわかっていない開発者が「コントローラーでDbContextを触れるじゃないか。じゃあ直接ここでDBにアクセスしちゃおう」と考えかねません。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"aspnet-core-ではdiを使って解決できる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#aspnet-core-%E3%81%A7%E3%81%AFdi%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E8%A7%A3%E6%B1%BA%E3%81%A7%E3%81%8D%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eASP.NET Core ではDIを使って解決できる\u003c/h1\u003e\n\n\u003cp\u003e調べていくと、ASP.NET CoreではDIコンテナがフレームワークとして用意されており、これを使って解決できるようです。\u003c/p\u003e\n\n\u003cp\u003eDIとは依存性注入(dependency injection)の略で、あるクラスが依存している別のオブジェクトの生成と破棄を、DIコンテナにお任せしてしまおう、というものです。ですので、DIコンテナを使いたい場合には、もうNew MyDbContextとは書きません。MyDbContextのインスタンスは常に外部から与えてもらうようにします。\u003c/p\u003e\n\n\u003cp\u003eDIコンテナについては、登場当時から便利だという話は聞いていたものの、これまでDIコンテナを使ったシステムに携わったことがなく、どのようにして使うのか、改めて調べてみました。\u003c/p\u003e\n\n\u003cp\u003e検索すると、基本的にほとんどのサイトで次のようなサンプルコードがヒットします。\u003cbr\u003e\n（サンプルはC#のみでした。VB.NETは本当に消えゆく言語ですね）\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eStartup.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureServices\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceCollection\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddControllers\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUseSqlServer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"name=ConnectionStrings:DefaultConnection\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Controller.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Controller\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e \u003cspan class=\"n\"\u003e_context\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eP101Controller\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_context\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eどういうことかというと、Controllerのインスタンス生成時に、Controllerのコンストラクタ引数のMyDbContextを、DIコンテナが自動的に生成して渡してくれるということです。コンストラクタ引数を全部生成してくれるわけではなく、Startupで指定した型（ここではMyDbContext）のみ、指定した具象型で生成して渡してくれます。\u003c/p\u003e\n\n\u003cp\u003eこれは、ASP.NET Coreに搭載されているMicrosoft Dependency InjectionというDIコンテナの機能です。本来は、生成するオブジェクトのインタフェースのみを依存する側が参照し、そのインタフェースに対応する具象クラスをDIコンテナ側に設定してインスタンスを切り替えるという使い方が本筋かと思いますが、この記事では「インスタンスの生成と破棄の責務」のみをDIコンテナに委譲する目的で使う為、インタフェースは定義していません。\u003c/p\u003e\n\n\u003cp\u003eDbContextについてはAddDbContextという専用のDIコンテナへの追加メソッドが用意されていますが、例えばP101Logicをここに登録することもできます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eStartup.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureServices\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceCollection\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddControllers\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUseSqlServer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"name=ConnectionStrings:DefaultConnection\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransient\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransient\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eP101Dao\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eAddTransient()は、Tで指定したクラスがControllerのコンストラクタ引数にあった場合に、「その都度」インスタンスを生成して渡してくれるというものです。\u003c/p\u003e\n\n\u003cp\u003e他にも、リクエスト毎に1つのインスタンスを生成してくれるAddScoped()や、システム全体で1つのインスタンスを渡してくれるAddSingleton()もあります。\u003c/p\u003e\n\n\u003cp\u003eDbContextのようにDisposableなものは、AddScopedでライフタイム管理をしたほうが良いでしょう。\u003c/p\u003e\n\n\u003cp\u003eともかくも、こう書く事で、P101LogicとかP101Daoという型のパラメータがControllerのコンストラクタ引数にあれば、リクエストの際に自動的にDIコンテナがインスタンスを生成して渡してくれるようになりました。\u003c/p\u003e\n\n\u003cp\u003e依存性注入をされる側の各クラスは、次のようになります。コンストラクタ引数のツリー構造が形成されています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Controller.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Controller\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e \u003cspan class=\"n\"\u003e_logic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eP101Controller\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e \u003cspan class=\"n\"\u003elogic\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_logic\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elogic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Logic.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Logic\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Dao\u003c/span\u003e \u003cspan class=\"n\"\u003e_dao\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eP101Dao\u003c/span\u003e \u003cspan class=\"n\"\u003edao\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_dao\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edao\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Dao.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Dao\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e \u003cspan class=\"n\"\u003e_db\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eP101Dao\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e \u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_db\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eP101Controllerに対するリクエストが発生した時、DIコンテナが裏で何をするかというと、こんな感じでしょうか。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eP101Controler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eP101Dao\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMyDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e))));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eマトリョーシカですね。\u003cbr\u003e\n見事に全てのオブジェクトが、自分が依存するインスタンスの生成責任を外部に丸投げしています。\u003cbr\u003e\nそして、その責任を一身に背負うのが、DIコンテナというわけです。\u003c/p\u003e\n\n\u003cp\u003eDIコンテナがP101ControllerのコンストラクタにP101Logicがあるのを見つけると、「P101LogicはDIコンテナで生成するんだったな」と、今度はP101Logicのコンストラクタ引数も見に行きます。そこにP101Daoがあるのを見つけて、「それも確かDIしろって言われてたな」と判断し、自動的に生成してくれるのです。\u003c/p\u003e\n\n\u003cp\u003eさらにはなんと、DIコンテナは、コンテナが生成したDisposableなインスタンス、例えばここではMyDbContextを、適切なタイミングでDisposeしてくれます。至れり尽くせりですね。\u003c/p\u003e\n\n\u003cp\u003e上記のP101Controllerを見てみると、MyDbContextへの依存が消えています。Logicへの依存のみとなり、すっきりしました。P101Logicもしかりです。\u003c/p\u003e\n\n\u003cp\u003e結果、各クラスに存在する依存性は、全て単一の場所（ここではStartup.cs）に集約されるようになりました。\u003c/p\u003e\n\n\u003cp\u003eまた各クラスは単に自分に渡されるインスタンスを黙って使って、使いっぱなしにすればOKになりました。依存オブジェクトの管理という責務から解き放たれたわけです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"アクションメソッドに依存性注入する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E4%BE%9D%E5%AD%98%E6%80%A7%E6%B3%A8%E5%85%A5%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eアクションメソッドに依存性注入する\u003c/h1\u003e\n\n\u003cp\u003eしかし正直なところ、P101Controllerが使うlogicは、コンストラクタで受け取ってわざわざメンバ変数に格納しておくほどのスコープを必要としません。アクションメソッド単位で依存性の注入を行ってくれないものでしょうか？\u003c/p\u003e\n\n\u003cp\u003e調べると、ASP.NET Core ならそれも可能でした。アクションメソッドの引数に[FromServices]を付けると、DIコンテナがよきに計らってくれます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Controller.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Controller\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIActionResult\u003c/span\u003e \u003cspan class=\"nf\"\u003eEmployeeList\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eFromServices\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e \u003cspan class=\"n\"\u003e_logic\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eviewmodel\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_logic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eviewmodel\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eただ、調べるとコンストラクタでの依存性注入の方が一般的で、メソッドへの注入はあまりメジャーではないようです。\u003cbr\u003e\n理由はテストのし易さのようです。コンストラクタでの注入にしておけばインスタンス生成のみをDIコンテナに任せておけばよいが、メソッドでの注入にするとメソッド呼び出しもDIコンテナ任せになって煩雑になる、ということのようです。\u003c/p\u003e\n\n\u003cp\u003e個人的にはそれでそこまで煩雑になるとも思いませんし、明らかに便利な技術だと思いますので、積極的に使っていきたいと思いました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"diコンテナを使えば複雑な依存性注入もシンプルに管理できる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%BF%E3%81%88%E3%81%B0%E8%A4%87%E9%9B%91%E3%81%AA%E4%BE%9D%E5%AD%98%E6%80%A7%E6%B3%A8%E5%85%A5%E3%82%82%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AB%E7%AE%A1%E7%90%86%E3%81%A7%E3%81%8D%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDIコンテナを使えば複雑な依存性注入もシンプルに管理できる\u003c/h1\u003e\n\n\u003cp\u003eところで、MyDbContextだけだと、「別にDIコンテナなんて使わなくてもコンストラクタ経由で渡していけばいいのでは」と思うかもしれません。\u003c/p\u003e\n\n\u003cp\u003eしかし、共通のロジックやログイン情報など、システム全体で共有したいオブジェクトは結構あります。ログイン情報は通常、HttpContext.Sessionに保持しておくべきものかもしれませんが、かといって、LogicがHttpContextに依存するのは違うでしょう。それらはLogicの外部から渡される必要があります。ControllerはHttpContextへの依存を持っていておかしくありませんから、Controllerがその責務を負うのも良いと思いますが、定形的な処理になるので、そういうものの生成はどこか他のクラスにお願いしたいところです。\u003c/p\u003e\n\n\u003cp\u003eこういうものは共通関数やSingletonパターンを使ってどこからでも取得できるようにするのがDI以前のやり方だったかもしれませんが、そのやり方をするとテストが非常にしにくくなりますし、特定のシステムに依存した、移植性の低いコードになってしまいます。\u003c/p\u003e\n\n\u003cp\u003eですから、これらも全てDIを使うやり方に切り替えていった方が良いでしょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eStartup.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureServices\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceCollection\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddControllers\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUseSqlServer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"name=ConnectionStrings:DefaultConnection\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransient\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransient\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eCommonLogic\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransient\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLoginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Controller.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Controller\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eController\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIActionResult\u003c/span\u003e \u003cspan class=\"nf\"\u003eEmployeeList\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eFromServices\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e \u003cspan class=\"n\"\u003e_logic\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eFromServices\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"n\"\u003eCommonLogic\u003c/span\u003e \u003cspan class=\"n\"\u003e_comlogic\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eviewmodel\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_logic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eviewmodel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetColorConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_comlogic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetColorConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eView\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eviewmodel\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Logic.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Logic\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Dao\u003c/span\u003e \u003cspan class=\"n\"\u003e_dao\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eLoginInfo\u003c/span\u003e \u003cspan class=\"n\"\u003e_loginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLoginInfo\u003c/span\u003e \u003cspan class=\"n\"\u003eloginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Dao\u003c/span\u003e \u003cspan class=\"n\"\u003edao\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_dao\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edao\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_loginInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eloginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこんな感じでどんどん依存性を外部に出していき、DIコンテナに生成と破棄の責任を担当して貰えば、各機能の独立性が向上し、テストもしやすくなることでしょう。\u003c/p\u003e\n\n\u003cp\u003e今回はAddTransientに直接具象クラスを指定していますが、インタフェースを定義して次のように指定すれば、テスト時にテスト用のドライバやスタブを使うのも簡単になります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eStartup.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConfigureServices\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIServiceCollection\u003c/span\u003e \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddControllers\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUseSqlServer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"name=ConnectionStrings:DefaultConnection\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransient\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransient\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eICommonLogic\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCommonLogic\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eservices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransient\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eILoginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eLoginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"aspnetcoreじゃない方ではどうするのか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#aspnetcore%E3%81%98%E3%82%83%E3%81%AA%E3%81%84%E6%96%B9%E3%81%A7%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eASP.NET(Coreじゃない方)ではどうするのか\u003c/h1\u003e\n\n\u003cp\u003eASP.NETには、ASP.NET CoreのようなDIコンテナが標準ではついていません。\u003c/p\u003e\n\n\u003cp\u003e今回の記事と同じことをするには、どのようなDIコンテナを導入すればよいでしょうか。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eControllerのコントラクタに依存性注入ができる\u003c/li\u003e\n\u003cli\u003eControllerのアクションメソッドに依存性注入ができる\u003c/li\u003e\n\u003cli\u003eインスタンスのライフサイクル管理方法として「リクエスト単位」「都度生成」が選べる\u003c/li\u003e\n\u003cli\u003e.NET Frameworkと.NET Core/5+両方に対応している。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこんなところでしょうか。\u003c/p\u003e\n\n\u003cp\u003e調べてみると、\u003ca href=\"https://autofac.org/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAutoFac\u003c/a\u003eというDIコンテナが上記全てに対応しており、利用者も多く、メンテナンスも活発のようです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eglobal.asax\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eApplication_Start\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContainerBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// Register your MVC controllers. (MvcApplication is the name of\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// the class in Global.asax.)\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterControllers\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMvcApplication\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eAssembly\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// OPTIONAL: Register model binders that require DI.\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterModelBinders\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMvcApplication\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eAssembly\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterModelBinderProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// OPTIONAL: Register web abstractions like HttpContextBase.\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterModule\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAutofacWebTypesModule\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// OPTIONAL: Enable property injection in view pages.\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterSource\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eViewRegistrationSource\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// OPTIONAL: Enable property injection into action filters.\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterFilterProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// OPTIONAL: Enable action method parameter injection (RARE).\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInjectActionInvoker\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// Set the dependency resolver to be Autofac.\u003c/span\u003e\n  \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econtainer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuild\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eDependencyResolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetResolver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eAutofacDependencyResolver\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtainer\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"nf\"\u003eInstancePerLifetimeScope\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003eAs\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eLoginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;()\u003c/span\u003e \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAutoFacをASP.NET Coreで使う方法については、以下の英語記事が参考になりそうです。\u003cbr\u003e\n\u003ca href=\"https://danylomeister.blog/2021/01/31/tips-on-using-autofac-in-net-core-3-x/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eTips on using Autofac in .NET Core 3.x\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"その他の懸念事項\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%87%B8%E5%BF%B5%E4%BA%8B%E9%A0%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eその他の懸念事項\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"diコンテナの初期化処理の増大\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96%E5%87%A6%E7%90%86%E3%81%AE%E5%A2%97%E5%A4%A7\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDIコンテナの初期化処理の増大\u003c/h2\u003e\n\n\u003cp\u003eシステムが膨大になってくると、これらのクラスを全てDIコンテナに登録していくのはかなり大変です。\u003cbr\u003e\nLogicが百個近くなってくると、新しいLogicの登録し忘れなども起きてくるでしょう。\u003cbr\u003e\n複数人で開発している場合、Git等のチーム開発において、単一のファイルを全員で編集することになり、コンフリクトの発生率も上がってしまいます。\u003c/p\u003e\n\n\u003cp\u003e調べると、AutoFacにはRegisterAssemblyTypes(asm)というメソッドが用意されており、例えば以下のように使うことで、指定したアセンブリに含まれる、DI対象のクラスをまとめて登録することができるようです（Microsoft Dependency Injectionには同等の機能を見つけられませんでしたが、恐らく外部ライブラリで対応できるものと思われます）。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://autofac.readthedocs.io/en/latest/register/scanning.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAssembly Scannin\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edataAccess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eAssembly\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetExecutingAssembly\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterAssemblyTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edataAccess\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n       \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEndsWith\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Logic\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n       \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAsImplementedInterfaces\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e上記の処理は、現在実行中のアセンブリを取得し、その中に含まれる全てのパブリックなクラスのうち、クラス名が「\"Logic\"で終わるクラス全てについてDIコンテナに登録する、というものです。\u003c/p\u003e\n\n\u003cp\u003eDAOやLogicが別のプロジェクトにパッケージングされている場合には、\u003ccode\u003eAppDomain.CurrentDomain.GetAssemblies()\u003c/code\u003eを使って、アプリケーションドメインに読み込まれているすべてのアセンブリを取得し、このやり方でDIに登録することができるのではないかと思います（未確認）。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"diコンテナへの依存を単一の場所に集約する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%B8%E3%81%AE%E4%BE%9D%E5%AD%98%E3%82%92%E5%8D%98%E4%B8%80%E3%81%AE%E5%A0%B4%E6%89%80%E3%81%AB%E9%9B%86%E7%B4%84%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDIコンテナへの依存を単一の場所に集約する\u003c/h2\u003e\n\n\u003cp\u003eDIコンテナへの依存部分は、ここでは「Startup.cs」のDIコンテナの初期化コードのことです。この場所に、今回DIコンテナを使用するにあたっての解決すべき依存性が全て記述されているようにしなければなりません。この単一の場所に、依存性を集約するのです。\u003c/p\u003e\n\n\u003cp\u003e例えば今回、P101Logicから使うDAOをP101Daoとしていますが、特定のメソッドがCommonDaoみたいな他のオブジェクトを必要とする場面はあるかもしれません。\u003c/p\u003e\n\n\u003cp\u003eその際には、P101LogicのコンストラクタにCommonDaoを追加します。もちろんDIコンテナの初期化にもservices.AddTransient();を追加します。\u003c/p\u003e\n\n\u003cp\u003eしかし、実は次のような事もできてしまいます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Logic.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Logic\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"n\"\u003e_serviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eLoginInfo\u003c/span\u003e \u003cspan class=\"n\"\u003e_loginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eP101Logic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLoginInfo\u003c/span\u003e \u003cspan class=\"n\"\u003eloginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIServiceProvider\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_serviceProvider\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eserviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_loginInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eloginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eP101ViewModel\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetSpecialInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCommonDao\u003c/span\u003e \u003cspan class=\"n\"\u003ecomDao\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_serviceProvider\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetService\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCommonDao\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eP101ViewModel\u003c/span\u003e \u003cspan class=\"n\"\u003evm\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003evm\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserLevel\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecomDao\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetUserLevel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_loginInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUserId\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003evm\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eコンストラクタ引数で、DIコンテナのサービスプロバイダを受け取って、自らDIコンテナを操り、インスタンスを取得しています。Logic内で自由に好きなDaoをDIコンテナから取得できるので、柔軟性があって良いように思えます。\u003c/p\u003e\n\n\u003cp\u003eしかしこれは、Logicから依存性を排除するというそもそもの目的に反してDIコンテナにLogicを依存させてしまっている為、避けるべきやり方です。\u003c/p\u003e\n\n\u003cp\u003e別の言い方をするならば、依存性を注入される側は、自分が依存性注入されているという意識を持ってはいけないということです。依存オブジェクトは、あくまでも「ただコンストラクタから渡される」だけであり、DIコンテナなどなくてもテスト可能でなくてはなりません。\u003c/p\u003e\n\n\u003cp\u003eちなみにこれを「サービスロケーターパターン」と呼び、依存性を注入するという目的に反する使い方である為、アンチパターンだといわれています。\u003cbr\u003e\nサービスロケーターパターンを使ってまでオブジェクトの生成をDIコンテナに任せたい場合、果たしてそこまでする価値があるのかよく考えるべきでしょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"dtoオブジェクトの転写についてオブジェクトマッパーの利用\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dto%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E8%BB%A2%E5%86%99%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%83%9E%E3%83%83%E3%83%91%E3%83%BC%E3%81%AE%E5%88%A9%E7%94%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDTOオブジェクトの転写について（オブジェクトマッパーの利用）\u003c/h2\u003e\n\n\u003cp\u003e今回の記事には関係ありませんが、DTOオブジェクトの転写は毎回面倒だと思います。\u003cbr\u003e\nまったく同じプロパティならば、1行で全部転写してほしいものです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"vb\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eP101Dao.vb\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eClass\u003c/span\u003e \u003cspan class=\"nc\"\u003eP101Dao\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ePrivate\u003c/span\u003e \u003cspan class=\"n\"\u003edb\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eMyDbContext\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ePublic\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetEmployees\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"ow\"\u003eAs\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eOf\u003c/span\u003e \u003cspan class=\"n\"\u003eEmployeeDto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eReturn\u003c/span\u003e \u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmployee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWhere\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"err\"\u003e条件\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\u003cspan class=\"err\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eNew\u003c/span\u003e \u003cspan class=\"n\"\u003eEmployeeDto\u003c/span\u003e \u003cspan class=\"k\"\u003eWith\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpId\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpId\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpName\u003c/span\u003e\n                 \u003cspan class=\"p\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"n\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eEnd\u003c/span\u003e \u003cspan class=\"k\"\u003eFunction\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eその為のライブラリとして有名なものに「\u003ca href=\"https://automapper.org/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAutoMapper\u003c/a\u003e」があります。\u003cbr\u003e\nしかしこれは、マッピングする側とされる側のクラスを事前に登録してやる必要があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMapperConfiguration\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecfg\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateMap\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eOrder\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eOrderDto\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;());\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれは正直面倒です。特に、多層システムとして複数のレイヤーに分割している場合、誰がこの登録処理の責務を負うのかという問題があります。プロパティのマッピングなどというものはソースコード上の問題であって、DLLの利用者にお願いしなければいけないようなものであってはならないでしょう。\u003c/p\u003e\n\n\u003cp\u003eかといって、上記の初期化処理をDLL側で責務を負って行うには、「アセンブリがロードされた時に行う初期化時処理」とでもいうようなものが存在しなければならず、これは.NETでは今のところまだ現実的ではないようです（「\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/proposals/csharp-9.0/module-initializers\" rel=\"nofollow noopener\" target=\"_blank\"\u003eモジュール初期化子\u003c/a\u003e」）。\u003c/p\u003e\n\n\u003cp\u003e現実的には、各DLL側にProfileクラスを継承したpublicな「初期化処理用のクラス」を用意し、そのクラスをアセンブリ参照を用いて生成する、という、結構面倒なやり方になるようです。（\u003ca href=\"https://docs.automapper.org/en/latest/Configuration.html#profile-instances\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAssembly Scanning for auto configuration\u003c/a\u003e）\u003c/p\u003e\n\n\u003cp\u003eどちらにせよ、使う側が予めこの処理を行わないとそのDLLが使えないとうのはあまり好ましくないと思います。また、同様の理由から、この初期化処理をDIコンテナを使って行うべきものでもないと感じます。\u003c/p\u003e\n\n\u003cp\u003e調べてみると、このあたりについて改善した、「\u003ca href=\"https://github.com/MapsterMapper/Mapster\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMapster\u003c/a\u003e」というオブジェクトマッパーがあるようです。\u003c/p\u003e\n\n\u003cp\u003e初期化処理は不要で、いきなりこう書けます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edestObject\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esourceObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAdapt\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDestination\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eTDestination .Adapt() の形式で使える拡張メソッドがObjectに対して定義されています。\u003cbr\u003e\nもちろん、マッピング時に細かい調整をすることもできます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eTypeAdapterConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTSource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTDestination\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eNewConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMap\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edest\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFullName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esrc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"{0} {1}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFirstName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLastName\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNewConfig()というのが面白くて、過去の設定を全てクリアするというものなので、常に「今、ここで設定したもの」以外の影響を受けない独立したコードが書けます。\u003c/p\u003e\n\n\u003cp\u003eただ、やはりせっかくのConfigは一か所にまとめたいですよね。\u003cbr\u003e\nそんな場合には、以下の書き方ができそうです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMapperConfig\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eTypeAdapterConfig\u003c/span\u003e  \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"nf\"\u003eMapperConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eMapperConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eTypeAdapterConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eMapperConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eForType\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOf\u003c/span\u003e \u003cspan class=\"n\"\u003eSource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eDestination\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMap\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"n\"\u003edest\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFullName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esrc\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"{0} {1}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFirstName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLastName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eTypeAdapterConfig\u003c/span\u003e \u003cspan class=\"n\"\u003eInstance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003edestObject\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esourceObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAdapt\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDestination\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eMapperConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eMapperConfigクラスはモジュール内プライベートにしておいて、各モジュール内でこのconfigを使えば、モジュール内に閉じた形で運用できそうです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"本当に全ての依存関係をdiコンテナに任せられるか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%AC%E5%BD%93%E3%81%AB%E5%85%A8%E3%81%A6%E3%81%AE%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%82%92di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AB%E4%BB%BB%E3%81%9B%E3%82%89%E3%82%8C%E3%82%8B%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e本当に全ての依存関係をDIコンテナに任せられるか？\u003c/h2\u003e\n\n\u003cp\u003e中には、条件に応じて異なるLogicに分岐をするようなケースもあるでしょう。そのような場合に、分岐の可能性のある全てのLogicのインスタンスをControllerのコンストラクタなりアクションメソッドなりに列挙するのでしょうか？\u003c/p\u003e\n\n\u003cp\u003eそれともそういう場合には、Logicを集約する親Logicクラスを作ってそこにカプセル化する、などするのでしょうか。\u003c/p\u003e\n\n\u003cp\u003eDIコンテナを使うと、大元となる処理のエントリポイント（ASP.NETではController）を起点として、全てのインスタンスを一気に生成してオブジェクトの構造を作ってしまってから、処理を開始するようなイメージがあります。\u003c/p\u003e\n\n\u003cp\u003eしかし、中には処理の開始時には必要かどうか未定で、入力パラメータの条件によっては必要になるオブジェクト、というようなものもあるでしょう。\u003c/p\u003e\n\n\u003cp\u003eそういう場合には、ひょっとして遅延実行というか、オブジェクトを返す関数のみを注入したりして、必要な時はその関数を実行してインスタンスを得るような形にするのでしょうか。\u003c/p\u003e\n\n\u003cp\u003eこの辺どうすべきなのかよくわからず少し不安なところはありますが、なんとかなるような気もします。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003e以上、調べた内容をつらつらとまとめてみました。\u003cbr\u003e\nある程度サンプルプロジェクトを作って動作を確かめていますが、想像で書いたコードも多い為、間違っていたらご指摘下さい。\u003c/p\u003e\n\n\u003cp\u003eまた、そもそも考え方が違う、もっとこうした方がいいなどありましたら、ご教授頂ければ幸いです。\u003c/p\u003e\n","createdAt":"2021-08-03T13:11:18Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"fjaOyVJQxRmkd8V/8uwAQVvn3eWBi/zBAw==--0tbMVHTHSgnTRadN--uiw67o5HHl12OrbWX7vlDQ==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-09-03T04:10:28Z","likesCount":6,"linkUrl":"https://qiita.com/jun1s/items/484cb55e7b6023e8fd23","organization":null,"originalId":1468780,"stockedCount":9,"title":"[ASP.NET]多層システムにおけるDbContextのバケツリレーをDIコンテナで解消する","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%82%92%E3%81%8B%E3%81%84%E3%81%9F%E7%90%86%E7%94%B1\"\u003eこの記事をかいた理由\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E3%82%8F%E3%81%8B%E3%82%8B%E3%81%93%E3%81%A8\"\u003eこの記事でわかること\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e概要\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%8F%BE%E5%9C%A8%E3%81%AE%E6%A7%8B%E6%88%90\"\u003e現在の構成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E4%BD%99%E8%AB%87\"\u003eトランザクションスクリプト・アーキテクチャ（余談）\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%8F%BE%E5%9C%A8%E3%81%AE%E8%AA%B2%E9%A1%8C\"\u003e現在の課題\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95\"\u003e解決方法（？）\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#aspnet-core-%E3%81%A7%E3%81%AFdi%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E8%A7%A3%E6%B1%BA%E3%81%A7%E3%81%8D%E3%82%8B\"\u003eASP.NET Core ではDIを使って解決できる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E4%BE%9D%E5%AD%98%E6%80%A7%E6%B3%A8%E5%85%A5%E3%81%99%E3%82%8B\"\u003eアクションメソッドに依存性注入する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%BF%E3%81%88%E3%81%B0%E8%A4%87%E9%9B%91%E3%81%AA%E4%BE%9D%E5%AD%98%E6%80%A7%E6%B3%A8%E5%85%A5%E3%82%82%E3%82%B7%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AB%E7%AE%A1%E7%90%86%E3%81%A7%E3%81%8D%E3%82%8B\"\u003eDIコンテナを使えば複雑な依存性注入もシンプルに管理できる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#aspnetcore%E3%81%98%E3%82%83%E3%81%AA%E3%81%84%E6%96%B9%E3%81%A7%E3%81%AF%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B\"\u003eASP.NET(Coreじゃない方)ではどうするのか\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E6%87%B8%E5%BF%B5%E4%BA%8B%E9%A0%85\"\u003eその他の懸念事項\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E5%88%9D%E6%9C%9F%E5%8C%96%E5%87%A6%E7%90%86%E3%81%AE%E5%A2%97%E5%A4%A7\"\u003eDIコンテナの初期化処理の増大\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%B8%E3%81%AE%E4%BE%9D%E5%AD%98%E3%82%92%E5%8D%98%E4%B8%80%E3%81%AE%E5%A0%B4%E6%89%80%E3%81%AB%E9%9B%86%E7%B4%84%E3%81%99%E3%82%8B\"\u003eDIコンテナへの依存を単一の場所に集約する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#dto%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E8%BB%A2%E5%86%99%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%83%9E%E3%83%83%E3%83%91%E3%83%BC%E3%81%AE%E5%88%A9%E7%94%A8\"\u003eDTOオブジェクトの転写について（オブジェクトマッパーの利用）\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%AC%E5%BD%93%E3%81%AB%E5%85%A8%E3%81%A6%E3%81%AE%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%82%92di%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AB%E4%BB%BB%E3%81%9B%E3%82%89%E3%82%8C%E3%82%8B%E3%81%8B\"\u003e本当に全ての依存関係をDIコンテナに任せられるか？\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":2229,"uuid":"484cb55e7b6023e8fd23","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"Bq7Omj8T3xkH3+GCwzvTsrkKqBKS--k2rEzH8XrdDY0zx+--pQev2/9i8xGUkmCyCSvUXw==","originalId":207038,"description":"福井県越前市在住のプログラマーです。\r\n主にマイクロソフト系の技術者であり、javascript系のweb技術もフォローしています。\r\nVB.NET、C#、ASP.NET MVC(.NET Framework 又は.NET 5)の新規開発、古いVB資産の最新システムへのリプレース案件等を得意としています。\r\nお仕事の依頼や開発チームへの参加要請がありましたらお気軽にご連絡下さい。","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"Jun-ichi Shinde","profileImageUrl":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/207038/profile-images/1626694207","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F207038%2Fprofile-images%2F1626694207?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=9079c756835185fa905352e904e5890a","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F207038%2Fprofile-images%2F1626694207?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=d32024917eddb4431b54a590dd0309cd","urlName":"jun1s","websiteUrl":"","twitterUrl":"https://twitter.com/jun1s","twitterUrlName":"jun1s","revealedOrganizations":{"edges":[]}},"tags":[{"name":"VB.Net","urlName":"vb.net"},{"name":"C#","urlName":"csharp"},{"name":"ASP.NET","urlName":"asp.net"},{"name":"DI","urlName":"di"},{"name":"ASP.NET_Core","urlName":"asp.net_core"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
