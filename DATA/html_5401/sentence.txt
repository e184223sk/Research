More than 3 years have passed since last update.ミニゲームを作ってUnityを学ぶ！[タンクウォーズ編]今回は前回実装したシーンを制御するスクリプトの土台について、ゲームの状態が「はじまり」から「プレイ中」に至るまでの具体的な処理を記述していきます。また、具体的な内容を実装していく際にどうしても必要になってしまうUIや、それぞれのオブジェクトを一元管理するマネージャーも同時に実装していきます。シーンの分岐先を実装する前に、まずはプレイヤーの操作する戦車と相手戦車をひとまとめにするためのマネージャーを実装します。TankModelをまとめるためにはListを活用します。TankManagerはRegisterTanks()が実行されるとゲーム内にあるタグ名がTankのオブジェクト全てについて、アタッチされているTankModelをListに格納し、戦車に対して何か処理が必要な際はListに格納されたTankModelの参照を使ってそれぞれのメソッドを呼び出します。今まではプロジェクトを実行した瞬間から戦車の操作が可能になる、いわゆるゲームが始まっている状態でしたが、この開始方法をプレイヤーが自分のタイミングで決定できるように修正していきます。SceneMainには状態(mState)としてINIT, PLAY, GAME_OVERの3種類が存在していましたが、ここで新しく状態を定義しなおします。ゲームを起動した直後はSceneMainの状態がWAIT_ENTER_KEYになっています。
この状態のときUpdate()では更新毎にEnterキーが押されたかどうかの判定を行い、もし押された場合は状態をPLAYへ遷移させています。続いて戦車側の修正を行います。
今の段階ではSceneMainがどんな状態であってもPlayerTank自体はゲーム起動直後から操作できてしまいますが、これをSceneMainがPLAY状態になるタイミングで初めて操作できるよう変更していきます。1: mIsActiveの初期値をtrueからfalseに変更
2: mIsActiveをtrueにするためのメソッドを追加この修正により、プロジェクトを実行しても戦車はmIsActiveがtrueになるまで操作ができなくなりました。それでは、動かなくなってしまった戦車をシーンがPLAY状態になるタイミングで操作可能にするために、TankManagerとSceneMainを修正していきます。TankManagerに新しくOnActiveAllTanks()を追加しました。
このメソッドでListに格納されている全ての戦車を操作可能な状態に変更します。1: フィールドを追加して空オブジェクトTankManagerをインスペクタから設定SceneMainではEnterキーの入力を感知した際に、シーンに配置されているタグ名がTankのオブジェクト全てについてアタッチされたTankModel（戦車本体）をマネージャーのListに格納し、それら全ての戦車を操作可能状態に変更しています。これでプレイヤーがEnterキーを押したタイミングで戦車を操作できるようになりました。
次は実際にEnterキーを押してもらうためにそれを促すテキストを画面中央に表示し、Enterキーの入力を受け取ったタイミングでそのテキストが非表示になるようにします。中央にテキストを表示できたらそれを操作するためのマネージャーを新しく作成し、SceneMainにも対応するコードを追加します。1: PanelCenterMsgをインスペクタから設定
2: フィールドを追加して空オブジェクトUiManagerをインスペクタから設定Enterキーの入力を受けたタイミングで中央のテキストを非表示にすることができましたので、追加でテキストが表示されている間は点滅アニメーションをさせることでゲーム開始前の画面に少しだけ動きをつけていきます。1: 文字列「Press the Enter key !」のTextをインスペクタから設定UpdateCenterMsg()では、現在の状態mCenterMsgStateによってTextのアルファ値を加減算することで点滅アニメーションを実現しています。起動直後からゲーム開始までの流れの中で、最後にもう1つだけ解決しなければいけない問題があります。
それはEnterキーを押したタイミングでゲームが開始されてしまうという点です。Enterキーを押すということは、その瞬間に移動キーのWSもしくはマウスから手を放すことになりますので、ゲーム開始から即座に動ける相手戦車と比べてプレイヤー側が不利な状態になってしまいます。この問題を解消するために、Enterキーが押されたらカウントダウンを開始し、カウントゼロでゲームを開始するという流れを実装していきます。1:TextCountDownをインスペクタから設定UpdateCountDown()では状態によって表示する文字を切り替えていき、最後のFire!の文字を表示した後はコルーチンを使った遅延処理で1秒後にTextを非表示にする処理を行っています。SceneMainでは新しくCOUNT_DOWNの状態を追加し、カウントダウンが終了した段階で戦車の操作が可能になるよう修正を行っています。これでようやくゲームを開始する準備が整いました。
最後にプロジェクトを実行して、意図したとおりの動きになっているか確認します。次のページに進む
イントロダクションに戻る



