More than 1 year has passed since last update.以前、こちらの記事 で オーバーレイ(風) にチャレンジしたのだけど。今回は ColorMatrix を利用して オーバーレイ に再チャレンジ。前回の (風) とは違い、今回はちゃんと望み動きが出来た。どちらかというと数学寄りの話。といっても私もにわかなので、そんなに難しくない話。Photoshopの レイヤー効果 でおなじみ(？)のやつ。
レイヤーの描画ピクセルの色情報を任意の色に上書きするやつ。
私はよくレイヤーの描画モードを スクリーン にした単色レイヤーを重ね合わせえて色味調整を行うことがよくあるのだけど。カラー オーバーレイ だとカラーピッカーで選択中の色がリアルタイムで反映されるので、 スクリーン レイヤーの色味調整でよく使ってる。ColorMatrix は 行列(Matrix) を使って色味を調整する。まず早速、その 行列 のための配列。ジャグ配列... (´・ω・｀)シンプルに指定色に置き換える。アルファによって、オーバーレイを加減をする。
(適応量を線形補間。)参考のイラストは、Pixivでは18年齢制限の制限がついてしまっているので、本記事では一応何となく一部にモザイクをかけております (苦笑)。単純に黒で塗りつぶし。
(人によっては背景が透明に見える)

色に透明度(α)も追加。
※ アルファ ブレンディング (加算) ではない。

絵も背景も単色で塗りつぶし。
なんか、一昔の エロゲ ゲームの 立ち絵 + とアルファ チャンネルみたい (苦笑)

高校数学あたりでやる、あの行列。行列演算は3Dなどで大変活用されており、機械学習など様々に応用されているので、最早言わずもがな、というくらい。こんな計算するやつ。例えば3Dの場合、行列1つの4x4の行列で、回転情報 (Rotatioin)、拡縮情報 (Scale)、平行移動情報 (Translation) を持つことができ、座標情報(Vector) や 他の行列 と掛け合わせることで、頂点座標を変換したり、 回転情報を伝播 したりなと、多様される。正直、当時は何となく習っただけの内容だけど、3Dで再会したときの衝撃はびっくりした。CSS Transform 3D も基礎は全く同じなので、ほんと行列すごい。今回の ColorMatrix では色情報を変換するのフィルターとして行列演算が使われている感じ。より。入出力とフィルターとなるMatrixでの計算式はこんな感じ。入力パラメータが 要素数5 の 5次元ベクトル なので、行列は 5x5の正方行列 が利用される。これを使って色味の調整ができる。正方行列で主対角線上の要素が1で、他が0のベクトルは 単位行列 と呼ばれる。細かい条件はあると思うが、今回の様にベクトルの次元数(要素数)と同じ行数・列数を持つ 正方行列 の場合、 単位行列 との積の場合、同じ値が得られる。一応確認。ほんとだ！
だいたいここから値を変えながら色々と試行していく。※ ちなみに、行列は 交換法則 は成り立たないが、単位行列との積については 交換法則 は成り立たつらしい。今回の主役。行列係数は、ARGB 同種値の変換に使用される 5 x 5 線形変換を構成します。 たとえば、ARGB ベクターは、赤、緑、青、アルファ、w として表されます。 w は常に1です。MSの説明をみて、なんのコッチャ？と思った人少なくないのでは、と思う。行列の積では基本は乗算のため、ARGB値に係数を掛け合わせるだけでは、特定の値に置き換えることが出来ない。しかし、Wには固定値 1 がくるのでWで任意の値を作ることが可能。更に 　他の係数を 0 にすれば元の値を潰せるので、置き換えることができる。ColorMatrix は色情報を 0.0～1.0 で表現するため、 rgb(229,153,76) に置き換える場合。という計算式で置き換えることができる。
W ありがてぇ。前述で一部省略はしているが、 出力 W' は使われない。入力で(R G B A W)の 5次元ベクトル のため、行列は 5行 必要だが、出力は (R' G' B' A') の 4次元ベクトル のため、行列は 4列 で十分だったりする。 W’無駄じゃね？しかし、正方行列 であることに利点がある様で、多少無駄な計算をさせても、作業のしやすさを取った 形だと考えている。3Dでも 4x4の正方行列 が一般的に使われるけど、最後の列が不要らしい。4x3の行列 の3Dエンジンのゲーム機もあった。(今はどうしているかわからないけど。流石に正方行列の波に飲まれていると予想)。行列演算だと 単位行列、 逆行列、 行列の積 などで、沢山の行列同士を計算する上で、正方行列 のほうが確かに都合が良さそうなので。満足の行くカラー オーバーレイがGDI+で出来てよかった。Matrix (行列)を使うのは意外だったけど、やっぱすげーな、Matrix。しかし、Matrix より、サンプル プロジェクトを作る方が時間かかった(爆) 2つのコントロール間ので値を相互的な連動とか。今更ながら、DataBindingsにチャレンジ出来たのは良い機会だった。しかし、色の画面表示用にPanel使ってみたけどTabStop出来なかったので、そっちの方法とかもいずれ調べてみたい。【.NET】カラー行列(ColorMatrix)で画像のRGBの値を調整する - CommentOut?
http://www.r-nakai.com/archives/30ColorMatrixによる色の変換 - C# - hesperus.net
https://www.hesperus.net/csharp/color_matrix.aspxColorMatrix クラス (System.Drawing.Imaging) | Microsoft Docs
https://docs.microsoft.com/ja-jp/dotnet/api/system.drawing.imaging.colormatrix?view=netframework-4.5ImageAttributes.SetColorMatrix メソッド (System.Drawing.Imaging) | Microsoft Docs
https://docs.microsoft.com/ja-jp/dotnet/api/system.drawing.imaging.imageattributes.setcolormatrix?view=netframework-4.5コントロールのデータ連結機能(Control.DataBindings, Binding, データバインディング) - いろいろ備忘録日記
https://devlights.hatenablog.com/entry/20070413/p1Data Binding With INotifyPropertyChanged Interface
https://www.c-sharpcorner.com/UploadFile/020f8f/data-binding-with-inotifypropertychanged-interface/


