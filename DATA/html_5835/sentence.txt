More than 3 years have passed since last update.　クロマキー。よくテレビの天気予報とかでやっているあれですね。普通はグリーンバックといって、グリーンの色ムラのないカーテンのようなものを背景に使うのですが、今回はそのカーテンを使わずに背景差分を使ってクロマキーを実現しようということです。　クロマキーを実現するには２つの画像（「A:背景として重ねる画像」と「B:前景となるものが写っている画像」）を用意します。「A:背景として重ねる画像」とは空撮映像とか天気予報図の映像とかですね。「B:前景となるものが写っている画像」とは、ウルトラマンとかお天気お姉さんとかですね。
　前提として「B:前景となるものが写っている画像」の実際の撮影場所には背景（透過させたい部位）にグリーンのカーテンがひかれています。そのため画像処理にてグリーン部位を透過させる（RGBAのAを0にするということ）ということができるわけです。最後にレイヤーの後ろに「A:背景として重ねる画像」を表示させることで完成です。簡単ですね。
　当然ながら、前景にグリーンがあるとそれも意図せず透過されてしまいます。（天気予報の映像にガチャピンがでてきてしまい、トラブルとなったことがありましたね）　「B:前景となるものが写っている画像」にグリーンのカーテンがありません。なのでどこを透過させるべきかがわかりません。そこで動かないものを透過させてしまえ。という考え方です。
　事前に基準画像（キャリブレーションといいます）を撮影しておきます。映像から連続の画像を取り出し、キャリブレーション画像との差分値を取り、差分がないもの（つまり、動かないもの）を透過させます。透過後の画像を「A:背景として重ねる画像」と組み合わせることでクロマキーを実現します。グレースケールではなくRGBそれぞれのの差分値を取ることでより細かいレベルでの透過のマスクを作り出すことができます。コードだと以下のような感じになります。


