More than 5 years have passed since last update.自作ツールの動作パラメータの確認画面としてListView(Details)を利用しました。
でも、パラメータであるからにはその値を変更する局面が必ず存在します。
別途編集画面を出すってのもアリはアリなんですけど、イマイチかっちょ悪い感じ。
ここはひとつ、ListViewはそのままにExcelのセル編集モードみたいな感じで編集が出来ると良いなぁ…とか思ったりして。ListViewはSubItemの直接編集機能は持っていません。
代替策として該当エリアにWidgetを重ねて表示して、あたかも直接編集しているかの様なエクスペリエンスを与えようぜぃ、と云うのが MSの見解 の様です。ところで、上の参照ページではListViewをサブクラス化しています。
でもさー、やりたい事はただSubItemの直接編集ちっくな動きをしたいだけなんですよねーまぁ実際問題としてサブクラス化した方が千倍も使い勝手がよくなることは自明の理。
しかーし、ここはひとつサブクラス化を前提としないでTextBoxによる直接編集に必要な技術要素は何なのか？
辺りを纏めてみたいと思います。取り敢えず直接編集ちっくを実現するために必要な要素を挙げてみる。ま、これ位あれば良さげ。サブクラス化は眼中にないので、取り敢えずListViewとTextBoxはフォーム上に配置されている前提で話を進めても良いよね？
となると、結局「直接編集モード」ってなんなん？
ってのを明らかにする事こそ一番重要なポイントだな。それは…と云う一連の流れ、って事にしましょう。
すると、現時点で少なくとも明確に定義されていなくてはならない事項は、と…
それじゃこれ以降、上の４つを明文化していこう。これは、マウスのダブルクリックが一番適当でしょうかねぇ。
ListView の MouseDoubleClick イベントをとっ捕まえて編集モードに突入する、と云う事で…って感じかなぁ…
ここら辺を合わせて取り敢えずコード化してみる。んー、ちょっとイメージ的に微妙だが、ここは TextBox がフォーカスを失った時がモードを抜けるトリガとなる。
モードを抜けたからフォーカスを失うんじゃないって事が重要だな。そして、微妙ってのはそもそも―
 俺ってば何でフォーカス失くしちまったんだーっっ！！ 
と云うドラマがあって、実はそっちの方にフォーカス（焦点の方）をあてる方が本題っぽいんだよねー。
この人間模様については、別途考える事にしよう。これは2)のほぼ裏返し。で、コードとしてはこれ位。さて、前振りしといたヤツですけど、ちょっと分類してみよう。上記ですべての要因を列挙出来ている訳ではないので、必要に応じて拡張が必要かもね。
※ コントローラブルって表現がイマイチしっくりこないけど、深く考えないでくださいまず、自分でフォーカスを手放す方から。
キー操作の中でモードを抜ける感じなので、 KeyPress イベントで引っ掛ける。お次は、コントローラブルな外部要因なんだが―
③は今回無視（コードでは対応しない）する。
Tabキーを押せばフォーカスを失うので、勝手にモード終了トリガが引かれる事になる（これはアンコントローラブルな外部要因と同じって事）。④は ListView の Resize イベントハンドラで終了トリガを引く。⑤はやっかい。
  ListView にはスクロールに関するハンドラが準備されていないのだよ。
 もしそれがあれば以下のようなコードになるだろう。ところで、何故スクロールを察知したなら直接編集ちっくモードを抜ける必要があるのか？
それは、セルにぴったり重ねた筈の TextBox がスクロールによって置いてけぼりにされてしまうから…
間抜けでしょ？勿論、モードを抜けるんじゃなくて、セルに追従するって対応もアリだ。
めんどくさいから私はやらないけど。めんどくさいと云えば（無理矢理だなぁ…）、一筋縄ではいきそうにない上記スクロールを如何に察知するのか？
これは ListView のサブクラス化（でた！）で対応するのが一つ、二つ目の方法としてはMS謹製のWndProcHookerを利用するって手もある。私は後者を「ふっかちゃん」と呼んでちょくちょく便利に使わせて貰っている…閑話休題(それはさておき)―
本稿では第３の選択肢として、特に何もしないという方針で進めたいと思う。
まぁ TextBox 以外をクリックすればモードは終了に向かって流れるので、気にしない気にしない…
（∵別稿で諸々含めてきちんとサブクラス対応しますので…）では、小出しにしてきたコードを纏めよう。
序に、上では説明してこなかった以下の点を織り込んでいきたいと思う。あ、あと前提を整理しておこう。画面のイメージはこんな感じ

デザイナでListViewとTextBoxは配置しておくという事で…（どう配置するかはお任せ）イベントハンドラもデザイナで定義しておいてね直接編集ちっく可能なカラムは「カラム2」だけお、もう一つ。
決して効率の良いコードではないので、そこんところは気を付ける様に。では、どうぞこんな感じになります。

これはこれで、そこそこ動きます。
当然、微妙な境界条件の所で妙な動きをする事はあります。（スクロールとかね、実装してないもんで）と云う事で、次回はこれをサブクラス化してスクロールにも対応したいと思います。
っても、目新しい項目はないので、ソース載せるだけで終わってしまうかも。で、その先にListViewItemやらListViewSubItemやらのサブクラス化にも挑戦したいと思ってます。


