<!DOCTYPE html><html><head><meta charset="utf-8" /><title>【Unity】ゼロから作るノードベースエディター【UIElements】 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/saragai/items/f7f88df863091946c9d1" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="Z9y9mjNbtXqPlqvLWd7lFL9phAOj/JAwhVbfYoR+9+LREQp7oyL4TYJKxdhhZkPvPZSXGyzQhgXfwprwkf9AZg==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="【Unity】ゼロから作るノードベースエディター【UIElements】 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRVlc1cGRIbmpnSkhqZ3J6amc2M2pnWXZqZ29ua3Zaempnb3ZqZzQ3amc3empnNG5qZzVuamc3empncm5qZ3Fqamc0ZmpncVBqZ3Jfamc3empnSkJWU1VWc1pXMWxiblJ6NDRDUiZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0xM2U0YmZjMGI3YmMwY2I4MGM4ZmM3ODE4YTQ1NDM5ZA&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5oY21GbllXayZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWRlZDliYTc1ZjlkYWE4Mzk3OGRiZDUwOTg2NjdkYzA2&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=c094762591080a7740ae565d9e211b7e"><meta property="og:description" content="

概要

UnityのUIElementsによってこのようなノードベースエディタを作ります。


タイトルの「ゼロから」は、「UIElements」を知らないところから、という意味です。
そのため、UIElemtnsに関する前提知識..."><meta content="https://qiita.com/saragai/items/f7f88df863091946c9d1" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity,UnityEditor,UIElements,GraphView" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-f23de7a1-cc0a-466f-9a2c-aa00255a5884"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fsaragai%2Fitems%2Ff7f88df863091946c9d1">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fsaragai%2Fitems%2Ff7f88df863091946c9d1">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-f23de7a1-cc0a-466f-9a2c-aa00255a5884">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-12-21T18:45:25.000+09:00","dateModified":"2020-01-09T00:07:36.000+09:00","headline":"【Unity】ゼロから作るノードベースエディター【UIElements】","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NENRVlc1cGRIbmpnSkhqZ3J6amc2M2pnWXZqZ29ua3Zaempnb3ZqZzQ3amc3empnNG5qZzVuamc3empncm5qZ3Fqamc0ZmpncVBqZ3Jfamc3empnSkJWU1VWc1pXMWxiblJ6NDRDUiZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0xM2U0YmZjMGI3YmMwY2I4MGM4ZmM3ODE4YTQ1NDM5ZA\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5oY21GbllXayZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWRlZDliYTc1ZjlkYWE4Mzk3OGRiZDUwOTg2NjdkYzA2\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=c094762591080a7740ae565d9e211b7e","mainEntityOfPage":"https://qiita.com/saragai/items/f7f88df863091946c9d1","author":{"@type":"Person","address":"Tokyo, Japan","email":null,"identifier":"saragai","name":"saragai","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F189786%2Fprofile-images%2F1498789786?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9d1f06bc9a3b7a50e5f15d582ddd20a9","url":"https://qiita.com/saragai","description":"都内にいます","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"saragai","type":"items","id":"f7f88df863091946c9d1"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"saragai","type":"items","id":"f7f88df863091946c9d1"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"saragai","type":"items","id":"f7f88df863091946c9d1"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/saragai/items/f7f88df863091946c9d1","location":"/saragai/items/f7f88df863091946c9d1","scheme":"https","host":"qiita.com","port":null,"pathname":"/saragai/items/f7f88df863091946c9d1","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"aN4YEiPI4pYuv89lPBI6xvM4rVxxdRy5nnJxtXVeF2zeE6/zs7GvoSNjoXYEqpw9ccW+RP5ZCozE5jQnYN+g6A==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-96051e73-ebb7-492a-a86e-a8237bd0cd39"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/saragai/items/f7f88df863091946c9d1/likers" class="css-1iupg5d">64</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">48</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/f7f88df863091946c9d1/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/saragai/items/f7f88df863091946c9d1/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/saragai/items/f7f88df863091946c9d1/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/saragai/items/f7f88df863091946c9d1/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/saragai/items/f7f88df863091946c9d1.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2019/unity2" class="it-AdcalRibbon_title">Unity #2<!-- --> Advent Calendar<!-- --> <!-- -->2019</a>Day 17</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/saragai"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/189786/profile-images/1498789786" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/saragai" class="css-10ougpm">@<!-- -->saragai</a><div class="css-1ay9vb9"><span><meta content="2019-12-21T09:45:25Z"/><time dateTime="2020-01-08T15:07:36Z" class="css-m19uds">updated at 2020-01-08</time></span></div></div></div></div></div><h1 class="css-cgzq40">【Unity】ゼロから作るノードベースエディター【UIElements】</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/unityeditor" class="css-4czcte">UnityEditor</a><a href="/tags/uielements" class="css-4czcte">UIElements</a><a href="/tags/graphview" class="css-4czcte">GraphView</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h1>

<p>UnityのUIElementsによってこのようなノードベースエディタを作ります。<br>
<a href="https://camo.qiitausercontent.com/281875bc4df480afa97dcfc5b06320159d211439/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32356230643735332d333636312d623439302d373131332d3565316630393863376139612e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F25b0d753-3661-b490-7113-5e1f098c7a9a.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9d52a9118d199eb96962ec01c36b25ef" alt="NodeEditor-36.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/25b0d753-3661-b490-7113-5e1f098c7a9a.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F25b0d753-3661-b490-7113-5e1f098c7a9a.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e5105bdb6a38973426b4cf0f30ea80c2 1x" loading="lazy"></a></p>

<p>タイトルの「ゼロから」は、「UIElements」を知らないところから、という意味です。<br>
そのため、UIElemtnsに関する前提知識は必要ありません。</p>

<p>Unityのバージョンは2019.1.3f1です。<br>
プロジェクトはGitHubに挙げておきます。<br>
<a href="https://github.com/saragai/GraphEditor/tree/article" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/saragai/GraphEditor/tree/article</a></p>

<p><strong>2019/12/23 追記：バージョン2019.2.16f1でこのエディタを使用したところ、エッジの選択ができなくなっていました。</strong><br>
<strong>2020/01/09 追記：上記の不具合を修正し、反映しました。変更ファイルはEdgeElement.csとEdgeConnector.csのみです。</strong></p>

<h1>
<span id="背景" class="fragment"></span><a href="#%E8%83%8C%E6%99%AF"><i class="fa fa-link"></i></a>背景</h1>

<p>Unity2019からUIElementsというUIツールが入りました。<br>
現在はエディタ拡張にしか使えませんが、将来的にはゲーム内部のUIにも使えるようになるそうです。</p>

<p>最近の機能でいえば、ShaderGraphのようなGUIツールもUIElementで作られています。</p>

<p><a href="https://camo.qiitausercontent.com/8b4433433b988db6ab067ca0790278140afa19cd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f38613837343831632d396533392d373439322d643334372d3534363965316165613933612e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8a87481c-9e39-7492-d347-5469e1aea93a.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c911b00406d3f319e9408f56e3db6cca" alt="shader_graph_sample.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/8a87481c-9e39-7492-d347-5469e1aea93a.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8a87481c-9e39-7492-d347-5469e1aea93a.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=64be94f7e9357030e6659b62009d5bdf 1x" loading="lazy"></a><br>
[画像は引用：<a href="https://unity.com/ja/shader-graph" class="autolink" rel="nofollow noopener" target="_blank">https://unity.com/ja/shader-graph</a>]</p>

<p>これはGraphViewというノードベースエディタによって作られていて、GraphViewを使えばShaderGraphのようなヴィジュアルツールを作成できます。<br>
[参照：<a href="https://qiita.com/ma_sh/items/7627a6151e849f5a0ede" id="reference-77a464b12c1b1b1714b1">GraphView完全理解した(2019年末版)</a>]</p>

<p>さて、本記事の目標はGraphViewのようなのツールを作ることです。</p>

<p>いやGraphView使えばいいじゃん、と思った方は鋭いです。実用に耐えるものを作るなら、使った方がよいと思います。<br>
さらに、本記事はUnityが公開している<a href="https://github.com/Unity-Technologies/UnityCsReference/tree/master/Modules/GraphViewEditor" rel="nofollow noopener" target="_blank">GraphViewの実装</a>を大いに参考にしているので、GraphViewを使うならすべて無視できる内容です。</p>

<p>とはいえ、内部でどんなことをすると上記画像のようなエディタ拡張ができるのか、気になる方も多いのではと思います。<br>
その理解の一助となればと思います。</p>

<p>注）この記事は手順を細かく解説したり、あえて不具合のある例を付けたりしているので、冗長な部分が多々あります。</p>

<h1>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h1>

<p>公式ドキュメントを見ながら実装していきます。<br>
<a href="https://docs.unity3d.com/2019.1/Documentation/Manual/UIElements.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.unity3d.com/2019.1/Documentation/Manual/UIElements.html</a><br>
<a href="https://docs.unity3d.com/2019.3/Documentation/ScriptReference/UIElements.VisualElement.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.unity3d.com/2019.3/Documentation/ScriptReference/UIElements.VisualElement.html</a></p>

<h2>
<span id="0-挨拶" class="fragment"></span><a href="#0-%E6%8C%A8%E6%8B%B6"><i class="fa fa-link"></i></a>0. 挨拶</h2>

<p>エディタ拡張用のスクリプトは必ず Assets/[どこでもいい]/Editor というディレクトリの下に置きます。ビルド時にビルド対象から外すためです。<br>
というわけで、Assets/Scripts/Editor にC#ファイルを作って GraphEditor と名付けます。</p>

<p>Graphとは、頂点と辺からなるデータ構造を示す用語で、ビヘイビアツリーや有限オートマトンもGraphの一種です。ビヘイビアツリーの場合はアクションやデコレータが頂点、それぞれがどのようにつながっているかが辺に対応します。ひとまずの目標は、このグラフを可視化できるようにすることです。</p>

<p>とはいえ、まだUIElementsと初めましてなので、まずは挨拶から始めます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditor.cs</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">GraphEditor</span> <span class="p">:</span> <span class="n">EditorWindow</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">MenuItem</span><span class="p">(</span><span class="s">"Window/GraphEditor"</span><span class="p">)]</span>  <span class="c1">// Unityのメニュー/Window/GraphEditorから呼び出せるように</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ShowWindow</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">GraphEditor</span> <span class="n">graphEditor</span> <span class="p">=</span> <span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">GraphEditor</span><span class="p">&gt;();</span>  <span class="c1">// ウィンドウを作成。</span>
        <span class="n">graphEditor</span><span class="p">.</span><span class="nf">Show</span><span class="p">();</span>  <span class="c1">// ウィンドウを表示</span>
        <span class="n">graphEditor</span><span class="p">.</span><span class="n">titleContent</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GUIContent</span><span class="p">(</span><span class="s">"Graph Editor"</span><span class="p">);</span>  <span class="c1">// Windowの名前の設定</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="https://blogs.unity3d.com/jp/2019/04/23/whats-new-with-uielements-in-2019-1/" rel="nofollow noopener" target="_blank">Unity公式ブログ</a>のはじめの例を参考にしました。</p>

<p>ウィンドウが作成されたときに呼ばれるOnEnable()で、はじめてUIElementsと対面します。<br>
見たところ、UIElementsはウィンドウの大元にあるrootVisualElementにどんどん要素を追加していく方式なんですね。<br>
rootVisualElementはVisualElementクラスで、LabelもVisualElementクラスを継承しています。</p>

<p>さあ、メニューからWindow/GraphEditorを選択すると以下のようなウィンドウが表示されます。</p>

<p><a href="https://camo.qiitausercontent.com/ff469b153518d73935b09a0dbfe61fb12767b3d6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f38656539643835612d343036372d626431622d393635332d3934333835623230346363632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8ee9d85a-4067-bd1b-9653-94385b204ccc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=084bfd5828ba8778d4471659751ec3bf" alt="NodeEditor-0.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/8ee9d85a-4067-bd1b-9653-94385b204ccc.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8ee9d85a-4067-bd1b-9653-94385b204ccc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f264c5dcc37321253b5ede09898cd00b 1x" loading="lazy"></a></p>

<p>こんにちは！<br>
ひとまず、挨拶は終わりました。</p>

<h2>
<span id="1-ノードを表示する" class="fragment"></span><a href="#1-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. ノードを表示する</h2>

<p>Inspectorのように、行儀よく上から下へ情報を追加していくUIであれば、あとは色を変えてみたり、ボタンを追加してみたり、水平に並べてみたりすればいいのですが、ノードベースエディタを作ろうとしているのでそれだけでは不十分です。<br>
四角形を自由自在に動かせなければいけません。</p>

<p>ドキュメントには、UIElementの構造の説明として、このような図がありました。<br>
<a href="https://camo.qiitausercontent.com/6e585a737bc2eb9fe3a82e77a52a2c166a2ccf6e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f66633039636230612d346333322d663937662d323961322d3161636465323963626261342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ffc09cb0a-4c32-f97f-29a2-1acde29cbba4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=aa1b1c52c89f5177cca991e19918daa5" alt="visualtree-hierarchy.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/fc09cb0a-4c32-f97f-29a2-1acde29cbba4.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ffc09cb0a-4c32-f97f-29a2-1acde29cbba4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=c058b3839ea4fb05f4ba395bd6ba2e73 1x" loading="lazy"></a><br>
[画像は引用：<a href="https://docs.unity3d.com/ja/2019.3/Manual/UIE-VisualTree.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.unity3d.com/ja/2019.3/Manual/UIE-VisualTree.html</a>]<br>
まずは、このred containerのような四角形を出したいですね。</p>

<p>というわけでいろいろ試してみます。</p>

<h3>
<span id="11-表示場所を指定する" class="fragment"></span><a href="#11-%E8%A1%A8%E7%A4%BA%E5%A0%B4%E6%89%80%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1.1 表示場所を指定する</h3>

<p><a href="https://docs.unity3d.com/ja/2019.3/Manual/UIE-VisualTree.html" rel="nofollow noopener" target="_blank">ドキュメント</a>によるとVisualElementはそれぞれlayoutなるメンバを持っていて、layout.positionやlayout.transformによって親に対する位置が決まるようです。実際に試してみましょう。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditor.cs</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">GraphEditor</span> <span class="p">:</span> <span class="n">EditorWindow</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">MenuItem</span><span class="p">(</span><span class="s">"Window/GraphEditor"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ShowWindow</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">GraphEditor</span> <span class="n">graphEditor</span> <span class="p">=</span> <span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">GraphEditor</span><span class="p">&gt;();</span>
        <span class="n">graphEditor</span><span class="p">.</span><span class="nf">Show</span><span class="p">();</span>
        <span class="n">graphEditor</span><span class="p">.</span><span class="n">titleContent</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GUIContent</span><span class="p">(</span><span class="s">"Graph Editor"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">));</span>

        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"One"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElement.cs</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">NodeElement</span> <span class="p">:</span> <span class="n">VisualElement</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">NodeElement</span> <span class="p">(</span><span class="n">Node</span> <span class="n">node</span><span class="p">,</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">style</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StyleColor</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
        <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">pos</span><span class="p">;</span>

        <span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>先ほどと違うのは、NodeElementクラスですね。<br>
NodeはGraphの頂点のことで、有限オートマトンでいうと状態に対応します。</p>

<p>このNodeElementのコンストラクタに色と位置を渡して、内部でstyle.backgroundClorとtransform.positionを設定します。<br>
それをrootにAddして、どのように表示されるかを見てみます。</p>

<p>以下、結果です。<br>
<a href="https://camo.qiitausercontent.com/3c5ef531a2a936b01e7bfec03aa967dca02e32a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f34666666376137312d363032372d633162352d636164622d3336373833663138623337652e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F4fff7a71-6027-c1b5-cadb-36783f18b37e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8b078a429d477d8f73745d58f3546983" alt="NodeEditor-1.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/4fff7a71-6027-c1b5-cadb-36783f18b37e.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F4fff7a71-6027-c1b5-cadb-36783f18b37e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=10575786a997321a55edfcb8b80ecf3d 1x" loading="lazy"></a><br>
お！<br>
表示位置が唐突な場所になっていますね。<br>
右にずっと伸びていますが、まだ幅を指定していないからでしょう。</p>

<p>もう一つ追加してみましょう。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorクラス</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">));</span>

        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"One"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"Two"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">yellow</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><a href="https://camo.qiitausercontent.com/8649efcb7e5569e2e26f201cbad2b000a463d7b8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31613563353837392d323764332d383035632d303639352d3834363534336637366465342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1a5c5879-27d3-805c-0695-846543f76de4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=eea538a473311dfe92ee0e5aeea30a21" alt="NodeEditor-2.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/1a5c5879-27d3-805c-0695-846543f76de4.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1a5c5879-27d3-805c-0695-846543f76de4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1646e4b39dad5356582dcb8595a5065e 1x" loading="lazy"></a><br>
……あれ？<br>
同じY座標を指定したのに二つのノードは重なっていません。</p>

<p>本当は、<br>
<a href="https://camo.qiitausercontent.com/5b1c183eb44649fed506c93ff84e4f5f47d54c4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f64646165303037652d653830652d376464332d326639322d3431616238616633666338622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fddae007e-e80e-7dd3-2f92-41ab8af3fc8b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e5e17d85b8acd5bc14fa7180323545b6" alt="NodeEditor-3.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/ddae007e-e80e-7dd3-2f92-41ab8af3fc8b.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fddae007e-e80e-7dd3-2f92-41ab8af3fc8b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=bb96f3abc691580177efef610014069a 1x" loading="lazy"></a><br>
このようになって欲しかったのです。<br>
ちなみに、この時点で上の図のようにするには以下を書きました。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorクラス</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">));</span>

        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"One"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"Two"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">yellow</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">32</span><span class="p">)));</span>  <span class="c1">// y座標を変更</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>どうやら18ピクセルだけ勝手に下にずらされていたようです。困ります。いい感じに自動レイアウトしてくれるという親切心だとは思うのですが、私が今作りたいのはヴィジュアルツールなので、上下左右に自在に動かしたいのです。</p>

<p>探すと<a href="https://docs.unity3d.com/ja/2019.3/Manual/UIE-LayoutEngine.html" rel="nofollow noopener" target="_blank">別のドキュメント</a>にありました。</p>

<blockquote>
<p>Set the <strong>position</strong> property to <strong>absolute</strong> to place an element relative to its parent position rectangle. In this case, it does not affect the layout of its siblings or parent.</p>
</blockquote>

<p>positionプロパティをabsoluteにすれば兄弟(=siblings)や親の影響を受けないよとあります。<br>
positionプロパティってなんだと思いましたが、VisualStudioの予測変換機能を駆使して見つけました。</p>

<p>NodeElementのコンストラクタを以下のように書き換えます</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElementクラス</span>
    <span class="k">public</span> <span class="nf">NodeElement</span> <span class="p">(</span><span class="n">Node</span> <span class="n">node</span><span class="p">,</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">style</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StyleColor</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
        <span class="n">style</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Position</span><span class="p">.</span><span class="n">Absolute</span><span class="p">;</span>  <span class="c1">// 追加。これがposition propertyらしい</span>
        <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">pos</span><span class="p">;</span>

        <span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>すると、</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorクラス</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="s">"Hello, World!"</span><span class="p">));</span>

        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"One"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"Two"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">yellow</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>は以下のようになります。<br>
<a href="https://camo.qiitausercontent.com/ecada519abb41b3c1baf6b8da0e585345a8b94c0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f30616631323236372d633261332d313262652d393238382d6364343563376531346330302e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F0af12267-c2a3-12be-9288-cd45c7e14c00.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b818a345993917278f4e9a66d23464e1" alt="NodeEditor-4.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/0af12267-c2a3-12be-9288-cd45c7e14c00.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F0af12267-c2a3-12be-9288-cd45c7e14c00.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=63624aa18fbf4efaba305d629ee04e6e 1x" loading="lazy"></a></p>

<p>ちゃんと同じ高さになりました！<br>
なぜか横方向の帯も消えています。</p>

<p>これで位置を自由に指定できるようになりました。</p>

<h3>
<span id="12-大きさを指定する" class="fragment"></span><a href="#12-%E5%A4%A7%E3%81%8D%E3%81%95%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1.2 大きさを指定する</h3>

<p>次は四角形の大きさを指定します。位置指定はラベルで実験したので勝手に大きさを合わせてくれていましたが、自由に幅や高さを指定したいです。<br>
このような見た目に関する部分はだいたい<code>VisualElement.style</code>にまとまっているようで、以下のように指定します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElementクラス</span>
    <span class="k">public</span> <span class="nf">NodeElement</span> <span class="p">(</span><span class="n">Node</span> <span class="n">node</span><span class="p">,</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">style</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StyleColor</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
        <span class="n">style</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Position</span><span class="p">.</span><span class="n">Absolute</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">height</span> <span class="p">=</span> <span class="m">50</span><span class="p">,</span>
        <span class="n">style</span><span class="p">.</span><span class="n">width</span> <span class="p">=</span> <span class="m">100</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">pos</span><span class="p">;</span>

        <span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>すると以下のようになります。<br>
<a href="https://camo.qiitausercontent.com/8e8d60bfc79851d8f088e3796785e545c152ba0d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f61366563356231612d646266392d346166392d653163372d6430356331386366656437322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fa6ec5b1a-dbf9-4af9-e1c7-d05c18cfed72.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7cb5166738f09c2c850784103b6cb8a2" alt="NodeEditor-5.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/a6ec5b1a-dbf9-4af9-e1c7-d05c18cfed72.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fa6ec5b1a-dbf9-4af9-e1c7-d05c18cfed72.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=36c4be56391cf6aa79a9de394a8dc2a2 1x" loading="lazy"></a></p>

<p>初めに言った、red containerのようになったと思います。<br>
<a href="https://camo.qiitausercontent.com/6cdd8bcbdec2ecba7aba39cb0e8cc53c4840883e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31336636386135322d323137622d663461332d383730362d6664653130363965396233342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F13f68a52-217b-f4a3-8706-fde1069e9b34.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3e857a32b0a922bffc990f1c90dc4b43" alt="visualtree-hierarchy.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/13f68a52-217b-f4a3-8706-fde1069e9b34.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F13f68a52-217b-f4a3-8706-fde1069e9b34.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5aeacc71e96ee1774aa287082c9d3466 1x" loading="lazy"></a></p>

<h2>
<span id="2-ノードを動かす" class="fragment"></span><a href="#2-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99"><i class="fa fa-link"></i></a>2. ノードを動かす</h2>

<p>次は表示した四角形をインタラクティブに移動させます。<br>
ヴィジュアルツールでは、見やすいように位置を動かすことは大事です。</p>

<p>挙動としては、<br>
1. 四角形を左クリックして選択<br>
2. そのままドラッグすると一緒に動く<br>
3. ドロップで現在の位置に固定<br>
というのを想定しています。</p>

<h3>
<span id="21-まずは試してみる" class="fragment"></span><a href="#21-%E3%81%BE%E3%81%9A%E3%81%AF%E8%A9%A6%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>2.1 まずは試してみる</h3>

<p>これらはどれもマウスの挙動に対しての反応なので、マウスイベントに対するコールバックとして実装します。<br>
探すと公式ドキュメントに<a href="https://docs.unity3d.com/ja/2019.3/Manual/UIE-Events.html" rel="nofollow noopener" target="_blank">The Event System</a>という項がありました。<br>
いろいろと重要そうなことが書いてある気がしますが、今はとりあえずイベントを取りたいのでその中の<a href="https://docs.unity3d.com/ja/2019.3/Manual/UIE-Events-Handling.html" rel="nofollow noopener" target="_blank">Responding to Events</a>を見てみます。<br>
どうやら、<code>VisualElement.RegisterCallback()</code>によってコールバックを登録できるみたいですね。</p>

<p>マウスに関するイベントはそれぞれ、<br>
1. <code>MouseDownEvent</code><br>
2. <code>MouseMoveEvent</code><br>
3. <code>MouseUpEvent</code><br>
でとることができそうです。</p>

<p>NodeElementクラスを以下のように書き換えます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElementクラス</span>
    <span class="k">public</span> <span class="nf">NodeElement</span> <span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">style</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StyleColor</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
        <span class="n">style</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Position</span><span class="p">.</span><span class="n">Absolute</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">height</span> <span class="p">=</span> <span class="m">50</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">width</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>

        <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">pos</span><span class="p">;</span>

        <span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>

        <span class="kt">bool</span> <span class="n">focus</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

        <span class="nf">RegisterCallback</span><span class="p">((</span><span class="n">MouseDownEvent</span> <span class="n">evt</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">button</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>  <span class="c1">// 左クリック</span>
            <span class="p">{</span>
                <span class="n">focus</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>  <span class="c1">// 選択</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="nf">RegisterCallback</span><span class="p">((</span><span class="n">MouseUpEvent</span> <span class="n">evt</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">focus</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>  <span class="c1">// 選択を解除</span>
        <span class="p">});</span>

        <span class="nf">RegisterCallback</span><span class="p">((</span><span class="n">MouseMoveEvent</span> <span class="n">evt</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">focus</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">+=</span> <span class="p">(</span><span class="n">Vector3</span><span class="p">)</span><span class="n">evt</span><span class="p">.</span><span class="n">mouseDelta</span><span class="p">;</span>  <span class="c1">// マウスが動いた分だけノードを動かす</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>すると、以下のような挙動になります。<br>
<a href="https://camo.qiitausercontent.com/fc78b237a77c649cd0b697a3d5870d1feccfd8e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f61636165383036312d663031642d656264362d376235362d6561623339366437656663662e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Facae8061-f01d-ebd6-7b56-eab396d7efcf.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=25986b5127bd8d43a28628e17bbfad91" alt="NodeEditor-7.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/acae8061-f01d-ebd6-7b56-eab396d7efcf.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Facae8061-f01d-ebd6-7b56-eab396d7efcf.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=100d3da8762a69fae30feb7ba3e087be 1x" loading="lazy"></a><br>
動きましたが、少し使いにくそうな動きです。<br>
まず、赤いノードが黄色のノードの下にあるせいで、赤を動かしている途中にカーソルが黄色の上に来ると、赤が動かなくなってしまいます。<br>
さらにそのあと右クリックをやめても選択が解除されておらず、赤が勝手に動いてしまいます。これは、<code>MouseUpEvent</code>が赤いノードに対して呼ばれていないことが問題のようです。</p>

<p>改善策は、<br>
1. 選択したノードは最前面に来てほしい<br>
2. カーソルがノードの外に出たときにも、マウスイベントは呼ばれてほしい<br>
の二つです。</p>

<h3>
<span id="22-visualelementの表示順を変える" class="fragment"></span><a href="#22-visualelement%E3%81%AE%E8%A1%A8%E7%A4%BA%E9%A0%86%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B"><i class="fa fa-link"></i></a>2.2 VisualElementの表示順を変える</h3>

<p>ドキュメントの<a href="https://docs.unity3d.com/ja/2019.3/Manual/UIE-VisualTree.html" rel="nofollow noopener" target="_blank">The Visual Treeの項目</a>に、Drawing orderの項があります。</p>

<blockquote>
<p><strong>Drawing order</strong><br>
The elements in the visual tree are drawn in the following order:<br>
- parents are drawn before their children<br>
- children are drawn according to their sibling list</p>

<p>The only way to change their drawing order is to reorder <em>VisualElementobjects</em> in their parents.</p>
</blockquote>

<p>描画順を変えるには親オブジェクトが持つVisualElementを並び替えないといけないようです。<br>
それ以上の情報がないので<a href="https://docs.unity3d.com/2019.3/Documentation/ScriptReference/UIElements.VisualElement.html" rel="nofollow noopener" target="_blank">VisualElementのスクリプトリファレンス</a>を見てみます。その中のメソッドでそれらしいものがないかを探すと……ありました。</p>

<p><code>BringToFront()</code>というメソッドで、親の子供リストの中の最後尾へ自分を持っていくものです。<br>
これをMouseDownEventのコールバックに追加します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElementクラス</span>
        <span class="nf">RegisterCallback</span><span class="p">((</span><span class="n">MouseDownEvent</span> <span class="n">evt</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">button</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">focus</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="nf">BringToFront</span><span class="p">();</span>  <span class="c1">// 自分を最前面に持ってくる</span>
            <span class="p">}</span>
        <span class="p">});</span>
</code></pre></div></div>

<p>実行結果は以下です。<br>
<a href="https://camo.qiitausercontent.com/c49415c800a3e4c75f72f6feb3b984659e1e26c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f61353630383238332d343830312d623566332d333530662d3430643130356264306137382e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fa5608283-4801-b5f3-350f-40d105bd0a78.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fb796a1c0203bb6876c1dde44469857b" alt="NodeEditor-8.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/a5608283-4801-b5f3-350f-40d105bd0a78.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fa5608283-4801-b5f3-350f-40d105bd0a78.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1c00cfcd640f10da3e131aa687dd5c28 1x" loading="lazy"></a><br>
クリックしたものが最前面へきているのがわかります。<br>
しかし、動画後半のように、マウスを勢いよく動かすとノードがついてこられないことがわかります。</p>

<h3>
<span id="23-マウスイベントをキャプチャする" class="fragment"></span><a href="#23-%E3%83%9E%E3%82%A6%E3%82%B9%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2.3 マウスイベントをキャプチャする</h3>

<p>マウスを勢いよく動かしたとき、カーソルがノードの外に出るので<code>MouseLeaveEvent</code>が呼ばれるはずです。その時にPositionを更新してドラッグ中は常にノードがカーソルの下にあるようにすればよい、と初めは思っていました。<br>
ですが、それだと勢いよく動かした直後にマウスクリックを解除した場合に、<code>MouseUpEvent</code>が選択中のノードに対して呼ばれないようなのです。<br>
イベントの呼ばれる順序にかかわる部分で、丁寧に対応してもバグの温床になりそうです。</p>

<p>いい方法はないかなとドキュメントを読んでいると、よさそうなものを見つけました。<br>
<a href="https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html" rel="nofollow noopener" target="_blank">Dispatching Events</a>の中のCapture the mouseという項です。</p>

<p>VisualElementは<code>CaptureMouse()</code>を呼ぶことによって、カーソルが自身の上にないときでもマウスイベントを自分のみに送ってくれるようになるということで、まさにマウスをキャプチャしています。<br>
キャプチャすると、マウスが自分の上にあるかどうかを気にしなくてよくなるので、安心して使えそうです。</p>

<p>ということで、MouseDown時にキャプチャし、MouseUp時に解放するように書き換えてみます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElementクラス</span>
        <span class="nf">RegisterCallback</span><span class="p">((</span><span class="n">MouseDownEvent</span> <span class="n">evt</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">button</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">focus</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="nf">BringToFront</span><span class="p">();</span>
                <span class="nf">CaptureMouse</span><span class="p">();</span>  <span class="c1">// マウスイベントをキャプチャ</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="nf">RegisterCallback</span><span class="p">((</span><span class="n">MouseUpEvent</span> <span class="n">evt</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="nf">ReleaseMouse</span><span class="p">();</span>  <span class="c1">// キャプチャを解放</span>
            <span class="n">focus</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">});</span>

        <span class="nf">RegisterCallback</span><span class="p">((</span><span class="n">MouseCaptureOutEvent</span> <span class="n">evt</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">m_Focus</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>  <span class="c1">// キャプチャが外れたときはドラッグを終了する</span>
        <span class="p">}</span>
</code></pre></div></div>

<p><code>MouseCaptureOutEvent</code>は他の<code>VisualElement</code>などによってキャプチャを奪われたときに呼ばれる関数です。</p>

<p>実行結果は以下になります。<br>
<a href="https://camo.qiitausercontent.com/d596b28479c7b273213331f0d5d0313f44426970/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f35306138393764632d663637302d393031302d363031312d3736313066633162396232612e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F50a897dc-f670-9010-6011-7610fc1b9b2a.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=18475f1ec2703e2c3db1811d059037fe" alt="NodeEditor-9.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/50a897dc-f670-9010-6011-7610fc1b9b2a.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F50a897dc-f670-9010-6011-7610fc1b9b2a.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b399c7ebf07a1ff73cae751762555940 1x" loading="lazy"></a><br>
無事に意図した動きになりました。</p>

<h3>
<span id="24-ノードを動かすコードをmanipulatorによって分離する" class="fragment"></span><a href="#24-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92manipulator%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E5%88%86%E9%9B%A2%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>2.4 ノードを動かすコードをManipulatorによって分離する</h3>

<p>この後もノードには様々な機能が追加される予定ですので、コードが煩雑にならないためにも、ノードを動かす部分を分離してしまいたいです。<br>
どうしようか悩んでいましたが、UIElementsにはManipulatorという仕組みがあることを見つけました。<br>
Manipulatorを使うことで、「ノードを動かす」のような操作を追加するコードをきれいに分離して書くことができます。</p>

<p>NodeDraggerというクラスを作成します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeDragger.cs</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">NodeDragger</span> <span class="p">:</span> <span class="n">MouseManipulator</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">bool</span> <span class="n">m_Focus</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">NodeDragger</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 左クリックで有効化する</span>
        <span class="n">activators</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">ManipulatorActivationFilter</span> <span class="p">{</span> <span class="n">button</span> <span class="p">=</span> <span class="n">MouseButton</span><span class="p">.</span><span class="n">LeftMouse</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">/// Manipulatorにターゲットがセットされたときに呼ばれる</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">RegisterCallbacksOnTarget</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">m_Focus</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

        <span class="n">target</span><span class="p">.</span><span class="n">RegisterCallback</span><span class="p">&lt;</span><span class="n">MouseDownEvent</span><span class="p">&gt;(</span><span class="n">OnMouseDown</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">RegisterCallback</span><span class="p">&lt;</span><span class="n">MouseUpEvent</span><span class="p">&gt;(</span><span class="n">OnMouseUp</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">RegisterCallback</span><span class="p">&lt;</span><span class="n">MouseMoveEvent</span><span class="p">&gt;(</span><span class="n">OnMouseMove</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">RegisterCallback</span><span class="p">&lt;</span><span class="n">MouseCaptureOutEvent</span><span class="p">&gt;(</span><span class="n">OnMouseCaptureOut</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// Manipulatorのターゲットが変わる直前に呼ばれる</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">UnregisterCallbacksFromTarget</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">target</span><span class="p">.</span><span class="n">UnregisterCallback</span><span class="p">&lt;</span><span class="n">MouseDownEvent</span><span class="p">&gt;(</span><span class="n">OnMouseDown</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">UnregisterCallback</span><span class="p">&lt;</span><span class="n">MouseUpEvent</span><span class="p">&gt;(</span><span class="n">OnMouseUp</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">UnregisterCallback</span><span class="p">&lt;</span><span class="n">MouseMoveEvent</span><span class="p">&gt;(</span><span class="n">OnMouseMove</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">UnregisterCallback</span><span class="p">&lt;</span><span class="n">MouseCaptureOutEvent</span><span class="p">&gt;(</span><span class="n">OnMouseCaptureOut</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseDown</span><span class="p">(</span><span class="n">MouseDownEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 設定した有効化条件をみたすか (= 左クリックか)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">CanStartManipulation</span><span class="p">(</span><span class="n">evt</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">m_Focus</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">BringToFront</span><span class="p">();</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">CaptureMouse</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseUp</span><span class="p">(</span><span class="n">MouseUpEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// CanStartManipulation()で条件を満たしたActivationのボタン条件と、</span>
        <span class="c1">// このイベントを発火させているボタンが同じか</span>
        <span class="c1">// (= 左クリックを離したときか)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">CanStopManipulation</span><span class="p">(</span><span class="n">evt</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">ReleaseMouse</span><span class="p">();</span>
            <span class="n">m_Focus</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseCaptureOut</span><span class="p">(</span><span class="n">MouseCaptureOutEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_Focus</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseMove</span><span class="p">(</span><span class="n">MouseMoveEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_Focus</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">target</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">+=</span> <span class="p">(</span><span class="n">Vector3</span><span class="p">)</span><span class="n">evt</span><span class="p">.</span><span class="n">mouseDelta</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code>RegisterCallBacksOnTarget()</code>と<code>UnregisterCallbacksFromTarget()</code>は<code>Manipulator</code>クラスの関数で、イベントのコールバックの登録・解除を担っています。<br>
<code>activators</code>や<code>CanStartManipulation()</code>、<code>CanStopManipulation()</code>は<code>Manipulator</code>クラスを継承する<code>MouseManipulator</code>クラスの関数で、マウスのボタンの管理がしやすくなっています。<br>
細かいことはコード中のコメントに記載しました。</p>

<p>このManipulatorを使用するには、対象のVisualElementを設定しなければいけません。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElementクラス</span>
    <span class="k">public</span> <span class="nf">NodeElement</span> <span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">pos</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">style</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StyleColor</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
        <span class="n">style</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Position</span><span class="p">.</span><span class="n">Absolute</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">height</span> <span class="p">=</span> <span class="m">50</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">width</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>

        <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">pos</span><span class="p">;</span>

        <span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Label</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>

        <span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeDragger</span><span class="p">());</span>  <span class="c1">// 操作の追加が一行で済む</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><code>AddManipulator</code>という関数によって対象のVisualElementを設定しています。<br>
実はこのコードは以下のようにもかけます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>        <span class="k">new</span> <span class="nf">NodeDragger</span><span class="p">(){</span><span class="n">target</span> <span class="p">=</span> <span class="n">container</span><span class="p">};</span>
</code></pre></div></div>

<p>内部の実装を見ると、<code>AddManipulator</code>では<code>IManipulator.target</code>プロパティに自身をセットしているだけでした。<br>
そしてsetter内で、セットする前に既存のtargetがあれば<code>UnregisterCallbacksFromTarget()</code>を呼び、そのあと新規のターゲットをセットしてから<code>RegisterCallbacksOnTarget()</code>を呼びます。</p>

<p>[参照：<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/2019.1/Modules/UIElements/Manipulators.cs" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Unity-Technologies/UnityCsReference/blob/2019.1/Modules/UIElements/Manipulators.cs</a>]<br>
[参照：<a href="https://github.com/Unity-Technologies/UnityCsReference/blob/2019.1/Modules/UIElements/MouseManipulator.cs" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Unity-Technologies/UnityCsReference/blob/2019.1/Modules/UIElements/MouseManipulator.cs</a>]</p>

<h2>
<span id="3-ノードを追加する" class="fragment"></span><a href="#3-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3. ノードを追加する</h2>

<p>これまではテストのためにノードの数は2つで固定されていましたが、自在に追加できなければグラフエディタとはとても呼べません。<br>
想定している挙動は、</p>

<ol>
<li>右クリックでメニューが出てくる</li>
<li>「Add Node」を選択する</li>
<li>右クリックした場所にノードが生成される</li>
</ol>

<p>です。</p>

<p>......実は前章の最後あたりで、このままのペースで書いていると時間がいくらあっても足りないと思い、先に実装してから記事を書くことにしました。<br>
ですので、これからの説明は少しスムーズに（悪く言えば飛躍気味に）なるかもしれません。ご了承ください。</p>

<h3>
<span id="31-メニューを表示する" class="fragment"></span><a href="#31-%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3.1 メニューを表示する</h3>

<p>2.4節で見たようなManipulatorと同じように、この挙動も操作としてまとめることができそうです。<br>
というか、こんなみんなが欲しそうな機能が公式に用意されていないはずがありません。<br>
案の定、存在しました。例によって<a href="https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Controls.html" rel="nofollow noopener" target="_blank">公式ドキュメント</a>です。</p>

<p>コードを載せます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorクラス</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>

        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"One"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"Two"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">yellow</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>

        <span class="n">root</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">ContextualMenuManipulator</span><span class="p">(</span><span class="n">OnContextMenuPopulate</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">OnContextMenuPopulate</span><span class="p">(</span><span class="n">ContextualMenuPopulateEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 項目を追加</span>
        <span class="n">evt</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="nf">AppendAction</span><span class="p">(</span>
            <span class="s">"Add Node"</span><span class="p">,</span>  <span class="c1">// 項目名</span>
            <span class="n">AddEdgeMenuAction</span><span class="p">,</span>  <span class="c1">// 選択時の挙動</span>
            <span class="n">DropdownMenuAction</span><span class="p">.</span><span class="n">AlwaysEnabled</span>  <span class="c1">// 選択可能かどうか</span>
            <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">AddEdgeMenuAction</span><span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuAction</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Add Node"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>さあ、どうでしょうか。<br>
<a href="https://camo.qiitausercontent.com/f9a89fb11383a7f026ae5cc5cfc111f1092d696a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31373134653062622d393164352d663532642d626662352d3564353535383531383631632e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1714e0bb-91d5-f52d-bfb5-5d555851861c.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7b8251ebcb4472e8d13c3b73afe57fec" alt="NodeEditor-10.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/1714e0bb-91d5-f52d-bfb5-5d555851861c.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1714e0bb-91d5-f52d-bfb5-5d555851861c.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=01f7afd92e132bfcc63d4b5a0d76ebc4 1x" loading="lazy"></a><br>
上手く動いていません。</p>

<p>期待していた挙動は、「背景を左クリックしたときはメニューが開いて、ノードを左クリックしたときは何も起こらない」です。でも、これでは逆ですね。<br>
<a href="https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html" rel="nofollow noopener" target="_blank">イベント発行についてのドキュメント</a>を見てみます。<br>
<a href="https://camo.qiitausercontent.com/0c8f9b3b8f577007e299a2c5f7814a938a5de8a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f61643865353064612d643835342d663537372d326438352d6162613837386330326162612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fad8e50da-d854-f577-2d85-aba878c02aba.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=af01da249d0f32615f9f580e610464b6" alt="NodeEditor-11.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/ad8e50da-d854-f577-2d85-aba878c02aba.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fad8e50da-d854-f577-2d85-aba878c02aba.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=2d09bdf527bf288706639ff387122306 1x" loading="lazy"></a><br>
[図は引用：<a href="https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html</a>]</p>

<p>イベントは root -&gt; target -&gt; root と呼ばれるみたいですね。<a href="https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Handling.html" rel="nofollow noopener" target="_blank">イベント受け取りについてのドキュメント</a>には、デフォルトではTargetフェイズとBubbleUpフェイズにイベントが登録されるともあります。</p>

<p>とにかく、思い当たるのは、ルートに登録したコールバックがノード経由で伝わっているということです。<br>
いろいろ試してみてわかったのは、ルートではデフォルトで<code>pickingMode</code>が<code>PickingMode.Ignore</code>に設定されているということでした。</p>

<p><a href="https://docs.unity3d.com/2019.1/Documentation/ScriptReference/UIElements.IPanel.Pick.html" rel="nofollow noopener" target="_blank">リファレンス</a>によると、マウスのクリック時にターゲットを決める際、その位置にある一番上のVisualElementを取ってきているらしいのですが、この<code>pickingMode</code>が<code>PickingMode.Ignore</code>に設定されていた場合は候補から外す、という挙動になるようです。</p>

<p>実際、このようにすると動きます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorクラス</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>

        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"One"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"Two"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">yellow</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>

        <span class="n">root</span><span class="p">.</span><span class="n">pickingMode</span> <span class="p">=</span> <span class="n">PickingMode</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>  <span class="c1">// ピッキングモード変更</span>

        <span class="n">root</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">ContextualMenuManipulator</span><span class="p">(</span><span class="n">OnContextMenuPopulate</span><span class="p">));</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><a href="https://camo.qiitausercontent.com/f1b3f34d28bbeef484d5963350a72b0dd95df86a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f36356130343631342d653361632d376266362d383866612d3439346135613463343666302e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F65a04614-e3ac-7bf6-88fa-494a5a4c46f0.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ff855a06bcf1e622b44a90181d48c508" alt="NodeEditor-12.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/65a04614-e3ac-7bf6-88fa-494a5a4c46f0.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F65a04614-e3ac-7bf6-88fa-494a5a4c46f0.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ce9bd957f995fc91a374f4938ccefe11 1x" loading="lazy"></a><br>
でも、ルートをむやみに変更するのはよくないですね。<br>
そこで、ルートの一つ下に一枚挟むことにします。今の作りでは、EditorWindowとVisualElementが不可分になってしまっていましたが、それを分離可能にするという意味合いもあります。</p>

<p>さあ、いよいよもってGraphViewに近づいてきました。<br>
分離自体はすぐにできます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditor.cs</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">GraphEditor</span> <span class="p">:</span> <span class="n">EditorWindow</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">MenuItem</span><span class="p">(</span><span class="s">"Window/GraphEditor"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ShowWindow</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">GraphEditor</span> <span class="n">graphEditor</span> <span class="p">=</span> <span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">GraphEditor</span><span class="p">&gt;();</span>
        <span class="n">graphEditor</span><span class="p">.</span><span class="nf">Show</span><span class="p">();</span>
        <span class="n">graphEditor</span><span class="p">.</span><span class="n">titleContent</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GUIContent</span><span class="p">(</span><span class="s">"Graph Editor"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">GraphEditorElement</span> <span class="n">m_GraphEditorElement</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>

        <span class="n">m_GraphEditorElement</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GraphEditorElement</span><span class="p">();</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">m_GraphEditorElement</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElement.cs</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">GraphEditorElement</span><span class="p">:</span> <span class="n">VisualElement</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">GraphEditorElement</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">style</span><span class="p">.</span><span class="n">flexGrow</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>  <span class="c1">// サイズを画面いっぱいに広げる</span>
        <span class="n">style</span><span class="p">.</span><span class="n">overflow</span> <span class="p">=</span> <span class="n">Overflow</span><span class="p">.</span><span class="n">Hidden</span><span class="p">;</span>  <span class="c1">// ウィンドウの枠からはみ出ないようにする</span>

        <span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"One"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>
        <span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"Two"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">yellow</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">50</span><span class="p">)));</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">ContextualMenuManipulator</span><span class="p">(</span><span class="n">OnContextMenuPopulate</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">OnContextMenuPopulate</span><span class="p">(</span><span class="n">ContextualMenuPopulateEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">evt</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="nf">AppendAction</span><span class="p">(</span>
            <span class="s">"Add Node"</span><span class="p">,</span>
            <span class="n">AddNodeMenuAction</span><span class="p">,</span>
            <span class="n">DropdownMenuAction</span><span class="p">.</span><span class="n">AlwaysEnabled</span>
            <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">AddNodeMenuAction</span><span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuAction</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Add Node"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>二つのスタイルを適用しました。<br>
<code>style.flexGrow = 1;</code> によってGraphEditorElementのサイズが画面いっぱいに広がり、クリックイベントを拾う背景の役割を果たしてくれます。<br>
<code>style.overflow = Overflow.Hidden;</code> は親の領域からはみ出た部分を表示しないようにします。ノードを動かすとウィンドウの枠からはみ出したりしていましたが、これでもう心配はいりません。</p>

<p>挙動はこのようになります。<br>
<a href="https://camo.qiitausercontent.com/70065fe40c35c1b496dd9e08aae0fa261dc849c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32663735396232642d333636312d613666332d386364352d3565633431343663646630312e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2f759b2d-3661-a6f3-8cd5-5ec4146cdf01.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=95d364e0534b38047d13fbc8a7483b67" alt="NodeEditor-13.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/2f759b2d-3661-a6f3-8cd5-5ec4146cdf01.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2f759b2d-3661-a6f3-8cd5-5ec4146cdf01.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=06d38157a31f8193d4e2ed9aa88b5f17 1x" loading="lazy"></a><br>
まだノードの上で右クリックしたときもAdd Nodeメニューが出てしまいます。<br>
これはノードに対しても何かを設定する必要がありそうですね。</p>

<p>後でノードを左クリックしたときにエッジを追加する挙動を実装します。そのとき考えましょう。</p>

<p>とにかくメニューは出たということで、次へ進んでいきます。</p>

<h3>
<span id="32-ノードを生成する" class="fragment"></span><a href="#32-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>3.2 ノードを生成する</h3>

<p>Add Nodeというログを出していた部分を少し変更すると、新しいノードが生成できます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>
    <span class="k">void</span> <span class="nf">AddNodeMenuAction</span><span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuAction</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Vector2</span> <span class="n">mousePosition</span> <span class="p">=</span> <span class="n">menuAction</span><span class="p">.</span><span class="n">eventInfo</span><span class="p">.</span><span class="n">localMousePosition</span><span class="p">;</span>  <span class="c1">// マウス位置はeventInfoの中にあります</span>

        <span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="s">"add"</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">green</span><span class="p">,</span> <span class="n">mousePosition</span><span class="p">));</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>挙動です。<br>
<a href="https://camo.qiitausercontent.com/7b24bbfae8eb60cdce0624abafc50cc882f59aca/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f34303661366532352d613866322d653038622d323063382d3635316265303562393235302e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F406a6e25-a8f2-e08b-20c8-651be05b9250.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4d7f363440fc1bcb1e548b624e9aee94" alt="NodeEditor-14.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/406a6e25-a8f2-e08b-20c8-651be05b9250.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F406a6e25-a8f2-e08b-20c8-651be05b9250.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5047003372f31cf32d9763616054f23e 1x" loading="lazy"></a><br>
これで、表示の上では新しいノードを生成できました。</p>

<h2>
<span id="4-ノードを永続化する" class="fragment"></span><a href="#4-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E6%B0%B8%E7%B6%9A%E5%8C%96%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>4. ノードを永続化する</h2>

<p>3章で生成したノードはGraphEditorウィンドウを開きなおしたりすると消えてしまいます。<br>
Unityで何らかのデータを保存しておくには、どこかのファイルにシリアライズしておく必要があります。</p>

<p>「シリアライズとはXXXである」と一言で言えたらいいのですが、短く上手く説明できる気がしません。<br>
脱線になってしまってもよくないので、気になる方は「Unity シリアライズ」などで検索してみてください。</p>

<h3>
<span id="41-グラフ構造とは" class="fragment"></span><a href="#41-%E3%82%B0%E3%83%A9%E3%83%95%E6%A7%8B%E9%80%A0%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>4.1 グラフ構造とは</h3>

<p>方針としては、グラフを再現するのに最低限必要なものを用意します。<br>
冒頭でも少し触れましたが、ここでグラフの定義を明確にしておきます。</p>

<p>グラフには大きく分けて二種類あります。<br>
無向グラフと有向グラフです。<br>
<a href="https://camo.qiitausercontent.com/63e7440a47362e1b53ef3e510addef989bb78b18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31376365326461372d336662662d666634312d616437622d6337663836396631303835652e6a706567" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F17ce2da7-3fbf-ff41-ad7b-c7f869f1085e.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5f0cff3900c9c657ada05eb594c73809" alt="graph_sample.jpg" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/17ce2da7-3fbf-ff41-ad7b-c7f869f1085e.jpeg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F17ce2da7-3fbf-ff41-ad7b-c7f869f1085e.jpeg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e49b76b03b7c97706ddd4718832614d2 1x" loading="lazy"></a><br>
[図は引用：<a href="https://qiita.com/drken/items/4a7869c5e304883f539b" class="autolink" id="reference-5a2f32b212affb3ba576">https://qiita.com/drken/items/4a7869c5e304883f539b</a>]</p>

<p>エッジ、つまり辺に向きがあるかないかの差があります。<br>
ゲームで使う場合、ロジックを表現するためのグラフはほとんどが有向グラフなのではと思います。</p>

<p>ビヘイビアツリー：　ノードはアクション、エッジは遷移<br>
有限オートマトン：　ノードは状態、エッジは遷移</p>

<p>ということで、作成中のグラフエディタも、有向グラフを表せるものを作りたいと思います。<br>
余談ですが、無向グラフは有効グラフの矢印と逆向きに同じ矢印を付けると実現することができます。</p>

<h3>
<span id="42-シリアライズ用のクラスを作る" class="fragment"></span><a href="#42-%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E7%94%A8%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>4.2 シリアライズ用のクラスを作る</h3>

<p>構造としては、<br>
グラフアセット：ノードリストを持つ<br>
ノード：エッジリストを持つ<br>
エッジ：つながるノードを持つ</p>

<p>として、グラフアセットをアセットとして新規作成できるようにしようと思います。<br>
実装は以下のようにします。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphAsset.cs</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="p">[</span><span class="nf">CreateAssetMenu</span><span class="p">(</span><span class="n">fileName</span> <span class="p">=</span><span class="s">"graph.asset"</span><span class="p">,</span> <span class="n">menuName</span> <span class="p">=</span><span class="s">"Graph Asset"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">GraphAsset</span> <span class="p">:</span> <span class="n">ScriptableObject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SerializableNode</span><span class="p">&gt;</span> <span class="n">nodes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SerializableNode</span><span class="p">&gt;();</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">SerializableNode</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Vector2</span> <span class="n">position</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SerializableEdge</span><span class="p">&gt;</span> <span class="n">edges</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SerializableEdge</span><span class="p">&gt;();</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">SerializableEdge</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">SerializableNode</span> <span class="n">toNode</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code>ScriptableObject</code>に<code>[CreateAssetMenu]</code>を付けることで、Unityのプロジェクトなどで右クリックをしたときにメニューから生成できるようになります。<br>
また、<code>[System.Serializable]</code>アトリビュートによって、指定したクラスをシリアライズ可能にしています。</p>

<p>早速、グラフアセットを作ってみました。<br>
<a href="https://camo.qiitausercontent.com/f64243707eccf5eeafc0c2398dd11ccc09e8d9a2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f39356636643863662d346137662d326438312d656233322d3839616262653935363961612e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F95f6d8cf-4a7f-2d81-eb32-89abbe9569aa.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=849328cce2b35dbfa3948cdb4d6ddc0c" alt="NodeEditor-15.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/95f6d8cf-4a7f-2d81-eb32-89abbe9569aa.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F95f6d8cf-4a7f-2d81-eb32-89abbe9569aa.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=acfc6fa0ce032c74c99f8c370f3147b0 1x" loading="lazy"></a><br>
すると、このようなエラーが出ます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>Serialization depth limit 7 exceeded at 'SerializableEdge.toNode'. There may be an object composition cycle in one or more of your serialized classes.

Serialization hierarchy:
8: SerializableEdge.toNode
7: SerializableNode.edges
6: SerializableEdge.toNode
5: SerializableNode.edges
4: SerializableEdge.toNode
3: SerializableNode.edges
2: SerializableEdge.toNode
1: SerializableNode.edges
0: GraphAsset.nodes

UnityEditor.InspectorWindow:RedrawFromNative()
</code></pre></div></div>

<p>これはつまり、こういうことです。<br>
<a href="https://camo.qiitausercontent.com/2025dfc08b616bfb0d8c69c72adf08594cc88f54/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f64313862616535312d366239382d333036612d343962382d6434383132656132353565352e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fd18bae51-6b98-306a-49b8-d4812ea255e5.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2dce5f0608611aa9053640893632ddf1" alt="NodeEditor-16.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/d18bae51-6b98-306a-49b8-d4812ea255e5.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fd18bae51-6b98-306a-49b8-d4812ea255e5.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5cc6f6b3954d3180a319050bb83b3ef9 1x" loading="lazy"></a></p>

<p>そう、ノードがシリアライズしようとするエッジが、さらにノードをシリアライズしようとして、循環が発生しているのです。<br>
シリアライズの仕組みとして、クラスの参照をそのまま保存することはできません。</p>

<p>では、どうするかというと、ノードのIDを保存しておくことにします。<br>
UnityのGUIDみたいに大きなIDを振ってもいいのですが、振るのとか対応付けとかが面倒そうです。<br>
そこで、ここではGraphAssetが持っているノードリストの何番目にあるか、というのをIDとしようと思います。</p>

<p>SerializableEdgeだけ以下のように直します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphAsset.cs</span>
<span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">SerializableEdge</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">toId</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これでワーニングは出なくなります。</p>

<h3>
<span id="43-アセットとエディタを対応付ける" class="fragment"></span><a href="#43-%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%A8%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF%E3%82%92%E5%AF%BE%E5%BF%9C%E4%BB%98%E3%81%91%E3%82%8B"><i class="fa fa-link"></i></a>4.3 アセットとエディタを対応付ける</h3>

<p>どのアセットを表示・編集するかを決めるために、エディタにアセットの情報を持たせなければいけません。<br>
実際にエディタを使うときのことを考えると、アセットからエディタが開けて、その際にそのアセットについて編集するようにできたらいいですね。</p>

<p>というわけで要件としては、<br>
1. GraphAssetをダブルクリックするとエディタが開く<br>
2. どこかのGraphEditorElementクラスにGraphAssetクラスを渡す<br>
です。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphAsset.cs</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor.Callbacks</span><span class="p">;</span>  <span class="c1">// OnOpenAssetアトリビュートのために追加</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">GraphEditor</span> <span class="p">:</span> <span class="n">EditorWindow</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">MenuItem</span><span class="p">(</span><span class="s">"Window/GraphEditor"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ShowWindow</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">GraphEditor</span> <span class="n">graphEditor</span> <span class="p">=</span> <span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">GraphEditor</span><span class="p">&gt;();</span>
        <span class="n">graphEditor</span><span class="p">.</span><span class="nf">Show</span><span class="p">();</span>
        <span class="n">graphEditor</span><span class="p">.</span><span class="n">titleContent</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GUIContent</span><span class="p">(</span><span class="s">"Graph Editor"</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">Selection</span><span class="p">.</span><span class="n">activeObject</span> <span class="k">is</span> <span class="n">GraphAsset</span> <span class="n">graphAsset</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">graphEditor</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="n">graphAsset</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="nf">OnOpenAsset</span><span class="p">()]</span>  <span class="c1">// Unityで何らかのアセットを開いたときに呼ばれるコールバック</span>
    <span class="k">static</span> <span class="kt">bool</span> <span class="nf">OnOpenAsset</span><span class="p">(</span><span class="kt">int</span> <span class="n">instanceId</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">EditorUtility</span><span class="p">.</span><span class="nf">InstanceIDToObject</span><span class="p">(</span><span class="n">instanceId</span><span class="p">)</span> <span class="k">is</span> <span class="n">GraphAsset</span><span class="p">)</span>  <span class="c1">// 開いたアセットがGraphAssetかどうか</span>
        <span class="p">{</span>
            <span class="nf">ShowWindow</span><span class="p">();</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">GraphAsset</span> <span class="n">m_GraphAsset</span><span class="p">;</span>  <span class="c1">// メンバ変数として持っておく</span>
    <span class="n">GraphEditorElement</span> <span class="n">m_GraphEditorElement</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnEnable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ShowWindow()を通らないような時（スクリプトのコンパイル後など）</span>
        <span class="c1">// のために初期化への導線を付ける</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_GraphAsset</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 初期化はInitializeに任せる</span>
            <span class="nf">Initialize</span><span class="p">(</span><span class="n">m_GraphAsset</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 初期化</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="n">GraphAsset</span> <span class="n">graphAsset</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_GraphAsset</span> <span class="p">=</span> <span class="n">graphAsset</span><span class="p">;</span>

        <span class="c1">// 以下はもともとOnEnable() で行っていた処理</span>
        <span class="c1">// OnEnable() はCreateInstance&lt;GraphEditor&gt;() の際に呼ばれるので、まだgraphAssetが渡されていない</span>
        <span class="c1">// 初期化でもgraphAssetを使うことになるのでここに移す</span>
        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>

        <span class="n">m_GraphEditorElement</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GraphEditorElement</span><span class="p">();</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">m_GraphEditorElement</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>これで、GraphAssetファイルをダブルクリックしたときにエディタが開くようになります。<br>
<a href="https://camo.qiitausercontent.com/d252754946e7ac50328f326cb3263b09ceb1212f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f62303539653361392d353662642d326433632d646339312d3532333232623331343537662e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fb059e3a9-56bd-2d3c-dc91-52322b31457f.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9cf0ca7803d5b3e2ddd1f03be038c9b4" alt="NodeEditor-17.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/b059e3a9-56bd-2d3c-dc91-52322b31457f.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fb059e3a9-56bd-2d3c-dc91-52322b31457f.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6f5bf324dc7d1d4b0478e17dcb5e829e 1x" loading="lazy"></a></p>

<h3>
<span id="44-アセットのデータからノードを表示するようにする" class="fragment"></span><a href="#44-%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8B%E3%82%89%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>4.4 アセットのデータからノードを表示するようにする</h3>

<p>続いて、アセットにある情報からノードを構築、表示したいと思います。<br>
まずはGraphAssetにダミーの情報を手打ちします。<br>
<a href="https://camo.qiitausercontent.com/e12c910f56524c1a638b98fc5545165da1d180fb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f34366434303036352d306666342d396631372d383666362d6233326334333364666263302e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F46d40065-0ff4-9f17-86f6-b32c433dfbc0.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b2e9dcb6162ca85bc0c4a59f3b947cd3" alt="NodeEditor-18.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/46d40065-0ff4-9f17-86f6-b32c433dfbc0.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F46d40065-0ff4-9f17-86f6-b32c433dfbc0.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=7abc97be292d5498c4caee41cb399aa7 1x" loading="lazy"></a><br>
(100, 50)と(200, 50)の位置、つまり今まで表示してきた赤と黄色の位置、にノードが表示されればOKです。</p>

<p>まず、NodeElementを少し変えます。<br>
色の情報はアセットにはないので省きますし、位置はシリアライズされますからね。</p>

<p>具体的には、生成をSerializableNodeから行うようにします。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElement.cs</span>

<span class="c1">// BackgroundColorがなくなると見えなくなるので、周囲を枠線で囲んだVisualElement、Boxを継承する</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">NodeElement</span> <span class="p">:</span> <span class="n">Box</span>  
<span class="p">{</span>
    <span class="k">public</span> <span class="n">SerializableNode</span> <span class="n">serializableNode</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">NodeElement</span> <span class="p">(</span><span class="n">SerializableNode</span> <span class="n">node</span><span class="p">)</span>  <span class="c1">// 引数を変更</span>
    <span class="p">{</span>
        <span class="n">serializableNode</span> <span class="p">=</span> <span class="n">node</span><span class="p">;</span>  <span class="c1">// シリアライズ対象を保存しておく</span>

        <span class="n">style</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Position</span><span class="p">.</span><span class="n">Absolute</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">height</span> <span class="p">=</span> <span class="m">50</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">width</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>

        <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">node</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>  <span class="c1">// シリアライズされている位置を取る</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeDragger</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>GraphEditorElementも伴って変更します。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElement.cs</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">GraphEditorElement</span><span class="p">:</span> <span class="n">VisualElement</span>
<span class="p">{</span>
    <span class="n">GraphAsset</span> <span class="n">m_GraphAsset</span><span class="p">;</span>  <span class="c1">// 渡されたアセットを保存</span>
    <span class="n">List</span><span class="p">&lt;</span><span class="n">NodeElement</span><span class="p">&gt;</span> <span class="n">m_Nodes</span><span class="p">;</span>  <span class="c1">// 作ったノードを入れておく。順序が重要</span>

    <span class="k">public</span> <span class="nf">GraphEditorElement</span><span class="p">(</span><span class="n">GraphAsset</span> <span class="n">graphAsset</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_GraphAsset</span> <span class="p">=</span> <span class="n">graphAsset</span><span class="p">;</span>

        <span class="n">style</span><span class="p">.</span><span class="n">flexGrow</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">overflow</span> <span class="p">=</span> <span class="n">Overflow</span><span class="p">.</span><span class="n">Hidden</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">ContextualMenuManipulator</span><span class="p">(</span><span class="n">OnContextMenuPopulate</span><span class="p">));</span>

        <span class="n">m_Nodes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">NodeElement</span><span class="p">&gt;();</span>

        <span class="c1">// 順番にノードを生成。この作る際の順番がSerializableEdgeが持つNodeのIDとなる</span>
        <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">node</span> <span class="k">in</span> <span class="n">graphAsset</span><span class="p">.</span><span class="n">nodes</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CreateNodeElement</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">void</span> <span class="nf">CreateNodeElement</span><span class="p">(</span><span class="n">SerializableNode</span> <span class="n">node</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">nodeElement</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NodeElement</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

        <span class="nf">Add</span><span class="p">(</span><span class="n">nodeElement</span><span class="p">);</span>  <span class="c1">// GraphEditorElementの子として追加</span>
        <span class="n">m_Nodes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">nodeElement</span><span class="p">);</span>  <span class="c1">// 順番を保持するためのリストに追加</span>
    <span class="p">}</span>

<span class="cm">/* ... 省略 */</span>

    <span class="k">void</span> <span class="nf">AddNodeMenuAction</span><span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuAction</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Vector2</span> <span class="n">mousePosition</span> <span class="p">=</span> <span class="n">menuAction</span><span class="p">.</span><span class="n">eventInfo</span><span class="p">.</span><span class="n">localMousePosition</span><span class="p">;</span>

        <span class="nf">CreateNodeElement</span><span class="p">(</span><span class="k">new</span> <span class="nf">SerializableNode</span><span class="p">()</span> <span class="p">{</span> <span class="n">position</span> <span class="p">=</span> <span class="n">mousePosition</span> <span class="p">});</span>  <span class="c1">// 追加生成時には仮で新しく作る</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>GraphEditorElementのコンストラクタにGraphAssetを渡すようにしたので、GraphEditorから生成するときに必要です</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorクラス</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="n">GraphAsset</span> <span class="n">graphAsset</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_GraphAsset</span> <span class="p">=</span> <span class="n">graphAsset</span><span class="p">;</span>

        <span class="n">VisualElement</span> <span class="n">root</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">rootVisualElement</span><span class="p">;</span>

        <span class="n">m_GraphEditorElement</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GraphEditorElement</span><span class="p">(</span><span class="n">graphAsset</span><span class="p">);</span>  <span class="c1">// アセットを渡す</span>
        <span class="n">root</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">m_GraphEditorElement</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>以上で、アセットに保持された情報を描画することができました。<br>
<a href="https://camo.qiitausercontent.com/f684ff8b8bf9222889eeed36df76371a3bfd15fc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32393938646637362d316438652d366564652d643437622d3664646162326632666631392e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2998df76-1d8e-6ede-d47b-6ddab2f2ff19.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ebcbb23e478b62e7fbb792ecd78645d5" alt="NodeEditor-19.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/2998df76-1d8e-6ede-d47b-6ddab2f2ff19.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2998df76-1d8e-6ede-d47b-6ddab2f2ff19.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=2b65419c8fb84fa4c6340e4559fb5d51 1x" loading="lazy"></a><br>
書き込みはしていないので、当然開きなおすと追加したノードは消えてしまいます。</p>

<h3>
<span id="45-追加作成したノードをアセットに書き込む" class="fragment"></span><a href="#45-%E8%BF%BD%E5%8A%A0%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>4.5 追加作成したノードをアセットに書き込む</h3>

<p>前節までできたら、あとはもう少し変えるだけです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">AddNodeMenuAction</span><span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuAction</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Vector2</span> <span class="n">mousePosition</span> <span class="p">=</span> <span class="n">menuAction</span><span class="p">.</span><span class="n">eventInfo</span><span class="p">.</span><span class="n">localMousePosition</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">node</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SerializableNode</span><span class="p">()</span> <span class="p">{</span> <span class="n">position</span> <span class="p">=</span> <span class="n">mousePosition</span> <span class="p">};</span>

        <span class="n">m_GraphAsset</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>  <span class="c1">// アセットに追加する</span>

        <span class="nf">CreateNodeElement</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>これでアセットに書き込まれます。<br>
<a href="https://camo.qiitausercontent.com/a722b025d84e05aeb5b08cad30a137f6e5279412/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f36656539336462642d393265642d336533352d313063302d3031356664613337343763642e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F6ee93dbd-92ed-3e35-10c0-015fda3747cd.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=45141f17adbec2d0b77f518cf6c215c9" alt="NodeEditor-20.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/6ee93dbd-92ed-3e35-10c0-015fda3747cd.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F6ee93dbd-92ed-3e35-10c0-015fda3747cd.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=be6fd4e99a416bf690f161b31b2c30c5 1x" loading="lazy"></a><br>
おっと、動かしたことを記録するのを忘れていました。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeDraggerクラス</span>
    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseUp</span><span class="p">(</span><span class="n">MouseUpEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">CanStopManipulation</span><span class="p">(</span><span class="n">evt</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">target</span><span class="p">.</span><span class="nf">ReleaseMouse</span><span class="p">();</span>

            <span class="k">if</span><span class="p">(</span><span class="n">target</span> <span class="k">is</span> <span class="n">NodeElement</span> <span class="n">node</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//NodeElementに保存しておいたシリアライズ対象のポジションをいじる</span>
                <span class="n">node</span><span class="p">.</span><span class="n">serializableNode</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">target</span><span class="p">.</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">m_Focus</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>動かしてドラッグをやめた瞬間に記録するとよいと思います。<br>
これで動かしたことも保存されるようになりました。<br>
<a href="https://camo.qiitausercontent.com/470474d6475bdf0c581d52ab3b78c6a2ca314cd0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f66646339383831632d633061332d386361372d396635662d6536333262626166393061372e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ffdc9881c-c0a3-8ca7-9f5f-e632bbaf90a7.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=44d1ee51318aa97acc579dfcb0edff05" alt="NodeEditor-21.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/fdc9881c-c0a3-8ca7-9f5f-e632bbaf90a7.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ffdc9881c-c0a3-8ca7-9f5f-e632bbaf90a7.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=7854af3b79702d1bff7beb6feff92162 1x" loading="lazy"></a></p>

<h2>
<span id="5-エッジを追加する" class="fragment"></span><a href="#5-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>5. エッジを追加する</h2>

<p>頂点の表示ができたので、次は辺です。辺は頂点同士を線で結ぶことで表します。<br>
コンテナ的な仕組みでは直線や曲線は引けないように思うので、ここは既存の仕組みで線を引きます。<br>
<code>Handles.Draw</code>系の関数が一番楽かなと思います。<br>
<code>DrawLine</code>や<code>DrawBezier</code>などです。</p>

<p>ちなみにGraphViewでは、エッジ用のメッシュを作って、<code>Graphics.DrawMeshNow()</code>で描画をしていました。</p>

<h3>
<span id="51-エッジを表示する" class="fragment"></span><a href="#51-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>5.1 エッジを表示する</h3>

<p>とりあえずダミーでデータを作ってみます。<br>
<a href="https://camo.qiitausercontent.com/07d2c2982ed941c93df0f40ca8e3597c23533e1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f65386233316139352d643863392d626537662d353731662d6266356465346230343864302e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fe8b31a95-d8c9-be7f-571f-bf5de4b048d0.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3c139f9575c1b5052c304709e99aa588" alt="NodeEditor-22.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/e8b31a95-d8c9-be7f-571f-bf5de4b048d0.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fe8b31a95-d8c9-be7f-571f-bf5de4b048d0.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=194a708e2db3981085651e41d7329c0f 1x" loading="lazy"></a><br>
Element0のEgesに要素を追加しました。<br>
このまま表示するとこうなります。<br>
<a href="https://camo.qiitausercontent.com/7ed43511a5d4a06b8cc6d428db6717173dc8179f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f66323935346634312d646337652d333635662d613738382d3535656232323036633734612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ff2954f41-dc7e-365f-a788-55eb2206c74a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4f92c8f2cb4396f067f5dc7dd5a63d3c" alt="NodeEditor-23.PNG" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/f2954f41-dc7e-365f-a788-55eb2206c74a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ff2954f41-dc7e-365f-a788-55eb2206c74a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6e7afa1c655e37e08b1a8a998dd41587 1x" loading="lazy"></a><br>
イメージとしては、左上のノードから右下のノードへ繋がっている矢印があればいいなと思います。</p>

<p>VisualElementは初期化字に一度呼べば後は自動で描画してくれていましたが、<code>Handles</code>で描画をするならウィンドウ更新のたびに呼ぶ必要があります。<br>
EditorWindowの更新といえば、<code>OnGUI</code>です。<br>
ウィンドウの更新のたびに<code>OnGUI</code>が呼ばれますので、そこからGraphEditorElementの描画関数を呼ぶことにします。</p>

<p>ひとまずこのように実装してみます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorクラス</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnGUI</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">m_GraphEditorElement</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">m_GraphEditorElement</span><span class="p">.</span><span class="nf">DrawEdge</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DrawEdge</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">m_GraphAsset</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">node</span> <span class="p">=</span> <span class="n">m_GraphAsset</span><span class="p">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">edge</span> <span class="k">in</span> <span class="n">node</span><span class="p">.</span><span class="n">edges</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">DrawEdge</span><span class="p">(</span>
                    <span class="n">startPos</span><span class="p">:</span> <span class="n">m_Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span>
                    <span class="n">startNorm</span><span class="p">:</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">),</span>
                    <span class="n">endPos</span><span class="p">:</span> <span class="n">m_Nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">.</span><span class="n">toId</span><span class="p">].</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">,</span>
                    <span class="n">endNorm</span><span class="p">:</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="p">-</span><span class="m">1f</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">DrawEdge</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">startPos</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">startNorm</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">endPos</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">endNorm</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Handles</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">blue</span><span class="p">;</span>  <span class="c1">// 色指定</span>

        <span class="c1">// エッジをベジェ曲線で描画</span>
        <span class="n">Handles</span><span class="p">.</span><span class="nf">DrawBezier</span><span class="p">(</span>
            <span class="n">startPos</span><span class="p">,</span>
            <span class="n">endPos</span><span class="p">,</span>
            <span class="n">startPos</span> <span class="p">+</span> <span class="m">50f</span> <span class="p">*</span> <span class="n">startNorm</span><span class="p">,</span>
            <span class="n">endPos</span> <span class="p">+</span> <span class="m">50f</span> <span class="p">*</span> <span class="n">endNorm</span><span class="p">,</span>
            <span class="n">color</span><span class="p">:</span> <span class="n">Color</span><span class="p">.</span><span class="n">blue</span><span class="p">,</span>
            <span class="n">texture</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span>
            <span class="n">width</span><span class="p">:</span> <span class="m">2f</span><span class="p">);</span>

        <span class="c1">// 矢印の三角形の描画</span>
        <span class="n">Vector2</span> <span class="n">arrowAxis</span> <span class="p">=</span> <span class="m">10f</span> <span class="p">*</span> <span class="n">endNorm</span><span class="p">;</span>
        <span class="n">Vector2</span> <span class="n">arrowNorm</span> <span class="p">=</span> <span class="m">5f</span> <span class="p">*</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">Cross</span><span class="p">(</span><span class="n">endNorm</span><span class="p">,</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">forward</span><span class="p">);</span>

        <span class="n">Handles</span><span class="p">.</span><span class="nf">DrawAAConvexPolygon</span><span class="p">(</span><span class="n">endPos</span><span class="p">,</span>
            <span class="n">endPos</span> <span class="p">+</span> <span class="n">arrowAxis</span> <span class="p">+</span> <span class="n">arrowNorm</span><span class="p">,</span>
            <span class="n">endPos</span> <span class="p">+</span> <span class="n">arrowAxis</span> <span class="p">-</span> <span class="n">arrowNorm</span><span class="p">);</span>

        <span class="n">Handles</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">white</span><span class="p">;</span>  <span class="c1">// 色指定をデフォルトに戻す</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>このようになりました。<br>
<a href="https://camo.qiitausercontent.com/3e1d8000645e34e486426ca88ed1ca0e7303bf1e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f64383063343734392d326230302d343936622d333238372d6534323138323032383830372e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fd80c4749-2b00-496b-3287-e42182028807.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c54d9d477a766a1dbfa52e0ff9418c3b" alt="NodeEditor-24.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/d80c4749-2b00-496b-3287-e42182028807.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fd80c4749-2b00-496b-3287-e42182028807.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=34df7c603ca889ad58e5abaa655de773 1x" loading="lazy"></a></p>

<p>ポジションとして単に<code>VisualElement.transform.position</code>を利用しているので左上隅に始点・終点が来ています。<br>
元ノードは下辺中央から、先ノードの上辺中央につながってほしい気がします。<br>
とはいえ、GraphEditorElementでNodeの形に関する部分を決め打ちで呼んでしまうのはちょっと気持ち悪いので、NodeElementに始点や終点の位置・方向の情報を返す関数を作ろうと思います。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DrawEdge</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">m_GraphAsset</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">node</span> <span class="p">=</span> <span class="n">m_GraphAsset</span><span class="p">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">edge</span> <span class="k">in</span> <span class="n">node</span><span class="p">.</span><span class="n">edges</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// ノードに情報を問い合わせる</span>
                <span class="nf">DrawEdge</span><span class="p">(</span>
                    <span class="n">startPos</span><span class="p">:</span> <span class="n">m_Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">GetStartPosition</span><span class="p">(),</span>
                    <span class="n">startNorm</span><span class="p">:</span> <span class="n">m_Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">GetStartNorm</span><span class="p">(),</span>
                    <span class="n">endPos</span><span class="p">:</span> <span class="n">m_Nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">.</span><span class="n">toId</span><span class="p">].</span><span class="nf">GetEndPosition</span><span class="p">(),</span>
                    <span class="n">endNorm</span><span class="p">:</span> <span class="n">m_Nodes</span><span class="p">[</span><span class="n">edge</span><span class="p">.</span><span class="n">toId</span><span class="p">].</span><span class="nf">GetEndNorm</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElementクラス</span>

    <span class="k">public</span> <span class="n">Vector2</span> <span class="nf">GetStartPosition</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Vector2</span><span class="p">)</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">+</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="n">style</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="k">value</span><span class="p">.</span><span class="k">value</span> <span class="p">/</span> <span class="m">2f</span><span class="p">,</span> <span class="n">style</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="k">value</span><span class="p">.</span><span class="k">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="n">Vector2</span> <span class="nf">GetEndPosition</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Vector2</span><span class="p">)</span><span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">+</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="n">style</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="k">value</span><span class="p">.</span><span class="k">value</span> <span class="p">/</span> <span class="m">2f</span><span class="p">,</span> <span class="m">0f</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="n">Vector2</span> <span class="nf">GetStartNorm</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="n">Vector2</span> <span class="nf">GetEndNorm</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="p">-</span><span class="m">1f</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>ちゃんとそれらしい位置から生えました。<br>
<a href="https://camo.qiitausercontent.com/2056979925a60b04b1eb19c1bf020be796b38821/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f65313665646434302d366337382d653663652d343637342d3962313663386132396135342e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fe16edd40-6c78-e6ce-4674-9b16c8a29a54.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4c0a794f6a5a70a6b6b1a67daef65d7f" alt="NodeEditor-25.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/e16edd40-6c78-e6ce-4674-9b16c8a29a54.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fe16edd40-6c78-e6ce-4674-9b16c8a29a54.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=dc94fb84a6c14453e64f5835ed6a9575 1x" loading="lazy"></a></p>

<p>また、エッジを描画するだけなら、エッジのVisualElementを作らずにGraphAssetに保存されているSerializableEdgeの値を見ていればよいのですが、エッジの追加・削除・付け替えなど、いずれ必要になるであろう操作がやりにくくなります。</p>

<p>そこで、エッジにもEdgeElementクラスを作ります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// EdgeElement.cs</span>

<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">EdgeElement</span> <span class="p">:</span> <span class="n">VisualElement</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">SerializableEdge</span> <span class="n">serializableEdge</span><span class="p">;</span>  <span class="c1">// データを持っておく</span>

    <span class="k">public</span> <span class="n">NodeElement</span> <span class="n">From</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// 元ノード</span>
    <span class="k">public</span> <span class="n">NodeElement</span> <span class="n">To</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">// 先ノード</span>

    <span class="k">public</span> <span class="nf">EdgeElement</span><span class="p">(</span><span class="n">SerializableEdge</span> <span class="n">edge</span><span class="p">,</span> <span class="n">NodeElement</span> <span class="k">from</span><span class="p">,</span> <span class="n">NodeElement</span> <span class="n">to</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">serializableEdge</span> <span class="p">=</span> <span class="n">edge</span><span class="p">;</span>
        <span class="n">From</span> <span class="p">=</span> <span class="k">from</span><span class="p">;</span>
        <span class="n">To</span> <span class="p">=</span> <span class="n">to</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">DrawEdge</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">From</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">To</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">DrawEdge</span><span class="p">(</span>
                <span class="n">startPos</span><span class="p">:</span> <span class="n">From</span><span class="p">.</span><span class="nf">GetStartPosition</span><span class="p">(),</span>
                <span class="n">startNorm</span><span class="p">:</span> <span class="n">From</span><span class="p">.</span><span class="nf">GetStartNorm</span><span class="p">(),</span>
                <span class="n">endPos</span><span class="p">:</span> <span class="n">To</span><span class="p">.</span><span class="nf">GetEndPosition</span><span class="p">(),</span>
                <span class="n">endNorm</span><span class="p">:</span> <span class="n">To</span><span class="p">.</span><span class="nf">GetEndNorm</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// GraphEditorElementからそのまま移した</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">DrawEdge</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">startPos</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">startNorm</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">endPos</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">endNorm</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Handles</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">blue</span><span class="p">;</span>
        <span class="n">Handles</span><span class="p">.</span><span class="nf">DrawBezier</span><span class="p">(</span>
            <span class="n">startPos</span><span class="p">,</span>
            <span class="n">endPos</span><span class="p">,</span>
            <span class="n">startPos</span> <span class="p">+</span> <span class="m">50f</span> <span class="p">*</span> <span class="n">startNorm</span><span class="p">,</span>
            <span class="n">endPos</span> <span class="p">+</span> <span class="m">50f</span> <span class="p">*</span> <span class="n">endNorm</span><span class="p">,</span>
            <span class="n">color</span><span class="p">:</span> <span class="n">Color</span><span class="p">.</span><span class="n">blue</span><span class="p">,</span>
            <span class="n">texture</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span>
            <span class="n">width</span><span class="p">:</span> <span class="m">2f</span><span class="p">);</span>

        <span class="n">Vector2</span> <span class="n">arrowAxis</span> <span class="p">=</span> <span class="m">10f</span> <span class="p">*</span> <span class="n">endNorm</span><span class="p">;</span>
        <span class="n">Vector2</span> <span class="n">arrowNorm</span> <span class="p">=</span> <span class="m">5f</span> <span class="p">*</span> <span class="n">Vector3</span><span class="p">.</span><span class="nf">Cross</span><span class="p">(</span><span class="n">endNorm</span><span class="p">,</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">forward</span><span class="p">);</span>

        <span class="n">Handles</span><span class="p">.</span><span class="nf">DrawAAConvexPolygon</span><span class="p">(</span><span class="n">endPos</span><span class="p">,</span>
            <span class="n">endPos</span> <span class="p">+</span> <span class="n">arrowAxis</span> <span class="p">+</span> <span class="n">arrowNorm</span><span class="p">,</span>
            <span class="n">endPos</span> <span class="p">+</span> <span class="n">arrowAxis</span> <span class="p">-</span> <span class="n">arrowNorm</span><span class="p">);</span>
        <span class="n">Handles</span><span class="p">.</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">white</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>このクラスもノードと同様に、GraphEditorElementが生成し、GraphEditorElementの子として保持することにします。<br>
ノードが持っていて、ノードの子として生成というのも考えましたが、GraphEditorで一元管理した方が構造が単純になりそうだと思ったのが理由です。</p>

<p>実装はこうです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>

    <span class="n">List</span><span class="p">&lt;</span><span class="n">EdgeElement</span><span class="p">&gt;</span> <span class="n">m_Edges</span><span class="p">;</span>  <span class="c1">// エッジもノードと同じくまとめて保持しておく</span>

    <span class="k">public</span> <span class="nf">GraphEditorElement</span><span class="p">(</span><span class="n">GraphAsset</span> <span class="n">graphAsset</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_GraphAsset</span> <span class="p">=</span> <span class="n">graphAsset</span><span class="p">;</span>

        <span class="n">style</span><span class="p">.</span><span class="n">flexGrow</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">overflow</span> <span class="p">=</span> <span class="n">Overflow</span><span class="p">.</span><span class="n">Hidden</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">ContextualMenuManipulator</span><span class="p">(</span><span class="n">OnContextMenuPopulate</span><span class="p">));</span>

        <span class="n">m_Nodes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">NodeElement</span><span class="p">&gt;();</span>

        <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">node</span> <span class="k">in</span> <span class="n">graphAsset</span><span class="p">.</span><span class="n">nodes</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">CreateNodeElement</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// すべてのノードの生成が終わってからエッジの生成を行う</span>
        <span class="c1">// エッジが持っているノードIDからノードを取得するため</span>
        <span class="n">m_Edges</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">EdgeElement</span><span class="p">&gt;();</span>

        <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">node</span> <span class="k">in</span> <span class="n">m_Nodes</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">edge</span> <span class="k">in</span> <span class="n">node</span><span class="p">.</span><span class="n">serializableNode</span><span class="p">.</span><span class="n">edges</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">CreateEdgeElement</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">m_Nodes</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// エッジの生成</span>
    <span class="k">public</span> <span class="n">EdgeElement</span> <span class="nf">CreateEdgeElement</span><span class="p">(</span><span class="n">SerializableEdge</span> <span class="n">edge</span><span class="p">,</span> <span class="n">NodeElement</span> <span class="n">fromNode</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">NodeElement</span><span class="p">&gt;</span> <span class="n">nodeElements</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">edgeElement</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EdgeElement</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">fromNode</span><span class="p">,</span> <span class="n">nodeElements</span><span class="p">[</span><span class="n">edge</span><span class="p">.</span><span class="n">toId</span><span class="p">]);</span>
        <span class="nf">Add</span><span class="p">(</span><span class="n">edgeElement</span><span class="p">);</span>
        <span class="n">m_Edges</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">edgeElement</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">edgeElement</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// GraphEditor.OnGUI() 内で呼ばれる。描画処理をエッジに移したので小さくなった</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DrawEdge</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">edge</span> <span class="k">in</span> <span class="n">m_Edges</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">edge</span><span class="p">.</span><span class="nf">DrawEdge</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>見た目は先ほどと変わりません。</p>

<h3>
<span id="52-エッジを追加できるようにする" class="fragment"></span><a href="#52-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>5.2 エッジを追加できるようにする</h3>

<p>あるノードからあるノードにエッジをつけようと思う時、元ノードから先ノードへ線を伸ばしていくようなイメージになると思います。</p>

<p>UnityのGraphViewやUnrealEngineのBluePrintではノードに備わった接続用のポートをクリックしてそのままドラッグすると線が引かれていきます。<br>
<a href="https://camo.qiitausercontent.com/46c52772223d1bb8507205831e4aacb9476b2db0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f37636130613964632d626435652d653638352d613336332d3664303238363131353235362e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F7ca0a9dc-bd5e-e685-a363-6d0286115256.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6376c522b9b82e2261ae49a398bc68f4" alt="NodeEditor-26.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/7ca0a9dc-bd5e-e685-a363-6d0286115256.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F7ca0a9dc-bd5e-e685-a363-6d0286115256.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5eea30fea72bab3ce30034b16ba79839 1x" loading="lazy"></a></p>

<p>UnrealEngineのBehaviourTreeでは、ノードの上下にエッジ接続領域があります。<br>
<a href="https://camo.qiitausercontent.com/dce88df7e59c58f3a426d0641b72145aee259a85/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f34613439336463382d633834392d343431612d623837342d3534333761633062663230342e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F4a493dc8-c849-441a-b874-5437ac0bf204.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1fb0ff67c921d5424d5397ad58a40b53" alt="NodeEditor-27.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/4a493dc8-c849-441a-b874-5437ac0bf204.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F4a493dc8-c849-441a-b874-5437ac0bf204.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=72b2af412e98b9db887d10091e18a02d 1x" loading="lazy"></a></p>

<p>これらのようなポートや接続領域などはあると便利そうですが、いったんメニューにAdd Edgeを追加するので良いでしょう。<br>
重要なのは、追加中に元ノードからエッジがマウスの位置を追従していることです。<br>
このUIによって、現在エッジ追加操作中であることと、つなげるノードを指定する方法が直感的にわかります。<br>
これは実装したいです。</p>

<p>挙動としては、<br>
1. ノードを右クリックする<br>
2. メニューから「Add Edge」を選択する<br>
3. 元ノードからマウスの位置に向かうエッジ候補ができる<br>
4. 他のノードを左クリックして、エッジの向かい先を確定する</p>

<p>を想定します。<br>
ノードに対する操作なので、ノードに<code>Manipulator</code>を追加します。<br>
エッジをつなぐ操作なので、EdgeConnectorクラスとします。</p>

<h4>
<span id="521-edgeconnectorクラスを作る" class="fragment"></span><a href="#521-edgeconnector%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>5.2.1 EdgeConnectorクラスを作る</h4>

<p>EdgeConnectorの役割はメニューを出してエッジ追加モードに入ることと、そのあとに別のノードをクリックして実際にノードを接続することの二つあります。<br>
その中でメニューを出す部分は<code>ContexturalMenuManipulator</code>の役割ですので、EdgeConnectorクラスの中で<code>ContexturalMenuManipulator</code>を作成し、それをEdgeConnectorのターゲットノードに<code>AddManipulator</code>しようと思います。</p>

<p>こうすることで、NodeElementにEdgeConnectorを追加するだけで、エッジ追加の処理をすべてEdgeConnectorクラスに投げることができます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElementクラス</span>
    <span class="k">public</span> <span class="nf">NodeElement</span> <span class="p">(</span><span class="n">SerializableNode</span> <span class="n">node</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* ... 省略 */</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeDragger</span><span class="p">());</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">EdgeConnector</span><span class="p">());</span>  <span class="c1">// 追加</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>そして、EdgeConnectorの内部はひとまずこのようにしておきます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine.UIElements</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">EdgeConnector</span> <span class="p">:</span> <span class="n">MouseManipulator</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">m_Active</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="n">ContextualMenuManipulator</span> <span class="n">m_AddEdgeMenu</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">EdgeConnector</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ノードの接続は左クリックで行う</span>
        <span class="n">activators</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">ManipulatorActivationFilter</span><span class="p">()</span> <span class="p">{</span> <span class="n">button</span> <span class="p">=</span> <span class="n">MouseButton</span><span class="p">.</span><span class="n">LeftMouse</span> <span class="p">});</span>

        <span class="n">m_Active</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

        <span class="c1">// メニュー選択マニピュレータは作っておくが、この時点ではターゲットが確定していないので、</span>
        <span class="c1">// RegisterCallbacksOnTarget()で追加する</span>
        <span class="n">m_AddEdgeMenu</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ContextualMenuManipulator</span><span class="p">(</span><span class="n">OnContextualMenuPopulate</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnContextualMenuPopulate</span><span class="p">(</span><span class="n">ContextualMenuPopulateEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">target</span> <span class="k">is</span> <span class="n">NodeElement</span> <span class="n">node</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// エッジ追加中に右クリックを押されたときのために、ノードの上かどうかを見る</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">node</span><span class="p">.</span><span class="nf">ContainsPoint</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">WorldToLocal</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">mousePosition</span><span class="p">)))</span>
            <span class="p">{</span>
                <span class="c1">// イベントを即座に中断</span>
                <span class="n">evt</span><span class="p">.</span><span class="nf">StopImmediatePropagation</span><span class="p">();</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">evt</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="nf">AppendAction</span><span class="p">(</span>
                <span class="s">"Add Edge"</span><span class="p">,</span>
                <span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuItem</span><span class="p">)</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="n">m_Active</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

                    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Add Edge"</span><span class="p">);</span>  <span class="c1">// ここでエッジ追加モード開始処理を書く</span>

                    <span class="n">target</span><span class="p">.</span><span class="nf">CaptureMouse</span><span class="p">();</span>
                <span class="p">},</span>
                <span class="n">DropdownMenuAction</span><span class="p">.</span><span class="n">AlwaysEnabled</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">RegisterCallbacksOnTarget</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">target</span><span class="p">.</span><span class="n">RegisterCallback</span><span class="p">&lt;</span><span class="n">MouseDownEvent</span><span class="p">&gt;(</span><span class="n">OnMouseDown</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">RegisterCallback</span><span class="p">&lt;</span><span class="n">MouseUpEvent</span><span class="p">&gt;(</span><span class="n">OnMouseUp</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">RegisterCallback</span><span class="p">&lt;</span><span class="n">MouseMoveEvent</span><span class="p">&gt;(</span><span class="n">OnMouseMove</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">RegisterCallback</span><span class="p">&lt;</span><span class="n">MouseCaptureOutEvent</span><span class="p">&gt;(</span><span class="n">OnCaptureOut</span><span class="p">);</span>

        <span class="n">target</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="n">m_AddEdgeMenu</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">UnregisterCallbacksFromTarget</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">target</span><span class="p">.</span><span class="nf">RemoveManipulator</span><span class="p">(</span><span class="n">m_AddEdgeMenu</span><span class="p">);</span>

        <span class="n">target</span><span class="p">.</span><span class="n">UnregisterCallback</span><span class="p">&lt;</span><span class="n">MouseDownEvent</span><span class="p">&gt;(</span><span class="n">OnMouseDown</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">UnregisterCallback</span><span class="p">&lt;</span><span class="n">MouseUpEvent</span><span class="p">&gt;(</span><span class="n">OnMouseUp</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">UnregisterCallback</span><span class="p">&lt;</span><span class="n">MouseMoveEvent</span><span class="p">&gt;(</span><span class="n">OnMouseMove</span><span class="p">);</span>
        <span class="n">target</span><span class="p">.</span><span class="n">UnregisterCallback</span><span class="p">&lt;</span><span class="n">MouseCaptureOutEvent</span><span class="p">&gt;(</span><span class="n">OnCaptureOut</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseDown</span><span class="p">(</span><span class="n">MouseDownEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">CanStartManipulation</span><span class="p">(</span><span class="n">evt</span><span class="p">))</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="c1">// マウス押下では他のイベントが起きてほしくないのでPropagationを中断する</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m_Active</span><span class="p">)</span>
            <span class="n">evt</span><span class="p">.</span><span class="nf">StopImmediatePropagation</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseUp</span><span class="p">(</span><span class="n">MouseUpEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">CanStopManipulation</span><span class="p">(</span><span class="n">evt</span><span class="p">))</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(!</span><span class="n">m_Active</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Try Connect"</span><span class="p">);</span>  <span class="c1">// ここでマウスの下にあるノードにエッジを接続しようとする</span>

        <span class="n">m_Active</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">target</span><span class="p">.</span><span class="nf">ReleaseMouse</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseMove</span><span class="p">(</span><span class="n">MouseMoveEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">m_Active</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"move"</span><span class="p">);</span>  <span class="c1">// ここで、追加中のエッジの再描画を行う</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnCaptureOut</span><span class="p">(</span><span class="n">MouseCaptureOutEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">m_Active</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="n">m_Active</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">target</span><span class="p">.</span><span class="nf">ReleaseMouse</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>この時点では、以下のような挙動になります。<br>
<a href="https://camo.qiitausercontent.com/14da1df71ddd669707710cb07b7749ec6ff565ad/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f37313730303138612d646136372d613933382d303466632d3663383536666230623530302e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F7170018a-da67-a938-04fc-6c856fb0b500.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3e95fc3834db3c75dd48991fabb4f320" alt="NodeEditor-28.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/7170018a-da67-a938-04fc-6c856fb0b500.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F7170018a-da67-a938-04fc-6c856fb0b500.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=adc4349fbeac6a51bd44601fce1c5650 1x" loading="lazy"></a></p>

<h4>
<span id="522-エッジ追加のためにエッジグラフクラスを整備" class="fragment"></span><a href="#522-%E3%82%A8%E3%83%83%E3%82%B8%E8%BF%BD%E5%8A%A0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AB%E3%82%A8%E3%83%83%E3%82%B8%E3%82%B0%E3%83%A9%E3%83%95%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%95%B4%E5%82%99"><i class="fa fa-link"></i></a>5.2.2 エッジ追加のためにエッジ・グラフクラスを整備</h4>

<p>次に、EdgeElementクラスに追加中のEdgeを作成するための準備をします。<br>
これまではEdgeには元ノードと先ノードを渡して作成していましたが、追加中には先ノード確定していないので、元ノードと矢印の位置からエッジを描画できるようにします。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// EdgeElementクラス</span>

    <span class="n">Vector2</span> <span class="n">m_ToPosition</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">Vector2</span> <span class="n">ToPosition</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_ToPosition</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">set</span>
        <span class="p">{</span>
            <span class="c1">// 2020/01/09 追記：GraphEditorElementの座標系で渡されることを想定するように変更</span>

            <span class="c1">// m_ToPosition = this.WorldToLocal(value);  // ワールド座標で渡されることを想定</span>
            <span class="c1">//  ↓↓ 変更</span>
            <span class="n">m_ConnectingEdge</span><span class="p">.</span><span class="n">ToPosition</span> <span class="p">=</span> <span class="n">m_Graph</span><span class="p">.</span><span class="nf">WorldToLocal</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">mousePosition</span><span class="p">);</span>
            <span class="c1">// 2020/01/09 追記ここまで</span>

            <span class="nf">MarkDirtyRepaint</span><span class="p">();</span>  <span class="c1">// 再描画をリクエスト</span>
        <span class="p">}</span>  
    <span class="p">}</span>

    <span class="c1">// 新しいコンストラクタ</span>
    <span class="k">public</span> <span class="nf">EdgeElement</span><span class="p">(</span><span class="n">NodeElement</span> <span class="n">fromNode</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">toPosition</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">From</span> <span class="p">=</span> <span class="n">fromNode</span><span class="p">;</span>
        <span class="n">ToPosition</span> <span class="p">=</span> <span class="n">toPosition</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// つなげるときに呼ぶ</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ConnectTo</span><span class="p">(</span><span class="n">NodeElement</span> <span class="n">node</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">To</span> <span class="p">=</span> <span class="n">node</span><span class="p">;</span>
        <span class="nf">MarkDirtyRepaint</span><span class="p">();</span>  <span class="c1">// 再描画をリクエスト</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">DrawEdge</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">From</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">To</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">DrawEdge</span><span class="p">(</span>
                <span class="n">startPos</span><span class="p">:</span> <span class="n">From</span><span class="p">.</span><span class="nf">GetStartPosition</span><span class="p">(),</span>
                <span class="n">startNorm</span><span class="p">:</span> <span class="n">From</span><span class="p">.</span><span class="nf">GetStartNorm</span><span class="p">(),</span>
                <span class="n">endPos</span><span class="p">:</span> <span class="n">To</span><span class="p">.</span><span class="nf">GetEndPosition</span><span class="p">(),</span>
                <span class="n">endNorm</span><span class="p">:</span> <span class="n">To</span><span class="p">.</span><span class="nf">GetEndNorm</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// 追加中の描画用</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">From</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">DrawEdge</span><span class="p">(</span>
                    <span class="n">startPos</span><span class="p">:</span> <span class="n">From</span><span class="p">.</span><span class="nf">GetStartPosition</span><span class="p">(),</span>
                    <span class="n">startNorm</span><span class="p">:</span> <span class="n">From</span><span class="p">.</span><span class="nf">GetStartNorm</span><span class="p">(),</span>
                    <span class="n">endPos</span><span class="p">:</span> <span class="n">ToPosition</span><span class="p">,</span>
                    <span class="n">endNorm</span><span class="p">:</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">zero</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>これにより、追加中のEdgeElementをGraphEditorElementのEdgesに追加すれば自動的に描画されるようになったはずです。<br>
ということで、GraphEditorElementにエッジ追加リクエストを投げられるようにします。<br>
ついでに、ノード追加を中断したときのためにエッジ削除関数も作っておきます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>
    <span class="k">public</span> <span class="n">EdgeElement</span> <span class="nf">CreateEdgeElement</span><span class="p">(</span><span class="n">NodeElement</span> <span class="n">fromNode</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">toPosition</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">edgeElement</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EdgeElement</span><span class="p">(</span><span class="n">fromNode</span><span class="p">,</span> <span class="n">toPosition</span><span class="p">);</span>
        <span class="nf">Add</span><span class="p">(</span><span class="n">edgeElement</span><span class="p">);</span>
        <span class="n">m_Edges</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">edgeElement</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">edgeElement</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveEdgeElement</span><span class="p">(</span><span class="n">EdgeElement</span> <span class="n">edge</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">Remove</span><span class="p">(</span><span class="n">edge</span><span class="p">);</span>
        <span class="n">m_Edges</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">edge</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<h4>
<span id="523-エッジ追加の挙動を実装" class="fragment"></span><a href="#523-%E3%82%A8%E3%83%83%E3%82%B8%E8%BF%BD%E5%8A%A0%E3%81%AE%E6%8C%99%E5%8B%95%E3%82%92%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>5.2.3 エッジ追加の挙動を実装</h4>

<p>上で作った関数をEdgeConnectorクラスから呼びます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// EdgeConnectorクラス</span>

    <span class="n">GraphEditorElement</span> <span class="n">m_Graph</span><span class="p">;</span>
    <span class="n">EdgeElement</span> <span class="n">m_ConnectingEdge</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnContextualMenuPopulate</span><span class="p">(</span><span class="n">ContextualMenuPopulateEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">target</span> <span class="k">is</span> <span class="n">NodeElement</span> <span class="n">node</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">evt</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="nf">AppendAction</span><span class="p">(</span>
                <span class="s">"Add Edge"</span><span class="p">,</span>
                <span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuItem</span><span class="p">)</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="n">m_Active</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

                    <span class="c1">// 親をたどってGraphEditorElementを取得する</span>
                    <span class="n">m_Graph</span> <span class="p">=</span> <span class="n">target</span><span class="p">.</span><span class="n">GetFirstAncestorOfType</span><span class="p">&lt;</span><span class="n">GraphEditorElement</span><span class="p">&gt;();</span>
                    <span class="n">m_ConnectingEdge</span> <span class="p">=</span> <span class="n">m_Graph</span><span class="p">.</span><span class="nf">CreateEdgeElement</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">menuItem</span><span class="p">.</span><span class="n">eventInfo</span><span class="p">.</span><span class="n">mousePosition</span><span class="p">);</span>

                    <span class="n">target</span><span class="p">.</span><span class="nf">CaptureMouse</span><span class="p">();</span>
                <span class="p">},</span>
                <span class="n">DropdownMenuAction</span><span class="p">.</span><span class="n">AlwaysEnabled</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* ... 省略 */</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseUp</span><span class="p">(</span><span class="n">MouseUpEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">CanStopManipulation</span><span class="p">(</span><span class="n">evt</span><span class="p">))</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(!</span><span class="n">m_Active</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">node</span> <span class="p">=</span> <span class="n">m_Graph</span><span class="p">.</span><span class="nf">GetDesignatedNode</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">originalMousePosition</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="p">==</span> <span class="k">null</span>  <span class="c1">// 背景をクリックしたとき</span>
            <span class="p">||</span> <span class="n">node</span> <span class="p">==</span> <span class="n">target</span>  <span class="c1">// 自分自身をクリックしたとき</span>
            <span class="p">||</span> <span class="n">m_Graph</span><span class="p">.</span><span class="nf">ContainsEdge</span><span class="p">(</span><span class="n">m_ConnectingEdge</span><span class="p">.</span><span class="n">From</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>  <span class="c1">// すでにつながっているノード同士をつなげようとしたとき</span>
        <span class="p">{</span>
            <span class="n">m_Graph</span><span class="p">.</span><span class="nf">RemoveEdgeElement</span><span class="p">(</span><span class="n">m_ConnectingEdge</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">m_ConnectingEdge</span><span class="p">.</span><span class="nf">ConnectTo</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">m_Active</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">m_ConnectingEdge</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>  <span class="c1">// 接続終了</span>
        <span class="n">target</span><span class="p">.</span><span class="nf">ReleaseMouse</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseMove</span><span class="p">(</span><span class="n">MouseMoveEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">m_Active</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 2020/01/09 追記：Worldの座標系からGraphEditorElementの座標系に変換して渡すことにする</span>
        <span class="c1">//                 この例でいうと、ウィンドウの上のタブ領域の分だけずれることになる</span>

        <span class="c1">// m_ConnectingEdge.ToPosition = evt.originalMousePosition;  // 位置更新</span>
        <span class="c1">//  ↓↓ 変更</span>
        <span class="n">m_ConnectingEdge</span><span class="p">.</span><span class="n">ToPosition</span> <span class="p">=</span> <span class="n">m_Graph</span><span class="p">.</span><span class="nf">WorldToLocal</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">mousePosition</span><span class="p">);</span>  <span class="c1">// 位置更新</span>
        <span class="c1">// 2020/01/09 追記ここまで</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnCaptureOut</span><span class="p">(</span><span class="n">MouseCaptureOutEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">m_Active</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="c1">// 中断時の処理</span>
        <span class="n">m_Graph</span><span class="p">.</span><span class="nf">RemoveEdgeElement</span><span class="p">(</span><span class="n">m_ConnectingEdge</span><span class="p">);</span>
        <span class="n">m_ConnectingEdge</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="n">m_Active</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">target</span><span class="p">.</span><span class="nf">ReleaseMouse</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>

    <span class="c1">// マウスの位置にあるノードを返す</span>
    <span class="k">public</span> <span class="n">NodeElement</span> <span class="nf">GetDesignatedNode</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">position</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span><span class="p">(</span><span class="n">NodeElement</span> <span class="n">node</span> <span class="k">in</span> <span class="n">m_Nodes</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">ContainsPoint</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">WorldToLocal</span><span class="p">(</span><span class="n">position</span><span class="p">)))</span>
                <span class="k">return</span> <span class="n">node</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// すでに同じエッジがあるかどうか</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">ContainsEdge</span><span class="p">(</span><span class="n">NodeElement</span> <span class="k">from</span><span class="p">,</span> <span class="n">NodeElement</span> <span class="n">to</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">m_Edges</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">edge</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">edge</span><span class="p">.</span><span class="n">From</span> <span class="p">==</span> <span class="k">from</span> <span class="p">&amp;&amp;</span> <span class="n">edge</span><span class="p">.</span><span class="n">To</span> <span class="p">==</span> <span class="n">to</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>ここまでで、このような挙動になります。<br>
<a href="https://camo.qiitausercontent.com/1273a7c78b1a313975458c4ff831560eaa182cdf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f36666539383733612d316364632d313232322d323565372d6338326561666464353430362e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F6fe9873a-1cdc-1222-25e7-c82eafdd5406.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=878709c3b987076cde6e6e13084c2ab2" alt="NodeEditor-29.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/6fe9873a-1cdc-1222-25e7-c82eafdd5406.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F6fe9873a-1cdc-1222-25e7-c82eafdd5406.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=755ef04af8151729c5af91435924a7d9 1x" loading="lazy"></a></p>

<h4>
<span id="524-追加したエッジをシリアライズする" class="fragment"></span><a href="#524-%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>5.2.4 追加したエッジをシリアライズする</h4>

<p>今のままではEdgeElementを追加しただけなので、つないだエッジはデータとして残っていません。<br>
ノードのときと同じようにシリアライズする必要があります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// EdgeConnectorクラス</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">OnMouseUp</span><span class="p">(</span><span class="n">MouseUpEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* ... 省略 */</span>
        <span class="kt">var</span> <span class="n">node</span> <span class="p">=</span> <span class="n">m_Graph</span><span class="p">.</span><span class="nf">GetDesignatedNode</span><span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">originalMousePosition</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="p">==</span> <span class="k">null</span>
            <span class="p">||</span> <span class="n">node</span> <span class="p">==</span> <span class="n">target</span>
            <span class="p">||</span> <span class="n">m_Graph</span><span class="p">.</span><span class="nf">ContainsEdge</span><span class="p">(</span><span class="n">m_ConnectingEdge</span><span class="p">.</span><span class="n">From</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">m_Graph</span><span class="p">.</span><span class="nf">RemoveEdgeElement</span><span class="p">(</span><span class="n">m_ConnectingEdge</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">m_ConnectingEdge</span><span class="p">.</span><span class="nf">ConnectTo</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
            <span class="n">m_Graph</span><span class="p">.</span><span class="nf">SerializeEdge</span><span class="p">(</span><span class="n">m_ConnectingEdge</span><span class="p">);</span>  <span class="c1">// つないだ時にシリアライズする</span>
        <span class="p">}</span>

        <span class="cm">/* ... 省略 */</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">SerializeEdge</span><span class="p">(</span><span class="n">EdgeElement</span> <span class="n">edge</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">serializableEdge</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SerializableEdge</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">toId</span> <span class="p">=</span> <span class="n">m_Nodes</span><span class="p">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">To</span><span class="p">)</span>  <span class="c1">// ここで先ノードのIDを数える</span>
        <span class="p">};</span>

        <span class="n">edge</span><span class="p">.</span><span class="n">From</span><span class="p">.</span><span class="n">serializableNode</span><span class="p">.</span><span class="n">edges</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">serializableEdge</span><span class="p">);</span>  <span class="c1">// 実際に追加</span>
        <span class="n">edge</span><span class="p">.</span><span class="n">serializableEdge</span> <span class="p">=</span> <span class="n">serializableEdge</span><span class="p">;</span>  <span class="c1">// EdgeElementに登録しておく</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>そして、実際に開きなおしてみると、<br>
<a href="https://camo.qiitausercontent.com/9edb9902f4f74f6d1a4d5379b25cec8ac6bf4838/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f38363066623865312d393331632d643734632d373231332d6432613434646663656238342e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F860fb8e1-931c-d74c-7213-d2a44dfceb84.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1b7bff3cf3e58b790d6f86acd590629c" alt="NodeEditor-30.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/860fb8e1-931c-d74c-7213-d2a44dfceb84.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F860fb8e1-931c-d74c-7213-d2a44dfceb84.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=afda7ffaa835aabeebf207672553cdd5 1x" loading="lazy"></a></p>

<p>保存されています。</p>

<h3>
<span id="53-エッジを削除できるようにする" class="fragment"></span><a href="#53-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E5%89%8A%E9%99%A4%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>5.3 エッジを削除できるようにする</h3>

<p>エッジの追加ができるようになったので、やはり削除もできなければいけません。</p>

<p>ノードを削除するときと同様に、エッジの削除もコンテキストメニューから行いたいと思います。<br>
しかし、このとき問題があります。<br>
ノードは大きさのある<code>VisualElement</code>だったため、<code>ContextualManipulator</code>を付けるとそのままクリックで選択ができました。<br>
しかし、エッジの<code>VisualElement</code>は大きさがありません。</p>

<h4>
<span id="531-エッジを選択できるようにする" class="fragment"></span><a href="#531-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E9%81%B8%E6%8A%9E%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>5.3.1 エッジを選択できるようにする</h4>

<p><code>VisualElement</code>をクリックして選択するときの挙動について、<a href="https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html" rel="nofollow noopener" target="_blank">ドキュメント</a>に記載がありました。<br>
Event targetのPicking mode and custom shapesの項です。</p>

<blockquote>
<p>You can override the <code>VisualElement.ContainsPoint()</code> method to perform custom intersection logic.</p>
</blockquote>

<p>この<code>VisualElement.ContainsPoint()</code>は、マウス座標を与えると、その座標と自分が衝突しているかを判定する関数です。<br>
それをオーバーライドして、独自の衝突判定を埋め込むことで、<code>VisualElement</code>の<code>Rect</code>以外の形に対応させることができます。</p>

<p>実際にベジェ曲線と点との距離を計算するのは面倒なので、近似した線分との距離を計算して、指定距離以内だったら選択したことにしようと思います。</p>

<p>さて、衝突を判定の実装に当たって、ログを出すものが必要です<br>
というわけで最初に、エッジに削除用のコンテキストメニューを作ります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// EdgeElementクラス</span>

    <span class="c1">// 削除用マニピュレータの追加</span>
    <span class="k">public</span> <span class="nf">EdgeElement</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 2020/01/09 追記：マウスのイベントを呼ばれるためにはVisualElementのRectがマウス座標を含む必要がある</span>
        <span class="c1">//                 よって、エッジも大きさを持つため、自由な位置を取れるようにPosition.Absoluteを指定する</span>
        <span class="n">style</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">Position</span><span class="p">.</span><span class="n">Absolute</span><span class="p">;</span>
        <span class="c1">// 2020/01/09 追記ここまで</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">ContextualMenuManipulator</span><span class="p">(</span><span class="n">evt</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">target</span> <span class="k">is</span> <span class="n">EdgeElement</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">evt</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="nf">AppendAction</span><span class="p">(</span>
                <span class="s">"Remove Edge"</span><span class="p">,</span>
                <span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuItem</span><span class="p">)</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"Remove Edge"</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="n">DropdownMenuAction</span><span class="p">.</span><span class="n">AlwaysEnabled</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">EdgeElement</span><span class="p">(</span><span class="n">NodeElement</span> <span class="n">fromNode</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">toPosition</span><span class="p">):</span><span class="k">this</span><span class="p">()</span>  <span class="c1">// 上のコンストラクタを呼ぶ</span>
    <span class="p">{</span>
        <span class="n">From</span> <span class="p">=</span> <span class="n">fromNode</span><span class="p">;</span>
        <span class="n">ToPosition</span> <span class="p">=</span> <span class="n">toPosition</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">EdgeElement</span><span class="p">(</span><span class="n">SerializableEdge</span> <span class="n">edge</span><span class="p">,</span> <span class="n">NodeElement</span> <span class="n">fromNode</span><span class="p">,</span> <span class="n">NodeElement</span> <span class="n">toNode</span><span class="p">):</span><span class="k">this</span><span class="p">()</span>  <span class="c1">// 上のコンストラクタを呼ぶ</span>
    <span class="p">{</span>
        <span class="n">serializableEdge</span> <span class="p">=</span> <span class="n">edge</span><span class="p">;</span>
        <span class="n">From</span> <span class="p">=</span> <span class="n">fromNode</span><span class="p">;</span>
        <span class="n">To</span> <span class="p">=</span> <span class="n">toNode</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>まず、接続元と接続先が収まるバウンディングボックスと衝突しているかどうかを判定してみます。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// EdgeElementクラス</span>

    <span class="c1">// 2020/01/09 追記：バウンディングボックスの取得を別関数に分ける</span>
    <span class="c1">//                 また、幅が狭くなりすぎないように少し大きめに取ることにする</span>
    <span class="c1">//                 その大きさをDrawEdgeのタイミングで適用することにする</span>
    <span class="k">private</span> <span class="n">Rect</span> <span class="nf">GetBoundingBox</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Vector2</span> <span class="n">start</span> <span class="p">=</span> <span class="n">From</span><span class="p">.</span><span class="nf">GetStartPosition</span><span class="p">();</span>
        <span class="n">Vector2</span> <span class="n">end</span> <span class="p">=</span> <span class="n">To</span><span class="p">.</span><span class="nf">GetEndPosition</span><span class="p">();</span>

        <span class="n">Vector2</span> <span class="n">rectPos</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">-</span> <span class="m">12f</span><span class="p">,</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Min</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">end</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">-</span> <span class="m">12f</span><span class="p">);</span>
        <span class="n">Vector2</span> <span class="n">rectSize</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="n">Mathf</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">x</span> <span class="p">-</span> <span class="n">end</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">+</span> <span class="m">24f</span><span class="p">,</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">y</span> <span class="p">-</span> <span class="n">end</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">+</span> <span class="m">24f</span><span class="p">);</span>
        <span class="n">Rect</span> <span class="n">bound</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="n">rectPos</span><span class="p">,</span> <span class="n">rectSize</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">bound</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 2020/01/09 追記</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateLayout</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Rect</span> <span class="n">bound</span> <span class="p">=</span> <span class="nf">GetBoundingBox</span><span class="p">();</span>

        <span class="c1">// レイアウトをバウンディングボックスに合わせて調整</span>
        <span class="n">style</span><span class="p">.</span><span class="n">left</span> <span class="p">=</span> <span class="n">bound</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">top</span> <span class="p">=</span> <span class="n">bound</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">right</span> <span class="p">=</span> <span class="kt">float</span><span class="p">.</span><span class="n">NaN</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">bottom</span> <span class="p">=</span> <span class="kt">float</span><span class="p">.</span><span class="n">NaN</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">width</span> <span class="p">=</span> <span class="n">bound</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
        <span class="n">style</span><span class="p">.</span><span class="n">height</span> <span class="p">=</span> <span class="n">bound</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 2020/01/09 追記</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DrawEdge</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">From</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">To</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">UpdateLayout</span><span class="p">();</span>  <span class="c1">// 見た目とずれることがないよう、ここでLayoutを修正する</span>

            <span class="nf">DrawEdge</span><span class="p">(</span><span class="cm">/* ... 省略 */</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
            <span class="cm">/* ... 省略 */</span>
    <span class="p">}</span>
    <span class="c1">// 2020/01/09 追記ここまで</span>

    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">ContainsPoint</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">localPoint</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">From</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">To</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

        <span class="c1">// 2020/01/09 追記：EdgeElementのレイアウトに大きさを持たせたことにより</span>
        <span class="c1">//                 base.ContainsPoint()がバウンディングボックスを見る処理として利用できるようになった</span>

        <span class="cm">/*
        Vector2 start = From.GetStartPosition();
        Vector2 end = To.GetEndPosition();

        // ノードを覆うRectを作成
        Vector2 rectPos = new Vector2(Mathf.Min(start.x, end.x), Mathf.Min(start.y, end.y));
        Vector2 rectSize = new Vector2(Mathf.Abs(start.x - end.x), Mathf.Abs(start.y - end.y));
        Rect bound = new Rect(rectPos, rectSize);

        if (!bound.Contains(localPoint))
        {
            return false;
        }
        */</span>
        <span class="c1">//  ↓↓ 変更</span>
        <span class="k">if</span> <span class="p">(!</span><span class="k">base</span><span class="p">.</span><span class="nf">ContainsPoint</span><span class="p">(</span><span class="n">localPoint</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>結果はこうなりました。<br>
<a href="https://camo.qiitausercontent.com/0b03a0a4371145c20e43ca92e6c2c53a77e95b7f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f65656332363233652d303965302d656533632d386662332d3561623866626163393562612e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Feec2623e-09e0-ee3c-8fb3-5ab8fbac95ba.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=58075ab0f9901e7fccad518652e0ce93" alt="NodeEditor-31.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/eec2623e-09e0-ee3c-8fb3-5ab8fbac95ba.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Feec2623e-09e0-ee3c-8fb3-5ab8fbac95ba.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=068b086427f8c07ddf665cf639faeb28 1x" loading="lazy"></a><br>
確かに、エッジのバウンディングボックスとの当たりを判定できていそうです。</p>

<p>次に、近似線分との距離を計算してみます。<br>
先にバウンディングボックスに入っていないものを弾いているので、端点が一番近い場合などを考えなくて済みます。<br>
つまり、線分ではなく直線と点の距離を考えればよいということです。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// EdgeElementクラス</span>
    <span class="k">readonly</span> <span class="kt">float</span> <span class="n">INTERCEPT_WIDHT</span> <span class="p">=</span> <span class="m">15f</span><span class="p">;</span>  <span class="c1">// エッジと当たる距離</span>

    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">ContainsPoint</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">localPoint</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* ... 省略 */</span>

        <span class="k">if</span> <span class="p">(!</span><span class="k">base</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">localPoint</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 2020/01/09 追記：localPointはEdgeElementの座標系で与えられる</span>
        <span class="c1">//                 それをGraphEditorElementの座標系に合わせる必要がある</span>
        <span class="n">localPoint</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">ChangeCoordinatesTo</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">localPoint</span><span class="p">);</span>
        <span class="c1">// 2020/01/09 追記ここまで</span>

        <span class="c1">// 近似線分ab</span>
        <span class="n">Vector2</span> <span class="n">a</span> <span class="p">=</span> <span class="n">From</span><span class="p">.</span><span class="nf">GetStartPosition</span><span class="p">()</span> <span class="p">+</span> <span class="m">12f</span> <span class="p">*</span> <span class="n">From</span><span class="p">.</span><span class="nf">GetStartNorm</span><span class="p">();</span>
        <span class="n">Vector2</span> <span class="n">b</span> <span class="p">=</span> <span class="n">To</span><span class="p">.</span><span class="nf">GetEndPosition</span><span class="p">()</span> <span class="p">+</span> <span class="m">12f</span> <span class="p">*</span> <span class="n">To</span><span class="p">.</span><span class="nf">GetEndNorm</span><span class="p">();</span>

        <span class="c1">// 一致した場合はaからの距離</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="p">==</span> <span class="n">b</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">Vector2</span><span class="p">.</span><span class="nf">Distance</span><span class="p">(</span><span class="n">localPoint</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="p">&lt;</span> <span class="n">INTERCEPT_WIDHT</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 直線abとlocalPointの距離</span>
        <span class="kt">float</span> <span class="n">distance</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span>
            <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">y</span> <span class="p">-</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">*</span> <span class="n">localPoint</span><span class="p">.</span><span class="n">x</span>
            <span class="p">-</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">x</span> <span class="p">-</span> <span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="p">*</span> <span class="n">localPoint</span><span class="p">.</span><span class="n">y</span>
            <span class="p">+</span> <span class="n">b</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span> <span class="p">-</span> <span class="n">b</span><span class="p">.</span><span class="n">y</span> <span class="p">*</span> <span class="n">a</span><span class="p">.</span><span class="n">x</span>
            <span class="p">)</span> <span class="p">/</span> <span class="n">Vector2</span><span class="p">.</span><span class="nf">Distance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">distance</span> <span class="p">&lt;</span> <span class="n">INTERCEPT_WIDHT</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>結果はこうなりました。<br>
<a href="https://camo.qiitausercontent.com/691484c5b30442b000f58240440615a093f201b6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32363433623334302d383032332d316566342d383932382d6634316235383437636130372e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2643b340-8023-1ef4-8928-f41b5847ca07.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8ca29aab27bbb7d72621ad0a60661edb" alt="NodeEditor-32.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/2643b340-8023-1ef4-8928-f41b5847ca07.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2643b340-8023-1ef4-8928-f41b5847ca07.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=9648ef6dc391274121afc46ac4997bdc 1x" loading="lazy"></a><br>
...ちょっとずれている気もしますが、まあ、許容範囲でしょう。</p>

<h4>
<span id="532-エッジデータを削除する" class="fragment"></span><a href="#532-%E3%82%A8%E3%83%83%E3%82%B8%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>5.3.2 エッジデータを削除する</h4>

<p>GraphAssetからエッジのデータを消します。<br>
EdgeElementには元ノードの情報が既にありますので、そこから自分のデータが入っているSerializableNodeを取得することができます。<br>
これを消せばよいですね。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// EdgeElementクラス</span>

    <span class="k">public</span> <span class="nf">EdgeElement</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">ContextualMenuManipulator</span><span class="p">(</span><span class="n">evt</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">target</span> <span class="k">is</span> <span class="n">EdgeElement</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">evt</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="nf">AppendAction</span><span class="p">(</span>
                <span class="s">"Remove Edge"</span><span class="p">,</span>
                <span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuItem</span><span class="p">)</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="c1">// 親をたどってGraphEditorElementに削除リクエストを送る</span>
                    <span class="kt">var</span> <span class="n">graph</span> <span class="p">=</span> <span class="n">GetFirstAncestorOfType</span><span class="p">&lt;</span><span class="n">GraphEditorElement</span><span class="p">&gt;();</span>
                    <span class="n">graph</span><span class="p">.</span><span class="nf">RemoveEdgeElement</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="n">DropdownMenuAction</span><span class="p">.</span><span class="n">AlwaysEnabled</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}));</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveEdgeElement</span><span class="p">(</span><span class="n">EdgeElement</span> <span class="n">edge</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 消すエッジにSerializableEdgeがあれば、それを消す</span>
        <span class="k">if</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">serializableEdge</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">edge</span><span class="p">.</span><span class="n">From</span><span class="p">.</span><span class="n">serializableNode</span><span class="p">.</span><span class="n">edges</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">serializableEdge</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nf">Remove</span><span class="p">(</span><span class="n">edge</span><span class="p">);</span>
        <span class="n">m_Edges</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">edge</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><a href="https://camo.qiitausercontent.com/5dd271f95218a50a2593f476a1f364fe4a89b38b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f38393933633330332d386337372d353861372d313831622d6262353032633532343732312e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8993c303-8c77-58a7-181b-bb502c524721.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b8d3d38c61df4ece5c48ed9932e9aebf" alt="NodeEditor-33.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/8993c303-8c77-58a7-181b-bb502c524721.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8993c303-8c77-58a7-181b-bb502c524721.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3fa1f951713d2ac45b51f440bce93212 1x" loading="lazy"></a></p>

<p>無事、削除できています。</p>

<h2>
<span id="6-ノードを削除する" class="fragment"></span><a href="#6-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>6. ノードを削除する</h2>

<p>最後に、ノードを削除できるようにしたいと思います。<br>
ノードを削除したときには、<br>
- NodeElementを削除する<br>
- 対応するSerializableNodeを削除する<br>
- そのノードとつながるEdgeElementを削除する<br>
- 対応するSerializableEdgeを削除する<br>
- 他ノードのIDが変わるので、それに応じてSerializableEdgeのIDを振りなおす</p>

<p>のすべてを行う必要があります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// NodeElementクラス</span>

    <span class="k">public</span> <span class="nf">NodeElement</span> <span class="p">(</span><span class="n">SerializableNode</span> <span class="n">node</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* ... 省略 */</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">NodeDragger</span><span class="p">());</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">EdgeConnector</span><span class="p">());</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">AddManipulator</span><span class="p">(</span><span class="k">new</span> <span class="nf">ContextualMenuManipulator</span><span class="p">(</span><span class="n">OnContextualMenuPopulate</span><span class="p">));</span>  <span class="c1">// 削除用マニピュレータ</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnContextualMenuPopulate</span><span class="p">(</span><span class="n">ContextualMenuPopulateEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">evt</span><span class="p">.</span><span class="n">target</span> <span class="k">is</span> <span class="n">NodeElement</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">evt</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="nf">AppendAction</span><span class="p">(</span>
                <span class="s">"Remove Node"</span><span class="p">,</span>
                <span class="n">RemoveNodeMenuAction</span><span class="p">,</span>
                <span class="n">DropdownMenuAction</span><span class="p">.</span><span class="n">AlwaysEnabled</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">RemoveNodeMenuAction</span><span class="p">(</span><span class="n">DropdownMenuAction</span> <span class="n">menuAction</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 親をたどって削除をリクエスト</span>
        <span class="kt">var</span> <span class="n">graph</span> <span class="p">=</span> <span class="n">GetFirstAncestorOfType</span><span class="p">&lt;</span><span class="n">GraphEditorElement</span><span class="p">&gt;();</span>
        <span class="n">graph</span><span class="p">.</span><span class="nf">RemoveNodeElement</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="c1">// GraphEditorElementクラス</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveNodeElement</span><span class="p">(</span><span class="n">NodeElement</span> <span class="n">node</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_GraphAsset</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">serializableNode</span><span class="p">);</span>  <span class="c1">// アセットから削除</span>

        <span class="kt">int</span> <span class="n">id</span> <span class="p">=</span> <span class="n">m_Nodes</span><span class="p">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

        <span class="c1">// エッジの削除とID変更</span>
        <span class="c1">// m_Edgesに変更が伴うため、降順で行う</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">m_Edges</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">edgeElement</span> <span class="p">=</span> <span class="n">m_Edges</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="kt">var</span> <span class="n">edge</span> <span class="p">=</span> <span class="n">edgeElement</span><span class="p">.</span><span class="n">serializableEdge</span><span class="p">;</span>

            <span class="c1">// 削除されるノードにつながるエッジを削除</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">edgeElement</span><span class="p">.</span><span class="n">To</span> <span class="p">==</span> <span class="n">node</span> <span class="p">||</span> <span class="n">edgeElement</span><span class="p">.</span><span class="n">From</span> <span class="p">==</span> <span class="n">node</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">RemoveEdgeElement</span><span class="p">(</span><span class="n">edgeElement</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 変更が生じるIDを持つエッジに対して、IDに修正を加える</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">edge</span><span class="p">.</span><span class="n">toId</span> <span class="p">&gt;</span> <span class="n">id</span><span class="p">)</span>
                <span class="n">edge</span><span class="p">.</span><span class="n">toId</span><span class="p">--;</span>
        <span class="p">}</span>

        <span class="nf">Remove</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>  <span class="c1">// VisualElementの子としてのノードを削除</span>
        <span class="n">m_Nodes</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>  <span class="c1">// 順序を保持するためのリストから削除</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>これでノードを削除できるようになりました。<br>
<a href="https://camo.qiitausercontent.com/791ea7e65956dc8772fe30bbbf378b500050c8f2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32323765616437632d393264622d316563362d636338642d6364316239373837616338312e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F227ead7c-92db-1ec6-cc8d-cd1b9787ac81.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=938adf4dd011e9b7ddf455863329f2b2" alt="NodeEditor-35.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/227ead7c-92db-1ec6-cc8d-cd1b9787ac81.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F227ead7c-92db-1ec6-cc8d-cd1b9787ac81.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3628a2cacb757a5f527d82d70cdf692c 1x" loading="lazy"></a></p>

<p>ウィンドウを開きなおしてもちゃんと構造が保存されています。</p>

<h1>
<span id="結果" class="fragment"></span><a href="#%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>結果</h1>

<p><a href="https://camo.qiitausercontent.com/281875bc4df480afa97dcfc5b06320159d211439/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32356230643735332d333636312d623439302d373131332d3565316630393863376139612e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F25b0d753-3661-b490-7113-5e1f098c7a9a.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9d52a9118d199eb96962ec01c36b25ef" alt="NodeEditor-36.gif" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/25b0d753-3661-b490-7113-5e1f098c7a9a.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F25b0d753-3661-b490-7113-5e1f098c7a9a.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e5105bdb6a38973426b4cf0f30ea80c2 1x" loading="lazy"></a><br>
ゼロからノードベースエディタを作りました。<br>
現状ではグラフ構造を保存するアセットを作れるだけですが、このノード部分に何か情報を載せると立派なヴィジュアルツールが出来上がります。</p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>UIElementの使い方を勉強したいと思ったので、ノードベースエディタを作ってみました。<br>
ドキュメントとリファレンスを読み込むことになり、GraphViewの実装もかなり追ったので勉強になってよかったです。<br>
実をいうと、このGraphEditorを使ってBehaviorTreeを作るところまでやりたかったのですが、エディタを作るだけで相当の時間がかかってしまったので、この記事はここまでにしておきます。</p>

<p>また、ゼロから作るを銘打って、実装する手順通りに事細かく書いてしまったので、やたら長くなってしまいました。<br>
とはいえ、エディタを作るにあたって得た知見をふんだんに盛り込めたのではないかと思います。</p>

<p>ここはもっとこうした方がよい、のような意見があればコメントで教えていただけるとありがたいです。<br>
ご拝読ありがとうございました。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fsaragai%2Fitems%2Ff7f88df863091946c9d1&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fsaragai%2Fitems%2Ff7f88df863091946c9d1&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/saragai/items/f7f88df863091946c9d1/likers" class="css-1iupg5d">64</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">48</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/f7f88df863091946c9d1/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/saragai/items/f7f88df863091946c9d1/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/saragai/items/f7f88df863091946c9d1/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/saragai/items/f7f88df863091946c9d1/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/saragai/items/f7f88df863091946c9d1.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-96051e73-ebb7-492a-a86e-a8237bd0cd39">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-34aff346-e645-41b7-8f5a-418aa947e51a"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-34aff346-e645-41b7-8f5a-418aa947e51a">{}</script>
      
<div id="LoginModal-react-component-83ea09c4-0a18-44aa-8b69-ac701bf4a191"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-83ea09c4-0a18-44aa-8b69-ac701bf4a191">{}</script>
      
<div id="StockModal-react-component-df1b3ed6-ca34-4a8b-be31-063fb2fc9233"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-df1b3ed6-ca34-4a8b-be31-063fb2fc9233">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;ruX9m1sjxG+2kHe1v0LHk6KwpLpFjKOyTiBoYr4BeN0YKEp6y1qJWLtMGaaH+mFoIE23osqgtYcUtC3wq4DPWQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"概要\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e概要\u003c/h1\u003e\n\n\u003cp\u003eUnityのUIElementsによってこのようなノードベースエディタを作ります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/281875bc4df480afa97dcfc5b06320159d211439/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32356230643735332d333636312d623439302d373131332d3565316630393863376139612e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F25b0d753-3661-b490-7113-5e1f098c7a9a.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=9d52a9118d199eb96962ec01c36b25ef\" alt=\"NodeEditor-36.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/25b0d753-3661-b490-7113-5e1f098c7a9a.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F25b0d753-3661-b490-7113-5e1f098c7a9a.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e5105bdb6a38973426b4cf0f30ea80c2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eタイトルの「ゼロから」は、「UIElements」を知らないところから、という意味です。\u003cbr\u003e\nそのため、UIElemtnsに関する前提知識は必要ありません。\u003c/p\u003e\n\n\u003cp\u003eUnityのバージョンは2019.1.3f1です。\u003cbr\u003e\nプロジェクトはGitHubに挙げておきます。\u003cbr\u003e\n\u003ca href=\"https://github.com/saragai/GraphEditor/tree/article\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/saragai/GraphEditor/tree/article\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e2019/12/23 追記：バージョン2019.2.16f1でこのエディタを使用したところ、エッジの選択ができなくなっていました。\u003c/strong\u003e\u003cbr\u003e\n\u003cstrong\u003e2020/01/09 追記：上記の不具合を修正し、反映しました。変更ファイルはEdgeElement.csとEdgeConnector.csのみです。\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"背景\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%83%8C%E6%99%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e背景\u003c/h1\u003e\n\n\u003cp\u003eUnity2019からUIElementsというUIツールが入りました。\u003cbr\u003e\n現在はエディタ拡張にしか使えませんが、将来的にはゲーム内部のUIにも使えるようになるそうです。\u003c/p\u003e\n\n\u003cp\u003e最近の機能でいえば、ShaderGraphのようなGUIツールもUIElementで作られています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/8b4433433b988db6ab067ca0790278140afa19cd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f38613837343831632d396533392d373439322d643334372d3534363965316165613933612e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8a87481c-9e39-7492-d347-5469e1aea93a.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c911b00406d3f319e9408f56e3db6cca\" alt=\"shader_graph_sample.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/8a87481c-9e39-7492-d347-5469e1aea93a.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8a87481c-9e39-7492-d347-5469e1aea93a.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=64be94f7e9357030e6659b62009d5bdf 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n[画像は引用：\u003ca href=\"https://unity.com/ja/shader-graph\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://unity.com/ja/shader-graph\u003c/a\u003e]\u003c/p\u003e\n\n\u003cp\u003eこれはGraphViewというノードベースエディタによって作られていて、GraphViewを使えばShaderGraphのようなヴィジュアルツールを作成できます。\u003cbr\u003e\n[参照：\u003ca href=\"https://qiita.com/ma_sh/items/7627a6151e849f5a0ede\" id=\"reference-77a464b12c1b1b1714b1\"\u003eGraphView完全理解した(2019年末版)\u003c/a\u003e]\u003c/p\u003e\n\n\u003cp\u003eさて、本記事の目標はGraphViewのようなのツールを作ることです。\u003c/p\u003e\n\n\u003cp\u003eいやGraphView使えばいいじゃん、と思った方は鋭いです。実用に耐えるものを作るなら、使った方がよいと思います。\u003cbr\u003e\nさらに、本記事はUnityが公開している\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/tree/master/Modules/GraphViewEditor\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGraphViewの実装\u003c/a\u003eを大いに参考にしているので、GraphViewを使うならすべて無視できる内容です。\u003c/p\u003e\n\n\u003cp\u003eとはいえ、内部でどんなことをすると上記画像のようなエディタ拡張ができるのか、気になる方も多いのではと思います。\u003cbr\u003e\nその理解の一助となればと思います。\u003c/p\u003e\n\n\u003cp\u003e注）この記事は手順を細かく解説したり、あえて不具合のある例を付けたりしているので、冗長な部分が多々あります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h1\u003e\n\n\u003cp\u003e公式ドキュメントを見ながら実装していきます。\u003cbr\u003e\n\u003ca href=\"https://docs.unity3d.com/2019.1/Documentation/Manual/UIElements.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.unity3d.com/2019.1/Documentation/Manual/UIElements.html\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://docs.unity3d.com/2019.3/Documentation/ScriptReference/UIElements.VisualElement.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.unity3d.com/2019.3/Documentation/ScriptReference/UIElements.VisualElement.html\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"0-挨拶\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#0-%E6%8C%A8%E6%8B%B6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e0. 挨拶\u003c/h2\u003e\n\n\u003cp\u003eエディタ拡張用のスクリプトは必ず Assets/[どこでもいい]/Editor というディレクトリの下に置きます。ビルド時にビルド対象から外すためです。\u003cbr\u003e\nというわけで、Assets/Scripts/Editor にC#ファイルを作って GraphEditor と名付けます。\u003c/p\u003e\n\n\u003cp\u003eGraphとは、頂点と辺からなるデータ構造を示す用語で、ビヘイビアツリーや有限オートマトンもGraphの一種です。ビヘイビアツリーの場合はアクションやデコレータが頂点、それぞれがどのようにつながっているかが辺に対応します。ひとまずの目標は、このグラフを可視化できるようにすることです。\u003c/p\u003e\n\n\u003cp\u003eとはいえ、まだUIElementsと初めましてなので、まずは挨拶から始めます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditor.cs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGraphEditor\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEditorWindow\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eMenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Window/GraphEditor\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// Unityのメニュー/Window/GraphEditorから呼び出せるように\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eShowWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGraphEditor\u003c/span\u003e \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ウィンドウを作成。\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eShow\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ウィンドウを表示\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etitleContent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eGUIContent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Graph Editor\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// Windowの名前の設定\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Hello, World!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://blogs.unity3d.com/jp/2019/04/23/whats-new-with-uielements-in-2019-1/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnity公式ブログ\u003c/a\u003eのはじめの例を参考にしました。\u003c/p\u003e\n\n\u003cp\u003eウィンドウが作成されたときに呼ばれるOnEnable()で、はじめてUIElementsと対面します。\u003cbr\u003e\n見たところ、UIElementsはウィンドウの大元にあるrootVisualElementにどんどん要素を追加していく方式なんですね。\u003cbr\u003e\nrootVisualElementはVisualElementクラスで、LabelもVisualElementクラスを継承しています。\u003c/p\u003e\n\n\u003cp\u003eさあ、メニューからWindow/GraphEditorを選択すると以下のようなウィンドウが表示されます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ff469b153518d73935b09a0dbfe61fb12767b3d6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f38656539643835612d343036372d626431622d393635332d3934333835623230346363632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8ee9d85a-4067-bd1b-9653-94385b204ccc.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=084bfd5828ba8778d4471659751ec3bf\" alt=\"NodeEditor-0.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/8ee9d85a-4067-bd1b-9653-94385b204ccc.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8ee9d85a-4067-bd1b-9653-94385b204ccc.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f264c5dcc37321253b5ede09898cd00b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこんにちは！\u003cbr\u003e\nひとまず、挨拶は終わりました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"1-ノードを表示する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. ノードを表示する\u003c/h2\u003e\n\n\u003cp\u003eInspectorのように、行儀よく上から下へ情報を追加していくUIであれば、あとは色を変えてみたり、ボタンを追加してみたり、水平に並べてみたりすればいいのですが、ノードベースエディタを作ろうとしているのでそれだけでは不十分です。\u003cbr\u003e\n四角形を自由自在に動かせなければいけません。\u003c/p\u003e\n\n\u003cp\u003eドキュメントには、UIElementの構造の説明として、このような図がありました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/6e585a737bc2eb9fe3a82e77a52a2c166a2ccf6e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f66633039636230612d346333322d663937662d323961322d3161636465323963626261342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ffc09cb0a-4c32-f97f-29a2-1acde29cbba4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=aa1b1c52c89f5177cca991e19918daa5\" alt=\"visualtree-hierarchy.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/fc09cb0a-4c32-f97f-29a2-1acde29cbba4.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ffc09cb0a-4c32-f97f-29a2-1acde29cbba4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=c058b3839ea4fb05f4ba395bd6ba2e73 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n[画像は引用：\u003ca href=\"https://docs.unity3d.com/ja/2019.3/Manual/UIE-VisualTree.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.unity3d.com/ja/2019.3/Manual/UIE-VisualTree.html\u003c/a\u003e]\u003cbr\u003e\nまずは、このred containerのような四角形を出したいですね。\u003c/p\u003e\n\n\u003cp\u003eというわけでいろいろ試してみます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"11-表示場所を指定する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#11-%E8%A1%A8%E7%A4%BA%E5%A0%B4%E6%89%80%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1.1 表示場所を指定する\u003c/h3\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.unity3d.com/ja/2019.3/Manual/UIE-VisualTree.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eドキュメント\u003c/a\u003eによるとVisualElementはそれぞれlayoutなるメンバを持っていて、layout.positionやlayout.transformによって親に対する位置が決まるようです。実際に試してみましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditor.cs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGraphEditor\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEditorWindow\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eMenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Window/GraphEditor\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eShowWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGraphEditor\u003c/span\u003e \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eShow\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etitleContent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eGUIContent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Graph Editor\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Hello, World!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"One\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ered\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElement.cs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNode\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebackgroundColor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStyleColor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e先ほどと違うのは、NodeElementクラスですね。\u003cbr\u003e\nNodeはGraphの頂点のことで、有限オートマトンでいうと状態に対応します。\u003c/p\u003e\n\n\u003cp\u003eこのNodeElementのコンストラクタに色と位置を渡して、内部でstyle.backgroundClorとtransform.positionを設定します。\u003cbr\u003e\nそれをrootにAddして、どのように表示されるかを見てみます。\u003c/p\u003e\n\n\u003cp\u003e以下、結果です。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/3c5ef531a2a936b01e7bfec03aa967dca02e32a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f34666666376137312d363032372d633162352d636164622d3336373833663138623337652e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F4fff7a71-6027-c1b5-cadb-36783f18b37e.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=8b078a429d477d8f73745d58f3546983\" alt=\"NodeEditor-1.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/4fff7a71-6027-c1b5-cadb-36783f18b37e.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F4fff7a71-6027-c1b5-cadb-36783f18b37e.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=10575786a997321a55edfcb8b80ecf3d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nお！\u003cbr\u003e\n表示位置が唐突な場所になっていますね。\u003cbr\u003e\n右にずっと伸びていますが、まだ幅を指定していないからでしょう。\u003c/p\u003e\n\n\u003cp\u003eもう一つ追加してみましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Hello, World!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"One\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ered\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Two\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eyellow\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/8649efcb7e5569e2e26f201cbad2b000a463d7b8/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31613563353837392d323764332d383035632d303639352d3834363534336637366465342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1a5c5879-27d3-805c-0695-846543f76de4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=eea538a473311dfe92ee0e5aeea30a21\" alt=\"NodeEditor-2.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/1a5c5879-27d3-805c-0695-846543f76de4.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1a5c5879-27d3-805c-0695-846543f76de4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1646e4b39dad5356582dcb8595a5065e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n……あれ？\u003cbr\u003e\n同じY座標を指定したのに二つのノードは重なっていません。\u003c/p\u003e\n\n\u003cp\u003e本当は、\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/5b1c183eb44649fed506c93ff84e4f5f47d54c4c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f64646165303037652d653830652d376464332d326639322d3431616238616633666338622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fddae007e-e80e-7dd3-2f92-41ab8af3fc8b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e5e17d85b8acd5bc14fa7180323545b6\" alt=\"NodeEditor-3.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/ddae007e-e80e-7dd3-2f92-41ab8af3fc8b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fddae007e-e80e-7dd3-2f92-41ab8af3fc8b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=bb96f3abc691580177efef610014069a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこのようになって欲しかったのです。\u003cbr\u003e\nちなみに、この時点で上の図のようにするには以下を書きました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Hello, World!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"One\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ered\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Two\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eyellow\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// y座標を変更\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eどうやら18ピクセルだけ勝手に下にずらされていたようです。困ります。いい感じに自動レイアウトしてくれるという親切心だとは思うのですが、私が今作りたいのはヴィジュアルツールなので、上下左右に自在に動かしたいのです。\u003c/p\u003e\n\n\u003cp\u003e探すと\u003ca href=\"https://docs.unity3d.com/ja/2019.3/Manual/UIE-LayoutEngine.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e別のドキュメント\u003c/a\u003eにありました。\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eSet the \u003cstrong\u003eposition\u003c/strong\u003e property to \u003cstrong\u003eabsolute\u003c/strong\u003e to place an element relative to its parent position rectangle. In this case, it does not affect the layout of its siblings or parent.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003epositionプロパティをabsoluteにすれば兄弟(=siblings)や親の影響を受けないよとあります。\u003cbr\u003e\npositionプロパティってなんだと思いましたが、VisualStudioの予測変換機能を駆使して見つけました。\u003c/p\u003e\n\n\u003cp\u003eNodeElementのコンストラクタを以下のように書き換えます\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNode\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebackgroundColor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStyleColor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAbsolute\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 追加。これがposition propertyらしい\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eすると、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Hello, World!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"One\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ered\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Two\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eyellow\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eは以下のようになります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/ecada519abb41b3c1baf6b8da0e585345a8b94c0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f30616631323236372d633261332d313262652d393238382d6364343563376531346330302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F0af12267-c2a3-12be-9288-cd45c7e14c00.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b818a345993917278f4e9a66d23464e1\" alt=\"NodeEditor-4.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/0af12267-c2a3-12be-9288-cd45c7e14c00.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F0af12267-c2a3-12be-9288-cd45c7e14c00.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=63624aa18fbf4efaba305d629ee04e6e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eちゃんと同じ高さになりました！\u003cbr\u003e\nなぜか横方向の帯も消えています。\u003c/p\u003e\n\n\u003cp\u003eこれで位置を自由に指定できるようになりました。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"12-大きさを指定する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#12-%E5%A4%A7%E3%81%8D%E3%81%95%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1.2 大きさを指定する\u003c/h3\u003e\n\n\u003cp\u003e次は四角形の大きさを指定します。位置指定はラベルで実験したので勝手に大きさを合わせてくれていましたが、自由に幅や高さを指定したいです。\u003cbr\u003e\nこのような見た目に関する部分はだいたい\u003ccode\u003eVisualElement.style\u003c/code\u003eにまとまっているようで、以下のように指定します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNode\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebackgroundColor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStyleColor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAbsolute\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eすると以下のようになります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/8e8d60bfc79851d8f088e3796785e545c152ba0d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f61366563356231612d646266392d346166392d653163372d6430356331386366656437322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fa6ec5b1a-dbf9-4af9-e1c7-d05c18cfed72.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7cb5166738f09c2c850784103b6cb8a2\" alt=\"NodeEditor-5.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/a6ec5b1a-dbf9-4af9-e1c7-d05c18cfed72.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fa6ec5b1a-dbf9-4af9-e1c7-d05c18cfed72.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=36c4be56391cf6aa79a9de394a8dc2a2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e初めに言った、red containerのようになったと思います。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/6cdd8bcbdec2ecba7aba39cb0e8cc53c4840883e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31336636386135322d323137622d663461332d383730362d6664653130363965396233342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F13f68a52-217b-f4a3-8706-fde1069e9b34.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3e857a32b0a922bffc990f1c90dc4b43\" alt=\"visualtree-hierarchy.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/13f68a52-217b-f4a3-8706-fde1069e9b34.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F13f68a52-217b-f4a3-8706-fde1069e9b34.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5aeacc71e96ee1774aa287082c9d3466 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"2-ノードを動かす\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2. ノードを動かす\u003c/h2\u003e\n\n\u003cp\u003e次は表示した四角形をインタラクティブに移動させます。\u003cbr\u003e\nヴィジュアルツールでは、見やすいように位置を動かすことは大事です。\u003c/p\u003e\n\n\u003cp\u003e挙動としては、\u003cbr\u003e\n1. 四角形を左クリックして選択\u003cbr\u003e\n2. そのままドラッグすると一緒に動く\u003cbr\u003e\n3. ドロップで現在の位置に固定\u003cbr\u003e\nというのを想定しています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"21-まずは試してみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#21-%E3%81%BE%E3%81%9A%E3%81%AF%E8%A9%A6%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2.1 まずは試してみる\u003c/h3\u003e\n\n\u003cp\u003eこれらはどれもマウスの挙動に対しての反応なので、マウスイベントに対するコールバックとして実装します。\u003cbr\u003e\n探すと公式ドキュメントに\u003ca href=\"https://docs.unity3d.com/ja/2019.3/Manual/UIE-Events.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eThe Event System\u003c/a\u003eという項がありました。\u003cbr\u003e\nいろいろと重要そうなことが書いてある気がしますが、今はとりあえずイベントを取りたいのでその中の\u003ca href=\"https://docs.unity3d.com/ja/2019.3/Manual/UIE-Events-Handling.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eResponding to Events\u003c/a\u003eを見てみます。\u003cbr\u003e\nどうやら、\u003ccode\u003eVisualElement.RegisterCallback()\u003c/code\u003eによってコールバックを登録できるみたいですね。\u003c/p\u003e\n\n\u003cp\u003eマウスに関するイベントはそれぞれ、\u003cbr\u003e\n1. \u003ccode\u003eMouseDownEvent\u003c/code\u003e\u003cbr\u003e\n2. \u003ccode\u003eMouseMoveEvent\u003c/code\u003e\u003cbr\u003e\n3. \u003ccode\u003eMouseUpEvent\u003c/code\u003e\u003cbr\u003e\nでとることができそうです。\u003c/p\u003e\n\n\u003cp\u003eNodeElementクラスを以下のように書き換えます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebackgroundColor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStyleColor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAbsolute\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003efocus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseDownEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebutton\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 左クリック\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003efocus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 選択\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efocus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 選択を解除\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseMoveEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efocus\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emouseDelta\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// マウスが動いた分だけノードを動かす\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eすると、以下のような挙動になります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/fc78b237a77c649cd0b697a3d5870d1feccfd8e2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f61636165383036312d663031642d656264362d376235362d6561623339366437656663662e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Facae8061-f01d-ebd6-7b56-eab396d7efcf.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=25986b5127bd8d43a28628e17bbfad91\" alt=\"NodeEditor-7.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/acae8061-f01d-ebd6-7b56-eab396d7efcf.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Facae8061-f01d-ebd6-7b56-eab396d7efcf.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=100d3da8762a69fae30feb7ba3e087be 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n動きましたが、少し使いにくそうな動きです。\u003cbr\u003e\nまず、赤いノードが黄色のノードの下にあるせいで、赤を動かしている途中にカーソルが黄色の上に来ると、赤が動かなくなってしまいます。\u003cbr\u003e\nさらにそのあと右クリックをやめても選択が解除されておらず、赤が勝手に動いてしまいます。これは、\u003ccode\u003eMouseUpEvent\u003c/code\u003eが赤いノードに対して呼ばれていないことが問題のようです。\u003c/p\u003e\n\n\u003cp\u003e改善策は、\u003cbr\u003e\n1. 選択したノードは最前面に来てほしい\u003cbr\u003e\n2. カーソルがノードの外に出たときにも、マウスイベントは呼ばれてほしい\u003cbr\u003e\nの二つです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"22-visualelementの表示順を変える\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#22-visualelement%E3%81%AE%E8%A1%A8%E7%A4%BA%E9%A0%86%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2.2 VisualElementの表示順を変える\u003c/h3\u003e\n\n\u003cp\u003eドキュメントの\u003ca href=\"https://docs.unity3d.com/ja/2019.3/Manual/UIE-VisualTree.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eThe Visual Treeの項目\u003c/a\u003eに、Drawing orderの項があります。\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eDrawing order\u003c/strong\u003e\u003cbr\u003e\nThe elements in the visual tree are drawn in the following order:\u003cbr\u003e\n- parents are drawn before their children\u003cbr\u003e\n- children are drawn according to their sibling list\u003c/p\u003e\n\n\u003cp\u003eThe only way to change their drawing order is to reorder \u003cem\u003eVisualElementobjects\u003c/em\u003e in their parents.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e描画順を変えるには親オブジェクトが持つVisualElementを並び替えないといけないようです。\u003cbr\u003e\nそれ以上の情報がないので\u003ca href=\"https://docs.unity3d.com/2019.3/Documentation/ScriptReference/UIElements.VisualElement.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eVisualElementのスクリプトリファレンス\u003c/a\u003eを見てみます。その中のメソッドでそれらしいものがないかを探すと……ありました。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eBringToFront()\u003c/code\u003eというメソッドで、親の子供リストの中の最後尾へ自分を持っていくものです。\u003cbr\u003e\nこれをMouseDownEventのコールバックに追加します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElementクラス\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseDownEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebutton\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003efocus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eBringToFront\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 自分を最前面に持ってくる\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e実行結果は以下です。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c49415c800a3e4c75f72f6feb3b984659e1e26c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f61353630383238332d343830312d623566332d333530662d3430643130356264306137382e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fa5608283-4801-b5f3-350f-40d105bd0a78.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=fb796a1c0203bb6876c1dde44469857b\" alt=\"NodeEditor-8.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/a5608283-4801-b5f3-350f-40d105bd0a78.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fa5608283-4801-b5f3-350f-40d105bd0a78.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1c00cfcd640f10da3e131aa687dd5c28 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nクリックしたものが最前面へきているのがわかります。\u003cbr\u003e\nしかし、動画後半のように、マウスを勢いよく動かすとノードがついてこられないことがわかります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"23-マウスイベントをキャプチャする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#23-%E3%83%9E%E3%82%A6%E3%82%B9%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2.3 マウスイベントをキャプチャする\u003c/h3\u003e\n\n\u003cp\u003eマウスを勢いよく動かしたとき、カーソルがノードの外に出るので\u003ccode\u003eMouseLeaveEvent\u003c/code\u003eが呼ばれるはずです。その時にPositionを更新してドラッグ中は常にノードがカーソルの下にあるようにすればよい、と初めは思っていました。\u003cbr\u003e\nですが、それだと勢いよく動かした直後にマウスクリックを解除した場合に、\u003ccode\u003eMouseUpEvent\u003c/code\u003eが選択中のノードに対して呼ばれないようなのです。\u003cbr\u003e\nイベントの呼ばれる順序にかかわる部分で、丁寧に対応してもバグの温床になりそうです。\u003c/p\u003e\n\n\u003cp\u003eいい方法はないかなとドキュメントを読んでいると、よさそうなものを見つけました。\u003cbr\u003e\n\u003ca href=\"https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDispatching Events\u003c/a\u003eの中のCapture the mouseという項です。\u003c/p\u003e\n\n\u003cp\u003eVisualElementは\u003ccode\u003eCaptureMouse()\u003c/code\u003eを呼ぶことによって、カーソルが自身の上にないときでもマウスイベントを自分のみに送ってくれるようになるということで、まさにマウスをキャプチャしています。\u003cbr\u003e\nキャプチャすると、マウスが自分の上にあるかどうかを気にしなくてよくなるので、安心して使えそうです。\u003c/p\u003e\n\n\u003cp\u003eということで、MouseDown時にキャプチャし、MouseUp時に解放するように書き換えてみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElementクラス\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseDownEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebutton\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003efocus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eBringToFront\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eCaptureMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// マウスイベントをキャプチャ\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eReleaseMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// キャプチャを解放\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efocus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseCaptureOutEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_Focus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// キャプチャが外れたときはドラッグを終了する\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eMouseCaptureOutEvent\u003c/code\u003eは他の\u003ccode\u003eVisualElement\u003c/code\u003eなどによってキャプチャを奪われたときに呼ばれる関数です。\u003c/p\u003e\n\n\u003cp\u003e実行結果は以下になります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/d596b28479c7b273213331f0d5d0313f44426970/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f35306138393764632d663637302d393031302d363031312d3736313066633162396232612e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F50a897dc-f670-9010-6011-7610fc1b9b2a.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=18475f1ec2703e2c3db1811d059037fe\" alt=\"NodeEditor-9.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/50a897dc-f670-9010-6011-7610fc1b9b2a.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F50a897dc-f670-9010-6011-7610fc1b9b2a.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b399c7ebf07a1ff73cae751762555940 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n無事に意図した動きになりました。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"24-ノードを動かすコードをmanipulatorによって分離する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#24-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92manipulator%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E5%88%86%E9%9B%A2%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2.4 ノードを動かすコードをManipulatorによって分離する\u003c/h3\u003e\n\n\u003cp\u003eこの後もノードには様々な機能が追加される予定ですので、コードが煩雑にならないためにも、ノードを動かす部分を分離してしまいたいです。\u003cbr\u003e\nどうしようか悩んでいましたが、UIElementsにはManipulatorという仕組みがあることを見つけました。\u003cbr\u003e\nManipulatorを使うことで、「ノードを動かす」のような操作を追加するコードをきれいに分離して書くことができます。\u003c/p\u003e\n\n\u003cp\u003eNodeDraggerというクラスを作成します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeDragger.cs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eNodeDragger\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseManipulator\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003em_Focus\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeDragger\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 左クリックで有効化する\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eactivators\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eManipulatorActivationFilter\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003ebutton\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLeftMouse\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// Manipulatorにターゲットがセットされたときに呼ばれる\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegisterCallbacksOnTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Focus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseDownEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseMoveEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseMove\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseCaptureOutEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseCaptureOut\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e/// Manipulatorのターゲットが変わる直前に呼ばれる\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnregisterCallbacksFromTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnregisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseDownEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnregisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnregisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseMoveEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseMove\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnregisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseCaptureOutEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseCaptureOut\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseDownEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 設定した有効化条件をみたすか (= 左クリックか)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eCanStartManipulation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_Focus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBringToFront\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCaptureMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// CanStartManipulation()で条件を満たしたActivationのボタン条件と、\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// このイベントを発火させているボタンが同じか\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// (= 左クリックを離したときか)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eCanStopManipulation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReleaseMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_Focus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseCaptureOut\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseCaptureOutEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Focus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseMove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseMoveEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_Focus\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emouseDelta\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eRegisterCallBacksOnTarget()\u003c/code\u003eと\u003ccode\u003eUnregisterCallbacksFromTarget()\u003c/code\u003eは\u003ccode\u003eManipulator\u003c/code\u003eクラスの関数で、イベントのコールバックの登録・解除を担っています。\u003cbr\u003e\n\u003ccode\u003eactivators\u003c/code\u003eや\u003ccode\u003eCanStartManipulation()\u003c/code\u003e、\u003ccode\u003eCanStopManipulation()\u003c/code\u003eは\u003ccode\u003eManipulator\u003c/code\u003eクラスを継承する\u003ccode\u003eMouseManipulator\u003c/code\u003eクラスの関数で、マウスのボタンの管理がしやすくなっています。\u003cbr\u003e\n細かいことはコード中のコメントに記載しました。\u003c/p\u003e\n\n\u003cp\u003eこのManipulatorを使用するには、対象のVisualElementを設定しなければいけません。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebackgroundColor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStyleColor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAbsolute\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eLabel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeDragger\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 操作の追加が一行で済む\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eAddManipulator\u003c/code\u003eという関数によって対象のVisualElementを設定しています。\u003cbr\u003e\n実はこのコードは以下のようにもかけます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeDragger\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econtainer\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e内部の実装を見ると、\u003ccode\u003eAddManipulator\u003c/code\u003eでは\u003ccode\u003eIManipulator.target\u003c/code\u003eプロパティに自身をセットしているだけでした。\u003cbr\u003e\nそしてsetter内で、セットする前に既存のtargetがあれば\u003ccode\u003eUnregisterCallbacksFromTarget()\u003c/code\u003eを呼び、そのあと新規のターゲットをセットしてから\u003ccode\u003eRegisterCallbacksOnTarget()\u003c/code\u003eを呼びます。\u003c/p\u003e\n\n\u003cp\u003e[参照：\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/2019.1/Modules/UIElements/Manipulators.cs\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/Unity-Technologies/UnityCsReference/blob/2019.1/Modules/UIElements/Manipulators.cs\u003c/a\u003e]\u003cbr\u003e\n[参照：\u003ca href=\"https://github.com/Unity-Technologies/UnityCsReference/blob/2019.1/Modules/UIElements/MouseManipulator.cs\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/Unity-Technologies/UnityCsReference/blob/2019.1/Modules/UIElements/MouseManipulator.cs\u003c/a\u003e]\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"3-ノードを追加する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3. ノードを追加する\u003c/h2\u003e\n\n\u003cp\u003eこれまではテストのためにノードの数は2つで固定されていましたが、自在に追加できなければグラフエディタとはとても呼べません。\u003cbr\u003e\n想定している挙動は、\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e右クリックでメニューが出てくる\u003c/li\u003e\n\u003cli\u003e「Add Node」を選択する\u003c/li\u003e\n\u003cli\u003e右クリックした場所にノードが生成される\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eです。\u003c/p\u003e\n\n\u003cp\u003e......実は前章の最後あたりで、このままのペースで書いていると時間がいくらあっても足りないと思い、先に実装してから記事を書くことにしました。\u003cbr\u003e\nですので、これからの説明は少しスムーズに（悪く言えば飛躍気味に）なるかもしれません。ご了承ください。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"31-メニューを表示する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#31-%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.1 メニューを表示する\u003c/h3\u003e\n\n\u003cp\u003e2.4節で見たようなManipulatorと同じように、この挙動も操作としてまとめることができそうです。\u003cbr\u003e\nというか、こんなみんなが欲しそうな機能が公式に用意されていないはずがありません。\u003cbr\u003e\n案の定、存在しました。例によって\u003ca href=\"https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Controls.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式ドキュメント\u003c/a\u003eです。\u003c/p\u003e\n\n\u003cp\u003eコードを載せます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"One\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ered\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Two\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eyellow\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContextualMenuManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnContextMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnContextMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContextualMenuPopulateEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 項目を追加\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emenu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"s\"\u003e\"Add Node\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 項目名\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eAddEdgeMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 選択時の挙動\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlwaysEnabled\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 選択可能かどうか\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddEdgeMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Add Node\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eさあ、どうでしょうか。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f9a89fb11383a7f026ae5cc5cfc111f1092d696a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31373134653062622d393164352d663532642d626662352d3564353535383531383631632e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1714e0bb-91d5-f52d-bfb5-5d555851861c.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7b8251ebcb4472e8d13c3b73afe57fec\" alt=\"NodeEditor-10.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/1714e0bb-91d5-f52d-bfb5-5d555851861c.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F1714e0bb-91d5-f52d-bfb5-5d555851861c.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=01f7afd92e132bfcc63d4b5a0d76ebc4 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n上手く動いていません。\u003c/p\u003e\n\n\u003cp\u003e期待していた挙動は、「背景を左クリックしたときはメニューが開いて、ノードを左クリックしたときは何も起こらない」です。でも、これでは逆ですね。\u003cbr\u003e\n\u003ca href=\"https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eイベント発行についてのドキュメント\u003c/a\u003eを見てみます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/0c8f9b3b8f577007e299a2c5f7814a938a5de8a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f61643865353064612d643835342d663537372d326438352d6162613837386330326162612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fad8e50da-d854-f577-2d85-aba878c02aba.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=af01da249d0f32615f9f580e610464b6\" alt=\"NodeEditor-11.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/ad8e50da-d854-f577-2d85-aba878c02aba.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fad8e50da-d854-f577-2d85-aba878c02aba.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=2d09bdf527bf288706639ff387122306 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n[図は引用：\u003ca href=\"https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html\u003c/a\u003e]\u003c/p\u003e\n\n\u003cp\u003eイベントは root -\u0026gt; target -\u0026gt; root と呼ばれるみたいですね。\u003ca href=\"https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Handling.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eイベント受け取りについてのドキュメント\u003c/a\u003eには、デフォルトではTargetフェイズとBubbleUpフェイズにイベントが登録されるともあります。\u003c/p\u003e\n\n\u003cp\u003eとにかく、思い当たるのは、ルートに登録したコールバックがノード経由で伝わっているということです。\u003cbr\u003e\nいろいろ試してみてわかったのは、ルートではデフォルトで\u003ccode\u003epickingMode\u003c/code\u003eが\u003ccode\u003ePickingMode.Ignore\u003c/code\u003eに設定されているということでした。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.unity3d.com/2019.1/Documentation/ScriptReference/UIElements.IPanel.Pick.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eリファレンス\u003c/a\u003eによると、マウスのクリック時にターゲットを決める際、その位置にある一番上のVisualElementを取ってきているらしいのですが、この\u003ccode\u003epickingMode\u003c/code\u003eが\u003ccode\u003ePickingMode.Ignore\u003c/code\u003eに設定されていた場合は候補から外す、という挙動になるようです。\u003c/p\u003e\n\n\u003cp\u003e実際、このようにすると動きます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorクラス\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"One\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ered\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Two\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eyellow\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epickingMode\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePickingMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ピッキングモード変更\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContextualMenuManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnContextMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/f1b3f34d28bbeef484d5963350a72b0dd95df86a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f36356130343631342d653361632d376266362d383866612d3439346135613463343666302e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F65a04614-e3ac-7bf6-88fa-494a5a4c46f0.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ff855a06bcf1e622b44a90181d48c508\" alt=\"NodeEditor-12.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/65a04614-e3ac-7bf6-88fa-494a5a4c46f0.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F65a04614-e3ac-7bf6-88fa-494a5a4c46f0.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=ce9bd957f995fc91a374f4938ccefe11 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nでも、ルートをむやみに変更するのはよくないですね。\u003cbr\u003e\nそこで、ルートの一つ下に一枚挟むことにします。今の作りでは、EditorWindowとVisualElementが不可分になってしまっていましたが、それを分離可能にするという意味合いもあります。\u003c/p\u003e\n\n\u003cp\u003eさあ、いよいよもってGraphViewに近づいてきました。\u003cbr\u003e\n分離自体はすぐにできます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditor.cs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGraphEditor\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEditorWindow\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eMenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Window/GraphEditor\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eShowWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGraphEditor\u003c/span\u003e \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eShow\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etitleContent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eGUIContent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Graph Editor\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eGraphEditorElement\u003c/span\u003e \u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElement.cs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eflexGrow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// サイズを画面いっぱいに広げる\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoverflow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eOverflow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHidden\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ウィンドウの枠からはみ出ないようにする\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"One\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ered\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Two\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eyellow\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContextualMenuManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnContextMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnContextMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContextualMenuPopulateEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emenu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"s\"\u003e\"Add Node\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eAddNodeMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlwaysEnabled\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddNodeMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Add Node\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e二つのスタイルを適用しました。\u003cbr\u003e\n\u003ccode\u003estyle.flexGrow = 1;\u003c/code\u003e によってGraphEditorElementのサイズが画面いっぱいに広がり、クリックイベントを拾う背景の役割を果たしてくれます。\u003cbr\u003e\n\u003ccode\u003estyle.overflow = Overflow.Hidden;\u003c/code\u003e は親の領域からはみ出た部分を表示しないようにします。ノードを動かすとウィンドウの枠からはみ出したりしていましたが、これでもう心配はいりません。\u003c/p\u003e\n\n\u003cp\u003e挙動はこのようになります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/70065fe40c35c1b496dd9e08aae0fa261dc849c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32663735396232642d333636312d613666332d386364352d3565633431343663646630312e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2f759b2d-3661-a6f3-8cd5-5ec4146cdf01.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=95d364e0534b38047d13fbc8a7483b67\" alt=\"NodeEditor-13.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/2f759b2d-3661-a6f3-8cd5-5ec4146cdf01.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2f759b2d-3661-a6f3-8cd5-5ec4146cdf01.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=06d38157a31f8193d4e2ed9aa88b5f17 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nまだノードの上で右クリックしたときもAdd Nodeメニューが出てしまいます。\u003cbr\u003e\nこれはノードに対しても何かを設定する必要がありそうですね。\u003c/p\u003e\n\n\u003cp\u003e後でノードを左クリックしたときにエッジを追加する挙動を実装します。そのとき考えましょう。\u003c/p\u003e\n\n\u003cp\u003eとにかくメニューは出たということで、次へ進んでいきます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"32-ノードを生成する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#32-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.2 ノードを生成する\u003c/h3\u003e\n\n\u003cp\u003eAdd Nodeというログを出していた部分を少し変更すると、新しいノードが生成できます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddNodeMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeventInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elocalMousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// マウス位置はeventInfoの中にあります\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"add\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egreen\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e挙動です。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/7b24bbfae8eb60cdce0624abafc50cc882f59aca/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f34303661366532352d613866322d653038622d323063382d3635316265303562393235302e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F406a6e25-a8f2-e08b-20c8-651be05b9250.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=4d7f363440fc1bcb1e548b624e9aee94\" alt=\"NodeEditor-14.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/406a6e25-a8f2-e08b-20c8-651be05b9250.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F406a6e25-a8f2-e08b-20c8-651be05b9250.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5047003372f31cf32d9763616054f23e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれで、表示の上では新しいノードを生成できました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"4-ノードを永続化する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E6%B0%B8%E7%B6%9A%E5%8C%96%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4. ノードを永続化する\u003c/h2\u003e\n\n\u003cp\u003e3章で生成したノードはGraphEditorウィンドウを開きなおしたりすると消えてしまいます。\u003cbr\u003e\nUnityで何らかのデータを保存しておくには、どこかのファイルにシリアライズしておく必要があります。\u003c/p\u003e\n\n\u003cp\u003e「シリアライズとはXXXである」と一言で言えたらいいのですが、短く上手く説明できる気がしません。\u003cbr\u003e\n脱線になってしまってもよくないので、気になる方は「Unity シリアライズ」などで検索してみてください。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"41-グラフ構造とは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#41-%E3%82%B0%E3%83%A9%E3%83%95%E6%A7%8B%E9%80%A0%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.1 グラフ構造とは\u003c/h3\u003e\n\n\u003cp\u003e方針としては、グラフを再現するのに最低限必要なものを用意します。\u003cbr\u003e\n冒頭でも少し触れましたが、ここでグラフの定義を明確にしておきます。\u003c/p\u003e\n\n\u003cp\u003eグラフには大きく分けて二種類あります。\u003cbr\u003e\n無向グラフと有向グラフです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/63e7440a47362e1b53ef3e510addef989bb78b18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f31376365326461372d336662662d666634312d616437622d6337663836396631303835652e6a706567\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F17ce2da7-3fbf-ff41-ad7b-c7f869f1085e.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5f0cff3900c9c657ada05eb594c73809\" alt=\"graph_sample.jpg\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/17ce2da7-3fbf-ff41-ad7b-c7f869f1085e.jpeg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F17ce2da7-3fbf-ff41-ad7b-c7f869f1085e.jpeg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e49b76b03b7c97706ddd4718832614d2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n[図は引用：\u003ca href=\"https://qiita.com/drken/items/4a7869c5e304883f539b\" class=\"autolink\" id=\"reference-5a2f32b212affb3ba576\"\u003ehttps://qiita.com/drken/items/4a7869c5e304883f539b\u003c/a\u003e]\u003c/p\u003e\n\n\u003cp\u003eエッジ、つまり辺に向きがあるかないかの差があります。\u003cbr\u003e\nゲームで使う場合、ロジックを表現するためのグラフはほとんどが有向グラフなのではと思います。\u003c/p\u003e\n\n\u003cp\u003eビヘイビアツリー：　ノードはアクション、エッジは遷移\u003cbr\u003e\n有限オートマトン：　ノードは状態、エッジは遷移\u003c/p\u003e\n\n\u003cp\u003eということで、作成中のグラフエディタも、有向グラフを表せるものを作りたいと思います。\u003cbr\u003e\n余談ですが、無向グラフは有効グラフの矢印と逆向きに同じ矢印を付けると実現することができます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"42-シリアライズ用のクラスを作る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#42-%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E7%94%A8%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.2 シリアライズ用のクラスを作る\u003c/h3\u003e\n\n\u003cp\u003e構造としては、\u003cbr\u003e\nグラフアセット：ノードリストを持つ\u003cbr\u003e\nノード：エッジリストを持つ\u003cbr\u003e\nエッジ：つながるノードを持つ\u003c/p\u003e\n\n\u003cp\u003eとして、グラフアセットをアセットとして新規作成できるようにしようと思います。\u003cbr\u003e\n実装は以下のようにします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphAsset.cs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateAssetMenu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efileName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"graph.asset\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emenuName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Graph Asset\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGraphAsset\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eScriptableObject\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003enodes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializable\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSerializableNode\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eedges\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializable\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSerializableEdge\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eSerializableNode\u003c/span\u003e \u003cspan class=\"n\"\u003etoNode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eScriptableObject\u003c/code\u003eに\u003ccode\u003e[CreateAssetMenu]\u003c/code\u003eを付けることで、Unityのプロジェクトなどで右クリックをしたときにメニューから生成できるようになります。\u003cbr\u003e\nまた、\u003ccode\u003e[System.Serializable]\u003c/code\u003eアトリビュートによって、指定したクラスをシリアライズ可能にしています。\u003c/p\u003e\n\n\u003cp\u003e早速、グラフアセットを作ってみました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f64243707eccf5eeafc0c2398dd11ccc09e8d9a2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f39356636643863662d346137662d326438312d656233322d3839616262653935363961612e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F95f6d8cf-4a7f-2d81-eb32-89abbe9569aa.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=849328cce2b35dbfa3948cdb4d6ddc0c\" alt=\"NodeEditor-15.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/95f6d8cf-4a7f-2d81-eb32-89abbe9569aa.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F95f6d8cf-4a7f-2d81-eb32-89abbe9569aa.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=acfc6fa0ce032c74c99f8c370f3147b0 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nすると、このようなエラーが出ます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eSerialization depth limit 7 exceeded at 'SerializableEdge.toNode'. There may be an object composition cycle in one or more of your serialized classes.\n\nSerialization hierarchy:\n8: SerializableEdge.toNode\n7: SerializableNode.edges\n6: SerializableEdge.toNode\n5: SerializableNode.edges\n4: SerializableEdge.toNode\n3: SerializableNode.edges\n2: SerializableEdge.toNode\n1: SerializableNode.edges\n0: GraphAsset.nodes\n\nUnityEditor.InspectorWindow:RedrawFromNative()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれはつまり、こういうことです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/2025dfc08b616bfb0d8c69c72adf08594cc88f54/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f64313862616535312d366239382d333036612d343962382d6434383132656132353565352e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fd18bae51-6b98-306a-49b8-d4812ea255e5.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2dce5f0608611aa9053640893632ddf1\" alt=\"NodeEditor-16.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/d18bae51-6b98-306a-49b8-d4812ea255e5.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fd18bae51-6b98-306a-49b8-d4812ea255e5.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5cc6f6b3954d3180a319050bb83b3ef9 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eそう、ノードがシリアライズしようとするエッジが、さらにノードをシリアライズしようとして、循環が発生しているのです。\u003cbr\u003e\nシリアライズの仕組みとして、クラスの参照をそのまま保存することはできません。\u003c/p\u003e\n\n\u003cp\u003eでは、どうするかというと、ノードのIDを保存しておくことにします。\u003cbr\u003e\nUnityのGUIDみたいに大きなIDを振ってもいいのですが、振るのとか対応付けとかが面倒そうです。\u003cbr\u003e\nそこで、ここではGraphAssetが持っているノードリストの何番目にあるか、というのをIDとしようと思います。\u003c/p\u003e\n\n\u003cp\u003eSerializableEdgeだけ以下のように直します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphAsset.cs\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializable\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eSerializableEdge\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etoId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれでワーニングは出なくなります。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"43-アセットとエディタを対応付ける\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#43-%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%A8%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF%E3%82%92%E5%AF%BE%E5%BF%9C%E4%BB%98%E3%81%91%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.3 アセットとエディタを対応付ける\u003c/h3\u003e\n\n\u003cp\u003eどのアセットを表示・編集するかを決めるために、エディタにアセットの情報を持たせなければいけません。\u003cbr\u003e\n実際にエディタを使うときのことを考えると、アセットからエディタが開けて、その際にそのアセットについて編集するようにできたらいいですね。\u003c/p\u003e\n\n\u003cp\u003eというわけで要件としては、\u003cbr\u003e\n1. GraphAssetをダブルクリックするとエディタが開く\u003cbr\u003e\n2. どこかのGraphEditorElementクラスにGraphAssetクラスを渡す\u003cbr\u003e\nです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphAsset.cs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEditor.Callbacks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// OnOpenAssetアトリビュートのために追加\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGraphEditor\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eEditorWindow\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eMenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Window/GraphEditor\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eShowWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGraphEditor\u003c/span\u003e \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eShow\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etitleContent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eGUIContent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Graph Editor\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSelection\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eactiveObject\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eGraphAsset\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003egraphEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eOnOpenAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e()]\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// Unityで何らかのアセットを開いたときに呼ばれるコールバック\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnOpenAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003einstanceId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEditorUtility\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInstanceIDToObject\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einstanceId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eGraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 開いたアセットがGraphAssetかどうか\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eShowWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eGraphAsset\u003c/span\u003e \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// メンバ変数として持っておく\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGraphEditorElement\u003c/span\u003e \u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ShowWindow()を通らないような時（スクリプトのコンパイル後など）\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// のために初期化への導線を付ける\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 初期化はInitializeに任せる\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eInitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 初期化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eInitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphAsset\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 以下はもともとOnEnable() で行っていた処理\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// OnEnable() はCreateInstance\u0026lt;GraphEditor\u0026gt;() の際に呼ばれるので、まだgraphAssetが渡されていない\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 初期化でもgraphAssetを使うことになるのでここに移す\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで、GraphAssetファイルをダブルクリックしたときにエディタが開くようになります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/d252754946e7ac50328f326cb3263b09ceb1212f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f62303539653361392d353662642d326433632d646339312d3532333232623331343537662e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fb059e3a9-56bd-2d3c-dc91-52322b31457f.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=9cf0ca7803d5b3e2ddd1f03be038c9b4\" alt=\"NodeEditor-17.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/b059e3a9-56bd-2d3c-dc91-52322b31457f.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fb059e3a9-56bd-2d3c-dc91-52322b31457f.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6f5bf324dc7d1d4b0478e17dcb5e829e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"44-アセットのデータからノードを表示するようにする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#44-%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8B%E3%82%89%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.4 アセットのデータからノードを表示するようにする\u003c/h3\u003e\n\n\u003cp\u003e続いて、アセットにある情報からノードを構築、表示したいと思います。\u003cbr\u003e\nまずはGraphAssetにダミーの情報を手打ちします。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/e12c910f56524c1a638b98fc5545165da1d180fb/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f34366434303036352d306666342d396631372d383666362d6233326334333364666263302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F46d40065-0ff4-9f17-86f6-b32c433dfbc0.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b2e9dcb6162ca85bc0c4a59f3b947cd3\" alt=\"NodeEditor-18.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/46d40065-0ff4-9f17-86f6-b32c433dfbc0.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F46d40065-0ff4-9f17-86f6-b32c433dfbc0.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=7abc97be292d5498c4caee41cb399aa7 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n(100, 50)と(200, 50)の位置、つまり今まで表示してきた赤と黄色の位置、にノードが表示されればOKです。\u003c/p\u003e\n\n\u003cp\u003eまず、NodeElementを少し変えます。\u003cbr\u003e\n色の情報はアセットにはないので省きますし、位置はシリアライズされますからね。\u003c/p\u003e\n\n\u003cp\u003e具体的には、生成をSerializableNodeから行うようにします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElement.cs\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// BackgroundColorがなくなると見えなくなるので、周囲を枠線で囲んだVisualElement、Boxを継承する\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eBox\u003c/span\u003e  \n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eSerializableNode\u003c/span\u003e \u003cspan class=\"n\"\u003eserializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableNode\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 引数を変更\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eserializableNode\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// シリアライズ対象を保存しておく\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAbsolute\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// シリアライズされている位置を取る\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeDragger\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eGraphEditorElementも伴って変更します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElement.cs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGraphAsset\u003c/span\u003e \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 渡されたアセットを保存\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 作ったノードを入れておく。順序が重要\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphAsset\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eflexGrow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoverflow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eOverflow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHidden\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContextualMenuManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnContextMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 順番にノードを生成。この作る際の順番がSerializableEdgeが持つNodeのIDとなる\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eCreateNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableNode\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// GraphEditorElementの子として追加\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 順番を保持するためのリストに追加\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"cm\"\u003e/* ... 省略 */\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddNodeMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeventInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elocalMousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eCreateNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSerializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 追加生成時には仮で新しく作る\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eGraphEditorElementのコンストラクタにGraphAssetを渡すようにしたので、GraphEditorから生成するときに必要です\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eInitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphAsset\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erootVisualElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// アセットを渡す\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e以上で、アセットに保持された情報を描画することができました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f684ff8b8bf9222889eeed36df76371a3bfd15fc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32393938646637362d316438652d366564652d643437622d3664646162326632666631392e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2998df76-1d8e-6ede-d47b-6ddab2f2ff19.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ebcbb23e478b62e7fbb792ecd78645d5\" alt=\"NodeEditor-19.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/2998df76-1d8e-6ede-d47b-6ddab2f2ff19.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2998df76-1d8e-6ede-d47b-6ddab2f2ff19.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=2b65419c8fb84fa4c6340e4559fb5d51 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n書き込みはしていないので、当然開きなおすと追加したノードは消えてしまいます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"45-追加作成したノードをアセットに書き込む\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#45-%E8%BF%BD%E5%8A%A0%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.5 追加作成したノードをアセットに書き込む\u003c/h3\u003e\n\n\u003cp\u003e前節までできたら、あとはもう少し変えるだけです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddNodeMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeventInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elocalMousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSerializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// アセットに追加する\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eCreateNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれでアセットに書き込まれます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/a722b025d84e05aeb5b08cad30a137f6e5279412/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f36656539336462642d393265642d336533352d313063302d3031356664613337343763642e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F6ee93dbd-92ed-3e35-10c0-015fda3747cd.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=45141f17adbec2d0b77f518cf6c215c9\" alt=\"NodeEditor-20.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/6ee93dbd-92ed-3e35-10c0-015fda3747cd.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F6ee93dbd-92ed-3e35-10c0-015fda3747cd.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=be6fd4e99a416bf690f161b31b2c30c5 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nおっと、動かしたことを記録するのを忘れていました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeDraggerクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eCanStopManipulation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReleaseMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e//NodeElementに保存しておいたシリアライズ対象のポジションをいじる\u003c/span\u003e\n                \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003em_Focus\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e動かしてドラッグをやめた瞬間に記録するとよいと思います。\u003cbr\u003e\nこれで動かしたことも保存されるようになりました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/470474d6475bdf0c581d52ab3b78c6a2ca314cd0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f66646339383831632d633061332d386361372d396635662d6536333262626166393061372e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ffdc9881c-c0a3-8ca7-9f5f-e632bbaf90a7.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=44d1ee51318aa97acc579dfcb0edff05\" alt=\"NodeEditor-21.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/fdc9881c-c0a3-8ca7-9f5f-e632bbaf90a7.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ffdc9881c-c0a3-8ca7-9f5f-e632bbaf90a7.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=7854af3b79702d1bff7beb6feff92162 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"5-エッジを追加する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#5-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5. エッジを追加する\u003c/h2\u003e\n\n\u003cp\u003e頂点の表示ができたので、次は辺です。辺は頂点同士を線で結ぶことで表します。\u003cbr\u003e\nコンテナ的な仕組みでは直線や曲線は引けないように思うので、ここは既存の仕組みで線を引きます。\u003cbr\u003e\n\u003ccode\u003eHandles.Draw\u003c/code\u003e系の関数が一番楽かなと思います。\u003cbr\u003e\n\u003ccode\u003eDrawLine\u003c/code\u003eや\u003ccode\u003eDrawBezier\u003c/code\u003eなどです。\u003c/p\u003e\n\n\u003cp\u003eちなみにGraphViewでは、エッジ用のメッシュを作って、\u003ccode\u003eGraphics.DrawMeshNow()\u003c/code\u003eで描画をしていました。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"51-エッジを表示する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#51-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.1 エッジを表示する\u003c/h3\u003e\n\n\u003cp\u003eとりあえずダミーでデータを作ってみます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/07d2c2982ed941c93df0f40ca8e3597c23533e1d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f65386233316139352d643863392d626537662d353731662d6266356465346230343864302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fe8b31a95-d8c9-be7f-571f-bf5de4b048d0.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3c139f9575c1b5052c304709e99aa588\" alt=\"NodeEditor-22.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/e8b31a95-d8c9-be7f-571f-bf5de4b048d0.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fe8b31a95-d8c9-be7f-571f-bf5de4b048d0.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=194a708e2db3981085651e41d7329c0f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nElement0のEgesに要素を追加しました。\u003cbr\u003e\nこのまま表示するとこうなります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/7ed43511a5d4a06b8cc6d428db6717173dc8179f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f66323935346634312d646337652d333635662d613738382d3535656232323036633734612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ff2954f41-dc7e-365f-a788-55eb2206c74a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=4f92c8f2cb4396f067f5dc7dd5a63d3c\" alt=\"NodeEditor-23.PNG\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/f2954f41-dc7e-365f-a788-55eb2206c74a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Ff2954f41-dc7e-365f-a788-55eb2206c74a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6e7afa1c655e37e08b1a8a998dd41587 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nイメージとしては、左上のノードから右下のノードへ繋がっている矢印があればいいなと思います。\u003c/p\u003e\n\n\u003cp\u003eVisualElementは初期化字に一度呼べば後は自動で描画してくれていましたが、\u003ccode\u003eHandles\u003c/code\u003eで描画をするならウィンドウ更新のたびに呼ぶ必要があります。\u003cbr\u003e\nEditorWindowの更新といえば、\u003ccode\u003eOnGUI\u003c/code\u003eです。\u003cbr\u003e\nウィンドウの更新のたびに\u003ccode\u003eOnGUI\u003c/code\u003eが呼ばれますので、そこからGraphEditorElementの描画関数を呼ぶことにします。\u003c/p\u003e\n\n\u003cp\u003eひとまずこのように実装してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnGUI\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_GraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eedges\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003estartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1f\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etoId\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1f\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003estartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eHandles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eblue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 色指定\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// エッジをベジェ曲線で描画\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eHandles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDrawBezier\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e50f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003estartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e50f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eblue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etexture\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e2f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 矢印の三角形の描画\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003earrowAxis\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e10f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003earrowNorm\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCross\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eforward\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eHandles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDrawAAConvexPolygon\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003earrowAxis\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003earrowNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003earrowAxis\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003earrowNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eHandles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewhite\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 色指定をデフォルトに戻す\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのようになりました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/3e1d8000645e34e486426ca88ed1ca0e7303bf1e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f64383063343734392d326230302d343936622d333238372d6534323138323032383830372e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fd80c4749-2b00-496b-3287-e42182028807.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c54d9d477a766a1dbfa52e0ff9418c3b\" alt=\"NodeEditor-24.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/d80c4749-2b00-496b-3287-e42182028807.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fd80c4749-2b00-496b-3287-e42182028807.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=34df7c603ca889ad58e5abaa655de773 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eポジションとして単に\u003ccode\u003eVisualElement.transform.position\u003c/code\u003eを利用しているので左上隅に始点・終点が来ています。\u003cbr\u003e\n元ノードは下辺中央から、先ノードの上辺中央につながってほしい気がします。\u003cbr\u003e\nとはいえ、GraphEditorElementでNodeの形に関する部分を決め打ちで呼んでしまうのはちょっと気持ち悪いので、NodeElementに始点や終点の位置・方向の情報を返す関数を作ろうと思います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eedges\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// ノードに情報を問い合わせる\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003estartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etoId\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEndPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etoId\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEndNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetStartPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eheight\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetEndPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e2f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetStartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetEndNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eちゃんとそれらしい位置から生えました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/2056979925a60b04b1eb19c1bf020be796b38821/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f65313665646434302d366337382d653663652d343637342d3962313663386132396135342e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fe16edd40-6c78-e6ce-4674-9b16c8a29a54.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=4c0a794f6a5a70a6b6b1a67daef65d7f\" alt=\"NodeEditor-25.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/e16edd40-6c78-e6ce-4674-9b16c8a29a54.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Fe16edd40-6c78-e6ce-4674-9b16c8a29a54.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=dc94fb84a6c14453e64f5835ed6a9575 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eまた、エッジを描画するだけなら、エッジのVisualElementを作らずにGraphAssetに保存されているSerializableEdgeの値を見ていればよいのですが、エッジの追加・削除・付け替えなど、いずれ必要になるであろう操作がやりにくくなります。\u003c/p\u003e\n\n\u003cp\u003eそこで、エッジにもEdgeElementクラスを作ります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// EdgeElement.cs\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEditor\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eEdgeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eVisualElement\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eSerializableEdge\u003c/span\u003e \u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// データを持っておく\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 元ノード\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 先ノード\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableEdge\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003estartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEndPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEndNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// GraphEditorElementからそのまま移した\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003estartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eHandles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eblue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eHandles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDrawBezier\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e50f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003estartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e50f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecolor\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eblue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etexture\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e2f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003earrowAxis\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e10f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003earrowNorm\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCross\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eforward\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eHandles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDrawAAConvexPolygon\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003earrowAxis\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003earrowNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003earrowAxis\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003earrowNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eHandles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecolor\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eColor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewhite\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのクラスもノードと同様に、GraphEditorElementが生成し、GraphEditorElementの子として保持することにします。\u003cbr\u003e\nノードが持っていて、ノードの子として生成というのも考えましたが、GraphEditorで一元管理した方が構造が単純になりそうだと思ったのが理由です。\u003c/p\u003e\n\n\u003cp\u003e実装はこうです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// エッジもノードと同じくまとめて保持しておく\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphAsset\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eflexGrow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoverflow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eOverflow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHidden\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContextualMenuManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnContextMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003egraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eCreateNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// すべてのノードの生成が終わってからエッジの生成を行う\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// エッジが持っているノードIDからノードを取得するため\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eedges\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eCreateEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// エッジの生成\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableEdge\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003enodeElements\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enodeElements\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etoId\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// GraphEditor.OnGUI() 内で呼ばれる。描画処理をエッジに移したので小さくなった\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e見た目は先ほどと変わりません。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"52-エッジを追加できるようにする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#52-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.2 エッジを追加できるようにする\u003c/h3\u003e\n\n\u003cp\u003eあるノードからあるノードにエッジをつけようと思う時、元ノードから先ノードへ線を伸ばしていくようなイメージになると思います。\u003c/p\u003e\n\n\u003cp\u003eUnityのGraphViewやUnrealEngineのBluePrintではノードに備わった接続用のポートをクリックしてそのままドラッグすると線が引かれていきます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/46c52772223d1bb8507205831e4aacb9476b2db0/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f37636130613964632d626435652d653638352d613336332d3664303238363131353235362e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F7ca0a9dc-bd5e-e685-a363-6d0286115256.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=6376c522b9b82e2261ae49a398bc68f4\" alt=\"NodeEditor-26.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/7ca0a9dc-bd5e-e685-a363-6d0286115256.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F7ca0a9dc-bd5e-e685-a363-6d0286115256.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5eea30fea72bab3ce30034b16ba79839 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eUnrealEngineのBehaviourTreeでは、ノードの上下にエッジ接続領域があります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/dce88df7e59c58f3a426d0641b72145aee259a85/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f34613439336463382d633834392d343431612d623837342d3534333761633062663230342e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F4a493dc8-c849-441a-b874-5437ac0bf204.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=1fb0ff67c921d5424d5397ad58a40b53\" alt=\"NodeEditor-27.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/4a493dc8-c849-441a-b874-5437ac0bf204.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F4a493dc8-c849-441a-b874-5437ac0bf204.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=72b2af412e98b9db887d10091e18a02d 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれらのようなポートや接続領域などはあると便利そうですが、いったんメニューにAdd Edgeを追加するので良いでしょう。\u003cbr\u003e\n重要なのは、追加中に元ノードからエッジがマウスの位置を追従していることです。\u003cbr\u003e\nこのUIによって、現在エッジ追加操作中であることと、つなげるノードを指定する方法が直感的にわかります。\u003cbr\u003e\nこれは実装したいです。\u003c/p\u003e\n\n\u003cp\u003e挙動としては、\u003cbr\u003e\n1. ノードを右クリックする\u003cbr\u003e\n2. メニューから「Add Edge」を選択する\u003cbr\u003e\n3. 元ノードからマウスの位置に向かうエッジ候補ができる\u003cbr\u003e\n4. 他のノードを左クリックして、エッジの向かい先を確定する\u003c/p\u003e\n\n\u003cp\u003eを想定します。\u003cbr\u003e\nノードに対する操作なので、ノードに\u003ccode\u003eManipulator\u003c/code\u003eを追加します。\u003cbr\u003e\nエッジをつなぐ操作なので、EdgeConnectorクラスとします。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"521-edgeconnectorクラスを作る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#521-edgeconnector%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.2.1 EdgeConnectorクラスを作る\u003c/h4\u003e\n\n\u003cp\u003eEdgeConnectorの役割はメニューを出してエッジ追加モードに入ることと、そのあとに別のノードをクリックして実際にノードを接続することの二つあります。\u003cbr\u003e\nその中でメニューを出す部分は\u003ccode\u003eContexturalMenuManipulator\u003c/code\u003eの役割ですので、EdgeConnectorクラスの中で\u003ccode\u003eContexturalMenuManipulator\u003c/code\u003eを作成し、それをEdgeConnectorのターゲットノードに\u003ccode\u003eAddManipulator\u003c/code\u003eしようと思います。\u003c/p\u003e\n\n\u003cp\u003eこうすることで、NodeElementにEdgeConnectorを追加するだけで、エッジ追加の処理をすべてEdgeConnectorクラスに投げることができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableNode\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"cm\"\u003e/* ... 省略 */\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeDragger\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeConnector\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 追加\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eそして、EdgeConnectorの内部はひとまずこのようにしておきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine.UIElements\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eEdgeConnector\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseManipulator\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003em_Active\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eContextualMenuManipulator\u003c/span\u003e \u003cspan class=\"n\"\u003em_AddEdgeMenu\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeConnector\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ノードの接続は左クリックで行う\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eactivators\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eManipulatorActivationFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003ebutton\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMouseButton\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLeftMouse\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_Active\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// メニュー選択マニピュレータは作っておくが、この時点ではターゲットが確定していないので、\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// RegisterCallbacksOnTarget()で追加する\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_AddEdgeMenu\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContextualMenuManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnContextualMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnContextualMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContextualMenuPopulateEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// エッジ追加中に右クリックを押されたときのために、ノードの上かどうかを見る\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContainsPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWorldToLocal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// イベントを即座に中断\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStopImmediatePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emenu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"s\"\u003e\"Add Edge\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003em_Active\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Add Edge\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ここでエッジ追加モード開始処理を書く\u003c/span\u003e\n\n                    \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCaptureMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlwaysEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegisterCallbacksOnTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseDownEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseMoveEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseMove\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseCaptureOutEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnCaptureOut\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_AddEdgeMenu\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnregisterCallbacksFromTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_AddEdgeMenu\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnregisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseDownEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnregisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnregisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseMoveEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnMouseMove\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnregisterCallback\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseCaptureOutEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnCaptureOut\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseDown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseDownEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"nf\"\u003eCanStartManipulation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// マウス押下では他のイベントが起きてほしくないのでPropagationを中断する\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_Active\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStopImmediatePropagation\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"nf\"\u003eCanStopManipulation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003em_Active\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Try Connect\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ここでマウスの下にあるノードにエッジを接続しようとする\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_Active\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReleaseMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseMove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseMoveEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003em_Active\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"move\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ここで、追加中のエッジの再描画を行う\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnCaptureOut\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseCaptureOutEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003em_Active\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_Active\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReleaseMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこの時点では、以下のような挙動になります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/14da1df71ddd669707710cb07b7749ec6ff565ad/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f37313730303138612d646136372d613933382d303466632d3663383536666230623530302e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F7170018a-da67-a938-04fc-6c856fb0b500.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=3e95fc3834db3c75dd48991fabb4f320\" alt=\"NodeEditor-28.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/7170018a-da67-a938-04fc-6c856fb0b500.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F7170018a-da67-a938-04fc-6c856fb0b500.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=adc4349fbeac6a51bd44601fce1c5650 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"522-エッジ追加のためにエッジグラフクラスを整備\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#522-%E3%82%A8%E3%83%83%E3%82%B8%E8%BF%BD%E5%8A%A0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AB%E3%82%A8%E3%83%83%E3%82%B8%E3%82%B0%E3%83%A9%E3%83%95%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%95%B4%E5%82%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.2.2 エッジ追加のためにエッジ・グラフクラスを整備\u003c/h4\u003e\n\n\u003cp\u003e次に、EdgeElementクラスに追加中のEdgeを作成するための準備をします。\u003cbr\u003e\nこれまではEdgeには元ノードと先ノードを渡して作成していましたが、追加中には先ノード確定していないので、元ノードと矢印の位置からエッジを描画できるようにします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// EdgeElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003em_ToPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003eToPosition\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003em_ToPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eset\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 2020/01/09 追記：GraphEditorElementの座標系で渡されることを想定するように変更\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// m_ToPosition = this.WorldToLocal(value);  // ワールド座標で渡されることを想定\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//  ↓↓ 変更\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToPosition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWorldToLocal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 2020/01/09 追記ここまで\u003c/span\u003e\n\n            \u003cspan class=\"nf\"\u003eMarkDirtyRepaint\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 再描画をリクエスト\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e  \n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 新しいコンストラクタ\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003etoPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eToPosition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etoPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// つなげるときに呼ぶ\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eConnectTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eMarkDirtyRepaint\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 再描画をリクエスト\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003estartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEndPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEndNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 追加中の描画用\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003estartPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003estartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eendPos\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eToPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eendNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ezero\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれにより、追加中のEdgeElementをGraphEditorElementのEdgesに追加すれば自動的に描画されるようになったはずです。\u003cbr\u003e\nということで、GraphEditorElementにエッジ追加リクエストを投げられるようにします。\u003cbr\u003e\nついでに、ノード追加を中断したときのためにエッジ削除関数も作っておきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e \u003cspan class=\"nf\"\u003eCreateEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003etoPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etoPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRemoveEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eRemove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"523-エッジ追加の挙動を実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#523-%E3%82%A8%E3%83%83%E3%82%B8%E8%BF%BD%E5%8A%A0%E3%81%AE%E6%8C%99%E5%8B%95%E3%82%92%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.2.3 エッジ追加の挙動を実装\u003c/h4\u003e\n\n\u003cp\u003e上で作った関数をEdgeConnectorクラスから呼びます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// EdgeConnectorクラス\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eGraphEditorElement\u003c/span\u003e \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e \u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnContextualMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContextualMenuPopulateEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emenu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"s\"\u003e\"Add Edge\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003em_Active\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e// 親をたどってGraphEditorElementを取得する\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetFirstAncestorOfType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeventInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCaptureMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlwaysEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"cm\"\u003e/* ... 省略 */\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"nf\"\u003eCanStopManipulation\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003em_Active\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetDesignatedNode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoriginalMousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 背景をクリックしたとき\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 自分自身をクリックしたとき\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContainsEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// すでにつながっているノード同士をつなげようとしたとき\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConnectTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Active\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 接続終了\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReleaseMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseMove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseMoveEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003em_Active\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 2020/01/09 追記：Worldの座標系からGraphEditorElementの座標系に変換して渡すことにする\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//                 この例でいうと、ウィンドウの上のタブ領域の分だけずれることになる\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// m_ConnectingEdge.ToPosition = evt.originalMousePosition;  // 位置更新\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//  ↓↓ 変更\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eToPosition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWorldToLocal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 位置更新\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 2020/01/09 追記ここまで\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnCaptureOut\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseCaptureOutEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003em_Active\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 中断時の処理\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003em_Active\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReleaseMouse\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// マウスの位置にあるノードを返す\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetDesignatedNode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContainsPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWorldToLocal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// すでに同じエッジがあるかどうか\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eContainsEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExists\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003efrom\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここまでで、このような挙動になります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/1273a7c78b1a313975458c4ff831560eaa182cdf/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f36666539383733612d316364632d313232322d323565372d6338326561666464353430362e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F6fe9873a-1cdc-1222-25e7-c82eafdd5406.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=878709c3b987076cde6e6e13084c2ab2\" alt=\"NodeEditor-29.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/6fe9873a-1cdc-1222-25e7-c82eafdd5406.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F6fe9873a-1cdc-1222-25e7-c82eafdd5406.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=755ef04af8151729c5af91435924a7d9 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"524-追加したエッジをシリアライズする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#524-%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.2.4 追加したエッジをシリアライズする\u003c/h4\u003e\n\n\u003cp\u003e今のままではEdgeElementを追加しただけなので、つないだエッジはデータとして残っていません。\u003cbr\u003e\nノードのときと同じようにシリアライズする必要があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// EdgeConnectorクラス\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnMouseUp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMouseUpEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"cm\"\u003e/* ... 省略 */\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetDesignatedNode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoriginalMousePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContainsEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConnectTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em_Graph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSerializeEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em_ConnectingEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// つないだ時にシリアライズする\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"cm\"\u003e/* ... 省略 */\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eSerializeEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSerializableEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etoId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIndexOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ここで先ノードのIDを数える\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eedges\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 実際に追加\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// EdgeElementに登録しておく\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eそして、実際に開きなおしてみると、\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/9edb9902f4f74f6d1a4d5379b25cec8ac6bf4838/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f38363066623865312d393331632d643734632d373231332d6432613434646663656238342e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F860fb8e1-931c-d74c-7213-d2a44dfceb84.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=1b7bff3cf3e58b790d6f86acd590629c\" alt=\"NodeEditor-30.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/860fb8e1-931c-d74c-7213-d2a44dfceb84.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F860fb8e1-931c-d74c-7213-d2a44dfceb84.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=afda7ffaa835aabeebf207672553cdd5 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e保存されています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"53-エッジを削除できるようにする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#53-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E5%89%8A%E9%99%A4%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.3 エッジを削除できるようにする\u003c/h3\u003e\n\n\u003cp\u003eエッジの追加ができるようになったので、やはり削除もできなければいけません。\u003c/p\u003e\n\n\u003cp\u003eノードを削除するときと同様に、エッジの削除もコンテキストメニューから行いたいと思います。\u003cbr\u003e\nしかし、このとき問題があります。\u003cbr\u003e\nノードは大きさのある\u003ccode\u003eVisualElement\u003c/code\u003eだったため、\u003ccode\u003eContextualManipulator\u003c/code\u003eを付けるとそのままクリックで選択ができました。\u003cbr\u003e\nしかし、エッジの\u003ccode\u003eVisualElement\u003c/code\u003eは大きさがありません。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"531-エッジを選択できるようにする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#531-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E9%81%B8%E6%8A%9E%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.3.1 エッジを選択できるようにする\u003c/h4\u003e\n\n\u003cp\u003e\u003ccode\u003eVisualElement\u003c/code\u003eをクリックして選択するときの挙動について、\u003ca href=\"https://docs.unity3d.com/2019.1/Documentation/Manual/UIE-Events-Dispatching.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eドキュメント\u003c/a\u003eに記載がありました。\u003cbr\u003e\nEvent targetのPicking mode and custom shapesの項です。\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eYou can override the \u003ccode\u003eVisualElement.ContainsPoint()\u003c/code\u003e method to perform custom intersection logic.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eこの\u003ccode\u003eVisualElement.ContainsPoint()\u003c/code\u003eは、マウス座標を与えると、その座標と自分が衝突しているかを判定する関数です。\u003cbr\u003e\nそれをオーバーライドして、独自の衝突判定を埋め込むことで、\u003ccode\u003eVisualElement\u003c/code\u003eの\u003ccode\u003eRect\u003c/code\u003e以外の形に対応させることができます。\u003c/p\u003e\n\n\u003cp\u003e実際にベジェ曲線と点との距離を計算するのは面倒なので、近似した線分との距離を計算して、指定距離以内だったら選択したことにしようと思います。\u003c/p\u003e\n\n\u003cp\u003eさて、衝突を判定の実装に当たって、ログを出すものが必要です\u003cbr\u003e\nというわけで最初に、エッジに削除用のコンテキストメニューを作ります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// EdgeElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 削除用マニピュレータの追加\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 2020/01/09 追記：マウスのイベントを呼ばれるためにはVisualElementのRectがマウス座標を含む必要がある\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//                 よって、エッジも大きさを持つため、自由な位置を取れるようにPosition.Absoluteを指定する\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePosition\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAbsolute\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 2020/01/09 追記ここまで\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContextualMenuManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emenu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"s\"\u003e\"Remove Edge\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Remove Edge\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlwaysEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003etoPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 上のコンストラクタを呼ぶ\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eToPosition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etoPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableEdge\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003etoNode\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 上のコンストラクタを呼ぶ\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efromNode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etoNode\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまず、接続元と接続先が収まるバウンディングボックスと衝突しているかどうかを判定してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// EdgeElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 2020/01/09 追記：バウンディングボックスの取得を別関数に分ける\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//                 また、幅が狭くなりすぎないように少し大きめに取ることにする\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//                 その大きさをDrawEdgeのタイミングで適用することにする\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eRect\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBoundingBox\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003estart\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEndPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003erectPos\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e12f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e12f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003erectSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAbs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e24f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAbs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e24f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRect\u003c/span\u003e \u003cspan class=\"n\"\u003ebound\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erectPos\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erectSize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebound\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 2020/01/09 追記\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdateLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRect\u003c/span\u003e \u003cspan class=\"n\"\u003ebound\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetBoundingBox\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// レイアウトをバウンディングボックスに合わせて調整\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eleft\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebound\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etop\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebound\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eright\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNaN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebottom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNaN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebound\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebound\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eheight\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 2020/01/09 追記\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eUpdateLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 見た目とずれることがないよう、ここでLayoutを修正する\u003c/span\u003e\n\n            \u003cspan class=\"nf\"\u003eDrawEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"cm\"\u003e/* ... 省略 */\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"cm\"\u003e/* ... 省略 */\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 2020/01/09 追記ここまで\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eContainsPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003elocalPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 2020/01/09 追記：EdgeElementのレイアウトに大きさを持たせたことにより\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//                 base.ContainsPoint()がバウンディングボックスを見る処理として利用できるようになった\u003c/span\u003e\n\n        \u003cspan class=\"cm\"\u003e/*\n        Vector2 start = From.GetStartPosition();\n        Vector2 end = To.GetEndPosition();\n\n        // ノードを覆うRectを作成\n        Vector2 rectPos = new Vector2(Mathf.Min(start.x, end.x), Mathf.Min(start.y, end.y));\n        Vector2 rectSize = new Vector2(Mathf.Abs(start.x - end.x), Mathf.Abs(start.y - end.y));\n        Rect bound = new Rect(rectPos, rectSize);\n\n        if (!bound.Contains(localPoint))\n        {\n            return false;\n        }\n        */\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//  ↓↓ 変更\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContainsPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elocalPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e結果はこうなりました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/0b03a0a4371145c20e43ca92e6c2c53a77e95b7f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f65656332363233652d303965302d656533632d386662332d3561623866626163393562612e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Feec2623e-09e0-ee3c-8fb3-5ab8fbac95ba.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=58075ab0f9901e7fccad518652e0ce93\" alt=\"NodeEditor-31.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/eec2623e-09e0-ee3c-8fb3-5ab8fbac95ba.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2Feec2623e-09e0-ee3c-8fb3-5ab8fbac95ba.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=068b086427f8c07ddf665cf639faeb28 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n確かに、エッジのバウンディングボックスとの当たりを判定できていそうです。\u003c/p\u003e\n\n\u003cp\u003e次に、近似線分との距離を計算してみます。\u003cbr\u003e\n先にバウンディングボックスに入っていないものを弾いているので、端点が一番近い場合などを考えなくて済みます。\u003cbr\u003e\nつまり、線分ではなく直線と点の距離を考えればよいということです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// EdgeElementクラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eINTERCEPT_WIDHT\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e15f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// エッジと当たる距離\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eContainsPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003elocalPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"cm\"\u003e/* ... 省略 */\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"k\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elocalPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 2020/01/09 追記：localPointはEdgeElementの座標系で与えられる\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//                 それをGraphEditorElementの座標系に合わせる必要がある\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elocalPoint\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eChangeCoordinatesTo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparent\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elocalPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 2020/01/09 追記ここまで\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 近似線分ab\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e12f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetStartNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEndPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e12f\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eTo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEndNorm\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 一致した場合はaからの距離\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDistance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elocalPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eINTERCEPT_WIDHT\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 直線abとlocalPointの距離\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edistance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAbs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elocalPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003elocalPoint\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eVector2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDistance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003edistance\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eINTERCEPT_WIDHT\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e結果はこうなりました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/691484c5b30442b000f58240440615a093f201b6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32363433623334302d383032332d316566342d383932382d6634316235383437636130372e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2643b340-8023-1ef4-8928-f41b5847ca07.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=8ca29aab27bbb7d72621ad0a60661edb\" alt=\"NodeEditor-32.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/2643b340-8023-1ef4-8928-f41b5847ca07.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F2643b340-8023-1ef4-8928-f41b5847ca07.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=9648ef6dc391274121afc46ac4997bdc 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n...ちょっとずれている気もしますが、まあ、許容範囲でしょう。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"532-エッジデータを削除する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#532-%E3%82%A8%E3%83%83%E3%82%B8%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.3.2 エッジデータを削除する\u003c/h4\u003e\n\n\u003cp\u003eGraphAssetからエッジのデータを消します。\u003cbr\u003e\nEdgeElementには元ノードの情報が既にありますので、そこから自分のデータが入っているSerializableNodeを取得することができます。\u003cbr\u003e\nこれを消せばよいですね。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// EdgeElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContextualMenuManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emenu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"s\"\u003e\"Remove Edge\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuItem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// 親をたどってGraphEditorElementに削除リクエストを送る\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003egraph\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGetFirstAncestorOfType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003egraph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlwaysEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRemoveEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEdgeElement\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 消すエッジにSerializableEdgeがあれば、それを消す\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eedges\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eRemove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/5dd271f95218a50a2593f476a1f364fe4a89b38b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f38393933633330332d386337372d353861372d313831622d6262353032633532343732312e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8993c303-8c77-58a7-181b-bb502c524721.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b8d3d38c61df4ece5c48ed9932e9aebf\" alt=\"NodeEditor-33.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/8993c303-8c77-58a7-181b-bb502c524721.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F8993c303-8c77-58a7-181b-bb502c524721.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=3fa1f951713d2ac45b51f440bce93212 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e無事、削除できています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"6-ノードを削除する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#6-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e6. ノードを削除する\u003c/h2\u003e\n\n\u003cp\u003e最後に、ノードを削除できるようにしたいと思います。\u003cbr\u003e\nノードを削除したときには、\u003cbr\u003e\n- NodeElementを削除する\u003cbr\u003e\n- 対応するSerializableNodeを削除する\u003cbr\u003e\n- そのノードとつながるEdgeElementを削除する\u003cbr\u003e\n- 対応するSerializableEdgeを削除する\u003cbr\u003e\n- 他ノードのIDが変わるので、それに応じてSerializableEdgeのIDを振りなおす\u003c/p\u003e\n\n\u003cp\u003eのすべてを行う必要があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// NodeElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializableNode\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"cm\"\u003e/* ... 省略 */\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNodeDragger\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eEdgeConnector\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eContextualMenuManipulator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOnContextualMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 削除用マニピュレータ\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnContextualMenuPopulate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContextualMenuPopulateEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emenu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"s\"\u003e\"Remove Node\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eRemoveNodeMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAlwaysEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRemoveNodeMenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDropdownMenuAction\u003c/span\u003e \u003cspan class=\"n\"\u003emenuAction\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 親をたどって削除をリクエスト\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003egraph\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGetFirstAncestorOfType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGraphEditorElement\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egraph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoveNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// GraphEditorElementクラス\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRemoveNodeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeElement\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_GraphAsset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableNode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// アセットから削除\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIndexOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// エッジの削除とID変更\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// m_Edgesに変更が伴うため、降順で行う\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e--)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003em_Edges\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eedge\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eserializableEdge\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 削除されるノードにつながるエッジを削除\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTo\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrom\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"nf\"\u003eRemoveEdgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedgeElement\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 変更が生じるIDを持つエッジに対して、IDに修正を加える\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etoId\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eedge\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etoId\u003c/span\u003e\u003cspan class=\"p\"\u003e--;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"nf\"\u003eRemove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// VisualElementの子としてのノードを削除\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em_Nodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 順序を保持するためのリストから削除\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれでノードを削除できるようになりました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/791ea7e65956dc8772fe30bbbf378b500050c8f2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32323765616437632d393264622d316563362d636338642d6364316239373837616338312e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F227ead7c-92db-1ec6-cc8d-cd1b9787ac81.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=938adf4dd011e9b7ddf455863329f2b2\" alt=\"NodeEditor-35.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/227ead7c-92db-1ec6-cc8d-cd1b9787ac81.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F227ead7c-92db-1ec6-cc8d-cd1b9787ac81.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=3628a2cacb757a5f527d82d70cdf692c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eウィンドウを開きなおしてもちゃんと構造が保存されています。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結果\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/281875bc4df480afa97dcfc5b06320159d211439/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3138393738362f32356230643735332d333636312d623439302d373131332d3565316630393863376139612e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F25b0d753-3661-b490-7113-5e1f098c7a9a.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=9d52a9118d199eb96962ec01c36b25ef\" alt=\"NodeEditor-36.gif\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/189786/25b0d753-3661-b490-7113-5e1f098c7a9a.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F189786%2F25b0d753-3661-b490-7113-5e1f098c7a9a.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e5105bdb6a38973426b4cf0f30ea80c2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nゼロからノードベースエディタを作りました。\u003cbr\u003e\n現状ではグラフ構造を保存するアセットを作れるだけですが、このノード部分に何か情報を載せると立派なヴィジュアルツールが出来上がります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おわりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおわりに\u003c/h1\u003e\n\n\u003cp\u003eUIElementの使い方を勉強したいと思ったので、ノードベースエディタを作ってみました。\u003cbr\u003e\nドキュメントとリファレンスを読み込むことになり、GraphViewの実装もかなり追ったので勉強になってよかったです。\u003cbr\u003e\n実をいうと、このGraphEditorを使ってBehaviorTreeを作るところまでやりたかったのですが、エディタを作るだけで相当の時間がかかってしまったので、この記事はここまでにしておきます。\u003c/p\u003e\n\n\u003cp\u003eまた、ゼロから作るを銘打って、実装する手順通りに事細かく書いてしまったので、やたら長くなってしまいました。\u003cbr\u003e\nとはいえ、エディタを作るにあたって得た知見をふんだんに盛り込めたのではないかと思います。\u003c/p\u003e\n\n\u003cp\u003eここはもっとこうした方がよい、のような意見があればコメントで教えていただけるとありがたいです。\u003cbr\u003e\nご拝読ありがとうございました。\u003c/p\u003e\n","createdAt":"2019-12-21T09:45:25Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"O52Bmj8nf6eeACxq9g2QJj6yHWDb8X5L1A==--w8/jtDAgOV1MN7v6--aIvakaUkJ+/SYEdWTHg25A==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-01-08T15:07:36Z","likesCount":64,"linkUrl":"https://qiita.com/saragai/items/f7f88df863091946c9d1","organization":null,"originalId":1118865,"stockedCount":48,"title":"【Unity】ゼロから作るノードベースエディター【UIElements】","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A6%82%E8%A6%81\"\u003e概要\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%83%8C%E6%99%AF\"\u003e背景\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#0-%E6%8C%A8%E6%8B%B6\"\u003e0. 挨拶\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#1-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\"\u003e1. ノードを表示する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#11-%E8%A1%A8%E7%A4%BA%E5%A0%B4%E6%89%80%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B\"\u003e1.1 表示場所を指定する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#12-%E5%A4%A7%E3%81%8D%E3%81%95%E3%82%92%E6%8C%87%E5%AE%9A%E3%81%99%E3%82%8B\"\u003e1.2 大きさを指定する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99\"\u003e2. ノードを動かす\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#21-%E3%81%BE%E3%81%9A%E3%81%AF%E8%A9%A6%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e2.1 まずは試してみる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#22-visualelement%E3%81%AE%E8%A1%A8%E7%A4%BA%E9%A0%86%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B\"\u003e2.2 VisualElementの表示順を変える\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#23-%E3%83%9E%E3%82%A6%E3%82%B9%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E3%81%99%E3%82%8B\"\u003e2.3 マウスイベントをキャプチャする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#24-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92manipulator%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E5%88%86%E9%9B%A2%E3%81%99%E3%82%8B\"\u003e2.4 ノードを動かすコードをManipulatorによって分離する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003e3. ノードを追加する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#31-%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\"\u003e3.1 メニューを表示する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#32-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E7%94%9F%E6%88%90%E3%81%99%E3%82%8B\"\u003e3.2 ノードを生成する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E6%B0%B8%E7%B6%9A%E5%8C%96%E3%81%99%E3%82%8B\"\u003e4. ノードを永続化する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#41-%E3%82%B0%E3%83%A9%E3%83%95%E6%A7%8B%E9%80%A0%E3%81%A8%E3%81%AF\"\u003e4.1 グラフ構造とは\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#42-%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E7%94%A8%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E3%82%8B\"\u003e4.2 シリアライズ用のクラスを作る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#43-%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%A8%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF%E3%82%92%E5%AF%BE%E5%BF%9C%E4%BB%98%E3%81%91%E3%82%8B\"\u003e4.3 アセットとエディタを対応付ける\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#44-%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8B%E3%82%89%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e4.4 アセットのデータからノードを表示するようにする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#45-%E8%BF%BD%E5%8A%A0%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80\"\u003e4.5 追加作成したノードをアセットに書き込む\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#5-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003e5. エッジを追加する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#51-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B\"\u003e5.1 エッジを表示する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#52-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e5.2 エッジを追加できるようにする\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#521-edgeconnector%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E3%82%8B\"\u003e5.2.1 EdgeConnectorクラスを作る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#522-%E3%82%A8%E3%83%83%E3%82%B8%E8%BF%BD%E5%8A%A0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AB%E3%82%A8%E3%83%83%E3%82%B8%E3%82%B0%E3%83%A9%E3%83%95%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%95%B4%E5%82%99\"\u003e5.2.2 エッジ追加のためにエッジ・グラフクラスを整備\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#523-%E3%82%A8%E3%83%83%E3%82%B8%E8%BF%BD%E5%8A%A0%E3%81%AE%E6%8C%99%E5%8B%95%E3%82%92%E5%AE%9F%E8%A3%85\"\u003e5.2.3 エッジ追加の挙動を実装\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#524-%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%A9%E3%82%A4%E3%82%BA%E3%81%99%E3%82%8B\"\u003e5.2.4 追加したエッジをシリアライズする\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#53-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E5%89%8A%E9%99%A4%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e5.3 エッジを削除できるようにする\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#531-%E3%82%A8%E3%83%83%E3%82%B8%E3%82%92%E9%81%B8%E6%8A%9E%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e5.3.1 エッジを選択できるようにする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#532-%E3%82%A8%E3%83%83%E3%82%B8%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B\"\u003e5.3.2 エッジデータを削除する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#6-%E3%83%8E%E3%83%BC%E3%83%89%E3%82%92%E5%89%8A%E9%99%A4%E3%81%99%E3%82%8B\"\u003e6. ノードを削除する\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E6%9E%9C\"\u003e結果\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003eおわりに\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":8082,"uuid":"f7f88df863091946c9d1","banReason":null,"adventCalendarItem":{"day":17,"calendar":{"name":"Unity #2","urlName":"unity2","year":2019,"organization":null}},"author":{"encryptedId":"d4meV+O/OrCZmiL4L++vk0fomWwa--WD0EFLLXSSUg8zlZ--vOW666/GMGMoTXA4OepGOQ==","originalId":189786,"description":"都内にいます","facebookUrl":null,"githubUrl":"https://github.com/saragai","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/189786/profile-images/1498789786","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F189786%2Fprofile-images%2F1498789786?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=0cfdead3041bcb8dcce7e955748cad5d","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F189786%2Fprofile-images%2F1498789786?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9d1f06bc9a3b7a50e5f15d582ddd20a9","urlName":"saragai","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"},{"name":"UnityEditor","urlName":"unityeditor"},{"name":"UIElements","urlName":"uielements"},{"name":"GraphView","urlName":"graphview"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
