More than 1 year has passed since last update.はじめまして，Nわかです。
初めての投稿でもあるので、軽く自己紹介。
現在起業した友人のもとでUnityエンジニアとして，大学に通いつつ働かせてもらっています。
現在1つのスマホ向けカジュアルゲーム制作を任されています。リモートでOKとのことで，ほぼ家や授業の合間などに作業させてもらっています。ホンマありがたいです。その担当したゲームの機能の一つに「オフライン報酬」というものがあります。これはゲームをプレイしていなくても，ゲーム内コインがゲームをやっていなかった時間分貰えるもらえるというものです。
ソシャゲの時間経過で回復する体力（ゲームプレイ時に消費）などが近しい機能でしょう。この機能を実装するにあたって，結構ググりましたが，直接的な記事は見当たりませんでした。
自分用の備忘録として，そして似たような機能を実装する方の助けに少しでもなれればと思います。今回実装するにあたり，決められていた仕様をざっくりと。本当にざっくりと、ですが。それでは実際に実装していくわけですが，やることとして大まかに2つ項目があります。サーバーとのやり取りをしないとのことなので，ローカルで時間を取得して前回の時間との差分を出して報酬を計算してあげる必要があります。DateTime.UtcNowで現在のUTC時刻を取得可能。Save();では，今回の機能に関係あるものでは_endTimeのみ保存しています。また，記載していませんが，ゲーム開始時に_endTimeを読み込んでいます。
1分あたりの報酬なので，今回は60で割っています。ちなみにCalcSecond()は以下の通り。DateTimeでのUTC時刻の差分を出し，トータル秒数を返却するメソッドです。これで_earnOfflineにオフライン報酬が代入されている状態になったので，これを全体の稼ぎを示すメンバにでも加算してあげればよいでしょう。アプリ起動時だけでなく，他のアプリから戻ってきた際にもポップアップ表示をしてあげないといけないので，アプリから離れたことを検知してあげる必要があります。UnityのMonoBehaviourには以下のようなメソッドが用意されています。
OnApplicationPause(bool pauseStatus)
これはアプリが他のアプリに移ったりホーム画面に戻ったりすることによって一時中断されたときや，逆にアプリケーションに戻ってきた際に呼ばれるものです。
つまり，pauseStatusがfalseの際は戻ってきたということになるので，ここにオフライン報酬の処理を記述してあげれば良さそうです。
ここで1つ注意すべき点としては，GoogleのAdMobを導入している際です。リワード広告を表示するとこれもアプリケーションを離れた判定を受けます。つまりリワード広告を閉じて戻ってきた際にも上記メソッドが呼ばれてしまうのです。
よって，もしリワード広告を導入しているのであれば，リワード広告を表示していた場合は無視するようにするべきでしょう。OpenOfflineEarning()は以下のようになっています。わざわざメソッドにする意味あったか？とか今見返すと色々思うところがありますが，置いておきます笑
先ほどのSetOfflineEarningは読み込んだ先のシーン内にあるシーン管理スクリプトのStart()内で実行しています。
CalcOfflineEarning()はSetOfflineEarningで行っている計算の部分のみを行い値だけ返却するメソッドです。報酬が0の場合はポップアップ表示をする必要がなく計算結果を代入されては困るので，if文で判定を行っています。
一応コードも載せておきます。（同じようなことを記述していてばかばかしいですね，もっと簡潔に書けそうではあります。）追加ロードするシーンは以下のようにポップアップ表示用UIを用意しておき，稼げる金額等をスクリプト側で書き換えています。
初投稿で文章が読みづらいところもあるかとは思いますが，ご容赦ください。
今回基本的には時間差分で報酬を計算，アプリケーションに戻ってきたことを判定し，その際にポップアップ表示用のシーンを追加ロードという形で実装しました。
もっと良い方法もあるかとは思いますが，少しでも参考になれば幸いです。今回の実装では特段チート対策（端末の時刻をいじるなどに対する対策）はしていません。
企画の方に確認したところ，対策しなくてもいいとのことだったので，とりあえず現状は放置です。そのうち対策したものも載せるかもしれません。


