More than 1 year has passed since last update.PowerShellでファイルシステムのディレクトリを削除する方法について、よくある例と、それを行うとうまくいかない、場合によっては破壊的な動作をする例を説明します。なお、最終的に.NETの問題にぶつかるので、PowerShellからC#使えばいいじゃない教の人もハマります。以下のようなコマンドでファイルシステムにテストデータを作成します。以下のようなディレクトリが作成されます。この時にtestフォルダを削除するにはどうすればいいでしょうか？
よくある説明では下記のコマンドを入力すると行えるとあります。先の例は、多くの場合、正しく動きますが、特定の条件下でユーザが意図しないような破壊的動作をします。まずファイルシステムの場合、シンボリックリンクやジャンクションという種類が存在しています。Windowsのシンボリックリンクとジャンクションとハードリンクの違い
https://www.atmarkit.co.jp/ait/articles/1306/07/news111.htmlこれらの機能は簡単にいうとディレクトリへのリンクを作成することができる機能になっています。
これらを実際に作成するには下記のスクリプトを管理者権限で実行してください。以下のようなディレクトリになります。ジャンクションやシンボリックリンクを用いることでディレクトリへのリンクが作成されていることが確認できます。ではsrc1フォルダとsrc2フォルダを残してtestフォルダのみを削除します。この結果はPowerShellのバージョンによって異なります。testディレクトリは削除されましたが、リンク先のファイルが全て削除されてしまいます。
これがユーザーの意図しない破壊的結果になります。この挙動は以下で修正されています。
https://github.com/PowerShell/PowerShell/issues/621Windows10+PowerShell 5.1の場合以下のようになります。ジャンクションは正しく削除されましたが、シンボリックリンクは残ってしまいます。
シンボリックリンクが消えない事象は、以下のコメントと同様の事象と思われます。
https://github.com/PowerShell/PowerShell/issues/621#issuecomment-515729308よく上記の話が出た際にプランBとして紹介される削除方法は以下になります。これは２つの問題を引き起こします。
１つ目は読み取り専用のファイルが混在していた場合に削除できません。
２つ目はジャンクションを含むサブディレクトリを削除した場合、エラーになります。先に挙げたジャンクションを含むディレクトリを削除した場合、以下のようになります。このときのフォルダ構成は以下のようになっており、ジャンクションを含むディレクトリ以外は削除されています。このため、もう一度、再実行すると正常に削除されます。この事象は、PowerShell固有の問題でなく、C#で実装した場合も発生します。
例えば、C#で以下のような実装で削除した場合も同様の事象になります。VisualStudio2019の下記にて検証
 ・.NET Framework 4.7.2 + Win10
 ・.NET Core 2.1 + Win10.
※ＴＯＤＯ：Linuxで動かした場合はそのうち。なぜこの事象が発生するかの理由は、わかりませんでしたが、おそらく、以下と類似の問題だと思います。Cannot delete directory with Directory.Delete(path, true)
https://stackoverflow.com/questions/329355/cannot-delete-directory-with-directory-deletepath-trueジャンクションポイントが削除されきっていない状態で親フォルダを削除しようとしてエラーになっているのではないかと思いますが、正直わかりません。昔ながらのcmd.exeにやらせる。PowerShellの場合、以下のようにSystem.IO.DirectoryInfo.Deleteで消せなかった残りの項目をRemove-Itemを強制＋再帰的に呼び出してしまう方法もあります。FileAttributes.ReparsePointを判定してシンボリックリンクやジャンクションの場合は再帰を行わず、該当のディレクトリだけを削除します。
それ以外の場合は読み取り属性を外してファイルを削除後、各ディレクトリについて再起呼び出しをします。
※よくあるサンプルだとFileAttributes.ReparsePointの判定をしていないので、リンク先の属性を変更してしまっているサンプルがあります。SHFileOperationを利用してエクスプローラーから削除したものと同じ動作を行う方法もあります。
この場合、削除中の進捗プログレスなどが表示されます。
ファイルロック中等でエラーなどが表示された場合に以下のダイアログが表示されて処理が止まるのでバッチ処理には向いていません。これと同様のことはMicrosoft.VisualBasicを参照後以下のコードでも実現可能です。シンボリックリンクやジャンクションを含むディレクトリの削除について記載しました。
C#のディレクトリ削除やPowerShellのディレクトリ削除でグーグル検索した場合の上位に出てくるものは、この辺りを考慮していないので注意してください。http://m-hiyama.hatenablog.com/entry/20150914/1442195413
https://kristofmattei.be/2012/12/15/powershell-remove-item-and-symbolic-links/
https://stackoverflow.com/questions/329355/cannot-delete-directory-with-directory-deletepath-true
https://www.fluxbytes.com/csharp/delete-files-or-folders-to-recycle-bin-in-c/


