More than 3 years have passed since last update.NPOIを触ってみたので、備忘録も兼ねて導入からExcelファイルの作成・編集までをまとめました。Officeのドキュメントの操作を行う事が出来るApache POI(Javaライブラリ)の.NET用に移植されたライブラリです。C#やVB.netでOfficeのドキュメントを作成・編集する事が出来ます。また、LicenceはApache 2.0です。
ここではxlsファイルやxlsxファイルといったExcelのドキュメントを扱う場合について記載します。また、Apache POIに準拠しているため、Apache POIのサンプルを参考に出来ます。POIの機能で主にExcelに関連があるのは下記の機能です。参考：
https://ja.wikipedia.org/wiki/Apache_POIVisual Studio 2015 Community
.NET Framework 4.5.2
NPOI 2.2.1NuGet(パッケージマネージャ)でインストール出来ます。
https://www.nuget.org/packages/NPOI/Install-Package NPOIをパッケージマネージャのコンソール上で実行すればインストールされ、参照等も設定されます。パッケージマネージャはメニューから[ツール]⇒[NuGetパッケージマネージャー]⇒[パッケージマネージャーコンソール]で表示されます。ブックを作成し、作成したブックを保存する事でExcelファイルを作成する方法を紹介します。拡張子に応じて対応するブックのインスタンスを作成した後、保存します。
また、シート無しのブックを保存すると保存後のExcelファイルを開いた時にエラーで開けなくなるので作成後に一つだけシートを追加しています。サンプルコードを実行すると以下のようなExcelファイルが作成されます。サンプルコードの簡略な解説です。xlsファイルならばHSSFWorkbookクラス、xlsxファイルならばXSSFWorkbookクラスのインスタンスを作成する事でブックを作成できます。どちらのクラスもIWorkbookインタフェースを継承しています。IWorkbookインタフェースのWriteメソッドを作成したFileStreamクラスのインスタンスを渡す事でExcelファイルを保存出来ます(FileStreamのコンストラクタには保存先のパスを指定)。シートのセルに値を設定する方法を紹介します。
また、併せてファイル読み込み等も紹介します。先程作成したExcelファイルを読み込んでシートのセルに設定します。サンプルコードを実行すると以下のようなExcelファイルが作成されます。
(日付表示のため、列の幅を広げています。)サンプルコードの簡略な解説です。WorkbookFactory.Createの引数にファイルパスを渡して呼び出すだけで指定したファイルパスのExcelファイルを開いて、ファイルパスに応じた形式(HSSF・XSSF)のブックを取得出来ます。セルに書き込むためにはまず、セルを取得する必要があります。シートから行のインスタンス、行からセルのインスタンスを取得する事が出来ます。また、それぞれ0オリジンとなっています。ただし、設定されていない箇所を取得する場合、行取得時及びセル取得時にnullが取得されます。そのため、null取得時に取得対象を作成する必要があります。取得したセルのインスタンスの値を設定するメソッド(SetCellValue)を呼び出す事で設定します。設定する値(SetCellValueの引数)に対応した表示形式(文字列・数値・日付など)でセルに保存されます。セルに書き込んでも表示形式までは変更されないのでデフォルト(標準)のままとなっています。そのため、日付の表示が数値表示となってしまいます。そこで表示形式を変更する必要があります。
ただし、書式はブックが保持しているものなので注意する必要があります。セルから取得した書式だけ変えると意図しない挙動になります。
(HSSFの場合は全セルに反映されて、XSSFの場合は反映自体されませんでした。)参考:
http://www.coppermine.jp/docs/programming/2011/11/apache-poi.html
http://irof.hateblo.jp/entry/20100313/p1思ったより長くなりましたがNPOIの導入からExcelファイルの作成・編集までを記載しました。
最後に上述以外で世話になった参考URLを記載します。流石に数年前のサンプルコードだと現在のNPOIのバージョンでは動作しないので気を付けてください。http://blog.okazuki.jp/entry/20091128/1259405232
http://www.javadrive.jp/poi/https://github.com/tonyqus/npoi
(NPOIのGithubリポジトリ。Exampleディレクトリ内に使用例があり、参考になりました。)


