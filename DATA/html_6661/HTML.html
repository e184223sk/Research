<!DOCTYPE html><html><head><meta charset="utf-8" /><title> C#で実行するOpenVINOによる手書き文字認識(MNIST) - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/fan2tamo/items/18f418bd6d23686621ea" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="S8EDT1pxYfYG+wosANx5AneCZ/Vt2i2j365dwehibPikvwE7e3p3qb3YenWBMwPn4XUOUvkiXDWhl272nAIqTA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@yasu_fan2tamo" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content=" C#で実行するOpenVINOによる手書き文字認識(MNIST) - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1JRU1qNDRHbjVhNmY2S0dNNDRHWjQ0S0xUM0JsYmxaSlRrX2pnYXZqZ29qamdvdm1pWXZtbTdqamdZM21sb2Zsclpmb3FvM29yWmdvVFU1SlUxUXAmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YzZjZTNkMGI3NjYxMDVhZjBhZWI3ZTAwZDhjOTY4MDg&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR1poYmpKMFlXMXYmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz02OGJiNjE4OGJmZTVjZjM2MzFhODI1NjM0OWFkODgxZQ&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=5612b94bae2cc6bfee57a63b6543ee3d"><meta property="og:description" content="

はじめに

この記事は、OpenVINOをC#で使うための記事です。
内容としては、過去に書いたC++で実行するOepnVinoによる手書き文字認識(MNIST)の内容を、最新バージョン(2021.2)向けに更新したものになってい..."><meta content="https://qiita.com/fan2tamo/items/18f418bd6d23686621ea" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,DeepLearning,swig,Keras,OpenVINO" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-504a10a7-183b-4a98-87c9-707aeffed1b9"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Ffan2tamo%2Fitems%2F18f418bd6d23686621ea">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Ffan2tamo%2Fitems%2F18f418bd6d23686621ea">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-504a10a7-183b-4a98-87c9-707aeffed1b9">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2021-02-23T12:57:24.000+09:00","dateModified":"2021-02-23T21:52:15.000+09:00","headline":" C#で実行するOpenVINOによる手書き文字認識(MNIST)","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1JRU1qNDRHbjVhNmY2S0dNNDRHWjQ0S0xUM0JsYmxaSlRrX2pnYXZqZ29qamdvdm1pWXZtbTdqamdZM21sb2Zsclpmb3FvM29yWmdvVFU1SlUxUXAmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YzZjZTNkMGI3NjYxMDVhZjBhZWI3ZTAwZDhjOTY4MDg\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR1poYmpKMFlXMXYmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz02OGJiNjE4OGJmZTVjZjM2MzFhODI1NjM0OWFkODgxZQ\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=5612b94bae2cc6bfee57a63b6543ee3d","mainEntityOfPage":"https://qiita.com/fan2tamo/items/18f418bd6d23686621ea","author":{"@type":"Person","address":"Tokyo, Japan","email":null,"identifier":"fan2tamo","name":"fan2tamo","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F329392%2Fe08b0f5411e5c1b79a59ecf87b6112d72f41d954%2Fx_large.png%3F1611727425?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=6c7acf933b897bd632982f6915d2ce71","url":"https://qiita.com/fan2tamo","description":"メインはC#、次がC++、Pythonという感じです。\r\nDeep Learningに興味があり、なんとかC#で使えないかと試行錯誤中。\r\n\r\n今まで触った言語は、C, C++, Prolog, Perl, Octave, C#, Pythonぐらい。\r\n学生の頃はFreeBSDを使っていたので、cshかtcshだったけど、今はzshです。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita&amp;utm_medium=header-banner">LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"fan2tamo","type":"items","id":"18f418bd6d23686621ea"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから","url":"https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"fan2tamo","type":"items","id":"18f418bd6d23686621ea"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから","url":"https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"fan2tamo","type":"items","id":"18f418bd6d23686621ea"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"LINEグループの成長を担うLINE Growth Technologyのこれまでとこれから","url":"https://zine.qiita.com/interview/202107-line-growth-technology/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/fan2tamo/items/18f418bd6d23686621ea","location":"/fan2tamo/items/18f418bd6d23686621ea","scheme":"https","host":"qiita.com","port":null,"pathname":"/fan2tamo/items/18f418bd6d23686621ea","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"go3fsNthfW6jzEFEMa8xPD7B8tykKCVIAPB2dF3kUC9t893E+mprMRjvMR2wQEvZqDabezDQVN5+yUVDKYQWmw==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-44ccd346-978f-48ef-9645-80114a9778fa"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/fan2tamo/items/18f418bd6d23686621ea/likers" class="css-1iupg5d">2</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">2</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/18f418bd6d23686621ea/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/fan2tamo/items/18f418bd6d23686621ea/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/fan2tamo/items/18f418bd6d23686621ea/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/fan2tamo/items/18f418bd6d23686621ea/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/fan2tamo/items/18f418bd6d23686621ea.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/fan2tamo"><img class="css-100alwu eyfquo10" src="https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/329392/e08b0f5411e5c1b79a59ecf87b6112d72f41d954/x_large.png?1611727425" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/fan2tamo" class="css-10ougpm">@<!-- -->fan2tamo</a><div class="css-1ay9vb9"><span><meta content="2021-02-23T03:57:24Z"/><time dateTime="2021-02-23T12:52:15Z" class="css-m19uds">updated at 2021-02-23</time></span></div></div></div></div></div><h1 class="css-cgzq40"> C#で実行するOpenVINOによる手書き文字認識(MNIST)</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/deeplearning" class="css-4czcte">DeepLearning</a><a href="/tags/swig" class="css-4czcte">swig</a><a href="/tags/keras" class="css-4czcte">Keras</a><a href="/tags/openvino" class="css-4czcte">OpenVINO</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>この記事は、OpenVINOをC#で使うための記事です。<br>
内容としては、過去に書いた<a href="https://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54" id="reference-09e5468a92daa7f0e7aa">C++で実行するOepnVinoによる手書き文字認識(MNIST)</a>の内容を、最新バージョン(2021.2)向けに更新したものになっています。<br>
また、それだけだとただの焼き直しになるので、C++とPythonのインターフェースしか用意されていないOpenVINOをC#から使えるようにしてみました。<br>
説明はしていませんが、dllをC++から使うアプリも一緒に公開していますので、必要があればそちらも見てください。</p>

<h2>
<span id="構成" class="fragment"></span><a href="#%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>構成</h2>

<p>この記事は以下5つのパートに分かれます。</p>

<ol>
<li><p><a href="#1_%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E8%AD%98%E5%88%A5%E5%99%A8%E3%81%AE%E7%94%9F%E6%88%90">学習済みモデル(識別器)の生成</a><br>
Kerasというフレームワークを使って学習済みモデルを生成します。<br>
内容としては<a href="https://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54">C++で実行するOepnVinoによる手書き文字認識(MNIST)</a>に沿っていますが、フレームワークをChainerからKerasに変更しています。</p></li>
<li><p><a href="#2_%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%82%92openvino%E3%81%8C%E6%89%B1%E3%81%88%E3%82%8B%E5%BD%A2%E5%BC%8F%E3%81%AB%E5%A4%89%E6%8F%9B">学習済みモデルをOpenVINOが扱える形式に変換</a><br>
Kerasで作成した学習済みモデルをOpenNINO付属のModel Optimizerで変換します。<br>
内容としては<a href="https://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54">C++で実行するOepnVinoによる手書き文字認識(MNIST)</a>に沿っています。</p></li>
<li><p><a href="#3_openvino%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8Bdll(c)%E3%82%92%E4%BD%9C%E6%88%90">OpenVINOを使って推論するdll(C++)を作成</a><br>
OpenVINOを扱うクラスを実装します。<br>
内容としては<a href="https://qiita.com/fan2tamo/items/8f110a22d47cb684f33d" id="reference-d3b15ace5e25e3d00eb8">C++で作成したDLLでAPIではなくクラスを提供する方法</a>に沿っています。</p></li>
<li><p><a href="#4_swig%E3%81%A7C%E5%90%91%E3%81%91%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0">SwigでC#向けのインターフェースを追加</a><br>
3.で作ったdllにSwigを使いC#向けのインターフェースを追加します。<br>
内容としては<a href="https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb" id="reference-0faad972bb5e352bc039">C++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法</a>に沿っています。</p></li>
<li><p><a href="#5_swig%E3%81%A7c%E5%90%91%E3%81%91%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9Fdll%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8B%E3%82%A2%E3%83%97%E3%83%AA(c)%E3%82%92%E4%BD%9C%E6%88%90">SwigでC#向けインターフェースを追加したdllを使って推論するアプリ(C#)を作成</a><br>
C#で作ったdllを使うアプリを作ります。<br>
内容としては<a href="https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb">C++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法</a>に沿っています。</p></li>
</ol>

<h2>
<span id="環境" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>環境</h2>

<p>このエントリを書いている私の環境は以下です。</p>

<ul>
<li>OS : Windows10 Pro x64 20H2</li>
<li>CPU : Intel</li>
<li>GPU : あり(NVIDIA)

<ul>
<li>CUDA : 10.1</li>
<li>cuDNN : 7.6.5</li>
</ul>
</li>
<li>VPU : あり(Movidius Neural Compute Stick 2)</li>
<li>Visual Studio Pro: 2019</li>
<li>OpenVino : 2021.2</li>
<li>Python3 : 3.7.9

<ul>
<li>Keras : 2.4.3</li>
<li>onnx : 1.8.0</li>
<li>onnx2keras : 0.0.24</li>
<li>opencv-python : 4.4.0.46</li>
<li>opencv-contrib-python : 4.4.0.46<br>
</li>
<li>tendorflow : 2.3.0(GPUがない場合のみ)</li>
<li>tensorflow-gpu : 2.3.0(GPUがある場合のみ)</li>
</ul>
</li>
<li>Swig : 4.0.2</li>
</ul>

<p>CUDAとcuDNNはお使いのtensorflow-GPUのバージョンで変えてください。<br>
<a href="https://www.tensorflow.org/install/source_windows?hl=ja" rel="nofollow noopener" target="_blank">ここに対応表</a>があります。</p>

<h1>
<span id="openvinoを使う理由について" class="fragment"></span><a href="#openvino%E3%82%92%E4%BD%BF%E3%81%86%E7%90%86%E7%94%B1%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>OpenVINOを使う理由について</h1>

<p>近年、KerasやPyTorchなどのDeep Learningフレームワークが登場したことにより、手軽に個人でDeep Learning(学習フェーズと推論フェーズ)を実行できるようになりつつありますが、個人では以下の理由により製品適用レベルの学習済みモデルを作成することはまだハードルが高いです。</p>

<ul>
<li>十分な量・質の学習データを用意する必要がある</li>
<li>専門的な知識がないとどのようなネットワークにすれば良いのか判断できない</li>
<li>高性能な外付けGPU(dGPU)がないと学習に時間がかかる</li>
</ul>

<p>また、学習済みモデルさえ用意できれば推論フェーズは個人で十分に実行可能ではあるのですが、推論自体も処理負荷が軽いわけではないために非力なデバイスで実行すると思った通りの速度がでない、もしくはCPU負荷が100%付近に張り付きユーザービリティの低下を招くという状況になってしまいます。<br>
そのため、解決策の一つして今回はIntel社のOpenVINOを使用します。<br>
OpenVINOを使用することで、以下が可能になります。<br>
- CPU以外のデバイス(iGPU, VPU, FPGA)での推論<br>
- CPUで実施する推論処理の高速化</p>

<p>具体的には、CPUが非力で推論を実行するとCPU負荷が100%になってしまう場合、VPU(Movidius Neural Compute Stick)を接続してVPUで推論することによりCPUには負荷をかけずに推論というようなことが可能になります。</p>

<p>なお、OpenVINOはIntelが出しているため、上で記載しているCPU、iGPU、VPU、FPGAとはIntel製のものがターゲットになります。</p>

<h1>
<span id="1-学習済みモデル識別器の生成" class="fragment"></span><a href="#1-%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E8%AD%98%E5%88%A5%E5%99%A8%E3%81%AE%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>1. 学習済みモデル(識別器)の生成</h1>

<h2>
<span id="問題設定" class="fragment"></span><a href="#%E5%95%8F%E9%A1%8C%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>問題設定</h2>

<p>今回はMNISTという手書き数字(0～9)を学習させて、入力された数字が0～9のどれなのか当てるという分類問題とします。<br>
<a href="https://camo.qiitausercontent.com/4fc3b543c42fefe1398e66a81059a609562ba64c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332393339322f65366237383032392d303038312d643362652d633939622d6462383963363462323961332e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2Fe6b78029-0081-d3be-c99b-db89c64b29a3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ada3a4552a82af11570f66366b23d25d" alt="mnist.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/329392/e6b78029-0081-d3be-c99b-db89c64b29a3.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2Fe6b78029-0081-d3be-c99b-db89c64b29a3.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=49ffd70e6ed2add577465a01a5a1981b 1x" loading="lazy"></a></p>

<p>データ自体はAPI一発でダウンロードできるため、簡単に利用することが可能です。<br>
学習・検証には公開されているデータを使い、テストには私がペイントで作ったデータを使うこととします。</p>

<h2>
<span id="ネットワーク" class="fragment"></span><a href="#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF"><i class="fa fa-link"></i></a>ネットワーク</h2>

<p>ニューラルネットワークは、入力層と隠れ層(中間層)、出力層を決める必要がありますが、その前にNCHWの説明をします。<br>
NCHWとはそれぞれ以下を示します。</p>

<ul>
<li>N : バッチサイズ</li>
<li>C : チャネル数(カラー画像では3、グレースケールでは1)</li>
<li>H : 画像の高さ</li>
<li>W : 画像の幅</li>
</ul>

<p>NCHW：1x3x224x224という感じで使われる用語なので覚えておいてください。<br>
さて入力層ですがMNISTは手書き数字のデータセットで、1枚は28x28のグレースケールですので素直に作るとNx1x28x28となります。<br>
が、今回はわざわざカラー画像として入力したいと思いますのでNx3x28x28となります。<br>
Nは実際に学習させる時にメモリに載るサイズまで増やしていきましょう。<br>
隠れ層は、各自自由に作ってみて精度が出なければ層を深くするなり、畳み込みをするなり、工夫してみてください。<br>
最後の出力層ですが、最終的に入力した画像が0～9のどれなのかを識別したいので、Nx10となります。</p>

<h2>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h2>

<p>今回はJupyter Notebook上で試していますのでそれぞれのセルごとに説明していきます。<br>
なおMNIST-Keras.ipynbというファイル名で<a href="https://github.com/fan2tamo/OpenVINOApp" rel="nofollow noopener" target="_blank">ここに格納</a>しています。</p>

<h3>
<span id="import" class="fragment"></span><a href="#import"><i class="fa fa-link"></i></a>import</h3>

<div class="code-frame" data-lang="python"><div class="highlight"><pre class="with-code"><code><span class="kn">from</span> <span class="nn">keras.datasets</span> <span class="kn">import</span> <span class="n">mnist</span>
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Convolution2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">BatchNormalization</span><span class="p">,</span> <span class="n">GlobalAveragePooling2D</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">ReLU</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>
<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">import</span> <span class="nn">keras2onnx</span>
<span class="kn">from</span> <span class="nn">keras2onnx</span> <span class="kn">import</span> <span class="n">convert_keras</span>
<span class="kn">from</span> <span class="nn">onnx</span> <span class="kn">import</span> <span class="n">save_model</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
</code></pre></div></div>

<p>Kerasなど必要なものをimportしています。<br>
ここでエラーになる場合は必要なパッケージが足りていませんので、エラーに従って適宜入れてください。</p>

<h3>
<span id="gpuが接続されているか確認" class="fragment"></span><a href="#gpu%E3%81%8C%E6%8E%A5%E7%B6%9A%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E7%A2%BA%E8%AA%8D"><i class="fa fa-link"></i></a>GPUが接続されているか確認</h3>

<div class="code-frame" data-lang="python"><div class="highlight"><pre class="with-code"><code><span class="kn">from</span> <span class="nn">tensorflow.python.client</span> <span class="kn">import</span> <span class="n">device_lib</span>
<span class="n">deviceStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">device_lib</span><span class="p">.</span><span class="n">list_local_devices</span><span class="p">())</span>
<span class="n">isGPU</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">if</span> <span class="s">"GPU"</span> <span class="ow">in</span> <span class="n">deviceStr</span><span class="p">:</span>
    <span class="n">isGPU</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">print</span><span class="p">(</span><span class="s">"*** isGPU == {} ***"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">isGPU</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">deviceStr</span><span class="p">)</span>
</code></pre></div></div>

<p>GPUが接続されているかチェックしています。<br>
GPUの接続が確認できればisGPUをTrueと、確認できなければFalseとしています。</p>

<h3>
<span id="学習検証用データの作成" class="fragment"></span><a href="#%E5%AD%A6%E7%BF%92%E6%A4%9C%E8%A8%BC%E7%94%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>学習・検証用データの作成</h3>

<div class="code-frame" data-lang="python"><div class="highlight"><pre class="with-code"><code><span class="c1"># データ取得
</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="p">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="n">x_train_shape</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">.</span><span class="n">shape</span>
<span class="n">x_test_shape</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">.</span><span class="n">shape</span>

<span class="c1"># reshape([?, 28, 28] -&gt; [?, 1, 28, 28])
</span><span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_train_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x_train_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_train_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x_test_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_test_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="c1"># データの色情報を1次元から3次元に拡張([?, 1, 28, 28] -&gt; [?, 3, 28, 28])
# グレースケールからカラーに拡張することになるが、色情報は同じ値としている
</span><span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">tile</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="k">if</span> <span class="n">isGPU</span><span class="p">:</span>
    <span class="n">data_format</span> <span class="o">=</span> <span class="s">"channels_first"</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">data_format</span> <span class="o">=</span> <span class="s">"channels_last"</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x_test</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span>  <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="n">x_train</span> <span class="o">/=</span> <span class="mi">255</span>
<span class="n">x_test</span> <span class="o">/=</span> <span class="mi">255</span>

<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1"># convert class vectors to binary class matrices
</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
</code></pre></div></div>

<p>ここでは3つのポイントがあります。<br>
- チャネルを1チャネルから3チャネルへ<br>
　　これはテスト用画像をペイントで作る時にグレースケール画像(1チャネルの意味)を作れないからです。<br>
- isGPU==FalseならNCHWからNHWCへ<br>
　　CPUではNCHWに対応していないため。<br>
　　なお、GPUはNHWCにも対応していますが、速度が遅くなります。<br>
- 画像の取りうる値を[0,255]から[0.0, 1.0]へ<br>
　　精度を上げるため。</p>

<h3>
<span id="ネットワーク定義" class="fragment"></span><a href="#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>ネットワーク定義</h3>

<div class="code-frame" data-lang="python"><div class="highlight"><pre class="with-code"><code><span class="k">def</span> <span class="nf">BN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gpu</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gpu</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>   

<span class="n">input_layer</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">"same"</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">input_layer</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">BN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">isGPU</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">"same"</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">BN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">isGPU</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">"same"</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">"same"</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">BN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">isGPU</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">"same"</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">BN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">isGPU</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">"same"</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">BN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">isGPU</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Convolution2D</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">"same"</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">BN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">isGPU</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">GlobalAveragePooling2D</span><span class="p">(</span><span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

<span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
</code></pre></div></div>

<p>ネットワーク全体は上記としました。<br>
上記ネットワークはCPUで実行すると時間がかかりますので、GPUがない方はGoogle Colabを使うなり、時間がかからないようにネットワークを変更するなりしてください。<br>
最適化関数はAdamとしています。</p>

<h3>
<span id="学習" class="fragment"></span><a href="#%E5%AD%A6%E7%BF%92"><i class="fa fa-link"></i></a>学習</h3>

<div class="code-frame" data-lang="python"><div class="highlight"><pre class="with-code"><code><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'auto'</span><span class="p">)],</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="p">)</span>
</code></pre></div></div>

<p>Epochを進めて検証用データでのlossとaccuracyが改善していることを確認してください。</p>

<h3>
<span id="テスト" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>テスト</h3>

<div class="code-frame" data-lang="python"><div class="highlight"><pre class="with-code"><code><span class="kn">import</span>  <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="n">imageFilePaths</span> <span class="o">=</span> <span class="n">glob</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="s">"""OpenVINOApp\OpenVINOAppCpp\Data\Image\*.png"""</span><span class="p">)</span>

<span class="k">for</span> <span class="n">imageFilePath</span> <span class="ow">in</span> <span class="n">imageFilePaths</span><span class="p">:</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imageFilePath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">isGPU</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> 
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="mf">255.0</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"-------   {0}  -----------"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">imageFilePath</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[{0}] = {1:.4f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
</code></pre></div></div>

<p>実際にペイントで作った3x28x28の画像を入力し、それぞれどの数字と予測したのかを表示しています。<br>
今学習したモデルで正解しているかを確認してください。</p>

<h3>
<span id="学習済みモデルの保存" class="fragment"></span><a href="#%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BF%9D%E5%AD%98"><i class="fa fa-link"></i></a>学習済みモデルの保存</h3>

<div class="code-frame" data-lang="python"><div class="highlight"><pre class="with-code"><code><span class="c1"># .h5で保存
</span><span class="n">model</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="s">"mnist.h5"</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s">"h5"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">isGPU</span><span class="p">:</span>
    <span class="c1"># .onnxで保存
</span>    <span class="n">onnx_model</span> <span class="o">=</span> <span class="n">convert_keras</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">channel_first_inputs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">])</span>
    <span class="n">save_model</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">,</span> <span class="s">"mnist.onnx"</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># .pbで保存
</span>    <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
    <span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
    <span class="kn">from</span> <span class="nn">tensorflow.python.framework.convert_to_constants</span> <span class="kn">import</span> <span class="n">convert_variables_to_constants_v2</span>

    <span class="c1">#path of the directory where you want to save your model
</span>    <span class="n">frozen_out_path</span> <span class="o">=</span> <span class="s">''</span>

    <span class="c1"># Convert Keras model to ConcreteFunction
</span>    <span class="n">full_model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">function</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">full_model</span> <span class="o">=</span> <span class="n">full_model</span><span class="p">.</span><span class="n">get_concrete_function</span><span class="p">(</span>
        <span class="n">tf</span><span class="p">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dtype</span><span class="p">))</span>
    <span class="c1"># Get frozen ConcreteFunction
</span>    <span class="n">frozen_func</span> <span class="o">=</span> <span class="n">convert_variables_to_constants_v2</span><span class="p">(</span><span class="n">full_model</span><span class="p">)</span>
    <span class="n">frozen_func</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="n">as_graph_def</span><span class="p">()</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">frozen_func</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="n">get_operations</span><span class="p">()]</span>

    <span class="c1"># Save frozen graph to disk
</span>    <span class="n">tf</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph_or_graph_def</span><span class="o">=</span><span class="n">frozen_func</span><span class="p">.</span><span class="n">graph</span><span class="p">,</span>
                      <span class="n">logdir</span><span class="o">=</span><span class="n">frozen_out_path</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">"mnist.pb"</span><span class="p">,</span>
                      <span class="n">as_text</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># Save its text representation
</span>    <span class="n">tf</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph_or_graph_def</span><span class="o">=</span><span class="n">frozen_func</span><span class="p">.</span><span class="n">graph</span><span class="p">,</span>
                      <span class="n">logdir</span><span class="o">=</span><span class="n">frozen_out_path</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">"mnist.pbtxt"</span><span class="p">,</span>
                      <span class="n">as_text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>まず、普通にKerasの機能で学習済みモデルを保存(mnist.h5)しています。<br>
ただしh5形式の学習済みモデルはOpenVINOでは使えないため、ONNX形式かpb形式に一旦した後にIR形式というOpenVINO専用の形式にする必要があります。<br>
なお、NHWCをONNX形式で保存してもうまくIR形式に変換できなかったので、NHWCの場合はpb形式で保存するようにしています。</p>

<p>これで学習済みモデルを作成する部分は完了です。</p>

<h1>
<span id="学習済みモデルをopenvinoが扱える形式に変換" class="fragment"></span><a href="#%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%82%92openvino%E3%81%8C%E6%89%B1%E3%81%88%E3%82%8B%E5%BD%A2%E5%BC%8F%E3%81%AB%E5%A4%89%E6%8F%9B"><i class="fa fa-link"></i></a>学習済みモデルをOpenVINOが扱える形式に変換</h1>

<p>OpenVinoはONNX形式の学習済みモデルを動かすことはできず、IR形式と呼ばれる専用の形式で記述された学習済みモデルでしか動作させることができません。そのため、ONNX形式をIR形式に変換する必要があります。ここが皆さんが遭遇する最初の山かもしれません。</p>

<p><a href="https://docs.openvinotoolkit.org/latest/openvino_docs_install_guides_installing_openvino_windows.html" rel="nofollow noopener" target="_blank">公式ページ</a>に沿ってやっていきましょう。</p>

<h2>
<span id="openvinoのインストール" class="fragment"></span><a href="#openvino%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>OpenVinoのインストール</h2>

<p>公式ページにそのものずばりがありますので割愛します。<br>
公式ページ以外ですと、以下2つを紹介しておきます。<br>
- <a href="https://openvino.jp/2021-1-on-win10/" rel="nofollow noopener" target="_blank">OpenVINO 2021.1 環境構築（Windows 10編）</a><br>
- <a href="https://qiita.com/hanapage/items/a2f76d97bed0204d3819" id="reference-4972cca5c4e82b09b6f4">OpenVINO (2019.R1) Windows10版のインストールとサンプルのテスト</a></p>

<h2>
<span id="環境設定" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>環境設定</h2>

<p><a href="https://docs.openvinotoolkit.org/latest/openvino_docs_install_guides_installing_openvino_windows.html" rel="nofollow noopener" target="_blank">公式ページ</a>によると、"setupvars.bat"を実行する必要があると記載されいるので、さっそく実行します。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="go">cd /d "C:\Program Files (x86)\Intel\openvino_2021\bin"
setupvars.bat
</span></code></pre></div></div>

<p>次に変換に必要なパッケージをインストールしますが、ONNX形式をIR形式にするのか、それともpb形式をIR形式にするのかで必要となるパッケージが異なります。</p>

<p>ONNX形式の場合は以下を実行してください。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="go">cd /d "C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\model_optimizer\install_prerequisites"
install_prerequisites_onnx.bat
</span></code></pre></div></div>

<p>pb形式の場合ですが、今回はKeras(Tensorflow2)でpb形式の学習済みモデルを作ったので、install_prerequisites_tf2.batを実行することになります。</p>

<h2>
<span id="変換" class="fragment"></span><a href="#%E5%A4%89%E6%8F%9B"><i class="fa fa-link"></i></a>変換</h2>

<p>ようやくIR形式に変換していきます。<br>
<a href="https://docs.openvinotoolkit.org/latest/openvino_docs_MO_DG_prepare_model_convert_model_Converting_Model_General.html" rel="nofollow noopener" target="_blank">このページ</a>を参照しながら変換していきましょう。</p>

<p>上記ページをみると、以下のコマンドで変換ができると記載があります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>python3 mo.py --input_model INPUT_MODEL
</code></pre></div></div>

<p>また必要なオプションも記載してありますので各自試してみてください。<br>
最終的に私が点けたオプションは以下の通りです。</p>

<ul>
<li>--framework onnx (pb形式の時はtf)</li>
<li>--output_dir xxx (出力先は適宜指定してください)</li>
<li>--b 1</li>
<li>--data_type FP16</li>
<li>--scale_values [255,255,255]</li>
</ul>

<p><strong>--data_type FP16</strong>は1つのモデルでCPU、GPU、VPUでの推論を可能にするためです。<br>
各デバイスで対応しているdata_typeは以下ページ内のSupported Model Formatsセクションに記載されています。<br>
<a href="https://docs.openvinotoolkit.org/latest/openvino_docs_IE_DG_supported_plugins_Supported_Devices.html" rel="nofollow noopener" target="_blank">Supported Devices</a></p>

<p><strong>--scale_values [255,255,255]</strong>は入力された画像の値をコード上で255で割る手間を省くためです。</p>

<p>ONNX形式時に実行したコマンドは以下の通りです。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="go">python mo.py --framework onnx --input_model mnist.onnx --output_dir "C:\Work\" --b 1 --data_type FP16 --scale_values [255,255,255]
</span></code></pre></div></div>

<p>上記を実行するとC:\Work\に以下のファイルが作成されていることが確認できます。</p>

<ul>
<li>mnist.xml</li>
<li>mnist.bin</li>
<li>mnist.mapping</li>
</ul>

<p>これでModel Optimaizerによる変換は完了です。<br>
今までのコマンドを自動で実行するバッチをconvertModel.batというファイル名で置いていますので面倒な人はそっちを使っても良いです。</p>

<h1>
<span id="3-openvinoを使って推論するdllcを作成" class="fragment"></span><a href="#3-openvino%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8Bdllc%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>3. OpenVINOを使って推論するdll(C++)を作成</h1>

<p>ようやくIR形式の学習済みモデルが作成できましたので、推論をする部分を作っていきます。<br>
推論用のコードはC++かPythonで書くことができます。<br>
Pythonで説明しているQiitaのエントリは我ら(また勝手に"我らが"とか言ってすみません)が<a href="https://qiita.com/PINTO">PINTO</a>さんを筆頭に良質なエントリがありますし、私は最終的にC#を使って推論をしたいため、今回はC++推論用のdllを作り、それをC#で使うことを目指します。</p>

<p>なにはともあれ、<a href="https://docs.openvinotoolkit.org/latest/_docs_IE_DG_Integrate_with_customer_application_new_API.html" rel="nofollow noopener" target="_blank">Inference Engineの説明ページ</a>を見てみます。<br>
上記ページによると以下の流れで推論を実施することになります。</p>

<ol>
<li><a href="#1-initialize-core">Initialize Core</a></li>
<li><a href="#2-read-model-ir">Read Model IR</a></li>
<li><a href="#3-configure-input--output">Configure Input &amp; Output</a></li>
<li><a href="#4-load-model">Load Model</a></li>
<li><a href="#5-create-infer-request">Create Infer Request</a></li>
<li><a href="#6-prepare-input">Prepare Input</a></li>
<li><a href="#7-do-inference">Do Inference</a></li>
</ol>

<p>順にコードに落としていきます。<br>
今回はMyOpenVINOImplというクラスを定義して、そこに推論機能を実装してGetInstance()というAPIでMyOpenVINOImplクラスのインスタンスを取得して使うことを想定しています。<br>
dll自体の作り方は<a href="https://qiita.com/fan2tamo/items/8f110a22d47cb684f33d">C++で作成したDLLでAPIではなくクラスを提供する方法</a>に沿っていますのでそちらを参照してください。<br>
ここではOpenVINOのAPIを使う部分にフォーカスして説明します。<br>
なお、不明な個所があったら、<a href="https://docs.openvinotoolkit.org/latest/_docs_IE_DG_Integrate_with_customer_application_new_API.html" rel="nofollow noopener" target="_blank">Inference Engineの説明ページ</a>を参照してください。</p>

<h2>
<span id="実装-1" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85-1"><i class="fa fa-link"></i></a>実装</h2>

<h3>
<span id="1-initialize-core" class="fragment"></span><a href="#1-initialize-core"><i class="fa fa-link"></i></a>1. Initialize Core</h3>

<div class="code-frame" data-lang="C++"><div class="highlight"><pre class="with-code"><code>    <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">Core</span> <span class="n">core</span><span class="p">;</span>
    <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">CNNNetwork</span> <span class="n">network</span><span class="p">;</span>
    <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">ExecutableNetwork</span> <span class="n">executableNetwork</span><span class="p">;</span>
</code></pre></div></div>

<p>ただの宣言ですね。</p>

<h3>
<span id="2-read-model-ir" class="fragment"></span><a href="#2-read-model-ir"><i class="fa fa-link"></i></a>2. Read Model IR</h3>

<p>ここではモデルの読み込みを実施しています。</p>

<div class="code-frame" data-lang="C++"><div class="highlight"><pre class="with-code"><code><span class="kt">bool</span> <span class="n">MyOpenVINOImpl</span><span class="o">::</span><span class="n">ReadNetwork</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">modelName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">modelName</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">".onnx"</span><span class="p">)</span> <span class="o">==</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// IR</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">binName</span> <span class="o">=</span> <span class="n">modelName</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">modelName</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s">".bin"</span><span class="p">;</span>
            <span class="n">network</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">ReadNetwork</span><span class="p">(</span><span class="n">modelName</span><span class="p">,</span> <span class="n">binName</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="c1">// onnx</span>
            <span class="n">network</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">ReadNetwork</span><span class="p">(</span><span class="n">modelName</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">InferenceEngine</span><span class="o">::</span><span class="n">details</span><span class="o">::</span><span class="n">InferenceEngineException</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Error ReadNetwork() : %s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(...)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Error ReadNetwork() </span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>引数のmodelNameには.xmlファイルのパスを渡します。<br>
そのため、学習済みモデルとして必要なものは.xmlファイルと.binファイルの2つです。<br>
IR形式に変換する際に.mappingファイルが作成されていますが、不要です。<br>
また、実はONNX形式もそのまま読み込めるようなので実装したんですが、未試行なので動くか不明です。</p>

<h3>
<span id="3-configure-input--output" class="fragment"></span><a href="#3-configure-input--output"><i class="fa fa-link"></i></a>3. Configure Input &amp; Output</h3>

<p>ここでは入力と出力の形状(NCHWとか)とデータ型(FP32とか)を設定します。</p>

<div class="code-frame" data-lang="c++"><div class="highlight"><pre class="with-code"><code><span class="kt">bool</span> <span class="n">MyOpenVINOImpl</span><span class="o">::</span><span class="n">SetNetworkConfiguration</span><span class="p">(</span><span class="k">const</span> <span class="n">Layout</span><span class="o">&amp;</span>  <span class="n">iLayout</span><span class="p">,</span> <span class="k">const</span> <span class="n">Precision</span><span class="o">&amp;</span> <span class="n">iPrecision</span><span class="p">,</span> <span class="k">const</span> <span class="n">Layout</span><span class="o">&amp;</span> <span class="n">oLayout</span><span class="p">,</span> <span class="k">const</span> <span class="n">Precision</span><span class="o">&amp;</span> <span class="n">oPrecision</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">inputLayerData</span> <span class="o">=</span> <span class="n">network</span><span class="p">.</span><span class="n">getInputsInfo</span><span class="p">().</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
        <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">Layout</span> <span class="n">il</span> <span class="o">=</span> <span class="n">ConvertInferenceEngineLayout</span><span class="p">(</span><span class="n">iLayout</span><span class="p">);</span>
        <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">Precision</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">ConvertInferenceEnginePrecision</span><span class="p">(</span><span class="n">iPrecision</span><span class="p">);</span>
        <span class="n">inputLayerData</span><span class="o">-&gt;</span><span class="n">setLayout</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
        <span class="n">inputLayerData</span><span class="o">-&gt;</span><span class="n">setPrecision</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
        <span class="n">inputLayerName</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span> <span class="n">network</span><span class="p">.</span><span class="n">getInputsInfo</span><span class="p">().</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span> <span class="p">);</span>
        <span class="n">inputLayout</span> <span class="o">=</span> <span class="n">iLayout</span><span class="p">;</span>
        <span class="n">inputPresicion</span> <span class="o">=</span> <span class="n">iPrecision</span><span class="p">;</span>

        <span class="k">auto</span> <span class="n">outputLayerData</span> <span class="o">=</span> <span class="n">network</span><span class="p">.</span><span class="n">getOutputsInfo</span><span class="p">().</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
        <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">Layout</span> <span class="n">ol</span> <span class="o">=</span> <span class="n">ConvertInferenceEngineLayout</span><span class="p">(</span><span class="n">oLayout</span><span class="p">);</span>
        <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">Precision</span> <span class="n">op</span> <span class="o">=</span> <span class="n">ConvertInferenceEnginePrecision</span><span class="p">(</span><span class="n">oPrecision</span><span class="p">);</span>
        <span class="n">outputLayerData</span><span class="o">-&gt;</span><span class="n">setLayout</span><span class="p">(</span><span class="n">ol</span><span class="p">);</span>
        <span class="n">outputLayerData</span><span class="o">-&gt;</span><span class="n">setPrecision</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
        <span class="n">outputLayerName</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="p">(</span> <span class="n">network</span><span class="p">.</span><span class="n">getOutputsInfo</span><span class="p">().</span><span class="n">begin</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(...)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Error SetNetworkConfiguration()</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Pythonで学習させた時に形状とデータ型をどうしていたのか思い出して、それを指定するだけです。</p>

<h3>
<span id="4-load-model" class="fragment"></span><a href="#4-load-model"><i class="fa fa-link"></i></a>4. Load Model</h3>

<p>実行可能なネットワークを作成します。<br>
特に何も考えずにこのまま実行しましょう。</p>

<div class="code-frame" data-lang="C++"><div class="highlight"><pre class="with-code"><code><span class="kt">bool</span> <span class="n">MyOpenVINOImpl</span><span class="o">::</span><span class="n">LoadNetwork</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Device</span><span class="o">&gt;&amp;</span> <span class="n">devices</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="o">&amp;</span><span class="n">isMulti</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">deviceStr</span> <span class="o">=</span> <span class="n">ConvertDevices2String</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">isMulti</span><span class="p">);</span>
        <span class="n">executableNetwork</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">LoadNetwork</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">deviceStr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(...)</span>
    <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Error : LoadNetwork()</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="5-create-infer-request" class="fragment"></span><a href="#5-create-infer-request"><i class="fa fa-link"></i></a>5. Create Infer Request</h3>

<p>ここでは推論を実行するオブジェクトを作成します。<br>
ここも特に何も考えずにこのまま実行しましょう。</p>

<div class="code-frame" data-lang="c++"><div class="highlight"><pre class="with-code"><code><span class="n">InferenceEngine</span><span class="o">::</span><span class="n">InferRequest</span> <span class="n">MyOpenVINOImpl</span><span class="o">::</span><span class="n">CreateInferRequest</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">InferRequest</span> <span class="n">inferRequest</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">inferRequest</span> <span class="o">=</span> <span class="n">executableNetwork</span><span class="p">.</span><span class="n">CreateInferRequest</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(...)</span>
    <span class="p">{</span>
        <span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">inferRequest</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="6-prepare-input" class="fragment"></span><a href="#6-prepare-input"><i class="fa fa-link"></i></a>6. Prepare Input</h3>

<p>matU8ToBlob()でデータをセットしています。</p>

<div class="code-frame" data-lang="C++"><div class="highlight"><pre class="with-code"><code><span class="kt">bool</span> <span class="n">MyOpenVINOImpl</span><span class="o">::</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="o">::</span><span class="n">InferRequest</span>  <span class="o">&amp;</span><span class="n">inferRequest</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">imageName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">imageData</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="n">imageName</span><span class="p">);</span>

    <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">Blob</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">inputBlob</span> <span class="o">=</span> <span class="n">inferRequest</span><span class="p">.</span><span class="n">GetBlob</span><span class="p">(</span><span class="n">inputLayerName</span><span class="p">);</span>
    <span class="n">matU8ToBlob</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">imageData</span><span class="p">,</span> <span class="n">inputBlob</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="7-do-inference" class="fragment"></span><a href="#7-do-inference"><i class="fa fa-link"></i></a>7. Do Inference</h3>

<p>推論を実行します。<br>
同期の場合はInferSync()を呼び出すだけで、推論が終了するまで待たされて結果が返ってきます。<br>
非同期の場合はInferASync()を呼び出すとすぐ制御が返りますが、推論の実態はInferASyncLocal()でされて結果はコールバックで渡されます。<br>
なお、事前に結果を返すコールバックを登録しておく必要があります。</p>

<div class="code-frame" data-lang="C++"><div class="highlight"><pre class="with-code"><code><span class="c1">// 推論(同期)</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">MyOpenVINOImpl</span><span class="o">::</span><span class="n">InferSync</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">imageName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">InferRequest</span> <span class="n">inferRequest</span> <span class="o">=</span> <span class="n">CreateInferRequest</span><span class="p">();</span>

    <span class="n">SetInputData</span><span class="p">(</span><span class="n">inferRequest</span><span class="p">,</span> <span class="n">imageName</span><span class="p">);</span>
    <span class="n">inferRequest</span><span class="p">.</span><span class="n">Infer</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">outputVect</span><span class="p">;</span>
    <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">SizeVector</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">inferRequest</span><span class="p">.</span><span class="n">GetBlob</span><span class="p">(</span><span class="n">outputLayerName</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getTensorDesc</span><span class="p">().</span><span class="n">getDims</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">float</span><span class="o">*</span> <span class="n">oneHotVector</span> <span class="o">=</span> <span class="p">(</span><span class="n">inferRequest</span><span class="p">.</span><span class="n">GetBlob</span><span class="p">(</span><span class="n">outputLayerName</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">().</span><span class="n">as</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">outputVect</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">oneHotVector</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">outputVect</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 推論(非同期)</span>
<span class="kt">int</span> <span class="n">MyOpenVINOImpl</span><span class="o">::</span><span class="n">InferASync</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">imageName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">inferID</span> <span class="o">=</span> <span class="n">inferCounter</span><span class="p">;</span>
    <span class="n">inferCounter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">InferRequest</span> <span class="n">inferRequest</span> <span class="o">=</span> <span class="n">CreateInferRequest</span><span class="p">();</span>

    <span class="n">InferInfo</span> <span class="n">inferInfo</span><span class="p">(</span><span class="n">inferRequest</span><span class="p">,</span> <span class="n">imageName</span><span class="p">);</span>
    <span class="n">inferMap</span><span class="p">[</span><span class="n">inferID</span><span class="p">]</span> <span class="o">=</span> <span class="n">inferInfo</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">*</span> <span class="n">th</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// 現状はInferASync()が実行されるたびにスレッドを作ってその中でStartAsync()をしている。</span>
    <span class="c1">// スレッドを作るコストは高いので、本当はthreadNumだけWorkerスレッド作って、ということをするべき。</span>
    <span class="n">th</span> <span class="o">=</span><span class="k">new</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyOpenVINOImpl</span><span class="o">::</span><span class="n">InferASyncLocal</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">inferID</span><span class="p">);</span>
    <span class="n">threadVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">th</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">inferID</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="n">MyOpenVINOImpl</span><span class="o">::</span><span class="n">InferASyncLocal</span><span class="p">(</span><span class="kt">int</span> <span class="n">inferID</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">successed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">outputVect</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">inputImage</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">InferInfo</span> <span class="n">inferInfo</span> <span class="o">=</span> <span class="n">inferMap</span><span class="p">[</span><span class="n">inferID</span><span class="p">];</span>
        <span class="n">inputImage</span> <span class="o">=</span> <span class="n">inferInfo</span><span class="p">.</span><span class="n">inputImage</span><span class="p">;</span>
        <span class="n">SetInputData</span><span class="p">(</span><span class="n">inferInfo</span><span class="p">.</span><span class="n">inferRequest</span><span class="p">,</span> <span class="n">inputImage</span><span class="p">);</span>
        <span class="n">inferInfo</span><span class="p">.</span><span class="n">inferRequest</span><span class="p">.</span><span class="n">StartAsync</span><span class="p">();</span>        
        <span class="n">inferInfo</span><span class="p">.</span><span class="n">inferRequest</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="o">::</span><span class="n">IInferRequest</span><span class="o">::</span><span class="n">WaitMode</span><span class="o">::</span><span class="n">RESULT_READY</span><span class="p">);</span>
        <span class="n">InferenceEngine</span><span class="o">::</span><span class="n">SizeVector</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">inferInfo</span><span class="p">.</span><span class="n">inferRequest</span><span class="p">.</span><span class="n">GetBlob</span><span class="p">(</span><span class="n">outputLayerName</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getTensorDesc</span><span class="p">().</span><span class="n">getDims</span><span class="p">();</span>
        <span class="k">const</span> <span class="kt">float</span><span class="o">*</span> <span class="n">oneHotVector</span> <span class="o">=</span> <span class="p">(</span><span class="n">inferInfo</span><span class="p">.</span><span class="n">inferRequest</span><span class="p">.</span><span class="n">GetBlob</span><span class="p">(</span><span class="n">outputLayerName</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">().</span><span class="n">as</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">outputVect</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">oneHotVector</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(...)</span>
    <span class="p">{</span>
        <span class="n">successed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pCallbackHandler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pCallbackHandler</span><span class="o">-&gt;</span><span class="n">InferCallBack</span><span class="p">(</span><span class="n">inferID</span><span class="p">,</span> <span class="n">inputImage</span>  <span class="p">,</span> <span class="n">successed</span><span class="p">,</span>  <span class="n">outputVect</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="ビルド" class="fragment"></span><a href="#%E3%83%93%E3%83%AB%E3%83%89"><i class="fa fa-link"></i></a>ビルド</h2>

<p>Visual Studioでビルドするのですが、そのままではビルド出来ないため以下を設定します。</p>

<table>
<thead>
<tr>
<th style="text-align: center">項目</th>
<th style="text-align: left">内容</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">アーキテクチャ</td>
<td style="text-align: left">x64</td>
</tr>
<tr>
<td style="text-align: center">追加のインクルードディレクトリ</td>
<td style="text-align: left">- C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\inference_engine\include\ <br> - C:\Program Files (x86)\Intel\openvino_2021\opencv\include</td>
</tr>
<tr>
<td style="text-align: center">追加の依存ファイル</td>
<td style="text-align: left">
<strong>Debug</strong><br> - C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\inference_engine\lib\intel64\Debug\inference_engined.lib <br> - C:\Program Files (x86)\Intel\openvino_2021\opencv\lib\opencv_imgproc451d.lib <br> - C:\Program Files (x86)\Intel\openvino_2021\opencv\lib\opencv_core451d.lib <br> - C:\Program Files (x86)\Intel\openvino_2021\opencv\lib\opencv_imgcodecs451d.lib <br> <br>  <strong>Release</strong> <br> - C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\inference_engine\lib\intel64\Release\inference_engine.lib <br> - C:\Program Files (x86)\Intel\openvino_2021\opencv\lib\opencv_imgproc451.lib <br> - C:\Program Files (x86)\Intel\openvino_2021\opencv\lib\opencv_core451.lib <br> - C:\Program Files (x86)\Intel\openvino_2021\opencv\lib\opencv_imgcodecs451.lib</td>
</tr>
</tbody>
</table>

<p>また、出力ディレクトリを以下に変更しています。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>$(ProjectDir)$(Platform)\$(Configuration)\
</code></pre></div></div>

<p>C#側がdllを使う際に作成したdll(MyOpenVINO.dll)をコピーするのですが、dllが置かれている場所が異なるとコピーできませんの注意してください。</p>

<h2>
<span id="dumpbin" class="fragment"></span><a href="#dumpbin"><i class="fa fa-link"></i></a>dumpbin</h2>

<p>ビルドに成功したのでdllが作成されましたが、どのようなAPIが使えるのか確認してみましょう。<br>
Visual Studioに付属しているDeveloper Command Prompt for VS2019を起動してみます。<br>
(お使いの環境によっては開発者コマンドプロンプトという名称かもしれません)</p>

<p>Developer Command Prompt for VS2019を起動して、さきほど作成したdllが置いてある場所に移動してください。<br>
今回はC:\Workに置いてあるとしています。<br>
dumpbinというコマンドでdllが公開しているAPIを確認することが出来ます。<br>
<a href="https://camo.qiitausercontent.com/d5bc2f9b85cc47e5e1b06511282fb97dfb461c09/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332393339322f35373036386561352d306262372d303434622d613464322d3965313264306533333236612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2F57068ea5-0bb7-044b-a4d2-9e12d0e3326a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b699ac41c84cd50cdea81950199591be" alt="swig_before.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/329392/57068ea5-0bb7-044b-a4d2-9e12d0e3326a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2F57068ea5-0bb7-044b-a4d2-9e12d0e3326a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5d1802eb8e42483c5b73ae5afc0516f8 1x" loading="lazy"></a></p>

<p>赤枠部分が公開しているAPIですが、GetInstanceという名前のAPIだけが公開されていることが分かります。</p>

<h1>
<span id="4-swigでc向けのインターフェースを追加" class="fragment"></span><a href="#4-swig%E3%81%A7c%E5%90%91%E3%81%91%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>4. SwigでC#向けのインターフェースを追加</h1>

<p>Swigを使ってC#向けのインターフェースを追加する方法は<a href="https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb">C++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法</a>を確認してください。<br>
最終的なインターフェースファイル(.i)は以下となります。</p>

<div class="code-frame" data-lang="C++"><div class="highlight"><pre class="with-code"><code><span class="cm">/* File : Swig.i */</span>
<span class="o">%</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">windows</span><span class="p">.</span><span class="n">i</span><span class="o">&gt;</span> 
<span class="o">%</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">std_string</span><span class="p">.</span><span class="n">i</span><span class="o">&gt;</span>
<span class="o">%</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">std_vector</span><span class="p">.</span><span class="n">i</span><span class="o">&gt;</span>
<span class="o">%</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">arrays_csharp</span><span class="p">.</span><span class="n">i</span><span class="o">&gt;</span>

<span class="o">%</span><span class="n">module</span> <span class="p">(</span><span class="n">directors</span><span class="o">=</span><span class="s">"1"</span><span class="p">)</span> <span class="n">MyOpenVINO</span>

<span class="o">%</span><span class="p">{</span>
<span class="cp">#include "MyOpenVINO.h"
</span><span class="o">%</span><span class="p">}</span>

<span class="o">%</span><span class="n">feature</span><span class="p">(</span><span class="s">"director"</span><span class="p">)</span> <span class="n">CallbackHandlerBase</span><span class="p">;</span>

<span class="cm">/* Let's just grab the original header file here */</span>
<span class="o">%</span><span class="n">include</span> <span class="s">"MyOpenVINO.h"</span>

<span class="o">%</span><span class="k">template</span><span class="p">(</span><span class="n">DeviceVector</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Device</span><span class="p">&gt;;</span>
<span class="o">%</span><span class="k">template</span><span class="p">(</span><span class="n">floatVector</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">&gt;;</span>
</code></pre></div></div>

<p>次に以下のコマンドを実行します。<br>
なお、作ったインターフェースファイル、先ほどdllを作る際に作成したヘッダファイル(MyOpenVINO.h)が同じ場所にある前提です。</p>

<div class="code-frame" data-lang="c++"><div class="highlight"><pre class="with-code"><code><span class="n">swig</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">c</span><span class="o">++</span> <span class="o">-</span><span class="n">csharp</span> <span class="o">-</span><span class="n">cppext</span> <span class="n">cpp</span> <span class="n">Swig</span><span class="p">.</span><span class="n">i</span>
</code></pre></div></div>

<p>これで同じ場所に以下のファイルが作成されます。</p>

<ul>
<li>Swig_wrap.cpp</li>
<li>Swig_wrap.h</li>
<li>CallbackHandlerBase.cs</li>
<li>Device.cs</li>
<li>DeviceVector.cs</li>
<li>floatVector.cs</li>
<li>IMyOpenVINO.cs</li>
<li>Layout.cs</li>
<li>MyOpenVINO.cs</li>
<li>MyOpenVINOPINVOKE.cs</li>
<li>NetworkInfo.cs</li>
<li>Precision.cs</li>
</ul>

<p>作成された上記ファイルのうち、Swig_wrap.cppをMyOpenVINOプロジェクトに加えてビルドします。<br>
なお、Swig_wrap.hがSwig_wrap.cppと同じ場所にあるのであれば、Swig_wrap.hを加える必要はありませんが、同じ場所にないのであればSwig_wrap.hも加えてください。<br>
ちなみにexecSwig.batというファイル名でSwigを実行するバッチを作っていますので、それを実行しても良いです。</p>

<h2>
<span id="dumpbin-1" class="fragment"></span><a href="#dumpbin-1"><i class="fa fa-link"></i></a>dumpbin</h2>

<p>Swigで作成したファイルを加えてビルドしましたので、dllが公開しているAPIがどう変わったのか確認してみましょう。<br>
<a href="https://camo.qiitausercontent.com/01689ce5cc9ea2fcd3d3b1217214f9167e1e6e15/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332393339322f63643662383732632d393039362d663461332d643733322d3734616338653166646462382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2Fcd6b872c-9096-f4a3-d732-74ac8e1fddb8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=723f314b48a7c533c8dd6f47ba24f7d7" alt="swig_after.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/329392/cd6b872c-9096-f4a3-d732-74ac8e1fddb8.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2Fcd6b872c-9096-f4a3-d732-74ac8e1fddb8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f859459eccfe65da88d94ea6da6c7c57 1x" loading="lazy"></a></p>

<p>赤枠部分が公開しているAPIですが、ものすごくAPIが追加されていることが分かりますね。</p>

<h1>
<span id="5-swigでc向けインターフェースを追加したdllを使って推論するアプリcを作成" class="fragment"></span><a href="#5-swig%E3%81%A7c%E5%90%91%E3%81%91%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9Fdll%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8B%E3%82%A2%E3%83%97%E3%83%AAc%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>5. SwigでC#向けインターフェースを追加したdllを使って推論するアプリ(C#)を作成</h1>

<p>SwigでC#向けインターフェースを追加したdllを使って推論するアプリ(C#)を作成する方法は<a href="https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb">C++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法</a>を確認してください。</p>

<p>やることを簡単に書くと以下になります。</p>

<ol>
<li><a href="#1-swig%E3%81%8C%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9Fcs%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E8%BF%BD%E5%8A%A0">Swigが作成した.csファイルをプロジェクトに追加</a></li>
<li><a href="#2-callbackhandlerbase%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E7%B6%99%E6%89%BF%E3%81%97%E3%81%9F%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90">CallbackHandlerBaseクラスを継承したクラスを作成</a></li>
<li><a href="#3-myopenvino%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96">MyOpenVINOクラスを使って推論</a></li>
<li><a href="#4-dll%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99%E3%81%9F%E3%82%81%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%B3%E3%83%94%E3%83%BC">dllを動かすためのファイルをコピー</a></li>
</ol>

<p>なお今回作成するアプリはWPF App(.NET)としていますが、コンソールでも良いので必要あれば適宜変更してください。</p>

<h2>
<span id="1-swigが作成したcsファイルをプロジェクトに追加" class="fragment"></span><a href="#1-swig%E3%81%8C%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9Fcs%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>1. Swigが作成した.csファイルをプロジェクトに追加</h2>

<p>プロジェクトに以下のファイルを追加してください。</p>

<ul>
<li>CallbackHandlerBase.cs</li>
<li>Device.cs</li>
<li>DeviceVector.cs</li>
<li>floatVector.cs</li>
<li>IMyOpenVINO.cs</li>
<li>Layout.cs</li>
<li>MyOpenVINO.cs</li>
<li>MyOpenVINOPINVOKE.cs</li>
<li>NetworkInfo.cs</li>
<li>Precision.cs</li>
</ul>

<h2>
<span id="2-callbackhandlerbaseクラスを継承したクラスを作成" class="fragment"></span><a href="#2-callbackhandlerbase%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E7%B6%99%E6%89%BF%E3%81%97%E3%81%9F%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>2. CallbackHandlerBaseクラスを継承したクラスを作成</h2>

<p>以下となります。</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="k">public</span>  <span class="k">class</span> <span class="nc">InferCallBackHandler</span> <span class="p">:</span> <span class="n">CallbackHandlerBase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">TextBox</span> <span class="n">textBox</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">InferCallBackHandler</span><span class="p">(</span><span class="n">TextBox</span> <span class="n">tbx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">textBox</span> <span class="p">=</span> <span class="n">tbx</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// dll側から呼ばれる</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">InferCallBack</span><span class="p">(</span><span class="kt">int</span> <span class="n">inferID</span><span class="p">,</span> <span class="kt">string</span> <span class="n">inputImage</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isSuccessed</span><span class="p">,</span> <span class="n">floatVector</span> <span class="n">results</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">textBox</span><span class="p">.</span><span class="n">Dispatcher</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">((</span><span class="n">Action</span><span class="p">)(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            <span class="n">textBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">+=</span> <span class="s">$"CallBack   inferID[</span><span class="p">{</span><span class="n">inferID</span><span class="p">}</span><span class="s">] : [inputImage] = </span><span class="p">{</span><span class="n">inputImage</span><span class="p">}</span><span class="s">"</span> <span class="p">+</span> <span class="n">System</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">;</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">float</span> <span class="n">result</span> <span class="k">in</span> <span class="n">results</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">textBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">+=</span> <span class="s">$"CallBack   inferID[</span><span class="p">{</span><span class="n">inferID</span><span class="p">}</span><span class="s">] : [</span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="s">] = </span><span class="p">{</span><span class="n">Math</span><span class="p">.</span><span class="nf">Round</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="n">MidpointRounding</span><span class="p">.</span><span class="n">AwayFromZero</span><span class="p">)}</span><span class="s">"</span> <span class="p">+</span> <span class="n">System</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">;</span>
                <span class="n">i</span> <span class="p">+=</span> <span class="m">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">textBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">+=</span> <span class="s">$"---------------------"</span> <span class="p">+</span> <span class="n">System</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">;</span>
        <span class="p">}));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>InferCallBack()でUI上に配置してあるTextBoxに推論結果を表示しています。</p>

<h2>
<span id="3-myopenvinoクラスを使って推論" class="fragment"></span><a href="#3-myopenvino%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96"><i class="fa fa-link"></i></a>3. MyOpenVINOクラスを使って推論</h2>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">Click_InferSync</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">deviceStr</span> <span class="p">=</span> <span class="nf">GetCheckedRadioButtonString</span><span class="p">();</span>
    <span class="n">NetworkInfo</span> <span class="n">networkInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NetworkInfo</span><span class="p">();</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">modelName</span> <span class="p">=</span> <span class="s">@"Model\mnist.xml"</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">inputLayout</span> <span class="p">=</span> <span class="n">Layout</span><span class="p">.</span><span class="n">NCHW</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">inputPrecision</span> <span class="p">=</span> <span class="n">Precision</span><span class="p">.</span><span class="n">U8</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">outputLayout</span> <span class="p">=</span> <span class="n">Layout</span><span class="p">.</span><span class="n">NC</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">outputPrecision</span> <span class="p">=</span> <span class="n">Precision</span><span class="p">.</span><span class="n">FP32</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">isMultiDevices</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">devices</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nf">ConvertString2Device</span><span class="p">(</span><span class="n">deviceStr</span><span class="p">));</span>

    <span class="kt">string</span><span class="p">[]</span> <span class="n">images</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="nf">GetFiles</span><span class="p">(</span><span class="n">inputImageDir</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>
    <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">inputImageFiles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
    <span class="n">inputImageFiles</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">images</span><span class="p">);</span>

    <span class="c1">// instance.GetAvailableDevices();</span>
    <span class="n">instance</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="n">networkInfo</span><span class="p">);</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">inputImage</span> <span class="k">in</span> <span class="n">inputImageFiles</span><span class="p">)</span>
    <span class="p">{</span>             
        <span class="n">instance</span><span class="p">.</span><span class="nf">InferSync</span><span class="p">(</span><span class="n">inputImage</span><span class="p">);</span> 

        <span class="n">floatVector</span> <span class="n">outputVec</span> <span class="p">=</span> <span class="n">instance</span><span class="p">.</span><span class="nf">InferSync</span><span class="p">(</span><span class="n">inputImage</span><span class="p">);</span>
        <span class="n">textBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">+=</span> <span class="s">$"inputImageFile : </span><span class="p">{</span><span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">inputImage</span><span class="p">)}</span><span class="s">"</span> <span class="p">+</span> <span class="n">System</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">foreach</span><span class="p">(</span><span class="kt">float</span> <span class="n">output</span> <span class="k">in</span> <span class="n">outputVec</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="c1">//textBox.Text += string.Format("{0} : {1:f4}", i, outputVec[i]) + System.Environment.NewLine;</span>
        <span class="n">textBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">+=</span>  <span class="s">$"[</span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="s">] :  </span><span class="p">{</span><span class="n">Math</span><span class="p">.</span><span class="nf">Round</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="n">MidpointRounding</span><span class="p">.</span><span class="n">AwayFromZero</span><span class="p">)}</span><span class="s">"</span> <span class="p">+</span> <span class="n">System</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">;</span>
        <span class="n">i</span><span class="p">++;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Click_InferASync</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">InferCallBackHandler</span> <span class="n">obj</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">InferCallBackHandler</span><span class="p">(</span><span class="n">textBox</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">deviceStr</span> <span class="p">=</span> <span class="nf">GetCheckedRadioButtonString</span><span class="p">();</span>
    <span class="n">NetworkInfo</span> <span class="n">networkInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NetworkInfo</span><span class="p">();</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">modelName</span> <span class="p">=</span> <span class="s">@"Model\mnist.xml"</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">inputLayout</span> <span class="p">=</span> <span class="n">Layout</span><span class="p">.</span><span class="n">NCHW</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">inputPrecision</span> <span class="p">=</span> <span class="n">Precision</span><span class="p">.</span><span class="n">U8</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">outputLayout</span> <span class="p">=</span> <span class="n">Layout</span><span class="p">.</span><span class="n">NC</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">outputPrecision</span> <span class="p">=</span> <span class="n">Precision</span><span class="p">.</span><span class="n">FP32</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">threadNum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">isMultiDevices</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="n">networkInfo</span><span class="p">.</span><span class="n">devices</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nf">ConvertString2Device</span><span class="p">(</span><span class="n">deviceStr</span><span class="p">));</span>

    <span class="kt">string</span><span class="p">[]</span> <span class="n">images</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="nf">GetFiles</span><span class="p">(</span><span class="n">inputImageDir</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>
    <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">inputImageFiles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
    <span class="n">inputImageFiles</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">images</span><span class="p">);</span>

    <span class="c1">// instance.GetAvailableDevices();</span>
    <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">instance</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="n">networkInfo</span><span class="p">);</span>
        <span class="n">instance</span><span class="p">.</span><span class="nf">SetInferCallBack</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">inputImage</span> <span class="k">in</span> <span class="n">inputImageFiles</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">instance</span><span class="p">.</span><span class="nf">InferASync</span><span class="p">(</span><span class="n">inputImage</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>           
<span class="p">}</span>
</code></pre></div></div>

<p>Click_InferSync()はInferSyncボタンクリック時に実行されるAPIで、Click_InferASync()はInferASyncボタンクリック時に実行されるAPIです。</p>

<p>あとは、UI周りをちょちょっと作成してください。</p>

<h2>
<span id="4-dllを動かすためのファイルをコピー" class="fragment"></span><a href="#4-dll%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99%E3%81%9F%E3%82%81%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%B3%E3%83%94%E3%83%BC"><i class="fa fa-link"></i></a>4. dllを動かすためのファイルをコピー</h2>

<p>コード自体は完成し、ビルドも出来るようになったのですがdllを動かすために必要なファイルがありますので、ビルド後のイベントを使ってコピーします。<br>
以下のコマンドをビルド後イベントのコマンドラインに記載してください。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">if "$</span><span class="o">(</span>ConfigurationName<span class="o">)</span><span class="s2">" == "</span>Debug<span class="s2">" (
</span><span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\inference_engine\external\tbb\bin\tbb_debug.dll" "$</span><span class="s2">(TargetDir)"</span> /D /S /R /Y /I /K
<span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\ngraph\lib\ngraphd.dll" "$</span><span class="o">(</span>TargetDir<span class="o">)</span><span class="s2">" /D /S /R /Y /I /K
</span><span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\ngraph\lib\onnx_importerd.dll" "$</span><span class="s2">(TargetDir)"</span> /D /S /R /Y /I /K
<span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\opencv\bin\opencv_imgproc451d.dll" "$</span><span class="o">(</span>TargetDir<span class="o">)</span><span class="s2">" /D /S /R /Y /I /K
</span><span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\opencv\bin\opencv_core451d.dll" "$</span><span class="s2">(TargetDir)"</span> /D /S /R /Y /I /K
<span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\opencv\bin\opencv_imgcodecs451d.dll" "$</span><span class="o">(</span>TargetDir<span class="o">)</span><span class="s2">" /D /S /R /Y /I /K
</span><span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\inference_engine\bin\intel64\$</span><span class="s2">(Configuration)"</span> <span class="s2">"</span><span class="si">$(</span>TargetDir<span class="si">)</span><span class="s2">"</span> /D /S /R /Y /I /K
<span class="go">)

</span><span class="gp">if "$</span><span class="o">(</span>ConfigurationName<span class="o">)</span><span class="s2">" == "</span>Release<span class="s2">" (
</span><span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\inference_engine\external\tbb\bin\tbb.dll" "$</span><span class="s2">(TargetDir)"</span> /D /S /R /Y /I /K
<span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\ngraph\lib\ngraph.dll" "$</span><span class="o">(</span>TargetDir<span class="o">)</span><span class="s2">" /D /S /R /Y /I /K
</span><span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\deployment_tools\ngraph\lib\onnx_importer.dll" "$</span><span class="s2">(TargetDir)"</span> /D /S /R /Y /I /K
<span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\opencv\bin\opencv_imgproc451.dll" "$</span><span class="o">(</span>TargetDir<span class="o">)</span><span class="s2">" /D /S /R /Y /I /K
</span><span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\opencv\bin\opencv_core451.dll" "$</span><span class="s2">(TargetDir)"</span> /D /S /R /Y /I /K
<span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\opencv\bin\opencv_imgcodecs451.dll" "$</span><span class="o">(</span>TargetDir<span class="o">)</span><span class="s2">" /D /S /R /Y /I /K
</span><span class="gp">xcopy "C:\Program Files (x86)\Intel\openvino_2021\inference_engine\bin\intel64\$</span><span class="s2">(Configuration)"</span> <span class="s2">"</span><span class="si">$(</span>TargetDir<span class="si">)</span><span class="s2">"</span> /D /S /R /Y /I /K
<span class="go">)
</span><span class="gp">xcopy "$</span><span class="o">(</span>SolutionDir<span class="o">)</span>MyOpenVINO<span class="se">\x</span>64<span class="se">\$</span><span class="o">(</span>Configuration<span class="o">)</span><span class="se">\M</span>yOpenVINO.dll<span class="s2">" "</span><span class="si">$(</span>TargetDir<span class="si">)</span><span class="s2">" /D /S /R /Y /I /K
</span><span class="gp">xcopy "$</span><span class="s2">(SolutionDir)OpenVINOAppCpp</span><span class="se">\D</span><span class="s2">ata</span><span class="se">\"</span><span class="s2"> "</span><span class="si">$(</span>TargetDir<span class="si">)</span><span class="s2">" /D /S /R /Y /I /K
</span></code></pre></div></div>

<p>これで動くようになったはずなので、実行してみてください。<br>
以下のような画面が表示されます。<br>
<a href="https://camo.qiitausercontent.com/426265af438832c534cd5063b603bfedeb2ca78d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332393339322f31623339663266322d393236352d396632382d626331382d3936396333393766373365642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2F1b39f2f2-9265-9f28-bc18-969c397f73ed.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2335f4d858ac6f8ece0a6c22afac5754" alt="OpenVINOAppNet.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/329392/1b39f2f2-9265-9f28-bc18-969c397f73ed.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2F1b39f2f2-9265-9f28-bc18-969c397f73ed.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b6d1c524cc86c9a86f930b94ddf75d45 1x" loading="lazy"></a></p>

<p>UI上にラジオボタンが表示されていますが、MYRIADはMovidius Neural Compute Stick 2が接続されていると選択できるようになります。</p>

<h1>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h1>

<p>OpenVinoを使って推論を実行してみました。<br>
OpenVINOをC#から使っている記事はなさそうですので、同じことをしたい人の助けになれば幸いです。<br>
誤記や認識間違いあればご指摘をお願いします。</p>

<h1>
<span id="参考リンク" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF"><i class="fa fa-link"></i></a>参考リンク</h1>

<ul>
<li>TensorflowとCUDA/cuDNNのバージョン対応表

<ul>
<li>
<a href="https://www.tensorflow.org/install/source_windows?hl=ja" class="autolink" rel="nofollow noopener" target="_blank">https://www.tensorflow.org/install/source_windows?hl=ja</a>)</li>
</ul>
</li>
<li>OpenVino公式

<ul>
<li><a href="https://docs.openvinotoolkit.org/latest/openvino_docs_install_guides_installing_openvino_windows.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.openvinotoolkit.org/latest/openvino_docs_install_guides_installing_openvino_windows.html</a></li>
<li><a href="https://docs.openvinotoolkit.org/latest/_docs_MO_DG_Deep_Learning_Model_Optimizer_DevGuide.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.openvinotoolkit.org/latest/_docs_MO_DG_Deep_Learning_Model_Optimizer_DevGuide.html</a></li>
<li><a href="https://docs.openvinotoolkit.org/latest/openvino_docs_MO_DG_prepare_model_convert_model_Converting_Model_General.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.openvinotoolkit.org/latest/openvino_docs_MO_DG_prepare_model_convert_model_Converting_Model_General.html</a></li>
<li><a href="https://docs.openvinotoolkit.org/latest/openvino_docs_IE_DG_supported_plugins_Supported_Devices.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.openvinotoolkit.org/latest/openvino_docs_IE_DG_supported_plugins_Supported_Devices.html</a></li>
<li><a href="https://docs.openvinotoolkit.org/latest/_docs_IE_DG_Integrate_with_customer_application_new_API.html" class="autolink" rel="nofollow noopener" target="_blank">https://docs.openvinotoolkit.org/latest/_docs_IE_DG_Integrate_with_customer_application_new_API.html</a></li>
</ul>
</li>
<li>OpenVinoインストール

<ul>
<li><a href="https://openvino.jp/2021-1-on-win10/" class="autolink" rel="nofollow noopener" target="_blank">https://openvino.jp/2021-1-on-win10/</a></li>
<li><a href="https://qiita.com/hanapage/items/a2f76d97bed0204d3819" class="autolink">https://qiita.com/hanapage/items/a2f76d97bed0204d3819</a></li>
</ul>
</li>
<li>PINTOさん

<ul>
<li><a href="https://qiita.com/PINTO" class="autolink">https://qiita.com/PINTO</a></li>
</ul>
</li>
<li>C++で実行するOepnVinoによる手書き文字認識(MNIST)

<ul>
<li><a href="https://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54" class="autolink">https://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54</a></li>
</ul>
</li>
<li>C++で作成したDLLでAPIではなくクラスを提供する方法

<ul>
<li><a href="https://qiita.com/fan2tamo/items/8f110a22d47cb684f33d" class="autolink">https://qiita.com/fan2tamo/items/8f110a22d47cb684f33d</a></li>
</ul>
</li>
<li>C++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法

<ul>
<li><a href="https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb" class="autolink">https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb</a></li>
</ul>
</li>
<li>ソース一式

<ul>
<li><a href="https://github.com/fan2tamo/OpenVINOApp" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/fan2tamo/OpenVINOApp</a></li>
</ul>
</li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Ffan2tamo%2Fitems%2F18f418bd6d23686621ea&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Ffan2tamo%2Fitems%2F18f418bd6d23686621ea&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/fan2tamo/items/18f418bd6d23686621ea/likers" class="css-1iupg5d">2</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">2</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/18f418bd6d23686621ea/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/fan2tamo/items/18f418bd6d23686621ea/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/fan2tamo/items/18f418bd6d23686621ea/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/fan2tamo/items/18f418bd6d23686621ea/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/fan2tamo/items/18f418bd6d23686621ea.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-44ccd346-978f-48ef-9645-80114a9778fa">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-c2dfe685-32e4-4080-8d23-3c0148169e8b"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-c2dfe685-32e4-4080-8d23-3c0148169e8b">{}</script>
      
<div id="LoginModal-react-component-1bfbaea8-04f8-4d46-a1d1-2221674587c4"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-1bfbaea8-04f8-4d46-a1d1-2221674587c4">{}</script>
      
<div id="StockModal-react-component-77353dfb-3133-4bcd-bcb1-78ab0785d5d2"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-77353dfb-3133-4bcd-bcb1-78ab0785d5d2">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;rLYw8omNMansjPnvS7z1jGcwUS0zqpQVsEjKbw7xbqdDyDKGqIYn9levibbKU49p8cc4iqdS5YPOcflYepEoEw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003eこの記事は、OpenVINOをC#で使うための記事です。\u003cbr\u003e\n内容としては、過去に書いた\u003ca href=\"https://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54\" id=\"reference-09e5468a92daa7f0e7aa\"\u003eC++で実行するOepnVinoによる手書き文字認識(MNIST)\u003c/a\u003eの内容を、最新バージョン(2021.2)向けに更新したものになっています。\u003cbr\u003e\nまた、それだけだとただの焼き直しになるので、C++とPythonのインターフェースしか用意されていないOpenVINOをC#から使えるようにしてみました。\u003cbr\u003e\n説明はしていませんが、dllをC++から使うアプリも一緒に公開していますので、必要があればそちらも見てください。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"構成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A7%8B%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e構成\u003c/h2\u003e\n\n\u003cp\u003eこの記事は以下5つのパートに分かれます。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"#1_%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E8%AD%98%E5%88%A5%E5%99%A8%E3%81%AE%E7%94%9F%E6%88%90\"\u003e学習済みモデル(識別器)の生成\u003c/a\u003e\u003cbr\u003e\nKerasというフレームワークを使って学習済みモデルを生成します。\u003cbr\u003e\n内容としては\u003ca href=\"https://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54\"\u003eC++で実行するOepnVinoによる手書き文字認識(MNIST)\u003c/a\u003eに沿っていますが、フレームワークをChainerからKerasに変更しています。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"#2_%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%82%92openvino%E3%81%8C%E6%89%B1%E3%81%88%E3%82%8B%E5%BD%A2%E5%BC%8F%E3%81%AB%E5%A4%89%E6%8F%9B\"\u003e学習済みモデルをOpenVINOが扱える形式に変換\u003c/a\u003e\u003cbr\u003e\nKerasで作成した学習済みモデルをOpenNINO付属のModel Optimizerで変換します。\u003cbr\u003e\n内容としては\u003ca href=\"https://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54\"\u003eC++で実行するOepnVinoによる手書き文字認識(MNIST)\u003c/a\u003eに沿っています。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"#3_openvino%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8Bdll(c)%E3%82%92%E4%BD%9C%E6%88%90\"\u003eOpenVINOを使って推論するdll(C++)を作成\u003c/a\u003e\u003cbr\u003e\nOpenVINOを扱うクラスを実装します。\u003cbr\u003e\n内容としては\u003ca href=\"https://qiita.com/fan2tamo/items/8f110a22d47cb684f33d\" id=\"reference-d3b15ace5e25e3d00eb8\"\u003eC++で作成したDLLでAPIではなくクラスを提供する方法\u003c/a\u003eに沿っています。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"#4_swig%E3%81%A7C%E5%90%91%E3%81%91%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0\"\u003eSwigでC#向けのインターフェースを追加\u003c/a\u003e\u003cbr\u003e\n3.で作ったdllにSwigを使いC#向けのインターフェースを追加します。\u003cbr\u003e\n内容としては\u003ca href=\"https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb\" id=\"reference-0faad972bb5e352bc039\"\u003eC++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法\u003c/a\u003eに沿っています。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"#5_swig%E3%81%A7c%E5%90%91%E3%81%91%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9Fdll%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8B%E3%82%A2%E3%83%97%E3%83%AA(c)%E3%82%92%E4%BD%9C%E6%88%90\"\u003eSwigでC#向けインターフェースを追加したdllを使って推論するアプリ(C#)を作成\u003c/a\u003e\u003cbr\u003e\nC#で作ったdllを使うアプリを作ります。\u003cbr\u003e\n内容としては\u003ca href=\"https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb\"\u003eC++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法\u003c/a\u003eに沿っています。\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"環境\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%92%B0%E5%A2%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e環境\u003c/h2\u003e\n\n\u003cp\u003eこのエントリを書いている私の環境は以下です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eOS : Windows10 Pro x64 20H2\u003c/li\u003e\n\u003cli\u003eCPU : Intel\u003c/li\u003e\n\u003cli\u003eGPU : あり(NVIDIA)\n\n\u003cul\u003e\n\u003cli\u003eCUDA : 10.1\u003c/li\u003e\n\u003cli\u003ecuDNN : 7.6.5\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eVPU : あり(Movidius Neural Compute Stick 2)\u003c/li\u003e\n\u003cli\u003eVisual Studio Pro: 2019\u003c/li\u003e\n\u003cli\u003eOpenVino : 2021.2\u003c/li\u003e\n\u003cli\u003ePython3 : 3.7.9\n\n\u003cul\u003e\n\u003cli\u003eKeras : 2.4.3\u003c/li\u003e\n\u003cli\u003eonnx : 1.8.0\u003c/li\u003e\n\u003cli\u003eonnx2keras : 0.0.24\u003c/li\u003e\n\u003cli\u003eopencv-python : 4.4.0.46\u003c/li\u003e\n\u003cli\u003eopencv-contrib-python : 4.4.0.46\u003cbr\u003e\n\u003c/li\u003e\n\u003cli\u003etendorflow : 2.3.0(GPUがない場合のみ)\u003c/li\u003e\n\u003cli\u003etensorflow-gpu : 2.3.0(GPUがある場合のみ)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eSwig : 4.0.2\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eCUDAとcuDNNはお使いのtensorflow-GPUのバージョンで変えてください。\u003cbr\u003e\n\u003ca href=\"https://www.tensorflow.org/install/source_windows?hl=ja\" rel=\"nofollow noopener\" target=\"_blank\"\u003eここに対応表\u003c/a\u003eがあります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"openvinoを使う理由について\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#openvino%E3%82%92%E4%BD%BF%E3%81%86%E7%90%86%E7%94%B1%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eOpenVINOを使う理由について\u003c/h1\u003e\n\n\u003cp\u003e近年、KerasやPyTorchなどのDeep Learningフレームワークが登場したことにより、手軽に個人でDeep Learning(学習フェーズと推論フェーズ)を実行できるようになりつつありますが、個人では以下の理由により製品適用レベルの学習済みモデルを作成することはまだハードルが高いです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e十分な量・質の学習データを用意する必要がある\u003c/li\u003e\n\u003cli\u003e専門的な知識がないとどのようなネットワークにすれば良いのか判断できない\u003c/li\u003e\n\u003cli\u003e高性能な外付けGPU(dGPU)がないと学習に時間がかかる\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eまた、学習済みモデルさえ用意できれば推論フェーズは個人で十分に実行可能ではあるのですが、推論自体も処理負荷が軽いわけではないために非力なデバイスで実行すると思った通りの速度がでない、もしくはCPU負荷が100%付近に張り付きユーザービリティの低下を招くという状況になってしまいます。\u003cbr\u003e\nそのため、解決策の一つして今回はIntel社のOpenVINOを使用します。\u003cbr\u003e\nOpenVINOを使用することで、以下が可能になります。\u003cbr\u003e\n- CPU以外のデバイス(iGPU, VPU, FPGA)での推論\u003cbr\u003e\n- CPUで実施する推論処理の高速化\u003c/p\u003e\n\n\u003cp\u003e具体的には、CPUが非力で推論を実行するとCPU負荷が100%になってしまう場合、VPU(Movidius Neural Compute Stick)を接続してVPUで推論することによりCPUには負荷をかけずに推論というようなことが可能になります。\u003c/p\u003e\n\n\u003cp\u003eなお、OpenVINOはIntelが出しているため、上で記載しているCPU、iGPU、VPU、FPGAとはIntel製のものがターゲットになります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"1-学習済みモデル識別器の生成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E8%AD%98%E5%88%A5%E5%99%A8%E3%81%AE%E7%94%9F%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. 学習済みモデル(識別器)の生成\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"問題設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%95%8F%E9%A1%8C%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e問題設定\u003c/h2\u003e\n\n\u003cp\u003e今回はMNISTという手書き数字(0～9)を学習させて、入力された数字が0～9のどれなのか当てるという分類問題とします。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/4fc3b543c42fefe1398e66a81059a609562ba64c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332393339322f65366237383032392d303038312d643362652d633939622d6462383963363462323961332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2Fe6b78029-0081-d3be-c99b-db89c64b29a3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ada3a4552a82af11570f66366b23d25d\" alt=\"mnist.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/329392/e6b78029-0081-d3be-c99b-db89c64b29a3.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2Fe6b78029-0081-d3be-c99b-db89c64b29a3.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=49ffd70e6ed2add577465a01a5a1981b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eデータ自体はAPI一発でダウンロードできるため、簡単に利用することが可能です。\u003cbr\u003e\n学習・検証には公開されているデータを使い、テストには私がペイントで作ったデータを使うこととします。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ネットワーク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eネットワーク\u003c/h2\u003e\n\n\u003cp\u003eニューラルネットワークは、入力層と隠れ層(中間層)、出力層を決める必要がありますが、その前にNCHWの説明をします。\u003cbr\u003e\nNCHWとはそれぞれ以下を示します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eN : バッチサイズ\u003c/li\u003e\n\u003cli\u003eC : チャネル数(カラー画像では3、グレースケールでは1)\u003c/li\u003e\n\u003cli\u003eH : 画像の高さ\u003c/li\u003e\n\u003cli\u003eW : 画像の幅\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eNCHW：1x3x224x224という感じで使われる用語なので覚えておいてください。\u003cbr\u003e\nさて入力層ですがMNISTは手書き数字のデータセットで、1枚は28x28のグレースケールですので素直に作るとNx1x28x28となります。\u003cbr\u003e\nが、今回はわざわざカラー画像として入力したいと思いますのでNx3x28x28となります。\u003cbr\u003e\nNは実際に学習させる時にメモリに載るサイズまで増やしていきましょう。\u003cbr\u003e\n隠れ層は、各自自由に作ってみて精度が出なければ層を深くするなり、畳み込みをするなり、工夫してみてください。\u003cbr\u003e\n最後の出力層ですが、最終的に入力した画像が0～9のどれなのかを識別したいので、Nx10となります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h2\u003e\n\n\u003cp\u003e今回はJupyter Notebook上で試していますのでそれぞれのセルごとに説明していきます。\u003cbr\u003e\nなおMNIST-Keras.ipynbというファイル名で\u003ca href=\"https://github.com/fan2tamo/OpenVINOApp\" rel=\"nofollow noopener\" target=\"_blank\"\u003eここに格納\u003c/a\u003eしています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"import\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#import\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eimport\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"python\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ekeras.datasets\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003emnist\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ekeras.utils\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eto_categorical\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ekeras.layers\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eDense\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eConvolution2D\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMaxPooling2D\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eInput\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBatchNormalization\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eGlobalAveragePooling2D\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ekeras.layers\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eReLU\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ekeras\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eModel\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ekeras.callbacks\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eEarlyStopping\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ekeras.optimizers\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eAdam\u003c/span\u003e\n\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003ekeras2onnx\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ekeras2onnx\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003econvert_keras\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003eonnx\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003esave_model\u003c/span\u003e\n\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003enumpy\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003enp\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003etensorflow.python.keras\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003ebackend\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003eK\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eKerasなど必要なものをimportしています。\u003cbr\u003e\nここでエラーになる場合は必要なパッケージが足りていませんので、エラーに従って適宜入れてください。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"gpuが接続されているか確認\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#gpu%E3%81%8C%E6%8E%A5%E7%B6%9A%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E7%A2%BA%E8%AA%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eGPUが接続されているか確認\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"python\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003etensorflow.python.client\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003edevice_lib\u003c/span\u003e\n\u003cspan class=\"n\"\u003edeviceStr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edevice_lib\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elist_local_devices\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n\u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eFalse\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"s\"\u003e\"GPU\"\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003edeviceStr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003eTrue\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"*** isGPU == {} ***\"\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003eformat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"k\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edeviceStr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eGPUが接続されているかチェックしています。\u003cbr\u003e\nGPUの接続が確認できればisGPUをTrueと、確認できなければFalseとしています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"学習検証用データの作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AD%A6%E7%BF%92%E6%A4%9C%E8%A8%BC%E7%94%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e学習・検証用データの作成\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"python\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e# データ取得\n\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_train\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ey_train\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_test\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ey_test\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emnist\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eload_data\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ex_train_shape\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_train\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex_test_shape\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_test\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# reshape([?, 28, 28] -\u0026gt; [?, 1, 28, 28])\n\u003c/span\u003e\u003cspan class=\"n\"\u003ex_train\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_train\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ereshape\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_train_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_train_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ex_train_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex_test\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_test\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ereshape\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_test_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex_test_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ex_test_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# データの色情報を1次元から3次元に拡張([?, 1, 28, 28] -\u0026gt; [?, 3, 28, 28])\n# グレースケールからカラーに拡張することになるが、色情報は同じ値としている\n\u003c/span\u003e\u003cspan class=\"n\"\u003ex_train\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_train\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex_test\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_test\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"channels_first\"\u003c/span\u003e\n    \u003cspan class=\"n\"\u003einput_shape\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"channels_last\"\u003c/span\u003e\n    \u003cspan class=\"n\"\u003einput_shape\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex_train\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etranspose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_train\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ex_test\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etranspose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_test\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ex_train\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_train\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eastype\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e'float32'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex_test\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex_test\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eastype\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e'float32'\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex_train\u003c/span\u003e \u003cspan class=\"o\"\u003e/=\u003c/span\u003e \u003cspan class=\"mi\"\u003e255\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex_test\u003c/span\u003e \u003cspan class=\"o\"\u003e/=\u003c/span\u003e \u003cspan class=\"mi\"\u003e255\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003enum_classes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e10\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# convert class vectors to binary class matrices\n\u003c/span\u003e\u003cspan class=\"n\"\u003ey_train\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eto_categorical\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey_train\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enum_classes\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ey_test\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eto_categorical\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ey_test\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enum_classes\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここでは3つのポイントがあります。\u003cbr\u003e\n- チャネルを1チャネルから3チャネルへ\u003cbr\u003e\n　　これはテスト用画像をペイントで作る時にグレースケール画像(1チャネルの意味)を作れないからです。\u003cbr\u003e\n- isGPU==FalseならNCHWからNHWCへ\u003cbr\u003e\n　　CPUではNCHWに対応していないため。\u003cbr\u003e\n　　なお、GPUはNHWCにも対応していますが、速度が遅くなります。\u003cbr\u003e\n- 画像の取りうる値を[0,255]から[0.0, 1.0]へ\u003cbr\u003e\n　　精度を上げるため。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ネットワーク定義\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E5%AE%9A%E7%BE%A9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eネットワーク定義\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"python\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eBN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003egpu\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003egpu\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eBatchNormalization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaxis\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eBatchNormalization\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaxis\u003c/span\u003e\u003cspan class=\"o\"\u003e=-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e   \n\n\u003cspan class=\"n\"\u003einput_layer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eInput\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003einput_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvolution2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"same\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einput_shape\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003einput_shape\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003einput_layer\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReLU\u003c/span\u003e\u003cspan class=\"p\"\u003e()(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvolution2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"same\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReLU\u003c/span\u003e\u003cspan class=\"p\"\u003e()(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMaxPooling2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epool_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"same\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvolution2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e128\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"same\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReLU\u003c/span\u003e\u003cspan class=\"p\"\u003e()(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvolution2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e128\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"same\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReLU\u003c/span\u003e\u003cspan class=\"p\"\u003e()(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMaxPooling2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epool_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvolution2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e512\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"same\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReLU\u003c/span\u003e\u003cspan class=\"p\"\u003e()(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvolution2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e512\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekernel_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003epadding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"same\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eReLU\u003c/span\u003e\u003cspan class=\"p\"\u003e()(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMaxPooling2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epool_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGlobalAveragePooling2D\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003edata_format\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDense\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e128\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eactivation\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e'relu'\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003eoutput\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDense\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enum_classes\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eactivation\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e'softmax'\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003emodel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eModel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einput_layer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003ecompile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloss\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e'categorical_crossentropy'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n              \u003cspan class=\"n\"\u003eoptimizer\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eAdam\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n              \u003cspan class=\"n\"\u003emetrics\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e'accuracy'\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eネットワーク全体は上記としました。\u003cbr\u003e\n上記ネットワークはCPUで実行すると時間がかかりますので、GPUがない方はGoogle Colabを使うなり、時間がかからないようにネットワークを変更するなりしてください。\u003cbr\u003e\n最適化関数はAdamとしています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"学習\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AD%A6%E7%BF%92\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e学習\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"python\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003ehistory\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_train\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ey_train\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebatch_size\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eepochs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e30\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003everbose\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecallbacks\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eEarlyStopping\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emonitor\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e'val_loss'\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epatience\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003everbose\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emode\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e'auto'\u003c/span\u003e\u003cspan class=\"p\"\u003e)],\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003evalidation_data\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex_test\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ey_test\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eEpochを進めて検証用データでのlossとaccuracyが改善していることを確認してください。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"テスト\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%86%E3%82%B9%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eテスト\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"python\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e  \u003cspan class=\"nn\"\u003eglob\u003c/span\u003e\n\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003ecv2\u003c/span\u003e\n\u003cspan class=\"n\"\u003eimageFilePaths\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eglob\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eglob\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\"\"OpenVINOApp\\OpenVINOAppCpp\\Data\\Image\\*.png\"\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003eimageFilePath\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eimageFilePaths\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eimage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecv2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eimread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimageFilePath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eimage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etranspose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e \n        \u003cspan class=\"n\"\u003eimage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ereshape\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eimage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ereshape\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eimage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eimage\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"mf\"\u003e255.0\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eoutputs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epredict\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"-------   {0}  -----------\"\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003eformat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimageFilePath\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"nb\"\u003eenumerate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]):\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"[{0}] = {1:.4f}\"\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003eformat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e実際にペイントで作った3x28x28の画像を入力し、それぞれどの数字と予測したのかを表示しています。\u003cbr\u003e\n今学習したモデルで正解しているかを確認してください。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"学習済みモデルの保存\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BF%9D%E5%AD%98\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e学習済みモデルの保存\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"python\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e# .h5で保存\n\u003c/span\u003e\u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esave\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"mnist.h5\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esave_format\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"h5\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eisGPU\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# .onnxで保存\n\u003c/span\u003e    \u003cspan class=\"n\"\u003eonnx_model\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econvert_keras\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003echannel_first_inputs\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e28\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esave_model\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eonnx_model\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"mnist.onnx\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# .pbで保存\n\u003c/span\u003e    \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003etensorflow\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003etf\u003c/span\u003e\n    \u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003etensorflow\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003ekeras\u003c/span\u003e\n    \u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003etensorflow.python.framework.convert_to_constants\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003econvert_variables_to_constants_v2\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e#path of the directory where you want to save your model\n\u003c/span\u003e    \u003cspan class=\"n\"\u003efrozen_out_path\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e''\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e# Convert Keras model to ConcreteFunction\n\u003c/span\u003e    \u003cspan class=\"n\"\u003efull_model\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elambda\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efull_model\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efull_model\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget_concrete_function\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTensorSpec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einputs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eshape\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einputs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003edtype\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# Get frozen ConcreteFunction\n\u003c/span\u003e    \u003cspan class=\"n\"\u003efrozen_func\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econvert_variables_to_constants_v2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efull_model\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efrozen_func\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egraph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eas_graph_def\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elayers\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003eop\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003efrozen_func\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egraph\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget_operations\u003c/span\u003e\u003cspan class=\"p\"\u003e()]\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e# Save frozen graph to disk\n\u003c/span\u003e    \u003cspan class=\"n\"\u003etf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eio\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite_graph\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egraph_or_graph_def\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003efrozen_func\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egraph\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                      \u003cspan class=\"n\"\u003elogdir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003efrozen_out_path\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                      \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"mnist.pb\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                      \u003cspan class=\"n\"\u003eas_text\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"bp\"\u003eFalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# Save its text representation\n\u003c/span\u003e    \u003cspan class=\"n\"\u003etf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eio\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite_graph\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egraph_or_graph_def\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003efrozen_func\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egraph\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                      \u003cspan class=\"n\"\u003elogdir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003efrozen_out_path\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                      \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"mnist.pbtxt\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                      \u003cspan class=\"n\"\u003eas_text\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"bp\"\u003eTrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまず、普通にKerasの機能で学習済みモデルを保存(mnist.h5)しています。\u003cbr\u003e\nただしh5形式の学習済みモデルはOpenVINOでは使えないため、ONNX形式かpb形式に一旦した後にIR形式というOpenVINO専用の形式にする必要があります。\u003cbr\u003e\nなお、NHWCをONNX形式で保存してもうまくIR形式に変換できなかったので、NHWCの場合はpb形式で保存するようにしています。\u003c/p\u003e\n\n\u003cp\u003eこれで学習済みモデルを作成する部分は完了です。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"学習済みモデルをopenvinoが扱える形式に変換\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%82%92openvino%E3%81%8C%E6%89%B1%E3%81%88%E3%82%8B%E5%BD%A2%E5%BC%8F%E3%81%AB%E5%A4%89%E6%8F%9B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e学習済みモデルをOpenVINOが扱える形式に変換\u003c/h1\u003e\n\n\u003cp\u003eOpenVinoはONNX形式の学習済みモデルを動かすことはできず、IR形式と呼ばれる専用の形式で記述された学習済みモデルでしか動作させることができません。そのため、ONNX形式をIR形式に変換する必要があります。ここが皆さんが遭遇する最初の山かもしれません。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.openvinotoolkit.org/latest/openvino_docs_install_guides_installing_openvino_windows.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式ページ\u003c/a\u003eに沿ってやっていきましょう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"openvinoのインストール\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#openvino%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eOpenVinoのインストール\u003c/h2\u003e\n\n\u003cp\u003e公式ページにそのものずばりがありますので割愛します。\u003cbr\u003e\n公式ページ以外ですと、以下2つを紹介しておきます。\u003cbr\u003e\n- \u003ca href=\"https://openvino.jp/2021-1-on-win10/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eOpenVINO 2021.1 環境構築（Windows 10編）\u003c/a\u003e\u003cbr\u003e\n- \u003ca href=\"https://qiita.com/hanapage/items/a2f76d97bed0204d3819\" id=\"reference-4972cca5c4e82b09b6f4\"\u003eOpenVINO (2019.R1) Windows10版のインストールとサンプルのテスト\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"環境設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e環境設定\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.openvinotoolkit.org/latest/openvino_docs_install_guides_installing_openvino_windows.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式ページ\u003c/a\u003eによると、\"setupvars.bat\"を実行する必要があると記載されいるので、さっそく実行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"go\"\u003ecd /d \"C:\\Program Files (x86)\\Intel\\openvino_2021\\bin\"\nsetupvars.bat\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e次に変換に必要なパッケージをインストールしますが、ONNX形式をIR形式にするのか、それともpb形式をIR形式にするのかで必要となるパッケージが異なります。\u003c/p\u003e\n\n\u003cp\u003eONNX形式の場合は以下を実行してください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"go\"\u003ecd /d \"C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\model_optimizer\\install_prerequisites\"\ninstall_prerequisites_onnx.bat\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003epb形式の場合ですが、今回はKeras(Tensorflow2)でpb形式の学習済みモデルを作ったので、install_prerequisites_tf2.batを実行することになります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"変換\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A4%89%E6%8F%9B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e変換\u003c/h2\u003e\n\n\u003cp\u003eようやくIR形式に変換していきます。\u003cbr\u003e\n\u003ca href=\"https://docs.openvinotoolkit.org/latest/openvino_docs_MO_DG_prepare_model_convert_model_Converting_Model_General.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこのページ\u003c/a\u003eを参照しながら変換していきましょう。\u003c/p\u003e\n\n\u003cp\u003e上記ページをみると、以下のコマンドで変換ができると記載があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003epython3 mo.py --input_model INPUT_MODEL\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eまた必要なオプションも記載してありますので各自試してみてください。\u003cbr\u003e\n最終的に私が点けたオプションは以下の通りです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e--framework onnx (pb形式の時はtf)\u003c/li\u003e\n\u003cli\u003e--output_dir xxx (出力先は適宜指定してください)\u003c/li\u003e\n\u003cli\u003e--b 1\u003c/li\u003e\n\u003cli\u003e--data_type FP16\u003c/li\u003e\n\u003cli\u003e--scale_values [255,255,255]\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003e--data_type FP16\u003c/strong\u003eは1つのモデルでCPU、GPU、VPUでの推論を可能にするためです。\u003cbr\u003e\n各デバイスで対応しているdata_typeは以下ページ内のSupported Model Formatsセクションに記載されています。\u003cbr\u003e\n\u003ca href=\"https://docs.openvinotoolkit.org/latest/openvino_docs_IE_DG_supported_plugins_Supported_Devices.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eSupported Devices\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e--scale_values [255,255,255]\u003c/strong\u003eは入力された画像の値をコード上で255で割る手間を省くためです。\u003c/p\u003e\n\n\u003cp\u003eONNX形式時に実行したコマンドは以下の通りです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"go\"\u003epython mo.py --framework onnx --input_model mnist.onnx --output_dir \"C:\\Work\\\" --b 1 --data_type FP16 --scale_values [255,255,255]\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e上記を実行するとC:\\Work\\に以下のファイルが作成されていることが確認できます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003emnist.xml\u003c/li\u003e\n\u003cli\u003emnist.bin\u003c/li\u003e\n\u003cli\u003emnist.mapping\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこれでModel Optimaizerによる変換は完了です。\u003cbr\u003e\n今までのコマンドを自動で実行するバッチをconvertModel.batというファイル名で置いていますので面倒な人はそっちを使っても良いです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"3-openvinoを使って推論するdllcを作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3-openvino%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8Bdllc%E3%82%92%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3. OpenVINOを使って推論するdll(C++)を作成\u003c/h1\u003e\n\n\u003cp\u003eようやくIR形式の学習済みモデルが作成できましたので、推論をする部分を作っていきます。\u003cbr\u003e\n推論用のコードはC++かPythonで書くことができます。\u003cbr\u003e\nPythonで説明しているQiitaのエントリは我ら(また勝手に\"我らが\"とか言ってすみません)が\u003ca href=\"https://qiita.com/PINTO\"\u003ePINTO\u003c/a\u003eさんを筆頭に良質なエントリがありますし、私は最終的にC#を使って推論をしたいため、今回はC++推論用のdllを作り、それをC#で使うことを目指します。\u003c/p\u003e\n\n\u003cp\u003eなにはともあれ、\u003ca href=\"https://docs.openvinotoolkit.org/latest/_docs_IE_DG_Integrate_with_customer_application_new_API.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eInference Engineの説明ページ\u003c/a\u003eを見てみます。\u003cbr\u003e\n上記ページによると以下の流れで推論を実施することになります。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"#1-initialize-core\"\u003eInitialize Core\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#2-read-model-ir\"\u003eRead Model IR\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#3-configure-input--output\"\u003eConfigure Input \u0026amp; Output\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#4-load-model\"\u003eLoad Model\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#5-create-infer-request\"\u003eCreate Infer Request\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#6-prepare-input\"\u003ePrepare Input\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#7-do-inference\"\u003eDo Inference\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e順にコードに落としていきます。\u003cbr\u003e\n今回はMyOpenVINOImplというクラスを定義して、そこに推論機能を実装してGetInstance()というAPIでMyOpenVINOImplクラスのインスタンスを取得して使うことを想定しています。\u003cbr\u003e\ndll自体の作り方は\u003ca href=\"https://qiita.com/fan2tamo/items/8f110a22d47cb684f33d\"\u003eC++で作成したDLLでAPIではなくクラスを提供する方法\u003c/a\u003eに沿っていますのでそちらを参照してください。\u003cbr\u003e\nここではOpenVINOのAPIを使う部分にフォーカスして説明します。\u003cbr\u003e\nなお、不明な個所があったら、\u003ca href=\"https://docs.openvinotoolkit.org/latest/_docs_IE_DG_Integrate_with_customer_application_new_API.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eInference Engineの説明ページ\u003c/a\u003eを参照してください。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実装-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"1-initialize-core\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-initialize-core\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. Initialize Core\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCore\u003c/span\u003e \u003cspan class=\"n\"\u003ecore\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCNNNetwork\u003c/span\u003e \u003cspan class=\"n\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eExecutableNetwork\u003c/span\u003e \u003cspan class=\"n\"\u003eexecutableNetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eただの宣言ですね。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"2-read-model-ir\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2-read-model-ir\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2. Read Model IR\u003c/h3\u003e\n\n\u003cp\u003eここではモデルの読み込みを実施しています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eMyOpenVINOImpl\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eReadNetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emodelName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodelName\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\".onnx\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003enpos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// IR\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ebinName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emodelName\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esubstr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emodelName\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\".bin\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enetwork\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReadNetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodelName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebinName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// onnx\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enetwork\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReadNetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emodelName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003edetails\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferenceEngineException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Error ReadNetwork() : %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewhat\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(...)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Error ReadNetwork() \u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e引数のmodelNameには.xmlファイルのパスを渡します。\u003cbr\u003e\nそのため、学習済みモデルとして必要なものは.xmlファイルと.binファイルの2つです。\u003cbr\u003e\nIR形式に変換する際に.mappingファイルが作成されていますが、不要です。\u003cbr\u003e\nまた、実はONNX形式もそのまま読み込めるようなので実装したんですが、未試行なので動くか不明です。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"3-configure-input--output\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3-configure-input--output\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3. Configure Input \u0026amp; Output\u003c/h3\u003e\n\n\u003cp\u003eここでは入力と出力の形状(NCHWとか)とデータ型(FP32とか)を設定します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eMyOpenVINOImpl\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eSetNetworkConfiguration\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003eLayout\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e  \u003cspan class=\"n\"\u003eiLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003ePrecision\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eiPrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003eLayout\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eoLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003ePrecision\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eoPrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003einputLayerData\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetInputsInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esecond\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eLayout\u003c/span\u003e \u003cspan class=\"n\"\u003eil\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvertInferenceEngineLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ePrecision\u003c/span\u003e \u003cspan class=\"n\"\u003eip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvertInferenceEnginePrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eiPrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einputLayerData\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esetLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eil\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einputLayerData\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esetPrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eip\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einputLayerName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"n\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetInputsInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efirst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ec_str\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einputLayout\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eiLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einputPresicion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eiPrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eauto\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputLayerData\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetOutputsInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esecond\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eLayout\u003c/span\u003e \u003cspan class=\"n\"\u003eol\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvertInferenceEngineLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ePrecision\u003c/span\u003e \u003cspan class=\"n\"\u003eop\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvertInferenceEnginePrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoPrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoutputLayerData\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esetLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eol\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoutputLayerData\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esetPrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoutputLayerName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"n\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetOutputsInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efirst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ec_str\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(...)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Error SetNetworkConfiguration()\u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ePythonで学習させた時に形状とデータ型をどうしていたのか思い出して、それを指定するだけです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"4-load-model\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4-load-model\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4. Load Model\u003c/h3\u003e\n\n\u003cp\u003e実行可能なネットワークを作成します。\u003cbr\u003e\n特に何も考えずにこのまま実行しましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eMyOpenVINOImpl\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eLoadNetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003evector\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDevice\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003edevices\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eisMulti\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003edeviceStr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eConvertDevices2String\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edevices\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisMulti\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eexecutableNetwork\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecore\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLoadNetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edeviceStr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(...)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Error : LoadNetwork()\u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"5-create-infer-request\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#5-create-infer-request\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5. Create Infer Request\u003c/h3\u003e\n\n\u003cp\u003eここでは推論を実行するオブジェクトを作成します。\u003cbr\u003e\nここも特に何も考えずにこのまま実行しましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferRequest\u003c/span\u003e \u003cspan class=\"n\"\u003eMyOpenVINOImpl\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateInferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferRequest\u003c/span\u003e \u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eexecutableNetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateInferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(...)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"6-prepare-input\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#6-prepare-input\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e6. Prepare Input\u003c/h3\u003e\n\n\u003cp\u003ematU8ToBlob()でデータをセットしています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eMyOpenVINOImpl\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eSetInputData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferRequest\u003c/span\u003e  \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eimageName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eMat\u003c/span\u003e \u003cspan class=\"n\"\u003eimageData\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eimread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimageName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eBlob\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003ePtr\u003c/span\u003e \u003cspan class=\"n\"\u003einputBlob\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetBlob\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einputLayerName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ematU8ToBlob\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003euint8_t\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimageData\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einputBlob\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"7-do-inference\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#7-do-inference\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e7. Do Inference\u003c/h3\u003e\n\n\u003cp\u003e推論を実行します。\u003cbr\u003e\n同期の場合はInferSync()を呼び出すだけで、推論が終了するまで待たされて結果が返ってきます。\u003cbr\u003e\n非同期の場合はInferASync()を呼び出すとすぐ制御が返りますが、推論の実態はInferASyncLocal()でされて結果はコールバックで渡されます。\u003cbr\u003e\nなお、事前に結果を返すコールバックを登録しておく必要があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// 推論(同期)\u003c/span\u003e\n\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003evector\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eMyOpenVINOImpl\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferSync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eimageName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferRequest\u003c/span\u003e \u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateInferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eSetInputData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimageName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInfer\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003evector\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputVect\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eSizeVector\u003c/span\u003e \u003cspan class=\"n\"\u003edims\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetBlob\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputLayerName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003egetTensorDesc\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003egetDims\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eoneHotVector\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetBlob\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputLayerName\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eas\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edims\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoutputVect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epush_back\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoneHotVector\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputVect\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 推論(非同期)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eMyOpenVINOImpl\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferASync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eimageName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003einferID\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einferCounter\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003einferCounter\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferRequest\u003c/span\u003e \u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateInferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eInferInfo\u003c/span\u003e \u003cspan class=\"n\"\u003einferInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimageName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003einferMap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003einferID\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einferInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"kr\"\u003ethread\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 現状はInferASync()が実行されるたびにスレッドを作ってその中でStartAsync()をしている。\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// スレッドを作るコストは高いので、本当はthreadNumだけWorkerスレッド作って、ということをするべき。\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"kr\"\u003ethread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eMyOpenVINOImpl\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferASyncLocal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einferID\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ethreadVector\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epush_back\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003emove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eth\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003einferID\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e  \u003cspan class=\"n\"\u003eMyOpenVINOImpl\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eInferASyncLocal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003einferID\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003esuccessed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003evector\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputVect\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003einputImage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eInferInfo\u003c/span\u003e \u003cspan class=\"n\"\u003einferInfo\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einferMap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003einferID\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einputImage\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einferInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einputImage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSetInputData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einferInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einputImage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einferInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStartAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e        \n        \u003cspan class=\"n\"\u003einferInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eIInferRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eWaitMode\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eRESULT_READY\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eInferenceEngine\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eSizeVector\u003c/span\u003e \u003cspan class=\"n\"\u003edims\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einferInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetBlob\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputLayerName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003egetTensorDesc\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003egetDims\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eoneHotVector\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einferInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einferRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetBlob\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputLayerName\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eas\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edims\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003edim\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eoutputVect\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epush_back\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoneHotVector\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(...)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esuccessed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epCallbackHandler\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epCallbackHandler\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eInferCallBack\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einferID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einputImage\u003c/span\u003e  \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esuccessed\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"n\"\u003eoutputVect\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ビルド\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%93%E3%83%AB%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eビルド\u003c/h2\u003e\n\n\u003cp\u003eVisual Studioでビルドするのですが、そのままではビルド出来ないため以下を設定します。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003e項目\u003c/th\u003e\n\u003cth style=\"text-align: left\"\u003e内容\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eアーキテクチャ\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003ex64\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e追加のインクルードディレクトリ\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e- C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\inference_engine\\include\\ \u003cbr\u003e - C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\include\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e追加の依存ファイル\u003c/td\u003e\n\u003ctd style=\"text-align: left\"\u003e\n\u003cstrong\u003eDebug\u003c/strong\u003e\u003cbr\u003e - C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\inference_engine\\lib\\intel64\\Debug\\inference_engined.lib \u003cbr\u003e - C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\lib\\opencv_imgproc451d.lib \u003cbr\u003e - C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\lib\\opencv_core451d.lib \u003cbr\u003e - C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\lib\\opencv_imgcodecs451d.lib \u003cbr\u003e \u003cbr\u003e  \u003cstrong\u003eRelease\u003c/strong\u003e \u003cbr\u003e - C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\inference_engine\\lib\\intel64\\Release\\inference_engine.lib \u003cbr\u003e - C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\lib\\opencv_imgproc451.lib \u003cbr\u003e - C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\lib\\opencv_core451.lib \u003cbr\u003e - C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\lib\\opencv_imgcodecs451.lib\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eまた、出力ディレクトリを以下に変更しています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e$(ProjectDir)$(Platform)\\$(Configuration)\\\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eC#側がdllを使う際に作成したdll(MyOpenVINO.dll)をコピーするのですが、dllが置かれている場所が異なるとコピーできませんの注意してください。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"dumpbin\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dumpbin\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003edumpbin\u003c/h2\u003e\n\n\u003cp\u003eビルドに成功したのでdllが作成されましたが、どのようなAPIが使えるのか確認してみましょう。\u003cbr\u003e\nVisual Studioに付属しているDeveloper Command Prompt for VS2019を起動してみます。\u003cbr\u003e\n(お使いの環境によっては開発者コマンドプロンプトという名称かもしれません)\u003c/p\u003e\n\n\u003cp\u003eDeveloper Command Prompt for VS2019を起動して、さきほど作成したdllが置いてある場所に移動してください。\u003cbr\u003e\n今回はC:\\Workに置いてあるとしています。\u003cbr\u003e\ndumpbinというコマンドでdllが公開しているAPIを確認することが出来ます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/d5bc2f9b85cc47e5e1b06511282fb97dfb461c09/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332393339322f35373036386561352d306262372d303434622d613464322d3965313264306533333236612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2F57068ea5-0bb7-044b-a4d2-9e12d0e3326a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b699ac41c84cd50cdea81950199591be\" alt=\"swig_before.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/329392/57068ea5-0bb7-044b-a4d2-9e12d0e3326a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2F57068ea5-0bb7-044b-a4d2-9e12d0e3326a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5d1802eb8e42483c5b73ae5afc0516f8 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e赤枠部分が公開しているAPIですが、GetInstanceという名前のAPIだけが公開されていることが分かります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"4-swigでc向けのインターフェースを追加\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4-swig%E3%81%A7c%E5%90%91%E3%81%91%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4. SwigでC#向けのインターフェースを追加\u003c/h1\u003e\n\n\u003cp\u003eSwigを使ってC#向けのインターフェースを追加する方法は\u003ca href=\"https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb\"\u003eC++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法\u003c/a\u003eを確認してください。\u003cbr\u003e\n最終的なインターフェースファイル(.i)は以下となります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"cm\"\u003e/* File : Swig.i */\u003c/span\u003e\n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"n\"\u003einclude\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ewindows\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"n\"\u003einclude\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003estd_string\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"n\"\u003einclude\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003estd_vector\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"n\"\u003einclude\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003earrays_csharp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"n\"\u003emodule\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edirectors\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\"1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eMyOpenVINO\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include \"MyOpenVINO.h\"\n\u003c/span\u003e\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"n\"\u003efeature\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"director\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eCallbackHandlerBase\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"cm\"\u003e/* Let's just grab the original header file here */\u003c/span\u003e\n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"n\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e\"MyOpenVINO.h\"\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"k\"\u003etemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDeviceVector\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003evector\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDevice\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"k\"\u003etemplate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efloatVector\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003evector\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e次に以下のコマンドを実行します。\u003cbr\u003e\nなお、作ったインターフェースファイル、先ほどdllを作る際に作成したヘッダファイル(MyOpenVINO.h)が同じ場所にある前提です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c++\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eswig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eexe\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ecsharp\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ecppext\u003c/span\u003e \u003cspan class=\"n\"\u003ecpp\u003c/span\u003e \u003cspan class=\"n\"\u003eSwig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで同じ場所に以下のファイルが作成されます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eSwig_wrap.cpp\u003c/li\u003e\n\u003cli\u003eSwig_wrap.h\u003c/li\u003e\n\u003cli\u003eCallbackHandlerBase.cs\u003c/li\u003e\n\u003cli\u003eDevice.cs\u003c/li\u003e\n\u003cli\u003eDeviceVector.cs\u003c/li\u003e\n\u003cli\u003efloatVector.cs\u003c/li\u003e\n\u003cli\u003eIMyOpenVINO.cs\u003c/li\u003e\n\u003cli\u003eLayout.cs\u003c/li\u003e\n\u003cli\u003eMyOpenVINO.cs\u003c/li\u003e\n\u003cli\u003eMyOpenVINOPINVOKE.cs\u003c/li\u003e\n\u003cli\u003eNetworkInfo.cs\u003c/li\u003e\n\u003cli\u003ePrecision.cs\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e作成された上記ファイルのうち、Swig_wrap.cppをMyOpenVINOプロジェクトに加えてビルドします。\u003cbr\u003e\nなお、Swig_wrap.hがSwig_wrap.cppと同じ場所にあるのであれば、Swig_wrap.hを加える必要はありませんが、同じ場所にないのであればSwig_wrap.hも加えてください。\u003cbr\u003e\nちなみにexecSwig.batというファイル名でSwigを実行するバッチを作っていますので、それを実行しても良いです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"dumpbin-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#dumpbin-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003edumpbin\u003c/h2\u003e\n\n\u003cp\u003eSwigで作成したファイルを加えてビルドしましたので、dllが公開しているAPIがどう変わったのか確認してみましょう。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/01689ce5cc9ea2fcd3d3b1217214f9167e1e6e15/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332393339322f63643662383732632d393039362d663461332d643733322d3734616338653166646462382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2Fcd6b872c-9096-f4a3-d732-74ac8e1fddb8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=723f314b48a7c533c8dd6f47ba24f7d7\" alt=\"swig_after.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/329392/cd6b872c-9096-f4a3-d732-74ac8e1fddb8.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2Fcd6b872c-9096-f4a3-d732-74ac8e1fddb8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f859459eccfe65da88d94ea6da6c7c57 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e赤枠部分が公開しているAPIですが、ものすごくAPIが追加されていることが分かりますね。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"5-swigでc向けインターフェースを追加したdllを使って推論するアプリcを作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#5-swig%E3%81%A7c%E5%90%91%E3%81%91%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9Fdll%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8B%E3%82%A2%E3%83%97%E3%83%AAc%E3%82%92%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5. SwigでC#向けインターフェースを追加したdllを使って推論するアプリ(C#)を作成\u003c/h1\u003e\n\n\u003cp\u003eSwigでC#向けインターフェースを追加したdllを使って推論するアプリ(C#)を作成する方法は\u003ca href=\"https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb\"\u003eC++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法\u003c/a\u003eを確認してください。\u003c/p\u003e\n\n\u003cp\u003eやることを簡単に書くと以下になります。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"#1-swig%E3%81%8C%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9Fcs%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E8%BF%BD%E5%8A%A0\"\u003eSwigが作成した.csファイルをプロジェクトに追加\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#2-callbackhandlerbase%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E7%B6%99%E6%89%BF%E3%81%97%E3%81%9F%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90\"\u003eCallbackHandlerBaseクラスを継承したクラスを作成\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#3-myopenvino%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96\"\u003eMyOpenVINOクラスを使って推論\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#4-dll%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99%E3%81%9F%E3%82%81%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%B3%E3%83%94%E3%83%BC\"\u003edllを動かすためのファイルをコピー\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eなお今回作成するアプリはWPF App(.NET)としていますが、コンソールでも良いので必要あれば適宜変更してください。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"1-swigが作成したcsファイルをプロジェクトに追加\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-swig%E3%81%8C%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9Fcs%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E8%BF%BD%E5%8A%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. Swigが作成した.csファイルをプロジェクトに追加\u003c/h2\u003e\n\n\u003cp\u003eプロジェクトに以下のファイルを追加してください。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eCallbackHandlerBase.cs\u003c/li\u003e\n\u003cli\u003eDevice.cs\u003c/li\u003e\n\u003cli\u003eDeviceVector.cs\u003c/li\u003e\n\u003cli\u003efloatVector.cs\u003c/li\u003e\n\u003cli\u003eIMyOpenVINO.cs\u003c/li\u003e\n\u003cli\u003eLayout.cs\u003c/li\u003e\n\u003cli\u003eMyOpenVINO.cs\u003c/li\u003e\n\u003cli\u003eMyOpenVINOPINVOKE.cs\u003c/li\u003e\n\u003cli\u003eNetworkInfo.cs\u003c/li\u003e\n\u003cli\u003ePrecision.cs\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"2-callbackhandlerbaseクラスを継承したクラスを作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2-callbackhandlerbase%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E7%B6%99%E6%89%BF%E3%81%97%E3%81%9F%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2. CallbackHandlerBaseクラスを継承したクラスを作成\u003c/h2\u003e\n\n\u003cp\u003e以下となります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e  \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eInferCallBackHandler\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eCallbackHandlerBase\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eTextBox\u003c/span\u003e \u003cspan class=\"n\"\u003etextBox\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eInferCallBackHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTextBox\u003c/span\u003e \u003cspan class=\"n\"\u003etbx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etextBox\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etbx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// dll側から呼ばれる\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eInferCallBack\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003einferID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003einputImage\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eisSuccessed\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efloatVector\u003c/span\u003e \u003cspan class=\"n\"\u003eresults\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etextBox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eAction\u003c/span\u003e\u003cspan class=\"p\"\u003e)(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etextBox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"CallBack   inferID[\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003einferID\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e] : [inputImage] = \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003einputImage\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eresults\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003etextBox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"CallBack   inferID[\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003einferID\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e] : [\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e] = \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRound\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMidpointRounding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAwayFromZero\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etextBox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"---------------------\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eInferCallBack()でUI上に配置してあるTextBoxに推論結果を表示しています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"3-myopenvinoクラスを使って推論\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3-myopenvino%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3. MyOpenVINOクラスを使って推論\u003c/h2\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eClick_InferSync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRoutedEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003edeviceStr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetCheckedRadioButtonString\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eNetworkInfo\u003c/span\u003e \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emodelName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"Model\\mnist.xml\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einputLayout\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNCHW\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einputPrecision\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eU8\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputLayout\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNC\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputPrecision\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFP32\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisMultiDevices\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edevices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eConvertString2Device\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edeviceStr\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eimages\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einputImageDir\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003einputImageFiles\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003einputImageFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimages\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// instance.GetAvailableDevices();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003einstance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003einputImage\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003einputImageFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e             \n        \u003cspan class=\"n\"\u003einstance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInferSync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einputImage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \n\n        \u003cspan class=\"n\"\u003efloatVector\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputVec\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einstance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInferSync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einputImage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etextBox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"inputImageFile : \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetFileName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einputImage\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eoutput\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eoutputVec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//textBox.Text += string.Format(\"{0} : {1:f4}\", i, outputVec[i]) + System.Environment.NewLine;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etextBox\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e  \u003cspan class=\"s\"\u003e$\"[\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e] :  \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRound\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoutput\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMidpointRounding\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAwayFromZero\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewLine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eClick_InferASync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003esender\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRoutedEventArgs\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eInferCallBackHandler\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eInferCallBackHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etextBox\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003edeviceStr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetCheckedRadioButtonString\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eNetworkInfo\u003c/span\u003e \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emodelName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"Model\\mnist.xml\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einputLayout\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNCHW\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einputPrecision\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eU8\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputLayout\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLayout\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNC\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoutputPrecision\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePrecision\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFP32\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ethreadNum\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisMultiDevices\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edevices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eConvertString2Device\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edeviceStr\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eimages\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einputImageDir\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003einputImageFiles\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003einputImageFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimages\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// instance.GetAvailableDevices();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einstance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enetworkInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einstance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetInferCallBack\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003einputImage\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003einputImageFiles\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003einstance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInferASync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einputImage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e           \n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eClick_InferSync()はInferSyncボタンクリック時に実行されるAPIで、Click_InferASync()はInferASyncボタンクリック時に実行されるAPIです。\u003c/p\u003e\n\n\u003cp\u003eあとは、UI周りをちょちょっと作成してください。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"4-dllを動かすためのファイルをコピー\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4-dll%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99%E3%81%9F%E3%82%81%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%B3%E3%83%94%E3%83%BC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4. dllを動かすためのファイルをコピー\u003c/h2\u003e\n\n\u003cp\u003eコード自体は完成し、ビルドも出来るようになったのですがdllを動かすために必要なファイルがありますので、ビルド後のイベントを使ってコピーします。\u003cbr\u003e\n以下のコマンドをビルド後イベントのコマンドラインに記載してください。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003eif \"$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eConfigurationName\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" == \"\u003c/span\u003eDebug\u003cspan class=\"s2\"\u003e\" (\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\inference_engine\\external\\tbb\\bin\\tbb_debug.dll\" \"$\u003c/span\u003e\u003cspan class=\"s2\"\u003e(TargetDir)\"\u003c/span\u003e /D /S /R /Y /I /K\n\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\ngraph\\lib\\ngraphd.dll\" \"$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eTargetDir\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" /D /S /R /Y /I /K\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\ngraph\\lib\\onnx_importerd.dll\" \"$\u003c/span\u003e\u003cspan class=\"s2\"\u003e(TargetDir)\"\u003c/span\u003e /D /S /R /Y /I /K\n\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\bin\\opencv_imgproc451d.dll\" \"$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eTargetDir\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" /D /S /R /Y /I /K\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\bin\\opencv_core451d.dll\" \"$\u003c/span\u003e\u003cspan class=\"s2\"\u003e(TargetDir)\"\u003c/span\u003e /D /S /R /Y /I /K\n\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\bin\\opencv_imgcodecs451d.dll\" \"$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eTargetDir\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" /D /S /R /Y /I /K\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\inference_engine\\bin\\intel64\\$\u003c/span\u003e\u003cspan class=\"s2\"\u003e(Configuration)\"\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003eTargetDir\u003cspan class=\"si\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"\u003c/span\u003e /D /S /R /Y /I /K\n\u003cspan class=\"go\"\u003e)\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003eif \"$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eConfigurationName\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" == \"\u003c/span\u003eRelease\u003cspan class=\"s2\"\u003e\" (\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\inference_engine\\external\\tbb\\bin\\tbb.dll\" \"$\u003c/span\u003e\u003cspan class=\"s2\"\u003e(TargetDir)\"\u003c/span\u003e /D /S /R /Y /I /K\n\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\ngraph\\lib\\ngraph.dll\" \"$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eTargetDir\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" /D /S /R /Y /I /K\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\deployment_tools\\ngraph\\lib\\onnx_importer.dll\" \"$\u003c/span\u003e\u003cspan class=\"s2\"\u003e(TargetDir)\"\u003c/span\u003e /D /S /R /Y /I /K\n\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\bin\\opencv_imgproc451.dll\" \"$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eTargetDir\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" /D /S /R /Y /I /K\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\bin\\opencv_core451.dll\" \"$\u003c/span\u003e\u003cspan class=\"s2\"\u003e(TargetDir)\"\u003c/span\u003e /D /S /R /Y /I /K\n\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\opencv\\bin\\opencv_imgcodecs451.dll\" \"$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eTargetDir\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" /D /S /R /Y /I /K\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"C:\\Program Files (x86)\\Intel\\openvino_2021\\inference_engine\\bin\\intel64\\$\u003c/span\u003e\u003cspan class=\"s2\"\u003e(Configuration)\"\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003eTargetDir\u003cspan class=\"si\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"\u003c/span\u003e /D /S /R /Y /I /K\n\u003cspan class=\"go\"\u003e)\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eSolutionDir\u003cspan class=\"o\"\u003e)\u003c/span\u003eMyOpenVINO\u003cspan class=\"se\"\u003e\\x\u003c/span\u003e64\u003cspan class=\"se\"\u003e\\$\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eConfiguration\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"se\"\u003e\\M\u003c/span\u003eyOpenVINO.dll\u003cspan class=\"s2\"\u003e\" \"\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003eTargetDir\u003cspan class=\"si\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" /D /S /R /Y /I /K\n\u003c/span\u003e\u003cspan class=\"gp\"\u003excopy \"$\u003c/span\u003e\u003cspan class=\"s2\"\u003e(SolutionDir)OpenVINOAppCpp\u003c/span\u003e\u003cspan class=\"se\"\u003e\\D\u003c/span\u003e\u003cspan class=\"s2\"\u003eata\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\"\u003c/span\u003e\u003cspan class=\"s2\"\u003e \"\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003eTargetDir\u003cspan class=\"si\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e\" /D /S /R /Y /I /K\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで動くようになったはずなので、実行してみてください。\u003cbr\u003e\n以下のような画面が表示されます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/426265af438832c534cd5063b603bfedeb2ca78d/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3332393339322f31623339663266322d393236352d396632382d626331382d3936396333393766373365642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2F1b39f2f2-9265-9f28-bc18-969c397f73ed.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2335f4d858ac6f8ece0a6c22afac5754\" alt=\"OpenVINOAppNet.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/329392/1b39f2f2-9265-9f28-bc18-969c397f73ed.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F329392%2F1b39f2f2-9265-9f28-bc18-969c397f73ed.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b6d1c524cc86c9a86f930b94ddf75d45 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eUI上にラジオボタンが表示されていますが、MYRIADはMovidius Neural Compute Stick 2が接続されていると選択できるようになります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"終わりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e終わりに\u003c/h1\u003e\n\n\u003cp\u003eOpenVinoを使って推論を実行してみました。\u003cbr\u003e\nOpenVINOをC#から使っている記事はなさそうですので、同じことをしたい人の助けになれば幸いです。\u003cbr\u003e\n誤記や認識間違いあればご指摘をお願いします。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"参考リンク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考リンク\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eTensorflowとCUDA/cuDNNのバージョン対応表\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://www.tensorflow.org/install/source_windows?hl=ja\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://www.tensorflow.org/install/source_windows?hl=ja\u003c/a\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eOpenVino公式\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.openvinotoolkit.org/latest/openvino_docs_install_guides_installing_openvino_windows.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.openvinotoolkit.org/latest/openvino_docs_install_guides_installing_openvino_windows.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.openvinotoolkit.org/latest/_docs_MO_DG_Deep_Learning_Model_Optimizer_DevGuide.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.openvinotoolkit.org/latest/_docs_MO_DG_Deep_Learning_Model_Optimizer_DevGuide.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.openvinotoolkit.org/latest/openvino_docs_MO_DG_prepare_model_convert_model_Converting_Model_General.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.openvinotoolkit.org/latest/openvino_docs_MO_DG_prepare_model_convert_model_Converting_Model_General.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.openvinotoolkit.org/latest/openvino_docs_IE_DG_supported_plugins_Supported_Devices.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.openvinotoolkit.org/latest/openvino_docs_IE_DG_supported_plugins_Supported_Devices.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.openvinotoolkit.org/latest/_docs_IE_DG_Integrate_with_customer_application_new_API.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.openvinotoolkit.org/latest/_docs_IE_DG_Integrate_with_customer_application_new_API.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eOpenVinoインストール\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://openvino.jp/2021-1-on-win10/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://openvino.jp/2021-1-on-win10/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/hanapage/items/a2f76d97bed0204d3819\" class=\"autolink\"\u003ehttps://qiita.com/hanapage/items/a2f76d97bed0204d3819\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ePINTOさん\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/PINTO\" class=\"autolink\"\u003ehttps://qiita.com/PINTO\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eC++で実行するOepnVinoによる手書き文字認識(MNIST)\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54\" class=\"autolink\"\u003ehttps://qiita.com/fan2tamo/items/36bc8f9657d1a430aa54\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eC++で作成したDLLでAPIではなくクラスを提供する方法\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/fan2tamo/items/8f110a22d47cb684f33d\" class=\"autolink\"\u003ehttps://qiita.com/fan2tamo/items/8f110a22d47cb684f33d\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eC++で作成したdllにSwigを使ってC#向けのインターフェースを追加してC#から呼び出す方法\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb\" class=\"autolink\"\u003ehttps://qiita.com/fan2tamo/items/31376e0ce43c9a6a8feb\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eソース一式\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/fan2tamo/OpenVINOApp\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/fan2tamo/OpenVINOApp\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2021-02-23T03:57:24Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"bsNpZDm6iI2bhjMtHXZxQXcBTUhzpVvi5g==--bLERUfjlcgfeERoW--GVbsj7hTVO9wMzjzeOzuQw==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-02-23T12:52:15Z","likesCount":2,"linkUrl":"https://qiita.com/fan2tamo/items/18f418bd6d23686621ea","organization":null,"originalId":1396542,"stockedCount":2,"title":" C#で実行するOpenVINOによる手書き文字認識(MNIST)","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A7%8B%E6%88%90\"\u003e構成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%92%B0%E5%A2%83\"\u003e環境\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#openvino%E3%82%92%E4%BD%BF%E3%81%86%E7%90%86%E7%94%B1%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eOpenVINOを使う理由について\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#1-%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E8%AD%98%E5%88%A5%E5%99%A8%E3%81%AE%E7%94%9F%E6%88%90\"\u003e1. 学習済みモデル(識別器)の生成\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%95%8F%E9%A1%8C%E8%A8%AD%E5%AE%9A\"\u003e問題設定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF\"\u003eネットワーク\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#import\"\u003eimport\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#gpu%E3%81%8C%E6%8E%A5%E7%B6%9A%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E7%A2%BA%E8%AA%8D\"\u003eGPUが接続されているか確認\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AD%A6%E7%BF%92%E6%A4%9C%E8%A8%BC%E7%94%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e学習・検証用データの作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E5%AE%9A%E7%BE%A9\"\u003eネットワーク定義\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AD%A6%E7%BF%92\"\u003e学習\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%86%E3%82%B9%E3%83%88\"\u003eテスト\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BF%9D%E5%AD%98\"\u003e学習済みモデルの保存\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AD%A6%E7%BF%92%E6%B8%88%E3%81%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%82%92openvino%E3%81%8C%E6%89%B1%E3%81%88%E3%82%8B%E5%BD%A2%E5%BC%8F%E3%81%AB%E5%A4%89%E6%8F%9B\"\u003e学習済みモデルをOpenVINOが扱える形式に変換\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#openvino%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\"\u003eOpenVinoのインストール\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A\"\u003e環境設定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A4%89%E6%8F%9B\"\u003e変換\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3-openvino%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8Bdllc%E3%82%92%E4%BD%9C%E6%88%90\"\u003e3. OpenVINOを使って推論するdll(C++)を作成\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85-1\"\u003e実装\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1-initialize-core\"\u003e1. Initialize Core\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2-read-model-ir\"\u003e2. Read Model IR\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3-configure-input--output\"\u003e3. Configure Input \u0026amp; Output\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4-load-model\"\u003e4. Load Model\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#5-create-infer-request\"\u003e5. Create Infer Request\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#6-prepare-input\"\u003e6. Prepare Input\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#7-do-inference\"\u003e7. Do Inference\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%93%E3%83%AB%E3%83%89\"\u003eビルド\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#dumpbin\"\u003edumpbin\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4-swig%E3%81%A7c%E5%90%91%E3%81%91%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0\"\u003e4. SwigでC#向けのインターフェースを追加\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#dumpbin-1\"\u003edumpbin\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#5-swig%E3%81%A7c%E5%90%91%E3%81%91%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9Fdll%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96%E3%81%99%E3%82%8B%E3%82%A2%E3%83%97%E3%83%AAc%E3%82%92%E4%BD%9C%E6%88%90\"\u003e5. SwigでC#向けインターフェースを追加したdllを使って推論するアプリ(C#)を作成\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1-swig%E3%81%8C%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9Fcs%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AB%E8%BF%BD%E5%8A%A0\"\u003e1. Swigが作成した.csファイルをプロジェクトに追加\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2-callbackhandlerbase%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E7%B6%99%E6%89%BF%E3%81%97%E3%81%9F%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90\"\u003e2. CallbackHandlerBaseクラスを継承したクラスを作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3-myopenvino%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E6%8E%A8%E8%AB%96\"\u003e3. MyOpenVINOクラスを使って推論\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4-dll%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99%E3%81%9F%E3%82%81%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E3%82%B3%E3%83%94%E3%83%BC\"\u003e4. dllを動かすためのファイルをコピー\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e終わりに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF\"\u003e参考リンク\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":2887,"uuid":"18f418bd6d23686621ea","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"9DGX58Hh+Sv2cot/RUPWxXNFLGAX--gBSUACD6niq7tCIW--9JRTcT1wv3KwqyRYU8CI0A==","originalId":329392,"description":"メインはC#、次がC++、Pythonという感じです。\r\nDeep Learningに興味があり、なんとかC#で使えないかと試行錯誤中。\r\n\r\n今まで触った言語は、C, C++, Prolog, Perl, Octave, C#, Pythonぐらい。\r\n学生の頃はFreeBSDを使っていたので、cshかtcshだったけど、今はzshです。","facebookUrl":null,"githubUrl":"https://github.com/tfukushima1","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"Tamo Fanfan","profileImageUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/329392/e08b0f5411e5c1b79a59ecf87b6112d72f41d954/x_large.png?1611727425","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F329392%2Fe08b0f5411e5c1b79a59ecf87b6112d72f41d954%2Fx_large.png%3F1611727425?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=353284fc9d35d5cc1899e4be3b0e07e9","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F329392%2Fe08b0f5411e5c1b79a59ecf87b6112d72f41d954%2Fx_large.png%3F1611727425?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=6c7acf933b897bd632982f6915d2ce71","urlName":"fan2tamo","websiteUrl":"","twitterUrl":"https://twitter.com/yasu_fan2tamo","twitterUrlName":"yasu_fan2tamo","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"DeepLearning","urlName":"deeplearning"},{"name":"swig","urlName":"swig"},{"name":"Keras","urlName":"keras"},{"name":"OpenVINO","urlName":"openvino"}],"followingLikers":{"edges":[]},"comments":{"totalCount":4}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
