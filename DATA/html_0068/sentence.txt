ASP.NET Core C# + NUnitで開発をしていた際にユニットテストで詰まった部分について備忘録として残しておきます。
ユニットテストでアプリ側のクラスを生成し、コンストラクタ引数をモックで作成してテストをした際に「System.NotSupportedException : Unsupported expression:～Non-overridable members (here: ～～) may not be used in setup」というエラーが出てしまいました。
今回はその解決方法を2つほど記載していこうと思います。アプリ側が以下のコードになっている場合を考えてみましょう。
利用しているのはASP.NET Core コンソールアプリです（簡略化のためProgram.csのMain関数は省略しています）。
appSettings.jsonファイルから「Test1」キーの値を引っ張ってきてその値が9999だったら0を返却し、そうでない場合は1を返却するというプログラムです。テストコードは以下のように作成してみました。コンソールアプリ自体は正常に動作しますがユニットテストでは最初に記載した通りエラーが出てしまいます。色々と調べていると世界には同じ内容で詰まっている方がいるものです。Moq開発メンバーが回答してくれていますが、どうやらMoqはvirtualを付ける必要があるようです。
（インターフェースを対象とすればオーバーライドの心配はしなくても大丈夫です。）そこで元のコードを見ると、確かに・・・Test1はvirtualになっていないですね・・・そこでvirtual修飾子を付けてみましょう。テストを実行～～～
しっかりテストが通ったのが確認できましたね！
こちらは公式ではないですが、stackoverflowで以下のような回答がありました。Options.Createについて調べてみたら単純に自身のインスタンスをOptionsの型で返すようです。こちらだとMoqを使用していないので先ほどのようにvirtualを付ける必要もないので良さげです。
どちらが良いのかは・・・ちょっと分かりませんが好みという感じなんですかね？？記事を書きながらMoqやOptionsについて調べているといかに自分が雰囲気でそれらを使っていたかが分かります。
なかなか実務の時間にじっくり深堀りする余裕がないので仕方ないといえば仕方ないのですがその分しっかり自学でカバーしていきたいです。


