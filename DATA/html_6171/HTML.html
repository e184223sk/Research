<!DOCTYPE html><html><head><meta charset="utf-8" /><title>TDD を実施するために Moq を試してみた 　その３ Fakes と他の方法で解決してみた - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="1GNP7Lkken/uMdJHHxuCnyXHclrX80wO0xlD1Xa6fQQ/JmHPC9dgeSseh1XSjIpfhxrR9xTtvAuGYwtreEv0bw==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="TDD を実施するために Moq を試してみた 　その３ Fakes と他の方法で解決してみた - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WRVJFSU9PQ2t1V3VuLWFXdmVPQm1lT0NpLU9Cbi1PQ2dlT0JxeUJOYjNFZzQ0S1M2S21tNDRHWDQ0R200NEdfNDRHZklPT0FnT09CbmVPQnJ1LThreUJHWVd0bGN5RGpnYWprdTViamdhN21scm5tczVYamdhZm9wNlBtc2JyamdaZmpnYWJqZ2JfamdaOCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0yNTJjZjc2NzdkOGNmMzg4ZDdmYmY2OWE5OTBmNDIzZA&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=5fc4042624e5a50de33bfeead8a7cba1"><meta property="og:description" content="前回、思いついた方法でやったけど、詰んだという話を書いた。

TDD を実施するために Moq を試してみた 　その２実践してみた

前回は師匠の言う通りと思って、お題の KeyVaultHelper の Mock はあきらめるという..."><meta content="https://qiita.com/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="TDD,C#,Moq,Fakes" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-b9f37c29-57e5-4fde-9de1-2d6c45d8a06f"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F0ce3eef31461945e6bd8">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F0ce3eef31461945e6bd8">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-b9f37c29-57e5-4fde-9de1-2d6c45d8a06f">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/tdd","name":"TDD"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2017-07-29T15:49:29.000+09:00","dateModified":"2017-07-29T15:49:29.000+09:00","headline":"TDD を実施するために Moq を試してみた 　その３ Fakes と他の方法で解決してみた","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WRVJFSU9PQ2t1V3VuLWFXdmVPQm1lT0NpLU9Cbi1PQ2dlT0JxeUJOYjNFZzQ0S1M2S21tNDRHWDQ0R200NEdfNDRHZklPT0FnT09CbmVPQnJ1LThreUJHWVd0bGN5RGpnYWprdTViamdhN21scm5tczVYamdhZm9wNlBtc2JyamdaZmpnYWJqZ2JfamdaOCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz0yNTJjZjc2NzdkOGNmMzg4ZDdmYmY2OWE5OTBmNDIzZA\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRlJ6ZFhsdmMyaHBWWE5vYVc5QVoybDBhSFZpJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGU1ZmY0YzU2YmJjZGZkMGE4NDQzMTk1MzQzY2ViMzI\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=5fc4042624e5a50de33bfeead8a7cba1","mainEntityOfPage":"https://qiita.com/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8","author":{"@type":"Person","address":"Kanagwa, Japan","email":null,"identifier":"TsuyoshiUshio@github","name":"TsuyoshiUshio@github","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","url":"https://qiita.com/TsuyoshiUshio@github","description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita&amp;utm_medium=header-banner">「最高の開発者体験」を目指す NewsPicks開発チーム</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"0ce3eef31461945e6bd8"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「最高の開発者体験」を目指す NewsPicks開発チーム","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"0ce3eef31461945e6bd8"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「最高の開発者体験」を目指す NewsPicks開発チーム","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"TsuyoshiUshio@github","type":"items","id":"0ce3eef31461945e6bd8"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「最高の開発者体験」を目指す NewsPicks開発チーム","url":"https://zine.qiita.com/interview/202105-uzabase-2/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8","location":"/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8","scheme":"https","host":"qiita.com","port":null,"pathname":"/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"/CZZ0+bs1d5kUO9eveS8WkvUrlBfyFE/rOgv22JIYU8XY3fwVB/P2KF/ukxwc7Sa6QkN/ZzWoTr5kmdlbLnoJA==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-ee1c3571-aa6f-4363-9c6e-f8f9873e312f"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8/likers" class="css-1iupg5d">7</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">12</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/0ce3eef31461945e6bd8/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/TsuyoshiUshio@github"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/TsuyoshiUshio@github" class="css-10ougpm">@<!-- -->TsuyoshiUshio@github</a><div class="css-1ay9vb9"><time dateTime="2017-07-29T06:49:29Z" class="css-m19uds">posted at 2017-07-29</time></div></div></div></div></div><h1 class="css-cgzq40">TDD を実施するために Moq を試してみた 　その３ Fakes と他の方法で解決してみた</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/tdd" class="css-4czcte">TDD</a><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/moq" class="css-4czcte">Moq</a><a href="/tags/fakes" class="css-4czcte">Fakes</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>前回、思いついた方法でやったけど、詰んだという話を書いた。</p>

<p><a href="http://qiita.com/TsuyoshiUshio@github/items/37d1cee9118d681db5af" id="reference-a987dd1ff32f52480406">TDD を実施するために Moq を試してみた 　その２実践してみた</a></p>

<p>前回は師匠の言う通りと思って、お題の KeyVaultHelper の Mock はあきらめるという方針をとって、それはとても正解と思うが、プログラミングテクニック的に他のやり方で出来ないかを考えて実践したらうまくいったのでブログに書き留めておきたい。金で解決する方法と、シンプルな方法の二つをご紹介します。</p>

<h1>
<span id="師匠の一言" class="fragment"></span><a href="#%E5%B8%AB%E5%8C%A0%E3%81%AE%E4%B8%80%E8%A8%80"><i class="fa fa-link"></i></a>師匠の一言</h1>

<p>私の尊敬するプログラミング師匠があの後コメントをくれた。そういえば以前師匠はこういっていた。</p>

<blockquote>
<p>C# での Mock は、Moq で。お金でぶん殴るなら、Fakesで</p>
</blockquote>

<p>「お金でぶん殴る」というのはどういう意味かというと、Fakes という Mockツールは、Visual Studio Enterprise でしか使えない機能らしいのだ。マイクロソフトの私は使えるじゃないか、、、というわけでどんなものか興味もあったので、実装して試してみた。</p>

<h1>
<span id="fakes" class="fragment"></span><a href="#fakes"><i class="fa fa-link"></i></a>Fakes</h1>

<p>Fakes は Microsoft の出しているテストのモックツールです。次のサイトが公式のものです。</p>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/hh549175.aspx" rel="nofollow noopener" target="_blank">Isolating Code Under Test with Microsoft Fakes</a></li>
</ul>

<p>他に具体的な例はこちらがわかりやすいです。</p>

<ul>
<li><a href="http://winterttr.me/2015/09/05/CSharp-Unit-Test-with-Microsoft-Fakes/" rel="nofollow noopener" target="_blank">C# Unit Test with Microsoft Fakes</a></li>
</ul>

<p>この Fakes は何のためにあるかというと、Moq を使ってて実際にあるのですが、Mock が出来るかどうかは元のクラスやインターフェイスの設計に依存します。だから、自分でいじれないライブラリを Mock しようとしたときに、virtual がついてなくて、オーバーライドできなかったり、インターフェイスが無かったり、拡張メソッドだったりすると、あきらめるしかない、、、となってしまいます。自分がライブラリに手を入れられない状況でも、Mock をしたいのが元々の動機のようです。</p>

<p>　その Mock の方法ですが、衝撃的です。C# の DLL を書き換えて、Mock 用 DLL を作るという方法です。Fakes は、Visual Studio Enterprise で、References を右クリックして、Mock 対象のライブラリを<code>Add Fakes Assembly</code> を選択すると、偽物のDLLが生成されます。このDLL をテストのプロジェクトからも、参照すると、使えるようになります。かなり大胆ですね。</p>

<p><a href="https://camo.qiitausercontent.com/079e01673e2324802178f4d5293a9bc1dc8a2d78/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f31306431303838612d643965632d666331612d306637332d3931383963336462623036642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F10d1088a-d9ec-fc1a-0f73-9189c3dbb06d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=357dc4be5d98bcdca62efc8a35d45d3c" alt="Fakes.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/10d1088a-d9ec-fc1a-0f73-9189c3dbb06d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F10d1088a-d9ec-fc1a-0f73-9189c3dbb06d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=2d4621e36b2b36e4352f6e04a483361f 1x" loading="lazy"></a></p>

<p>先ほどのブログに紹介されていた図ですが、とんでもないものまで Mock できます。Static メソッドに、private メソッドなんでもありです。ただ、実際にやってもそうですが、パフォーマンスは遅いです。</p>

<p><a href="https://camo.qiitausercontent.com/cf97c91eccf545dcea974cae11558b20ba42bd60/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32636134363465312d643836362d303533372d393762622d3932326331383738353138662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F2ca464e1-d866-0537-97bb-922c1878518f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=cdace3213dfd5b0e429d227f9ee9a148" alt="Fakes02.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/2ca464e1-d866-0537-97bb-922c1878518f.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F2ca464e1-d866-0537-97bb-922c1878518f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=7ee01ee90189af2875ee96269bebe692 1x" loading="lazy"></a></p>

<p>実際に昨日のコードに対して Fakes でテストを書くとちゃんと成功しました。Fakes には、Stub というモードと、Shims というモードがあると思いますが、実際に Fakes が生きるのは、Shims なので、そっちでの要素が多そうです。ポイントを解説したいと思います。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>
        <span class="p">[</span><span class="n">TestMethod</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">TestGetSecretByShim</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">identifiyer</span> <span class="p">=</span> <span class="s">"https://abc.vault.azure.net/secrets/"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">secretValue</span> <span class="p">=</span> <span class="s">"bar"</span><span class="p">;</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">ShimsContext</span><span class="p">.</span><span class="nf">Create</span><span class="p">())</span> <span class="c1">// 1. ShimsContext の設定</span>
            <span class="p">{</span>

                <span class="n">ShimSecretBundle</span><span class="p">.</span><span class="n">AllInstances</span><span class="p">.</span><span class="n">ValueGet</span> <span class="p">=</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">secretValue</span><span class="p">;</span> <span class="c1">// 2. SecretBundle のValue メソッドの Mock</span>
                <span class="n">Microsoft</span><span class="p">.</span><span class="n">Azure</span><span class="p">.</span><span class="n">KeyVault</span><span class="p">.</span><span class="n">Fakes</span><span class="p">.</span><span class="n">ShimKeyVaultClientExtensions</span><span class="p">.</span><span class="n">GetSecretAsyncIKeyVaultClientStringCancellationToken</span> <span class="p">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">ca</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="k">new</span> <span class="nf">SecretBundle</span><span class="p">());</span>
                <span class="n">ShimKeyVaultClient</span><span class="p">.</span><span class="n">ConstructorKeyVaultCredentialHttpClient</span> <span class="p">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">};</span> <span class="c1">// 3. KeyVaultClientExtensionのGetSecretAsyncメソッドの Mock</span>
                <span class="kt">var</span> <span class="n">helper</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">KeyVaultHelper</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="k">new</span> <span class="nf">KeyVaultClient</span><span class="p">((</span><span class="n">KeyVaultCredential</span><span class="p">)</span><span class="k">null</span><span class="p">,</span> <span class="p">(</span><span class="n">HttpClient</span><span class="p">)</span> <span class="k">null</span><span class="p">),</span> <span class="n">vaultBaseUrl</span><span class="p">:</span> <span class="n">identifiyer</span><span class="p">);</span>
                <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="s">"bar"</span><span class="p">,</span> <span class="k">await</span> <span class="n">helper</span><span class="p">.</span><span class="nf">GetSecretValueAsync</span><span class="p">(</span><span class="s">"foo"</span><span class="p">));</span>
            <span class="p">}</span>
         <span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="1-shimscontext-の設定" class="fragment"></span><a href="#1-shimscontext-%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>1. ShimsContext の設定</h2>

<p>　このShimsContext の範囲で、Shims の Mock が有効になります。</p>

<h2>
<span id="2-secretbundle-の-value-メソッドのmockちなみに" class="fragment"></span><a href="#2-secretbundle-%E3%81%AE-value-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AEmock%E3%81%A1%E3%81%AA%E3%81%BF%E3%81%AB"><i class="fa fa-link"></i></a>2. SecretBundle の Value メソッドのMockちなみに、</h2>

<p>クラス名が、Shimが頭についた名前に変更されていて、全てのインスタンスメソッドの中で、Get するものという感じで、クラス名もメソッド名も変更されています。インテリセンスがあるので、<code>.</code>を押して、使えるメソッドを眺めていると、どれが自分がモックしたいメソッドなのかがわかると思います。</p>

<h2>
<span id="3-keyvaultcientexensions-の-getsecretasync-のmock" class="fragment"></span><a href="#3-keyvaultcientexensions-%E3%81%AE-getsecretasync-%E3%81%AEmock"><i class="fa fa-link"></i></a>3. KeyVaultCientExensions の GetSecretAsync のMock</h2>

<p>　ノリは 2. と同じですが、引数の型が、ことごとくメソッド名に加えられています。IKeyVaultClient でもなく、KeyVaultClient でもなく、KeyVaultClientExtensions という名前になっています。これは何かというと、KeyVaultClient の GetSecretAsync というメソッドは、「拡張メソッド」と呼ばれるものです。元の KeyVaultClient には定義がなく、後で拡張されたものです。<a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.keyvault.keyvaultclient?view=azurekeyvault-2.0.6" rel="nofollow noopener" target="_blank">KeyVaultClient リファレンス</a>　Mixin を実現するのに使われます。</p>

<p>これが、何が問題かというと、Moq では、この拡張メソッドの Mock ができません。なぜなら、拡張メソッドは、static メソッドを、インスタンスメソッドのように呼び出しているものだからです。<a href="http://ufcpp.net/study/csharp/sp3_extension.html" rel="nofollow noopener" target="_blank">拡張メソッド</a>　ただ、Shims はそんなものもお構いなく Mock します。だから、この方法でばっちりテストが通りました。</p>

<p><a href="https://camo.qiitausercontent.com/93872afc0f6cf5e68f51eba0bd3f895d746565ba/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33646566633032322d633739342d306539662d636433622d3731393766326330663339662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F3defc022-c794-0e9f-cd3b-7197f2c0f39f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=94a831a02fc3ed47cb3fd3a64801c2b7" alt="Fakes03.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/3defc022-c794-0e9f-cd3b-7197f2c0f39f.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F3defc022-c794-0e9f-cd3b-7197f2c0f39f.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5ae8d698eda14237b78a77baa196e56f 1x" loading="lazy"></a></p>

<p>おおお！まさに、出来ないことを可能にする、人間を超越した気分です！ついにできたぞー！</p>

<h2>
<span id="しかし意味は薄い" class="fragment"></span><a href="#%E3%81%97%E3%81%8B%E3%81%97%E6%84%8F%E5%91%B3%E3%81%AF%E8%96%84%E3%81%84"><i class="fa fa-link"></i></a>しかし、意味は薄い</h2>

<p>盛り上がっておいてなんですが、これを Mock したところでなんの意味があるのかはよくわかりません。Mock のテストの重要なポイントは自分で書いたロジックをテストすることであります。だから、テストとしては、Mock したところ以外のロジックがちゃんと動いているか、Mock に想定した値が渡っているかがテストのポイントですが、この方式だと、結果を Mock しているので、どちらもテストできていません。全くの自己満足ですｗ</p>

<p>ただ、Fakes 自体は不可能を可能にする仕組みですので、こいつさえ Mock できればぁーーーきーーーー。となっているときには救世主になるかもしれません。試せてよかった。</p>

<p>じゃあ、Moq と Fakes を組み合わせればいいんじゃないの？いや、Moqだけで行けるかもと思って書いたのがこのコード</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>
            <span class="kt">var</span> <span class="n">identifiyer</span> <span class="p">=</span> <span class="s">"https://abc.vault.azure.net/secrets/"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">secretName</span> <span class="p">=</span> <span class="s">"foo"</span><span class="p">;</span>
                <span class="kt">var</span> <span class="n">keyVaultClientMock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IKeyVaultClient</span><span class="p">&gt;();</span>
                <span class="kt">var</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SecretBundle</span><span class="p">();</span>
                <span class="n">sb</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="s">"bar"</span><span class="p">;</span>
                <span class="n">keyVaultClientMock</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="nf">GetSecretAsync</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">identifiyer</span><span class="p">}{</span><span class="n">secretName</span><span class="p">}</span><span class="s">/"</span><span class="p">,</span> <span class="k">new</span> <span class="nf">CancellationToken</span><span class="p">())).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
                <span class="kt">var</span> <span class="n">helper</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">KeyVaultHelper</span><span class="p">(</span><span class="n">keyVaultClientMock</span><span class="p">.</span><span class="n">Object</span><span class="p">,</span> <span class="s">"https://abc.vault.azure.net"</span><span class="p">);</span>
                <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="s">"bar"</span><span class="p">,</span> <span class="k">await</span> <span class="n">helper</span><span class="p">.</span><span class="nf">GetSecretValueAsync</span><span class="p">(</span><span class="s">"foo"</span><span class="p">));</span>
</code></pre></div></div>

<p>残念ながら結論としてはできません。先で書いた通り、GetSecretAsync メソッドは、拡張メソッドなので、Moq では Mock 出来ないのです。ぐぬぬ。はやりあきらめるしかないのか、、、。</p>

<h1>
<span id="金で殴らない単純な解決策" class="fragment"></span><a href="#%E9%87%91%E3%81%A7%E6%AE%B4%E3%82%89%E3%81%AA%E3%81%84%E5%8D%98%E7%B4%94%E3%81%AA%E8%A7%A3%E6%B1%BA%E7%AD%96"><i class="fa fa-link"></i></a>金で殴らない単純な解決策</h1>

<p>そんな時にふとむっちゃ簡単な解決策を思いつきました。</p>

<ul>
<li>そもそも、Mock したいのは、KeyVaultClient のしかも一つのメソッドだけ。</li>
<li>テストしたいのは、GetSecretValueAsyncメソッド内で書いている、baseUrl + /secrets/ + keyの名前 というロジックがちゃんと実行されているか？ということだけ</li>
</ul>

<p>なので`KeyVaultClientの.GetSecretAsyncを実行している部分＋戻り値で問題になる、SecretBundleクラスのモックをあきらめて、SecretBundle から、Value を取り出すメソッドのテストだけをあきらめて、メソッドに切り出してあげればいいということです。</p>

<p>これを</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetSecretValueAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">identifier</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">vaultBaseUrl</span><span class="p">}</span><span class="s">/secrets/</span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s">/"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">secret</span> <span class="p">=</span> <span class="k">await</span> <span class="n">keyClient</span><span class="p">.</span><span class="nf">GetSecretAsync</span><span class="p">(</span><span class="n">identifier</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">secret</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>こんな感じに</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>        <span class="k">public</span> <span class="k">async</span> <span class="k">virtual</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetSecretVelueWithIdentifierAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">secret</span> <span class="p">=</span> <span class="k">await</span> <span class="n">keyClient</span><span class="p">.</span><span class="nf">GetSecretAsync</span><span class="p">(</span><span class="n">identifier</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">secret</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetSecretValueAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">identifier</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">vaultBaseUrl</span><span class="p">}</span><span class="s">/secrets/</span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s">/"</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nf">GetSecretVelueWithIdentifierAsync</span><span class="p">(</span><span class="n">identifier</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>テストはこんな感じで</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">TestGetAsyncByMoqOnly</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">baseUrl</span> <span class="p">=</span> <span class="s">"https://abc.vault.azure.net"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">secretName</span> <span class="p">=</span> <span class="s">"foo"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">keyVaultHelperMock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">KeyVaultHelper</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">,</span> <span class="n">baseUrl</span><span class="p">);</span>
            <span class="n">keyVaultHelperMock</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="nf">GetSecretVelueWithIdentifierAsync</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">baseUrl</span><span class="p">}</span><span class="s">/secrets/</span><span class="p">{</span><span class="n">secretName</span><span class="p">}</span><span class="s">/"</span><span class="p">)).</span><span class="nf">ReturnsAsync</span><span class="p">(</span><span class="s">"bar"</span><span class="p">);</span>
            <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="s">"bar"</span><span class="p">,</span> <span class="k">await</span> <span class="n">keyVaultHelperMock</span><span class="p">.</span><span class="n">Object</span><span class="p">.</span><span class="nf">GetSecretValueAsync</span><span class="p">(</span><span class="s">"foo"</span><span class="p">));</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>昨日はあきらめでいいやと思ったのですが、このクラスをコーディングしていくと、どうしても、KeyValueHelper自体をテストしたい場面が出てきて、この方法をふと思いつきました。よくよく考えたら前から知ってる方法じゃないか、、、何をやってたのよ、、、 orz </p>

<p>ちなみにツイッターでご指摘いただいた次の方法で、Moq の　戻り値の書き方のおしゃれさが増しています。</p>

<ul>
<li><a href="http://kuxumarin.hatenablog.com/entry/2017/07/22/moq_%E3%81%A7_%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E8%BF%94%E3%81%99%E5%80%A4%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B" rel="nofollow noopener" target="_blank">moq で 非同期メソッドの返り値を設定する</a></li>
</ul>

<p>むっちゃありがとうございました！</p>

<p>しかし、これですっきりテストも通りました！しかも、この方法だと、テストしたい部分（ロジック）がしっかりテストされているし、適切な値が渡ってきたときしか、このMock が発動しないので、Moq の Velify を使わなくても、Mock したメソッドに正しい値が渡ってきたことが保証できています。これ一番ええやん。金つかってないけど！人間を超越しなくても、出来るやん！素晴らしい！人間賛歌だ！</p>

<p><a href="https://camo.qiitausercontent.com/a32066938d3230b1518e410ac316657d497a2aee/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32366364346536362d636338662d666231382d376564632d3935396162343130386364662e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F26cd4e66-cc8f-fb18-7edc-959ab4108cdf.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=84b72777b5648ef645683344f8f75a96" alt="Fakes05.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/3470/26cd4e66-cc8f-fb18-7edc-959ab4108cdf.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F26cd4e66-cc8f-fb18-7edc-959ab4108cdf.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a13ecd003c67885202b9e1080d21005a 1x" loading="lazy"></a></p>

<h1>
<span id="おわりに" class="fragment"></span><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>おわりに</h1>

<p>いろんなコメントをいただきありがとうございました。皆様のおかげでこの解放にたどり着けました。<br>
今日はいろいろ学んだのでまだまだブログしようと思います。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F0ce3eef31461945e6bd8&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FTsuyoshiUshio%40github%2Fitems%2F0ce3eef31461945e6bd8&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8/likers" class="css-1iupg5d">7</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">12</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/0ce3eef31461945e6bd8/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-ee1c3571-aa6f-4363-9c6e-f8f9873e312f">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-e97eec5d-c104-4e42-97b7-cc32d80f5ff5"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-e97eec5d-c104-4e42-97b7-cc32d80f5ff5">{}</script>
      
<div id="LoginModal-react-component-726cdcf4-040f-43ad-86f8-d8057dac345b"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-726cdcf4-040f-43ad-86f8-d8057dac345b">{}</script>
      
<div id="StockModal-react-component-2c76d051-455a-4208-9b16-beba4e5310d4"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-2c76d051-455a-4208-9b16-beba4e5310d4">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;v5H5ntVtNv3j+DaSw3rer7dT70Xk5TaHSf6xHfhwqplU1Ne9Z54s+ybXY4AO7dZvFY5M6Cf7xoIchPmj9oEj8g==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e前回、思いついた方法でやったけど、詰んだという話を書いた。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"http://qiita.com/TsuyoshiUshio@github/items/37d1cee9118d681db5af\" id=\"reference-a987dd1ff32f52480406\"\u003eTDD を実施するために Moq を試してみた 　その２実践してみた\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e前回は師匠の言う通りと思って、お題の KeyVaultHelper の Mock はあきらめるという方針をとって、それはとても正解と思うが、プログラミングテクニック的に他のやり方で出来ないかを考えて実践したらうまくいったのでブログに書き留めておきたい。金で解決する方法と、シンプルな方法の二つをご紹介します。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"師匠の一言\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%B8%AB%E5%8C%A0%E3%81%AE%E4%B8%80%E8%A8%80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e師匠の一言\u003c/h1\u003e\n\n\u003cp\u003e私の尊敬するプログラミング師匠があの後コメントをくれた。そういえば以前師匠はこういっていた。\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eC# での Mock は、Moq で。お金でぶん殴るなら、Fakesで\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e「お金でぶん殴る」というのはどういう意味かというと、Fakes という Mockツールは、Visual Studio Enterprise でしか使えない機能らしいのだ。マイクロソフトの私は使えるじゃないか、、、というわけでどんなものか興味もあったので、実装して試してみた。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"fakes\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#fakes\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eFakes\u003c/h1\u003e\n\n\u003cp\u003eFakes は Microsoft の出しているテストのモックツールです。次のサイトが公式のものです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://msdn.microsoft.com/en-us/library/hh549175.aspx\" rel=\"nofollow noopener\" target=\"_blank\"\u003eIsolating Code Under Test with Microsoft Fakes\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e他に具体的な例はこちらがわかりやすいです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"http://winterttr.me/2015/09/05/CSharp-Unit-Test-with-Microsoft-Fakes/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC# Unit Test with Microsoft Fakes\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこの Fakes は何のためにあるかというと、Moq を使ってて実際にあるのですが、Mock が出来るかどうかは元のクラスやインターフェイスの設計に依存します。だから、自分でいじれないライブラリを Mock しようとしたときに、virtual がついてなくて、オーバーライドできなかったり、インターフェイスが無かったり、拡張メソッドだったりすると、あきらめるしかない、、、となってしまいます。自分がライブラリに手を入れられない状況でも、Mock をしたいのが元々の動機のようです。\u003c/p\u003e\n\n\u003cp\u003e　その Mock の方法ですが、衝撃的です。C# の DLL を書き換えて、Mock 用 DLL を作るという方法です。Fakes は、Visual Studio Enterprise で、References を右クリックして、Mock 対象のライブラリを\u003ccode\u003eAdd Fakes Assembly\u003c/code\u003e を選択すると、偽物のDLLが生成されます。このDLL をテストのプロジェクトからも、参照すると、使えるようになります。かなり大胆ですね。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/079e01673e2324802178f4d5293a9bc1dc8a2d78/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f31306431303838612d643965632d666331612d306637332d3931383963336462623036642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F10d1088a-d9ec-fc1a-0f73-9189c3dbb06d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=357dc4be5d98bcdca62efc8a35d45d3c\" alt=\"Fakes.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/10d1088a-d9ec-fc1a-0f73-9189c3dbb06d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F10d1088a-d9ec-fc1a-0f73-9189c3dbb06d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=2d4621e36b2b36e4352f6e04a483361f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e先ほどのブログに紹介されていた図ですが、とんでもないものまで Mock できます。Static メソッドに、private メソッドなんでもありです。ただ、実際にやってもそうですが、パフォーマンスは遅いです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/cf97c91eccf545dcea974cae11558b20ba42bd60/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32636134363465312d643836362d303533372d393762622d3932326331383738353138662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F2ca464e1-d866-0537-97bb-922c1878518f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=cdace3213dfd5b0e429d227f9ee9a148\" alt=\"Fakes02.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/2ca464e1-d866-0537-97bb-922c1878518f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F2ca464e1-d866-0537-97bb-922c1878518f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=7ee01ee90189af2875ee96269bebe692 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e実際に昨日のコードに対して Fakes でテストを書くとちゃんと成功しました。Fakes には、Stub というモードと、Shims というモードがあると思いますが、実際に Fakes が生きるのは、Shims なので、そっちでの要素が多そうです。ポイントを解説したいと思います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eTestMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eTestGetSecretByShim\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eidentifiyer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"https://abc.vault.azure.net/secrets/\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecretValue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"bar\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eShimsContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 1. ShimsContext の設定\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003eShimSecretBundle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAllInstances\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValueGet\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esecretValue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 2. SecretBundle のValue メソッドの Mock\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eMicrosoft\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAzure\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyVault\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFakes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eShimKeyVaultClientExtensions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetSecretAsyncIKeyVaultClientStringCancellationToken\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eca\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSecretBundle\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eShimKeyVaultClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConstructorKeyVaultCredentialHttpClient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 3. KeyVaultClientExtensionのGetSecretAsyncメソッドの Mock\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ehelper\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eKeyVaultHelper\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eKeyVaultClient\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyVaultCredential\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eHttpClient\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003evaultBaseUrl\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eidentifiyer\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eAssert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAreEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"bar\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ehelper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSecretValueAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n         \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"1-shimscontext-の設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1-shimscontext-%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1. ShimsContext の設定\u003c/h2\u003e\n\n\u003cp\u003e　このShimsContext の範囲で、Shims の Mock が有効になります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"2-secretbundle-の-value-メソッドのmockちなみに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2-secretbundle-%E3%81%AE-value-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AEmock%E3%81%A1%E3%81%AA%E3%81%BF%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2. SecretBundle の Value メソッドのMockちなみに、\u003c/h2\u003e\n\n\u003cp\u003eクラス名が、Shimが頭についた名前に変更されていて、全てのインスタンスメソッドの中で、Get するものという感じで、クラス名もメソッド名も変更されています。インテリセンスがあるので、\u003ccode\u003e.\u003c/code\u003eを押して、使えるメソッドを眺めていると、どれが自分がモックしたいメソッドなのかがわかると思います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"3-keyvaultcientexensions-の-getsecretasync-のmock\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3-keyvaultcientexensions-%E3%81%AE-getsecretasync-%E3%81%AEmock\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3. KeyVaultCientExensions の GetSecretAsync のMock\u003c/h2\u003e\n\n\u003cp\u003e　ノリは 2. と同じですが、引数の型が、ことごとくメソッド名に加えられています。IKeyVaultClient でもなく、KeyVaultClient でもなく、KeyVaultClientExtensions という名前になっています。これは何かというと、KeyVaultClient の GetSecretAsync というメソッドは、「拡張メソッド」と呼ばれるものです。元の KeyVaultClient には定義がなく、後で拡張されたものです。\u003ca href=\"https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.keyvault.keyvaultclient?view=azurekeyvault-2.0.6\" rel=\"nofollow noopener\" target=\"_blank\"\u003eKeyVaultClient リファレンス\u003c/a\u003e　Mixin を実現するのに使われます。\u003c/p\u003e\n\n\u003cp\u003eこれが、何が問題かというと、Moq では、この拡張メソッドの Mock ができません。なぜなら、拡張メソッドは、static メソッドを、インスタンスメソッドのように呼び出しているものだからです。\u003ca href=\"http://ufcpp.net/study/csharp/sp3_extension.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e拡張メソッド\u003c/a\u003e　ただ、Shims はそんなものもお構いなく Mock します。だから、この方法でばっちりテストが通りました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/93872afc0f6cf5e68f51eba0bd3f895d746565ba/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f33646566633032322d633739342d306539662d636433622d3731393766326330663339662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F3defc022-c794-0e9f-cd3b-7197f2c0f39f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=94a831a02fc3ed47cb3fd3a64801c2b7\" alt=\"Fakes03.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/3defc022-c794-0e9f-cd3b-7197f2c0f39f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F3defc022-c794-0e9f-cd3b-7197f2c0f39f.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=5ae8d698eda14237b78a77baa196e56f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eおおお！まさに、出来ないことを可能にする、人間を超越した気分です！ついにできたぞー！\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"しかし意味は薄い\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%97%E3%81%8B%E3%81%97%E6%84%8F%E5%91%B3%E3%81%AF%E8%96%84%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eしかし、意味は薄い\u003c/h2\u003e\n\n\u003cp\u003e盛り上がっておいてなんですが、これを Mock したところでなんの意味があるのかはよくわかりません。Mock のテストの重要なポイントは自分で書いたロジックをテストすることであります。だから、テストとしては、Mock したところ以外のロジックがちゃんと動いているか、Mock に想定した値が渡っているかがテストのポイントですが、この方式だと、結果を Mock しているので、どちらもテストできていません。全くの自己満足ですｗ\u003c/p\u003e\n\n\u003cp\u003eただ、Fakes 自体は不可能を可能にする仕組みですので、こいつさえ Mock できればぁーーーきーーーー。となっているときには救世主になるかもしれません。試せてよかった。\u003c/p\u003e\n\n\u003cp\u003eじゃあ、Moq と Fakes を組み合わせればいいんじゃないの？いや、Moqだけで行けるかもと思って書いたのがこのコード\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eidentifiyer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"https://abc.vault.azure.net/secrets/\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecretName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyVaultClientMock\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eMock\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIKeyVaultClient\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eSecretBundle\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"bar\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ekeyVaultClientMock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSecretAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eidentifiyer\u003c/span\u003e\u003cspan class=\"p\"\u003e}{\u003c/span\u003e\u003cspan class=\"n\"\u003esecretName\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e/\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eCancellationToken\u003c/span\u003e\u003cspan class=\"p\"\u003e())).\u003c/span\u003e\u003cspan class=\"nf\"\u003eReturns\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esb\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ehelper\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eKeyVaultHelper\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekeyVaultClientMock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"https://abc.vault.azure.net\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eAssert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAreEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"bar\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ehelper\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSecretValueAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e残念ながら結論としてはできません。先で書いた通り、GetSecretAsync メソッドは、拡張メソッドなので、Moq では Mock 出来ないのです。ぐぬぬ。はやりあきらめるしかないのか、、、。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"金で殴らない単純な解決策\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%87%91%E3%81%A7%E6%AE%B4%E3%82%89%E3%81%AA%E3%81%84%E5%8D%98%E7%B4%94%E3%81%AA%E8%A7%A3%E6%B1%BA%E7%AD%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e金で殴らない単純な解決策\u003c/h1\u003e\n\n\u003cp\u003eそんな時にふとむっちゃ簡単な解決策を思いつきました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eそもそも、Mock したいのは、KeyVaultClient のしかも一つのメソッドだけ。\u003c/li\u003e\n\u003cli\u003eテストしたいのは、GetSecretValueAsyncメソッド内で書いている、baseUrl + /secrets/ + keyの名前 というロジックがちゃんと実行されているか？ということだけ\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eなので`KeyVaultClientの.GetSecretAsyncを実行している部分＋戻り値で問題になる、SecretBundleクラスのモックをあきらめて、SecretBundle から、Value を取り出すメソッドのテストだけをあきらめて、メソッドに切り出してあげればいいということです。\u003c/p\u003e\n\n\u003cp\u003eこれを\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetSecretValueAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eidentifier\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003evaultBaseUrl\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e/secrets/\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e/\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSecretAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eidentifier\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこんな感じに\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003evirtual\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetSecretVelueWithIdentifierAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eidentifier\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSecretAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eidentifier\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esecret\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetSecretValueAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eidentifier\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003evaultBaseUrl\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e/secrets/\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e/\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetSecretVelueWithIdentifierAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eidentifier\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eテストはこんな感じで\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eTestGetAsyncByMoqOnly\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebaseUrl\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"https://abc.vault.azure.net\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esecretName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyVaultHelperMock\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eMock\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyVaultHelper\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebaseUrl\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ekeyVaultHelperMock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSecretVelueWithIdentifierAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ebaseUrl\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e/secrets/\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003esecretName\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e/\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)).\u003c/span\u003e\u003cspan class=\"nf\"\u003eReturnsAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"bar\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eAssert\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAreEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"bar\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyVaultHelperMock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetSecretValueAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e昨日はあきらめでいいやと思ったのですが、このクラスをコーディングしていくと、どうしても、KeyValueHelper自体をテストしたい場面が出てきて、この方法をふと思いつきました。よくよく考えたら前から知ってる方法じゃないか、、、何をやってたのよ、、、 orz \u003c/p\u003e\n\n\u003cp\u003eちなみにツイッターでご指摘いただいた次の方法で、Moq の　戻り値の書き方のおしゃれさが増しています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"http://kuxumarin.hatenablog.com/entry/2017/07/22/moq_%E3%81%A7_%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AB%E8%BF%94%E3%81%99%E5%80%A4%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B\" rel=\"nofollow noopener\" target=\"_blank\"\u003emoq で 非同期メソッドの返り値を設定する\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eむっちゃありがとうございました！\u003c/p\u003e\n\n\u003cp\u003eしかし、これですっきりテストも通りました！しかも、この方法だと、テストしたい部分（ロジック）がしっかりテストされているし、適切な値が渡ってきたときしか、このMock が発動しないので、Moq の Velify を使わなくても、Mock したメソッドに正しい値が渡ってきたことが保証できています。これ一番ええやん。金つかってないけど！人間を超越しなくても、出来るやん！素晴らしい！人間賛歌だ！\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/a32066938d3230b1518e410ac316657d497a2aee/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f333437302f32366364346536362d636338662d666231382d376564632d3935396162343130386364662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F26cd4e66-cc8f-fb18-7edc-959ab4108cdf.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=84b72777b5648ef645683344f8f75a96\" alt=\"Fakes05.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/3470/26cd4e66-cc8f-fb18-7edc-959ab4108cdf.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2F26cd4e66-cc8f-fb18-7edc-959ab4108cdf.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a13ecd003c67885202b9e1080d21005a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"おわりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eおわりに\u003c/h1\u003e\n\n\u003cp\u003eいろんなコメントをいただきありがとうございました。皆様のおかげでこの解放にたどり着けました。\u003cbr\u003e\n今日はいろいろ学んだのでまだまだブログしようと思います。\u003c/p\u003e\n","createdAt":"2017-07-29T06:49:29Z","elapsedYearsFromLastModifiedAt":4,"encryptedId":"sPbXuujGYfiAZyeXz3LRILfY6sMMgbOL--FLUSIYVAlG/Y8mbT--/ueCN0m+cpfI931B5fHK/A==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2017-07-29T06:49:29Z","likesCount":7,"linkUrl":"https://qiita.com/TsuyoshiUshio@github/items/0ce3eef31461945e6bd8","organization":null,"originalId":512003,"stockedCount":12,"title":"TDD を実施するために Moq を試してみた 　その３ Fakes と他の方法で解決してみた","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%B8%AB%E5%8C%A0%E3%81%AE%E4%B8%80%E8%A8%80\"\u003e師匠の一言\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#fakes\"\u003eFakes\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1-shimscontext-%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003e1. ShimsContext の設定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2-secretbundle-%E3%81%AE-value-%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AEmock%E3%81%A1%E3%81%AA%E3%81%BF%E3%81%AB\"\u003e2. SecretBundle の Value メソッドのMockちなみに、\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3-keyvaultcientexensions-%E3%81%AE-getsecretasync-%E3%81%AEmock\"\u003e3. KeyVaultCientExensions の GetSecretAsync のMock\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%97%E3%81%8B%E3%81%97%E6%84%8F%E5%91%B3%E3%81%AF%E8%96%84%E3%81%84\"\u003eしかし、意味は薄い\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%87%91%E3%81%A7%E6%AE%B4%E3%82%89%E3%81%AA%E3%81%84%E5%8D%98%E7%B4%94%E3%81%AA%E8%A7%A3%E6%B1%BA%E7%AD%96\"\u003e金で殴らない単純な解決策\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB\"\u003eおわりに\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":5190,"uuid":"0ce3eef31461945e6bd8","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"GAEzjr77ZJid+1f7JrhC3SktSw==--OWGmD/1y/+dJWa/7--A4Dyn0i1XfHQ6+oyrLUiNg==","originalId":3470,"description":"プログラマ。自分の学習用のブログです。内容は会社とは一切関係ありません。","facebookUrl":null,"githubUrl":"https://github.com/TsuyoshiUshio","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"Ushio Tsuyoshi","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/3470/profile-images/1473683187","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=f09fda0ad182a04e6357e901c2c45fb7","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F3470%2Fprofile-images%2F1473683187?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=cda7476028a6ec9bbbb09934d2ac259e","urlName":"TsuyoshiUshio@github","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"TDD","urlName":"tdd"},{"name":"C#","urlName":"csharp"},{"name":"Moq","urlName":"moq"},{"name":"Fakes","urlName":"fakes"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
