<!DOCTYPE html><html><head><meta charset="utf-8" /><title>社内ドキュメントを検索できる『検索君』というシステムを、MFT 高速 Index × Elasticsearch にアップグレードしている話 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/kikuchi_kentaro/items/536bdb3606fd8dffcd50" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="lIuqzluqAW5MNopJUedjnvLXI/DhAXOMeWh/ihQOc5hD07NjDW5NGwQtKcBo2OQOIL/v+3bRPrjT/Wy9982NrA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="社内ドキュメントを検索できる『検索君』というシステムを、MFT 高速 Index × Elasticsearch にアップグレードしている話 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND01NlMtNVlhRjQ0T0o0NEt0NDRPbDQ0T2g0NE96NDRPSTQ0S1M1cVNjNTdTaTQ0R240NEdONDRLTDQ0Q081cVNjNTdTaTVaQ2I0NENQNDRHbzQ0R0U0NEdHNDRLMzQ0SzU0NE9HNDRPZzQ0S1M0NENCVFVaVUlPbXJtT21BbnlCSmJtUmxlQ0REbHlCRmJHRnpkR2xqYzJWaGNtTm9JT09CcS1PQ291T0RnLU9EbC1PQ3NPT0RyT09Edk9PRGllT0JsLU9CcHVPQmhPS0FwZyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz05NjBhZTg3MzEyZjdiNWEwMjAzYTM0YTRiMjljYmNjZQ&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3RwYTNWamFHbGZhMlZ1ZEdGeWJ3JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OTY4ODczNDg0MWI1NzZiMTI3YjVkNDRiNjdjOWVkZmQ&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=18020c34e363ba2650920877984c69ae"><meta property="og:description" content="以前、新人の研修担当をしていた時に、その新人が『社内ドキュメントを検索できるツールあったら便利じゃないか』という提案したことがある。

完成イメージ画像まで作っていて、名前は 『検索君』 だった。

弊社では、一部クラウド化はされてい..."><meta content="https://qiita.com/kikuchi_kentaro/items/536bdb3606fd8dffcd50" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Elixir,Elasticsearch,docker-compose,NTFS" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-d1a368f5-74a0-475d-bcfe-c83253d7e108"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fkikuchi_kentaro%2Fitems%2F536bdb3606fd8dffcd50">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fkikuchi_kentaro%2Fitems%2F536bdb3606fd8dffcd50">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-d1a368f5-74a0-475d-bcfe-c83253d7e108">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2017-12-20T09:01:03.000+09:00","dateModified":"2017-12-24T14:43:03.000+09:00","headline":"社内ドキュメントを検索できる『検索君』というシステムを、MFT 高速 Index × Elasticsearch にアップグレードしている話","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND01NlMtNVlhRjQ0T0o0NEt0NDRPbDQ0T2g0NE96NDRPSTQ0S1M1cVNjNTdTaTQ0R240NEdONDRLTDQ0Q081cVNjNTdTaTVaQ2I0NENQNDRHbzQ0R0U0NEdHNDRLMzQ0SzU0NE9HNDRPZzQ0S1M0NENCVFVaVUlPbXJtT21BbnlCSmJtUmxlQ0REbHlCRmJHRnpkR2xqYzJWaGNtTm9JT09CcS1PQ291T0RnLU9EbC1PQ3NPT0RyT09Edk9PRGllT0JsLU9CcHVPQmhPS0FwZyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz05NjBhZTg3MzEyZjdiNWEwMjAzYTM0YTRiMjljYmNjZQ\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3RwYTNWamFHbGZhMlZ1ZEdGeWJ3JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OTY4ODczNDg0MWI1NzZiMTI3YjVkNDRiNjdjOWVkZmQ\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=18020c34e363ba2650920877984c69ae","mainEntityOfPage":"https://qiita.com/kikuchi_kentaro/items/536bdb3606fd8dffcd50","author":{"@type":"Person","address":"","email":null,"identifier":"kikuchi_kentaro","name":"kikuchi_kentaro","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fprofile-images%2F1473682942?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=d7abf5d837cbe8a4298575cc7e4620ac","url":"https://qiita.com/kikuchi_kentaro","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"kikuchi_kentaro","type":"items","id":"536bdb3606fd8dffcd50"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"kikuchi_kentaro","type":"items","id":"536bdb3606fd8dffcd50"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"kikuchi_kentaro","type":"items","id":"536bdb3606fd8dffcd50"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/kikuchi_kentaro/items/536bdb3606fd8dffcd50","location":"/kikuchi_kentaro/items/536bdb3606fd8dffcd50","scheme":"https","host":"qiita.com","port":null,"pathname":"/kikuchi_kentaro/items/536bdb3606fd8dffcd50","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"fbnwCprx4PILVkf3QWl7hgQ59tw++VAs5ivVIffbKa2q4emnzDWsh0NN5H54VvwW1lE616kpHRhMvsYWFBjXmQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-4f74ba84-18ec-40b5-bd92-194e2b6c5ad7"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50/likers" class="css-1iupg5d">16</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">18</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/536bdb3606fd8dffcd50/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2017/softgiken" class="it-AdcalRibbon_title">ソフト技研<!-- --> Advent Calendar<!-- --> <!-- -->2017</a>Day 20</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/kikuchi_kentaro"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/20198/profile-images/1473682942" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/kikuchi_kentaro" class="css-10ougpm">@<!-- -->kikuchi_kentaro</a><div class="css-1ay9vb9"><span><meta content="2017-12-20T00:01:03Z"/><time dateTime="2017-12-24T05:43:03Z" class="css-m19uds">updated at 2017-12-24</time></span></div></div></div></div></div><h1 class="css-cgzq40">社内ドキュメントを検索できる『検索君』というシステムを、MFT 高速 Index × Elasticsearch にアップグレードしている話</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/elixir" class="css-4czcte">Elixir</a><a href="/tags/elasticsearch" class="css-4czcte">Elasticsearch</a><a href="/tags/docker-compose" class="css-4czcte">docker-compose</a><a href="/tags/ntfs" class="css-4czcte">NTFS</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>以前、新人の研修担当をしていた時に、その新人が『社内ドキュメントを検索できるツールあったら便利じゃないか』という提案したことがある。</p>

<p>完成イメージ画像まで作っていて、名前は <strong>『検索君』</strong> だった。</p>

<p>弊社では、一部クラウド化はされているものの、様々な事情で未だ NAS に大量のドキュメントが置かれている。<br>
管理はしっかりされている一方、とにかく量が多く階層も深く、探すのが辛かった。</p>

<p>新人が、しっかりと新人の目でその不満点を見ていた事に感心し、作るのも簡単そうだったのでサクッと作ってみた。</p>

<h1>
<span id="初代-検索君" class="fragment"></span><a href="#%E5%88%9D%E4%BB%A3-%E6%A4%9C%E7%B4%A2%E5%90%9B"><i class="fa fa-link"></i></a>初代 検索君</h1>

<p><a href="https://camo.qiitausercontent.com/c72d41bdb69194e42bd3ee0b2ef669c3b544c0dd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f36343233333864632d346334652d643737632d316363322d3362326533383036373637312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F642338dc-4c4e-d77c-1cc2-3b2e38067671.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6fdefaeb56d6ce39e65ffadf708f2ad1" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/20198/642338dc-4c4e-d77c-1cc2-3b2e38067671.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F642338dc-4c4e-d77c-1cc2-3b2e38067671.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=7b734ddc14a512cf313621e973d09066 1x" loading="lazy"></a></p>

<p>初代検索くんは、数時間で作られてこともあり、便利さは限定的だった。</p>

<h2>
<span id="実行環境" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>実行環境</h2>

<ul>
<li>Ruby

<ul>
<li>Sinatra</li>
<li>groonga</li>
</ul>
</li>
<li>Frontend

<ul>
<li>riot.js</li>
<li>Bulma.css</li>
</ul>
</li>
</ul>

<h2>
<span id="できる事" class="fragment"></span><a href="#%E3%81%A7%E3%81%8D%E3%82%8B%E4%BA%8B"><i class="fa fa-link"></i></a>できる事</h2>

<ul>
<li>NAS 内とクラウドストレージのシームレス検索

<ul>
<li>NAS</li>
<li>Google Drive</li>
</ul>
</li>
<li>検索エンジンは groonga</li>
<li>ファイルパスでの部分一致検索</li>
</ul>

<h2>
<span id="できない事" class="fragment"></span><a href="#%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E4%BA%8B"><i class="fa fa-link"></i></a>できない事</h2>

<ul>
<li>コンテンツでの検索</li>
<li>あいまい検索</li>
<li>Index は手動で数時間 ~ 数日かかる

<ul>
<li>
<code>Find.find</code> で検索が遅かった</li>
<li>一旦作ると、再 Index 化が面倒でやらなくなる

<ul>
<li>現実と乖離していく Index</li>
</ul>
</li>
</ul>
</li>
</ul>

<h2>
<span id="直したい所" class="fragment"></span><a href="#%E7%9B%B4%E3%81%97%E3%81%9F%E3%81%84%E6%89%80"><i class="fa fa-link"></i></a>直したい所</h2>

<p>とにかく、<strong>現実との乖離</strong> はサービスの価値としては致命的なので、これをまず何とかしたい。</p>

<h1>
<span id="二代目-j-soul-検索君" class="fragment"></span><a href="#%E4%BA%8C%E4%BB%A3%E7%9B%AE-j-soul-%E6%A4%9C%E7%B4%A2%E5%90%9B"><i class="fa fa-link"></i></a>二代目 J Soul 検索君</h1>

<p>二代目でやりたい事は、</p>

<ul>
<li>MFT による Index の高速化</li>
<li>検索エンジンを Elasticsearch に</li>
<li>Web API を Elixir 化</li>
<li>Docker 化</li>
</ul>

<p><a href="https://camo.qiitausercontent.com/623c126716d245f7169c8ef2799db65e82efbcce/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f62383263616132622d313231382d636532642d333637652d3166326139656139626262372e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fb82caa2b-1218-ce2d-367e-1f2a9ea9bbb7.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e0eb5398bd6435d41c214b897e254f08" alt="kensaku (1).png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/20198/b82caa2b-1218-ce2d-367e-1f2a9ea9bbb7.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fb82caa2b-1218-ce2d-367e-1f2a9ea9bbb7.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f56d8c949d82303b9f1ec67224d4c580 1x" loading="lazy"></a></p>

<p>実際のソースコードは全てGithub にある。</p>

<p><a href="https://github.com/kentork/kensakukun" rel="nofollow noopener" target="_blank">github.com/kentork/kensakukun</a><br>
<a href="https://github.com/kentork/tansakukun" rel="nofollow noopener" target="_blank">github.com/kentork/tansakukun</a></p>

<h2>
<span id="mft-による-index-の高速化" class="fragment"></span><a href="#mft-%E3%81%AB%E3%82%88%E3%82%8B-index-%E3%81%AE%E9%AB%98%E9%80%9F%E5%8C%96"><i class="fa fa-link"></i></a>MFT による Index の高速化</h2>

<p>NTFS ファイルシステムには、 MFT ( Master File Table ) という全てのファイルエントリを管理する親玉ファイルが存在する。</p>

<p>どうやら、 Everything 等の高速 Index 検索ツールもこれを使って高速化しているらしいと聞き、検索君もこれを使って高速化できないだろうかと挑戦してみた。</p>

<p>以下、参考に</p>

<p><a href="https://ja.wikipedia.org/wiki/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC_%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB_%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB" rel="nofollow noopener" target="_blank">Wikipedia - マスター ファイル テーブル</a><br>
<a href="https://qiita.com/kusano_k/items/45b0a86649aabb8040ff" id="reference-44c7838dcb75e88ef368">NTFSの読み方</a></p>

<h3>
<span id="情報がない" class="fragment"></span><a href="#%E6%83%85%E5%A0%B1%E3%81%8C%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>情報がない</h3>

<p>全然無い。<br>
ソースコードはチラチラと見つかるが、古かったりよく分からなかったりと、とにかく無い。</p>

<p>取り敢えず、良さそうなサンプルソースをいくつか読み解きながら、主にこのコードを参考に進めた。</p>

<p><a href="https://code.msdn.microsoft.com/windowsdesktop/CCS-LABS-C-Accessing-the-d317805c/sourcecode" rel="nofollow noopener" target="_blank">CCS LABS C#: Accessing the Master File Table</a></p>

<p>● 参考</p>

<p><a href="https://stackoverflow.com/questions/21661798/how-do-we-access-mft-through-c-sharp" rel="nofollow noopener" target="_blank">stackoverflow - How do we access MFT through C#<br>
</a><br>
<a href="https://stackoverflow.com/questions/31938722/how-to-read-file-attributes-using-master-file-table-data" rel="nofollow noopener" target="_blank">How to read file attributes using Master File Table data<br>
</a><br>
<a href="https://stackoverflow.com/questions/24724343/get-file-info-from-ntfs-mft-reference-number" rel="nofollow noopener" target="_blank">Get file info from NTFS-MFT reference number<br>
</a></p>

<h3>
<span id="開発" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA"><i class="fa fa-link"></i></a>開発</h3>

<p>役割としては検索君とは独立しているため、プロジェクトを切りだした。</p>

<p><a href="https://github.com/kentork/tansakukun" rel="nofollow noopener" target="_blank">github.com/kentork/tansakukun</a></p>

<h4>
<span id="-開発環境" class="fragment"></span><a href="#-%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>◆ 開発環境</h4>

<ul>
<li>Windows 10</li>
<li>VS Code</li>
<li>DotNet SDK 2.3.1 ( x86 )</li>
</ul>

<h4>
<span id="-c-プロジェクト作成" class="fragment"></span><a href="#-c-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>◆ C# プロジェクト作成</h4>

<p>C# を書くのは久しぶりなので、まずは C# の環境を作るところから始める。<br>
以下、 <a href="https://qiita.com/kikuchi_kentaro/items/77793e4a21db6ffdb7cd" id="reference-541e3f40596d0fb30be2">scoop は使えるものとして進める</a></p>

<p>まずは、DotNet SDK を入れる。</p>

<div class="code-frame" data-lang="ps1"><div class="highlight"><pre class="with-code"><code>PS&gt; scoop install -a x86 dotnet-sdk
</code></pre></div></div>

<p><font color="silver">※ 今回は、x86向けにビルドする必要があるので、アーキテクチャを指定している。x64 を使っている人は何とか頑張ってください</font></p>

<p>次に、<a href="https://qiita.com/kikuchi_kentaro/items/f500f261d1292ebe2941" id="reference-b0b7f23b08aee2c8a233">gh コマンド</a> で Github プロジェクトを作り、C# プロジェクトとして初期化する。</p>

<div class="code-frame" data-lang="ps1"><div class="highlight"><pre class="with-code"><code>PS&gt; gh create

# create kentork/tansakukun project

PS&gt; gh cd kentork/tansakukun
PS&gt; dotnet new console -o .
</code></pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre class="with-code"><code>├── ./Program.cs
├── ./tansakukun.csproj
└── ./obj
    ├── ./obj/tansakukun.csproj.nuget.cache
    ├── ./obj/tansakukun.csproj.nuget.g.props
    ├── ./obj/tansakukun.csproj.nuget.g.targets
    └── ./obj/project.assets.json
</code></pre></div></div>

<h4>
<span id="-サンプル実行" class="fragment"></span><a href="#-%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>◆ サンプル実行</h4>

<p><a href="https://code.msdn.microsoft.com/windowsdesktop/CCS-LABS-C-Accessing-the-d317805c/sourcecode?fileId=60931&amp;pathId=477876996" rel="nofollow noopener" target="_blank">サンプルソース</a> を実行してみたが、以下でエラーが出たので、ちょっと直した。</p>

<div class="code-frame" data-lang="diff"><div class="highlight"><pre class="with-code"><code><span class="gd">-      [DllImport("kernel32.dll")]
-      public static extern void ZeroMemory(IntPtr ptr, Int32 size);
</span><span class="gi">+      [DllImport("Kernel32.dll", EntryPoint = "RtlZeroMemory", SetLastError = false)]
+      public static extern void ZeroMemory(IntPtr ptr, Int32 size);
</span></code></pre></div></div>

<p>実行</p>

<div class="code-frame" data-lang="ps1"><div class="highlight"><pre class="with-code"><code>PS&gt; dotnet restore
PS&gt; dotnet run
</code></pre></div></div>

<p>これで、一応動いたんだけど、取れるのはファイル名だけだった。<br>
以降、カスタマイズしていく。</p>

<h4>
<span id="-フルパス取得" class="fragment"></span><a href="#-%E3%83%95%E3%83%AB%E3%83%91%E3%82%B9%E5%8F%96%E5%BE%97"><i class="fa fa-link"></i></a>◆ フルパス取得</h4>

<p>まずは、これをフルパスにする機能を追加した。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>  <span class="k">public</span> <span class="k">class</span> <span class="nc">FileNameAndParentFrn</span>
  <span class="p">{</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">_name</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span>
    <span class="p">{</span>
      <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_name</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">set</span> <span class="p">{</span> <span class="n">_name</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="kt">string</span> <span class="n">_path</span> <span class="p">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Path</span>
    <span class="p">{</span>
      <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_path</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">set</span> <span class="p">{</span> <span class="n">_path</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">UInt64</span> <span class="n">_parentFrn</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">UInt64</span> <span class="n">ParentFrn</span>
    <span class="p">{</span>
      <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_parentFrn</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">set</span> <span class="p">{</span> <span class="n">_parentFrn</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">FileNameAndParentFrn</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">UInt64</span> <span class="n">parentFrn</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">name</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">_name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"Invalid argument: null or Length = zero"</span><span class="p">,</span> <span class="s">"name"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(!(</span><span class="n">parentFrn</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">_parentFrn</span> <span class="p">=</span> <span class="n">parentFrn</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"Invalid argument: less than zero"</span><span class="p">,</span> <span class="s">"parentFrn"</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">...</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ResolvePath</span><span class="p">(</span><span class="kt">string</span> <span class="n">drive</span><span class="p">,</span> <span class="k">ref</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">ulong</span><span class="p">,</span> <span class="n">FileNameAndParentFrn</span><span class="p">&gt;</span> <span class="n">files</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">ulong</span><span class="p">,</span> <span class="n">FileNameAndParentFrn</span><span class="p">&gt;</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">files</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">FileNameAndParentFrn</span> <span class="n">file</span> <span class="p">=</span> <span class="p">(</span><span class="n">FileNameAndParentFrn</span><span class="p">)</span><span class="n">entry</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
        <span class="n">file</span><span class="p">.</span><span class="n">Path</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Concat</span><span class="p">(</span><span class="nf">FrnToParentDirectory</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">ParentFrn</span><span class="p">),</span> <span class="n">Path</span><span class="p">.</span><span class="n">DirectorySeparatorChar</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="nf">FrnToParentDirectory</span><span class="p">(</span><span class="kt">string</span> <span class="n">drive</span><span class="p">,</span> <span class="kt">ulong</span> <span class="n">frn</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(!</span><span class="n">_directories</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">frn</span><span class="p">))</span> <span class="k">return</span> <span class="s">""</span><span class="p">;</span>

      <span class="kt">var</span> <span class="n">parent</span> <span class="p">=</span> <span class="n">_directories</span><span class="p">[</span><span class="n">frn</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">ParentFrn</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">drive</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">Path</span> <span class="p">!=</span> <span class="s">""</span><span class="p">)</span> <span class="k">return</span> <span class="n">parent</span><span class="p">.</span><span class="n">Path</span><span class="p">;</span>

      <span class="n">parent</span><span class="p">.</span><span class="n">Path</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Concat</span><span class="p">(</span><span class="nf">FrnToParentDirectory</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">parent</span><span class="p">.</span><span class="n">ParentFrn</span><span class="p">),</span> <span class="n">Path</span><span class="p">.</span><span class="n">DirectorySeparatorChar</span><span class="p">,</span> <span class="n">parent</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">parent</span><span class="p">.</span><span class="n">Path</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>ファイルをリストしている間に、実はフォルダも全部リストアップしていたのでそれを使った。<br>
やっていることは、親への Reference を辿りながら、パスを結合していくというシンプルなもの。</p>

<p>C# 的に再帰ってどうなの？とは思ったけど、眠くてこれ以外にアルゴリズムが思いつかなかった。</p>

<p>これで、フルパスが取れるようになった。<br>
ローカルマシンで確認した所、『C:』から350万ぐらいのファイルを読み込んで、2分弱 ( CPU Core i5, Mem 16GB )。早い。</p>

<h4>
<span id="-巨大な壁" class="fragment"></span><a href="#-%E5%B7%A8%E5%A4%A7%E3%81%AA%E5%A3%81"><i class="fa fa-link"></i></a>◆ 巨大な壁</h4>

<p>ここで、試しに社内の NAS に繋いでみようと思ったが、１つ疑問が。</p>

<p><strong>あれ、共有フォルダって Drive Letter 無いよね？</strong></p>

<p>とは言え、ホスト名とか入れれば動くんでしょ、と思ってやってみたが、駄目だった。<br>
ネットワークドライブの割当も駄目。</p>

<p>え、NAS 繋がらないの？ <strong>意味ないじゃん！！</strong></p>

<p>しかし、MFT をつかっているであろう高速 Index ツールにも、共有フォルダに対応する物はあるので、できないことは無いのでは、と思っている。</p>

<p>今の所、対策は無い。</p>

<p>[追記]<br>
さっき、出張から戻った同僚に相談したら、なんだかんだで MFT を取るのは難しんじゃないかと言う感じになった。<br>
さて、次の方法を考えないと。。。</p>

<h2>
<span id="検索エンジンを-elasticsearch-に" class="fragment"></span><a href="#%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%82%92-elasticsearch-%E3%81%AB"><i class="fa fa-link"></i></a>検索エンジンを Elasticsearch に</h2>

<p>次に、検索エンジンを groonga から Elasticsearch に変更。<br>
安定感、アクセスのしやすさ、情報の多さ、これまでの経験を含めて、Elasticsearch がベストと判断。</p>

<h3>
<span id="開発-1" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA-1"><i class="fa fa-link"></i></a>開発</h3>

<p>Elasticsearch は Docker として立ち上げる。<br>
これは、検索君のプロジェクトで管理している。</p>

<div class="code-frame" data-lang="yaml">
<div class="code-lang"><span class="bold">docker-compose.yaml</span></div>
<div class="highlight"><pre class="with-code"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">es</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">es</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:6.1.1</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9200:9200"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">es_data:/usr/share/elasticsearch/data</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ELASTIC_PASSWORD=MagicWord</span>
      <span class="pi">-</span> <span class="s">ES_JAVA_OPTS=-Xms512m -Xmx512m</span>
      <span class="pi">-</span> <span class="s">transport.host=0.0.0.0</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span>
      <span class="pi">-</span> <span class="s">discovery.type=single-node</span>
      <span class="c1"># - cluster.name=full-house</span>
      <span class="c1"># - node.name=Jesse</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">default</span>

<span class="nn">...</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">es_data</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s1">'</span><span class="s">local'</span>

</code></pre></div>
</div>

<p>Elasticsearch のイメージは、<code>library/elasticsearch</code> ではなく <code>docker.elastic.co/elasticsearch/elasticsearch</code> が公式サポート版。</p>

<p>今の所、クラスタを組む気は無いため、<code>single-node</code> で動作している。</p>

<h4>
<span id="-elasticsearch-に-bulk-insert" class="fragment"></span><a href="#-elasticsearch-%E3%81%AB-bulk-insert"><i class="fa fa-link"></i></a>◆ Elasticsearch に Bulk Insert</h4>

<p>上記で Elasticsearch を立ち上げたら、まずは tansakukun の方から入れ込む。<br>
C# から Elasticsearch を操作をする場合、以下クライアントが公式にサポートされている。</p>

<ul>
<li>
<a href="https://github.com/elastic/elasticsearch-net" rel="nofollow noopener" target="_blank">NEST</a>

<ul>
<li>Higl Level Client と呼ばれている</li>
<li>LINQ っぽい Query DSL で操作可能</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/client/net-api/current/nest.html" rel="nofollow noopener" target="_blank">NEST - High level client</a></li>
</ul>
</li>
<li>
<a href="https://github.com/elastic/elasticsearch-net" rel="nofollow noopener" target="_blank">Elasticsearch.Net</a>

<ul>
<li>Low Level Client と呼ばれている</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/client/net-api/current/elasticsearch-net.html" rel="nofollow noopener" target="_blank">Elasticsearch.Net - Low level client</a></li>
</ul>
</li>
</ul>

<p><strong>Bulk API が提供されているのは Elasticsearch.Net だけ</strong> なので、コッチを使う。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code>  <span class="k">public</span> <span class="k">class</span> <span class="nc">BulkInsert</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">execute</span><span class="p">(</span><span class="kt">string</span> <span class="n">host</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">ulong</span><span class="p">,</span> <span class="n">FileNameAndParentFrn</span><span class="p">&gt;</span> <span class="n">files</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chunkSize</span> <span class="p">=</span> <span class="m">10000</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">var</span> <span class="n">settings</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConnectionConfiguration</span><span class="p">(</span><span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"http://"</span> <span class="p">+</span> <span class="n">host</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">port</span><span class="p">))</span>
                          <span class="p">.</span><span class="nf">RequestTimeout</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromMinutes</span><span class="p">(</span><span class="m">2</span><span class="p">));</span>
      <span class="kt">var</span> <span class="n">lowlevelClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ElasticLowLevelClient</span><span class="p">(</span><span class="n">settings</span><span class="p">);</span>

      <span class="kt">var</span> <span class="n">index</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"yyyyMMddHHmmss"</span><span class="p">);</span>
      <span class="kt">var</span> <span class="n">type</span> <span class="p">=</span> <span class="s">"pathes"</span><span class="p">;</span>

      <span class="kt">long</span> <span class="n">id</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">chank</span> <span class="k">in</span> <span class="n">files</span><span class="p">.</span><span class="n">Values</span><span class="p">.</span><span class="nf">Chunks</span><span class="p">(</span><span class="n">chunkSize</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="n">chank</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">json</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Index</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">type</span><span class="p">));</span>
          <span class="n">json</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">FileEntry</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">Path</span><span class="p">,</span> <span class="s">""</span><span class="p">));</span>

          <span class="n">id</span><span class="p">++;</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">indexResponse</span> <span class="p">=</span> <span class="n">lowlevelClient</span><span class="p">.</span><span class="n">Bulk</span><span class="p">&lt;</span><span class="n">StreamResponse</span><span class="p">&gt;(</span><span class="n">PostData</span><span class="p">.</span><span class="nf">MultiJson</span><span class="p">(</span><span class="n">json</span><span class="p">));</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">responseStream</span> <span class="p">=</span> <span class="n">indexResponse</span><span class="p">.</span><span class="n">Body</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// from https://webbibouroku.com/Blog/Article/chunk-linq</span>
  <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Extensions</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">Chunks</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="n">list</span><span class="p">.</span><span class="nf">Take</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="n">list</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="nf">Skip</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Index.cs</span></div>
<div class="highlight"><pre class="with-code"><code>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Index</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="n">Metadata</span> <span class="n">index</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">Index</span><span class="p">(</span><span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">string</span> <span class="n">_index</span><span class="p">,</span> <span class="kt">string</span> <span class="n">type</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">index</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Metadata</span><span class="p">(</span><span class="n">_index</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">id</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">Metadata</span>
    <span class="p">{</span>
      <span class="k">public</span> <span class="nf">Metadata</span><span class="p">(</span><span class="kt">string</span> <span class="n">index</span><span class="p">,</span> <span class="kt">string</span> <span class="n">type</span><span class="p">,</span> <span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">_index</span> <span class="p">=</span> <span class="n">index</span><span class="p">;</span>
        <span class="n">_type</span> <span class="p">=</span> <span class="n">type</span><span class="p">;</span>
        <span class="n">_id</span> <span class="p">=</span> <span class="n">id</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">public</span> <span class="kt">string</span> <span class="n">_index</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">public</span> <span class="kt">string</span> <span class="n">_type</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">public</span> <span class="kt">string</span> <span class="n">_id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">FileEntry.cs</span></div>
<div class="highlight"><pre class="with-code"><code>  <span class="k">public</span> <span class="k">class</span> <span class="nc">FileEntry</span>
  <span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">path</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">date</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">FileEntry</span><span class="p">(</span><span class="kt">string</span> <span class="n">path</span><span class="p">,</span> <span class="kt">string</span> <span class="n">date</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="n">path</span> <span class="p">=</span> <span class="n">path</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="n">date</span> <span class="p">=</span> <span class="n">date</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>
</div>

<p>ポイントとしては、</p>

<ul>
<li>起動時間毎に新しい Index をつくる</li>
<li>Index のオブジェクトと Data のオブジェクトを交互に渡すと、勝手に Serialize してくれる</li>
<li>10000 ファイルずつチャンクして Bulk</li>
</ul>

<p>10000 ファイルでチャンクしたのは、HTTPリクエストと大量データ送信の程よい均衡点を探しての事。<br>
設定ファイルで変更可能であり、現在は 2~50000 ファイルあたりでもパフォーマンス調査しているが、失敗もなく時間増加も線形的なので、もっと増やしてみたい。</p>

<p>先程の350万レコードを挿入して、大体 15 分程度だった。まぁまぁ早い。</p>

<p>※ 後で気付いたけど、<strong>Elasticsearch に日本語検索のプラグイン入れてなかった</strong>。パフォーマンス確実に変わるので、上記は参考程度に。</p>

<h2>
<span id="web-サーバを-elixir-化" class="fragment"></span><a href="#web-%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92-elixir-%E5%8C%96"><i class="fa fa-link"></i></a>Web サーバを Elixir 化</h2>

<p>これは、以前の Ruby + Sinatra のままでも良かったのだが、クエリ検索の機能があまり優秀ではなかったりして、もう少し本格的にしていきたいなぁと。</p>

<p>で、そうなると Ruby + Sinatra だと少し不安だなぁ。ということで、 Elixir にした。<br>
速度や安定感もさることながら、<strong>データ加工</strong> が素晴らしい。</p>

<h4>
<span id="-elixir" class="fragment"></span><a href="#-elixir"><i class="fa fa-link"></i></a>◆ Elixir</h4>

<p>パイプラインやパターンマッチ等で流れるようにデータが加工できるのがとても良く、データを少し加工して返すシンプルな API サーバとしてとても優秀だと実感した。<br>
以下の資料に、その素晴らしさがまとめられている。</p>

<p><a href="https://www.slideshare.net/piacere_ex/elixirphoenix" rel="nofollow noopener" target="_blank">やや関数型を意識した風Elixir／Phoenixご紹介</a></p>

<p>辛かったのは、まとまった良い情報が Web 上にあまり無いこと。<br>
同時期に Rust も書いていたが、あっちは公式も充実していたし記事も多かった。<br>
仕方なく、昔買った <a href="https://www.amazon.co.jp/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0Elixir-Dave-Thomas/dp/4274219151" rel="nofollow noopener" target="_blank">プログラミングElixir</a> を見ながら頑張った。</p>

<h3>
<span id="開発-2" class="fragment"></span><a href="#%E9%96%8B%E7%99%BA-2"><i class="fa fa-link"></i></a>開発</h3>

<p>メインプロジェクトとして、Elasticsearch 等クラスタ管理も仕切る。</p>

<p><a href="https://github.com/kentork/kensakukun" rel="nofollow noopener" target="_blank">github.com/kentork/kensakukun</a></p>

<h4>
<span id="-開発環境-1" class="fragment"></span><a href="#-%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83-1"><i class="fa fa-link"></i></a>◆ 開発環境</h4>

<ul>
<li>Windows 10</li>
<li>VS Code</li>
<li>Erlang OTP 20</li>
<li>Elixir 1.6.0-dev</li>
</ul>

<h4>
<span id="-elixir-プロジェクト作成" class="fragment"></span><a href="#-elixir-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>◆ Elixir プロジェクト作成</h4>

<p>Elixir を書くのも久しぶりなので、まずは Elixir の環境を作るところから始める。<br>
以下、 <a href="https://qiita.com/kikuchi_kentaro/items/77793e4a21db6ffdb7cd">scoop は使えるものとして進める</a></p>

<p>本来は、Docker で動かしたかったが、変更監視 → Recompile の手法が見つけられなかったので、今回はローカルでの動作を前提とする。</p>

<div class="code-frame" data-lang="ps1"><div class="highlight"><pre class="with-code"><code>PS&gt; scoop install elixir
</code></pre></div></div>

<p>次に、<a href="https://qiita.com/kikuchi_kentaro/items/f500f261d1292ebe2941">gh コマンド</a> で Github プロジェクトを作り、Elixir プロジェクトとして初期化する。</p>

<div class="code-frame" data-lang="ps1"><div class="highlight"><pre class="with-code"><code>PS&gt; gh create

# create kentork/kensakukun project

PS&gt; gh cd kentork/kensakukun 
PS&gt; cd ..
PS&gt; mix new kensakukun 
# The directory "hoge" already exists. Are you sure you want to continue? [Yn] y
</code></pre></div></div>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre class="with-code"><code>├── ./LICENSE.txt
├── ./README.md
├── ./config
│   └── ./config/config.exs
├── ./lib
│   └── ./lib/kensakukun.ex
├── ./mix.exs
└── ./test
    ├── ./test/kensakukun_test.exs
    └── ./test/test_helper.exs
</code></pre></div></div>

<h4>
<span id="-依存パッケージを追加" class="fragment"></span><a href="#-%E4%BE%9D%E5%AD%98%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E8%BF%BD%E5%8A%A0"><i class="fa fa-link"></i></a>◆ 依存パッケージを追加</h4>

<p>今回は、Phoenix 等のフルスタックフレームワークは要らないので、シンプルに plug だけの web サーバを考える。</p>

<div class="code-frame" data-lang="elixir">
<div class="code-lang"><span class="bold">mix.exs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="o">...</span>
  <span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
    <span class="p">[</span>
      <span class="p">{</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="s2">"~&gt; 1.1"</span><span class="p">},</span>
      <span class="p">{</span><span class="ss">:plug</span><span class="p">,</span> <span class="s2">"~&gt; 1.5.0-rc.0"</span><span class="p">},</span>
      <span class="p">{</span><span class="ss">:poison</span><span class="p">,</span> <span class="s2">"~&gt; 3.1.0"</span><span class="p">},</span>
      <span class="p">{</span><span class="ss">:httpotion</span><span class="p">,</span> <span class="s2">"~&gt; 3.0.3"</span><span class="p">}</span>
    <span class="p">]</span>
  <span class="k">end</span>
<span class="o">...</span>
</code></pre></div>
</div>

<p>Webサーバは <strong>cowboy</strong> で、Rack 的な Web インターフェイスに <strong>plug</strong>。<br>
JSON パーサとして <strong>poison</strong> を利用。<br>
Elasticsearch へのクエリは、クライアントを使わずに <strong>httpotion</strong> でリクエストする。</p>

<h4>
<span id="-application" class="fragment"></span><a href="#-application"><i class="fa fa-link"></i></a>◆ Application</h4>

<div class="code-frame" data-lang="elixir">
<div class="code-lang"><span class="bold">kensakukun.ex</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">defmodule</span> <span class="no">Kensakukun</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Application</span>
  <span class="kn">require</span> <span class="no">Logger</span>

  <span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
      <span class="no">Plug</span><span class="o">.</span><span class="no">Adapters</span><span class="o">.</span><span class="no">Cowboy</span><span class="o">.</span><span class="n">child_spec</span><span class="p">(</span><span class="ss">:http</span><span class="p">,</span> <span class="no">Kensakukun</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">Router</span><span class="p">,</span> <span class="p">[],</span> <span class="ss">port:</span> <span class="mi">8080</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="no">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Started application"</span><span class="p">)</span>

    <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>

<h4>
<span id="-routing" class="fragment"></span><a href="#-routing"><i class="fa fa-link"></i></a>◆ Routing</h4>

<div class="code-frame" data-lang="elixir">
<div class="code-lang"><span class="bold">plug/router.ex</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">defmodule</span> <span class="no">Kensakukun</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Router</span>
  <span class="kn">require</span> <span class="no">Logger</span>

  <span class="k">if</span> <span class="no">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">()</span> <span class="o">==</span> <span class="ss">:dev</span> <span class="k">do</span>
    <span class="kn">use</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Debugger</span>
  <span class="k">end</span>

  <span class="n">plug</span><span class="p">(</span><span class="no">Plug</span><span class="o">.</span><span class="no">Logger</span><span class="p">)</span>
  <span class="n">plug</span><span class="p">(</span><span class="no">Plug</span><span class="o">.</span><span class="no">Parsers</span><span class="p">,</span> <span class="ss">parsers:</span> <span class="p">[</span><span class="ss">:json</span><span class="p">],</span> <span class="ss">json_decoder:</span> <span class="no">Poison</span><span class="p">)</span>

  <span class="n">plug</span><span class="p">(</span><span class="ss">:match</span><span class="p">)</span>
  <span class="n">plug</span><span class="p">(</span><span class="ss">:dispatch</span><span class="p">)</span>

  <span class="n">get</span> <span class="s2">"/api/oauth/google/client_id"</span> <span class="k">do</span>
    <span class="n">client_id</span> <span class="o">=</span> <span class="no">Application</span><span class="o">.</span><span class="n">fetch_env!</span><span class="p">(</span><span class="ss">:kensakukun</span><span class="p">,</span> <span class="ss">:api_token</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">client_id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">get</span> <span class="s2">"/api/search"</span> <span class="k">do</span>
    <span class="n">index</span> <span class="o">=</span>
      <span class="no">Kensakukun</span><span class="o">.</span><span class="no">Elasticsearch</span><span class="o">.</span><span class="n">get_indices</span><span class="p">()</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">max_by</span><span class="p">(</span><span class="o">&amp;</span><span class="no">Integer</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">[</span><span class="s2">"index"</span><span class="p">]))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="no">Kensakukun</span><span class="o">.</span><span class="no">Elasticsearch</span><span class="o">.</span><span class="n">search_path</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">"index"</span><span class="p">],</span> <span class="n">conn</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">"query"</span><span class="p">])</span>

    <span class="n">pathes</span> <span class="o">=</span>
      <span class="no">Poison</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="p">(</span><span class="k">fn</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">result</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">result</span> <span class="k">end</span><span class="p">)</span><span class="o">.</span><span class="p">()</span>

    <span class="n">resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">pathes</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">match</span> <span class="n">_</span> <span class="k">do</span>
    <span class="n">resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">"Not Found"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
</div>

<p>クライアントで使う Google API 用の Client ID は、クライアントに埋め込見たくない。<br>
ので、エンドポイントを 1つ設けてある。</p>

<h4>
<span id="-elasticsearch-の操作" class="fragment"></span><a href="#-elasticsearch-%E3%81%AE%E6%93%8D%E4%BD%9C"><i class="fa fa-link"></i></a>◆ Elasticsearch の操作</h4>

<p>これは、通常の HTTP を用いる普通のやり方。特に無し。</p>

<p>350 万件から部分一致件検索で 1000件取得して 150 ms 前後。<br>
以前に比べて数倍~数十倍早いんじゃなかろうか。</p>

<p>インクリメンタル検索も夢じゃない？</p>

<p><a href="https://camo.qiitausercontent.com/cedf1d96e7e5ac8b3f7d01c74f6e6176ce02ac28/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f62326264373031352d636261322d653266392d383037662d3732343138613030363439362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fb2bd7015-cba2-e2f9-807f-72418a006496.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fcdff5f1ac41ebc64b4c2827c3ad9778" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/20198/b2bd7015-cba2-e2f9-807f-72418a006496.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fb2bd7015-cba2-e2f9-807f-72418a006496.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=924bc6521faeea12a3d9d11fcb118264 1x" loading="lazy"></a></p>

<p>※ 後で気付いたけど、<strong>Elasticsearch に日本語検索のプラグイン入れてなかった</strong>。パフォーマンス変わるので参考程度に。</p>

<h4>
<span id="-docker-化" class="fragment"></span><a href="#-docker-%E5%8C%96"><i class="fa fa-link"></i></a>◆ Docker 化</h4>

<p>本番 ( と言っても社内だが ) に向けて、Docker 化はしておきたい。<br>
公式のパッケージが Hex や Rebar を含んでおらず、入れていないと毎度聞かれるのが面倒なので、あらかじめ入れたイメージを作っておく。</p>

<div class="code-frame" data-lang="dockerfile">
<div class="code-lang"><span class="bold">Dockerfile</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">FROM</span><span class="s"> elixir:1.5.3-alpine</span>
<span class="k">RUN </span>mix local.hex <span class="nt">--force</span> <span class="o">&amp;&amp;</span> mix local.rebar <span class="nt">--force</span>
</code></pre></div>
</div>

<p>サービス定義はこんな感じ</p>

<div class="code-frame" data-lang="yaml">
<div class="code-lang"><span class="bold">docker-compose.yaml</span></div>
<div class="highlight"><pre class="with-code"><code><span class="nn">...</span>
  <span class="na">api-init</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">api-init</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./:/usr/src/app</span>
      <span class="pi">-</span> <span class="s">elixir_cache:/usr/src/app/deps</span>
    <span class="na">working_dir</span><span class="pi">:</span> <span class="s">/usr/src/app</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">sh -c "mix deps.get &amp;&amp; mix compile"</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">default</span>
  <span class="na">api</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">api</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:8080"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">MIX_ENV=prod</span>
      <span class="pi">-</span> <span class="s">ES_HOST=es</span>
      <span class="pi">-</span> <span class="s">ES_PORT=9200</span>
    <span class="na">env_file</span><span class="pi">:</span> <span class="s">.env</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./:/usr/src/app</span>
      <span class="pi">-</span> <span class="s">elixir_cache:/usr/src/app/deps</span>
    <span class="na">working_dir</span><span class="pi">:</span> <span class="s">/usr/src/app</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s">mix run --no-halt</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">default</span>
<span class="nn">...</span>
</code></pre></div>
</div>

<p>渡した環境変数は、<code>config/prod.exs</code> で参照している。<br>
<code>API_TOKEN</code> だけは、便宜上 <code>.env</code> から取得している。</p>

<div class="code-frame" data-lang="elixir">
<div class="code-lang"><span class="bold">config/prod.exs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="kn">use</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Config</span>

<span class="n">config</span> <span class="ss">:kensakukun</span><span class="p">,</span>
  <span class="ss">es_host:</span> <span class="no">System</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">"ES_HOST"</span><span class="p">),</span>
  <span class="ss">es_port:</span> <span class="no">System</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">"ES_PORT"</span><span class="p">),</span>
  <span class="ss">api_token:</span> <span class="no">System</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">"API_TOKEN"</span><span class="p">)</span>

</code></pre></div>
</div>

<p>動かす時は、一度初期化が必要。</p>

<div class="code-frame" data-lang="bash"><div class="highlight"><pre class="with-code"><code>docker-compose run <span class="nt">--rm</span> api-init
docker-compose up <span class="nt">-d</span> api
</code></pre></div></div>

<h2>
<span id="フロントエンド" class="fragment"></span><a href="#%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89"><i class="fa fa-link"></i></a>フロントエンド</h2>

<ul>
<li>Riot.js v3.7.4</li>
<li>Bulma.css v0.6.1</li>
</ul>

<p>ここは、ほぼ初代からの流用である。バージョンだけ上げている。<br>
やはり、Riotjs + Bulma.css の組み合わせは、ぱっと作るのに向いている。</p>

<p>配信は、<a href="https://caddyserver.com/" rel="nofollow noopener" target="_blank">Caddy</a> が担当している。</p>

<div class="code-frame" data-lang="yaml">
<div class="code-lang"><span class="bold">docker-compose.yaml</span></div>
<div class="highlight"><pre class="with-code"><code><span class="nn">...</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">web</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">abiosoft/caddy:latest</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">443:2015"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./Site/Caddyfile:/etc/Caddyfile</span>
      <span class="pi">-</span> <span class="s">./Site/public:/srv</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">default</span>
<span class="nn">...</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>Site
├── Caddyfile
└── public
    ├── 404.html
    ├── component
    │   └── app.tag
    ├── css
    │   ├── bulma.min.css
    │   └── font-awesome.min.css
    ├── favicons
    │   ├── android-icon-144x144.png
    │   ├── ...
    │   └── ms-icon-70x70.png
    ├── fonts
    │   ├── FontAwesome.otf
    │   ├── ...
    │   └── fontawesome-webfont.woff2
    ├── images
    │   ├── drive.png
    │   ├── folder.png
    │   └── kensaku.png
    ├── index.html
    └── js
        ├── clipboard.min.js
        └── riot+compiler.min.js
</code></pre></div></div>

<div class="code-frame" data-lang="">
<div class="code-lang"><span class="bold">Caddyfile</span></div>
<div class="highlight"><pre class="with-code"><code>0.0.0.0 {
  root /srv
  gzip
  tls self_signed

  index index.html
  errors {
    404 404.html
  }

  proxy /api http://api:8080/ {
    transparent
  }
}
</code></pre></div>
</div>

<p>これだけで、 HTTPS + HTTP2 (+ quic) + Reverse Proxy。素晴らしい。</p>

<p><a href="https://camo.qiitausercontent.com/2b553c48340144cd012096ac8802965a5499c899/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f32633837306539622d356233342d663635362d303332342d3336306561363232333036612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F2c870e9b-5b34-f656-0324-360ea622306a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2b9a1020a42a655985421d14de6e1349" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/20198/2c870e9b-5b34-f656-0324-360ea622306a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F2c870e9b-5b34-f656-0324-360ea622306a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=642ce6544bef3860500bf45212ca258e 1x" loading="lazy"></a></p>

<h1>
<span id="docker-化" class="fragment"></span><a href="#docker-%E5%8C%96"><i class="fa fa-link"></i></a>Docker 化</h1>

<p>ここまでで Docker 化終わってるので。</p>

<p>現在、ローカルでは一応動いている。</p>

<p><a href="https://camo.qiitausercontent.com/cb252b592b3c92544d2b8c11e75fc386c959a52f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f38313162616662612d633033332d366563642d663636652d6633366336363332393663342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F811bafba-c033-6ecd-f66e-f36c663296c4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d5c36703d69743ab706702f8b12e5673" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/20198/811bafba-c033-6ecd-f66e-f36c663296c4.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F811bafba-c033-6ecd-f66e-f36c663296c4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8806e1dbae1a149d0b5f5f5afe903fc8 1x" loading="lazy"></a></p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>検索は確実に早くなるでしょう。</p>

<p>しかし、Index 化が早くならなくては余り意味がない。<br>
最新の情報があるという保証がなければ、サービスの価値は低い。<br>
少なくとも、1日1回は走らせたい。その為には、せいぜい <strong>30分~1時間以内</strong> は欲しい。</p>

<p>とにかく、ネットワークの向こうの NAS をいかに高速に Index するか考えなくては。<br>
MFT が取れるのか、それとも取れないのか。<br>
MFT から取らないのなら、他に方法は無いのか。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fkikuchi_kentaro%2Fitems%2F536bdb3606fd8dffcd50&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fkikuchi_kentaro%2Fitems%2F536bdb3606fd8dffcd50&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50/likers" class="css-1iupg5d">16</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">18</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/536bdb3606fd8dffcd50/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/kikuchi_kentaro/items/536bdb3606fd8dffcd50.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-4f74ba84-18ec-40b5-bd92-194e2b6c5ad7">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-94a61735-41ec-45af-814a-f5107189e9c4"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-94a61735-41ec-45af-814a-f5107189e9c4">{}</script>
      
<div id="LoginModal-react-component-8effcb8b-5a09-4ae5-88e7-9091d4670b48"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-8effcb8b-5a09-4ae5-88e7-9091d4670b48">{}</script>
      
<div id="StockModal-react-component-c675a472-1e91-4627-9a64-94b4d2385689"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-c675a472-1e91-4627-9a64-94b4d2385689">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;jzLy7VmsNkspcoCEkkn3KLKFW3LtUGK7nsOcch02g3tYautAD2h6PmFpIw2rdnC4YO2XeXqAL480Vo9F/vV9Tw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e以前、新人の研修担当をしていた時に、その新人が『社内ドキュメントを検索できるツールあったら便利じゃないか』という提案したことがある。\u003c/p\u003e\n\n\u003cp\u003e完成イメージ画像まで作っていて、名前は \u003cstrong\u003e『検索君』\u003c/strong\u003e だった。\u003c/p\u003e\n\n\u003cp\u003e弊社では、一部クラウド化はされているものの、様々な事情で未だ NAS に大量のドキュメントが置かれている。\u003cbr\u003e\n管理はしっかりされている一方、とにかく量が多く階層も深く、探すのが辛かった。\u003c/p\u003e\n\n\u003cp\u003e新人が、しっかりと新人の目でその不満点を見ていた事に感心し、作るのも簡単そうだったのでサクッと作ってみた。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"初代-検索君\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%88%9D%E4%BB%A3-%E6%A4%9C%E7%B4%A2%E5%90%9B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e初代 検索君\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/c72d41bdb69194e42bd3ee0b2ef669c3b544c0dd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f36343233333864632d346334652d643737632d316363322d3362326533383036373637312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F642338dc-4c4e-d77c-1cc2-3b2e38067671.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=6fdefaeb56d6ce39e65ffadf708f2ad1\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/20198/642338dc-4c4e-d77c-1cc2-3b2e38067671.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F642338dc-4c4e-d77c-1cc2-3b2e38067671.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=7b734ddc14a512cf313621e973d09066 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e初代検索くんは、数時間で作られてこともあり、便利さは限定的だった。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実行環境\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実行環境\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eRuby\n\n\u003cul\u003e\n\u003cli\u003eSinatra\u003c/li\u003e\n\u003cli\u003egroonga\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eFrontend\n\n\u003cul\u003e\n\u003cli\u003eriot.js\u003c/li\u003e\n\u003cli\u003eBulma.css\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"できる事\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%A7%E3%81%8D%E3%82%8B%E4%BA%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eできる事\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eNAS 内とクラウドストレージのシームレス検索\n\n\u003cul\u003e\n\u003cli\u003eNAS\u003c/li\u003e\n\u003cli\u003eGoogle Drive\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e検索エンジンは groonga\u003c/li\u003e\n\u003cli\u003eファイルパスでの部分一致検索\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"できない事\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E4%BA%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eできない事\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eコンテンツでの検索\u003c/li\u003e\n\u003cli\u003eあいまい検索\u003c/li\u003e\n\u003cli\u003eIndex は手動で数時間 ~ 数日かかる\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eFind.find\u003c/code\u003e で検索が遅かった\u003c/li\u003e\n\u003cli\u003e一旦作ると、再 Index 化が面倒でやらなくなる\n\n\u003cul\u003e\n\u003cli\u003e現実と乖離していく Index\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"直したい所\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%9B%B4%E3%81%97%E3%81%9F%E3%81%84%E6%89%80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e直したい所\u003c/h2\u003e\n\n\u003cp\u003eとにかく、\u003cstrong\u003e現実との乖離\u003c/strong\u003e はサービスの価値としては致命的なので、これをまず何とかしたい。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"二代目-j-soul-検索君\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BA%8C%E4%BB%A3%E7%9B%AE-j-soul-%E6%A4%9C%E7%B4%A2%E5%90%9B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e二代目 J Soul 検索君\u003c/h1\u003e\n\n\u003cp\u003e二代目でやりたい事は、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eMFT による Index の高速化\u003c/li\u003e\n\u003cli\u003e検索エンジンを Elasticsearch に\u003c/li\u003e\n\u003cli\u003eWeb API を Elixir 化\u003c/li\u003e\n\u003cli\u003eDocker 化\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/623c126716d245f7169c8ef2799db65e82efbcce/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f62383263616132622d313231382d636532642d333637652d3166326139656139626262372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fb82caa2b-1218-ce2d-367e-1f2a9ea9bbb7.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e0eb5398bd6435d41c214b897e254f08\" alt=\"kensaku (1).png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/20198/b82caa2b-1218-ce2d-367e-1f2a9ea9bbb7.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fb82caa2b-1218-ce2d-367e-1f2a9ea9bbb7.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f56d8c949d82303b9f1ec67224d4c580 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e実際のソースコードは全てGithub にある。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/kentork/kensakukun\" rel=\"nofollow noopener\" target=\"_blank\"\u003egithub.com/kentork/kensakukun\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/kentork/tansakukun\" rel=\"nofollow noopener\" target=\"_blank\"\u003egithub.com/kentork/tansakukun\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"mft-による-index-の高速化\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#mft-%E3%81%AB%E3%82%88%E3%82%8B-index-%E3%81%AE%E9%AB%98%E9%80%9F%E5%8C%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eMFT による Index の高速化\u003c/h2\u003e\n\n\u003cp\u003eNTFS ファイルシステムには、 MFT ( Master File Table ) という全てのファイルエントリを管理する親玉ファイルが存在する。\u003c/p\u003e\n\n\u003cp\u003eどうやら、 Everything 等の高速 Index 検索ツールもこれを使って高速化しているらしいと聞き、検索君もこれを使って高速化できないだろうかと挑戦してみた。\u003c/p\u003e\n\n\u003cp\u003e以下、参考に\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC_%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB_%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB\" rel=\"nofollow noopener\" target=\"_blank\"\u003eWikipedia - マスター ファイル テーブル\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/kusano_k/items/45b0a86649aabb8040ff\" id=\"reference-44c7838dcb75e88ef368\"\u003eNTFSの読み方\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"情報がない\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%83%85%E5%A0%B1%E3%81%8C%E3%81%AA%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e情報がない\u003c/h3\u003e\n\n\u003cp\u003e全然無い。\u003cbr\u003e\nソースコードはチラチラと見つかるが、古かったりよく分からなかったりと、とにかく無い。\u003c/p\u003e\n\n\u003cp\u003e取り敢えず、良さそうなサンプルソースをいくつか読み解きながら、主にこのコードを参考に進めた。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://code.msdn.microsoft.com/windowsdesktop/CCS-LABS-C-Accessing-the-d317805c/sourcecode\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCCS LABS C#: Accessing the Master File Table\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e● 参考\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/21661798/how-do-we-access-mft-through-c-sharp\" rel=\"nofollow noopener\" target=\"_blank\"\u003estackoverflow - How do we access MFT through C#\u003cbr\u003e\n\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://stackoverflow.com/questions/31938722/how-to-read-file-attributes-using-master-file-table-data\" rel=\"nofollow noopener\" target=\"_blank\"\u003eHow to read file attributes using Master File Table data\u003cbr\u003e\n\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://stackoverflow.com/questions/24724343/get-file-info-from-ntfs-mft-reference-number\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGet file info from NTFS-MFT reference number\u003cbr\u003e\n\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"開発\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%96%8B%E7%99%BA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e開発\u003c/h3\u003e\n\n\u003cp\u003e役割としては検索君とは独立しているため、プロジェクトを切りだした。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/kentork/tansakukun\" rel=\"nofollow noopener\" target=\"_blank\"\u003egithub.com/kentork/tansakukun\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-開発環境\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ 開発環境\u003c/h4\u003e\n\n\u003cul\u003e\n\u003cli\u003eWindows 10\u003c/li\u003e\n\u003cli\u003eVS Code\u003c/li\u003e\n\u003cli\u003eDotNet SDK 2.3.1 ( x86 )\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-c-プロジェクト作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-c-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ C# プロジェクト作成\u003c/h4\u003e\n\n\u003cp\u003eC# を書くのは久しぶりなので、まずは C# の環境を作るところから始める。\u003cbr\u003e\n以下、 \u003ca href=\"https://qiita.com/kikuchi_kentaro/items/77793e4a21db6ffdb7cd\" id=\"reference-541e3f40596d0fb30be2\"\u003escoop は使えるものとして進める\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eまずは、DotNet SDK を入れる。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"ps1\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ePS\u0026gt; scoop install -a x86 dotnet-sdk\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cfont color=\"silver\"\u003e※ 今回は、x86向けにビルドする必要があるので、アーキテクチャを指定している。x64 を使っている人は何とか頑張ってください\u003c/font\u003e\u003c/p\u003e\n\n\u003cp\u003e次に、\u003ca href=\"https://qiita.com/kikuchi_kentaro/items/f500f261d1292ebe2941\" id=\"reference-b0b7f23b08aee2c8a233\"\u003egh コマンド\u003c/a\u003e で Github プロジェクトを作り、C# プロジェクトとして初期化する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"ps1\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ePS\u0026gt; gh create\n\n# create kentork/tansakukun project\n\nPS\u0026gt; gh cd kentork/tansakukun\nPS\u0026gt; dotnet new console -o .\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"bash\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e├── ./Program.cs\n├── ./tansakukun.csproj\n└── ./obj\n    ├── ./obj/tansakukun.csproj.nuget.cache\n    ├── ./obj/tansakukun.csproj.nuget.g.props\n    ├── ./obj/tansakukun.csproj.nuget.g.targets\n    └── ./obj/project.assets.json\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-サンプル実行\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E5%AE%9F%E8%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ サンプル実行\u003c/h4\u003e\n\n\u003cp\u003e\u003ca href=\"https://code.msdn.microsoft.com/windowsdesktop/CCS-LABS-C-Accessing-the-d317805c/sourcecode?fileId=60931\u0026amp;pathId=477876996\" rel=\"nofollow noopener\" target=\"_blank\"\u003eサンプルソース\u003c/a\u003e を実行してみたが、以下でエラーが出たので、ちょっと直した。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"diff\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gd\"\u003e-      [DllImport(\"kernel32.dll\")]\n-      public static extern void ZeroMemory(IntPtr ptr, Int32 size);\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+      [DllImport(\"Kernel32.dll\", EntryPoint = \"RtlZeroMemory\", SetLastError = false)]\n+      public static extern void ZeroMemory(IntPtr ptr, Int32 size);\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e実行\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"ps1\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ePS\u0026gt; dotnet restore\nPS\u0026gt; dotnet run\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれで、一応動いたんだけど、取れるのはファイル名だけだった。\u003cbr\u003e\n以降、カスタマイズしていく。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-フルパス取得\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-%E3%83%95%E3%83%AB%E3%83%91%E3%82%B9%E5%8F%96%E5%BE%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ フルパス取得\u003c/h4\u003e\n\n\u003cp\u003eまずは、これをフルパスにする機能を追加した。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFileNameAndParentFrn\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_name\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eName\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_name\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eset\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003e_name\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_path\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ePath\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_path\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eset\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003e_path\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eUInt64\u003c/span\u003e \u003cspan class=\"n\"\u003e_parentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eUInt64\u003c/span\u003e \u003cspan class=\"n\"\u003eParentFrn\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_parentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eset\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003e_parentFrn\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eFileNameAndParentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUInt64\u003c/span\u003e \u003cspan class=\"n\"\u003eparentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_name\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Invalid argument: null or Length = zero\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!(\u003c/span\u003e\u003cspan class=\"n\"\u003eparentFrn\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_parentFrn\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eparentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Invalid argument: less than zero\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"parentFrn\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eResolvePath\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003edrive\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eulong\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileNameAndParentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003efiles\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyValuePair\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eulong\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileNameAndParentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003efiles\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eFileNameAndParentFrn\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFileNameAndParentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eFrnToParentDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edrive\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectorySeparatorChar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eFrnToParentDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003edrive\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eulong\u003c/span\u003e \u003cspan class=\"n\"\u003efrn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003e_directories\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContainsKey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efrn\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n      \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eparent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_directories\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003efrn\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParentFrn\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003edrive\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eparent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n      \u003cspan class=\"n\"\u003eparent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConcat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eFrnToParentDirectory\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edrive\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eparent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDirectorySeparatorChar\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eparent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eparent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eファイルをリストしている間に、実はフォルダも全部リストアップしていたのでそれを使った。\u003cbr\u003e\nやっていることは、親への Reference を辿りながら、パスを結合していくというシンプルなもの。\u003c/p\u003e\n\n\u003cp\u003eC# 的に再帰ってどうなの？とは思ったけど、眠くてこれ以外にアルゴリズムが思いつかなかった。\u003c/p\u003e\n\n\u003cp\u003eこれで、フルパスが取れるようになった。\u003cbr\u003e\nローカルマシンで確認した所、『C:』から350万ぐらいのファイルを読み込んで、2分弱 ( CPU Core i5, Mem 16GB )。早い。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-巨大な壁\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-%E5%B7%A8%E5%A4%A7%E3%81%AA%E5%A3%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ 巨大な壁\u003c/h4\u003e\n\n\u003cp\u003eここで、試しに社内の NAS に繋いでみようと思ったが、１つ疑問が。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eあれ、共有フォルダって Drive Letter 無いよね？\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eとは言え、ホスト名とか入れれば動くんでしょ、と思ってやってみたが、駄目だった。\u003cbr\u003e\nネットワークドライブの割当も駄目。\u003c/p\u003e\n\n\u003cp\u003eえ、NAS 繋がらないの？ \u003cstrong\u003e意味ないじゃん！！\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eしかし、MFT をつかっているであろう高速 Index ツールにも、共有フォルダに対応する物はあるので、できないことは無いのでは、と思っている。\u003c/p\u003e\n\n\u003cp\u003e今の所、対策は無い。\u003c/p\u003e\n\n\u003cp\u003e[追記]\u003cbr\u003e\nさっき、出張から戻った同僚に相談したら、なんだかんだで MFT を取るのは難しんじゃないかと言う感じになった。\u003cbr\u003e\nさて、次の方法を考えないと。。。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"検索エンジンを-elasticsearch-に\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%82%92-elasticsearch-%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e検索エンジンを Elasticsearch に\u003c/h2\u003e\n\n\u003cp\u003e次に、検索エンジンを groonga から Elasticsearch に変更。\u003cbr\u003e\n安定感、アクセスのしやすさ、情報の多さ、これまでの経験を含めて、Elasticsearch がベストと判断。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"開発-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%96%8B%E7%99%BA-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e開発\u003c/h3\u003e\n\n\u003cp\u003eElasticsearch は Docker として立ち上げる。\u003cbr\u003e\nこれは、検索君のプロジェクトで管理している。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"yaml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003edocker-compose.yaml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"na\"\u003eversion\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s1\"\u003e'\u003c/span\u003e\u003cspan class=\"s\"\u003e3'\u003c/span\u003e\n\n\u003cspan class=\"na\"\u003eservices\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ees\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003econtainer_name\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ees\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003edocker.elastic.co/elasticsearch/elasticsearch:6.1.1\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eports\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"\u003c/span\u003e\u003cspan class=\"s\"\u003e9200:9200\"\u003c/span\u003e\n    \u003cspan class=\"na\"\u003evolumes\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003ees_data:/usr/share/elasticsearch/data\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eenvironment\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eELASTIC_PASSWORD=MagicWord\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eES_JAVA_OPTS=-Xms512m -Xmx512m\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003etransport.host=0.0.0.0\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003ebootstrap.memory_lock=true\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003ediscovery.type=single-node\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e# - cluster.name=full-house\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e# - node.name=Jesse\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eulimits\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ememlock\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003esoft\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e-1\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ehard\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e-1\u003c/span\u003e\n    \u003cspan class=\"na\"\u003enetworks\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003edefault\u003c/span\u003e\n\n\u003cspan class=\"nn\"\u003e...\u003c/span\u003e\n\n\u003cspan class=\"na\"\u003evolumes\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ees_data\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003edriver\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s1\"\u003e'\u003c/span\u003e\u003cspan class=\"s\"\u003elocal'\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eElasticsearch のイメージは、\u003ccode\u003elibrary/elasticsearch\u003c/code\u003e ではなく \u003ccode\u003edocker.elastic.co/elasticsearch/elasticsearch\u003c/code\u003e が公式サポート版。\u003c/p\u003e\n\n\u003cp\u003e今の所、クラスタを組む気は無いため、\u003ccode\u003esingle-node\u003c/code\u003e で動作している。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-elasticsearch-に-bulk-insert\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-elasticsearch-%E3%81%AB-bulk-insert\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ Elasticsearch に Bulk Insert\u003c/h4\u003e\n\n\u003cp\u003e上記で Elasticsearch を立ち上げたら、まずは tansakukun の方から入れ込む。\u003cbr\u003e\nC# から Elasticsearch を操作をする場合、以下クライアントが公式にサポートされている。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://github.com/elastic/elasticsearch-net\" rel=\"nofollow noopener\" target=\"_blank\"\u003eNEST\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eHigl Level Client と呼ばれている\u003c/li\u003e\n\u003cli\u003eLINQ っぽい Query DSL で操作可能\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/client/net-api/current/nest.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eNEST - High level client\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://github.com/elastic/elasticsearch-net\" rel=\"nofollow noopener\" target=\"_blank\"\u003eElasticsearch.Net\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eLow Level Client と呼ばれている\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.elastic.co/guide/en/elasticsearch/client/net-api/current/elasticsearch-net.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eElasticsearch.Net - Low level client\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003eBulk API が提供されているのは Elasticsearch.Net だけ\u003c/strong\u003e なので、コッチを使う。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBulkInsert\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eexecute\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ehost\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eport\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eulong\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileNameAndParentFrn\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003efiles\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003echunkSize\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e10000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esettings\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eConnectionConfiguration\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eUri\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"http://\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ehost\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\":\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eport\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                          \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRequestTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTimeSpan\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromMinutes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n      \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elowlevelClient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eElasticLowLevelClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esettings\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n      \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"yyyyMMddHHmmss\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n      \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"pathes\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n      \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003echank\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003efiles\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValues\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eChunks\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echunkSize\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ejson\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003echank\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n          \u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFileEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n          \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eindexResponse\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elowlevelClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBulk\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eStreamResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ePostData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMultiJson\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresponseStream\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eindexResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBody\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\".\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// from https://webbibouroku.com/Blog/Article/chunk-linq\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eExtensions\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eChunks\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAny\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elist\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSkip\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eIndex.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eIndex\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eMetadata\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_index\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eMetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_index\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMetadata\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eMetadata\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_index\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_type\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_id\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_index\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_type\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_id\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eFileEntry.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFileEntry\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eFileEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eポイントとしては、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e起動時間毎に新しい Index をつくる\u003c/li\u003e\n\u003cli\u003eIndex のオブジェクトと Data のオブジェクトを交互に渡すと、勝手に Serialize してくれる\u003c/li\u003e\n\u003cli\u003e10000 ファイルずつチャンクして Bulk\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e10000 ファイルでチャンクしたのは、HTTPリクエストと大量データ送信の程よい均衡点を探しての事。\u003cbr\u003e\n設定ファイルで変更可能であり、現在は 2~50000 ファイルあたりでもパフォーマンス調査しているが、失敗もなく時間増加も線形的なので、もっと増やしてみたい。\u003c/p\u003e\n\n\u003cp\u003e先程の350万レコードを挿入して、大体 15 分程度だった。まぁまぁ早い。\u003c/p\u003e\n\n\u003cp\u003e※ 後で気付いたけど、\u003cstrong\u003eElasticsearch に日本語検索のプラグイン入れてなかった\u003c/strong\u003e。パフォーマンス確実に変わるので、上記は参考程度に。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"web-サーバを-elixir-化\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#web-%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92-elixir-%E5%8C%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eWeb サーバを Elixir 化\u003c/h2\u003e\n\n\u003cp\u003eこれは、以前の Ruby + Sinatra のままでも良かったのだが、クエリ検索の機能があまり優秀ではなかったりして、もう少し本格的にしていきたいなぁと。\u003c/p\u003e\n\n\u003cp\u003eで、そうなると Ruby + Sinatra だと少し不安だなぁ。ということで、 Elixir にした。\u003cbr\u003e\n速度や安定感もさることながら、\u003cstrong\u003eデータ加工\u003c/strong\u003e が素晴らしい。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-elixir\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-elixir\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ Elixir\u003c/h4\u003e\n\n\u003cp\u003eパイプラインやパターンマッチ等で流れるようにデータが加工できるのがとても良く、データを少し加工して返すシンプルな API サーバとしてとても優秀だと実感した。\u003cbr\u003e\n以下の資料に、その素晴らしさがまとめられている。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.slideshare.net/piacere_ex/elixirphoenix\" rel=\"nofollow noopener\" target=\"_blank\"\u003eやや関数型を意識した風Elixir／Phoenixご紹介\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e辛かったのは、まとまった良い情報が Web 上にあまり無いこと。\u003cbr\u003e\n同時期に Rust も書いていたが、あっちは公式も充実していたし記事も多かった。\u003cbr\u003e\n仕方なく、昔買った \u003ca href=\"https://www.amazon.co.jp/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0Elixir-Dave-Thomas/dp/4274219151\" rel=\"nofollow noopener\" target=\"_blank\"\u003eプログラミングElixir\u003c/a\u003e を見ながら頑張った。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"開発-2\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%96%8B%E7%99%BA-2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e開発\u003c/h3\u003e\n\n\u003cp\u003eメインプロジェクトとして、Elasticsearch 等クラスタ管理も仕切る。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/kentork/kensakukun\" rel=\"nofollow noopener\" target=\"_blank\"\u003egithub.com/kentork/kensakukun\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-開発環境-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ 開発環境\u003c/h4\u003e\n\n\u003cul\u003e\n\u003cli\u003eWindows 10\u003c/li\u003e\n\u003cli\u003eVS Code\u003c/li\u003e\n\u003cli\u003eErlang OTP 20\u003c/li\u003e\n\u003cli\u003eElixir 1.6.0-dev\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-elixir-プロジェクト作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-elixir-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ Elixir プロジェクト作成\u003c/h4\u003e\n\n\u003cp\u003eElixir を書くのも久しぶりなので、まずは Elixir の環境を作るところから始める。\u003cbr\u003e\n以下、 \u003ca href=\"https://qiita.com/kikuchi_kentaro/items/77793e4a21db6ffdb7cd\"\u003escoop は使えるものとして進める\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e本来は、Docker で動かしたかったが、変更監視 → Recompile の手法が見つけられなかったので、今回はローカルでの動作を前提とする。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"ps1\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ePS\u0026gt; scoop install elixir\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e次に、\u003ca href=\"https://qiita.com/kikuchi_kentaro/items/f500f261d1292ebe2941\"\u003egh コマンド\u003c/a\u003e で Github プロジェクトを作り、Elixir プロジェクトとして初期化する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"ps1\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003ePS\u0026gt; gh create\n\n# create kentork/kensakukun project\n\nPS\u0026gt; gh cd kentork/kensakukun \nPS\u0026gt; cd ..\nPS\u0026gt; mix new kensakukun \n# The directory \"hoge\" already exists. Are you sure you want to continue? [Yn] y\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"bash\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e├── ./LICENSE.txt\n├── ./README.md\n├── ./config\n│   └── ./config/config.exs\n├── ./lib\n│   └── ./lib/kensakukun.ex\n├── ./mix.exs\n└── ./test\n    ├── ./test/kensakukun_test.exs\n    └── ./test/test_helper.exs\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-依存パッケージを追加\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-%E4%BE%9D%E5%AD%98%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E8%BF%BD%E5%8A%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ 依存パッケージを追加\u003c/h4\u003e\n\n\u003cp\u003e今回は、Phoenix 等のフルスタックフレームワークは要らないので、シンプルに plug だけの web サーバを考える。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"elixir\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003emix.exs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\n  \u003cspan class=\"k\"\u003edefp\u003c/span\u003e \u003cspan class=\"n\"\u003edeps\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"ss\"\u003e:cowboy\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"~\u0026gt; 1.1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"ss\"\u003e:plug\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"~\u0026gt; 1.5.0-rc.0\"\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"ss\"\u003e:poison\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"~\u0026gt; 3.1.0\"\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"ss\"\u003e:httpotion\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"~\u0026gt; 3.0.3\"\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"o\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eWebサーバは \u003cstrong\u003ecowboy\u003c/strong\u003e で、Rack 的な Web インターフェイスに \u003cstrong\u003eplug\u003c/strong\u003e。\u003cbr\u003e\nJSON パーサとして \u003cstrong\u003epoison\u003c/strong\u003e を利用。\u003cbr\u003e\nElasticsearch へのクエリは、クライアントを使わずに \u003cstrong\u003ehttpotion\u003c/strong\u003e でリクエストする。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-application\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-application\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ Application\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"elixir\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ekensakukun.ex\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003edefmodule\u003c/span\u003e \u003cspan class=\"no\"\u003eKensakukun\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n  \u003cspan class=\"kn\"\u003euse\u003c/span\u003e \u003cspan class=\"no\"\u003eApplication\u003c/span\u003e\n  \u003cspan class=\"kn\"\u003erequire\u003c/span\u003e \u003cspan class=\"no\"\u003eLogger\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_type\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_args\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n    \u003cspan class=\"n\"\u003echildren\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"no\"\u003ePlug\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eAdapters\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eCowboy\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003echild_spec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003e:http\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003eKensakukun\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003ePlug\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eRouter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[],\u003c/span\u003e \u003cspan class=\"ss\"\u003eport:\u003c/span\u003e \u003cspan class=\"mi\"\u003e8080\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\n    \u003cspan class=\"no\"\u003eLogger\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"Started application\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"no\"\u003eSupervisor\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estart_link\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echildren\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003estrategy:\u003c/span\u003e \u003cspan class=\"ss\"\u003e:one_for_one\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-routing\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-routing\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ Routing\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"elixir\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eplug/router.ex\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003edefmodule\u003c/span\u003e \u003cspan class=\"no\"\u003eKensakukun\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003ePlug\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eRouter\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n  \u003cspan class=\"kn\"\u003euse\u003c/span\u003e \u003cspan class=\"no\"\u003ePlug\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eRouter\u003c/span\u003e\n  \u003cspan class=\"kn\"\u003erequire\u003c/span\u003e \u003cspan class=\"no\"\u003eLogger\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"no\"\u003eMix\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"ss\"\u003e:dev\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n    \u003cspan class=\"kn\"\u003euse\u003c/span\u003e \u003cspan class=\"no\"\u003ePlug\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eDebugger\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003eplug\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"no\"\u003ePlug\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eLogger\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eplug\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"no\"\u003ePlug\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eParsers\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003eparsers:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"ss\"\u003e:json\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"ss\"\u003ejson_decoder:\u003c/span\u003e \u003cspan class=\"no\"\u003ePoison\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003eplug\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003e:match\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eplug\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003e:dispatch\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003eget\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"/api/oauth/google/client_id\"\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eclient_id\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eApplication\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efetch_env!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003e:kensakukun\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003e:api_token\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eclient_id\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003eget\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"/api/search\"\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\n      \u003cspan class=\"no\"\u003eKensakukun\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eElasticsearch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget_indices\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"no\"\u003eEnum\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emax_by\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"no\"\u003eInteger\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eparse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e\u0026amp;1\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"index\"\u003c/span\u003e\u003cspan class=\"p\"\u003e]))\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eKensakukun\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eElasticsearch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esearch_path\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"index\"\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"query\"\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003epathes\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e\n      \u003cspan class=\"no\"\u003ePoison\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eencode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e|\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efn\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"ss\"\u003e:ok\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"k\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epathes\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003ematch\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e404\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"Not Found\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eクライアントで使う Google API 用の Client ID は、クライアントに埋め込見たくない。\u003cbr\u003e\nので、エンドポイントを 1つ設けてある。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-elasticsearch-の操作\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-elasticsearch-%E3%81%AE%E6%93%8D%E4%BD%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ Elasticsearch の操作\u003c/h4\u003e\n\n\u003cp\u003eこれは、通常の HTTP を用いる普通のやり方。特に無し。\u003c/p\u003e\n\n\u003cp\u003e350 万件から部分一致件検索で 1000件取得して 150 ms 前後。\u003cbr\u003e\n以前に比べて数倍~数十倍早いんじゃなかろうか。\u003c/p\u003e\n\n\u003cp\u003eインクリメンタル検索も夢じゃない？\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/cedf1d96e7e5ac8b3f7d01c74f6e6176ce02ac28/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f62326264373031352d636261322d653266392d383037662d3732343138613030363439362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fb2bd7015-cba2-e2f9-807f-72418a006496.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=fcdff5f1ac41ebc64b4c2827c3ad9778\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/20198/b2bd7015-cba2-e2f9-807f-72418a006496.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fb2bd7015-cba2-e2f9-807f-72418a006496.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=924bc6521faeea12a3d9d11fcb118264 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e※ 後で気付いたけど、\u003cstrong\u003eElasticsearch に日本語検索のプラグイン入れてなかった\u003c/strong\u003e。パフォーマンス変わるので参考程度に。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"-docker-化\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#-docker-%E5%8C%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e◆ Docker 化\u003c/h4\u003e\n\n\u003cp\u003e本番 ( と言っても社内だが ) に向けて、Docker 化はしておきたい。\u003cbr\u003e\n公式のパッケージが Hex や Rebar を含んでおらず、入れていないと毎度聞かれるのが面倒なので、あらかじめ入れたイメージを作っておく。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"dockerfile\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eDockerfile\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eFROM\u003c/span\u003e\u003cspan class=\"s\"\u003e elixir:1.5.3-alpine\u003c/span\u003e\n\u003cspan class=\"k\"\u003eRUN \u003c/span\u003emix local.hex \u003cspan class=\"nt\"\u003e--force\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e mix local.rebar \u003cspan class=\"nt\"\u003e--force\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eサービス定義はこんな感じ\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"yaml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003edocker-compose.yaml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nn\"\u003e...\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eapi-init\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003econtainer_name\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eapi-init\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ebuild\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e.\u003c/span\u003e\n    \u003cspan class=\"na\"\u003evolumes\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e./:/usr/src/app\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eelixir_cache:/usr/src/app/deps\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eworking_dir\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/src/app\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eentrypoint\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003esh -c \"mix deps.get \u0026amp;\u0026amp; mix compile\"\u003c/span\u003e\n    \u003cspan class=\"na\"\u003enetworks\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003edefault\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eapi\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003econtainer_name\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eapi\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ebuild\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e.\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eports\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"\u003c/span\u003e\u003cspan class=\"s\"\u003e8080:8080\"\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eenvironment\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eMIX_ENV=prod\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eES_HOST=es\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eES_PORT=9200\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eenv_file\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e.env\u003c/span\u003e\n    \u003cspan class=\"na\"\u003evolumes\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e./:/usr/src/app\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eelixir_cache:/usr/src/app/deps\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eworking_dir\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/src/app\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eentrypoint\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003emix run --no-halt\u003c/span\u003e\n    \u003cspan class=\"na\"\u003enetworks\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003edefault\u003c/span\u003e\n\u003cspan class=\"nn\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e渡した環境変数は、\u003ccode\u003econfig/prod.exs\u003c/code\u003e で参照している。\u003cbr\u003e\n\u003ccode\u003eAPI_TOKEN\u003c/code\u003e だけは、便宜上 \u003ccode\u003e.env\u003c/code\u003e から取得している。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"elixir\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003econfig/prod.exs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kn\"\u003euse\u003c/span\u003e \u003cspan class=\"no\"\u003eMix\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"no\"\u003eConfig\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003econfig\u003c/span\u003e \u003cspan class=\"ss\"\u003e:kensakukun\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"ss\"\u003ees_host:\u003c/span\u003e \u003cspan class=\"no\"\u003eSystem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget_env\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"ES_HOST\"\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n  \u003cspan class=\"ss\"\u003ees_port:\u003c/span\u003e \u003cspan class=\"no\"\u003eSystem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget_env\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"ES_PORT\"\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n  \u003cspan class=\"ss\"\u003eapi_token:\u003c/span\u003e \u003cspan class=\"no\"\u003eSystem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget_env\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\"API_TOKEN\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e動かす時は、一度初期化が必要。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"bash\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003edocker-compose run \u003cspan class=\"nt\"\u003e--rm\u003c/span\u003e api-init\ndocker-compose up \u003cspan class=\"nt\"\u003e-d\u003c/span\u003e api\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"フロントエンド\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eフロントエンド\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eRiot.js v3.7.4\u003c/li\u003e\n\u003cli\u003eBulma.css v0.6.1\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eここは、ほぼ初代からの流用である。バージョンだけ上げている。\u003cbr\u003e\nやはり、Riotjs + Bulma.css の組み合わせは、ぱっと作るのに向いている。\u003c/p\u003e\n\n\u003cp\u003e配信は、\u003ca href=\"https://caddyserver.com/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eCaddy\u003c/a\u003e が担当している。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"yaml\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003edocker-compose.yaml\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"nn\"\u003e...\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eweb\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003econtainer_name\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eweb\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eabiosoft/caddy:latest\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eports\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"\u003c/span\u003e\u003cspan class=\"s\"\u003e443:2015\"\u003c/span\u003e\n    \u003cspan class=\"na\"\u003evolumes\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e./Site/Caddyfile:/etc/Caddyfile\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e./Site/public:/srv\u003c/span\u003e\n    \u003cspan class=\"na\"\u003enetworks\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003edefault\u003c/span\u003e\n\u003cspan class=\"nn\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eSite\n├── Caddyfile\n└── public\n    ├── 404.html\n    ├── component\n    │   └── app.tag\n    ├── css\n    │   ├── bulma.min.css\n    │   └── font-awesome.min.css\n    ├── favicons\n    │   ├── android-icon-144x144.png\n    │   ├── ...\n    │   └── ms-icon-70x70.png\n    ├── fonts\n    │   ├── FontAwesome.otf\n    │   ├── ...\n    │   └── fontawesome-webfont.woff2\n    ├── images\n    │   ├── drive.png\n    │   ├── folder.png\n    │   └── kensaku.png\n    ├── index.html\n    └── js\n        ├── clipboard.min.js\n        └── riot+compiler.min.js\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eCaddyfile\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e0.0.0.0 {\n  root /srv\n  gzip\n  tls self_signed\n\n  index index.html\n  errors {\n    404 404.html\n  }\n\n  proxy /api http://api:8080/ {\n    transparent\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこれだけで、 HTTPS + HTTP2 (+ quic) + Reverse Proxy。素晴らしい。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/2b553c48340144cd012096ac8802965a5499c899/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f32633837306539622d356233342d663635362d303332342d3336306561363232333036612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F2c870e9b-5b34-f656-0324-360ea622306a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2b9a1020a42a655985421d14de6e1349\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/20198/2c870e9b-5b34-f656-0324-360ea622306a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F2c870e9b-5b34-f656-0324-360ea622306a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=642ce6544bef3860500bf45212ca258e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"docker-化\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#docker-%E5%8C%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDocker 化\u003c/h1\u003e\n\n\u003cp\u003eここまでで Docker 化終わってるので。\u003c/p\u003e\n\n\u003cp\u003e現在、ローカルでは一応動いている。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/cb252b592b3c92544d2b8c11e75fc386c959a52f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f32303139382f38313162616662612d633033332d366563642d663636652d6633366336363332393663342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F811bafba-c033-6ecd-f66e-f36c663296c4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d5c36703d69743ab706702f8b12e5673\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/20198/811bafba-c033-6ecd-f66e-f36c663296c4.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2F811bafba-c033-6ecd-f66e-f36c663296c4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8806e1dbae1a149d0b5f5f5afe903fc8 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003e検索は確実に早くなるでしょう。\u003c/p\u003e\n\n\u003cp\u003eしかし、Index 化が早くならなくては余り意味がない。\u003cbr\u003e\n最新の情報があるという保証がなければ、サービスの価値は低い。\u003cbr\u003e\n少なくとも、1日1回は走らせたい。その為には、せいぜい \u003cstrong\u003e30分~1時間以内\u003c/strong\u003e は欲しい。\u003c/p\u003e\n\n\u003cp\u003eとにかく、ネットワークの向こうの NAS をいかに高速に Index するか考えなくては。\u003cbr\u003e\nMFT が取れるのか、それとも取れないのか。\u003cbr\u003e\nMFT から取らないのなら、他に方法は無いのか。\u003c/p\u003e\n","createdAt":"2017-12-20T00:01:03Z","elapsedYearsFromLastModifiedAt":3,"encryptedId":"9wv+Og27WFc64kPHw6IumqjjJdxSq2lP--0emp/VXIhleNfmxF--V07NU0ssfk3R3LyBhxPsNA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2017-12-24T05:43:03Z","likesCount":16,"linkUrl":"https://qiita.com/kikuchi_kentaro/items/536bdb3606fd8dffcd50","organization":null,"originalId":591387,"stockedCount":18,"title":"社内ドキュメントを検索できる『検索君』というシステムを、MFT 高速 Index × Elasticsearch にアップグレードしている話","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%88%9D%E4%BB%A3-%E6%A4%9C%E7%B4%A2%E5%90%9B\"\u003e初代 検索君\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83\"\u003e実行環境\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%A7%E3%81%8D%E3%82%8B%E4%BA%8B\"\u003eできる事\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E4%BA%8B\"\u003eできない事\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%9B%B4%E3%81%97%E3%81%9F%E3%81%84%E6%89%80\"\u003e直したい所\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BA%8C%E4%BB%A3%E7%9B%AE-j-soul-%E6%A4%9C%E7%B4%A2%E5%90%9B\"\u003e二代目 J Soul 検索君\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#mft-%E3%81%AB%E3%82%88%E3%82%8B-index-%E3%81%AE%E9%AB%98%E9%80%9F%E5%8C%96\"\u003eMFT による Index の高速化\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%83%85%E5%A0%B1%E3%81%8C%E3%81%AA%E3%81%84\"\u003e情報がない\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%96%8B%E7%99%BA\"\u003e開発\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#-%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83\"\u003e◆ 開発環境\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-c-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BD%9C%E6%88%90\"\u003e◆ C# プロジェクト作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E5%AE%9F%E8%A1%8C\"\u003e◆ サンプル実行\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-%E3%83%95%E3%83%AB%E3%83%91%E3%82%B9%E5%8F%96%E5%BE%97\"\u003e◆ フルパス取得\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-%E5%B7%A8%E5%A4%A7%E3%81%AA%E5%A3%81\"\u003e◆ 巨大な壁\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%82%92-elasticsearch-%E3%81%AB\"\u003e検索エンジンを Elasticsearch に\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%96%8B%E7%99%BA-1\"\u003e開発\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#-elasticsearch-%E3%81%AB-bulk-insert\"\u003e◆ Elasticsearch に Bulk Insert\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#web-%E3%82%B5%E3%83%BC%E3%83%90%E3%82%92-elixir-%E5%8C%96\"\u003eWeb サーバを Elixir 化\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#-elixir\"\u003e◆ Elixir\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%96%8B%E7%99%BA-2\"\u003e開発\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#-%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83-1\"\u003e◆ 開発環境\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-elixir-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BD%9C%E6%88%90\"\u003e◆ Elixir プロジェクト作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-%E4%BE%9D%E5%AD%98%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E8%BF%BD%E5%8A%A0\"\u003e◆ 依存パッケージを追加\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-application\"\u003e◆ Application\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-routing\"\u003e◆ Routing\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-elasticsearch-%E3%81%AE%E6%93%8D%E4%BD%9C\"\u003e◆ Elasticsearch の操作\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#-docker-%E5%8C%96\"\u003e◆ Docker 化\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89\"\u003eフロントエンド\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cli\u003e\n\u003ca href=\"#docker-%E5%8C%96\"\u003eDocker 化\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\n","totalPv":5430,"uuid":"536bdb3606fd8dffcd50","banReason":null,"adventCalendarItem":{"day":20,"calendar":{"name":"ソフト技研","urlName":"softgiken","year":2017,"organization":null}},"author":{"encryptedId":"H9uu5kKP0HPTdQAPHRimRPnDDpY=--qIfNc7xcK883myxI--m+QHXQf/7e2qbINu/sz6FQ==","originalId":20198,"description":"","facebookUrl":null,"githubUrl":"https://github.com/kentork","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/20198/profile-images/1473682942","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fprofile-images%2F1473682942?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=02c1a677b10405d206da6dacc0b639a9","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F20198%2Fprofile-images%2F1473682942?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=d7abf5d837cbe8a4298575cc7e4620ac","urlName":"kikuchi_kentaro","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Elixir","urlName":"elixir"},{"name":"Elasticsearch","urlName":"elasticsearch"},{"name":"docker-compose","urlName":"docker-compose"},{"name":"NTFS","urlName":"ntfs"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
