自分がメンテをしている Azure Functions Kafka Extensionというライブラリがある。実際に運用してみると、ロギングが不十分であることに気が付いた。Azure Functions Kafka Extensions は、 Confluent.Kafka の C#ライブラリを使っている、さらにその内部でネイティブライブラリである Libkafkaが使用されている。通常の実行ログは実行されるが、Libkafkaの方で何か問題が出たとき、例えば Maximum application poll interval exceeded が出たあと、Auto-commit をかけようとして失敗しているメッセージが LibKafka から出ているが、ゴリゴリに Standard Output から出ている。運用もしている側からするとこれはいただけない。しかも、先の  Libkafka　のライブラリの issue を見ていると、問題が発生したら作者が Debug オプションを On にしてとのたまうことが多い。これは、Debug を有効にしたい。条件としてはこの通り。上記をやってみた。Libkafka のデバッグの有効化は簡単だ。こちらのとおり、debug という設定をしてあげると良い。all という凶悪なオプションまである。さて、こちらのConfluent.Kafka ではどうするか？KafkaOptions というクラスがあり、これが Kafka の host.json の項目になる。ここに書けば host.jsonから自動で読んでくれる。Default は空文字ではうまくいかなかったので、null にした。こちらを、ConsumerConfig と ProducerConfig に足すだけでよい。これらのクラスのスーパークラスが ClientConfig　であり、そこに、単純に Debug に代入するだけでよい。簡単や。これが、Libkafka のライブラリに設定を渡してくれる。KafkaListener L152Producer の方は　KafkaProducerFactory L131 だけど同じようなものだから省略さて、現在 Standard Output に垂れ流されている libkafka のログどうやって盗んだらええねん、、、と思ってたけど、欲しいの自分だけやないよねということで、あっさりとライブラリにHookが存在した。こんな感じ。KafkaProducerFactory L76Consumer も似たようなもので、KafkaListener L107 だ。省略この SetLogHandler で、Action を渡す。

IConsumer と、LogMessage が渡ってくる。IConsumer には様々なメタ情報が入っているが、私が今欲しいのはログのメッセージだけなので、
一旦ここでは、LogMessage の中身だけ見てみる。ここでは、レベルとかも出てくるが、よくよく考えたらログレベルに合わせてInfomationだけではなく違うものに変えるようにしてもいいかもしれない。一旦ここではInfoにしておく。クエリーできるだけでも様様だ。レビューをお願いしているので、気に食わんかったらアドバイスがもらえるだろう。さて、運用していると、ユーザーさんがFunctionをどちらのモードで使っているか？とか知りたいときがある。例えばKafka Trigger は、Function に定義されたパラメータが Array か否かでパラメータがシングルか、複数か決まり実行されるロジックが異なってくる。ただ、頻繁にはログを出したくない。であるので、コンストラクターのところに入れてみたのだが、実際は、Function名をとりたいところ。実際には、executor オブジェクトがFunction名を持っているのだが、そのライブラリの作者が実装クラスを internal  にしているし、インターフェイスなので、リフレクションで取得するのは危険だろう。今はあきらめたがいい方法があれば教えてほしい。SingleItemFunctionExecutor L22これで一旦当初予定していたロギングの強化が完了した。ついでにライブラリもバージョンアップしておいた。


