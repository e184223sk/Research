More than 1 year has passed since last update.ASP.NET Coreを理解するために、プログラムが起動するまでを追ってみます。テンプレートから生成されたファイルを題材にします。ProgramクラスのMainメソッドの中は、以下のようになっています。これを1行ずつ追ってみます。WebHostBuilderインスタンスを作成します。ソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/DefaultBuilder/src/WebHost.csWebHostBuilderコンストラクタの主要部分です。ConfigurationBuilderの拡張メソッドを呼んで、プレフィックス ASPNETCORE_ がついた環境変数を読み込むようにします。ソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Hosting/Hosting/src/WebHostBuilder.cs指定されたプレフィックスがついた環境変数を読み込むようにします。ソースファイル: https://github.com/aspnet/Extensions/blob/master/src/Configuration/Config.EnvironmentVariables/src/EnvironmentVariablesExtensions.csdotnet runコマンドでは何も渡ってこないので、実質何もしてないです。環境に応じて、設定ファイルを読み込むdelegateをWebHostBuilderに渡しています。デフォルトではappsettings.jsonファイルを読み込みます。
さらにappsettings.{環境}.jsonファイルを読み込みます。Development環境のときは、追加のアセンブリを読み込んでいます。1ロガーを設定しています。ソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Servers/Kestrel/Kestrel/src/WebHostBuilderKestrelExtensions.csソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Servers/IIS/IIS/src/WebHostBuilderIISExtensions.csDIコンテナにスタートアップクラスを登録するdelegateをWebHostBuilderに追加しています。実際にはConventionBasedStartupクラスを使用するようになっています。ソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Hosting/Hosting/src/WebHostBuilderExtensions.csソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Hosting/Hosting/src/Startup/ConventionBasedStartup.csConverntionBasedStartupクラスが呼び出すメソッドは、StartupLoaderで決めています。ソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Hosting/Hosting/src/Internal/StartupLoader.csWebHostをビルドします。ソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Hosting/Hosting/src/WebHostBuilder.csこのあたり、なにやっているか追えていません。WebHostのインスタンスを作成し、Initializeを呼んでいます。ソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Hosting/Hosting/src/Internal/WebHost.csソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Hosting/Hosting/src/WebHostExtensions.csソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Hosting/Hosting/src/Internal/WebHost.csソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Hosting/Hosting/src/Builder/ApplicationBuilderFactory.csソースファイル: https://github.com/aspnet/AspNetCore/blob/master/src/Http/Http/src/Internal/ApplicationBuilder.cs_componentsには、useしたdelegateが入っています。環境名は「Development」「Production」「Staging」と決め打ちです。なかなか厄介。 ↩


