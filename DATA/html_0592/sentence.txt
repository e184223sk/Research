IAM認証を使っているAWSのAPI Gatewayは、APIリクエスト時にSigV4署名が必要です。前回の記事では、IAMユーザで認証するAPI Gateway呼び出しをC#で書きました。今回は、EC2インスタンスにアタッチされているIAMロールでの認証です。2020/12/23追記
EC2からはもっとシンプルに書いたほうがよさそうなので、改訂版の記事を書きました。
→ IAM認証のAWS API GatewayにEC2インスタンスからSigV4署名してアクセスするにはIAMロールのアタッチされているEC2インスタンスでC#のコードを実行します。~/.aws/config に以下のようにIAMロールが指定されているものとします。API GatewayのリソースポリシーにはこのIAMロールからのAPIアクセスを許可してあるものとします。動作確認した環境はUbuntu 20.04です。C#の環境は以下の通り。以下は私の記事でして、このとおりC#をほとんど始めて触っています。C#の流儀と違うところがあったらごめんなさい。本記事でのライブラリ等は2020/10/19時点のものです。SigV4署名するC#のサンプルコードはAWS公式サイトにありますので、それをダウンロードし、必要なディレクトリのみ残します。この手順の詳細は前回の記事を参照。サンプルソースコードのnamespaceを全置換しておきます。(このコマンドの説明は sedコマンドでディレクトリ内の全ファイルをテキスト全置換するには)dotnetコマンドでプロジェクトを作成します。以下のようなディレクトリ構成になります。sample.csprojに以下のように RootNamespace の項目を追加します。サンプルダウンロード後に全置換したnamespaceを指定します。必要なパッケージをダウンロードします。 Program.cs は以下です。2020/12/23追記：もう少しシンプルなコード → IAM認証のAWS API GatewayにEC2インスタンスからSigV4署名してアクセスするにはuriはAPI GatewayのAPIのURLを入れます。以下のコマンドで実行できます。ダウンロードしたサンプルコードのSignersとUtilにデバッグ用出力があるので、いろいろ表示されますが、最後にAPI Gatewayからのレスポンスが表示されます。C#でIAMロールにAssumeする方法がわからず、今回のテーマは難儀でした。わかってしまえば大したことないのですが。参考にした情報は、前回の記事に加えて、AWS SDK for .NETのAPIレファレンスとPython boto3のソースコードと、参考としてawscurlというコマンドのソースコードです。AWS SDK for .NETのドキュメントは、説明が少なく、メソッドのシグニチャはわかってもどう使ったらいいのかがわかりませんでした。IAMロールでの署名をしているはずのawscurlのソースコードを読み、awscurlが呼び出しているboto3のソースコードも読むことで、AWSのAPIをどう呼び出しているのかを把握し、同じことをC#で書くことで実装できました。boto3はAWSのAPIを呼び出しているだけだと思っていましたが、使いやすいように多くの機能をPythonで実装していることを実感しました。boto3とは違って、AWS SDK for .NETは単にAWS API呼び出しをそのままメソッドにしているだけのように見えます。


