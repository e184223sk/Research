<!DOCTYPE html><html><head><meta charset="utf-8" /><title>ステートマシン実装の決定版ImtStateMachineについて語り尽くす - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/BelColo/items/a94c9ccc2d5174dc29a3" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="3agNZtzjz8d6YbB9Tg3/sIItLvvaz34/Y60DCWU1gPGiXI518M5l8msk5qpFD4Ac48WuR50AzTwn2HvqoEggkQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="ステートマシン実装の決定版ImtStateMachineについて語り尽くす - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NEs1NDRPRzQ0Tzg0NE9JNDRPZTQ0SzM0NE96NWE2ZjZLT0Y0NEd1NXJHNjVhNmE1NG1JU1cxMFUzUmhkR1ZOWVdOb2FXNWw0NEdyNDRHazQ0R0U0NEdtNktxZTQ0S0s1YkM5NDRHUDQ0R1omdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9MTkwYzVhYjM2NWEyM2IxNmYzNTU0NDdhNWUxMjMyNDE&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRUpsYkVOdmJHOCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTAyMjI4NGM0M2E0YWZiOTc2MWZlMTVlZDUxN2NkZjk3&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=5ec04e3327655fe12d658d76a3b4513a"><meta property="og:description" content="

加筆 or 修正


2021-02-09


ImtStateMachine.cs のリンクを修正





前置き

ステートマシンよりも前に、状態制御とはなにかを書いていたのですが、思った以上に長くなりそうだったので、状態制..."><meta content="https://qiita.com/BelColo/items/a94c9ccc2d5174dc29a3" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,game,Unity,statemachine,IceMilkTea" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-f9a38147-ab72-414f-8a72-66be1034afc1"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FBelColo%2Fitems%2Fa94c9ccc2d5174dc29a3">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FBelColo%2Fitems%2Fa94c9ccc2d5174dc29a3">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-f9a38147-ab72-414f-8a72-66be1034afc1">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-12-23T18:18:18.000+09:00","dateModified":"2021-02-09T16:20:19.000+09:00","headline":"ステートマシン実装の決定版ImtStateMachineについて語り尽くす","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND00NEs1NDRPRzQ0Tzg0NE9JNDRPZTQ0SzM0NE96NWE2ZjZLT0Y0NEd1NXJHNjVhNmE1NG1JU1cxMFUzUmhkR1ZOWVdOb2FXNWw0NEdyNDRHazQ0R0U0NEdtNktxZTQ0S0s1YkM5NDRHUDQ0R1omdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9MTkwYzVhYjM2NWEyM2IxNmYzNTU0NDdhNWUxMjMyNDE\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRUpsYkVOdmJHOCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTAyMjI4NGM0M2E0YWZiOTc2MWZlMTVlZDUxN2NkZjk3\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=5ec04e3327655fe12d658d76a3b4513a","mainEntityOfPage":"https://qiita.com/BelColo/items/a94c9ccc2d5174dc29a3","author":{"@type":"Person","address":"","email":null,"identifier":"BelColo","name":"BelColo","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2Fprofile-images%2F1545271010?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=0cd3450fa2c72ce332697f9ad4e6970a","url":"https://qiita.com/BelColo","description":"某お艦ゲーを愛してやまないマン","memberOf":[{"@type":"Organization","address":"東京都新宿区西新宿4-34-7 住友不動産西新宿ビル5号館3階","legalName":"株式会社 gumi","image":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/83434c9a6c3634eab7735e73cebdceb8c450b289/original.jpg?1395209492","logo":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/af10c3d31812a4bdbb2e57f74eb23904073018e5/original.jpg?1557194992","identifier":"gumi","description":"Python、Erlang、Elixir などちょっと変わった技術でゲームをつくったりする会社。プログラマだけじゃなく、企画、デザイン、イラストなど開発全般揃ってます。"}]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita&amp;utm_medium=header-banner">「不動産取引をワンクリックで完結する」世界観へ。GA technologiesの取り組み</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"BelColo","type":"items","id":"a94c9ccc2d5174dc29a3"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「不動産取引をワンクリックで完結する」世界観へ。GA technologiesの取り組み","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"BelColo","type":"items","id":"a94c9ccc2d5174dc29a3"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「不動産取引をワンクリックで完結する」世界観へ。GA technologiesの取り組み","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"BelColo","type":"items","id":"a94c9ccc2d5174dc29a3"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「不動産取引をワンクリックで完結する」世界観へ。GA technologiesの取り組み","url":"https://zine.qiita.com/interview/202104-ga-technologies/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/BelColo/items/a94c9ccc2d5174dc29a3","location":"/BelColo/items/a94c9ccc2d5174dc29a3","scheme":"https","host":"qiita.com","port":null,"pathname":"/BelColo/items/a94c9ccc2d5174dc29a3","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"eTdC4pyrq5LZD6Zv4LIdfC4oxv2XQuCCyWxoAK+I3/gGw8HxsIYBp8hK8LjrsGLQT8BGQdCNU4GNGRDjavV/mA==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-8f8439d0-49fe-4b22-917b-084c6f793155"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/BelColo/items/a94c9ccc2d5174dc29a3/likers" class="css-1iupg5d">96</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">84</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/a94c9ccc2d5174dc29a3/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/BelColo/items/a94c9ccc2d5174dc29a3/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/BelColo/items/a94c9ccc2d5174dc29a3/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/BelColo/items/a94c9ccc2d5174dc29a3/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/BelColo/items/a94c9ccc2d5174dc29a3.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><a href="/organizations/gumi"><img src="https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/af10c3d31812a4bdbb2e57f74eb23904073018e5/original.jpg?1557194992" class="it-AdcalRibbon_orgImage"/></a><span><a href="/advent-calendar/2018/gumi" class="it-AdcalRibbon_title">gumi Inc.<!-- --> Advent Calendar<!-- --> <!-- -->2018</a>Day 24</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/BelColo"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/328967/profile-images/1545271010" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/BelColo" class="css-10ougpm">@<!-- -->BelColo</a><div class="css-1ay9vb9"><span><meta content="2018-12-23T09:18:18Z"/><time dateTime="2021-02-09T07:20:19Z" class="css-m19uds">updated at 2021-02-09</time></span></div></div></div></div></div><h1 class="css-cgzq40">ステートマシン実装の決定版ImtStateMachineについて語り尽くす</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/game" class="css-4czcte">game</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/statemachine" class="css-4czcte">statemachine</a><a href="/tags/icemilktea" class="css-4czcte">IceMilkTea</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h4>
<span id="加筆-or-修正" class="fragment"></span><a href="#%E5%8A%A0%E7%AD%86-or-%E4%BF%AE%E6%AD%A3"><i class="fa fa-link"></i></a>加筆 or 修正</h4>

<ul>
<li>2021-02-09

<ul>
<li>ImtStateMachine.cs のリンクを修正</li>
</ul>
</li>
</ul>

<h1>
<span id="前置き" class="fragment"></span><a href="#%E5%89%8D%E7%BD%AE%E3%81%8D"><i class="fa fa-link"></i></a>前置き</h1>

<p>ステートマシンよりも前に、状態制御とはなにかを書いていたのですが、思った以上に長くなりそうだったので、状態制御については別記事にします。<br>
今回は、<strong>シノア氏</strong>が開発しているOSSである <a href="https://github.com/Sinoa/IceMilkTea/" rel="nofollow noopener" target="_blank"><strong>IceMilkTea</strong></a> という、Unityゲームエンジン向け開発サポートライブラリの「<strong>サブセット</strong>」である <a href="https://github.com/Sinoa/IceMilkTea/blob/develop/Packages/IceMilkTea/Runtime/Core/StateMachine.cs" rel="nofollow noopener" target="_blank"><strong>ImtStateMachine</strong></a> を紹介（語り尽く）したいと思います。</p>

<h1>
<span id="unityで状態制御といえば" class="fragment"></span><a href="#unity%E3%81%A7%E7%8A%B6%E6%85%8B%E5%88%B6%E5%BE%A1%E3%81%A8%E3%81%84%E3%81%88%E3%81%B0"><i class="fa fa-link"></i></a>Unityで状態制御といえば</h1>

<p>殆どのUnityゲームクリエイターがステートマシンと聞いたら次のアセットを思い浮かべるのではないのでしょうか</p>

<ul>
<li>
<a href="https://assetstore.unity.com/packages/tools/visual-scripting/playmaker-368" rel="nofollow noopener" target="_blank"><strong>Playmaker</strong></a>

<ul>
<li>Unityのステートマシンの老舗と言えばこのアセットですよね、Unity3.2の頃ではお世話になっていました。</li>
<li>いまでもメンテナンスは続いており、Playmaker以外の人もPlaymaker用追加モジュールを製作されているほどの人気です。</li>
</ul>
</li>
<li>
<a href="https://assetstore.unity.com/packages/tools/visual-scripting/behaviour-machine-indie-20202" rel="nofollow noopener" target="_blank"><strong>Behaviour Machine</strong></a>

<ul>
<li>非常に軽快でシンプルでありながら、強力なビジュアルエディタが付属しており使い勝手が抜群です。</li>
<li>また、有料版になりますが、ソースコードもフルオープンのためブラックボックスがなく、問題が起きた時の調査もしやすいです。</li>
<li>Unity4.6～5.xではお世話になっていました。</li>
<li>しかも、ステートマシンだけに限らずビヘイビアツリーと言った状態制御方法もサポートしています。（むしろこっちが本命でステートマシンがおまけ感）</li>
</ul>
</li>
<li>
<a href="https://assetstore.unity.com/packages/tools/visual-scripting/arbor-3-fsm-bt-graph-editor-112239" rel="nofollow noopener" target="_blank"><strong>Arbor 3: FSM &amp; BT Graph Editor</strong></a>

<ul>
<li>知る人ぞ知る、日本国産のステートマシンアセットです。</li>
<li>そのため、日本語マニュアルも完備されており、ビジュアルエディタも日本語サポートされています。</li>
<li>こちらもビヘイビアツリーを実現する機能が提供されています。</li>
</ul>
</li>
</ul>

<h3>
<span id="ステートマシンとは少し違いますが" class="fragment"></span><a href="#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%A8%E3%81%AF%E5%B0%91%E3%81%97%E9%81%95%E3%81%84%E3%81%BE%E3%81%99%E3%81%8C"><i class="fa fa-link"></i></a>ステートマシンとは少し違いますが</h3>

<p>なにも、状態制御はステートマシンだけが実装方法ではありません。解決方法は違えど状態制御が可能なものもあります。<br>
Unityにおいてもステートマシンを使わずとも状態制御は可能です。本題と少しずれてしまいますが、他のアセットも見てみましょう。</p>

<ul>
<li>
<a href="https://assetstore.unity.com/packages/tools/integration/unirx-reactive-extensions-for-unity-17276" rel="nofollow noopener" target="_blank"><strong>UniRx</strong></a>

<ul>
<li>C#界隈で有名な neuecc氏が開発しているUnity向けにチューニングされた ReactiveExtensions と言えばこれですね</li>
<li>RxライクでUnity向けのオペレータも豊富です。</li>
<li>ほぼシーケンシャルな状態遷移及び状態の振る舞いがシンプルなら非常に強力に働くでしょう。</li>
</ul>
</li>
<li>
<a href="https://assetstore.unity.com/packages/tools/visual-scripting/behavior-designer-behavior-trees-for-everyone-15277" rel="nofollow noopener" target="_blank"><strong>Behavior Designer</strong></a>

<ul>
<li>Unityのビヘイビアツリーの老舗と言えばこのアセットですね、Unity 4.6世代あたりではお世話になっていました。</li>
<li>ビジュアルエディタも非常にわかりやすく、デバッグ機能も非常に強力でツリーの構築も非常にやりやすいです。</li>
</ul>
</li>
<li>
<a href="https://assetstore.unity.com/packages/tools/visual-scripting/nodecanvas-14914" rel="nofollow noopener" target="_blank"><strong>NodeCanvas</strong></a>

<ul>
<li>ビヘイビアツリー界隈で知らない人は居ないのではないのでしょうか、これも非常に有名ですね。</li>
<li>やや独特なビジュアルエディタでありながら、非常にハイパフォーマンスでかつメモリ効率も良いアセットです。</li>
<li>またPlaymakerと同様、様々なサブシステムへのインテグレーションも行われており、非常にサードパーティが多いのも一つの魅力です。</li>
</ul>
</li>
</ul>

<h1>
<span id="これだけのオススメのアセットがあるのに何故-imtstatemachine" class="fragment"></span><a href="#%E3%81%93%E3%82%8C%E3%81%A0%E3%81%91%E3%81%AE%E3%82%AA%E3%82%B9%E3%82%B9%E3%83%A1%E3%81%AE%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%8C%E3%81%82%E3%82%8B%E3%81%AE%E3%81%AB%E4%BD%95%E6%95%85-imtstatemachine"><i class="fa fa-link"></i></a>これだけのオススメのアセットがあるのに何故 ImtStateMachine？</h1>

<p>殆どのインディーズ系Unityゲーム開発であれば、上記で紹介したアセットで事足りますし<br>
実際、非常にエディタとしても強力でそれなりのパフォーマンスが得られます。<br>
では、それでもその恩恵を捨てながらも ImtStateMachine を使う理由とは何でしょうか。</p>

<h3>
<span id="サーバーコードもunity側実装と同じようにかつハイパフォーマンスで使いたい" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%B3%E3%83%BC%E3%83%89%E3%82%82unity%E5%81%B4%E5%AE%9F%E8%A3%85%E3%81%A8%E5%90%8C%E3%81%98%E3%82%88%E3%81%86%E3%81%AB%E3%81%8B%E3%81%A4%E3%83%8F%E3%82%A4%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%A7%E4%BD%BF%E3%81%84%E3%81%9F%E3%81%84"><i class="fa fa-link"></i></a>サーバーコードも、Unity側実装と同じようにかつハイパフォーマンスで使いたい！</h3>

<p>近年では、スマートフォンゲームでも珍しくなくなってきた、リアルタイムオンライン通信によるマルチプレイゲームが流行ってきています。<br>
そのため、サーバーサイド側の開発事情も変わってきています。殆どの通信は1度のリクエストで1度のレスポンスで済むものです、それも今も変わりません。<br>
しかし、リアルタイム通信で同期型のオンライン通信となると、ガラッと変わりサーバーが今まで<strong>ステートレスな処理</strong>から<strong>ステートフルな処理</strong>へ大変貌を遂げました。</p>

<p>それを解決するには、ステートマシンによる状態制御が必要です。<br>
そこで、可能ならばUnityで実装しているような状態制御をサーバーサイド側のプログラムでもやりたい！<br>
しかも、サーバー側コードなので、ただ状態制御が出来るだけでなく、パフォーマンスも保証し安定して動作しなければなりません。<br>
そんな理由もあり、それを実現出来るのが ImtStateMachine でした。</p>

<h3>
<span id="imtstatemachine-の特徴" class="fragment"></span><a href="#imtstatemachine-%E3%81%AE%E7%89%B9%E5%BE%B4"><i class="fa fa-link"></i></a>ImtStateMachine の特徴</h3>

<p>では、サーバーサイドでもUnityでも使えるステートマシンといわれる ImtStateMachine はどんなステートマシンなのか箇条書きで簡単ですが、以下にまとめました。</p>

<ul>
<li>
<strong>本体がピュアC#で実装されている</strong>

<ul>
<li>本体コードを見るとわかりますが、本体コードの全てが<strong>C#の標準クラスでのみ実装</strong>されています。</li>
<li>そのため、C#の実装環境なら殆どの場所で<strong>再利用が可能</strong>です。</li>
<li>サーバーコードでもUnityコードでも使える理由はこれのおかげです。</li>
</ul>
</li>
<li>
<strong>ソースコードファイルがたった1つ</strong>

<ul>
<li>なんと、ステートマシンとして実現する実装コードはたったの1ファイルのみです。</li>
<li>フルセットである IceMilkTea をまるごと導入する必要はありません。</li>
<li>そのため、<strong>非常にポータビリティが高い</strong>ので再利用性がより一層上がります。</li>
</ul>
</li>
<li>
<strong>ハイパフォーマンスでメモリ効率もよい</strong>

<ul>
<li>非常にコンパクトな実装のため、<strong>ナノ秒オーダーでの動作が可能</strong>です。</li>
<li>一度動作を開始したら、ステートマシンによるGCAllocは一切ありません。</li>
</ul>
</li>
<li>
<strong>安全に動作する（例外耐性が高い）</strong>

<ul>
<li>ImtStateMachineが、ステートで発生した例外を適切に拾い上げて制御する方法を提供しています（<strong>UnhandledException機構</strong>）。</li>
<li>ステートで例外が発生してもステートマシンが不正終了する事が無いため、そのまま復帰することが可能です。</li>
</ul>
</li>
<li>
<strong>状態の遷移が決められていて入力と紐付けられる（有限状態機械）</strong>

<ul>
<li>有限状態機械として実装するための遷移テーブルを構築する手段が提供されています。</li>
<li>遷移テーブルも非常に見やすい書き方で実現されています。</li>
</ul>
</li>
<li>
<strong>任意状態遷移を構築できる（Any遷移）</strong>

<ul>
<li>有限状態機械のみならず、ステートパターンとして組むための任意遷移が提供されています。</li>
</ul>
</li>
<li>
<strong>どの型（クラス）に対してもステートマシンとして実装出来る（コンテキストフリー）</strong>

<ul>
<li>ステートマシン自体にコンテキストは存在せず、コンテキストはユーザー定義型で実装することが可能です。</li>
</ul>
</li>
<li>
<strong>状態の遷移条件を状態毎に実装が可能（遷移ガード）</strong>

<ul>
<li>ステートマシンの入力に対して、ステートが遷移をコントロールすることが可能です。</li>
</ul>
</li>
<li>
<strong>状態のスタックが可能（状態割り込み）</strong>

<ul>
<li>状態を維持したまま状態を遷移して、状態を元に戻すといった事が可能です。</li>
</ul>
</li>
<li>
<strong>ライセンスがzlib/libpng（MITライセンスよりもっと緩い）</strong>

<ul>
<li>最近の OSS では MIT ライセンスが多いですが IceMilkTea は zlib/libpng ライセンスという形を取っています。</li>
<li>すごくざっくりいうと（as-is（現状の））まま使われることを想定しているけど、改変は自由にOK（その際は改変されたということがわかるようにすること）</li>
<li>改変したとしても、開発者を偽らなければそのまま使っていいよ（ソースコードに書かれている作者情報をそのままにすること）</li>
<li>特に、権利者表記を義務付けないよ、書いてもいいけど作者から書くことは強要しないよ</li>
</ul>
</li>
</ul>

<h1>
<span id="大まかな使い方" class="fragment"></span><a href="#%E5%A4%A7%E3%81%BE%E3%81%8B%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9"><i class="fa fa-link"></i></a>大まかな使い方</h1>

<h3>
<span id="状態の書き方" class="fragment"></span><a href="#%E7%8A%B6%E6%85%8B%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9"><i class="fa fa-link"></i></a>状態の書き方</h3>

<p>ステートマシンと言うからには状態の定義が必要です。<br>
ImtStateMachine は、どのステートマシンの状態なのかという実装の仕方になります。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="err">コンテキストになるクラスの型</span><span class="p">&gt;.</span><span class="n">State</span>
</code></pre></div></div>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">実例.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="c1">// 状態を定義しているだけの何もしないクラス</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Hoge</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="c1">// この Hoge クラスのステートマシン</span>
    <span class="k">private</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Hoge</span><span class="p">&gt;</span> <span class="n">stateMachine</span><span class="p">;</span>

    <span class="c1">// この Hoge クラスのアイドリング状態クラス</span>
    <span class="k">private</span> <span class="k">class</span> <span class="nc">IdleState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Hoge</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
        <span class="c1">// 何もしない状態クラスなら何も書かなくても良い（むしろ無駄なoverrideは避ける）</span>
    <span class="p">}</span>

    <span class="c1">// この Hoge クラスのなにかを処理している状態クラス</span>
    <span class="k">private</span> <span class="k">class</span> <span class="nc">ProcessState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Hoge</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
        <span class="c1">// 状態へ突入時の処理はこのEnterで行う</span>
        <span class="k">protected</span> <span class="k">internal</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Enter</span><span class="p">()</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="c1">// 状態の更新はこのUpdateで行う</span>
        <span class="k">protected</span> <span class="k">internal</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="c1">// 状態から脱出する時の処理はこのExitで行う</span>
        <span class="k">protected</span> <span class="k">internal</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Exit</span><span class="p">()</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="c1">// 状態で発生した未処理の例外がキャッチされた時の処理はこのErrorで行う</span>
        <span class="k">protected</span> <span class="k">internal</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">Error</span><span class="p">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 未処理の例外をハンドリングしたのなら true を返すことで、ステートマシンはエラーから復帰します</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ステートマシンが状態の遷移をする前にステートマシンのイベント入力を処理するならこのGuardEventで行う</span>
        <span class="k">protected</span> <span class="k">internal</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">GuardEvent</span><span class="p">(</span><span class="kt">int</span> <span class="n">eventId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 特定のタイミングで遷移を拒否（ガード）するなら true を返せばステートマシンは遷移を諦めます</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">Context</span><span class="p">.</span><span class="n">isActiveAndEnabled</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 遷移を許可するなら false を返せばステートマシンは状態の遷移をします</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ステートマシンが前回のプッシュした状態に復帰する時の処理をするならこのGuardPopで行う</span>
        <span class="k">protected</span> <span class="k">internal</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">GuardPop</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// 復帰を拒否（ガード）するなら true を返せばステートマシンは復帰を諦めます</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">Context</span><span class="p">.</span><span class="n">isActiveAndEnabled</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 復帰を許可するなら false を返せばステートマシンは復帰します</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>この例では、1ソースコードで状態を実装していますが、C#にはpartialという型の分割定義が可能なので、メンテナンス性を考慮し状態クラスごとにソースコードを分けると良いです。<br>
<a href="https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/keywords/partial-type" rel="nofollow noopener" target="_blank">partial 型 (C# リファレンス)</a><br>
もちろん、コード規模によっては1ファイルで書いたほうが良い場面もあるので、適切な分量で書き分けましょう。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Hoge.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Hoge</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="c1">// この Hoge クラスのステートマシン</span>
    <span class="k">private</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Hoge</span><span class="p">&gt;</span> <span class="n">stateMachine</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Hoge.IdleState.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Hoge</span>
<span class="p">{</span>
    <span class="c1">// この Hoge クラスのアイドリング状態クラス</span>
    <span class="k">private</span> <span class="k">class</span> <span class="nc">IdleState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Hoge</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Hoge.ProcessState.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Hoge</span>
<span class="p">{</span>
    <span class="c1">// この Hoge クラスのなにかを処理している状態クラス</span>
    <span class="k">private</span> <span class="k">class</span> <span class="nc">ProcessState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Hoge</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="状態遷移テーブルの作り方" class="fragment"></span><a href="#%E7%8A%B6%E6%85%8B%E9%81%B7%E7%A7%BB%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9"><i class="fa fa-link"></i></a>状態遷移テーブルの作り方</h3>

<p>殆どのケースでは有限状態機械として実装することが多いので、その遷移テーブルを記述してみます。<br>
ImtStateMachine では AddTransition, AddAnyTransition, AddTransitionRange の3つの関数でテーブルを構築し、SetStartState で開始状態を定義する事ができます。</p>

<p>遷移テーブルは状態クラスの型を使って from -&gt; to : input といった形で関数を呼びます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="c1">// この関数を呼ぶと（遷移元状態クラスの状態で、入力値の入力をされた時に、遷移先状態クラスの状態へ遷移する）という定義になります。</span>
<span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="err">遷移元の状態クラスの型</span><span class="p">,</span> <span class="err">遷移先の状態クラスの型</span><span class="p">&gt;(</span><span class="err">入力値</span><span class="p">);</span>
</code></pre></div></div>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Hoge</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="c1">// ステートマシンの入力（イベント）を判り易くするために列挙型で定義</span>
    <span class="k">public</span> <span class="k">enum</span> <span class="n">StateEventId</span>
    <span class="p">{</span>
        <span class="n">Finish</span><span class="p">,</span>
        <span class="n">Reset</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">// この Hoge クラスのステートマシン</span>
    <span class="k">private</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Hoge</span><span class="p">&gt;</span> <span class="n">stateMachine</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンのインスタンスを生成して遷移テーブルを構築</span>
        <span class="n">stateMachine</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Hoge</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// 自身がコンテキストになるので自身のインスタンスを渡す</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">IdleState</span><span class="p">,</span> <span class="n">ProcessState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Finish</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">ProcessState</span><span class="p">,</span> <span class="n">IdleState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Reset</span><span class="p">);</span>

        <span class="c1">// 起動ステートを設定（起動ステートは IdleState）</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">SetStartState</span><span class="p">&lt;</span><span class="n">IdleState</span><span class="p">&gt;();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>上記の呼び出しを行うと、次のような状態遷移テーブルが構築されます</p>

<p><a href="https://camo.qiitausercontent.com/9d153fd2f0c6150bb67712f189812570e8231352/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f706e672f536f576b49496d6741537444755368384a34624c4943716a4141624b4934616a4a59784142325a3970435f5a596a51414c54334c6a4c466d4a43623933497639423464625768434b574338314856643967534e353442774c57626a634e63506e31585541413547704a34624751643567325054335162754171354f30" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLFmJCb93Iv9B4dbWhCKWC81HVd9gSN54BwLWbjcNcPn1XUAA5GpJ4bGQd5g2PT3QbuAq5O0?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4a8469fb68b1259a3ca48e461091fdd9" alt="状態遷移構築サンプル" data-canonical-src="http://www.plantuml.com/plantuml/png/SoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLFmJCb93Iv9B4dbWhCKWC81HVd9gSN54BwLWbjcNcPn1XUAA5GpJ4bGQd5g2PT3QbuAq5O0" srcset="https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLFmJCb93Iv9B4dbWhCKWC81HVd9gSN54BwLWbjcNcPn1XUAA5GpJ4bGQd5g2PT3QbuAq5O0?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0ea5208e955de050164ba36b81de8c2a 1x" loading="lazy"></a></p>

<h3>
<span id="ステートマシンの更新ループ" class="fragment"></span><a href="#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E6%9B%B4%E6%96%B0%E3%83%AB%E3%83%BC%E3%83%97"><i class="fa fa-link"></i></a>ステートマシンの更新ループ</h3>

<p>状態クラスの定義、遷移テーブルの構築、をここまでやったら後はステートマシンを動かすだけです。<br>
ImtStateMachine では Update 関数がステートマシンの起動と更新を担います。<br>
通常、Unityでは、コンポーネントの更新ループ関数で状態の更新を行うので、コンポーネントの Start 関数で起動し Update 関数で更新するのが常套手段になります。<br>
また、サンプルコードを見ていただけたら分かりますが ImtStateMachine は Update 関数を呼び出すだけで状態更新を行えます。<br>
業務アプリケーションなどのフォームアプリケーション、コンソールアプリケーションなどで動かす場合は、OSのメッセージループ内で呼び出したり、タイマやボタンのクリック等の特定イベントなどでのタイミングでの更新も可能です。<br>
ご自身の希望するタイミングで、更新タイミングを実行することが可能です。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Hoge</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
<span class="cm">/*
中略...
*/</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンを起動</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
    <span class="p">}</span>


    <span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ひたすら更新</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="ステートマシンへのイベント入力" class="fragment"></span><a href="#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%B8%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E5%85%A5%E5%8A%9B"><i class="fa fa-link"></i></a>ステートマシンへのイベント入力</h3>

<p>ステートマシンへ状態の遷移をするための指示をするには、入力が必要です。<br>
ImtStateMachine では SendEvent 関数で状態の遷移をする事が出来ます。<br>
入力する値は、遷移テーブルを構築する時に Add～Transition 関数に渡した引数の値になります。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">Hoge</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
<span class="cm">/*
中略...
*/</span>
    <span class="c1">// 何かがぶつかった！</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnCollisionEnter</span><span class="p">(</span><span class="n">Collision</span> <span class="n">collision</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンにイベントを送る</span>
        <span class="c1">// この例では IdleState の状態時は ProcessState へ遷移するが</span>
        <span class="c1">// ProcessState の状態時は、遷移する先が無いので何も起きない</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Finish</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1>
<span id="試しに使ってみる" class="fragment"></span><a href="#%E8%A9%A6%E3%81%97%E3%81%AB%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>試しに使ってみる</h1>

<p>本当は、もっともっと ImtStateMachine を使ったテクニックを紹介したいのですが、今回はカレンダー記事ということで基本中の基本という「語り尽くす」とはと何だと思ってしまいます。<br>
代わりと言ってはなんですが、たった一つの ImtStateMachine のソースコードファイルをインポートしたUnityプロジェクトで簡単なサンプルを作ってみたので、ご参照下さい。<br>
ImtStateMachine を使ったテクニック集なども、いずれ記事にしたいと思います。</p>

<p>では、早速 ImtStateMachine を使ってUnityで簡単なサンプルを作ってみます。</p>

<p>今回作るゲームは、ブロック崩しを作りたいと思います。<br>
要件は次の通りです。</p>

<ul>
<li>スペースキーでボールを発射</li>
<li>全てのブロックが破壊されれば終了</li>
<li>プレイヤーがボールを受け取れずミスを3回したらゲーム終了</li>
</ul>

<h3>
<span id="新規unityプロジェクトを作ってソースコードをインポート" class="fragment"></span><a href="#%E6%96%B0%E8%A6%8Funity%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>新規Unityプロジェクトを作ってソースコードをインポート</h3>

<p>今回の使用するUnityエンジンバージョンは 2018.3.0f2 です。<br>
早速Unityプロジェクトを新規作成し、シノア氏の IceMilkTea のリポジトリに含まれる ImtStateMachine のソースコードだけ、コピペするかリポジトリをチェックアウトしてきた所から頂戴します。<br>
<a href="https://github.com/Sinoa/IceMilkTea/blob/develop/Program/Runtime/Core/UnitCode/PureCsharp/StateMachine.cs" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/Sinoa/IceMilkTea/blob/develop/Program/Runtime/Core/UnitCode/PureCsharp/StateMachine.cs</a><br>
<a href="https://camo.qiitausercontent.com/9c24edc40a6ff75628b3b9c25487bb65d93e05a1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3332383936372f33643437306366332d313839322d613537632d393436622d6539623735346335386534642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F3d470cf3-1892-a57c-946b-e9b754c58e4d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=bc87917a5cd4a06a57b73f41b6c6ff9c" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/328967/3d470cf3-1892-a57c-946b-e9b754c58e4d.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F3d470cf3-1892-a57c-946b-e9b754c58e4d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6f927f4269aa5d28db2907c2a9aabadd 1x" loading="lazy"></a><br>
このように、ポンっとPluginsディレクトリに置くだけの簡単な作業です。</p>

<h3>
<span id="物理エンジンのバウンド閾値を調整" class="fragment"></span><a href="#%E7%89%A9%E7%90%86%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%81%AE%E3%83%90%E3%82%A6%E3%83%B3%E3%83%89%E9%96%BE%E5%80%A4%E3%82%92%E8%AA%BF%E6%95%B4"><i class="fa fa-link"></i></a>物理エンジンのバウンド閾値を調整</h3>

<p>今回作るゲームはブロック崩しの為ボールが確実にバウンドするように、物理エンジンのバウンドするかどうかの閾値を0にします。<br>
<a href="https://camo.qiitausercontent.com/7bddb942d934d96510a9065282eb3019a3bae119/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3332383936372f38616537366236652d333563322d616538322d356235332d6539323030366339313736302e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F8ae76b6e-35c2-ae82-5b53-e92006c91760.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c247d3ac4ce42eda77ab9a0ae89f8be8" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/328967/8ae76b6e-35c2-ae82-5b53-e92006c91760.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F8ae76b6e-35c2-ae82-5b53-e92006c91760.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=22d743144a6c3e615abe905b9c5073df 1x" loading="lazy"></a></p>

<h3>
<span id="ステージをパパパっと作る" class="fragment"></span><a href="#%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8%E3%82%92%E3%83%91%E3%83%91%E3%83%91%E3%81%A3%E3%81%A8%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>ステージをパパパっと作る</h3>

<p>全てプリミティブなオブジェクトで組んでしまいます。もちろん物理エンジンのコンポーネントも付けていきます。<br>
<a href="https://camo.qiitausercontent.com/e80acf5e32f84d5dfdb78752a67fbc2aa0de0b5f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3332383936372f33306562396434632d623336662d636439392d656634362d3061313035356535373262322e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F30eb9d4c-b36f-cd99-ef46-0a1055e572b2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=02a8603112691352b374577f3ae9f002" alt="image.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/328967/30eb9d4c-b36f-cd99-ef46-0a1055e572b2.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F30eb9d4c-b36f-cd99-ef46-0a1055e572b2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d5341d1371a26bdb8078ab612003ec8c 1x" loading="lazy"></a><br>
いい感じです。</p>

<h3>
<span id="プレイヤークラスを書く" class="fragment"></span><a href="#%E3%83%97%E3%83%AC%E3%82%A4%E3%83%A4%E3%83%BC%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>プレイヤークラスを書く</h3>

<p>それでは、まずプレイヤーとして存在するバーの操作クラスを作ってみましょう。<br>
プレイヤーが行える状態は次の構造になりますね。<br>
<a href="https://camo.qiitausercontent.com/b44ca4a003fec7d4ef5f694adbcddb71efc2d0cb/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f706e672f536f576b49496d6741537444755368384a34624c4943716a4141624b4934616a4a59784142325a3970435f5a596a51414c54334c6a4c446d6f496e454a4366394a47616b49496e39764b425857554c5479763034684131534263484858333438544a302d627144674e57684735473030" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmoInEJCf9JGakIIn9vKBXWULTyv04hA1SBcHHX348TJ0-bqDgNWhG5G00?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=121a3a1875e19fbb789f641fd46a1d93" alt="PlayerState" data-canonical-src="http://www.plantuml.com/plantuml/png/SoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmoInEJCf9JGakIIn9vKBXWULTyv04hA1SBcHHX348TJ0-bqDgNWhG5G00" srcset="https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmoInEJCf9JGakIIn9vKBXWULTyv04hA1SBcHHX348TJ0-bqDgNWhG5G00?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0550e2412bddd189401581e8e1b2e436 1x" loading="lazy"></a><br>
では、この構造をソースコードに落とし込んでいきます。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Player.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="p">[</span><span class="nf">RequireComponent</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Rigidbody</span><span class="p">))]</span>
<span class="p">[</span><span class="nf">RequireComponent</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">MeshFilter</span><span class="p">))]</span>
<span class="p">[</span><span class="nf">RequireComponent</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Transform</span><span class="p">))]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Player</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="c1">// ステートマシンのイベントID列挙型</span>
    <span class="k">private</span> <span class="k">enum</span> <span class="n">StateEventId</span>
    <span class="p">{</span>
        <span class="n">Enable</span><span class="p">,</span>
        <span class="n">Disable</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1">// 中略...</span>

    <span class="c1">// ステートマシン変数の定義、もちろんコンテキストは Player クラス</span>
    <span class="k">private</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Player</span><span class="p">&gt;</span> <span class="n">stateMachine</span><span class="p">;</span>
<span class="c1">// 中略...</span>

    <span class="c1">// コンポーネントの初期化</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
<span class="c1">// 中略...</span>
        <span class="c1">// ステートマシンの遷移テーブルを構築（コンテキストのインスタンスはもちろん自分自身）</span>
        <span class="n">stateMachine</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Player</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">DisabledState</span><span class="p">,</span> <span class="n">EnabledState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Enable</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">EnabledState</span><span class="p">,</span> <span class="n">DisabledState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Disable</span><span class="p">);</span>

        <span class="c1">// 起動状態はDisabled</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">SetStartState</span><span class="p">&lt;</span><span class="n">EnabledState</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
<span class="c1">// 中略...</span>
        <span class="c1">// ステートマシンを起動</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Playerクラスと言っておきながら移動コンポーネントなのでFixedUpdateでステートマシンを回す</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">FixedUpdate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンの更新</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// プレイヤーの操作を有効にします</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">EnableMove</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンに有効イベントを叩きつける</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Enable</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// プレイヤーの操作を無効にします</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">DisableMove</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンに無効イベントを叩きつける</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Disable</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// プレイヤーの移動も何も出来ない哀れな状態クラス</span>
    <span class="k">private</span> <span class="k">class</span> <span class="nc">DisabledState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Player</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// プレイヤーの移動が許された状態クラス</span>
    <span class="k">private</span> <span class="k">class</span> <span class="nc">EnabledState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Player</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
        <span class="c1">// 状態の更新を行います</span>
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
        <span class="p">{</span>
<span class="c1">// 中略...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="ブロッククラスを書く" class="fragment"></span><a href="#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>ブロッククラスを書く</h3>

<p>次にブロックの状態をコントロールするクラスを作ってみましょう。<br>
ブロックが起こりうる状態は次の構造になりますね。<br>
<a href="https://camo.qiitausercontent.com/bb6dc8354e3659ffdc92a0b95e8a650a78e9153a/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f706e672f536f576b49496d6741537444755368384a34624c4943716a4141624b4934616a4a59784142325a3970435f5a596a51414c54334c6a4c446d70436169496d716b49496e39764b386d6d4a386b674f61663439754c63437135357131655843613766504f31554c6d45674e616647336931" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmpCaiImqkIIn9vK8mmJ8kgOaf49uLcCq55q1eXCa7fPO1ULmEgNafG3i1?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ab24c0e838c3bce81a437211d151a8d4" alt="BlockState" data-canonical-src="http://www.plantuml.com/plantuml/png/SoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmpCaiImqkIIn9vK8mmJ8kgOaf49uLcCq55q1eXCa7fPO1ULmEgNafG3i1" srcset="https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmpCaiImqkIIn9vK8mmJ8kgOaf49uLcCq55q1eXCa7fPO1ULmEgNafG3i1?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=baec0c7637edcfdc3da4d4b780475fcb 1x" loading="lazy"></a><br>
では、この構造をソースコードに落とし込んでいきます。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">Block.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Block</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="c1">// 状態イベントの定義</span>
    <span class="k">private</span> <span class="k">enum</span> <span class="n">StateEventId</span>
    <span class="p">{</span>
        <span class="n">Dead</span><span class="p">,</span>
        <span class="n">Revive</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">// 現在の状態が生存状態なら生存していることを返すプロパティ</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">=&gt;</span> <span class="n">stateMachine</span><span class="p">.</span><span class="n">IsCurrentState</span><span class="p">&lt;</span><span class="n">AliveState</span><span class="p">&gt;();</span>
    <span class="k">private</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Block</span><span class="p">&gt;</span> <span class="n">stateMachine</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">stateMachine</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Block</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">AliveState</span><span class="p">,</span> <span class="n">DeadState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Dead</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">DeadState</span><span class="p">,</span> <span class="n">AliveState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Revive</span><span class="p">);</span>

        <span class="n">stateMachine</span><span class="p">.</span><span class="n">SetStartState</span><span class="p">&lt;</span><span class="n">AliveState</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">OnCollisionEnter</span><span class="p">(</span><span class="n">Collision</span> <span class="n">collision</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 衝突した相手がボールなら</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">collision</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="n">name</span> <span class="p">==</span> <span class="s">"Ball"</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 死亡イベントを送る</span>
            <span class="n">stateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Dead</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Revive</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンに復活イベントを送る</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Revive</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">AliveState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Block</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
<span class="c1">// 中略...</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">DeadState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">Block</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
<span class="c1">// 中略...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="シーンクラスを書く" class="fragment"></span><a href="#%E3%82%B7%E3%83%BC%E3%83%B3%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>シーンクラスを書く</h3>

<p>次にゲームの流れをコントロールするシーンのクラスを作ってみましょう。<br>
シーンが起こりうる状態は次の構造になりますね。<br>
<a href="https://camo.qiitausercontent.com/b9f953e5ad73c7d57fd03c08ab8a770f561b6568/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f706e672f565033313269386d34344a6c2d6e4b76325f71313372384c7a494841464f673773326e735150674d50314e707a74514c4b3568484976584374594a506f474468705f563647614b36354a4f5448734b6d62397577666a5231554e50484d5250473147526134736a3636454a78663556454e4546376341696a4547654c5a3570315a625037536855346f485036646131783259344865682d39644d766d524c37785832736a4e54637368466b62485755492d6c6374306a64373249384e375878653478447634694675624b61316d7630662d765f417150632d75485330" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FVP312i8m44Jl-nKv2_q13r8LzIHAFOg7s2nsQPgMP1NpztQLK5hHIvXCtYJPoGDhp_V6GaK65JOTHsKmb9uwfjR1UNPHMRPG1GRa4sj66EJxf5VENEF7cAijEGeLZ5p1ZbP7ShU4oHP6da1x2Y4Heh-9dMvmRL7xX2sjNTcshFkbHWUI-lct0jd72I8N7Xxe4xDv4iFubKa1mv0f-v_AqPc-uHS0?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7e30051dba18e26e034da89378a852cf" alt="SceneState" data-canonical-src="http://www.plantuml.com/plantuml/png/VP312i8m44Jl-nKv2_q13r8LzIHAFOg7s2nsQPgMP1NpztQLK5hHIvXCtYJPoGDhp_V6GaK65JOTHsKmb9uwfjR1UNPHMRPG1GRa4sj66EJxf5VENEF7cAijEGeLZ5p1ZbP7ShU4oHP6da1x2Y4Heh-9dMvmRL7xX2sjNTcshFkbHWUI-lct0jd72I8N7Xxe4xDv4iFubKa1mv0f-v_AqPc-uHS0" srcset="https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FVP312i8m44Jl-nKv2_q13r8LzIHAFOg7s2nsQPgMP1NpztQLK5hHIvXCtYJPoGDhp_V6GaK65JOTHsKmb9uwfjR1UNPHMRPG1GRa4sj66EJxf5VENEF7cAijEGeLZ5p1ZbP7ShU4oHP6da1x2Y4Heh-9dMvmRL7xX2sjNTcshFkbHWUI-lct0jd72I8N7Xxe4xDv4iFubKa1mv0f-v_AqPc-uHS0?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a9110272ef85ee047eeec74390fba191 1x" loading="lazy"></a><br>
では、この構造をソースコードに落とし込んでいきます。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">MainGameScene.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">IceMilkTea.Core</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MainGameScene</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="c1">// ステートマシンのイベントID列挙型</span>
    <span class="k">private</span> <span class="k">enum</span> <span class="n">StateEventId</span>
    <span class="p">{</span>
        <span class="n">Play</span><span class="p">,</span>
        <span class="n">Miss</span><span class="p">,</span>
        <span class="n">Retry</span><span class="p">,</span>
        <span class="n">Exit</span><span class="p">,</span>
        <span class="n">AllBlockBloken</span><span class="p">,</span>
        <span class="n">Finish</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1">// 中略...</span>

    <span class="c1">// ステートマシン変数の定義、もちろんコンテキストは MainGameScene クラス</span>
    <span class="k">private</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">MainGameScene</span><span class="p">&gt;</span> <span class="n">stateMachine</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">missCount</span><span class="p">;</span>

    <span class="c1">// コンポーネントの初期化</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンの遷移テーブルを構築（コンテキストのインスタンスはもちろん自分自身）</span>
        <span class="n">stateMachine</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">MainGameScene</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">ResetState</span><span class="p">,</span> <span class="n">StandbyState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Finish</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">StandbyState</span><span class="p">,</span> <span class="n">PlayingState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Play</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">PlayingState</span><span class="p">,</span> <span class="n">MissState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Miss</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">PlayingState</span><span class="p">,</span> <span class="n">GameClearState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">AllBlockBloken</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">MissState</span><span class="p">,</span> <span class="n">StandbyState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Retry</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">MissState</span><span class="p">,</span> <span class="n">GameOverState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Exit</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">GameClearState</span><span class="p">,</span> <span class="n">ResetState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Finish</span><span class="p">);</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">AddTransition</span><span class="p">&lt;</span><span class="n">GameOverState</span><span class="p">,</span> <span class="n">ResetState</span><span class="p">&gt;((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Finish</span><span class="p">);</span>


        <span class="c1">// 起動状態はReset</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="n">SetStartState</span><span class="p">&lt;</span><span class="n">ResetState</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンを起動</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンの更新</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">MissSignal</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ステートマシンにミスイベントを送る</span>
        <span class="n">stateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Miss</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">ResetState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">MainGameScene</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Enter</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">block</span> <span class="k">in</span> <span class="n">Context</span><span class="p">.</span><span class="n">blocks</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">block</span><span class="p">.</span><span class="nf">Revive</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="n">Context</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Transform</span><span class="p">&gt;().</span><span class="n">position</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="n">playerStartTransform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
            <span class="n">Context</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="nf">DisableMove</span><span class="p">();</span>
            <span class="n">Context</span><span class="p">.</span><span class="n">ball</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Transform</span><span class="p">&gt;().</span><span class="n">position</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="n">ballStartTransform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
            <span class="n">Context</span><span class="p">.</span><span class="n">ball</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody</span><span class="p">&gt;().</span><span class="n">velocity</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>

            <span class="n">StateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Finish</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">StandbyState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">MainGameScene</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetKeyDown</span><span class="p">(</span><span class="n">KeyCode</span><span class="p">.</span><span class="n">Space</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">StateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Play</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">PlayingState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">MainGameScene</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Enter</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">xDirection</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="nf">Range</span><span class="p">(-</span><span class="m">1.0f</span><span class="p">,</span> <span class="m">1.0f</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">zDirection</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0.5f</span><span class="p">,</span> <span class="m">1.0f</span><span class="p">);</span>
            <span class="n">Context</span><span class="p">.</span><span class="n">ball</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody</span><span class="p">&gt;().</span><span class="n">velocity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="n">xDirection</span><span class="p">,</span> <span class="m">0.0f</span><span class="p">,</span> <span class="n">zDirection</span><span class="p">).</span><span class="n">normalized</span> <span class="p">*</span> <span class="n">Context</span><span class="p">.</span><span class="n">ballSpeed</span><span class="p">;</span>

            <span class="n">Context</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="nf">EnableMove</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">blockAllDead</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">block</span> <span class="k">in</span> <span class="n">Context</span><span class="p">.</span><span class="n">blocks</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">IsAlive</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">blockAllDead</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">blockAllDead</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">StateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">AllBlockBloken</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">MissState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">MainGameScene</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Enter</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Context</span><span class="p">.</span><span class="n">player</span><span class="p">.</span><span class="nf">DisableMove</span><span class="p">();</span>
            <span class="n">Context</span><span class="p">.</span><span class="n">ball</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Transform</span><span class="p">&gt;().</span><span class="n">position</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="n">ballStartTransform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
            <span class="n">Context</span><span class="p">.</span><span class="n">ball</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody</span><span class="p">&gt;().</span><span class="n">velocity</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>

            <span class="n">Context</span><span class="p">.</span><span class="n">missCount</span> <span class="p">+=</span> <span class="m">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="n">missCount</span> <span class="p">==</span> <span class="n">Context</span><span class="p">.</span><span class="n">availablePlayCount</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">StateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Exit</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">StateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Retry</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">GameClearState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">MainGameScene</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Enter</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"GameClear!!!"</span><span class="p">);</span>
            <span class="n">StateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Finish</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">GameOverState</span> <span class="p">:</span> <span class="n">ImtStateMachine</span><span class="p">&lt;</span><span class="n">MainGameScene</span><span class="p">&gt;.</span><span class="n">State</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Enter</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Debug</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="s">"GameOver..."</span><span class="p">);</span>
            <span class="n">StateMachine</span><span class="p">.</span><span class="nf">SendEvent</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">StateEventId</span><span class="p">.</span><span class="n">Finish</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h1>
<span id="完成" class="fragment"></span><a href="#%E5%AE%8C%E6%88%90"><i class="fa fa-link"></i></a>完成</h1>

<p><a href="https://camo.qiitausercontent.com/e24f19ea725691344301ff9550c0fa3da141179b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3332383936372f31636432323862662d353538622d656330632d353439382d3532333965663963386134622e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/328967/1cd228bf-558b-ec0c-5498-5239ef9c8a4b.gif" alt="完成映像.gif" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/328967/1cd228bf-558b-ec0c-5498-5239ef9c8a4b.gif" loading="lazy"></a><br>
完成しました。</p>

<p>完成プロジェクトに関しては、GitHubにて公開しました。<br>
<a href="https://github.com/BelColo/ImtStateMachineUseSample" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/BelColo/ImtStateMachineUseSample</a></p>

<p>当初より予定していた、記事の長さを遥かに超える事になってしまいましたが、いかがでしたでしょうか。<br>
サンプルコードはパフォーマンスや実装方法について、ステートマシンの動かし方を重点的に説明するため、犠牲になっていますが、それでもステートマシンを使ったことによって遥かに実装が楽になっていることがわかるはずです。</p>

<p>今回使ったImtStateMachineは、Unityだけに留まらず<strong>サーバーサイドのプログラムにも使われており、実際使わせてもらっています</strong>。<br>
ImtStateMachineが流行ることを願いつつ今回は、これでしめさせて頂きます。</p>

<p>ImtStateMachineを使ったテクニック集などもいつの日か、書ける日が来たら書こうと思います。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FBelColo%2Fitems%2Fa94c9ccc2d5174dc29a3&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FBelColo%2Fitems%2Fa94c9ccc2d5174dc29a3&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/BelColo/items/a94c9ccc2d5174dc29a3/likers" class="css-1iupg5d">96</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">84</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/a94c9ccc2d5174dc29a3/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/BelColo/items/a94c9ccc2d5174dc29a3/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/BelColo/items/a94c9ccc2d5174dc29a3/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/BelColo/items/a94c9ccc2d5174dc29a3/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/BelColo/items/a94c9ccc2d5174dc29a3.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-8f8439d0-49fe-4b22-917b-084c6f793155">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-3d6de6ee-4cb8-47e5-a419-f988f3898e9f"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-3d6de6ee-4cb8-47e5-a419-f988f3898e9f">{}</script>
      
<div id="LoginModal-react-component-eb8f42c3-82ef-4574-982f-f3cce03fd798"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-eb8f42c3-82ef-4574-982f-f3cce03fd798">{}</script>
      
<div id="StockModal-react-component-22a44475-65f5-4fad-925f-dfb3630232d1"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-22a44475-65f5-4fad-925f-dfb3630232d1">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;67nC21SUE/IHIafQ84nNahbcBi6CBgrsjWZgIBEaPq2UTUHIeLm5xxZk8Qf4i7LGdzSGksXJue/JExjD1GeezQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch4\u003e\n\u003cspan id=\"加筆-or-修正\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8A%A0%E7%AD%86-or-%E4%BF%AE%E6%AD%A3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e加筆 or 修正\u003c/h4\u003e\n\n\u003cul\u003e\n\u003cli\u003e2021-02-09\n\n\u003cul\u003e\n\u003cli\u003eImtStateMachine.cs のリンクを修正\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"前置き\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%89%8D%E7%BD%AE%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e前置き\u003c/h1\u003e\n\n\u003cp\u003eステートマシンよりも前に、状態制御とはなにかを書いていたのですが、思った以上に長くなりそうだったので、状態制御については別記事にします。\u003cbr\u003e\n今回は、\u003cstrong\u003eシノア氏\u003c/strong\u003eが開発しているOSSである \u003ca href=\"https://github.com/Sinoa/IceMilkTea/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003cstrong\u003eIceMilkTea\u003c/strong\u003e\u003c/a\u003e という、Unityゲームエンジン向け開発サポートライブラリの「\u003cstrong\u003eサブセット\u003c/strong\u003e」である \u003ca href=\"https://github.com/Sinoa/IceMilkTea/blob/develop/Packages/IceMilkTea/Runtime/Core/StateMachine.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003cstrong\u003eImtStateMachine\u003c/strong\u003e\u003c/a\u003e を紹介（語り尽く）したいと思います。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"unityで状態制御といえば\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unity%E3%81%A7%E7%8A%B6%E6%85%8B%E5%88%B6%E5%BE%A1%E3%81%A8%E3%81%84%E3%81%88%E3%81%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUnityで状態制御といえば\u003c/h1\u003e\n\n\u003cp\u003e殆どのUnityゲームクリエイターがステートマシンと聞いたら次のアセットを思い浮かべるのではないのでしょうか\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://assetstore.unity.com/packages/tools/visual-scripting/playmaker-368\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003cstrong\u003ePlaymaker\u003c/strong\u003e\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eUnityのステートマシンの老舗と言えばこのアセットですよね、Unity3.2の頃ではお世話になっていました。\u003c/li\u003e\n\u003cli\u003eいまでもメンテナンスは続いており、Playmaker以外の人もPlaymaker用追加モジュールを製作されているほどの人気です。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://assetstore.unity.com/packages/tools/visual-scripting/behaviour-machine-indie-20202\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003cstrong\u003eBehaviour Machine\u003c/strong\u003e\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e非常に軽快でシンプルでありながら、強力なビジュアルエディタが付属しており使い勝手が抜群です。\u003c/li\u003e\n\u003cli\u003eまた、有料版になりますが、ソースコードもフルオープンのためブラックボックスがなく、問題が起きた時の調査もしやすいです。\u003c/li\u003e\n\u003cli\u003eUnity4.6～5.xではお世話になっていました。\u003c/li\u003e\n\u003cli\u003eしかも、ステートマシンだけに限らずビヘイビアツリーと言った状態制御方法もサポートしています。（むしろこっちが本命でステートマシンがおまけ感）\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://assetstore.unity.com/packages/tools/visual-scripting/arbor-3-fsm-bt-graph-editor-112239\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003cstrong\u003eArbor 3: FSM \u0026amp; BT Graph Editor\u003c/strong\u003e\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e知る人ぞ知る、日本国産のステートマシンアセットです。\u003c/li\u003e\n\u003cli\u003eそのため、日本語マニュアルも完備されており、ビジュアルエディタも日本語サポートされています。\u003c/li\u003e\n\u003cli\u003eこちらもビヘイビアツリーを実現する機能が提供されています。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ステートマシンとは少し違いますが\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%A8%E3%81%AF%E5%B0%91%E3%81%97%E9%81%95%E3%81%84%E3%81%BE%E3%81%99%E3%81%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eステートマシンとは少し違いますが\u003c/h3\u003e\n\n\u003cp\u003eなにも、状態制御はステートマシンだけが実装方法ではありません。解決方法は違えど状態制御が可能なものもあります。\u003cbr\u003e\nUnityにおいてもステートマシンを使わずとも状態制御は可能です。本題と少しずれてしまいますが、他のアセットも見てみましょう。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://assetstore.unity.com/packages/tools/integration/unirx-reactive-extensions-for-unity-17276\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003cstrong\u003eUniRx\u003c/strong\u003e\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eC#界隈で有名な neuecc氏が開発しているUnity向けにチューニングされた ReactiveExtensions と言えばこれですね\u003c/li\u003e\n\u003cli\u003eRxライクでUnity向けのオペレータも豊富です。\u003c/li\u003e\n\u003cli\u003eほぼシーケンシャルな状態遷移及び状態の振る舞いがシンプルなら非常に強力に働くでしょう。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://assetstore.unity.com/packages/tools/visual-scripting/behavior-designer-behavior-trees-for-everyone-15277\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003cstrong\u003eBehavior Designer\u003c/strong\u003e\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eUnityのビヘイビアツリーの老舗と言えばこのアセットですね、Unity 4.6世代あたりではお世話になっていました。\u003c/li\u003e\n\u003cli\u003eビジュアルエディタも非常にわかりやすく、デバッグ機能も非常に強力でツリーの構築も非常にやりやすいです。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://assetstore.unity.com/packages/tools/visual-scripting/nodecanvas-14914\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003cstrong\u003eNodeCanvas\u003c/strong\u003e\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eビヘイビアツリー界隈で知らない人は居ないのではないのでしょうか、これも非常に有名ですね。\u003c/li\u003e\n\u003cli\u003eやや独特なビジュアルエディタでありながら、非常にハイパフォーマンスでかつメモリ効率も良いアセットです。\u003c/li\u003e\n\u003cli\u003eまたPlaymakerと同様、様々なサブシステムへのインテグレーションも行われており、非常にサードパーティが多いのも一つの魅力です。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"これだけのオススメのアセットがあるのに何故-imtstatemachine\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%93%E3%82%8C%E3%81%A0%E3%81%91%E3%81%AE%E3%82%AA%E3%82%B9%E3%82%B9%E3%83%A1%E3%81%AE%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%8C%E3%81%82%E3%82%8B%E3%81%AE%E3%81%AB%E4%BD%95%E6%95%85-imtstatemachine\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eこれだけのオススメのアセットがあるのに何故 ImtStateMachine？\u003c/h1\u003e\n\n\u003cp\u003e殆どのインディーズ系Unityゲーム開発であれば、上記で紹介したアセットで事足りますし\u003cbr\u003e\n実際、非常にエディタとしても強力でそれなりのパフォーマンスが得られます。\u003cbr\u003e\nでは、それでもその恩恵を捨てながらも ImtStateMachine を使う理由とは何でしょうか。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"サーバーコードもunity側実装と同じようにかつハイパフォーマンスで使いたい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%B3%E3%83%BC%E3%83%89%E3%82%82unity%E5%81%B4%E5%AE%9F%E8%A3%85%E3%81%A8%E5%90%8C%E3%81%98%E3%82%88%E3%81%86%E3%81%AB%E3%81%8B%E3%81%A4%E3%83%8F%E3%82%A4%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%A7%E4%BD%BF%E3%81%84%E3%81%9F%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eサーバーコードも、Unity側実装と同じようにかつハイパフォーマンスで使いたい！\u003c/h3\u003e\n\n\u003cp\u003e近年では、スマートフォンゲームでも珍しくなくなってきた、リアルタイムオンライン通信によるマルチプレイゲームが流行ってきています。\u003cbr\u003e\nそのため、サーバーサイド側の開発事情も変わってきています。殆どの通信は1度のリクエストで1度のレスポンスで済むものです、それも今も変わりません。\u003cbr\u003e\nしかし、リアルタイム通信で同期型のオンライン通信となると、ガラッと変わりサーバーが今まで\u003cstrong\u003eステートレスな処理\u003c/strong\u003eから\u003cstrong\u003eステートフルな処理\u003c/strong\u003eへ大変貌を遂げました。\u003c/p\u003e\n\n\u003cp\u003eそれを解決するには、ステートマシンによる状態制御が必要です。\u003cbr\u003e\nそこで、可能ならばUnityで実装しているような状態制御をサーバーサイド側のプログラムでもやりたい！\u003cbr\u003e\nしかも、サーバー側コードなので、ただ状態制御が出来るだけでなく、パフォーマンスも保証し安定して動作しなければなりません。\u003cbr\u003e\nそんな理由もあり、それを実現出来るのが ImtStateMachine でした。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"imtstatemachine-の特徴\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#imtstatemachine-%E3%81%AE%E7%89%B9%E5%BE%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eImtStateMachine の特徴\u003c/h3\u003e\n\n\u003cp\u003eでは、サーバーサイドでもUnityでも使えるステートマシンといわれる ImtStateMachine はどんなステートマシンなのか箇条書きで簡単ですが、以下にまとめました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003e本体がピュアC#で実装されている\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e本体コードを見るとわかりますが、本体コードの全てが\u003cstrong\u003eC#の標準クラスでのみ実装\u003c/strong\u003eされています。\u003c/li\u003e\n\u003cli\u003eそのため、C#の実装環境なら殆どの場所で\u003cstrong\u003e再利用が可能\u003c/strong\u003eです。\u003c/li\u003e\n\u003cli\u003eサーバーコードでもUnityコードでも使える理由はこれのおかげです。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eソースコードファイルがたった1つ\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003eなんと、ステートマシンとして実現する実装コードはたったの1ファイルのみです。\u003c/li\u003e\n\u003cli\u003eフルセットである IceMilkTea をまるごと導入する必要はありません。\u003c/li\u003e\n\u003cli\u003eそのため、\u003cstrong\u003e非常にポータビリティが高い\u003c/strong\u003eので再利用性がより一層上がります。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eハイパフォーマンスでメモリ効率もよい\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e非常にコンパクトな実装のため、\u003cstrong\u003eナノ秒オーダーでの動作が可能\u003c/strong\u003eです。\u003c/li\u003e\n\u003cli\u003e一度動作を開始したら、ステートマシンによるGCAllocは一切ありません。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e安全に動作する（例外耐性が高い）\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003eImtStateMachineが、ステートで発生した例外を適切に拾い上げて制御する方法を提供しています（\u003cstrong\u003eUnhandledException機構\u003c/strong\u003e）。\u003c/li\u003e\n\u003cli\u003eステートで例外が発生してもステートマシンが不正終了する事が無いため、そのまま復帰することが可能です。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e状態の遷移が決められていて入力と紐付けられる（有限状態機械）\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e有限状態機械として実装するための遷移テーブルを構築する手段が提供されています。\u003c/li\u003e\n\u003cli\u003e遷移テーブルも非常に見やすい書き方で実現されています。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e任意状態遷移を構築できる（Any遷移）\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e有限状態機械のみならず、ステートパターンとして組むための任意遷移が提供されています。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eどの型（クラス）に対してもステートマシンとして実装出来る（コンテキストフリー）\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003eステートマシン自体にコンテキストは存在せず、コンテキストはユーザー定義型で実装することが可能です。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e状態の遷移条件を状態毎に実装が可能（遷移ガード）\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003eステートマシンの入力に対して、ステートが遷移をコントロールすることが可能です。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e状態のスタックが可能（状態割り込み）\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e状態を維持したまま状態を遷移して、状態を元に戻すといった事が可能です。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eライセンスがzlib/libpng（MITライセンスよりもっと緩い）\u003c/strong\u003e\n\n\u003cul\u003e\n\u003cli\u003e最近の OSS では MIT ライセンスが多いですが IceMilkTea は zlib/libpng ライセンスという形を取っています。\u003c/li\u003e\n\u003cli\u003eすごくざっくりいうと（as-is（現状の））まま使われることを想定しているけど、改変は自由にOK（その際は改変されたということがわかるようにすること）\u003c/li\u003e\n\u003cli\u003e改変したとしても、開発者を偽らなければそのまま使っていいよ（ソースコードに書かれている作者情報をそのままにすること）\u003c/li\u003e\n\u003cli\u003e特に、権利者表記を義務付けないよ、書いてもいいけど作者から書くことは強要しないよ\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"大まかな使い方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A4%A7%E3%81%BE%E3%81%8B%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e大まかな使い方\u003c/h1\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"状態の書き方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%8A%B6%E6%85%8B%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e状態の書き方\u003c/h3\u003e\n\n\u003cp\u003eステートマシンと言うからには状態の定義が必要です。\u003cbr\u003e\nImtStateMachine は、どのステートマシンの状態なのかという実装の仕方になります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"err\"\u003eコンテキストになるクラスの型\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e実例.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 状態を定義しているだけの何もしないクラス\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHoge\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// この Hoge クラスのステートマシン\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// この Hoge クラスのアイドリング状態クラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eIdleState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 何もしない状態クラスなら何も書かなくても良い（むしろ無駄なoverrideは避ける）\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// この Hoge クラスのなにかを処理している状態クラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProcessState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 状態へ突入時の処理はこのEnterで行う\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 状態の更新はこのUpdateで行う\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 状態から脱出する時の処理はこのExitで行う\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eExit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 状態で発生した未処理の例外がキャッチされた時の処理はこのErrorで行う\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eError\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003eexception\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 未処理の例外をハンドリングしたのなら true を返すことで、ステートマシンはエラーから復帰します\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// ステートマシンが状態の遷移をする前にステートマシンのイベント入力を処理するならこのGuardEventで行う\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eGuardEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eeventId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 特定のタイミングで遷移を拒否（ガード）するなら true を返せばステートマシンは遷移を諦めます\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisActiveAndEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 遷移を許可するなら false を返せばステートマシンは状態の遷移をします\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// ステートマシンが前回のプッシュした状態に復帰する時の処理をするならこのGuardPopで行う\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003einternal\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eGuardPop\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 復帰を拒否（ガード）するなら true を返せばステートマシンは復帰を諦めます\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eisActiveAndEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 復帰を許可するなら false を返せばステートマシンは復帰します\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこの例では、1ソースコードで状態を実装していますが、C#にはpartialという型の分割定義が可能なので、メンテナンス性を考慮し状態クラスごとにソースコードを分けると良いです。\u003cbr\u003e\n\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/keywords/partial-type\" rel=\"nofollow noopener\" target=\"_blank\"\u003epartial 型 (C# リファレンス)\u003c/a\u003e\u003cbr\u003e\nもちろん、コード規模によっては1ファイルで書いたほうが良い場面もあるので、適切な分量で書き分けましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eHoge.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHoge\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// この Hoge クラスのステートマシン\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eHoge.IdleState.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHoge\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// この Hoge クラスのアイドリング状態クラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eIdleState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eHoge.ProcessState.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHoge\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// この Hoge クラスのなにかを処理している状態クラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProcessState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"状態遷移テーブルの作り方\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%8A%B6%E6%85%8B%E9%81%B7%E7%A7%BB%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e状態遷移テーブルの作り方\u003c/h3\u003e\n\n\u003cp\u003e殆どのケースでは有限状態機械として実装することが多いので、その遷移テーブルを記述してみます。\u003cbr\u003e\nImtStateMachine では AddTransition, AddAnyTransition, AddTransitionRange の3つの関数でテーブルを構築し、SetStartState で開始状態を定義する事ができます。\u003c/p\u003e\n\n\u003cp\u003e遷移テーブルは状態クラスの型を使って from -\u0026gt; to : input といった形で関数を呼びます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// この関数を呼ぶと（遷移元状態クラスの状態で、入力値の入力をされた時に、遷移先状態クラスの状態へ遷移する）という定義になります。\u003c/span\u003e\n\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"err\"\u003e遷移元の状態クラスの型\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"err\"\u003e遷移先の状態クラスの型\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"err\"\u003e入力値\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHoge\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ステートマシンの入力（イベント）を判り易くするために列挙型で定義\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eReset\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// この Hoge クラスのステートマシン\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAwake\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンのインスタンスを生成して遷移テーブルを構築\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eHoge\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 自身がコンテキストになるので自身のインスタンスを渡す\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIdleState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eProcessState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eProcessState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIdleState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 起動ステートを設定（起動ステートは IdleState）\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSetStartState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIdleState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e上記の呼び出しを行うと、次のような状態遷移テーブルが構築されます\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/9d153fd2f0c6150bb67712f189812570e8231352/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f706e672f536f576b49496d6741537444755368384a34624c4943716a4141624b4934616a4a59784142325a3970435f5a596a51414c54334c6a4c466d4a43623933497639423464625768434b574338314856643967534e353442774c57626a634e63506e31585541413547704a34624751643567325054335162754171354f30\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLFmJCb93Iv9B4dbWhCKWC81HVd9gSN54BwLWbjcNcPn1XUAA5GpJ4bGQd5g2PT3QbuAq5O0?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=4a8469fb68b1259a3ca48e461091fdd9\" alt=\"状態遷移構築サンプル\" data-canonical-src=\"http://www.plantuml.com/plantuml/png/SoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLFmJCb93Iv9B4dbWhCKWC81HVd9gSN54BwLWbjcNcPn1XUAA5GpJ4bGQd5g2PT3QbuAq5O0\" srcset=\"https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLFmJCb93Iv9B4dbWhCKWC81HVd9gSN54BwLWbjcNcPn1XUAA5GpJ4bGQd5g2PT3QbuAq5O0?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0ea5208e955de050164ba36b81de8c2a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ステートマシンの更新ループ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E6%9B%B4%E6%96%B0%E3%83%AB%E3%83%BC%E3%83%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eステートマシンの更新ループ\u003c/h3\u003e\n\n\u003cp\u003e状態クラスの定義、遷移テーブルの構築、をここまでやったら後はステートマシンを動かすだけです。\u003cbr\u003e\nImtStateMachine では Update 関数がステートマシンの起動と更新を担います。\u003cbr\u003e\n通常、Unityでは、コンポーネントの更新ループ関数で状態の更新を行うので、コンポーネントの Start 関数で起動し Update 関数で更新するのが常套手段になります。\u003cbr\u003e\nまた、サンプルコードを見ていただけたら分かりますが ImtStateMachine は Update 関数を呼び出すだけで状態更新を行えます。\u003cbr\u003e\n業務アプリケーションなどのフォームアプリケーション、コンソールアプリケーションなどで動かす場合は、OSのメッセージループ内で呼び出したり、タイマやボタンのクリック等の特定イベントなどでのタイミングでの更新も可能です。\u003cbr\u003e\nご自身の希望するタイミングで、更新タイミングを実行することが可能です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHoge\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/*\n中略...\n*/\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンを起動\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ひたすら更新\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ステートマシンへのイベント入力\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%B8%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E5%85%A5%E5%8A%9B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eステートマシンへのイベント入力\u003c/h3\u003e\n\n\u003cp\u003eステートマシンへ状態の遷移をするための指示をするには、入力が必要です。\u003cbr\u003e\nImtStateMachine では SendEvent 関数で状態の遷移をする事が出来ます。\u003cbr\u003e\n入力する値は、遷移テーブルを構築する時に Add～Transition 関数に渡した引数の値になります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003epartial\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eHoge\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/*\n中略...\n*/\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 何かがぶつかった！\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnCollisionEnter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCollision\u003c/span\u003e \u003cspan class=\"n\"\u003ecollision\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンにイベントを送る\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// この例では IdleState の状態時は ProcessState へ遷移するが\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ProcessState の状態時は、遷移する先が無いので何も起きない\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"試しに使ってみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A9%A6%E3%81%97%E3%81%AB%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e試しに使ってみる\u003c/h1\u003e\n\n\u003cp\u003e本当は、もっともっと ImtStateMachine を使ったテクニックを紹介したいのですが、今回はカレンダー記事ということで基本中の基本という「語り尽くす」とはと何だと思ってしまいます。\u003cbr\u003e\n代わりと言ってはなんですが、たった一つの ImtStateMachine のソースコードファイルをインポートしたUnityプロジェクトで簡単なサンプルを作ってみたので、ご参照下さい。\u003cbr\u003e\nImtStateMachine を使ったテクニック集なども、いずれ記事にしたいと思います。\u003c/p\u003e\n\n\u003cp\u003eでは、早速 ImtStateMachine を使ってUnityで簡単なサンプルを作ってみます。\u003c/p\u003e\n\n\u003cp\u003e今回作るゲームは、ブロック崩しを作りたいと思います。\u003cbr\u003e\n要件は次の通りです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eスペースキーでボールを発射\u003c/li\u003e\n\u003cli\u003e全てのブロックが破壊されれば終了\u003c/li\u003e\n\u003cli\u003eプレイヤーがボールを受け取れずミスを3回したらゲーム終了\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"新規unityプロジェクトを作ってソースコードをインポート\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%96%B0%E8%A6%8Funity%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e新規Unityプロジェクトを作ってソースコードをインポート\u003c/h3\u003e\n\n\u003cp\u003e今回の使用するUnityエンジンバージョンは 2018.3.0f2 です。\u003cbr\u003e\n早速Unityプロジェクトを新規作成し、シノア氏の IceMilkTea のリポジトリに含まれる ImtStateMachine のソースコードだけ、コピペするかリポジトリをチェックアウトしてきた所から頂戴します。\u003cbr\u003e\n\u003ca href=\"https://github.com/Sinoa/IceMilkTea/blob/develop/Program/Runtime/Core/UnitCode/PureCsharp/StateMachine.cs\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/Sinoa/IceMilkTea/blob/develop/Program/Runtime/Core/UnitCode/PureCsharp/StateMachine.cs\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/9c24edc40a6ff75628b3b9c25487bb65d93e05a1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3332383936372f33643437306366332d313839322d613537632d393436622d6539623735346335386534642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F3d470cf3-1892-a57c-946b-e9b754c58e4d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=bc87917a5cd4a06a57b73f41b6c6ff9c\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/328967/3d470cf3-1892-a57c-946b-e9b754c58e4d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F3d470cf3-1892-a57c-946b-e9b754c58e4d.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6f927f4269aa5d28db2907c2a9aabadd 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこのように、ポンっとPluginsディレクトリに置くだけの簡単な作業です。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"物理エンジンのバウンド閾値を調整\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%89%A9%E7%90%86%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%81%AE%E3%83%90%E3%82%A6%E3%83%B3%E3%83%89%E9%96%BE%E5%80%A4%E3%82%92%E8%AA%BF%E6%95%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e物理エンジンのバウンド閾値を調整\u003c/h3\u003e\n\n\u003cp\u003e今回作るゲームはブロック崩しの為ボールが確実にバウンドするように、物理エンジンのバウンドするかどうかの閾値を0にします。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/7bddb942d934d96510a9065282eb3019a3bae119/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3332383936372f38616537366236652d333563322d616538322d356235332d6539323030366339313736302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F8ae76b6e-35c2-ae82-5b53-e92006c91760.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=c247d3ac4ce42eda77ab9a0ae89f8be8\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/328967/8ae76b6e-35c2-ae82-5b53-e92006c91760.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F8ae76b6e-35c2-ae82-5b53-e92006c91760.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=22d743144a6c3e615abe905b9c5073df 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ステージをパパパっと作る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8%E3%82%92%E3%83%91%E3%83%91%E3%83%91%E3%81%A3%E3%81%A8%E4%BD%9C%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eステージをパパパっと作る\u003c/h3\u003e\n\n\u003cp\u003e全てプリミティブなオブジェクトで組んでしまいます。もちろん物理エンジンのコンポーネントも付けていきます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/e80acf5e32f84d5dfdb78752a67fbc2aa0de0b5f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3332383936372f33306562396434632d623336662d636439392d656634362d3061313035356535373262322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F30eb9d4c-b36f-cd99-ef46-0a1055e572b2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=02a8603112691352b374577f3ae9f002\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/328967/30eb9d4c-b36f-cd99-ef46-0a1055e572b2.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2F30eb9d4c-b36f-cd99-ef46-0a1055e572b2.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d5341d1371a26bdb8078ab612003ec8c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nいい感じです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"プレイヤークラスを書く\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%97%E3%83%AC%E3%82%A4%E3%83%A4%E3%83%BC%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%9B%B8%E3%81%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eプレイヤークラスを書く\u003c/h3\u003e\n\n\u003cp\u003eそれでは、まずプレイヤーとして存在するバーの操作クラスを作ってみましょう。\u003cbr\u003e\nプレイヤーが行える状態は次の構造になりますね。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/b44ca4a003fec7d4ef5f694adbcddb71efc2d0cb/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f706e672f536f576b49496d6741537444755368384a34624c4943716a4141624b4934616a4a59784142325a3970435f5a596a51414c54334c6a4c446d6f496e454a4366394a47616b49496e39764b425857554c5479763034684131534263484858333438544a302d627144674e57684735473030\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmoInEJCf9JGakIIn9vKBXWULTyv04hA1SBcHHX348TJ0-bqDgNWhG5G00?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=121a3a1875e19fbb789f641fd46a1d93\" alt=\"PlayerState\" data-canonical-src=\"http://www.plantuml.com/plantuml/png/SoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmoInEJCf9JGakIIn9vKBXWULTyv04hA1SBcHHX348TJ0-bqDgNWhG5G00\" srcset=\"https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmoInEJCf9JGakIIn9vKBXWULTyv04hA1SBcHHX348TJ0-bqDgNWhG5G00?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0550e2412bddd189401581e8e1b2e436 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nでは、この構造をソースコードに落とし込んでいきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ePlayer.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eRequireComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eRigidbody\u003c/span\u003e\u003cspan class=\"p\"\u003e))]\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eRequireComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMeshFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e))]\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nf\"\u003eRequireComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTransform\u003c/span\u003e\u003cspan class=\"p\"\u003e))]\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePlayer\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ステートマシンのイベントID列挙型\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDisable\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 中略...\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// ステートマシン変数の定義、もちろんコンテキストは Player クラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 中略...\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// コンポーネントの初期化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAwake\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 中略...\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンの遷移テーブルを構築（コンテキストのインスタンスはもちろん自分自身）\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDisabledState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eEnabledState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eEnabledState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eDisabledState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDisable\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 起動状態はDisabled\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSetStartState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eEnabledState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 中略...\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンを起動\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Playerクラスと言っておきながら移動コンポーネントなのでFixedUpdateでステートマシンを回す\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFixedUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンの更新\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// プレイヤーの操作を有効にします\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnableMove\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンに有効イベントを叩きつける\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnable\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// プレイヤーの操作を無効にします\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDisableMove\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンに無効イベントを叩きつける\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDisable\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// プレイヤーの移動も何も出来ない哀れな状態クラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDisabledState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// プレイヤーの移動が許された状態クラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eEnabledState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 状態の更新を行います\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 中略...\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ブロッククラスを書く\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%9B%B8%E3%81%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eブロッククラスを書く\u003c/h3\u003e\n\n\u003cp\u003e次にブロックの状態をコントロールするクラスを作ってみましょう。\u003cbr\u003e\nブロックが起こりうる状態は次の構造になりますね。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/bb6dc8354e3659ffdc92a0b95e8a650a78e9153a/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f706e672f536f576b49496d6741537444755368384a34624c4943716a4141624b4934616a4a59784142325a3970435f5a596a51414c54334c6a4c446d70436169496d716b49496e39764b386d6d4a386b674f61663439754c63437135357131655843613766504f31554c6d45674e616647336931\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmpCaiImqkIIn9vK8mmJ8kgOaf49uLcCq55q1eXCa7fPO1ULmEgNafG3i1?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ab24c0e838c3bce81a437211d151a8d4\" alt=\"BlockState\" data-canonical-src=\"http://www.plantuml.com/plantuml/png/SoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmpCaiImqkIIn9vK8mmJ8kgOaf49uLcCq55q1eXCa7fPO1ULmEgNafG3i1\" srcset=\"https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FSoWkIImgAStDuSh8J4bLICqjAAbKI4ajJYxAB2Z9pC_ZYjQALT3LjLDmpCaiImqkIIn9vK8mmJ8kgOaf49uLcCq55q1eXCa7fPO1ULmEgNafG3i1?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=baec0c7637edcfdc3da4d4b780475fcb 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nでは、この構造をソースコードに落とし込んでいきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBlock.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eBlock\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 状態イベントの定義\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDead\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRevive\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 現在の状態が生存状態なら生存していることを返すプロパティ\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eIsAlive\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsCurrentState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAliveState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBlock\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAwake\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBlock\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAliveState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eDeadState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDead\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDeadState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eAliveState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRevive\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSetStartState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAliveState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eOnCollisionEnter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCollision\u003c/span\u003e \u003cspan class=\"n\"\u003ecollision\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 衝突した相手がボールなら\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecollision\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egameObject\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Ball\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 死亡イベントを送る\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDead\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRevive\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンに復活イベントを送る\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRevive\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAliveState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBlock\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 中略...\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eDeadState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBlock\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 中略...\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"シーンクラスを書く\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B7%E3%83%BC%E3%83%B3%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%9B%B8%E3%81%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eシーンクラスを書く\u003c/h3\u003e\n\n\u003cp\u003e次にゲームの流れをコントロールするシーンのクラスを作ってみましょう。\u003cbr\u003e\nシーンが起こりうる状態は次の構造になりますね。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/b9f953e5ad73c7d57fd03c08ab8a770f561b6568/687474703a2f2f7777772e706c616e74756d6c2e636f6d2f706c616e74756d6c2f706e672f565033313269386d34344a6c2d6e4b76325f71313372384c7a494841464f673773326e735150674d50314e707a74514c4b3568484976584374594a506f474468705f563647614b36354a4f5448734b6d62397577666a5231554e50484d5250473147526134736a3636454a78663556454e4546376341696a4547654c5a3570315a625037536855346f485036646131783259344865682d39644d766d524c37785832736a4e54637368466b62485755492d6c6374306a64373249384e375878653478447634694675624b61316d7630662d765f417150632d75485330\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FVP312i8m44Jl-nKv2_q13r8LzIHAFOg7s2nsQPgMP1NpztQLK5hHIvXCtYJPoGDhp_V6GaK65JOTHsKmb9uwfjR1UNPHMRPG1GRa4sj66EJxf5VENEF7cAijEGeLZ5p1ZbP7ShU4oHP6da1x2Y4Heh-9dMvmRL7xX2sjNTcshFkbHWUI-lct0jd72I8N7Xxe4xDv4iFubKa1mv0f-v_AqPc-uHS0?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7e30051dba18e26e034da89378a852cf\" alt=\"SceneState\" data-canonical-src=\"http://www.plantuml.com/plantuml/png/VP312i8m44Jl-nKv2_q13r8LzIHAFOg7s2nsQPgMP1NpztQLK5hHIvXCtYJPoGDhp_V6GaK65JOTHsKmb9uwfjR1UNPHMRPG1GRa4sj66EJxf5VENEF7cAijEGeLZ5p1ZbP7ShU4oHP6da1x2Y4Heh-9dMvmRL7xX2sjNTcshFkbHWUI-lct0jd72I8N7Xxe4xDv4iFubKa1mv0f-v_AqPc-uHS0\" srcset=\"https://qiita-user-contents.imgix.net/http%3A%2F%2Fwww.plantuml.com%2Fplantuml%2Fpng%2FVP312i8m44Jl-nKv2_q13r8LzIHAFOg7s2nsQPgMP1NpztQLK5hHIvXCtYJPoGDhp_V6GaK65JOTHsKmb9uwfjR1UNPHMRPG1GRa4sj66EJxf5VENEF7cAijEGeLZ5p1ZbP7ShU4oHP6da1x2Y4Heh-9dMvmRL7xX2sjNTcshFkbHWUI-lct0jd72I8N7Xxe4xDv4iFubKa1mv0f-v_AqPc-uHS0?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a9110272ef85ee047eeec74390fba191 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nでは、この構造をソースコードに落とし込んでいきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMainGameScene.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eIceMilkTea.Core\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMainGameScene\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ステートマシンのイベントID列挙型\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ePlay\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eMiss\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRetry\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eExit\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eAllBlockBloken\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 中略...\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// ステートマシン変数の定義、もちろんコンテキストは MainGameScene クラス\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMainGameScene\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003emissCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// コンポーネントの初期化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAwake\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンの遷移テーブルを構築（コンテキストのインスタンスはもちろん自分自身）\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMainGameScene\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eResetState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStandbyState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eStandbyState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePlayingState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlay\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayingState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMissState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMiss\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePlayingState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eGameClearState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAllBlockBloken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMissState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eStandbyState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRetry\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMissState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eGameOverState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eExit\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGameClearState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eResetState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddTransition\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGameOverState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eResetState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\n        \u003cspan class=\"c1\"\u003e// 起動状態はReset\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSetStartState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eResetState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンを起動\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンの更新\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMissSignal\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// ステートマシンにミスイベントを送る\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMiss\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eResetState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMainGameScene\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eblocks\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRevive\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eplayer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTransform\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eplayerStartTransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eplayer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDisableMove\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eball\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTransform\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eballStartTransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eball\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRigidbody\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003evelocity\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ezero\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eStandbyState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMainGameScene\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetKeyDown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyCode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSpace\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePlay\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePlayingState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMainGameScene\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003exDirection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRandom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(-\u003c/span\u003e\u003cspan class=\"m\"\u003e1.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ezDirection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRandom\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0.5f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eball\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRigidbody\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003evelocity\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003exDirection\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ezDirection\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003enormalized\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eballSpeed\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eplayer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnableMove\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eblockAllDead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eblocks\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsAlive\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eblockAllDead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eblockAllDead\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAllBlockBloken\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eMissState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMainGameScene\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eplayer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDisableMove\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eball\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTransform\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eballStartTransform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eball\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRigidbody\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;().\u003c/span\u003e\u003cspan class=\"n\"\u003evelocity\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ezero\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emissCount\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emissCount\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eavailablePlayCount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eExit\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRetry\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGameClearState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMainGameScene\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"GameClear!!!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eGameOverState\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eImtStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMainGameScene\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprotected\u003c/span\u003e \u003cspan class=\"k\"\u003eoverride\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDebug\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"GameOver...\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eStateMachine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSendEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eStateEventId\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFinish\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"完成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%8C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e完成\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/e24f19ea725691344301ff9550c0fa3da141179b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3332383936372f31636432323862662d353538622d656330632d353439382d3532333965663963386134622e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-image-store.s3.amazonaws.com/0/328967/1cd228bf-558b-ec0c-5498-5239ef9c8a4b.gif\" alt=\"完成映像.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/328967/1cd228bf-558b-ec0c-5498-5239ef9c8a4b.gif\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n完成しました。\u003c/p\u003e\n\n\u003cp\u003e完成プロジェクトに関しては、GitHubにて公開しました。\u003cbr\u003e\n\u003ca href=\"https://github.com/BelColo/ImtStateMachineUseSample\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/BelColo/ImtStateMachineUseSample\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e当初より予定していた、記事の長さを遥かに超える事になってしまいましたが、いかがでしたでしょうか。\u003cbr\u003e\nサンプルコードはパフォーマンスや実装方法について、ステートマシンの動かし方を重点的に説明するため、犠牲になっていますが、それでもステートマシンを使ったことによって遥かに実装が楽になっていることがわかるはずです。\u003c/p\u003e\n\n\u003cp\u003e今回使ったImtStateMachineは、Unityだけに留まらず\u003cstrong\u003eサーバーサイドのプログラムにも使われており、実際使わせてもらっています\u003c/strong\u003e。\u003cbr\u003e\nImtStateMachineが流行ることを願いつつ今回は、これでしめさせて頂きます。\u003c/p\u003e\n\n\u003cp\u003eImtStateMachineを使ったテクニック集などもいつの日か、書ける日が来たら書こうと思います。\u003c/p\u003e\n","createdAt":"2018-12-23T09:18:18Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"RFn/H8IA2ES+tvBwZ0gD37eTRKAHpqNh--NGhdI2iNAN+RbgJr--xUhiBD7BzW9cfYrkJOgiEw==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-02-09T07:20:19Z","likesCount":96,"linkUrl":"https://qiita.com/BelColo/items/a94c9ccc2d5174dc29a3","organization":null,"originalId":748265,"stockedCount":84,"title":"ステートマシン実装の決定版ImtStateMachineについて語り尽くす","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8A%A0%E7%AD%86-or-%E4%BF%AE%E6%AD%A3\"\u003e加筆 or 修正\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%89%8D%E7%BD%AE%E3%81%8D\"\u003e前置き\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#unity%E3%81%A7%E7%8A%B6%E6%85%8B%E5%88%B6%E5%BE%A1%E3%81%A8%E3%81%84%E3%81%88%E3%81%B0\"\u003eUnityで状態制御といえば\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%A8%E3%81%AF%E5%B0%91%E3%81%97%E9%81%95%E3%81%84%E3%81%BE%E3%81%99%E3%81%8C\"\u003eステートマシンとは少し違いますが\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%93%E3%82%8C%E3%81%A0%E3%81%91%E3%81%AE%E3%82%AA%E3%82%B9%E3%82%B9%E3%83%A1%E3%81%AE%E3%82%A2%E3%82%BB%E3%83%83%E3%83%88%E3%81%8C%E3%81%82%E3%82%8B%E3%81%AE%E3%81%AB%E4%BD%95%E6%95%85-imtstatemachine\"\u003eこれだけのオススメのアセットがあるのに何故 ImtStateMachine？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%B3%E3%83%BC%E3%83%89%E3%82%82unity%E5%81%B4%E5%AE%9F%E8%A3%85%E3%81%A8%E5%90%8C%E3%81%98%E3%82%88%E3%81%86%E3%81%AB%E3%81%8B%E3%81%A4%E3%83%8F%E3%82%A4%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%81%A7%E4%BD%BF%E3%81%84%E3%81%9F%E3%81%84\"\u003eサーバーコードも、Unity側実装と同じようにかつハイパフォーマンスで使いたい！\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#imtstatemachine-%E3%81%AE%E7%89%B9%E5%BE%B4\"\u003eImtStateMachine の特徴\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A4%A7%E3%81%BE%E3%81%8B%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9\"\u003e大まかな使い方\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%8A%B6%E6%85%8B%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9\"\u003e状態の書き方\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%8A%B6%E6%85%8B%E9%81%B7%E7%A7%BB%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9\"\u003e状態遷移テーブルの作り方\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%AE%E6%9B%B4%E6%96%B0%E3%83%AB%E3%83%BC%E3%83%97\"\u003eステートマシンの更新ループ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%9E%E3%82%B7%E3%83%B3%E3%81%B8%E3%81%AE%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E5%85%A5%E5%8A%9B\"\u003eステートマシンへのイベント入力\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A9%A6%E3%81%97%E3%81%AB%E4%BD%BF%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e試しに使ってみる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%96%B0%E8%A6%8Funity%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88\"\u003e新規Unityプロジェクトを作ってソースコードをインポート\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%89%A9%E7%90%86%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%81%AE%E3%83%90%E3%82%A6%E3%83%B3%E3%83%89%E9%96%BE%E5%80%A4%E3%82%92%E8%AA%BF%E6%95%B4\"\u003e物理エンジンのバウンド閾値を調整\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8%E3%82%92%E3%83%91%E3%83%91%E3%83%91%E3%81%A3%E3%81%A8%E4%BD%9C%E3%82%8B\"\u003eステージをパパパっと作る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%97%E3%83%AC%E3%82%A4%E3%83%A4%E3%83%BC%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%9B%B8%E3%81%8F\"\u003eプレイヤークラスを書く\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%9B%B8%E3%81%8F\"\u003eブロッククラスを書く\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B7%E3%83%BC%E3%83%B3%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%92%E6%9B%B8%E3%81%8F\"\u003eシーンクラスを書く\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%8C%E6%88%90\"\u003e完成\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":18792,"uuid":"a94c9ccc2d5174dc29a3","banReason":null,"adventCalendarItem":{"day":24,"calendar":{"name":"gumi Inc.","urlName":"gumi","year":2018,"organization":{"logoUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/af10c3d31812a4bdbb2e57f74eb23904073018e5/original.jpg?1557194992","urlName":"gumi"}}},"author":{"encryptedId":"s5kCFohnj9+RxTUl/ycZfmUXsZBb--ELS/0IyWPfFWCOtF--sSB4D526Ke2aF1tpRXDZdw==","originalId":328967,"description":"某お艦ゲーを愛してやまないマン","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/328967/profile-images/1545271010","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2Fprofile-images%2F1545271010?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=8e999e7d09ff3e8920d791cd6f767cc0","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F328967%2Fprofile-images%2F1545271010?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=0cd3450fa2c72ce332697f9ad4e6970a","urlName":"BelColo","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[{"node":{"encryptedId":"4Hu/e5XNQupWYPjvBsmNpQErYPpBBTOB9w==--Ja6bmQftvYZOX4QI--g5VVJ6r8UPJ0DjzDCeTBrw==","isBetaReleaseEnabled":false,"isFollowableByViewer":false,"isFollowedByViewer":false,"name":"株式会社 gumi","logoUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-organization-image/af10c3d31812a4bdbb2e57f74eb23904073018e5/original.jpg?1557194992","urlName":"gumi","description":"Python、Erlang、Elixir などちょっと変わった技術でゲームをつくったりする会社。プログラマだけじゃなく、企画、デザイン、イラストなど開発全般揃ってます。","url":"http://gu3.co.jp"}}]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"game","urlName":"game"},{"name":"Unity","urlName":"unity"},{"name":"statemachine","urlName":"statemachine"},{"name":"IceMilkTea","urlName":"icemilktea"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
