<!DOCTYPE html><html><head><meta charset="utf-8" /><title>ILの暗黒の魔術　第２章「Unity反撃！●された静的委譲！」 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/pCYSl5EDgo/items/4a5cc446553f4d99a7f3" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="3CKvyeSbTEZQeL2qwOWEbhigLcNN/uCtBe7BT1dIOnfPif4x/d72ATG8ymaxuQfcb/C5ss2S9+zZ39cExzXP5Q==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@pCYSl5EDgo" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="ILの暗黒の魔術　第２章「Unity反撃！●された静的委譲！」 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1TVXpqZ2E3bW1wZnB1NUxqZ2E3cHJaVG9vWlBqZ0lEbnJLenZ2SkxucTZEamdJeFZibWwwZWVXUGplYVNnLS04Z2VLWGotT0JsZU9Dak9PQm4tbWRtZWVhaE9XbmxPaXRzdS04Z2VPQWpRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTJhOWJhMDYyMjdhY2Q2NzkwYzYzM2I1ZDI0ZWI5ZjRh&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSEJEV1ZOc05VVkVaMjgmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz01YmYwNDcwNjQ5YzY4NDM0OWU3ZDUxNDM3ODg5MWUzNQ&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=76b757bdbc4355d4c8fec32836417ea6"><meta property="og:description" content="初投稿です（大嘘）。

ufcppによるとマルチキャストが不要な静的メソッドに対してデリゲート的なことをしようとする場合デリゲートはオーバースペックなのですね。
ですがシングルキャストなデリゲートはC#ではサポートされていません。
メ..."><meta content="https://qiita.com/pCYSl5EDgo/items/4a5cc446553f4d99a7f3" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity,IL,DynamicMethod" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-175ecc5d-a3c8-4c5f-bba6-eae7aec9d345"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2FpCYSl5EDgo%2Fitems%2F4a5cc446553f4d99a7f3">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2FpCYSl5EDgo%2Fitems%2F4a5cc446553f4d99a7f3">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-175ecc5d-a3c8-4c5f-bba6-eae7aec9d345">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-01-25T18:08:28.000+09:00","dateModified":"2019-01-25T18:08:28.000+09:00","headline":"ILの暗黒の魔術　第２章「Unity反撃！●された静的委譲！」","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1TVXpqZ2E3bW1wZnB1NUxqZ2E3cHJaVG9vWlBqZ0lEbnJLenZ2SkxucTZEamdJeFZibWwwZWVXUGplYVNnLS04Z2VLWGotT0JsZU9Dak9PQm4tbWRtZWVhaE9XbmxPaXRzdS04Z2VPQWpRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTJhOWJhMDYyMjdhY2Q2NzkwYzYzM2I1ZDI0ZWI5ZjRh\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSEJEV1ZOc05VVkVaMjgmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz01YmYwNDcwNjQ5YzY4NDM0OWU3ZDUxNDM3ODg5MWUzNQ\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=76b757bdbc4355d4c8fec32836417ea6","mainEntityOfPage":"https://qiita.com/pCYSl5EDgo/items/4a5cc446553f4d99a7f3","author":{"@type":"Person","address":"","email":"pcysl5edgo@yahoo.co.jp","identifier":"pCYSl5EDgo","name":"pCYSl5EDgo","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F256047%2Fprofile-images%2F1546351264?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=c5789bc76dd49b92c1ddc68bc158b06b","url":"https://qiita.com/pCYSl5EDgo","description":"C#!好き!!（語彙不足）\r\nUnityやヴァーレントゥーガ関連の投稿をしていく予定です。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"pCYSl5EDgo","type":"items","id":"4a5cc446553f4d99a7f3"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"pCYSl5EDgo","type":"items","id":"4a5cc446553f4d99a7f3"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"pCYSl5EDgo","type":"items","id":"4a5cc446553f4d99a7f3"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/pCYSl5EDgo/items/4a5cc446553f4d99a7f3","location":"/pCYSl5EDgo/items/4a5cc446553f4d99a7f3","scheme":"https","host":"qiita.com","port":null,"pathname":"/pCYSl5EDgo/items/4a5cc446553f4d99a7f3","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"sCftuGKoXWtWwzTF/D++MeLIcr7rlS+e6eMDAHNrVA2jjLxAe+3nLDcHQwmNYz2DlZjmz2v5ON810hVL4xahnw==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-17669bc4-ed17-4fd5-adfd-24401cdf5613"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3/likers" class="css-1iupg5d">24</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">23</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/4a5cc446553f4d99a7f3/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/pCYSl5EDgo"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/256047/profile-images/1546351264" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/pCYSl5EDgo" class="css-10ougpm">@<!-- -->pCYSl5EDgo</a><div class="css-1ay9vb9"><time dateTime="2019-01-25T09:08:28Z" class="css-m19uds">posted at 2019-01-25</time></div></div></div></div></div><h1 class="css-cgzq40">ILの暗黒の魔術　第２章「Unity反撃！●された静的委譲！」</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a><a href="/tags/il" class="css-4czcte">IL</a><a href="/tags/dynamicmethod" class="css-4czcte">DynamicMethod</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>初投稿です（大嘘）。</p>

<p><a href="https://ufcpp.net/blog/2018/8/pickuproslyn0822/" rel="nofollow noopener" target="_blank">ufcpp</a>によるとマルチキャストが不要な静的メソッドに対してデリゲート的なことをしようとする場合デリゲートはオーバースペックなのですね。<br>
ですがシングルキャストなデリゲートはC#ではサポートされていません。<br>
メソッドから関数ポインタを取得するldftn命令を直接出力したり、関数ポインタをメソッドとして使用するcalli命令を直接出力したりできないからです。</p>

<p><em>C#でできないことだってできる。そう、ILならね。</em>　という感じでILを使用してシングルキャスト静的デリゲートを扱えるようにしてみました。</p>

<h1>
<span id="第0節im-il-nichts-neuesil戦線異状なし" class="fragment"></span><a href="#%E7%AC%AC0%E7%AF%80im-il-nichts-neuesil%E6%88%A6%E7%B7%9A%E7%95%B0%E7%8A%B6%E3%81%AA%E3%81%97"><i class="fa fa-link"></i></a>第0節　Im IL nichts Neues/IL戦線異状なし</h1>

<p>C#はRoslynコンパイラによってコンパイルされると中間言語（Intermediate Language）にコンパイルされてDLLやEXEファイルになります。<br>
ILは実行環境でJITコンパイルされて機械語に翻訳されて実行されます。</p>

<p>C:\Windows\Microsoft.Net\Framework64\v4.0.30319\ilasm.exeをコマンドラインから使用して.ilファイルをコンパイルすると.dllファイルを作ることが可能です。<br>
この時に.projファイルは不要です。</p>

<p>ILの書き方は<a href="https://www.linqpad.net/download.aspx" rel="nofollow noopener" target="_blank">LINQPad5</a>と<a href="https://github.com/icsharpcode/ILSpy/releases" rel="nofollow noopener" target="_blank">ILSpy</a>を使用して学ぶのが最適でしょう。<br>
学び方は <a href="/neuecc" class="user-mention js-hovercard" title="neuecc" data-hovercard-target-type="user" data-hovercard-target-name="neuecc">@neuecc</a> さんの<a href="http://neue.cc/2017/12/04_560.html" rel="nofollow noopener" target="_blank">記事</a>を参考にされると良いでしょう。<br>
なお、calliとldftnは殆どIL中にも出てこない命令ですので上記ソフトで使用法を学習できませんでした。</p>

<h1>
<span id="第1節anders-got-his-documentアンダァスは仕様書を読んだ" class="fragment"></span><a href="#%E7%AC%AC1%E7%AF%80anders-got-his-document%E3%82%A2%E3%83%B3%E3%83%80%E3%82%A1%E3%82%B9%E3%81%AF%E4%BB%95%E6%A7%98%E6%9B%B8%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A0"><i class="fa fa-link"></i></a>第1節　Anders Got His Document/アンダァスは仕様書を読んだ</h1>

<p><a href="https://www.ecma-international.org/publications/standards/Ecma-335.htm" rel="nofollow noopener" target="_blank">ILについてのECMAの仕様書</a>を読んでldftnとcalliについての概略を把握しました。　calliについて検索すると「calling」というワードも引っかかるのが面倒でしたね。</p>

<h2>
<span id="calliについての仕様書の記述" class="fragment"></span><a href="#calli%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E4%BB%95%E6%A7%98%E6%9B%B8%E3%81%AE%E8%A8%98%E8%BF%B0"><i class="fa fa-link"></i></a>calliについての仕様書の記述</h2>

<table>
<thead>
<tr>
<th style="text-align: center">Format</th>
<th style="text-align: center">Assembly Format</th>
<th style="text-align: center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">29 </td>
<td style="text-align: center">calli callsitedescr</td>
<td style="text-align: center">Call method indicated on the stack with arguments described by callsitedescr.</td>
</tr>
</tbody>
</table>

<blockquote>
<p>Stack Transition:<br>
…, arg0, arg1 … argN, ftn → …, retVal (not always returned)</p>

<p>Description:<br>
The calli instruction calls ftn (a pointer to a method entry point) with the arguments arg0 … argN.<br>
The types of these arguments are described by the signature callsitedescr. (See Partition I for a description of the CIL calling sequence.) The calli instruction can be immediately preceded by a tail. prefix to specify that the current method state should be released before transferring control. If the call would transfer control to a method of higher trust than the originating method the stack frame will not be released; instead, the execution will continue silently as if the tail. prefix had not been supplied.<br>
[A callee of “higher trust” is defined as one whose permission grant-set is a strict superset of the grant-set of the caller.]<br>
The ftn argument must be a method pointer to a method that can be legitimately called with the arguments described by callsitedescr (a metadata token for a stand-alone signature). Such a pointer can be created using the ldftn or ldvirtftn instructions, or could have been passed in from native code.<br>
The standalone signature specifies the number and type of parameters being passed, as well as the calling convention (See Partition II). The calling convention is not checked dynamically, so code that uses a calli instruction will not work correctly if the destination does not actually use the specified calling convention.<br>
The arguments are placed on the stack in left-to-right order. That is, the first argument is computed and placed on the stack, then the second argument, and so on. The argument-building code sequence for an instance or virtual method shall push that instance reference (the this pointer, which shall not be null) first. [Note: for calls to methods on value types, the this pointer is a managed pointer, not an instance reference. §I.8.6.1.5. end note]<br>
The arguments are passed as though by implicit starg (§III.3.61) instructions, see Implicit argument coercion §III.1.6.<br>
calli pops the this pointer, if any, and the arguments off the evaluation stack before calling the method. If the method has a return value, it is pushed on the stack upon method completion. On the callee side, the arg0 parameter/this pointer is accessed as argument 0, arg1 as argument 1, and so on. </p>
</blockquote>

<p>自家翻訳</p>

<blockquote>
<p>calli命令はarg0からargNの与えられた引数を用いてftn（メソッドエントリポイントを指す関数ポインタ）の位置にあるメソッドを実行する。<br>
引数の型はシグネチャcallsitedescrによって示される。（CILのcalling sequenceの説明については第一編を見よ。）<br>
このcalli命令によって使用される関数ポインタはldftnあるいはldvirtftn命令で得られるか、あるいはネイティブコードから受け渡される。<br>
Standaloneシグネチャは渡される引数の個数と型とともに呼び出し規約（第二編を見よ）を詳らかにする。呼び出し規約は動的（実行時）には検証されないため、呼び出し先の関数の呼び出し規約が記述されたそれでない場合、正しく動作しない。<br>
引数は左から右順でスタック上に積まれる。これは、第一引数が先に計算されてスタックに積まれ、次に第二引数という風に続くということである。インスタンスメソッドあるいは仮想メソッドのための引数にバインドされるコード列ならばインスタンスへの参照(this参照のことであり、nullを許容しない)を第零引数として置く。＊注：値型のインスタンスメソッドの場合はthisはマネージドポインタであり、インスタンスへの参照ではない。<br>
引数は暗黙的に使用されるstarg命令によってメソッドに渡される。<br>
calliは関数ポインタをpopし、もし引数があるのであれば、関数を呼び出す前に評価スタックから引数をpopする。もしメソッドが戻り値を返すのであればメソッド完了時に戻り値がスタック上にpushされる。呼び出される側において、第零引数はargument 0、第一引数はargument 1という風にして使用可能である。</p>
</blockquote>

<p>callsitedescrをどう書けばいいのかわかりませんね。</p>

<h2>
<span id="ldftnについての仕様書の記述" class="fragment"></span><a href="#ldftn%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E4%BB%95%E6%A7%98%E6%9B%B8%E3%81%AE%E8%A8%98%E8%BF%B0"><i class="fa fa-link"></i></a>ldftnについての仕様書の記述</h2>

<table>
<thead>
<tr>
<th style="text-align: center">Format</th>
<th style="text-align: center">Assembly Format</th>
<th style="text-align: center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">FE 06 </td>
<td style="text-align: center">ldftn method</td>
<td style="text-align: center">Push a pointer to a method referenced by method, on the stack.</td>
</tr>
</tbody>
</table>

<blockquote>
<p>Stack Transition:<br>
… → …, ftn</p>

<p>Description:<br>
The ldftn instruction pushes a method pointer (§II.14.5) to the native code implementing the method described by method (a metadata token, either a methoddef or methodref (see Partition II)), or to some other implementation-specific description of method (see Note) onto the stack).<br>
The value pushed can be called using the calli instruction if it references a managed method (or a stub that transitions from managed to unmanaged code). It may also be used to construct a delegate, stored in a variable, etc.<br>
The CLI resolves the method pointer according to the rules specified in §I.12.4.1.3 (Computed destinations), except that the destination is computed with respect to the class specified by method.<br>
The value returned points to native code (see Note) using the calling convention specified by method. Thus a method pointer can be passed to unmanaged native code (e.g., as a callback routine).<br>
Note that the address computed by this instruction can be to a thunk produced specially for this purpose (for example, to re-enter the CIL interpreter when a native version of the method isn’t available).<br>
[Note: There are many options for implementing this instruction. Conceptually, this instruction places on the virtual machine’s evaluation stack a representation of the address of the method specified. In terms of native code this can be an address (as specified), a data structure that contains the address, or any value that can be used to compute the address, depending on the architecture of the underlying machine, the native calling conventions, and the implementation technology of the VES (JIT, interpreter, threaded code, etc.). end note] </p>
</blockquote>

<p>自家翻訳</p>

<blockquote>
<p>ldftn命令はmethoddefあるいはmethodref(第二編を見よ)なメタデータトークンによって記述された、メソッド実行部分のネイティブコードへの関数ポインタをpushする。<br>
スタック上にpushされた値は、もしその値がマネージドコードを参照（あるいはマネージド領域からアンマネージ領域へ移行するためのスタブ）ならばcalli命令によって使用されうる。<br>
この値は変数に格納されたり、あるいはデリゲートを作成したり、その他なにかに使用される可能性もあるかもしれない（低い）。<br>
CLIはメソッドで指定されたクラスに関して計算されたdestinationを除いて、第一編十二章四節一項三款に詳述された規則に従い関数ポインタを解決する。<br>
戻り値の値はメソッドに指定された呼び出し規約を使用するネイティブコードを指す。これ故に関数ポインタはアンマネージドネイティブコードに渡されうる。（例：コールバックルーチン）<br>
注意すべきことに、この命令によって算出されたアドレスはこの目的のために特別に用意されたthunkでありうる。たとえばネイティブ版のメソッドをCILインタプリタに再代入することは不可能である。<br>
＊注：この命令の実装方法は多岐にわたる。概念的には、この命令は仮想マシンの評価スタックに特定メソッドのアドレスを表すものをpushする。ネイティブコードならばそれはアドレスや、アドレスを含む構造体、あるいはアドレスを算出しうるなんらかの値であり、具体的には基底に存在する現実の計算機の構造、ネイティブの呼び出し規約、VESの実装に依存する。</p>
</blockquote>

<h1>
<span id="第2節wikiapocalypse-nowウィキペディアの黙示録" class="fragment"></span><a href="#%E7%AC%AC2%E7%AF%80wikiapocalypse-now%E3%82%A6%E3%82%A3%E3%82%AD%E3%83%9A%E3%83%87%E3%82%A3%E3%82%A2%E3%81%AE%E9%BB%99%E7%A4%BA%E9%8C%B2"><i class="fa fa-link"></i></a>第2節　Wikiapocalypse Now/ウィキペディアの黙示録</h1>

<p>calliの使用例を見ないと書きようがないとわかった私は試しにwikipedia英語版を開いてみました。<br>
<a href="https://en.wikipedia.org/wiki/Common_Intermediate_Language#Pointer_instructions_-_C++/CLI" rel="nofollow noopener" target="_blank">使用例</a>がありました（完全勝利した淫夢くんUC）。<br>
サンプルコードについては上記リンク先を参照してみてください。</p>

<p>結論から書きますが上記サンプルは私を激しく混乱させるだけに終わりました。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>IL_001d:   calli      unmanaged stdcall void modopt([mscorlib]System.Runtime.CompilerServices.CallConvStdcall)(native int)
</code></pre></div></div>

<p>このコード片のIL_0001d:はラベルです。ハイ、C#ではswitch文のcaseで使用されるラベルです。あるいはgoto文の行き先を意味するラベルです。<br>
LINQPadでC#をILに変換し、それをさらにILSpyで完全版を確認すると必ず全IL命令のある行にIL_00xx:みたいな表記をされているのでCOBOLとかのように必須だと思い込んでいました。<br>
<em>別になくてもいいのです。</em><br>
<strong>別になくてもいいのです（強調）。</strong></p>

<p>さらに上記サンプルはC++/CLIでネイティブコードを表現するためのものでしてね……</p>

<h1>
<span id="第3節lightning-strike-document-re-launch雷撃仕様書再出動" class="fragment"></span><a href="#%E7%AC%AC3%E7%AF%80lightning-strike-document-re-launch%E9%9B%B7%E6%92%83%E4%BB%95%E6%A7%98%E6%9B%B8%E5%86%8D%E5%87%BA%E5%8B%95"><i class="fa fa-link"></i></a>第3節　Lightning Strike Document re-Launch/雷撃仕様書再出動</h1>

<p>やはり基本となるべきものは仕様書です。基本に立ち返ってサンプルを探しましょう。<br>
197ページからのサンプルが完全に正しかったです。<br>
なぜ、最初見落としていたのかですって？<br>
無視していました。IL_00xx:のようなラベルがないのでこれは実際には動かない擬似コードだろうと思いこんでいました。<br>
LINQPad5のILデコンパイルで表示されるILは厳密には擬似コードなので、そう思い込んでしまいました。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>.assembly Test { }
.assembly extern mscorlib { }
.method public static int32 AddOne(int32 Input)
{
 .maxstack 5
 ldarg Input
 ldc.i4.1
 add
 ret
}
.method public static int32 Negate(int32 Input)
{
 .maxstack 5
 ldarg Input
 neg
 ret
}
.class value sealed public MakeDecision extends [mscorlib]System.ValueType
{
 .field static bool Oscillate
 .method public static method int32 *(int32) Decide()
 {
   ldsfld bool valuetype MakeDecision::Oscillate
   dup
   not
   stsfld bool valuetype MakeDecision::Oscillate
   brfalse NegateIt
   ldftn int32 AddOne(int32)
   ret
  NegateIt:
   ldftn int32 Negate(int32)
   ret
 }
}
.method public static void Start()
{
 .maxstack 2
 .entrypoint
 ldc.i4.1
 call method int32 *(int32) valuetype MakeDecision::Decide()
 calli int32(int32)
 call void [mscorlib]System.Console::WriteLine(int32)
 ldc.i4.1
 call method int32 *(int32) valuetype MakeDecision::Decide()
 calli int32(int32)
 call void [mscorlib]System.Console::WriteLine(int32)
 ldc.i4.1
 call method int32 *(int32) valuetype MakeDecision::Decide()
 calli int32(int32)
 call void [mscorlib]System.Console::WriteLine(int32)
 ret
}
</code></pre></div></div>

<p>ILを全て書く場合、そのDLLが所属するアセンブリ名をファイルの先頭に.assembly <em>アセンブリ名</em>と書きます。<br>
そしてこのILが参照する全てのDLLというかアセンブリの名前を.assembly extern <em>参照アセンブリ名</em>として記述します。<br>
mscorlibに基本的なAPIが集約されています。</p>

<h2>
<span id="addone-negate解説" class="fragment"></span><a href="#addone-negate%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>AddOne, Negate解説</h2>

<p>AddOneとNegateはC#で表記すると以下のようになります。萌ポイントとしてはneg命令によって正負反転が一命令で実現されていることですね。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>public static int AddOne(int Input) =&gt; Input + 1;
public static int Negate(int Input) =&gt; -Input;
</code></pre></div></div>

<h2>
<span id="makedecision構造体解説" class="fragment"></span><a href="#makedecision%E6%A7%8B%E9%80%A0%E4%BD%93%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>MakeDecision構造体解説</h2>

<p>MakeDecisionは構造体です。.class value sealedと extends [mscorlib]System.ValueTypeによってそう指定されています。<br>
.field static bool Oscillateはprivateなbool型のstaticフィールドの定義です。<br>
C#では同一文で複数のフィールドを定義できますが、ILでは１文につき１フィールド定義します。<br>
MakeDecision.DecideについてC#で擬似コードを書いてみましょう。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="nf">Decide</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">Oscillate</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Oscillate</span> <span class="p">!=</span> <span class="n">Oscillate</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">AddOne</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">Oscillate</span> <span class="p">!=</span> <span class="n">Oscillate</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">Negate</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>初出命令の解説</p>

<ul>
<li>dup

<ul>
<li>スタックの一番上にある値を複製してpush</li>
</ul>
</li>
<li>ldsfld/stsfld

<ul>
<li>静的フィールドをスタック上にloadあるいはスタック上から格納(store)</li>
</ul>
</li>
<li>brfalse

<ul>
<li>スタックの一番上の値をpopして評価し、falseならばラベル位置へ処理をgoto</li>
</ul>
</li>
</ul>

<p>最適化されたILコードを見ると結構な頻度でローカル変数が消滅したりします。具体的には一つのインスタンスを連続で使い倒す場合ですね。この場合必要数だけ最初にdupしまくることでローカル変数を省いています。IL書くようになるとdupを上手に使いたくなります。</p>

<p>ちなみにC#擬似コードで戻り値の型をFunc&lt;int, int&gt;と書いていますが、実際に戻っているのは関数ポインタです。</p>

<h2>
<span id="start解説" class="fragment"></span><a href="#start%E8%A7%A3%E8%AA%AC"><i class="fa fa-link"></i></a>Start解説</h2>

<p>疑似C#コードは以下の通りです。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
   <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">MakeDecision</span><span class="p">.</span><span class="nf">Decide</span><span class="p">()(</span><span class="m">1</span><span class="p">));</span> <span class="c1">// -1</span>
   <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">MakeDecision</span><span class="p">.</span><span class="nf">Decide</span><span class="p">()(</span><span class="m">1</span><span class="p">));</span> <span class="c1">//  2</span>
   <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">MakeDecision</span><span class="p">.</span><span class="nf">Decide</span><span class="p">()(</span><span class="m">1</span><span class="p">));</span> <span class="c1">// -1</span>
<span class="p">}</span>
</code></pre></div></div>

<p>試しにilasm.exeで動かせば動きました。<br>
いやぁ、ラベルって各行に必須なものではなかったのですね（遠い目）。</p>

<h1>
<span id="第4節happy-hanukkah-mr-albahari総称型のハッピーハヌカ" class="fragment"></span><a href="#%E7%AC%AC4%E7%AF%80happy-hanukkah-mr-albahari%E7%B7%8F%E7%A7%B0%E5%9E%8B%E3%81%AE%E3%83%8F%E3%83%83%E3%83%94%E3%83%BC%E3%83%8F%E3%83%8C%E3%82%AB"><i class="fa fa-link"></i></a>第4節　Happy Hanukkah, Mr. Albahari/総称型のハッピーハヌカ</h1>

<p>前節でcalliでCLIのマネージコードを呼び出す際の書式がわかりました。<br>
int32(int32)のように戻り値の型(引数の型, ...)ですね。</p>

<p>使い方がわかったとしてもライブラリにするためには総称型・ジェネリクスでないと使い勝手が悪いですよね。<br>
ジェネリクスに対応させましょう。<br>
ここでLINQPad5とILSpyに以下のコードをIL化してもらいます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Z</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">T</span> <span class="nf">A</span><span class="p">(</span><span class="k">this</span> <span class="n">T</span> <span class="n">obj0</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">obj0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>.class public auto ansi abstract sealed beforefieldinit Z extends [mscorlib]System.Object
{
    .method public hidebysig static !!T A&lt;T&gt;(!!T obj0) cil managed
    {
        .custom instance void [mscorlib]System.Runtime.CompilerServices.ExtensionAttribute::.ctor() = (01 00 00 00)
        .maxstack 1
        ldarg.0
        ret
    }
}
</code></pre></div></div>

<p>このILコードで注目していただきたいのは、メソッドシグネチャを定義している部分です。<br>
!!T A&lt;T&gt;(!!T obj0)と書いてありますよね。&lt;&gt;の間にジェネリクスの型パラメータの名前を書きます。<br>
そしてその型パラメータを他のコードで使用する場合、!!というprefixをつけます。<br>
簡単ですね！</p>

<p>ところで、C#のwhere以下に記述される型制約も&lt;&gt;の間に記述されることになります。<br>
この例としてはC# 7.3で導入された最高にクールなunmanaged制約がわかりやすいでしょう。<br>
T A&lt;T&gt;() where T : unmanagedは<br>
!!T A&lt;valuetype .ctor (class [mscorlib]System.ValueType modreq([mscorlib]System.Runtime.InteropServices.UnmanagedType)) T&gt;() cil managed<br>
となります。<br>
modereqとは呼び出し側が無視してはならない条件という意味合いですので、必須の型制約なのですね。</p>

<p>また、C#の拡張メソッドをILで記述するにはどうすればよいでしょうか？<br>
メソッドの最初の行とその静的クラスの最初の行に.custom instance void [mscorlib]System.Runtime.CompilerServices.ExtensionAttribute::.ctor() = (01 00 00 00)と記述するのです。<br>
そうすることでそのクラスとメソッドが拡張クラス・メソッドであると.NETに伝えられます。</p>

<h2>
<span id="ref引数及びref戻り値" class="fragment"></span><a href="#ref%E5%BC%95%E6%95%B0%E5%8F%8A%E3%81%B3ref%E6%88%BB%E3%82%8A%E5%80%A4"><i class="fa fa-link"></i></a>ref引数及びref戻り値</h2>

<p>型の後ろに&amp;とつけるだけで参照扱いされます。!!T&amp;のような感じです。</p>

<p>参照型と値型に対してそれぞれフィールド取得などで命令に細かい差異が生じますが、今回の記事ではその辺の知識は不要なので説明しません。<br>
学びたいのであればECMAの仕様書に当たると良いですよ。</p>

<h1>
<span id="第5節the-bridge-on-the-river-ldftn関数ポインタにかける橋" class="fragment"></span><a href="#%E7%AC%AC5%E7%AF%80the-bridge-on-the-river-ldftn%E9%96%A2%E6%95%B0%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%AB%E3%81%8B%E3%81%91%E3%82%8B%E6%A9%8B"><i class="fa fa-link"></i></a>第5節　The Bridge on The River Ldftn/関数ポインタにかける橋</h1>

<p>calliによって関数ポインタを駆動するための知識は前節までで得られました。</p>

<p>では、どうやって関数ポインタを得ましょうか？<br>
ldftnでは引数に関数の情報を取ります。これはコード中にべた書きする他ありません。<br>
ですが、ライブラリのユーザーはILではなく、C#を使う想定です。</p>

<p>悩んでいた所ちょうど良さそうな.NETのAPIが見つかりました。</p>

<h2>
<span id="systemruntimeinteropservicesmarshalgetfunctionpointerfordelegatesystemdelegate" class="fragment"></span><a href="#systemruntimeinteropservicesmarshalgetfunctionpointerfordelegatesystemdelegate"><i class="fa fa-link"></i></a>System.Runtime.InteropServices.Marshal.GetFunctionPointerForDelegate(System.Delegate)</h2>

<p>そのまんまな名前ですね。</p>

<p>私は喜び勇んでこのAPIを使用して得た関数ポインタをcalliに渡してみました。</p>

<p>「ガッシ！ボカッ！」<br>
.NET Coreは死んだ。スイーツ（笑）</p>

<p>.NET Coreの新たなクラッシュ方法を私は学びました。<br>
開発サイクルを高速に回すためにまず.NET Coreで動作をテストしています。Unityだとコンパイルと実行でそこそこ時間がかかりますからね。</p>

<h2>
<span id="il部dynamicmethodの裏技" class="fragment"></span><a href="#il%E9%83%A8dynamicmethod%E3%81%AE%E8%A3%8F%E6%8A%80"><i class="fa fa-link"></i></a>IL部・DynamicMethodの裏技</h2>

<p><a href="https://qiita.com/pCYSl5EDgo/items/2c2794efcf335c35cb19" id="reference-30b323fc9dce87e88853">前の章で解説したテクニックを使用します。</a><br>
具体的には.NET 4.xのmscorlibをILSpyで覗いてみればわかるのですが、System.Delegateクラスのprivateフィールドに2つIntPtr型があるのです。<br>
この2つ（_methodPtrと_methodPtrAux）のうちのどちらかがldftnで得られるメソッド本体を指す関数ポインタであると容易に想定されます。なぜ2つIntPtr型を用意しているのかよくわかりませんが。</p>

<p>これはC#で書ける内容ですので以下のように書いて、それをLINQPad5→ILSpyのコンボでIL化してilasm.exeでDLL化しました。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection.Emit</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">StaticDelegateHelper</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Delegate</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">&gt;</span> <span class="n">GetFuncPtr</span><span class="p">;</span>
    <span class="k">static</span> <span class="nf">StaticDelegateHelper</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">DynamicMethod</span> <span class="n">method</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynamicMethod</span><span class="p">(</span><span class="s">"GetFuncPtr"</span><span class="p">,</span> <span class="n">MethodAttributes</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">MethodAttributes</span><span class="p">.</span><span class="n">Static</span><span class="p">,</span> <span class="n">CallingConventions</span><span class="p">.</span><span class="n">Standard</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">),</span> <span class="k">new</span> <span class="n">Type</span><span class="p">[]</span> <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Delegate</span><span class="p">)</span> <span class="p">},</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Delegate</span><span class="p">),</span> <span class="k">true</span><span class="p">);</span>
        <span class="n">ILGenerator</span> <span class="n">ilgen</span> <span class="p">=</span> <span class="n">method</span><span class="p">.</span><span class="nf">GetILGenerator</span><span class="p">();</span>
        <span class="n">ilgen</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span> <span class="c1">// 第０引数について</span>
        <span class="n">ilgen</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldfld</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Delegate</span><span class="p">).</span><span class="nf">GetField</span><span class="p">(</span><span class="s">"_methodPtr"</span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">));</span>
        <span class="n">ilgen</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ret</span><span class="p">);</span> <span class="c1">// 戻り値とせよ</span>
        <span class="n">GetFuncPtr</span> <span class="p">=</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Delegate</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">&gt;)</span><span class="n">method</span><span class="p">.</span><span class="nf">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Delegate</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">&gt;));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これをIL化したコードを一応見てみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>.class nested public auto ansi abstract sealed StaticDelegateHelper extends [mscorlib]System.Object
{
  // Fields
  .field public static initonly class [mscorlib]System.Func`2&lt;class [mscorlib]System.Delegate, native int&gt; GetFuncPtr

  // Methods
  .method private hidebysig specialname rtspecialname static void .cctor () cil managed 
  {
    // Method begins at RVA 0x205c
    // Code size 139 (0x8b)
    .maxstack 8

    ldstr "GetFuncPtr"
    ldc.i4.s 22
    ldc.i4.1
    ldtoken [mscorlib]System.IntPtr
    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)
    ldc.i4.1
    newarr [mscorlib]System.Type
    dup
    ldc.i4.0
    ldtoken [mscorlib]System.Delegate
    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)
    stelem.ref
    ldtoken [mscorlib]System.Delegate
    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)
    ldc.i4.1
    newobj instance void [mscorlib]System.Reflection.Emit.DynamicMethod::.ctor(string, valuetype [mscorlib]System.Reflection.MethodAttributes, valuetype [mscorlib]System.Reflection.CallingConventions, class [mscorlib]System.Type, class [mscorlib]System.Type[], class [mscorlib]System.Type, bool)
    dup
    callvirt instance class [mscorlib]System.Reflection.Emit.ILGenerator [mscorlib]System.Reflection.Emit.DynamicMethod::GetILGenerator()
    dup
    ldsfld valuetype [mscorlib]System.Reflection.Emit.OpCode [mscorlib]System.Reflection.Emit.OpCodes::Ldarg_0
    callvirt instance void [mscorlib]System.Reflection.Emit.ILGenerator::Emit(valuetype [mscorlib]System.Reflection.Emit.OpCode)
    dup
    ldsfld valuetype [mscorlib]System.Reflection.Emit.OpCode [mscorlib]System.Reflection.Emit.OpCodes::Ldfld
    ldtoken [mscorlib]System.Delegate
    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)
    ldstr "_methodPtr"
    ldc.i4.s 36
    callvirt instance class [mscorlib]System.Reflection.FieldInfo [mscorlib]System.Type::GetField(string, valuetype [mscorlib]System.Reflection.BindingFlags)
    callvirt instance void [mscorlib]System.Reflection.Emit.ILGenerator::Emit(valuetype [mscorlib]System.Reflection.Emit.OpCode, class [mscorlib]System.Reflection.FieldInfo)
    ldsfld valuetype [mscorlib]System.Reflection.Emit.OpCode [mscorlib]System.Reflection.Emit.OpCodes::Ret
    callvirt instance void [mscorlib]System.Reflection.Emit.ILGenerator::Emit(valuetype [mscorlib]System.Reflection.Emit.OpCode)
    ldtoken class [mscorlib]System.Func`2&lt;class [mscorlib]System.Delegate, native int&gt;
    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)
    callvirt instance class [mscorlib]System.Delegate [mscorlib]System.Reflection.MethodInfo::CreateDelegate(class [mscorlib]System.Type)
    castclass class [mscorlib]System.Func`2&lt;class [mscorlib]System.Delegate, native int&gt;
    stsfld class [mscorlib]System.Func`2&lt;class [mscorlib]System.Delegate, native int&gt; StaticDelegateHelper::GetFuncPtr
    ret
  } // end of method StaticDelegateHelper::.cctor
} // end of class StaticDelegateHelper
</code></pre></div></div>

<p>メソッドの中身について語ることは特にないです。<br>
補足すべき点としては、readonlyはinitonlyと記述されます。<br>
そして静的コンストラクタは.method private hidebysig specialname rtspecialname static void .cctor () cil managedと書かれます。</p>

<p>_methodPtrで試したところ、.NET Coreがクラッシュしました。<br>
_methodPtrAuxで試したところ、動きました（完全勝利した淫夢くんUC）。</p>

<h2>
<span id="性能測定" class="fragment"></span><a href="#%E6%80%A7%E8%83%BD%E6%B8%AC%E5%AE%9A"><i class="fa fa-link"></i></a>性能測定</h2>

<p>元々シングルキャスト静的デリゲートはマルチキャストなデリゲートよりも高速に動作するはずと聞いたのでそれを利用としたのでした。<br>
では、どれだけ高速化したのか、測定しましょう！</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">StaticDelegate</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">static</span> <span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">Guid</span> <span class="nf">CALC</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">();</span>
    <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="nf">MethodImpl</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">CompilerServices</span><span class="p">.</span><span class="n">MethodImplOptions</span><span class="p">.</span><span class="n">AggressiveOptimization</span><span class="p">)]</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">V</span> <span class="p">=</span> <span class="m">50000000</span><span class="p">;</span>
        <span class="n">Stopwatch</span> <span class="n">watch</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Stopwatch</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">funcDelegate</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Guid</span><span class="p">&gt;(</span><span class="n">CALC</span><span class="p">);</span>
        <span class="n">IntPtr</span> <span class="n">funcPtr</span> <span class="p">=</span> <span class="n">funcDelegate</span><span class="p">.</span><span class="nf">GetFuncPtr</span><span class="p">();</span>
        <span class="n">watch</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">V</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="n">funcPtr</span><span class="p">.</span><span class="n">Call</span><span class="p">&lt;</span><span class="n">Guid</span><span class="p">&gt;();</span>
        <span class="n">watch</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">watch</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">);</span>
        <span class="n">watch</span><span class="p">.</span><span class="nf">Reset</span><span class="p">();</span>
        <span class="n">watch</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">V</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="nf">funcDelegate</span><span class="p">();</span>
        <span class="n">watch</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">watch</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">);</span>
        <span class="n">watch</span><span class="p">.</span><span class="nf">Reset</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>上記コードは5千万回デリゲートを生成します。<br>
その結果は次の通りです。</p>

<table>
<thead>
<tr>
<th style="text-align: center">Static Delegate</th>
<th style="text-align: center">Old Delegate</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">6112ms</td>
<td style="text-align: center">6138ms</td>
</tr>
</tbody>
</table>

<p>圧倒的僅差ッ！　意味がナイッ！</p>

<h2>
<span id="インライン化" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%B3%E5%8C%96"><i class="fa fa-link"></i></a>インライン化</h2>

<p>C#で高速化するためのお手軽な属性をご存知でしょうか？<br>
それはSystem.Runtime.CompilerServices.MethodImplAttribute(MethodImpleOptions.AggressiveInlining)です。<br>
これをつけると関数はわりとインライン化されやすくなります。<br>
インライン化されると何が嬉しいのかですって？　それは<a href="https://ufcpp.net/study/csharp/structured/miscinlining/" rel="nofollow noopener" target="_blank">こちらの記事</a>をご覧ください。</p>

<p>IL的には次のように書けば[System.Runtime.CompilerServices.MethodImplAttribute(MethodImpleOptions.AggressiveInlining)]と同じ働きになります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>.method public hidebysig static !!T Calc&lt;T&gt;(native int funcPtr) cil managed aggressiveinlining
</code></pre></div></div>

<p>cil managed の後にaggressiveinliningとつけるだけですね。実に簡単です。<br>
さあ、これで再試行しましょう。リベンジです！</p>

<p>「ガッシ！ボカッ！」<br>
.NET Coreは同じ結果を返した。スイーツ（笑）</p>

<p>calliが含まれるメソッドはインライン化されないようです。</p>

<h1>
<span id="第6節the-burst-compiler-conditionburstコンパイラの条件" class="fragment"></span><a href="#%E7%AC%AC6%E7%AF%80the-burst-compiler-conditionburst%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%81%AE%E6%9D%A1%E4%BB%B6"><i class="fa fa-link"></i></a>第6節　The Burst Compiler Condition/Burstコンパイラの条件</h1>

<p>前節にて私はSystem.Delegateと同等のスペックの新たなシングルキャストデリゲートを開発しました。<br>
性能向上が本当は欲しいのですが、無いものは仕方がありません。<br>
では現状得られたこの静的デリゲート（実態はIntPtr型に対する拡張メソッド群）をどのように使えばDelegateと差別化を図れるでしょうか？</p>

<p>この時私に電流が走りました。<br>
「静的クラス以外の参照型を一切使用できない環境下であるならば、この拡張クラスと静的デリゲートを使わざるを得ないのでは？」と。</p>

<p>そんな都合の良い環境は……存在します。<br>
UnityのBurst Jobです。<br>
詳しくは<a href="https://unity3d.com/jp/learn/tutorials/topics/scripting/using-burst-compiler" rel="nofollow noopener" target="_blank">Unity社のチュートリアル</a>などを参照してほしいのですが、BurstとはUnityで超高速に並列計算を行うための特殊な制約を課された環境です。Burst CompilerはILをネイティブコードに変えますが、SIMDなどを活用して大胆な高速化を図るそうです。<br>
そこでは参照型をnewすることはできず、静的フィールドを使用できません。静的メソッドと構造体のみ使用できます。</p>

<p>System.Delegateと私のStaticDelegateHelper（拡張メソッド群）の差別化にぴったりではありませんか！</p>

<p>私は喜び勇んでサンプルプログラムを書いて実行しました。</p>

<p>「ガッシ！ボカッ！」<br>
Unityは死んだ。スイーツ（笑）</p>

<h2>
<span id="unityの使用するmscorlibについて" class="fragment"></span><a href="#unity%E3%81%AE%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8Bmscorlib%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>Unityの使用するmscorlibについて</h2>

<p>Unityの使用するmscorlibは.NET Coreの使用するそれと異なっていました。<br>
はい、UnityはMonoです。MonoのSystem.Delegateには_methodPtrAuxというIntPtr型privateフィールドは存在していませんでした。</p>

<p>私はILSpyでSystem.DelegateのprivateなIntPtr型フィールドを調べてみました。</p>

<ul>
<li>method_ptr</li>
<li>invoke_impl</li>
<li>method</li>
<li>delegate_trampoline</li>
<li>extra_arg</li>
<li>method_code</li>
</ul>

<p>6個全部試してみました！　<strong>全部Unityをクラッシュさせました！（全ギレ）</strong></p>

<h2>
<span id="再びのdynamicmethod" class="fragment"></span><a href="#%E5%86%8D%E3%81%B3%E3%81%AEdynamicmethod"><i class="fa fa-link"></i></a>再びのDynamicMethod</h2>

<p>次のようなコードを書かざるを得ませんでした。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">static</span> <span class="n">IntPtr</span> <span class="nf">GetFuncPtr</span><span class="p">(</span><span class="k">this</span> <span class="n">System</span><span class="p">.</span><span class="n">Delegate</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DynamicMethod</span> <span class="n">dm</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynamicMethod</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IntPtr</span><span class="p">),</span> <span class="n">Array</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">&gt;());</span>
    <span class="n">ILGenerator</span> <span class="n">ilgen</span> <span class="p">=</span> <span class="n">dm</span><span class="p">.</span><span class="nf">GetILGenerator</span><span class="p">();</span>
    <span class="n">ilgen</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldftn</span><span class="p">,</span> <span class="n">function</span><span class="p">.</span><span class="nf">GetMethodInfo</span><span class="p">());</span>
    <span class="n">ilgen</span><span class="p">.</span><span class="nf">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ret</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dm</span><span class="p">.</span><span class="nf">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IntPtr</span><span class="p">&gt;))</span> <span class="k">as</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">IntPtr</span><span class="p">&gt;)();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>System.DelegateからGetMethodInfoでMethodInfoを得ます。<br>
これをldftnの引数にすることで対象のメソッドの関数ポインタを得ています。<br>
そしてDynamicMethodでメソッドを新規に作成、呼び出し、戻り値として関数ポインタを得ます。<br>
無駄な回り道感と無駄アロケーション感が大きすぎて敗北感に苛まれますね。</p>

<h1>
<span id="最終節static-delegates-longest-day静的委譲のいちばん長い日" class="fragment"></span><a href="#%E6%9C%80%E7%B5%82%E7%AF%80static-delegates-longest-day%E9%9D%99%E7%9A%84%E5%A7%94%E8%AD%B2%E3%81%AE%E3%81%84%E3%81%A1%E3%81%B0%E3%82%93%E9%95%B7%E3%81%84%E6%97%A5"><i class="fa fa-link"></i></a>最終節　Static Delegate's Longest Day/静的委譲のいちばん長い日</h1>

<p>こうして私はUnityでもデリゲートから関数ポインタを得られるようになり、calliを使ってシングルキャスト静的デリゲートを使えるようになりました。<br>
さあ、最後にBurstでこれを使えれば今までデリゲートが存在せず柔軟な機能制御ができなかったBurst界隈に革命が起きるはずです。</p>

<p>「ガッシ！ボカッ！」<br>
Burst Compilerは死んだ。スイーツ（笑）</p>

<p>Burst Compilerはcalli命令を扱えませんでした。</p>

<p>これまでの私の苦労は一体？と絶望し、Unity TechnologiesにBurst Compilerがcalliを扱えるように改善してほしいと要望を出しました。<br>
現在Burstがデリゲートを扱えないのは重大な機能的欠陥であるとも指摘しました。</p>

<h2>
<span id="delegate-in-burst" class="fragment"></span><a href="#delegate-in-burst"><i class="fa fa-link"></i></a>Delegate in Burst</h2>

<p>返信は他のUnityユーザーの方からきました。<br>
<a href="https://forum.unity.com/threads/burst-job-support-delegates.614905/" rel="nofollow noopener" target="_blank">Burstは最新バージョンからデリゲートを特別扱いすることで利用可能にしているそうです。</a></p>

<h1>
<span id="感想" class="fragment"></span><a href="#%E6%84%9F%E6%83%B3"><i class="fa fa-link"></i></a>感想</h1>

<p><img alt=":angel:" class="emoji" height="20" src="https://cdn.qiita.com/emoji/twemoji/unicode/1f47c.png" title=":angel:" width="20" loading="lazy"></p>

<p>最後までお読みいただきありがとうございました。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2FpCYSl5EDgo%2Fitems%2F4a5cc446553f4d99a7f3&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2FpCYSl5EDgo%2Fitems%2F4a5cc446553f4d99a7f3&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3/likers" class="css-1iupg5d">24</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">23</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/4a5cc446553f4d99a7f3/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/pCYSl5EDgo/items/4a5cc446553f4d99a7f3.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-17669bc4-ed17-4fd5-adfd-24401cdf5613">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-0525c6d1-5a2a-496d-bd23-112fc1daa571"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-0525c6d1-5a2a-496d-bd23-112fc1daa571">{}</script>
      
<div id="LoginModal-react-component-0e78f5fd-7314-498f-8412-6ea84896721e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-0e78f5fd-7314-498f-8412-6ea84896721e">{}</script>
      
<div id="StockModal-react-component-f3ca3c5b-9c00-4a63-b1f5-be1f4c268df7"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-f3ca3c5b-9c00-4a63-b1f5-be1f4c268df7">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;gWWdikiZTs0URzRXAeZEHkcOKlvE1P6OxZ1teoGvHuuSzsxyUdz0inWDQ5twusesMF6+KkS46c8ZrHsxEdLreQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e初投稿です（大嘘）。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://ufcpp.net/blog/2018/8/pickuproslyn0822/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eufcpp\u003c/a\u003eによるとマルチキャストが不要な静的メソッドに対してデリゲート的なことをしようとする場合デリゲートはオーバースペックなのですね。\u003cbr\u003e\nですがシングルキャストなデリゲートはC#ではサポートされていません。\u003cbr\u003e\nメソッドから関数ポインタを取得するldftn命令を直接出力したり、関数ポインタをメソッドとして使用するcalli命令を直接出力したりできないからです。\u003c/p\u003e\n\n\u003cp\u003e\u003cem\u003eC#でできないことだってできる。そう、ILならね。\u003c/em\u003e　という感じでILを使用してシングルキャスト静的デリゲートを扱えるようにしてみました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"第0節im-il-nichts-neuesil戦線異状なし\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%AC%AC0%E7%AF%80im-il-nichts-neuesil%E6%88%A6%E7%B7%9A%E7%95%B0%E7%8A%B6%E3%81%AA%E3%81%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e第0節　Im IL nichts Neues/IL戦線異状なし\u003c/h1\u003e\n\n\u003cp\u003eC#はRoslynコンパイラによってコンパイルされると中間言語（Intermediate Language）にコンパイルされてDLLやEXEファイルになります。\u003cbr\u003e\nILは実行環境でJITコンパイルされて機械語に翻訳されて実行されます。\u003c/p\u003e\n\n\u003cp\u003eC:\\Windows\\Microsoft.Net\\Framework64\\v4.0.30319\\ilasm.exeをコマンドラインから使用して.ilファイルをコンパイルすると.dllファイルを作ることが可能です。\u003cbr\u003e\nこの時に.projファイルは不要です。\u003c/p\u003e\n\n\u003cp\u003eILの書き方は\u003ca href=\"https://www.linqpad.net/download.aspx\" rel=\"nofollow noopener\" target=\"_blank\"\u003eLINQPad5\u003c/a\u003eと\u003ca href=\"https://github.com/icsharpcode/ILSpy/releases\" rel=\"nofollow noopener\" target=\"_blank\"\u003eILSpy\u003c/a\u003eを使用して学ぶのが最適でしょう。\u003cbr\u003e\n学び方は \u003ca href=\"/neuecc\" class=\"user-mention js-hovercard\" title=\"neuecc\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"neuecc\"\u003e@neuecc\u003c/a\u003e さんの\u003ca href=\"http://neue.cc/2017/12/04_560.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e記事\u003c/a\u003eを参考にされると良いでしょう。\u003cbr\u003e\nなお、calliとldftnは殆どIL中にも出てこない命令ですので上記ソフトで使用法を学習できませんでした。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"第1節anders-got-his-documentアンダァスは仕様書を読んだ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%AC%AC1%E7%AF%80anders-got-his-document%E3%82%A2%E3%83%B3%E3%83%80%E3%82%A1%E3%82%B9%E3%81%AF%E4%BB%95%E6%A7%98%E6%9B%B8%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e第1節　Anders Got His Document/アンダァスは仕様書を読んだ\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.ecma-international.org/publications/standards/Ecma-335.htm\" rel=\"nofollow noopener\" target=\"_blank\"\u003eILについてのECMAの仕様書\u003c/a\u003eを読んでldftnとcalliについての概略を把握しました。　calliについて検索すると「calling」というワードも引っかかるのが面倒でしたね。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"calliについての仕様書の記述\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#calli%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E4%BB%95%E6%A7%98%E6%9B%B8%E3%81%AE%E8%A8%98%E8%BF%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003ecalliについての仕様書の記述\u003c/h2\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eFormat\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eAssembly Format\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eDescription\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e29 \u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003ecalli callsitedescr\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eCall method indicated on the stack with arguments described by callsitedescr.\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eStack Transition:\u003cbr\u003e\n…, arg0, arg1 … argN, ftn → …, retVal (not always returned)\u003c/p\u003e\n\n\u003cp\u003eDescription:\u003cbr\u003e\nThe calli instruction calls ftn (a pointer to a method entry point) with the arguments arg0 … argN.\u003cbr\u003e\nThe types of these arguments are described by the signature callsitedescr. (See Partition I for a description of the CIL calling sequence.) The calli instruction can be immediately preceded by a tail. prefix to specify that the current method state should be released before transferring control. If the call would transfer control to a method of higher trust than the originating method the stack frame will not be released; instead, the execution will continue silently as if the tail. prefix had not been supplied.\u003cbr\u003e\n[A callee of “higher trust” is defined as one whose permission grant-set is a strict superset of the grant-set of the caller.]\u003cbr\u003e\nThe ftn argument must be a method pointer to a method that can be legitimately called with the arguments described by callsitedescr (a metadata token for a stand-alone signature). Such a pointer can be created using the ldftn or ldvirtftn instructions, or could have been passed in from native code.\u003cbr\u003e\nThe standalone signature specifies the number and type of parameters being passed, as well as the calling convention (See Partition II). The calling convention is not checked dynamically, so code that uses a calli instruction will not work correctly if the destination does not actually use the specified calling convention.\u003cbr\u003e\nThe arguments are placed on the stack in left-to-right order. That is, the first argument is computed and placed on the stack, then the second argument, and so on. The argument-building code sequence for an instance or virtual method shall push that instance reference (the this pointer, which shall not be null) first. [Note: for calls to methods on value types, the this pointer is a managed pointer, not an instance reference. §I.8.6.1.5. end note]\u003cbr\u003e\nThe arguments are passed as though by implicit starg (§III.3.61) instructions, see Implicit argument coercion §III.1.6.\u003cbr\u003e\ncalli pops the this pointer, if any, and the arguments off the evaluation stack before calling the method. If the method has a return value, it is pushed on the stack upon method completion. On the callee side, the arg0 parameter/this pointer is accessed as argument 0, arg1 as argument 1, and so on. \u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e自家翻訳\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003ecalli命令はarg0からargNの与えられた引数を用いてftn（メソッドエントリポイントを指す関数ポインタ）の位置にあるメソッドを実行する。\u003cbr\u003e\n引数の型はシグネチャcallsitedescrによって示される。（CILのcalling sequenceの説明については第一編を見よ。）\u003cbr\u003e\nこのcalli命令によって使用される関数ポインタはldftnあるいはldvirtftn命令で得られるか、あるいはネイティブコードから受け渡される。\u003cbr\u003e\nStandaloneシグネチャは渡される引数の個数と型とともに呼び出し規約（第二編を見よ）を詳らかにする。呼び出し規約は動的（実行時）には検証されないため、呼び出し先の関数の呼び出し規約が記述されたそれでない場合、正しく動作しない。\u003cbr\u003e\n引数は左から右順でスタック上に積まれる。これは、第一引数が先に計算されてスタックに積まれ、次に第二引数という風に続くということである。インスタンスメソッドあるいは仮想メソッドのための引数にバインドされるコード列ならばインスタンスへの参照(this参照のことであり、nullを許容しない)を第零引数として置く。＊注：値型のインスタンスメソッドの場合はthisはマネージドポインタであり、インスタンスへの参照ではない。\u003cbr\u003e\n引数は暗黙的に使用されるstarg命令によってメソッドに渡される。\u003cbr\u003e\ncalliは関数ポインタをpopし、もし引数があるのであれば、関数を呼び出す前に評価スタックから引数をpopする。もしメソッドが戻り値を返すのであればメソッド完了時に戻り値がスタック上にpushされる。呼び出される側において、第零引数はargument 0、第一引数はargument 1という風にして使用可能である。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003ecallsitedescrをどう書けばいいのかわかりませんね。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ldftnについての仕様書の記述\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ldftn%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E4%BB%95%E6%A7%98%E6%9B%B8%E3%81%AE%E8%A8%98%E8%BF%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eldftnについての仕様書の記述\u003c/h2\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eFormat\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eAssembly Format\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eDescription\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eFE 06 \u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eldftn method\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003ePush a pointer to a method referenced by method, on the stack.\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eStack Transition:\u003cbr\u003e\n… → …, ftn\u003c/p\u003e\n\n\u003cp\u003eDescription:\u003cbr\u003e\nThe ldftn instruction pushes a method pointer (§II.14.5) to the native code implementing the method described by method (a metadata token, either a methoddef or methodref (see Partition II)), or to some other implementation-specific description of method (see Note) onto the stack).\u003cbr\u003e\nThe value pushed can be called using the calli instruction if it references a managed method (or a stub that transitions from managed to unmanaged code). It may also be used to construct a delegate, stored in a variable, etc.\u003cbr\u003e\nThe CLI resolves the method pointer according to the rules specified in §I.12.4.1.3 (Computed destinations), except that the destination is computed with respect to the class specified by method.\u003cbr\u003e\nThe value returned points to native code (see Note) using the calling convention specified by method. Thus a method pointer can be passed to unmanaged native code (e.g., as a callback routine).\u003cbr\u003e\nNote that the address computed by this instruction can be to a thunk produced specially for this purpose (for example, to re-enter the CIL interpreter when a native version of the method isn’t available).\u003cbr\u003e\n[Note: There are many options for implementing this instruction. Conceptually, this instruction places on the virtual machine’s evaluation stack a representation of the address of the method specified. In terms of native code this can be an address (as specified), a data structure that contains the address, or any value that can be used to compute the address, depending on the architecture of the underlying machine, the native calling conventions, and the implementation technology of the VES (JIT, interpreter, threaded code, etc.). end note] \u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e自家翻訳\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eldftn命令はmethoddefあるいはmethodref(第二編を見よ)なメタデータトークンによって記述された、メソッド実行部分のネイティブコードへの関数ポインタをpushする。\u003cbr\u003e\nスタック上にpushされた値は、もしその値がマネージドコードを参照（あるいはマネージド領域からアンマネージ領域へ移行するためのスタブ）ならばcalli命令によって使用されうる。\u003cbr\u003e\nこの値は変数に格納されたり、あるいはデリゲートを作成したり、その他なにかに使用される可能性もあるかもしれない（低い）。\u003cbr\u003e\nCLIはメソッドで指定されたクラスに関して計算されたdestinationを除いて、第一編十二章四節一項三款に詳述された規則に従い関数ポインタを解決する。\u003cbr\u003e\n戻り値の値はメソッドに指定された呼び出し規約を使用するネイティブコードを指す。これ故に関数ポインタはアンマネージドネイティブコードに渡されうる。（例：コールバックルーチン）\u003cbr\u003e\n注意すべきことに、この命令によって算出されたアドレスはこの目的のために特別に用意されたthunkでありうる。たとえばネイティブ版のメソッドをCILインタプリタに再代入することは不可能である。\u003cbr\u003e\n＊注：この命令の実装方法は多岐にわたる。概念的には、この命令は仮想マシンの評価スタックに特定メソッドのアドレスを表すものをpushする。ネイティブコードならばそれはアドレスや、アドレスを含む構造体、あるいはアドレスを算出しうるなんらかの値であり、具体的には基底に存在する現実の計算機の構造、ネイティブの呼び出し規約、VESの実装に依存する。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"第2節wikiapocalypse-nowウィキペディアの黙示録\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%AC%AC2%E7%AF%80wikiapocalypse-now%E3%82%A6%E3%82%A3%E3%82%AD%E3%83%9A%E3%83%87%E3%82%A3%E3%82%A2%E3%81%AE%E9%BB%99%E7%A4%BA%E9%8C%B2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e第2節　Wikiapocalypse Now/ウィキペディアの黙示録\u003c/h1\u003e\n\n\u003cp\u003ecalliの使用例を見ないと書きようがないとわかった私は試しにwikipedia英語版を開いてみました。\u003cbr\u003e\n\u003ca href=\"https://en.wikipedia.org/wiki/Common_Intermediate_Language#Pointer_instructions_-_C++/CLI\" rel=\"nofollow noopener\" target=\"_blank\"\u003e使用例\u003c/a\u003eがありました（完全勝利した淫夢くんUC）。\u003cbr\u003e\nサンプルコードについては上記リンク先を参照してみてください。\u003c/p\u003e\n\n\u003cp\u003e結論から書きますが上記サンプルは私を激しく混乱させるだけに終わりました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003eIL_001d:   calli      unmanaged stdcall void modopt([mscorlib]System.Runtime.CompilerServices.CallConvStdcall)(native int)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのコード片のIL_0001d:はラベルです。ハイ、C#ではswitch文のcaseで使用されるラベルです。あるいはgoto文の行き先を意味するラベルです。\u003cbr\u003e\nLINQPadでC#をILに変換し、それをさらにILSpyで完全版を確認すると必ず全IL命令のある行にIL_00xx:みたいな表記をされているのでCOBOLとかのように必須だと思い込んでいました。\u003cbr\u003e\n\u003cem\u003e別になくてもいいのです。\u003c/em\u003e\u003cbr\u003e\n\u003cstrong\u003e別になくてもいいのです（強調）。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eさらに上記サンプルはC++/CLIでネイティブコードを表現するためのものでしてね……\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"第3節lightning-strike-document-re-launch雷撃仕様書再出動\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%AC%AC3%E7%AF%80lightning-strike-document-re-launch%E9%9B%B7%E6%92%83%E4%BB%95%E6%A7%98%E6%9B%B8%E5%86%8D%E5%87%BA%E5%8B%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e第3節　Lightning Strike Document re-Launch/雷撃仕様書再出動\u003c/h1\u003e\n\n\u003cp\u003eやはり基本となるべきものは仕様書です。基本に立ち返ってサンプルを探しましょう。\u003cbr\u003e\n197ページからのサンプルが完全に正しかったです。\u003cbr\u003e\nなぜ、最初見落としていたのかですって？\u003cbr\u003e\n無視していました。IL_00xx:のようなラベルがないのでこれは実際には動かない擬似コードだろうと思いこんでいました。\u003cbr\u003e\nLINQPad5のILデコンパイルで表示されるILは厳密には擬似コードなので、そう思い込んでしまいました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e.assembly Test { }\n.assembly extern mscorlib { }\n.method public static int32 AddOne(int32 Input)\n{\n .maxstack 5\n ldarg Input\n ldc.i4.1\n add\n ret\n}\n.method public static int32 Negate(int32 Input)\n{\n .maxstack 5\n ldarg Input\n neg\n ret\n}\n.class value sealed public MakeDecision extends [mscorlib]System.ValueType\n{\n .field static bool Oscillate\n .method public static method int32 *(int32) Decide()\n {\n   ldsfld bool valuetype MakeDecision::Oscillate\n   dup\n   not\n   stsfld bool valuetype MakeDecision::Oscillate\n   brfalse NegateIt\n   ldftn int32 AddOne(int32)\n   ret\n  NegateIt:\n   ldftn int32 Negate(int32)\n   ret\n }\n}\n.method public static void Start()\n{\n .maxstack 2\n .entrypoint\n ldc.i4.1\n call method int32 *(int32) valuetype MakeDecision::Decide()\n calli int32(int32)\n call void [mscorlib]System.Console::WriteLine(int32)\n ldc.i4.1\n call method int32 *(int32) valuetype MakeDecision::Decide()\n calli int32(int32)\n call void [mscorlib]System.Console::WriteLine(int32)\n ldc.i4.1\n call method int32 *(int32) valuetype MakeDecision::Decide()\n calli int32(int32)\n call void [mscorlib]System.Console::WriteLine(int32)\n ret\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eILを全て書く場合、そのDLLが所属するアセンブリ名をファイルの先頭に.assembly \u003cem\u003eアセンブリ名\u003c/em\u003eと書きます。\u003cbr\u003e\nそしてこのILが参照する全てのDLLというかアセンブリの名前を.assembly extern \u003cem\u003e参照アセンブリ名\u003c/em\u003eとして記述します。\u003cbr\u003e\nmscorlibに基本的なAPIが集約されています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"addone-negate解説\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#addone-negate%E8%A7%A3%E8%AA%AC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eAddOne, Negate解説\u003c/h2\u003e\n\n\u003cp\u003eAddOneとNegateはC#で表記すると以下のようになります。萌ポイントとしてはneg命令によって正負反転が一命令で実現されていることですね。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003epublic static int AddOne(int Input) =\u0026gt; Input + 1;\npublic static int Negate(int Input) =\u0026gt; -Input;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"makedecision構造体解説\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#makedecision%E6%A7%8B%E9%80%A0%E4%BD%93%E8%A7%A3%E8%AA%AC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eMakeDecision構造体解説\u003c/h2\u003e\n\n\u003cp\u003eMakeDecisionは構造体です。.class value sealedと extends [mscorlib]System.ValueTypeによってそう指定されています。\u003cbr\u003e\n.field static bool Oscillateはprivateなbool型のstaticフィールドの定義です。\u003cbr\u003e\nC#では同一文で複数のフィールドを定義できますが、ILでは１文につき１フィールド定義します。\u003cbr\u003e\nMakeDecision.DecideについてC#で擬似コードを書いてみましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eDecide\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOscillate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eOscillate\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003eOscillate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eAddOne\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eOscillate\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003eOscillate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eNegate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e初出命令の解説\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003edup\n\n\u003cul\u003e\n\u003cli\u003eスタックの一番上にある値を複製してpush\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eldsfld/stsfld\n\n\u003cul\u003e\n\u003cli\u003e静的フィールドをスタック上にloadあるいはスタック上から格納(store)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ebrfalse\n\n\u003cul\u003e\n\u003cli\u003eスタックの一番上の値をpopして評価し、falseならばラベル位置へ処理をgoto\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e最適化されたILコードを見ると結構な頻度でローカル変数が消滅したりします。具体的には一つのインスタンスを連続で使い倒す場合ですね。この場合必要数だけ最初にdupしまくることでローカル変数を省いています。IL書くようになるとdupを上手に使いたくなります。\u003c/p\u003e\n\n\u003cp\u003eちなみにC#擬似コードで戻り値の型をFunc\u0026lt;int, int\u0026gt;と書いていますが、実際に戻っているのは関数ポインタです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"start解説\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#start%E8%A7%A3%E8%AA%AC\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStart解説\u003c/h2\u003e\n\n\u003cp\u003e疑似C#コードは以下の通りです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMakeDecision\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDecide\u003c/span\u003e\u003cspan class=\"p\"\u003e()(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e \u003cspan class=\"c1\"\u003e// -1\u003c/span\u003e\n   \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMakeDecision\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDecide\u003c/span\u003e\u003cspan class=\"p\"\u003e()(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e \u003cspan class=\"c1\"\u003e//  2\u003c/span\u003e\n   \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMakeDecision\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDecide\u003c/span\u003e\u003cspan class=\"p\"\u003e()(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e \u003cspan class=\"c1\"\u003e// -1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e試しにilasm.exeで動かせば動きました。\u003cbr\u003e\nいやぁ、ラベルって各行に必須なものではなかったのですね（遠い目）。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"第4節happy-hanukkah-mr-albahari総称型のハッピーハヌカ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%AC%AC4%E7%AF%80happy-hanukkah-mr-albahari%E7%B7%8F%E7%A7%B0%E5%9E%8B%E3%81%AE%E3%83%8F%E3%83%83%E3%83%94%E3%83%BC%E3%83%8F%E3%83%8C%E3%82%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e第4節　Happy Hanukkah, Mr. Albahari/総称型のハッピーハヌカ\u003c/h1\u003e\n\n\u003cp\u003e前節でcalliでCLIのマネージコードを呼び出す際の書式がわかりました。\u003cbr\u003e\nint32(int32)のように戻り値の型(引数の型, ...)ですね。\u003c/p\u003e\n\n\u003cp\u003e使い方がわかったとしてもライブラリにするためには総称型・ジェネリクスでないと使い勝手が悪いですよね。\u003cbr\u003e\nジェネリクスに対応させましょう。\u003cbr\u003e\nここでLINQPad5とILSpyに以下のコードをIL化してもらいます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eZ\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"nf\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"n\"\u003eobj0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eobj0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e.class public auto ansi abstract sealed beforefieldinit Z extends [mscorlib]System.Object\n{\n    .method public hidebysig static !!T A\u0026lt;T\u0026gt;(!!T obj0) cil managed\n    {\n        .custom instance void [mscorlib]System.Runtime.CompilerServices.ExtensionAttribute::.ctor() = (01 00 00 00)\n        .maxstack 1\n        ldarg.0\n        ret\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのILコードで注目していただきたいのは、メソッドシグネチャを定義している部分です。\u003cbr\u003e\n!!T A\u0026lt;T\u0026gt;(!!T obj0)と書いてありますよね。\u0026lt;\u0026gt;の間にジェネリクスの型パラメータの名前を書きます。\u003cbr\u003e\nそしてその型パラメータを他のコードで使用する場合、!!というprefixをつけます。\u003cbr\u003e\n簡単ですね！\u003c/p\u003e\n\n\u003cp\u003eところで、C#のwhere以下に記述される型制約も\u0026lt;\u0026gt;の間に記述されることになります。\u003cbr\u003e\nこの例としてはC# 7.3で導入された最高にクールなunmanaged制約がわかりやすいでしょう。\u003cbr\u003e\nT A\u0026lt;T\u0026gt;() where T : unmanagedは\u003cbr\u003e\n!!T A\u0026lt;valuetype .ctor (class [mscorlib]System.ValueType modreq([mscorlib]System.Runtime.InteropServices.UnmanagedType)) T\u0026gt;() cil managed\u003cbr\u003e\nとなります。\u003cbr\u003e\nmodereqとは呼び出し側が無視してはならない条件という意味合いですので、必須の型制約なのですね。\u003c/p\u003e\n\n\u003cp\u003eまた、C#の拡張メソッドをILで記述するにはどうすればよいでしょうか？\u003cbr\u003e\nメソッドの最初の行とその静的クラスの最初の行に.custom instance void [mscorlib]System.Runtime.CompilerServices.ExtensionAttribute::.ctor() = (01 00 00 00)と記述するのです。\u003cbr\u003e\nそうすることでそのクラスとメソッドが拡張クラス・メソッドであると.NETに伝えられます。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ref引数及びref戻り値\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ref%E5%BC%95%E6%95%B0%E5%8F%8A%E3%81%B3ref%E6%88%BB%E3%82%8A%E5%80%A4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eref引数及びref戻り値\u003c/h2\u003e\n\n\u003cp\u003e型の後ろに\u0026amp;とつけるだけで参照扱いされます。!!T\u0026amp;のような感じです。\u003c/p\u003e\n\n\u003cp\u003e参照型と値型に対してそれぞれフィールド取得などで命令に細かい差異が生じますが、今回の記事ではその辺の知識は不要なので説明しません。\u003cbr\u003e\n学びたいのであればECMAの仕様書に当たると良いですよ。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"第5節the-bridge-on-the-river-ldftn関数ポインタにかける橋\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%AC%AC5%E7%AF%80the-bridge-on-the-river-ldftn%E9%96%A2%E6%95%B0%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%AB%E3%81%8B%E3%81%91%E3%82%8B%E6%A9%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e第5節　The Bridge on The River Ldftn/関数ポインタにかける橋\u003c/h1\u003e\n\n\u003cp\u003ecalliによって関数ポインタを駆動するための知識は前節までで得られました。\u003c/p\u003e\n\n\u003cp\u003eでは、どうやって関数ポインタを得ましょうか？\u003cbr\u003e\nldftnでは引数に関数の情報を取ります。これはコード中にべた書きする他ありません。\u003cbr\u003e\nですが、ライブラリのユーザーはILではなく、C#を使う想定です。\u003c/p\u003e\n\n\u003cp\u003e悩んでいた所ちょうど良さそうな.NETのAPIが見つかりました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"systemruntimeinteropservicesmarshalgetfunctionpointerfordelegatesystemdelegate\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#systemruntimeinteropservicesmarshalgetfunctionpointerfordelegatesystemdelegate\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eSystem.Runtime.InteropServices.Marshal.GetFunctionPointerForDelegate(System.Delegate)\u003c/h2\u003e\n\n\u003cp\u003eそのまんまな名前ですね。\u003c/p\u003e\n\n\u003cp\u003e私は喜び勇んでこのAPIを使用して得た関数ポインタをcalliに渡してみました。\u003c/p\u003e\n\n\u003cp\u003e「ガッシ！ボカッ！」\u003cbr\u003e\n.NET Coreは死んだ。スイーツ（笑）\u003c/p\u003e\n\n\u003cp\u003e.NET Coreの新たなクラッシュ方法を私は学びました。\u003cbr\u003e\n開発サイクルを高速に回すためにまず.NET Coreで動作をテストしています。Unityだとコンパイルと実行でそこそこ時間がかかりますからね。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"il部dynamicmethodの裏技\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#il%E9%83%A8dynamicmethod%E3%81%AE%E8%A3%8F%E6%8A%80\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eIL部・DynamicMethodの裏技\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/pCYSl5EDgo/items/2c2794efcf335c35cb19\" id=\"reference-30b323fc9dce87e88853\"\u003e前の章で解説したテクニックを使用します。\u003c/a\u003e\u003cbr\u003e\n具体的には.NET 4.xのmscorlibをILSpyで覗いてみればわかるのですが、System.Delegateクラスのprivateフィールドに2つIntPtr型があるのです。\u003cbr\u003e\nこの2つ（_methodPtrと_methodPtrAux）のうちのどちらかがldftnで得られるメソッド本体を指す関数ポインタであると容易に想定されます。なぜ2つIntPtr型を用意しているのかよくわかりませんが。\u003c/p\u003e\n\n\u003cp\u003eこれはC#で書ける内容ですので以下のように書いて、それをLINQPad5→ILSpyのコンボでIL化してilasm.exeでDLL化しました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Reflection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Reflection.Emit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eStaticDelegateHelper\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eGetFuncPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"nf\"\u003eStaticDelegateHelper\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDynamicMethod\u003c/span\u003e \u003cspan class=\"n\"\u003emethod\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDynamicMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"GetFuncPtr\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMethodAttributes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePublic\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eMethodAttributes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStatic\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCallingConventions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStandard\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eType\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eILGenerator\u003c/span\u003e \u003cspan class=\"n\"\u003eilgen\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emethod\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetILGenerator\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eilgen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOpCodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLdarg_0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 第０引数について\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eilgen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOpCodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLdfld\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetField\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"_methodPtr\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBindingFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNonPublic\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eBindingFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInstance\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eilgen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOpCodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRet\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 戻り値とせよ\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eGetFuncPtr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;)\u003c/span\u003e\u003cspan class=\"n\"\u003emethod\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこれをIL化したコードを一応見てみましょう。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e.class nested public auto ansi abstract sealed StaticDelegateHelper extends [mscorlib]System.Object\n{\n  // Fields\n  .field public static initonly class [mscorlib]System.Func`2\u0026lt;class [mscorlib]System.Delegate, native int\u0026gt; GetFuncPtr\n\n  // Methods\n  .method private hidebysig specialname rtspecialname static void .cctor () cil managed \n  {\n    // Method begins at RVA 0x205c\n    // Code size 139 (0x8b)\n    .maxstack 8\n\n    ldstr \"GetFuncPtr\"\n    ldc.i4.s 22\n    ldc.i4.1\n    ldtoken [mscorlib]System.IntPtr\n    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)\n    ldc.i4.1\n    newarr [mscorlib]System.Type\n    dup\n    ldc.i4.0\n    ldtoken [mscorlib]System.Delegate\n    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)\n    stelem.ref\n    ldtoken [mscorlib]System.Delegate\n    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)\n    ldc.i4.1\n    newobj instance void [mscorlib]System.Reflection.Emit.DynamicMethod::.ctor(string, valuetype [mscorlib]System.Reflection.MethodAttributes, valuetype [mscorlib]System.Reflection.CallingConventions, class [mscorlib]System.Type, class [mscorlib]System.Type[], class [mscorlib]System.Type, bool)\n    dup\n    callvirt instance class [mscorlib]System.Reflection.Emit.ILGenerator [mscorlib]System.Reflection.Emit.DynamicMethod::GetILGenerator()\n    dup\n    ldsfld valuetype [mscorlib]System.Reflection.Emit.OpCode [mscorlib]System.Reflection.Emit.OpCodes::Ldarg_0\n    callvirt instance void [mscorlib]System.Reflection.Emit.ILGenerator::Emit(valuetype [mscorlib]System.Reflection.Emit.OpCode)\n    dup\n    ldsfld valuetype [mscorlib]System.Reflection.Emit.OpCode [mscorlib]System.Reflection.Emit.OpCodes::Ldfld\n    ldtoken [mscorlib]System.Delegate\n    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)\n    ldstr \"_methodPtr\"\n    ldc.i4.s 36\n    callvirt instance class [mscorlib]System.Reflection.FieldInfo [mscorlib]System.Type::GetField(string, valuetype [mscorlib]System.Reflection.BindingFlags)\n    callvirt instance void [mscorlib]System.Reflection.Emit.ILGenerator::Emit(valuetype [mscorlib]System.Reflection.Emit.OpCode, class [mscorlib]System.Reflection.FieldInfo)\n    ldsfld valuetype [mscorlib]System.Reflection.Emit.OpCode [mscorlib]System.Reflection.Emit.OpCodes::Ret\n    callvirt instance void [mscorlib]System.Reflection.Emit.ILGenerator::Emit(valuetype [mscorlib]System.Reflection.Emit.OpCode)\n    ldtoken class [mscorlib]System.Func`2\u0026lt;class [mscorlib]System.Delegate, native int\u0026gt;\n    call class [mscorlib]System.Type [mscorlib]System.Type::GetTypeFromHandle(valuetype [mscorlib]System.RuntimeTypeHandle)\n    callvirt instance class [mscorlib]System.Delegate [mscorlib]System.Reflection.MethodInfo::CreateDelegate(class [mscorlib]System.Type)\n    castclass class [mscorlib]System.Func`2\u0026lt;class [mscorlib]System.Delegate, native int\u0026gt;\n    stsfld class [mscorlib]System.Func`2\u0026lt;class [mscorlib]System.Delegate, native int\u0026gt; StaticDelegateHelper::GetFuncPtr\n    ret\n  } // end of method StaticDelegateHelper::.cctor\n} // end of class StaticDelegateHelper\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eメソッドの中身について語ることは特にないです。\u003cbr\u003e\n補足すべき点としては、readonlyはinitonlyと記述されます。\u003cbr\u003e\nそして静的コンストラクタは.method private hidebysig specialname rtspecialname static void .cctor () cil managedと書かれます。\u003c/p\u003e\n\n\u003cp\u003e_methodPtrで試したところ、.NET Coreがクラッシュしました。\u003cbr\u003e\n_methodPtrAuxで試したところ、動きました（完全勝利した淫夢くんUC）。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"性能測定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%80%A7%E8%83%BD%E6%B8%AC%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e性能測定\u003c/h2\u003e\n\n\u003cp\u003e元々シングルキャスト静的デリゲートはマルチキャストなデリゲートよりも高速に動作するはずと聞いたのでそれを利用としたのでした。\u003cbr\u003e\nでは、どれだけ高速化したのか、測定しましょう！\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eStaticDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Diagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eGuid\u003c/span\u003e \u003cspan class=\"nf\"\u003eCALC\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eGuid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eNewGuid\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRuntime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompilerServices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMethodImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRuntime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCompilerServices\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMethodImplOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAggressiveOptimization\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eV\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e50000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eStopwatch\u003c/span\u003e \u003cspan class=\"n\"\u003ewatch\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efuncDelegate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGuid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eCALC\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"n\"\u003efuncPtr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efuncDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetFuncPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efuncPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCall\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eGuid\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsedMilliseconds\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReset\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003efuncDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsedMilliseconds\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ewatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReset\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e上記コードは5千万回デリゲートを生成します。\u003cbr\u003e\nその結果は次の通りです。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eStatic Delegate\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eOld Delegate\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e6112ms\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e6138ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e圧倒的僅差ッ！　意味がナイッ！\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"インライン化\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%B3%E5%8C%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eインライン化\u003c/h2\u003e\n\n\u003cp\u003eC#で高速化するためのお手軽な属性をご存知でしょうか？\u003cbr\u003e\nそれはSystem.Runtime.CompilerServices.MethodImplAttribute(MethodImpleOptions.AggressiveInlining)です。\u003cbr\u003e\nこれをつけると関数はわりとインライン化されやすくなります。\u003cbr\u003e\nインライン化されると何が嬉しいのかですって？　それは\u003ca href=\"https://ufcpp.net/study/csharp/structured/miscinlining/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこちらの記事\u003c/a\u003eをご覧ください。\u003c/p\u003e\n\n\u003cp\u003eIL的には次のように書けば[System.Runtime.CompilerServices.MethodImplAttribute(MethodImpleOptions.AggressiveInlining)]と同じ働きになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e.method public hidebysig static !!T Calc\u0026lt;T\u0026gt;(native int funcPtr) cil managed aggressiveinlining\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ecil managed の後にaggressiveinliningとつけるだけですね。実に簡単です。\u003cbr\u003e\nさあ、これで再試行しましょう。リベンジです！\u003c/p\u003e\n\n\u003cp\u003e「ガッシ！ボカッ！」\u003cbr\u003e\n.NET Coreは同じ結果を返した。スイーツ（笑）\u003c/p\u003e\n\n\u003cp\u003ecalliが含まれるメソッドはインライン化されないようです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"第6節the-burst-compiler-conditionburstコンパイラの条件\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%AC%AC6%E7%AF%80the-burst-compiler-conditionburst%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%81%AE%E6%9D%A1%E4%BB%B6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e第6節　The Burst Compiler Condition/Burstコンパイラの条件\u003c/h1\u003e\n\n\u003cp\u003e前節にて私はSystem.Delegateと同等のスペックの新たなシングルキャストデリゲートを開発しました。\u003cbr\u003e\n性能向上が本当は欲しいのですが、無いものは仕方がありません。\u003cbr\u003e\nでは現状得られたこの静的デリゲート（実態はIntPtr型に対する拡張メソッド群）をどのように使えばDelegateと差別化を図れるでしょうか？\u003c/p\u003e\n\n\u003cp\u003eこの時私に電流が走りました。\u003cbr\u003e\n「静的クラス以外の参照型を一切使用できない環境下であるならば、この拡張クラスと静的デリゲートを使わざるを得ないのでは？」と。\u003c/p\u003e\n\n\u003cp\u003eそんな都合の良い環境は……存在します。\u003cbr\u003e\nUnityのBurst Jobです。\u003cbr\u003e\n詳しくは\u003ca href=\"https://unity3d.com/jp/learn/tutorials/topics/scripting/using-burst-compiler\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnity社のチュートリアル\u003c/a\u003eなどを参照してほしいのですが、BurstとはUnityで超高速に並列計算を行うための特殊な制約を課された環境です。Burst CompilerはILをネイティブコードに変えますが、SIMDなどを活用して大胆な高速化を図るそうです。\u003cbr\u003e\nそこでは参照型をnewすることはできず、静的フィールドを使用できません。静的メソッドと構造体のみ使用できます。\u003c/p\u003e\n\n\u003cp\u003eSystem.Delegateと私のStaticDelegateHelper（拡張メソッド群）の差別化にぴったりではありませんか！\u003c/p\u003e\n\n\u003cp\u003e私は喜び勇んでサンプルプログラムを書いて実行しました。\u003c/p\u003e\n\n\u003cp\u003e「ガッシ！ボカッ！」\u003cbr\u003e\nUnityは死んだ。スイーツ（笑）\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"unityの使用するmscorlibについて\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#unity%E3%81%AE%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8Bmscorlib%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eUnityの使用するmscorlibについて\u003c/h2\u003e\n\n\u003cp\u003eUnityの使用するmscorlibは.NET Coreの使用するそれと異なっていました。\u003cbr\u003e\nはい、UnityはMonoです。MonoのSystem.Delegateには_methodPtrAuxというIntPtr型privateフィールドは存在していませんでした。\u003c/p\u003e\n\n\u003cp\u003e私はILSpyでSystem.DelegateのprivateなIntPtr型フィールドを調べてみました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003emethod_ptr\u003c/li\u003e\n\u003cli\u003einvoke_impl\u003c/li\u003e\n\u003cli\u003emethod\u003c/li\u003e\n\u003cli\u003edelegate_trampoline\u003c/li\u003e\n\u003cli\u003eextra_arg\u003c/li\u003e\n\u003cli\u003emethod_code\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e6個全部試してみました！　\u003cstrong\u003e全部Unityをクラッシュさせました！（全ギレ）\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"再びのdynamicmethod\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%86%8D%E3%81%B3%E3%81%AEdynamicmethod\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e再びのDynamicMethod\u003c/h2\u003e\n\n\u003cp\u003e次のようなコードを書かざるを得ませんでした。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetFuncPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDelegate\u003c/span\u003e \u003cspan class=\"n\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDynamicMethod\u003c/span\u003e \u003cspan class=\"n\"\u003edm\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDynamicMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEmpty\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eType\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;());\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eILGenerator\u003c/span\u003e \u003cspan class=\"n\"\u003eilgen\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edm\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetILGenerator\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eilgen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOpCodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLdftn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetMethodInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eilgen\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEmit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eOpCodes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRet\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edm\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCreateDelegate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etypeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;))\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003eFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIntPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;)();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eSystem.DelegateからGetMethodInfoでMethodInfoを得ます。\u003cbr\u003e\nこれをldftnの引数にすることで対象のメソッドの関数ポインタを得ています。\u003cbr\u003e\nそしてDynamicMethodでメソッドを新規に作成、呼び出し、戻り値として関数ポインタを得ます。\u003cbr\u003e\n無駄な回り道感と無駄アロケーション感が大きすぎて敗北感に苛まれますね。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"最終節static-delegates-longest-day静的委譲のいちばん長い日\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%80%E7%B5%82%E7%AF%80static-delegates-longest-day%E9%9D%99%E7%9A%84%E5%A7%94%E8%AD%B2%E3%81%AE%E3%81%84%E3%81%A1%E3%81%B0%E3%82%93%E9%95%B7%E3%81%84%E6%97%A5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e最終節　Static Delegate's Longest Day/静的委譲のいちばん長い日\u003c/h1\u003e\n\n\u003cp\u003eこうして私はUnityでもデリゲートから関数ポインタを得られるようになり、calliを使ってシングルキャスト静的デリゲートを使えるようになりました。\u003cbr\u003e\nさあ、最後にBurstでこれを使えれば今までデリゲートが存在せず柔軟な機能制御ができなかったBurst界隈に革命が起きるはずです。\u003c/p\u003e\n\n\u003cp\u003e「ガッシ！ボカッ！」\u003cbr\u003e\nBurst Compilerは死んだ。スイーツ（笑）\u003c/p\u003e\n\n\u003cp\u003eBurst Compilerはcalli命令を扱えませんでした。\u003c/p\u003e\n\n\u003cp\u003eこれまでの私の苦労は一体？と絶望し、Unity TechnologiesにBurst Compilerがcalliを扱えるように改善してほしいと要望を出しました。\u003cbr\u003e\n現在Burstがデリゲートを扱えないのは重大な機能的欠陥であるとも指摘しました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"delegate-in-burst\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#delegate-in-burst\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eDelegate in Burst\u003c/h2\u003e\n\n\u003cp\u003e返信は他のUnityユーザーの方からきました。\u003cbr\u003e\n\u003ca href=\"https://forum.unity.com/threads/burst-job-support-delegates.614905/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eBurstは最新バージョンからデリゲートを特別扱いすることで利用可能にしているそうです。\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"感想\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%84%9F%E6%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e感想\u003c/h1\u003e\n\n\u003cp\u003e\u003cimg alt=\":angel:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/1f47c.png\" title=\":angel:\" width=\"20\" loading=\"lazy\"\u003e\u003c/p\u003e\n\n\u003cp\u003e最後までお読みいただきありがとうございました。\u003c/p\u003e\n","createdAt":"2019-01-25T09:08:28Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"Y0JEhn6wU4ALPgcYoSZb+abhU/116Rf3--xrlf0XnBD8UW3AJa--ecFWF94SEmgkwhPdvBuLug==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2019-01-25T09:08:28Z","likesCount":24,"linkUrl":"https://qiita.com/pCYSl5EDgo/items/4a5cc446553f4d99a7f3","organization":null,"originalId":773154,"stockedCount":23,"title":"ILの暗黒の魔術　第２章「Unity反撃！●された静的委譲！」","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%AC%AC0%E7%AF%80im-il-nichts-neuesil%E6%88%A6%E7%B7%9A%E7%95%B0%E7%8A%B6%E3%81%AA%E3%81%97\"\u003e第0節　Im IL nichts Neues/IL戦線異状なし\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%AC%AC1%E7%AF%80anders-got-his-document%E3%82%A2%E3%83%B3%E3%83%80%E3%82%A1%E3%82%B9%E3%81%AF%E4%BB%95%E6%A7%98%E6%9B%B8%E3%82%92%E8%AA%AD%E3%82%93%E3%81%A0\"\u003e第1節　Anders Got His Document/アンダァスは仕様書を読んだ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#calli%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E4%BB%95%E6%A7%98%E6%9B%B8%E3%81%AE%E8%A8%98%E8%BF%B0\"\u003ecalliについての仕様書の記述\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ldftn%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E4%BB%95%E6%A7%98%E6%9B%B8%E3%81%AE%E8%A8%98%E8%BF%B0\"\u003eldftnについての仕様書の記述\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%AC%AC2%E7%AF%80wikiapocalypse-now%E3%82%A6%E3%82%A3%E3%82%AD%E3%83%9A%E3%83%87%E3%82%A3%E3%82%A2%E3%81%AE%E9%BB%99%E7%A4%BA%E9%8C%B2\"\u003e第2節　Wikiapocalypse Now/ウィキペディアの黙示録\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%AC%AC3%E7%AF%80lightning-strike-document-re-launch%E9%9B%B7%E6%92%83%E4%BB%95%E6%A7%98%E6%9B%B8%E5%86%8D%E5%87%BA%E5%8B%95\"\u003e第3節　Lightning Strike Document re-Launch/雷撃仕様書再出動\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#addone-negate%E8%A7%A3%E8%AA%AC\"\u003eAddOne, Negate解説\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#makedecision%E6%A7%8B%E9%80%A0%E4%BD%93%E8%A7%A3%E8%AA%AC\"\u003eMakeDecision構造体解説\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#start%E8%A7%A3%E8%AA%AC\"\u003eStart解説\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%AC%AC4%E7%AF%80happy-hanukkah-mr-albahari%E7%B7%8F%E7%A7%B0%E5%9E%8B%E3%81%AE%E3%83%8F%E3%83%83%E3%83%94%E3%83%BC%E3%83%8F%E3%83%8C%E3%82%AB\"\u003e第4節　Happy Hanukkah, Mr. Albahari/総称型のハッピーハヌカ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#ref%E5%BC%95%E6%95%B0%E5%8F%8A%E3%81%B3ref%E6%88%BB%E3%82%8A%E5%80%A4\"\u003eref引数及びref戻り値\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%AC%AC5%E7%AF%80the-bridge-on-the-river-ldftn%E9%96%A2%E6%95%B0%E3%83%9D%E3%82%A4%E3%83%B3%E3%82%BF%E3%81%AB%E3%81%8B%E3%81%91%E3%82%8B%E6%A9%8B\"\u003e第5節　The Bridge on The River Ldftn/関数ポインタにかける橋\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#systemruntimeinteropservicesmarshalgetfunctionpointerfordelegatesystemdelegate\"\u003eSystem.Runtime.InteropServices.Marshal.GetFunctionPointerForDelegate(System.Delegate)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#il%E9%83%A8dynamicmethod%E3%81%AE%E8%A3%8F%E6%8A%80\"\u003eIL部・DynamicMethodの裏技\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%80%A7%E8%83%BD%E6%B8%AC%E5%AE%9A\"\u003e性能測定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%B3%E5%8C%96\"\u003eインライン化\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%AC%AC6%E7%AF%80the-burst-compiler-conditionburst%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%A9%E3%81%AE%E6%9D%A1%E4%BB%B6\"\u003e第6節　The Burst Compiler Condition/Burstコンパイラの条件\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#unity%E3%81%AE%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8Bmscorlib%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eUnityの使用するmscorlibについて\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%86%8D%E3%81%B3%E3%81%AEdynamicmethod\"\u003e再びのDynamicMethod\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%80%E7%B5%82%E7%AF%80static-delegates-longest-day%E9%9D%99%E7%9A%84%E5%A7%94%E8%AD%B2%E3%81%AE%E3%81%84%E3%81%A1%E3%81%B0%E3%82%93%E9%95%B7%E3%81%84%E6%97%A5\"\u003e最終節　Static Delegate's Longest Day/静的委譲のいちばん長い日\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#delegate-in-burst\"\u003eDelegate in Burst\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%84%9F%E6%83%B3\"\u003e感想\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":5066,"uuid":"4a5cc446553f4d99a7f3","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"kHrEiD8at16Tv4dedWfpaOz2j+Ir--m1Y6sqp5e1O0IE52--T+3zhPk8WynLb8Q/iz8QbA==","originalId":256047,"description":"C#!好き!!（語彙不足）\r\nUnityやヴァーレントゥーガ関連の投稿をしていく予定です。","facebookUrl":null,"githubUrl":"https://github.com/pCYSl5EDgo","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"自治区 スーギ・ノウコ","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/256047/profile-images/1546351264","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F256047%2Fprofile-images%2F1546351264?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=976dab58dc56a745da2171d56fec56a7","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F256047%2Fprofile-images%2F1546351264?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=c5789bc76dd49b92c1ddc68bc158b06b","urlName":"pCYSl5EDgo","websiteUrl":"","twitterUrl":"https://twitter.com/pCYSl5EDgo","twitterUrlName":"pCYSl5EDgo","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"},{"name":"IL","urlName":"il"},{"name":"DynamicMethod","urlName":"dynamicmethod"}],"followingLikers":{"edges":[]},"comments":{"totalCount":2}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
