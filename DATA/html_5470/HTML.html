<!DOCTYPE html><html><head><meta charset="utf-8" /><title>PostgreSQLの日付型のソートとインデックスのパフォーマンス比較 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/koshian2/items/867ed761c9e9d1608911" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="md3xGiGIxsYGUqNuQkTq+NuZgni4k4A81YAdEOmtwBVKwhN+wpA91yOIUb8LbBBUt+n+nr2hNbWPwgsDKlnVQQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@koshian2" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="PostgreSQLの日付型のソートとインデックスのパフォーマンス比較 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1VRzl6ZEdkeVpWTlJUT09CcnVhWHBlUzdtT1dlaS1PQnJ1T0N2ZU9Edk9PRGlPT0JxT09DcE9PRHMtT0RoLU9EZy1PQ3ItT0N1ZU9CcnVPRGtlT0RsZU9DcWVPRHZPT0RudU9Ecy1PQ3VlYXZsT2k4Z3cmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZTEyN2Y5M2Q1NTRkY2E5NDhmNDkyZWU5NDMxMmVmMjk&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3R2YzJocFlXNHkmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz03ODE4YmRmMzdhNTRkOWNiMzBlZGM5NDlkOTExNWFhYQ&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=466530204e3b6b9c783700ff969abef1"><meta property="og:description" content="PostgreSQLを使っていたら、日付のソートってどれぐらいの処理速度なんだろう？と気になったので計測してみました。

環境：psql (PostgreSQL) 10.2 Windows版、Npgsql（v3.2.6 - 2017/..."><meta content="https://qiita.com/koshian2/items/867ed761c9e9d1608911" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,SQL,PostgreSQL,Npgsql" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-a9e2ec2b-0313-48e6-8fc3-309e85ee8e6e"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fkoshian2%2Fitems%2F867ed761c9e9d1608911">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fkoshian2%2Fitems%2F867ed761c9e9d1608911">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-a9e2ec2b-0313-48e6-8fc3-309e85ee8e6e">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-02-22T21:52:35.000+09:00","dateModified":"2018-02-22T21:52:35.000+09:00","headline":"PostgreSQLの日付型のソートとインデックスのパフォーマンス比較","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1VRzl6ZEdkeVpWTlJUT09CcnVhWHBlUzdtT1dlaS1PQnJ1T0N2ZU9Edk9PRGlPT0JxT09DcE9PRHMtT0RoLU9EZy1PQ3ItT0N1ZU9CcnVPRGtlT0RsZU9DcWVPRHZPT0RudU9Ecy1PQ3VlYXZsT2k4Z3cmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZTEyN2Y5M2Q1NTRkY2E5NDhmNDkyZWU5NDMxMmVmMjk\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3R2YzJocFlXNHkmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz03ODE4YmRmMzdhNTRkOWNiMzBlZGM5NDlkOTExNWFhYQ\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=466530204e3b6b9c783700ff969abef1","mainEntityOfPage":"https://qiita.com/koshian2/items/867ed761c9e9d1608911","author":{"@type":"Person","address":"","email":null,"identifier":"koshian2","name":"koshian2","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F232088%2Fbfc82ef2b35f67a9938d0c0b8e47b7f8b31cfd0f%2Fx_large.png%3F1601448873?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1bb883886dc4d0acc43421d9cae720cb","url":"https://qiita.com/koshian2","description":"C#使ってましたがPythonに浮気してます。IoTでビッグデータをディープラーニングする闇の魔術の趣味をはじめました。 \r\n新刊通販（NumPy本）　https://koshian2.booth.pm/items/2462894  \r\n通販（GAN本）　https://koshian2.booth.pm/items/1835219  \r\n","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita&amp;utm_medium=header-banner">クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"koshian2","type":"items","id":"867ed761c9e9d1608911"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい","url":"https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"koshian2","type":"items","id":"867ed761c9e9d1608911"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい","url":"https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"koshian2","type":"items","id":"867ed761c9e9d1608911"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"クラウド型AI-OCRの技術者が語る、研究開発寄りのプロダクト開発のやりがい","url":"https://zine.qiita.com/interview/202107-hitachi/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/koshian2/items/867ed761c9e9d1608911","location":"/koshian2/items/867ed761c9e9d1608911","scheme":"https","host":"qiita.com","port":null,"pathname":"/koshian2/items/867ed761c9e9d1608911","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"fT/ZqyV0USSE9aiXlt4q74nfKOPFtBYkSF48Aow+EbiuIDvPxmyqNaEvWkbf9tBD5a9UBcCGo60SHCoRT8oE7A==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-dd4239b1-ffab-4aff-949f-99e5a2205e69"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/koshian2/items/867ed761c9e9d1608911/likers" class="css-1iupg5d">9</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">14</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/867ed761c9e9d1608911/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/koshian2/items/867ed761c9e9d1608911/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/koshian2/items/867ed761c9e9d1608911/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/koshian2/items/867ed761c9e9d1608911/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/koshian2/items/867ed761c9e9d1608911.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/koshian2"><img class="css-100alwu eyfquo10" src="https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/232088/bfc82ef2b35f67a9938d0c0b8e47b7f8b31cfd0f/x_large.png?1601448873" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/koshian2" class="css-10ougpm">@<!-- -->koshian2</a><div class="css-1ay9vb9"><time dateTime="2018-02-22T12:52:35Z" class="css-m19uds">posted at 2018-02-22</time></div></div></div></div></div><h1 class="css-cgzq40">PostgreSQLの日付型のソートとインデックスのパフォーマンス比較</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/sql" class="css-4czcte">SQL</a><a href="/tags/postgresql" class="css-4czcte">PostgreSQL</a><a href="/tags/npgsql" class="css-4czcte">Npgsql</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>PostgreSQLを使っていたら、日付のソートってどれぐらいの処理速度なんだろう？と気になったので計測してみました。</p>

<p>環境：psql (PostgreSQL) 10.2 Windows版、Npgsql（v3.2.6 - 2017/12/3）、データディレクトリはHDD、.NET Framework 4.6</p>

<p>データ挿入はアプリケーション（C#）側から行っています。パフォーマンスの比較はPostgreSQLにログインし、コマンドラインから\timingコマンドを使って行います。</p>

<h2>
<span id="1postgresqlの日付のデータ型" class="fragment"></span><a href="#1postgresql%E3%81%AE%E6%97%A5%E4%BB%98%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B"><i class="fa fa-link"></i></a>1.PostgreSQLの日付のデータ型</h2>

<p><a href="https://www.postgresql.jp/document/9.6/html/datatype-datetime.html" rel="nofollow noopener" target="_blank">公式ドキュメント</a>によると、timestamp型が日付と時刻を両方管理するのに使えそうです。<strong>タイムゾーンあり（TIMESTAMPTZ）、なし（TIMESTAMP）</strong>の2つがあります。標準SQLではTIMESTAMPはタイムゾーンが含まれなく、TIMESTAMPTZはPostgreSQLの独自の拡張だそうです。</p>

<table>
<thead>
<tr>
<th style="text-align: center">型名</th>
<th style="text-align: center">格納サイズ</th>
<th style="text-align: center">説明</th>
<th style="text-align: center">最遠の過去</th>
<th style="text-align: center">最遠の未来</th>
<th style="text-align: center">精度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">timestamp [ (p) ] [ without time zone ]</td>
<td style="text-align: center">8 バイト</td>
<td style="text-align: center">日付と時刻両方（時間帯なし）</td>
<td style="text-align: center">4713 BC</td>
<td style="text-align: center">294276 AD</td>
<td style="text-align: center">1マイクロ秒、14桁</td>
</tr>
<tr>
<td style="text-align: center">timestamp [ (p) ] with time zone</td>
<td style="text-align: center">8バイト</td>
<td style="text-align: center">日付と時刻両方、時間帯付き</td>
<td style="text-align: center">4713 BC</td>
<td style="text-align: center">294276 AD</td>
<td style="text-align: center">1マイクロ秒、14桁</td>
</tr>
</tbody>
</table>

<p>INTERVAL型は時刻と時刻の差分を表す時間（<a href="http://www.npgsql.org/doc/types/datetime.html" rel="nofollow noopener" target="_blank">Npgsqlのドキュメント</a>によれば、.NETでいうところのTimeSpan）なので、時刻を表すのにはちょっと違うかなと考えて除外しました。<br>
また、UNIX時間を<strong>64ビット整数のbigint</strong>としてそのまま格納する方法もあります。それ以外にも、タイムスタンプを<strong>ある一定のフォーマットの文字列TEXT（VARCHAR(N)でもOK）</strong>として（ここでは2001-09-09T10:46:40+09:00のような「ISO 8601形式」を用います）格納する方法もあります。<br>
1つのカラムに1データであることにとらわれない場合は、JSONの中にタイムスタンプを文字列として埋め込んでしまう方法もあります。その場合は、<strong>JSONのバイナリ型であるJSONB</strong>としてカラムを定義し、その中にタイムスタンプの要素を作ります。おそらく文字列の場合と似た挙動になるのではないかなと思います。</p>

<p>したがって、以下の5つのデータ型を調べることになります。</p>

<ol>
<li>タイムゾーンありのTIMESTAMPTZ</li>
<li>タイムゾーンなしのTIMESTAMP</li>
<li>UNIX時間のBIGINT</li>
<li>タイムスタンプの文字列のTEXT</li>
<li>JSONの中にタイムスタンプが入っているJSONB</li>
</ol>

<h2>
<span id="2用意するデータ" class="fragment"></span><a href="#2%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF"><i class="fa fa-link"></i></a>2.用意するデータ</h2>

<p>挿入まではC#で行います。ランダムな並びの整数を日本標準時のUNIX時間として、日付形式に変換し格納します。開始値は10億（UNIX時間で2001/09/09 10:46:40+09:00）とし、一定間隔（この例では31）でUNIX時間の配列を1000万件作成します。これをランダムにシャッフルし、様々なデータ型に変換し、格納してソート時間を比較します。作成したデータを改行区切りのJSONで保存します（格納すれば関係ないので形式はなんでもいいですが、UTF8エンコードでファイルに書き出して7.78GBだったので一気にオンメモリでシリアライズする…的なことをすると死にます）。</p>

<p>データ生成部分はこんな感じにCreateDataというクラスで。Guid.NewGuid()がおおよそユニークな乱数として利用できることから入れ替え時に利用しています。Membership.GeneratePassword()はランダムな128文字の文字列を作るために使っています（これはソートに無関係なデータであり後々使います）。JSONシリアライザーには<a href="https://github.com/ServiceStack/ServiceStack.Text" rel="nofollow noopener" target="_blank">ServiceStack.Text</a>を使っています。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">C#</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Web.Security</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">ServiceStack.Text</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">CreateData</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeData</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">randomEpoch</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">10000000</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="m">1</span><span class="n">e9</span> <span class="p">+</span> <span class="n">x</span> <span class="p">*</span> <span class="m">31</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">()).</span><span class="nf">ToArray</span><span class="p">();</span>

        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="s">"random"</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Write</span><span class="p">))</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">sw</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamWriter</span><span class="p">(</span><span class="n">fs</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">//メモリあふれるので行単位で</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">r</span> <span class="k">in</span> <span class="n">randomEpoch</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RandomData</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">&lt;</span><span class="n">RandomData</span><span class="p">&gt;(</span><span class="n">item</span><span class="p">);</span>
                <span class="n">sw</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">RandomData</span><span class="p">&gt;</span> <span class="nf">ReadData</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="s">"random"</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">sr</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamReader</span><span class="p">(</span><span class="n">fs</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">sr</span><span class="p">.</span><span class="nf">Peek</span><span class="p">()</span> <span class="p">&gt;</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">str</span> <span class="p">=</span> <span class="n">sr</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
                <span class="k">yield</span> <span class="k">return</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">DeserializeFromString</span><span class="p">&lt;</span><span class="n">RandomData</span><span class="p">&gt;(</span><span class="n">str</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">RandomData</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">long</span> <span class="n">UnixEpoch</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">DateTime</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">DateTimeOffset</span> <span class="n">DateTimeOffset</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">TimeStamp</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">RandomString</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> 

    <span class="k">public</span> <span class="nf">RandomData</span><span class="p">()</span>
    <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">RandomData</span><span class="p">(</span><span class="kt">long</span> <span class="n">unixEpoch</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">UnixEpoch</span> <span class="p">=</span> <span class="n">unixEpoch</span><span class="p">;</span>
        <span class="n">DateTimeOffset</span> <span class="p">=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="nf">FromUnixTimeSeconds</span><span class="p">(</span><span class="n">unixEpoch</span><span class="p">).</span><span class="nf">ToLocalTime</span><span class="p">();</span>
        <span class="n">DateTime</span> <span class="p">=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">LocalDateTime</span><span class="p">;</span>
        <span class="n">TimeStamp</span> <span class="p">=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"o"</span><span class="p">);</span>
        <span class="n">RandomString</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">5</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">Membership</span><span class="p">.</span><span class="nf">GeneratePassword</span><span class="p">(</span><span class="m">128</span><span class="p">,</span> <span class="m">0</span><span class="p">)).</span><span class="nf">ToArray</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="nf">ToTimestampOnlyJson</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">ServiceStack</span><span class="p">.</span><span class="n">DynamicJson</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="k">new</span> <span class="p">{</span> <span class="n">timestamp</span> <span class="p">=</span> <span class="n">TimeStamp</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="nf">ToRandomStringContainsJson</span><span class="p">(</span><span class="kt">int</span> <span class="n">takeLength</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">takeLength</span> <span class="p">&lt;=</span> <span class="m">0</span> <span class="p">||</span> <span class="n">takeLength</span> <span class="p">&gt;</span> <span class="n">RandomString</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">ServiceStack</span><span class="p">.</span><span class="n">DynamicJson</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="k">new</span> <span class="p">{</span> <span class="n">timestamp</span> <span class="p">=</span> <span class="n">TimeStamp</span><span class="p">,</span> <span class="n">random_str</span> <span class="p">=</span> <span class="n">RandomString</span><span class="p">.</span><span class="nf">Take</span><span class="p">(</span><span class="n">takeLength</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">()</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>エントリーポイント</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">C#</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">CreateData</span><span class="p">.</span><span class="nf">MakeData</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>本当にランダムなの？ということで最初の10件を表示してみます。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">C#</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">r</span> <span class="k">in</span> <span class="n">CreateData</span><span class="p">.</span><span class="nf">ReadData</span><span class="p">().</span><span class="nf">Take</span><span class="p">(</span><span class="m">10</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">DateTimeOffset</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>2002/05/08 0:26:30 +09:00
2009/03/19 23:54:37 +09:00
2009/08/07 14:22:20 +09:00
2004/11/24 2:39:14 +09:00
2006/10/09 5:30:40 +09:00
2004/05/15 10:20:58 +09:00
2009/05/20 6:37:40 +09:00
2009/05/09 2:31:15 +09:00
2003/10/07 12:49:58 +09:00
2002/12/21 15:33:47 +09:00
</code></pre></div></div>

<p>確かにランダムですね。</p>

<h2>
<span id="3単一カラムのデータテーブルの場合" class="fragment"></span><a href="#3%E5%8D%98%E4%B8%80%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>3.単一カラムのデータテーブルの場合</h2>

<p>日付型のカラムのみで構成される、単一カラムのデータテーブルを作成し、ソートにかかる時間を比較します。次のような定義です。</p>

<table>
<thead>
<tr>
<th>カラム名</th>
<th>制約</th>
<th>型</th>
</tr>
</thead>
<tbody>
<tr>
<td>time</td>
<td>-</td>
<td>TIMESTAMPTZ / TIMESTAMP / BIGINT / TEXT / JSONB</td>
</tr>
</tbody>
</table>

<p>TEXTはVARCHAR(N)でもいいです。PrimaryKeyやインデックスはとりあえずは作りません（後で作ります）。5つの型について比較します。DBの初期設定と起動、データベースの作成を行っておきます。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">&gt;</span>initdb <span class="nt">--encoding</span><span class="o">=</span>UTF8 <span class="nt">--no-locale</span> <span class="nt">--username</span><span class="o">=</span>postgres <span class="nt">--pwprompt</span> <span class="nt">-D</span> <span class="s2">"D:</span><span class="se">\p</span><span class="s2">sql</span><span class="se">\t</span><span class="s2">imeseries"</span>
<span class="gp">&gt;</span>pg_ctl start <span class="nt">-D</span> <span class="s2">"D:</span><span class="se">\p</span><span class="s2">sql</span><span class="se">\t</span><span class="s2">imeseries"</span>
<span class="gp">&gt;</span>psql <span class="nt">-U</span> postgres
<span class="gp">postgres=#</span><span class="w"> </span>CREATE DATABASE foo<span class="p">;</span>
</code></pre></div></div>

<p>Npgsqlによる挿入コードは以下の通り。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">C#</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">Npgsql</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">random</span> <span class="p">=</span> <span class="n">CreateData</span><span class="p">.</span><span class="nf">ReadData</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnectionStringBuilder</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Host</span> <span class="p">=</span> <span class="s">"localhost"</span><span class="p">,</span>
            <span class="n">Port</span> <span class="p">=</span> <span class="m">5432</span><span class="p">,</span>
            <span class="n">Username</span> <span class="p">=</span> <span class="s">"postgres"</span><span class="p">,</span>
            <span class="n">Password</span> <span class="p">=</span> <span class="s">"postgres"</span><span class="p">,</span>
            <span class="n">Database</span> <span class="p">=</span> <span class="s">"foo"</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">con</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">ConnectionString</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">con</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>

            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Connection</span> <span class="p">=</span> <span class="n">con</span><span class="p">;</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">"CREATE TABLE tstz (time TIMESTAMPTZ)"</span><span class="p">;</span>
                <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">"CREATE TABLE ts (time TIMESTAMP)"</span><span class="p">;</span>
                <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">"CREATE TABLE int (time BIGINT)"</span><span class="p">;</span>
                <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">"CREATE TABLE text (time TEXT)"</span><span class="p">;</span>
                <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">"CREATE TABLE json (time JSONB)"</span><span class="p">;</span>
                <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">tables</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"tstz"</span><span class="p">,</span> <span class="s">"ts"</span><span class="p">,</span> <span class="s">"int"</span><span class="p">,</span> <span class="s">"text"</span><span class="p">,</span> <span class="s">"json"</span> <span class="p">};</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">table</span> <span class="k">in</span> <span class="n">tables</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">writer</span> <span class="p">=</span> <span class="n">con</span><span class="p">.</span><span class="nf">BeginBinaryImport</span><span class="p">(</span><span class="s">$"COPY </span><span class="p">{</span><span class="n">table</span><span class="p">}</span><span class="s">(time) FROM STDIN (FORMAT BINARY)"</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">r</span> <span class="k">in</span> <span class="n">random</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">writer</span><span class="p">.</span><span class="nf">StartRow</span><span class="p">();</span>

                        <span class="k">switch</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="c1">//参考：http://www.npgsql.org/doc/types/datetime.html</span>
                            <span class="k">case</span> <span class="s">"tstz"</span><span class="p">:</span>
                                <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">TimestampTZ</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s">"ts"</span><span class="p">:</span>
                                <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s">"int"</span><span class="p">:</span>
                                <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">UnixEpoch</span><span class="p">,</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Bigint</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s">"text"</span><span class="p">:</span>
                                <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">TimeStamp</span><span class="p">,</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s">"json"</span><span class="p">:</span>
                                <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">ToTimestampOnlyJson</span><span class="p">(),</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Jsonb</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>TimestamptzでDateTimeOffsetではなく、DateTimeなのがちょっと直感的ではありませんがこれが仕様のようです（<a href="http://www.npgsql.org/doc/types/datetime.html" rel="nofollow noopener" target="_blank">公式ドキュメント</a>の.NET Native TypeがDateTimeになっています）。Qiitaでも検証している方がいます。</p>

<p>参考：<a href="https://qiita.com/kkino90h/items/147aed6162c82a1022f9" class="autolink" id="reference-9f84870a0b91b67ccbd4">https://qiita.com/kkino90h/items/147aed6162c82a1022f9</a></p>

<h3>
<span id="31-timestamptz型" class="fragment"></span><a href="#31-timestamptz%E5%9E%8B"><i class="fa fa-link"></i></a>3.1 Timestamptz型</h3>

<p>各3回ずつクエリを実行します。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM tstz ORDER BY <span class="nb">time</span><span class="p">;</span>
<span class="go">          time
------------------------
 2001-09-09 10:46:40+09
 2001-09-09 10:47:11+09
 2001-09-09 10:47:42+09
 2001-09-09 10:48:13+09
 2001-09-09 10:48:44+09
 2001-09-09 10:49:15+09
 2001-09-09 10:49:46+09
 2001-09-09 10:50:17+09
 2001-09-09 10:50:48+09
 2001-09-09 10:51:19+09
 2001-09-09 10:51:50+09
 2001-09-09 10:52:21+09
 2001-09-09 10:52:52+09
 2001-09-09 10:53:23+09
 2001-09-09 10:53:54+09
 2001-09-09 10:54:25+09
 2001-09-09 10:54:56+09
 2001-09-09 10:55:27+09
 2001-09-09 10:55:58+09
 2001-09-09 10:56:29+09
 2001-09-09 10:57:00+09
 2001-09-09 10:57:31+09
Time: 24920.397 ms (00:24.920)
Time: 13499.368 ms (00:13.499)
Time: 13439.432 ms (00:13.439)
</span></code></pre></div></div>

<p>1回目と2回目で明らかに速くなっているのはOSのファイルキャッシュなど、何かしらのキャッシュが効いていそうです。条件を切り離すのが難しいですが、キャッシュが効いていないときと効いているときの処理時間がおおよそ比例していればまぁ大丈夫かなと。</p>

<h3>
<span id="32-timestamp型" class="fragment"></span><a href="#32-timestamp%E5%9E%8B"><i class="fa fa-link"></i></a>3.2 Timestamp型</h3>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM ts ORDER BY <span class="nb">time</span><span class="p">;</span>
<span class="go">        time
---------------------
 2001-09-09 10:46:40
（中略）
Time: 21246.412 ms (00:21.246)
Time: 12226.805 ms (00:12.227)
Time: 12429.354 ms (00:12.429)
</span></code></pre></div></div>

<p>タイムゾーンありより若干速そう。</p>

<h3>
<span id="33-bigint型" class="fragment"></span><a href="#33-bigint%E5%9E%8B"><i class="fa fa-link"></i></a>3.3 BigInt型</h3>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM int ORDER BY <span class="nb">time</span><span class="p">;</span>
<span class="go">    time
------------
 1000000000
（略）
Time: 19395.331 ms (00:19.395)
Time: 10748.002 ms (00:10.748)
Time: 10570.828 ms (00:10.571)
</span></code></pre></div></div>

<p>多分これが一番速いはずです。</p>

<h3>
<span id="34-text型" class="fragment"></span><a href="#34-text%E5%9E%8B"><i class="fa fa-link"></i></a>3.4 Text型</h3>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM text ORDER BY <span class="nb">time</span><span class="p">;</span>
<span class="go">               time
-----------------------------------
 2001-09-09T10:46:40.0000000+09:00
（略）
Time: 21323.976 ms (00:21.324)
Time: 16482.135 ms (00:16.482)
Time: 16023.891 ms (00:16.024)
</span></code></pre></div></div>

<p>アンチパターンと言われそうな形。Locale=Cだからまだマシなものの、他のロケールだったらもっとパフォーマンス悪くなると思います。ロケールとソートの速度の関係については下記の記事がとても詳しいです。</p>

<p>参考：<a href="https://qiita.com/fujii_masao/items/2a715fb5a3f718d22ab4" class="autolink" id="reference-2a5664bd8e632991039c">https://qiita.com/fujii_masao/items/2a715fb5a3f718d22ab4</a></p>

<h3>
<span id="35-jsonb型" class="fragment"></span><a href="#35-jsonb%E5%9E%8B"><i class="fa fa-link"></i></a>3.5 JSONB型</h3>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM json ORDER BY time-&gt;&gt;<span class="s1">'timestamp'</span><span class="p">;</span>
<span class="go">                        time
----------------------------------------------------
 {"timestamp": "2001-09-09T10:46:40.0000000+09:00"}
（略）
Time: 21434.557 ms (00:21.435)
Time: 19787.943 ms (00:19.788)
Time: 19867.661 ms (00:19.868)
</span></code></pre></div></div>

<p>JSONながら意外と健闘している！？　<strong>テキストとして取得する-&gt;&gt;演算子ではなく、配列として取得する-&gt;演算子だとソートはできるものの、この2倍ぐらい遅いので</strong>注意してください（気付かずにやり直した）。</p>

<h3>
<span id="単一カラムまとめ" class="fragment"></span><a href="#%E5%8D%98%E4%B8%80%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>単一カラムまとめ</h3>

<p>ちょっとキャッシュ関係が再現性が紛らわしいですが、（明示的にキャッシュをクリアする方法もわからなく、DROP TABLE, DROP DATABASEをして再格納しても1回目の遅い状況を再現できなかった）。各3回の処理時間のうちのTimeの中間値をまとめると次のようになります。</p>

<table>
<thead>
<tr>
<th style="text-align: center">型</th>
<th style="text-align: center">中間値(ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">BIGINT</td>
<td style="text-align: center">10748.002</td>
</tr>
<tr>
<td style="text-align: center">TIMESTAMP</td>
<td style="text-align: center">12429.354</td>
</tr>
<tr>
<td style="text-align: center">TIMESTAMPTZ</td>
<td style="text-align: center">13439.432</td>
</tr>
<tr>
<td style="text-align: center">TEXT</td>
<td style="text-align: center">16482.135</td>
</tr>
<tr>
<td style="text-align: center">JSONB</td>
<td style="text-align: center">19867.661</td>
</tr>
</tbody>
</table>

<p>※1000万件のランダムなタイムスタンプを昇順ソート</p>

<p>大方予想通りの結果になりました。JSONBを除けばTEXT型が最も遅く、日付や時間でフィルタリングする場合に再度パースするオーバーヘッドがつくので、普通は使う意味がないです。JSONBも結局TEXTとして取り出してソートなので、やっていることはそこまで変わらなそう。本格的にやるならタイムスタンプ用のカラムを定義したほうが良さそう（似たような悩みは<a href="https://stackoverflow.com/questions/42968683/postgres-jsonb-timestamp-query-very-slow-compared-to-timestamp-column-query" rel="nofollow noopener" target="_blank">StackOverFlowを見ていたらそこそこ</a>ありました）。<br>
BIGINTは確かに最速ですが、フィルタリングする場合やタイムゾーンがある場合にちょっと面倒になるので、ここでの速度を取るか可読性を取るかはよく検討する必要がありそうです。</p>

<p>各テーブルの容量を取ると次のようになります。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT relname, pg_size_pretty<span class="o">(</span>pg_relation_size<span class="o">(</span>relid<span class="o">))</span> FROM pg_stat_user_tables ORDER BY relid<span class="p">;</span>
<span class="go"> relname | pg_size_pretty
---------+----------------
 tstz    | 346 MB
 ts      | 346 MB
 int     | 346 MB
 text    | 651 MB
 json    | 805 MB
(5 rows)
</span></code></pre></div></div>

<p>JSONBがちょっと特殊ですが、サイズが多いほどソートが遅くなるようです。</p>

<h2>
<span id="4複数カラムのデータテーブルの場合" class="fragment"></span><a href="#4%E8%A4%87%E6%95%B0%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>4.複数カラムのデータテーブルの場合</h2>

<p>3の単一カラムの5ケースを1つのデータテーブルに統合します。</p>

<table>
<thead>
<tr>
<th style="text-align: center">カラム名</th>
<th style="text-align: center">制約</th>
<th style="text-align: center">型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">tstz</td>
<td style="text-align: center">-</td>
<td style="text-align: center">TIMESTAMPTZ</td>
</tr>
<tr>
<td style="text-align: center">ts</td>
<td style="text-align: center">-</td>
<td style="text-align: center">TIMESTAMP</td>
</tr>
<tr>
<td style="text-align: center">int</td>
<td style="text-align: center">-</td>
<td style="text-align: center">BIGINT</td>
</tr>
<tr>
<td style="text-align: center">text</td>
<td style="text-align: center">-</td>
<td style="text-align: center">TEXT</td>
</tr>
<tr>
<td style="text-align: center">json</td>
<td style="text-align: center">-</td>
<td style="text-align: center">JSONB</td>
</tr>
</tbody>
</table>

<p>挿入は以下の通り。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">C#</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">Npgsql</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">random</span> <span class="p">=</span> <span class="n">CreateData</span><span class="p">.</span><span class="nf">ReadData</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnectionStringBuilder</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Host</span> <span class="p">=</span> <span class="s">"localhost"</span><span class="p">,</span>
            <span class="n">Port</span> <span class="p">=</span> <span class="m">5432</span><span class="p">,</span>
            <span class="n">Username</span> <span class="p">=</span> <span class="s">"postgres"</span><span class="p">,</span>
            <span class="n">Password</span> <span class="p">=</span> <span class="s">"postgres"</span><span class="p">,</span>
            <span class="n">Database</span> <span class="p">=</span> <span class="s">"foo"</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">con</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">ConnectionString</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">con</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>

            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Connection</span> <span class="p">=</span> <span class="n">con</span><span class="p">;</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">"CREATE TABLE multi ("</span> <span class="p">+</span>
                    <span class="s">"tstz TIMESTAMPTZ,"</span> <span class="p">+</span>
                    <span class="s">"ts TIMESTAMP,"</span> <span class="p">+</span>
                    <span class="s">"int BIGINT,"</span> <span class="p">+</span>
                    <span class="s">"text TEXT,"</span> <span class="p">+</span>
                    <span class="s">"json JSONB)"</span><span class="p">;</span>
                <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">writer</span> <span class="p">=</span> <span class="n">con</span><span class="p">.</span><span class="nf">BeginBinaryImport</span><span class="p">(</span><span class="s">"COPY multi(tstz, ts, int, text, json) FROM STDIN (FORMAT BINARY)"</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">r</span> <span class="k">in</span> <span class="n">random</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">writer</span><span class="p">.</span><span class="nf">StartRow</span><span class="p">();</span>
                    <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">TimestampTZ</span><span class="p">);</span>
                    <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">);</span>
                    <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">UnixEpoch</span><span class="p">,</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Bigint</span><span class="p">);</span>
                    <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">TimeStamp</span><span class="p">,</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>
                    <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">ToTimestampOnlyJson</span><span class="p">(),</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Jsonb</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="41-複数カラムの場合のソート" class="fragment"></span><a href="#41-%E8%A4%87%E6%95%B0%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%BD%E3%83%BC%E3%83%88"><i class="fa fa-link"></i></a>4.1 複数カラムの場合のソート</h3>

<p>単一の場合最速だったBigIntと、中間だったTimstamptz、最も遅かったJsonbの比較を行います。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi ORDER BY tstz<span class="p">;</span>
<span class="go">          tstz          |         ts          |    int     |               text
               |                        json
------------------------+---------------------+------------+--------------------
---------------+----------------------------------------------------
 2001-09-09 10:46:40+09 | 2001-09-09 01:46:40 | 1000000000 | 2001-09-09T10:46:40
.0000000+09:00 | {"timestamp": "2001-09-09T10:46:40.0000000+09:00"}
（略）
Time: 67700.814 ms (01:07.701)
Time: 33956.836 ms (00:33.957)
Time: 35280.877 ms (00:35.281)

</span><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi ORDER BY int<span class="p">;</span>
<span class="go">Time: 37101.919 ms (00:37.102)
Time: 36413.210 ms (00:36.413)
Time: 36367.728 ms (00:36.368)

</span><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi ORDER BY json-&gt;&gt;<span class="s1">'timestamp'</span><span class="p">;</span>
<span class="go">Time: 40122.308 ms (00:40.122)
Time: 41672.883 ms (00:41.673)
Time: 41480.865 ms (00:41.481)
</span></code></pre></div></div>

<p>レコードあたりのサイズが大きくなっている分ソートに時間がかかっていますが、遅い型でソートしたときに遅くなるのはやはり変わらない模様（BigIntとTimestamptzが逆転しているのが謎）。Timestamptzの初回だけ遅くなっているのはやはり何らかのキャッシュが関係してそうですね。</p>

<p>データテーブルの容量を取ります。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="go"> relname | pg_size_pretty
---------+----------------
 tstz    | 346 MB
 ts      | 346 MB
 int     | 346 MB
 text    | 651 MB
 json    | 805 MB
 multi   | 1420 MB
(6 rows)
</span></code></pre></div></div>

<p>tstz～jsonの単純合計とはならなかったのが興味深いですが、容量に比例してソートは遅くなっています。</p>

<h3>
<span id="42-インデックスを張る" class="fragment"></span><a href="#42-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E5%BC%B5%E3%82%8B"><i class="fa fa-link"></i></a>4.2 インデックスを張る</h3>

<p>今までずっとインデックスを張ってきませんでしたが、multiテーブルのtstzカラム（Timestamptz）に対してインデックスを張ってみます。インデックスを張らない状態と張った状態で2005年のデータを抽出し、WHEREを比較します。</p>

<h4>
<span id="インデックス張らない場合" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E5%BC%B5%E3%82%89%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>インデックス張らない場合</h4>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi WHERE tstz <span class="o">&gt;=</span> timestamptz <span class="s1">'2005-01-01 00:00:00+09'</span> AND
<span class="gp"> tstz &lt; timestamptz '2006-01-01 00:00:00';</span><span class="w">
</span><span class="go">          tstz          |         ts          |    int     |               text
               |                        json
------------------------+---------------------+------------+--------------------
---------------+----------------------------------------------------
 2005-10-21 15:31:38+09 | 2005-10-21 15:31:38 | 1129876298 | 2005-10-21T15:31:38
.0000000+09:00 | {"timestamp": "2005-10-21T15:31:38.0000000+09:00"}
 2005-09-08 06:54:32+09 | 2005-09-08 06:54:32 | 1126130072 | 2005-09-08T06:54:32
.0000000+09:00 | {"timestamp": "2005-09-08T06:54:32.0000000+09:00"}
 2005-05-30 03:46:52+09 | 2005-05-30 03:46:52 | 1117392412 | 2005-05-30T03:46:52
.0000000+09:00 | {"timestamp": "2005-05-30T03:46:52.0000000+09:00"}
 2005-04-27 10:03:06+09 | 2005-04-27 10:03:06 | 1114563786 | 2005-04-27T10:03:06
.0000000+09:00 | {"timestamp": "2005-04-27T10:03:06.0000000+09:00"}
 2005-06-21 00:40:48+09 | 2005-06-21 00:40:48 | 1119282048 | 2005-06-21T00:40:48
.0000000+09:00 | {"timestamp": "2005-06-21T00:40:48.0000000+09:00"}
 2005-12-22 11:47:55+09 | 2005-12-22 11:47:55 | 1135219675 | 2005-12-22T11:47:55
.0000000+09:00 | {"timestamp": "2005-12-22T11:47:55.0000000+09:00"}
 2005-01-08 02:51:27+09 | 2005-01-08 02:51:27 | 1105120287 | 2005-01-08T02:51:27
.0000000+09:00 | {"timestamp": "2005-01-08T02:51:27.0000000+09:00"}
 2005-09-13 03:43:38+09 | 2005-09-13 03:43:38 | 1126550618 | 2005-09-13T03:43:38
.0000000+09:00 | {"timestamp": "2005-09-13T03:43:38.0000000+09:00"}
 2005-06-26 14:37:33+09 | 2005-06-26 14:37:33 | 1119764253 | 2005-06-26T14:37:33
.0000000+09:00 | {"timestamp": "2005-06-26T14:37:33.0000000+09:00"}
 2005-06-20 05:22:57+09 | 2005-06-20 05:22:57 | 1119212577 | 2005-06-20T05:22:57
.0000000+09:00 | {"timestamp": "2005-06-20T05:22:57.0000000+09:00"}
Time: 4883.846 ms (00:04.884)
</span></code></pre></div></div>

<h4>
<span id="インデックスを張った場合" class="fragment"></span><a href="#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E5%BC%B5%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>インデックスを張った場合</h4>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX tstz_idx ON multi<span class="o">(</span>tstz<span class="o">)</span><span class="p">;</span>
<span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi WHERE tstz <span class="o">&gt;=</span> timestamptz <span class="s1">'2005-01-01 00:00:00+09'</span> AND
<span class="gp"> tstz &lt; timestamptz '2006-01-01 00:00:00';</span><span class="w">
</span><span class="go">Time: 5253.525 ms (00:05.254)
Time: 5269.091 ms (00:05.269)

</span><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi ORDER BY tstz<span class="p">;</span>
<span class="go">Time: 222606.614 ms (03:42.607)

</span><span class="gp">foo=#</span><span class="w"> </span>DROP INDEX tstz_idx<span class="p">;</span>
<span class="go">DROP INDEX
</span><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi ORDER BY tstz<span class="p">;</span>
<span class="go">Time: 34338.246 ms (00:34.338)
</span></code></pre></div></div>

<p><strong>あれ、インデックスを張ると遅くなってる！？</strong>WHEREが4.8秒→5.2秒と若干遅くなり、フルソートが最悪で34秒→3分42秒と大幅に悪化しました。ただEXPLAIN ANALYZEで分析してみると、インデックスを張ったほうが総コストは下がっています。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>EXPLAIN ANALYZE SELECT <span class="k">*</span> FROM multi ORDER BY tstz<span class="p">;</span>
<span class="gp">#</span>インデックスなしの場合
<span class="go">                                                                QUERY PLAN

--------------------------------------------------------------------------------
----------------------------------------------------------
 Gather Merge  (cost=1195321.36..2167611.54 rows=8333334 width=113) (actual time
=5736.849..9649.220 rows=10000000 loops=1)
   Workers Planned: 2
   Workers Launched: 2
</span><span class="gp">   -&gt;</span><span class="w">  </span>Sort  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>1194321.34..1204738.00 <span class="nv">rows</span><span class="o">=</span>4166667 <span class="nv">width</span><span class="o">=</span>113<span class="o">)</span> <span class="o">(</span>actual <span class="nb">time</span><span class="o">=</span>5
<span class="go">478.435..6237.954 rows=3333333 loops=3)
         Sort Key: tstz
         Sort Method: external merge  Disk: 462648kB
</span><span class="gp">         -&gt;</span><span class="w">  </span>Parallel Seq Scan on multi  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>0.00..223485.67 <span class="nv">rows</span><span class="o">=</span>4166667 widt
<span class="go">h=113) (actual time=0.353..1055.199 rows=3333333 loops=3)
 Planning time: 0.096 ms
 Execution time: 10008.774 ms
(9 rows)

</span><span class="gp">#</span>インデックスありの場合
<span class="go">                                                                QUERY PLAN

--------------------------------------------------------------------------------
----------------------------------------------------------
 Index Scan using tstz_idx on multi  (cost=0.44..986963.25 rows=10000000 width=1
13) (actual time=0.168..184216.684 rows=10000000 loops=1)
 Planning time: 1.685 ms
 Execution time: 184658.639 ms
(3 rows)
</span></code></pre></div></div>

<p>処理時間は34秒→3分42秒と悪化しているのに、総コストは216万→98万と改善しています。</p>

<p><strong>インデックスが激遅になってしまうのは、シャッフルされたカラムに対してインデックスを張ったのが原因</strong>だったようです（後述）。そもそも論でこんなランダムな日付のデータをデータベースに突っ込むべきではないし、突っ込むにしてもソートしてから突っ込むべきですよね。</p>

<p>インデックスなしの場合に「Workers Launched: 2」という並列化のようなもの（パラレルスキャンというそうです）が自動でなされているのも興味深いです。今のPostgreSQLはとてもお利口なので、インデックスなしの1000万件をソートするとかいうアホなクエリを書いても、自動でいろいろチューニングしてくれるのでしょう。なので、この例ではたまたまそうでしたが、インデックスないほうが処理が速く終わるというのは、かなり特殊な状況と認識しておいたほうがよさそうです。EXPLAIN ANALYZEでの総コスト値はインデックスがあったほうが少ないので。</p>

<p>インデックスの明確なデメリットはあります。以下、インデックスがある場合、ない場合での<a href="https://www.postgresql.jp/document/8.1/html/functions-admin.html" rel="nofollow noopener" target="_blank">pg_total_relation_size</a>（インデックス込みのバイト数）です。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre class="with-code"><code>foo=# SELECT relname, pg_size_pretty(pg_total_relation_size(relid)) FROM pg_stat
_user_tables WHERE relname = 'multi';
 relname | pg_size_pretty
---------+----------------
 multi   | 1635 MB
(1 row)

foo=# DROP INDEX tstz_idx;
foo=# SELECT relname, pg_size_pretty(pg_total_relation_size(relid)) FROM pg_stat
_user_tables WHERE relname = 'multi';
 relname | pg_size_pretty
---------+----------------
 multi   | 1421 MB
(1 row)
</code></pre></div></div>

<p>インデックスだけで200MB以上使用しています。乱用は厳禁です。INDEXをUNIQUE INDEXにしてみましたが、大して変わらなかったので省略します。</p>

<h3>
<span id="42-プライマリーキーを張る" class="fragment"></span><a href="#42-%E3%83%97%E3%83%A9%E3%82%A4%E3%83%9E%E3%83%AA%E3%83%BC%E3%82%AD%E3%83%BC%E3%82%92%E5%BC%B5%E3%82%8B"><i class="fa fa-link"></i></a>4.2 プライマリーキーを張る</h3>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>ALTER TABLE multi ADD PRIMARY KEY<span class="o">(</span>tstz<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>一旦インデックスを削除し、プライマリーキーを張ってみました。結果はインデックスの場合と変わらなかったので省略します。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>ALTER TABLE multi DROP CONSTRAINT multi_pkey<span class="p">;</span>
</code></pre></div></div>

<h3>
<span id="43-インデックスはシャッフルされたデータが苦手" class="fragment"></span><a href="#43-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%AF%E3%82%B7%E3%83%A3%E3%83%83%E3%83%95%E3%83%AB%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E8%8B%A6%E6%89%8B"><i class="fa fa-link"></i></a>4.3 インデックスはシャッフルされたデータが苦手？</h3>

<p>追加で実験してみたところ興味深いことがわかりました。先程の「SELECT * FROM multi ORDER BY tstz」というソートですが、一旦ソートしてから別のテーブルに格納し、同じようにソートしてみます（後半の場合のソートは事実上意味がない）。そしてその時間をインデックスあり・なしで比較します。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>CREATE TABLE multi2 AS SELECT <span class="k">*</span> FROM multi ORDER BY tstz<span class="p">;</span>
</code></pre></div></div>

<p>このようにソート済みのテーブルmulti2を作ります。インデックスなしでソートすると次のようになります。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi2 ORDER BY tstz<span class="p">;</span>
<span class="go">Time: 39986.190 ms (00:39.986)
Time: 34903.614 ms (00:34.904)
Time: 33085.059 ms (00:33.085)
</span></code></pre></div></div>

<p>インデックスなしの場合は、<strong>未ソートのテーブルmultiの場合とほぼ変わりません。</strong>未ソートの場合は、インデックスを作成すると大幅にパフォーマンスが悪化（34秒→3分42秒）しましたが、ソート済みテーブルの場合はどうでしょうか？</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX tstz_idx ON multi2<span class="o">(</span>tstz<span class="o">)</span><span class="p">;</span>
<span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi2 ORDER BY tstz<span class="p">;</span>
<span class="go">Time: 30379.679 ms (00:30.380)
Time: 30317.588 ms (00:30.318)
</span></code></pre></div></div>

<p><strong>格納時にソートすることでインデックススキャンが速くなりました！　</strong>ソート済みの場合は、インデックス未作成の場合よりフルソートでも3～4秒速くなりました。これがインデックスの本来のパフォーマンスでしょう。詳細は省略してしまいましたが、WHEREによる比較もインデックスがない場合より速くなりました（1年分を抽出するので時間が半分に）。</p>

<p>PostgreSQL（SQL全般）のデフォルトのインデックスに、<a href="https://www.postgresql.jp/document/9.0/html/indexes-types.html" rel="nofollow noopener" target="_blank">Btree</a>とよばれるデータ構造を使用しています。これが2分探索木に近いデータ構造であるため、ソートされたデータに対してインデックスを張ったほうが明らかにパフォーマンスが良いです。なるほど、これはいい勉強になりました。</p>

<p>EXPLAIN ANALYZEでも確認してみます。multiが未ソート、multi2が事前にソート済みです。multi2はソート後にインデックスを張り、multiはソート前にインデックスを張ってソートのクエリをEXPLAIN ANALYZEをします。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX tstz_index ON multi<span class="o">(</span>tstz<span class="o">)</span><span class="p">;</span>
<span class="go">CREATE INDEX
Time: 13162.883 ms (00:13.163)
</span><span class="gp">foo=#</span><span class="w"> </span>EXPLAIN ANALYZE SELECT <span class="k">*</span> FROM multi ORDER BY tstz<span class="p">;</span>
<span class="go">                                                                 QUERY PLAN

--------------------------------------------------------------------------------
------------------------------------------------------------
 Index Scan using tstz_index on multi  (cost=0.44..986963.25 rows=10000000 width
=113) (actual time=0.090..189174.966 rows=10000000 loops=1)
 Planning time: 1.310 ms
 Execution time: 189723.607 ms
(3 rows)

</span><span class="gp">#</span><span class="c">###</span>
<span class="go">
</span><span class="gp">foo=#</span><span class="w"> </span>EXPLAIN ANALYZE SELECT <span class="k">*</span> FROM multi2 ORDER BY tstz<span class="p">;</span>
<span class="go">                                                               QUERY PLAN

--------------------------------------------------------------------------------
---------------------------------------------------------
 Index Scan using tstz_idx on multi2  (cost=0.44..441510.44 rows=10000000 width=
113) (actual time=0.101..2790.953 rows=10000000 loops=1)
 Planning time: 0.065 ms
 Execution time: 2949.663 ms
(3 rows)
</span></code></pre></div></div>

<p>どちらもIndex Scanが用いられています。総コストを見ると、multi2（ソート済み）が44万であるのに対して、multi（未ソート）は倍以上の98万です。ソート済みだから当たり前だろうと思うかもしれませんが、<strong>Seq Scanの場合はソートの有無にかかわらず総コストは変わりませんでした</strong>。どちらもインデックスを外してもう一度EXPLAIN ANALYZEしてみます。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>DROP INDEX tstz_idx<span class="p">;</span>
<span class="gp">foo=#</span><span class="w"> </span>DROP INDEX tstz_index<span class="p">;</span>
<span class="gp">foo=#</span><span class="w"> </span>EXPLAIN ANALYZE SELECT <span class="k">*</span> FROM multi ORDER BY tstz<span class="p">;</span>
<span class="go">                                                                 QUERY PLAN

--------------------------------------------------------------------------------
------------------------------------------------------------
 Gather Merge  (cost=1195321.36..2167611.54 rows=8333334 width=113) (actual time
=22250.940..26635.054 rows=10000000 loops=1)
   Workers Planned: 2
   Workers Launched: 2
</span><span class="gp">   -&gt;</span><span class="w">  </span>Sort  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>1194321.34..1204738.00 <span class="nv">rows</span><span class="o">=</span>4166667 <span class="nv">width</span><span class="o">=</span>113<span class="o">)</span> <span class="o">(</span>actual <span class="nb">time</span><span class="o">=</span>2
<span class="go">1821.372..22626.747 rows=3333333 loops=3)
         Sort Key: tstz
         Sort Method: external merge  Disk: 439040kB
</span><span class="gp">         -&gt;</span><span class="w">  </span>Parallel Seq Scan on multi  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>0.00..223485.67 <span class="nv">rows</span><span class="o">=</span>4166667 widt
<span class="go">h=113) (actual time=10.119..17335.576 rows=3333333 loops=3)
 Planning time: 0.049 ms
 Execution time: 26895.805 ms
(9 rows)
Time: 26897.545 ms (00:26.898)

</span><span class="gp">#</span><span class="c">###</span>
<span class="gp">foo=#</span><span class="w"> </span>EXPLAIN ANALYZE SELECT <span class="k">*</span> FROM multi2 ORDER BY tstz<span class="p">;</span>
<span class="go">                                                                QUERY PLAN

--------------------------------------------------------------------------------
-----------------------------------------------------------
 Gather Merge  (cost=1195321.36..2167611.54 rows=8333334 width=113) (actual time
=3775.550..7609.507 rows=10000000 loops=1)
   Workers Planned: 2
   Workers Launched: 2
</span><span class="gp">   -&gt;</span><span class="w">  </span>Sort  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>1194321.34..1204738.00 <span class="nv">rows</span><span class="o">=</span>4166667 <span class="nv">width</span><span class="o">=</span>113<span class="o">)</span> <span class="o">(</span>actual <span class="nb">time</span><span class="o">=</span>3
<span class="go">705.071..4224.302 rows=3333333 loops=3)
         Sort Key: tstz
         Sort Method: external sort  Disk: 502600kB
</span><span class="gp">         -&gt;</span><span class="w">  </span>Parallel Seq Scan on multi2  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>0.00..223485.67 <span class="nv">rows</span><span class="o">=</span>4166667 wid
<span class="go">th=113) (actual time=0.234..1517.535 rows=3333333 loops=3)
 Planning time: 9.965 ms
 Execution time: 8770.950 ms
(9 rows)
Time: 8781.462 ms (00:08.781)
</span></code></pre></div></div>

<h3>
<span id="44-レコードのソート状態とシーケンシャルソートの速度をcで比較" class="fragment"></span><a href="#44-%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E3%82%BD%E3%83%BC%E3%83%88%E7%8A%B6%E6%85%8B%E3%81%A8%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B7%E3%83%A3%E3%83%AB%E3%82%BD%E3%83%BC%E3%83%88%E3%81%AE%E9%80%9F%E5%BA%A6%E3%82%92c%E3%81%A7%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>4.4 レコードのソート状態とシーケンシャルソートの速度をC#で比較</h3>

<p>4.3ではコンソールを用いて、レコードのソートの有無とシーケンシャルソートの実行時間がほとんど変わらないということを確認しましたが、さすがにそれは腑に落ちないのでC#（Npgsql）側でも確認してみます。<br>
なぜ腑に落ちないのかというと、ソート済みのテーブルで「SELECT * FROM テーブルORDER BY ソート済みカラム」をやったとしても、やっていることは実質的に「SELECT * FROM テーブル」と変わらないからです。つまり、ソート済みのテーブルと未ソートのテーブルで、結果的にORDER BYの処理時間が無視できる…さすがにそれはないだろう。となったわけです。</p>

<p>まず、multiから以下のような4つの派生テーブルを作ります。</p>

<table>
<thead>
<tr>
<th style="text-align: center">ソート</th>
<th style="text-align: center">インデックス</th>
<th style="text-align: center">テーブル名</th>
<th style="text-align: center">CREATE TABLE … AS</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">×</td>
<td style="text-align: center">×</td>
<td style="text-align: center">multi_nosorted_noindex</td>
<td style="text-align: center">SELECT * FROM multi</td>
</tr>
<tr>
<td style="text-align: center">×</td>
<td style="text-align: center">○</td>
<td style="text-align: center">multi_nosorted_withindex</td>
<td style="text-align: center">SELECT * FROM multi</td>
</tr>
<tr>
<td style="text-align: center">○</td>
<td style="text-align: center">×</td>
<td style="text-align: center">multi_sorted_noindex</td>
<td style="text-align: center">SELECT * FROM multi ORDER BY tstz</td>
</tr>
<tr>
<td style="text-align: center">○</td>
<td style="text-align: center">○</td>
<td style="text-align: center">multi_sorted_withindex</td>
<td style="text-align: center">SELECT * FROM multi ORDER BY tstz</td>
</tr>
</tbody>
</table>

<p>インデックスには各テーブルのtstz（Timestamptz）を使います。まず、スキャンの方式ですが、SELECT * FROM テーブル（全レコードスキャン）は、EXPLAIN ANALYZEで確認したところインデックスの有無にかかわらずSeq Scanが用いられました。ORDER BYを用いると、インデックスありの場合はIndex Scanになり、インデックスなしの場合はSeq Scanとなりました。スキャン方式をまとめると次のようになります。</p>

<table>
<thead>
<tr>
<th style="text-align: center">ソート</th>
<th style="text-align: center">インデックス</th>
<th style="text-align: center">テーブル名</th>
<th style="text-align: center">SELECT *</th>
<th style="text-align: center">SELECT * … ORDER BY</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">×</td>
<td style="text-align: center">×</td>
<td style="text-align: center">multi_nosorted_noindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">Seq</td>
</tr>
<tr>
<td style="text-align: center">×</td>
<td style="text-align: center">○</td>
<td style="text-align: center">multi_nosorted_withindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">Index</td>
</tr>
<tr>
<td style="text-align: center">○</td>
<td style="text-align: center">×</td>
<td style="text-align: center">multi_sorted_noindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">Seq</td>
</tr>
<tr>
<td style="text-align: center">○</td>
<td style="text-align: center">○</td>
<td style="text-align: center">multi_sorted_withindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">Index</td>
</tr>
</tbody>
</table>

<p>4テーブルに対して、「SELECT *　FROM テーブル」と「SELECT *　FROM テーブル ORDER BY tstz」の2つのクエリをC#側から行い、実行時間を比較します。</p>

<h4>
<span id="select--from-テーブル" class="fragment"></span><a href="#select--from-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB"><i class="fa fa-link"></i></a>SELECT * FROM テーブル</h4>

<table>
<thead>
<tr>
<th style="text-align: center">ソート</th>
<th style="text-align: center">インデックス</th>
<th style="text-align: center">テーブル名</th>
<th style="text-align: center">スキャン方式</th>
<th style="text-align: center">中間値[ms]</th>
<th style="text-align: center">平均値[ms]</th>
<th style="text-align: center">1回目</th>
<th style="text-align: center">2回目</th>
<th style="text-align: center">3回目</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">×</td>
<td style="text-align: center">×</td>
<td style="text-align: center">multi_nosorted_noindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">13,306.42</td>
<td style="text-align: center">13,211.07</td>
<td style="text-align: center">13,306.42</td>
<td style="text-align: center">12,816.77</td>
<td style="text-align: center">13,510.03</td>
</tr>
<tr>
<td style="text-align: center">×</td>
<td style="text-align: center">○</td>
<td style="text-align: center">multi_nosorted_withindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">13,297.97</td>
<td style="text-align: center">13,560.73</td>
<td style="text-align: center">13,297.97</td>
<td style="text-align: center">14,098.73</td>
<td style="text-align: center">13,285.48</td>
</tr>
<tr>
<td style="text-align: center">○</td>
<td style="text-align: center">×</td>
<td style="text-align: center">multi_sorted_noindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">14,412.15</td>
<td style="text-align: center">14,249.22</td>
<td style="text-align: center">14,412.15</td>
<td style="text-align: center">13,885.87</td>
<td style="text-align: center">14,449.65</td>
</tr>
<tr>
<td style="text-align: center">○</td>
<td style="text-align: center">○</td>
<td style="text-align: center">multi_sorted_withindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">13,850.53</td>
<td style="text-align: center">14,060.40</td>
<td style="text-align: center">13,850.53</td>
<td style="text-align: center">14,483.26</td>
<td style="text-align: center">13,847.42</td>
</tr>
</tbody>
</table>

<p>どれもほぼ変わりません。全部シーケンシャルスキャンだからそれはそう。</p>

<h4>
<span id="select-from-テーブル-order-by-tstz" class="fragment"></span><a href="#select-from-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB-order-by-tstz"><i class="fa fa-link"></i></a>SELECT *　FROM テーブル ORDER BY tstz</h4>

<table>
<thead>
<tr>
<th style="text-align: center">ソート</th>
<th style="text-align: center">インデックス</th>
<th style="text-align: center">テーブル名</th>
<th style="text-align: center">スキャン方式</th>
<th style="text-align: center">中間値[ms]</th>
<th style="text-align: center">平均値[ms]</th>
<th style="text-align: center">1回目</th>
<th style="text-align: center">2回目</th>
<th style="text-align: center">3回目</th>
<th style="text-align: center">4回目</th>
<th style="text-align: center">5回目</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">×</td>
<td style="text-align: center">×</td>
<td style="text-align: center">multi_nosorted_noindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">21,643.11</td>
<td style="text-align: center">21,527.77</td>
<td style="text-align: center">21,875.27</td>
<td style="text-align: center">21,276.25</td>
<td style="text-align: center">21,643.11</td>
<td style="text-align: center">20,707.07</td>
<td style="text-align: center">22,137.14</td>
</tr>
<tr>
<td style="text-align: center">×</td>
<td style="text-align: center">○</td>
<td style="text-align: center">multi_nosorted_withindex</td>
<td style="text-align: center">Index</td>
<td style="text-align: center">225,930.34</td>
<td style="text-align: center">229,355.78</td>
<td style="text-align: center">213,420.65</td>
<td style="text-align: center">217,755.75</td>
<td style="text-align: center">225,930.34</td>
<td style="text-align: center">246,658.27</td>
<td style="text-align: center">243,013.88</td>
</tr>
<tr>
<td style="text-align: center">○</td>
<td style="text-align: center">×</td>
<td style="text-align: center">multi_sorted_noindex</td>
<td style="text-align: center">Seq</td>
<td style="text-align: center">25,633.70</td>
<td style="text-align: center">27,572.08</td>
<td style="text-align: center">37,830.12</td>
<td style="text-align: center">28,122.39</td>
<td style="text-align: center">25,633.70</td>
<td style="text-align: center">21,681.04</td>
<td style="text-align: center">24,593.16</td>
</tr>
<tr>
<td style="text-align: center">○</td>
<td style="text-align: center">○</td>
<td style="text-align: center">multi_sorted_withindex</td>
<td style="text-align: center">Index</td>
<td style="text-align: center">16,489.44</td>
<td style="text-align: center">16,572.41</td>
<td style="text-align: center">18,633.70</td>
<td style="text-align: center">16,489.44</td>
<td style="text-align: center">15,672.30</td>
<td style="text-align: center">16,515.13</td>
<td style="text-align: center">15,551.51</td>
</tr>
</tbody>
</table>

<p><strong>ソート×、インデックス○な場合だけ桁が違います</strong>。これはコンソールの場合と同じです。インデックス×、ソートの有無でソートの速度が違うかというと、見た目はソート○のほうが遅いという謎な結果ですが、初回は特に外れ値のように遅いので、ディスクアクセスやキャッシュの誤差の範囲内かと考えられます。ソート済みのほうが遅くなるというのはEXPLAIN ANALYZEからも説明できません。したがって、シーケンシャルなソートにおいて、事前ソートの有無はパフォーマンスに影響を与えるということを確認できなかったといえるでしょう。</p>

<p>4.4の冒頭の疑問は解決しませんでしたが、コンソールからやってもアプリケーションからやっても同じ結果になるのはまあそういうものであると受け止めるしかありません。</p>

<p>C#でのコードは以下の通りです。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">C#</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">Npgsql</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">IndexBenchmark</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MultiTableBenchmarck</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnectionStringBuilder</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Host</span> <span class="p">=</span> <span class="s">"localhost"</span><span class="p">,</span>
            <span class="n">Port</span> <span class="p">=</span> <span class="m">5432</span><span class="p">,</span>
            <span class="n">Username</span> <span class="p">=</span> <span class="s">"postgres"</span><span class="p">,</span>
            <span class="n">Password</span> <span class="p">=</span> <span class="s">"postgres"</span><span class="p">,</span>
            <span class="n">Database</span> <span class="p">=</span> <span class="s">"foo"</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">con</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">ConnectionString</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">con</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">tables</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"multi_nosorted_noindex"</span><span class="p">,</span> <span class="s">"multi_nosorted_withindex"</span><span class="p">,</span> <span class="s">"multi_sorted_noindex"</span><span class="p">,</span> <span class="s">"multi_sorted_withindex"</span> <span class="p">};</span>

            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Connection</span> <span class="p">=</span> <span class="n">con</span><span class="p">;</span>

                <span class="kt">var</span> <span class="n">sw</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Stopwatch</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>

                <span class="c1">//SELECT *　FROM テーブル(各3回)</span>
                <span class="n">result</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">"--- SELECT *　FROM テーブル ---"</span><span class="p">);</span>
                <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">table</span> <span class="k">in</span> <span class="n">tables</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">result</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
                    <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="k">in</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">3</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="n">sw</span><span class="p">.</span><span class="nf">Restart</span><span class="p">();</span>
                        <span class="n">cmd</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">$"SELECT * FROM </span><span class="p">{</span><span class="n">table</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
                        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteReader</span><span class="p">())</span>
                        <span class="p">{</span>
                            <span class="k">while</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">Read</span><span class="p">())</span> <span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">sw</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
                        <span class="n">result</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">sw</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">result</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">();</span>

                <span class="c1">//SELECT * FROM テーブル ORDER BY tstz(各5回)</span>
                <span class="n">result</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">"--- SELECT *　FROM テーブル ORDER BY tstz---"</span><span class="p">);</span>
                <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">table</span> <span class="k">in</span> <span class="n">tables</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">result</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
                    <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="k">in</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">5</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="n">sw</span><span class="p">.</span><span class="nf">Restart</span><span class="p">();</span>
                        <span class="n">cmd</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">$"SELECT * FROM </span><span class="p">{</span><span class="n">table</span><span class="p">}</span><span class="s"> ORDER BY tstz"</span><span class="p">;</span>
                        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteReader</span><span class="p">())</span>
                        <span class="p">{</span>
                            <span class="k">while</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">Read</span><span class="p">())</span> <span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">sw</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
                        <span class="n">result</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">sw</span><span class="p">.</span><span class="n">Elapsed</span><span class="p">.</span><span class="n">TotalMilliseconds</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="c1">//結果の保存</span>
                <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="nf">WriteAllText</span><span class="p">(</span><span class="s">"indexbench.txt"</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="45-インデックスの有無とデータ型" class="fragment"></span><a href="#45-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%AE%E6%9C%89%E7%84%A1%E3%81%A8%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B"><i class="fa fa-link"></i></a>4.5 インデックスの有無とデータ型</h3>

<p>単一カラムの場合はデータ型によってシーケンシャルスキャンの遅い速いがありましたが、これはインデックスがあった場合でも同様になるのでしょうか？<br>
tstz（TIMESTAMPTZ型）についてソート済みであるmulti_tstz、int（BIGINT型）についてソート済みのmulti_int、jsonカラム（JSONB型）のtimestampフィールドについてソート済みであるmulti_jsonの各3つのテーブルを作成します。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>CREATE TABLE multi_tstz AS SELECT <span class="k">*</span> FROM multi ORDER BY tstz<span class="p">;</span>
<span class="gp">foo=#</span><span class="w"> </span>CREATE TABLE multi_int AS SELECT <span class="k">*</span> FROM multi ORDER BY int<span class="p">;</span>
<span class="gp">foo=#</span><span class="w"> </span>CREATE TABLE multi_json AS SELECT <span class="k">*</span> FROM multi ORDER BY json-&gt;&gt;<span class="s1">'timestamp'</span><span class="p">;</span>
</code></pre></div></div>

<p>4.3～4.4で事前にソート済みかどうかが、シーケンシャルなソートにおけるパフォーマンスに影響を及ぼさないであろうということがわかったので、この状態でソート操作を行い、インデックスの有無による処理時間を見ます。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">#</span><span class="w"> </span>これを3回
<span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi_tstz ORDER BY tstz<span class="p">;</span>
<span class="gp">#</span><span class="w"> </span>インデックスを作る
<span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX multi_tstz_index ON multi_tstz<span class="o">(</span>tstz<span class="o">)</span><span class="p">;</span>
<span class="gp">#</span><span class="w"> </span>インデックススキャンを3回
<span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi_tstz ORDER BY tstz<span class="p">;</span>
</code></pre></div></div>

<p>以下同様。JSONBのmulti_jsonのインデックス作成はちょっと特殊で、同じくBtreeインデックスを利用しますが、フィールドを()でくくります。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX multi_json_index ON multi_json<span class="o">((</span>json-&gt;&gt;<span class="s1">'timestamp'</span><span class="o">))</span><span class="p">;</span>
</code></pre></div></div>

<p>結果は以下の通り。</p>

<table>
<thead>
<tr>
<th style="text-align: center">ORDER / SeqScan [ms]</th>
<th style="text-align: center">tstz</th>
<th style="text-align: center">int</th>
<th style="text-align: center">json</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1回目</td>
<td style="text-align: center">34,536.86</td>
<td style="text-align: center">39,183.36</td>
<td style="text-align: center">44,027.67</td>
</tr>
<tr>
<td style="text-align: center">2回目</td>
<td style="text-align: center">29,900.62</td>
<td style="text-align: center">29,980.37</td>
<td style="text-align: center">32,915.02</td>
</tr>
<tr>
<td style="text-align: center">3回目</td>
<td style="text-align: center">29,649.35</td>
<td style="text-align: center">29,488.35</td>
<td style="text-align: center">33,316.29</td>
</tr>
<tr>
<td style="text-align: center">中間値[ms]</td>
<td style="text-align: center">29,900.62</td>
<td style="text-align: center">29,980.37</td>
<td style="text-align: center">33,316.29</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th style="text-align: center">ORDER / IndexScan [ms]</th>
<th style="text-align: center">tstz</th>
<th style="text-align: center">int</th>
<th style="text-align: center">json</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1回目</td>
<td style="text-align: center">25,915.84</td>
<td style="text-align: center">26,555.30</td>
<td style="text-align: center">29,139.74</td>
</tr>
<tr>
<td style="text-align: center">2回目</td>
<td style="text-align: center">27,363.52</td>
<td style="text-align: center">26,978.52</td>
<td style="text-align: center">27,797.72</td>
</tr>
<tr>
<td style="text-align: center">3回目</td>
<td style="text-align: center">27,745.97</td>
<td style="text-align: center">26,959.08</td>
<td style="text-align: center">28,818.42</td>
</tr>
<tr>
<td style="text-align: center">中間値[ms]</td>
<td style="text-align: center">27,363.52</td>
<td style="text-align: center">26,959.08</td>
<td style="text-align: center">28,818.42</td>
</tr>
</tbody>
</table>

<p>シーケンシャルな場合は若干JSONBが遅かったですが、インデックスの場合はどれもほぼ変わらないように見えます。ただ、これだけではなんとも言えないのでJSONBについては後ほどレコードのサイズを変えて実験してみます。</p>

<h3>
<span id="46-複数カラムまとめ" class="fragment"></span><a href="#46-%E8%A4%87%E6%95%B0%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>4.6 複数カラムまとめ</h3>

<p>インデックス絡みでだいぶ脱線してしまいましたがまとめます</p>

<ul>
<li>複数カラムの場合でも、シーケンシャルなソートをする場合、単体カラムと同様TEXTやJSONBなどソートが遅い型は遅いままという性質は変わらない</li>
<li>シーケンシャルスキャンの場合、全般的なソート時間は行あたりのデータサイズが大きくなればなるほど遅くなる。いくらソートのキーに速い型を使ってもソート時間は容量に引っ張られる。</li>
<li>シーケンシャルスキャンの場合、レコードの状態（事前にソート済みかそうでないか）はソートのパフォーマンスに影響を与えないように見える（数回やっただけだから反例あるかもしれない）。ただし、Btreeインデックスによるスキャンの場合、レコードの状態がパフォーマンスに大きく影響を与える。</li>
<li>Btreeインデックスはソートされた状態で使うべき。完全にランダムな状態だとインデックスを張ったほうが明らかに遅くなることがある（ただしEXPLAIN ANALYZEでの総コストはランダムでも、インデックススキャンのほうがシーケンシャルスキャンより少ない）。</li>
<li>PostgreSQLのバージョンによっては、シーケンシャルスキャンにはパラレルスキャンなどの最適化が入るため、シャッフルされたカラムに対して下手にインデックスを張るよりも、シーケンシャルスキャンでソートしたほうが速くなることがある。</li>
</ul>

<h2>
<span id="5jsonbにおけるソートに無関係なデータのサイズとパフォーマンス" class="fragment"></span><a href="#5jsonb%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%BD%E3%83%BC%E3%83%88%E3%81%AB%E7%84%A1%E9%96%A2%E4%BF%82%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%A8%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9"><i class="fa fa-link"></i></a>5.JSONBにおけるソートに無関係なデータのサイズとパフォーマンス</h2>

<p>最後に、JSONBでKVSで格納する場合に、ソートに無関係なデータのサイズとソート時間をインデックス有り・無しで比較します。これまでの調査で、シーケンシャルなソート時間と全体のデータのサイズはほぼ比例することがわかったので、インデックスなしの場合のソート時間は無関係なデータが増えるほど遅くなるはずです。ただし、インデックスとは文字通り”索引”なので、インデックスありかつレコードの件数が同一な場合において、無関係なデータが増えても定数時間で検索できれば、これほど嬉しいことはありません。</p>

<p>今回はインデックスとしてGINインデックスではなく、フィールドに対してBtreeインデックスを使います。なぜならGINインデックスはORDER BYのような比較演算子に対応していないためです。<a href="https://www.postgresql.jp/document/9.5/html/datatype-json.html#json-indexing" rel="nofollow noopener" target="_blank">公式ドキュメント</a>より、</p>

<blockquote>
<p>jsonb型の問い合わせでサポートしているデフォルトのGIN演算子クラスは、トップレベルのキーが存在するかの演算子として?、?&amp;、?|があり、パス／値が存在するかの演算子として@&gt;があります</p>
</blockquote>

<p>Btreeインデックスを効率よく使うために、ランダムではなく事前にソート済みのデータを用います。ソート済みのデータをソートするというのも不思議な話ですが、事前にソートしようがしまいがシーケンシャル（インデックスを張らない場合）なソートにおいて処理時間が特に変わらなかったから仕方ありません。気持ち悪ければ、事前に昇順にソートしたデータを、ORDER BY…DESCで降順ソートすると置き換えて読んでも構いません。事実、4.5で登場したjson-&gt;&gt;'timestamp'について昇順ソート済みのmulti_jsonテーブルに対して、シーケンシャルなソートを行ってみると</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>DROP INDEX multi_json_index<span class="p">;</span>
<span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi_json ORDER BY json-&gt;&gt;<span class="s1">'timestamp'</span> DESC<span class="p">;</span>
<span class="go">Time: 39736.049 ms (00:39.736)
</span><span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM multi_json ORDER BY json-&gt;&gt;<span class="s1">'timestamp'</span><span class="p">;</span>
<span class="go">Time: 39991.808 ms (00:39.992)
</span></code></pre></div></div>

<p>昇順でソートしようが、降順でソートしようが時間は変わりません。</p>

<h3>
<span id="51-データの用意" class="fragment"></span><a href="#51-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%94%A8%E6%84%8F"><i class="fa fa-link"></i></a>5.1 データの用意</h3>

<p>ここでは、<strong>無関係なデータとして128文字のランダムな英数字を用いて、その文字列を配列として格納します。配列の要素数を1、3、5と変化させたテーブル、one, three, five</strong>を作り、インデックスの有無でORDER BYの時間を比較します。JSON生成部分のC#プログラムを再掲します（全部のコードは2を参照）。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">C#</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">RandomData</span>
<span class="p">{</span>
  <span class="cm">/*
  * 略
  */</span>
  <span class="k">public</span> <span class="kt">string</span> <span class="nf">ToRandomStringContainsJson</span><span class="p">(</span><span class="kt">int</span> <span class="n">takeLength</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">takeLength</span> <span class="p">&lt;=</span> <span class="m">0</span> <span class="p">||</span> <span class="n">takeLength</span> <span class="p">&gt;</span> <span class="n">RandomString</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">();</span>
      <span class="k">return</span> <span class="n">ServiceStack</span><span class="p">.</span><span class="n">DynamicJson</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="k">new</span> <span class="p">{</span> <span class="n">timestamp</span> <span class="p">=</span> <span class="n">TimeStamp</span><span class="p">,</span> <span class="n">random_str</span> <span class="p">=</span> <span class="n">RandomString</span><span class="p">.</span><span class="nf">Take</span><span class="p">(</span><span class="n">takeLength</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">()</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>この引数のtakeLengthを1,3,5と変化させます。CreateDataのクラスに連続したデータを読み書きするクラスを作ります。例えば5の場合はこのようになります。全く意味のないゴミデータです。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="go">{"timestamp":"2001-09-09T10:46:40.0000000+09:00","random_str":["o+}bxM4:Pr}8%WPG
</span><span class="gp">G^BG%l7OOWj;</span>/t<span class="p">;</span>4R-eRlPxkTu<span class="k">*</span>Oy<span class="o">(</span>v:wD:QIv0oe:q!1Z<span class="p">;</span><span class="c">#ZMtz6iidng+ck}tnXNTmd(sFcXoxyET9</span>
<span class="gp">rzuJQ)&gt;</span>nSGmc^pm[L<span class="o">)</span>.v4<span class="o">=</span>hrg&amp;TBByBJ<span class="s2">","</span>okZ6.-Ol&amp;VELOD9u#V-]21fOb6oGc?LjMiZwOY59Q_[6a
<span class="gp">hrgKbk_eS^!{:xJ-bnK[6;</span>dk:jA<span class="nv">$x</span><span class="o">!</span>G<span class="o">}</span>ihQqZpL?]8H<span class="k">*</span><span class="p">;</span><span class="o">[</span>BQWVqmYc<span class="k">*</span>ABBE-KMbub<span class="k">*</span>jio&amp;yN-BRWk6/]
<span class="gp">8g+","%D65r3T[FY#</span>Heb<span class="p">;</span>a#Q0a4S&amp;3oNrdeZ]-.CHD1DcoRd&gt;l_:er<span class="o">}</span>c<span class="o">(</span>OkpbV@<span class="o">(</span>eljc?XyagOTe&gt;K9I
<span class="gp">Ks{D6MO=h^L)R8]7ylEdHJs2@mY#</span>A7jp#t<span class="nv">$=</span>7^bJh<span class="o">=</span>6Vfi4Tabz3G/<span class="s2">","</span>?Oap<span class="p">;</span><span class="o">=</span>4Mfr9Roq9NSj!<span class="o">(}</span>_?
<span class="gp">-7G_):/+yO@O9&amp;Cnv0T-4OpkM@ubHx)p&gt;</span>Utqk<span class="p">;</span>Y<span class="o">)</span>Wo+Vy-MjJ4U_3v&gt;Y<span class="p">;</span>MF<span class="nv">$42</span>:vetmZ9RxyMd[e]u1s
<span class="gp">Y9VN72q:c4:EV5R4=?xEt0)Uy","[yh)CdH5.NUf-8&gt;</span>6:.@d@4p@%7mF+L6<span class="p">;</span>qbc<span class="p">;</span><span class="nv">i3SqCJ</span><span class="o">=</span>n-Uj<span class="o">(</span>Npp9
<span class="gp">5kO6@_nw;</span><span class="nv">N</span><span class="o">=}</span>T9^v/F3u<span class="o">(</span>VIx<span class="nv">$@</span><span class="k">*</span>g.jftRlpXh0G<span class="o">}</span>v<span class="p">;</span>R&amp;-x+D^2<span class="p">;</span>02:|_1c2/YBKK8zI%5ac@:[k@<span class="s2">"]}
</span></code></pre></div></div>

<p>ファイルへの読み書きは次の通り。これまでと同様に1000万レコード作ります。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">C#</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CreateData</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeSeqData</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">seqEpoch</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">10000000</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="m">1</span><span class="n">e9</span> <span class="p">+</span> <span class="n">x</span> <span class="p">*</span> <span class="m">31</span><span class="p">);</span>

        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="s">"seq"</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Write</span><span class="p">))</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">sw</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamWriter</span><span class="p">(</span><span class="n">fs</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">s</span> <span class="k">in</span> <span class="n">seqEpoch</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">item</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RandomData</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">&lt;</span><span class="n">RandomData</span><span class="p">&gt;(</span><span class="n">item</span><span class="p">);</span>
                <span class="n">sw</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">RandomData</span><span class="p">&gt;</span> <span class="nf">ReadSeqData</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="s">"seq"</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">sr</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StreamReader</span><span class="p">(</span><span class="n">fs</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">sr</span><span class="p">.</span><span class="nf">Peek</span><span class="p">()</span> <span class="p">&gt;</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">str</span> <span class="p">=</span> <span class="n">sr</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
                <span class="k">yield</span> <span class="k">return</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">DeserializeFromString</span><span class="p">&lt;</span><span class="n">RandomData</span><span class="p">&gt;(</span><span class="n">str</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>挿入は以下の通り。</p>

<div class="code-frame" data-lang="csharp">
<div class="code-lang"><span class="bold">C#</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">Npgsql</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">seq</span> <span class="p">=</span> <span class="n">CreateData</span><span class="p">.</span><span class="nf">ReadSeqData</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnectionStringBuilder</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Host</span> <span class="p">=</span> <span class="s">"localhost"</span><span class="p">,</span>
            <span class="n">Port</span> <span class="p">=</span> <span class="m">5432</span><span class="p">,</span>
            <span class="n">Username</span> <span class="p">=</span> <span class="s">"postgres"</span><span class="p">,</span>
            <span class="n">Password</span> <span class="p">=</span> <span class="s">"postgres"</span><span class="p">,</span>
            <span class="n">Database</span> <span class="p">=</span> <span class="s">"foo"</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">con</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlConnection</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">ConnectionString</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">con</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">table</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"one"</span><span class="p">,</span> <span class="s">"three"</span><span class="p">,</span> <span class="s">"five"</span> <span class="p">};</span>

            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cmd</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NpgsqlCommand</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">cmd</span><span class="p">.</span><span class="n">Connection</span> <span class="p">=</span> <span class="n">con</span><span class="p">;</span>


                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">t</span> <span class="k">in</span> <span class="n">table</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s">$"CREATE TABLE </span><span class="p">{</span><span class="n">t</span><span class="p">}</span><span class="s"> (id INTEGER, json JSONB)"</span><span class="p">;</span>
                    <span class="n">cmd</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="k">in</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">table</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">writer</span> <span class="p">=</span> <span class="n">con</span><span class="p">.</span><span class="nf">BeginBinaryImport</span><span class="p">(</span><span class="s">$"COPY </span><span class="p">{</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span><span class="s">(id, json) FROM STDIN (FORMAT BINARY)"</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">cnt</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
                    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">r</span> <span class="k">in</span> <span class="n">seq</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">writer</span><span class="p">.</span><span class="nf">StartRow</span><span class="p">();</span>
                        <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Integer</span><span class="p">);</span>
                        <span class="n">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">ToRandomStringContainsJson</span><span class="p">(</span><span class="n">i</span> <span class="p">*</span> <span class="m">2</span> <span class="p">+</span> <span class="m">1</span><span class="p">),</span> <span class="n">NpgsqlTypes</span><span class="p">.</span><span class="n">NpgsqlDbType</span><span class="p">.</span><span class="n">Jsonb</span><span class="p">);</span>
                        <span class="n">cnt</span><span class="p">++;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>インデックスをつけない状態のテーブルサイズは次の通り。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>SELECT relname, pg_size_pretty<span class="o">(</span>pg_relation_size<span class="o">(</span>relid<span class="o">))</span> FROM pg_stat_user_tables ORDER BY relid DESC LIMIT 3<span class="p">;</span>
<span class="go"> relname | pg_size_pretty
---------+----------------
 five    | 7813 MB
 three   | 4883 MB
 one     | 2367 MB
(3 rows)
</span></code></pre></div></div>

<h3>
<span id="52-jsonbのフィールドにインデックスをつけてもorder-byでインデックスが使われないことがある" class="fragment"></span><a href="#52-jsonb%E3%81%AE%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%81%AB%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E3%81%A4%E3%81%91%E3%81%A6%E3%82%82order-by%E3%81%A7%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%8C%E4%BD%BF%E3%82%8F%E3%82%8C%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B"><i class="fa fa-link"></i></a>5.2 JSONBのフィールドにインデックスをつけてもORDER BYでインデックスが使われないことがある</h3>

<p>これまでのようにjson-&gt;&gt;'timestamp'にインデックスをつければインデックススキャンになるのかと思ったら、<strong>インデックスを使われる場合と使われない場合がありました</strong>。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX one_idx ON one<span class="o">((</span>json-&gt;&gt;<span class="s1">'timestamp'</span><span class="o">))</span><span class="p">;</span>
<span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX three_idx ON three<span class="o">((</span>json-&gt;&gt;<span class="s1">'timestamp'</span><span class="o">))</span><span class="p">;</span>
<span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX five_idx ON five<span class="o">((</span>json-&gt;&gt;<span class="s1">'timestamp'</span><span class="o">))</span><span class="p">;</span>
<span class="go">
</span><span class="gp">foo=#</span><span class="w"> </span>EXPLAIN ANALYZE SELECT <span class="k">*</span> FROM one ORDER BY json-&gt;&gt;<span class="s1">'timestamp'</span><span class="p">;</span>
<span class="go">                                                               QUERY PLAN
--------------------------------------------------------------------------------
--------------------------------------------------------
 Index Scan using one_idx on one  (cost=0.56..1675472.56 rows=10000000 width=248
) (actual time=13.762..26074.756 rows=10000000 loops=1)
 Planning time: 37.796 ms
 Execution time: 26643.971 ms
(3 rows)


</span><span class="gp">foo=#</span><span class="w"> </span>EXPLAIN ANALYZE SELECT <span class="k">*</span> FROM three ORDER BY json-&gt;&gt;<span class="s1">'timestamp'</span><span class="p">;</span>
<span class="go">                                                                 QUERY PLAN
--------------------------------------------------------------------------------
------------------------------------------------------------
 Gather Merge  (cost=3998770.03..4971060.21 rows=8333334 width=512) (actual time
=172476.795..201055.184 rows=10000000 loops=1)
   Workers Planned: 2
   Workers Launched: 2
</span><span class="gp">   -&gt;</span><span class="w">  </span>Sort  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>3997770.00..4008186.67 <span class="nv">rows</span><span class="o">=</span>4166667 <span class="nv">width</span><span class="o">=</span>512<span class="o">)</span> <span class="o">(</span>actual <span class="nb">time</span><span class="o">=</span>1
<span class="go">72172.880..182443.152 rows=3333333 loops=3)
</span><span class="gp">         Sort Key: ((json -&gt;</span><span class="o">&gt;</span> <span class="s1">'timestamp'</span>::text<span class="o">))</span>
<span class="go">         Sort Method: external sort  Disk: 1741360kB
</span><span class="gp">         -&gt;</span><span class="w">  </span>Parallel Seq Scan on three  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>0.00..677083.33 <span class="nv">rows</span><span class="o">=</span>4166667 widt
<span class="go">h=512) (actual time=4.656..162457.024 rows=3333333 loops=3)
 Planning time: 31.543 ms
 Execution time: 201925.840 ms
(9 rows)

</span><span class="gp">foo=#</span><span class="w"> </span>EXPLAIN ANALYZE SELECT <span class="k">*</span> FROM five ORDER BY json-&gt;&gt;<span class="s1">'timestamp'</span><span class="p">;</span>
<span class="go">                                                                 QUERY PLAN
--------------------------------------------------------------------------------
------------------------------------------------------------
 Gather Merge  (cost=5783689.03..6755979.21 rows=8333334 width=776) (actual time
=236130.058..326493.436 rows=10000000 loops=1)
   Workers Planned: 2
   Workers Launched: 2
</span><span class="gp">   -&gt;</span><span class="w">  </span>Sort  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>5782689.00..5793105.67 <span class="nv">rows</span><span class="o">=</span>4166667 <span class="nv">width</span><span class="o">=</span>776<span class="o">)</span> <span class="o">(</span>actual <span class="nb">time</span><span class="o">=</span>2
<span class="go">36071.833..274220.890 rows=3333333 loops=3)
</span><span class="gp">         Sort Key: ((json -&gt;</span><span class="o">&gt;</span> <span class="s1">'timestamp'</span>::text<span class="o">))</span>
<span class="go">         Sort Method: external sort  Disk: 2554256kB
</span><span class="gp">         -&gt;</span><span class="w">  </span>Parallel Seq Scan on five  <span class="o">(</span><span class="nv">cost</span><span class="o">=</span>0.00..1052083.33 <span class="nv">rows</span><span class="o">=</span>4166667 widt
<span class="go">h=776) (actual time=3.433..222802.313 rows=3333333 loops=3)
 Planning time: 0.191 ms
 Execution time: 327663.142 ms
(9 rows)
</span></code></pre></div></div>

<p><strong>oneはインデックススキャンになっているのに、threeとfiveはシーケンシャルスキャンです</strong>。なんやそれ？？　仕方がないので、インデックスをjson-&gt;&gt;'timestamp'ではなくidカラムに対して付与してみます。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX five_int_idx ON five<span class="o">(</span><span class="nb">id</span><span class="o">)</span><span class="p">;</span>
<span class="go">CREATE INDEX
</span><span class="gp">foo=#</span><span class="w"> </span>EXPLAIN ANALYZE SELECT <span class="k">*</span> FROM five ORDER BY <span class="nb">id</span><span class="p">;</span>
<span class="go">                                                                 QUERY PLAN

--------------------------------------------------------------------------------
-------------------------------------------------------------
 Index Scan using five_int_idx on five  (cost=0.44..1259691.44 rows=10000000 wid
th=744) (actual time=0.531..10676.681 rows=10000000 loops=1)
 Planning time: 2.966 ms
 Execution time: 10848.587 ms
(3 rows)
</span></code></pre></div></div>

<p>int型のidカラムに対してだとさすがにインデックススキャンが用いられました。さすがにこれは予想外だったので、<strong>計画を変更して、「SELECT * FROM テーブル ORDER BY id」で比較します</strong>。idカラムに対してインデックスを不可した場合はインデックススキャンになることを確認しました。</p>

<h3>
<span id="53-keyidカラムによるソートの結果" class="fragment"></span><a href="#53-keyid%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AB%E3%82%88%E3%82%8B%E3%82%BD%E3%83%BC%E3%83%88%E3%81%AE%E7%B5%90%E6%9E%9C"><i class="fa fa-link"></i></a>5.3 Key（idカラム）によるソートの結果</h3>

<p>以下のような流れで行います（事前にインデックスは全てはずしておきます）。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="gp">#</span><span class="w"> </span>シーケンシャルスキャンを3回
<span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM one ORDER BY <span class="nb">id</span><span class="p">;</span>
<span class="gp">#</span><span class="w"> </span>インデックスを作る
<span class="gp">foo=#</span><span class="w"> </span>CREATE INDEX one_id_idx ON one<span class="o">(</span><span class="nb">id</span><span class="o">)</span><span class="p">;</span>
<span class="gp">#</span><span class="w"> </span>インデックススキャンを3回
<span class="gp">foo=#</span><span class="w"> </span>SELECT <span class="k">*</span> FROM one ORDER BY <span class="nb">id</span><span class="p">;</span>
</code></pre></div></div>

<p>時間比較はまたコンソールの\timingで行いました。その前に、<strong>json-&gt;&gt;'timestamp'をインデックスなしでソートした場合</strong>の時間を張っておきます。</p>

<table>
<thead>
<tr>
<th style="text-align: center">json-&gt;&gt;'timestamp' / SeqScan</th>
<th style="text-align: center">one</th>
<th style="text-align: center">three</th>
<th style="text-align: center">five</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1回目</td>
<td style="text-align: center">145,759</td>
<td style="text-align: center">287,076</td>
<td style="text-align: center">503,091</td>
</tr>
<tr>
<td style="text-align: center">2回目</td>
<td style="text-align: center">105,478</td>
<td style="text-align: center">261,721</td>
<td style="text-align: center">403,437</td>
</tr>
<tr>
<td style="text-align: center">3回目</td>
<td style="text-align: center">100,498</td>
<td style="text-align: center">270,508</td>
<td style="text-align: center">403,140</td>
</tr>
<tr>
<td style="text-align: center">中央値[ms]</td>
<td style="text-align: center">105,478</td>
<td style="text-align: center">270,508</td>
<td style="text-align: center">403,437</td>
</tr>
<tr>
<td style="text-align: center">中央値[mm:ss]</td>
<td style="text-align: center">1:45</td>
<td style="text-align: center">4:30</td>
<td style="text-align: center">6:43</td>
</tr>
<tr>
<td style="text-align: center">テーブルサイズ（MB）</td>
<td style="text-align: center">2,367</td>
<td style="text-align: center">4,883</td>
<td style="text-align: center">7,813</td>
</tr>
<tr>
<td style="text-align: center">中央値[ms/GB]</td>
<td style="text-align: center">44,562</td>
<td style="text-align: center">55,398</td>
<td style="text-align: center">51,637</td>
</tr>
</tbody>
</table>

<p>概ねテーブルサイズに比例しています。中央値[ms/GB]は中央値[ms]をテーブルサイズで割って1000掛けて算出しています。次に、<strong>idをインデックスなしでソート</strong>します。jsonでのソート時間より若干速いぐらいが期待されます。</p>

<table>
<thead>
<tr>
<th style="text-align: center">id / SeqScan</th>
<th style="text-align: center">one</th>
<th style="text-align: center">three</th>
<th style="text-align: center">five</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1回目</td>
<td style="text-align: center">190,600</td>
<td style="text-align: center">264,294</td>
<td style="text-align: center">420,541</td>
</tr>
<tr>
<td style="text-align: center">2回目</td>
<td style="text-align: center">40,040</td>
<td style="text-align: center">275,050</td>
<td style="text-align: center">398,599</td>
</tr>
<tr>
<td style="text-align: center">3回目</td>
<td style="text-align: center">39,745</td>
<td style="text-align: center">300,400</td>
<td style="text-align: center">406,201</td>
</tr>
<tr>
<td style="text-align: center">中央値[ms]</td>
<td style="text-align: center">40,040</td>
<td style="text-align: center">275,050</td>
<td style="text-align: center">406,201</td>
</tr>
<tr>
<td style="text-align: center">中央値[mm:ss]</td>
<td style="text-align: center">0:40</td>
<td style="text-align: center">4:35</td>
<td style="text-align: center">6:46</td>
</tr>
<tr>
<td style="text-align: center">テーブルサイズ（MB）</td>
<td style="text-align: center">2,367</td>
<td style="text-align: center">4,883</td>
<td style="text-align: center">7,813</td>
</tr>
<tr>
<td style="text-align: center">中央値[ms/GB]</td>
<td style="text-align: center">16,916</td>
<td style="text-align: center">56,328</td>
<td style="text-align: center">51,990</td>
</tr>
</tbody>
</table>

<p>oneのみキャッシュが効いたのか高速になっていますが、ほとんどjson-&gt;&gt;'timestamp'でソートしたときと変わりません。<strong>idにインデックスを張って再びソート</strong>します。</p>

<table>
<thead>
<tr>
<th style="text-align: center">id / IndexScan</th>
<th style="text-align: center">one</th>
<th style="text-align: center">three</th>
<th style="text-align: center">five</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">1回目</td>
<td style="text-align: center">71,156</td>
<td style="text-align: center">85,095</td>
<td style="text-align: center">151,068</td>
</tr>
<tr>
<td style="text-align: center">2回目</td>
<td style="text-align: center">37,417</td>
<td style="text-align: center">83,583</td>
<td style="text-align: center">120,955</td>
</tr>
<tr>
<td style="text-align: center">3回目</td>
<td style="text-align: center">37,814</td>
<td style="text-align: center">82,639</td>
<td style="text-align: center">118,263</td>
</tr>
<tr>
<td style="text-align: center">中央値[ms]</td>
<td style="text-align: center">37,814</td>
<td style="text-align: center">83,583</td>
<td style="text-align: center">120,955</td>
</tr>
<tr>
<td style="text-align: center">中央値[mm:ss]</td>
<td style="text-align: center">0:37</td>
<td style="text-align: center">1:23</td>
<td style="text-align: center">2:00</td>
</tr>
<tr>
<td style="text-align: center">テーブル＋インデックス(MB)</td>
<td style="text-align: center">2,582</td>
<td style="text-align: center">5,098</td>
<td style="text-align: center">8,028</td>
</tr>
<tr>
<td style="text-align: center">中央値[ms/GB]</td>
<td style="text-align: center">14,645</td>
<td style="text-align: center">16,395</td>
<td style="text-align: center">15,067</td>
</tr>
</tbody>
</table>

<p>インデックスを張ると、レコード数に対して定数時間でソート可能というのはさすがになりませんでしたが、threeとfiveのテーブルにおいてインデックスを張らない場合の3～4倍の速度でソートできています。線形時間であるものの、インデックスを張らない場合より傾きが緩やかであったというべきでしょう。<br>
もちろんこれはソート済みの段階でインデックスを張ったので、ランダムに近いような状態だとこれまで見てきたようにシーケンシャルスキャンより遅くなることもあります。</p>

<h2>
<span id="6まとめ" class="fragment"></span><a href="#6%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>6.まとめ</h2>

<p>非常に長い投稿になってしまいましたが、これまでの内容を振り返ります。</p>

<ul>
<li>日付型は実用的には<strong>利便性重視でtimestampかtimestamptzを用いるべき</strong>。UNIX時間のようなbitintもありだが、ソートの速度面のメリットはあまりない。<strong>UUIDも広義のタイムスタンプ（UUID v1）なので必要に応じてあり</strong>。JSONの場合は型変換が入ってちょっと大変（感覚的には文字列とほとんど変わらない）。</li>
<li>レコードあたりの容量にしめるソートのデータの容量少ないほど、データ型ごとの”軽さ”が支配的になる。<strong>レコードの容量が大きくなればなるほど、よほど変な型でソートしようとしない限り、全体の容量が支配的になるため大差がなくなる</strong>（bigintとtimestampの差なんてすぐ消える）。</li>
<li>
<strong>ソート時間はインデックスの有無にかかわらず、同一レコード数の場合、レコードあたりの容量におおよそ比例</strong>する。<strong>正しくインデックスを用いると、ソート時間の傾斜がシーケンシャルスキャンな場合より緩やかになる</strong>ため、カラム側に大型のテーブルほどインデックスが有効になる。</li>
<li>
<strong>Btreeインデックスはランダムなレコード配列に対して非常に弱い</strong>。ランダムなレコードに対してインデックスを張ると、インデックスを張らない場合より明らかに遅くなることがある。</li>
<li>
<strong>インデックスを使わない（シーケンシャルスキャン）の場合、ソート時間はレコードの事前のソート状態と明確に関係あるとはいえない</strong>。事前にソートしたからといってソートが速くなるわけではない。この例では無関係であるように見えるが、反例がありそうなので断定はできない。</li>
<li>
<strong>インデックスを用いた（Btreeインデックスによるスキャン）の場合、ソート時間はレコードの状態と明確に関係があり</strong>、事前にソートしておかない（あるいはインデックスを張るカラムに対して並び順的な意味でシーケンシャルになることを保証しないと）大変なことになる。</li>
</ul>

<p>以上です。データベース素人ですが、インデックスについてモヤモヤしたことが解決して勉強になりました。</p>

<p>以下、チラ裏ですが、処理している途中HDDがガリガリ言っていつ壊れるか不安で仕方なかったので、今度似たようなことをやるときは作業用のSSDを買おうと思いました。fiveのテーブル（8GB程度）をインデックスでソートしている途中のタスクマネージャーのスクショです。<br>
<a href="https://camo.qiitausercontent.com/46a14ff9b740cabf6f91e70f8bb1c741c6d0312c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233323038382f38616134636635392d633266352d353163312d343237372d3632663363653133623764382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F232088%2F8aa4cf59-c2f5-51c1-4277-62f3ce13b7d8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6efbd6809f038a6dec3ce610eb3112c8" alt="psqltime.png" data-canonical-src="https://qiita-image-store.s3.amazonaws.com/0/232088/8aa4cf59-c2f5-51c1-4277-62f3ce13b7d8.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F232088%2F8aa4cf59-c2f5-51c1-4277-62f3ce13b7d8.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=9ac632ccea11585f6fd09cfec1e83b57 1x" loading="lazy"></a><br>
メモリの食べ過ぎに注意しましょう。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fkoshian2%2Fitems%2F867ed761c9e9d1608911&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fkoshian2%2Fitems%2F867ed761c9e9d1608911&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/koshian2/items/867ed761c9e9d1608911/likers" class="css-1iupg5d">9</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">14</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/867ed761c9e9d1608911/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/koshian2/items/867ed761c9e9d1608911/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/koshian2/items/867ed761c9e9d1608911/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/koshian2/items/867ed761c9e9d1608911/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/koshian2/items/867ed761c9e9d1608911.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-dd4239b1-ffab-4aff-949f-99e5a2205e69">{"authorAnalyticsTrackingId":"UA-110383409-3","organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-8ea14fd2-c514-4a63-a4ea-748b1db261f1"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-8ea14fd2-c514-4a63-a4ea-748b1db261f1">{}</script>
      
<div id="LoginModal-react-component-432a5b1e-ea2e-4529-a7d7-7d7c53a2c4ad"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-432a5b1e-ea2e-4529-a7d7-7d7c53a2c4ad">{}</script>
      
<div id="StockModal-react-component-6eb38105-0105-4dad-9234-3d6db648a52d"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-6eb38105-0105-4dad-9234-3d6db648a52d">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;RZGYjJJ2nOq0H8CwdmoMNv8vzy/3vDIOFGMjiN4WWDOWjnrocW5n+5HFMmE/Qvaak1+zyfKOh4dOITWbHeJNZw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003ePostgreSQLを使っていたら、日付のソートってどれぐらいの処理速度なんだろう？と気になったので計測してみました。\u003c/p\u003e\n\n\u003cp\u003e環境：psql (PostgreSQL) 10.2 Windows版、Npgsql（v3.2.6 - 2017/12/3）、データディレクトリはHDD、.NET Framework 4.6\u003c/p\u003e\n\n\u003cp\u003eデータ挿入はアプリケーション（C#）側から行っています。パフォーマンスの比較はPostgreSQLにログインし、コマンドラインから\\timingコマンドを使って行います。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"1postgresqlの日付のデータ型\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1postgresql%E3%81%AE%E6%97%A5%E4%BB%98%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e1.PostgreSQLの日付のデータ型\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.postgresql.jp/document/9.6/html/datatype-datetime.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式ドキュメント\u003c/a\u003eによると、timestamp型が日付と時刻を両方管理するのに使えそうです。\u003cstrong\u003eタイムゾーンあり（TIMESTAMPTZ）、なし（TIMESTAMP）\u003c/strong\u003eの2つがあります。標準SQLではTIMESTAMPはタイムゾーンが含まれなく、TIMESTAMPTZはPostgreSQLの独自の拡張だそうです。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003e型名\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e格納サイズ\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e説明\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e最遠の過去\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e最遠の未来\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e精度\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003etimestamp [ (p) ] [ without time zone ]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e8 バイト\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e日付と時刻両方（時間帯なし）\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e4713 BC\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e294276 AD\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e1マイクロ秒、14桁\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003etimestamp [ (p) ] with time zone\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e8バイト\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e日付と時刻両方、時間帯付き\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e4713 BC\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e294276 AD\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e1マイクロ秒、14桁\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eINTERVAL型は時刻と時刻の差分を表す時間（\u003ca href=\"http://www.npgsql.org/doc/types/datetime.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eNpgsqlのドキュメント\u003c/a\u003eによれば、.NETでいうところのTimeSpan）なので、時刻を表すのにはちょっと違うかなと考えて除外しました。\u003cbr\u003e\nまた、UNIX時間を\u003cstrong\u003e64ビット整数のbigint\u003c/strong\u003eとしてそのまま格納する方法もあります。それ以外にも、タイムスタンプを\u003cstrong\u003eある一定のフォーマットの文字列TEXT（VARCHAR(N)でもOK）\u003c/strong\u003eとして（ここでは2001-09-09T10:46:40+09:00のような「ISO 8601形式」を用います）格納する方法もあります。\u003cbr\u003e\n1つのカラムに1データであることにとらわれない場合は、JSONの中にタイムスタンプを文字列として埋め込んでしまう方法もあります。その場合は、\u003cstrong\u003eJSONのバイナリ型であるJSONB\u003c/strong\u003eとしてカラムを定義し、その中にタイムスタンプの要素を作ります。おそらく文字列の場合と似た挙動になるのではないかなと思います。\u003c/p\u003e\n\n\u003cp\u003eしたがって、以下の5つのデータ型を調べることになります。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eタイムゾーンありのTIMESTAMPTZ\u003c/li\u003e\n\u003cli\u003eタイムゾーンなしのTIMESTAMP\u003c/li\u003e\n\u003cli\u003eUNIX時間のBIGINT\u003c/li\u003e\n\u003cli\u003eタイムスタンプの文字列のTEXT\u003c/li\u003e\n\u003cli\u003eJSONの中にタイムスタンプが入っているJSONB\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"2用意するデータ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#2%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e2.用意するデータ\u003c/h2\u003e\n\n\u003cp\u003e挿入まではC#で行います。ランダムな並びの整数を日本標準時のUNIX時間として、日付形式に変換し格納します。開始値は10億（UNIX時間で2001/09/09 10:46:40+09:00）とし、一定間隔（この例では31）でUNIX時間の配列を1000万件作成します。これをランダムにシャッフルし、様々なデータ型に変換し、格納してソート時間を比較します。作成したデータを改行区切りのJSONで保存します（格納すれば関係ないので形式はなんでもいいですが、UTF8エンコードでファイルに書き出して7.78GBだったので一気にオンメモリでシリアライズする…的なことをすると死にます）。\u003c/p\u003e\n\n\u003cp\u003eデータ生成部分はこんな感じにCreateDataというクラスで。Guid.NewGuid()がおおよそユニークな乱数として利用できることから入れ替え時に利用しています。Membership.GeneratePassword()はランダムな128文字の文字列を作るために使っています（これはソートに無関係なデータであり後々使います）。JSONシリアライザーには\u003ca href=\"https://github.com/ServiceStack/ServiceStack.Text\" rel=\"nofollow noopener\" target=\"_blank\"\u003eServiceStack.Text\u003c/a\u003eを使っています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eC#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Linq\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.IO\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Web.Security\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eServiceStack.Text\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCreateData\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMakeData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003erandomEpoch\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e10000000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"n\"\u003ee9\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e31\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOrderBy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eGuid\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eNewGuid\u003c/span\u003e\u003cspan class=\"p\"\u003e()).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFileStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"random\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAccess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStreamWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efs\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e//メモリあふれるので行単位で\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003erandomEpoch\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ejson\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eJsonSerializer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeToString\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eReadData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFileStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"random\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAccess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStreamReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efs\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePeek\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadLine\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJsonSerializer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDeserializeFromString\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eRandomData\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003eUnixEpoch\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTimeOffset\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTimeOffset\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeStamp\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eRandomString\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003eget\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003eunixEpoch\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eUnixEpoch\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eunixEpoch\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDateTimeOffset\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTimeOffset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFromUnixTimeSeconds\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eunixEpoch\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToLocalTime\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTimeOffset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLocalDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eTimeStamp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eDateTimeOffset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"o\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRandomString\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eMembership\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGeneratePassword\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e128\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eToTimestampOnlyJson\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eServiceStack\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDynamicJson\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSerialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003etimestamp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeStamp\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eToRandomStringContainsJson\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etakeLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etakeLength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003etakeLength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eRandomString\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eServiceStack\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDynamicJson\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSerialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003etimestamp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeStamp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erandom_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRandomString\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etakeLength\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eエントリーポイント\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eC#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCreateData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMakeData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e本当にランダムなの？ということで最初の10件を表示してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eC#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadData\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eTake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTimeOffset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e2002/05/08 0:26:30 +09:00\n2009/03/19 23:54:37 +09:00\n2009/08/07 14:22:20 +09:00\n2004/11/24 2:39:14 +09:00\n2006/10/09 5:30:40 +09:00\n2004/05/15 10:20:58 +09:00\n2009/05/20 6:37:40 +09:00\n2009/05/09 2:31:15 +09:00\n2003/10/07 12:49:58 +09:00\n2002/12/21 15:33:47 +09:00\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e確かにランダムですね。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"3単一カラムのデータテーブルの場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#3%E5%8D%98%E4%B8%80%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.単一カラムのデータテーブルの場合\u003c/h2\u003e\n\n\u003cp\u003e日付型のカラムのみで構成される、単一カラムのデータテーブルを作成し、ソートにかかる時間を比較します。次のような定義です。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eカラム名\u003c/th\u003e\n\u003cth\u003e制約\u003c/th\u003e\n\u003cth\u003e型\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003etime\u003c/td\u003e\n\u003ctd\u003e-\u003c/td\u003e\n\u003ctd\u003eTIMESTAMPTZ / TIMESTAMP / BIGINT / TEXT / JSONB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eTEXTはVARCHAR(N)でもいいです。PrimaryKeyやインデックスはとりあえずは作りません（後で作ります）。5つの型について比較します。DBの初期設定と起動、データベースの作成を行っておきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003e\u0026gt;\u003c/span\u003einitdb \u003cspan class=\"nt\"\u003e--encoding\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eUTF8 \u003cspan class=\"nt\"\u003e--no-locale\u003c/span\u003e \u003cspan class=\"nt\"\u003e--username\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003epostgres \u003cspan class=\"nt\"\u003e--pwprompt\u003c/span\u003e \u003cspan class=\"nt\"\u003e-D\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"D:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\p\u003c/span\u003e\u003cspan class=\"s2\"\u003esql\u003c/span\u003e\u003cspan class=\"se\"\u003e\\t\u003c/span\u003e\u003cspan class=\"s2\"\u003eimeseries\"\u003c/span\u003e\n\u003cspan class=\"gp\"\u003e\u0026gt;\u003c/span\u003epg_ctl start \u003cspan class=\"nt\"\u003e-D\u003c/span\u003e \u003cspan class=\"s2\"\u003e\"D:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\p\u003c/span\u003e\u003cspan class=\"s2\"\u003esql\u003c/span\u003e\u003cspan class=\"se\"\u003e\\t\u003c/span\u003e\u003cspan class=\"s2\"\u003eimeseries\"\u003c/span\u003e\n\u003cspan class=\"gp\"\u003e\u0026gt;\u003c/span\u003epsql \u003cspan class=\"nt\"\u003e-U\u003c/span\u003e postgres\n\u003cspan class=\"gp\"\u003epostgres=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE DATABASE foo\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNpgsqlによる挿入コードは以下の通り。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eC#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNpgsql\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003erandom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnectionStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eHost\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"localhost\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePort\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5432\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eUsername\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"postgres\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePassword\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"postgres\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDatabase\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConnectionString\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConnection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommandText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"CREATE TABLE tstz (time TIMESTAMPTZ)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommandText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"CREATE TABLE ts (time TIMESTAMP)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommandText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"CREATE TABLE int (time BIGINT)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommandText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"CREATE TABLE text (time TEXT)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommandText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"CREATE TABLE json (time JSONB)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etables\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"s\"\u003e\"tstz\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"ts\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"int\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"text\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"json\"\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etable\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003etables\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBeginBinaryImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"COPY \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e(time) FROM STDIN (FORMAT BINARY)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003erandom\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartRow\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                        \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e//参考：http://www.npgsql.org/doc/types/datetime.html\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s\"\u003e\"tstz\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTimestampTZ\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s\"\u003e\"ts\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTimestamp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s\"\u003e\"int\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnixEpoch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBigint\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s\"\u003e\"text\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTimeStamp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"s\"\u003e\"json\"\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToTimestampOnlyJson\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJsonb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eTimestamptzでDateTimeOffsetではなく、DateTimeなのがちょっと直感的ではありませんがこれが仕様のようです（\u003ca href=\"http://www.npgsql.org/doc/types/datetime.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式ドキュメント\u003c/a\u003eの.NET Native TypeがDateTimeになっています）。Qiitaでも検証している方がいます。\u003c/p\u003e\n\n\u003cp\u003e参考：\u003ca href=\"https://qiita.com/kkino90h/items/147aed6162c82a1022f9\" class=\"autolink\" id=\"reference-9f84870a0b91b67ccbd4\"\u003ehttps://qiita.com/kkino90h/items/147aed6162c82a1022f9\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"31-timestamptz型\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#31-timestamptz%E5%9E%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.1 Timestamptz型\u003c/h3\u003e\n\n\u003cp\u003e各3回ずつクエリを実行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM tstz ORDER BY \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e          time\n------------------------\n 2001-09-09 10:46:40+09\n 2001-09-09 10:47:11+09\n 2001-09-09 10:47:42+09\n 2001-09-09 10:48:13+09\n 2001-09-09 10:48:44+09\n 2001-09-09 10:49:15+09\n 2001-09-09 10:49:46+09\n 2001-09-09 10:50:17+09\n 2001-09-09 10:50:48+09\n 2001-09-09 10:51:19+09\n 2001-09-09 10:51:50+09\n 2001-09-09 10:52:21+09\n 2001-09-09 10:52:52+09\n 2001-09-09 10:53:23+09\n 2001-09-09 10:53:54+09\n 2001-09-09 10:54:25+09\n 2001-09-09 10:54:56+09\n 2001-09-09 10:55:27+09\n 2001-09-09 10:55:58+09\n 2001-09-09 10:56:29+09\n 2001-09-09 10:57:00+09\n 2001-09-09 10:57:31+09\nTime: 24920.397 ms (00:24.920)\nTime: 13499.368 ms (00:13.499)\nTime: 13439.432 ms (00:13.439)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e1回目と2回目で明らかに速くなっているのはOSのファイルキャッシュなど、何かしらのキャッシュが効いていそうです。条件を切り離すのが難しいですが、キャッシュが効いていないときと効いているときの処理時間がおおよそ比例していればまぁ大丈夫かなと。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"32-timestamp型\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#32-timestamp%E5%9E%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.2 Timestamp型\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM ts ORDER BY \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e        time\n---------------------\n 2001-09-09 10:46:40\n（中略）\nTime: 21246.412 ms (00:21.246)\nTime: 12226.805 ms (00:12.227)\nTime: 12429.354 ms (00:12.429)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eタイムゾーンありより若干速そう。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"33-bigint型\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#33-bigint%E5%9E%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.3 BigInt型\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM int ORDER BY \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e    time\n------------\n 1000000000\n（略）\nTime: 19395.331 ms (00:19.395)\nTime: 10748.002 ms (00:10.748)\nTime: 10570.828 ms (00:10.571)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e多分これが一番速いはずです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"34-text型\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#34-text%E5%9E%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.4 Text型\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM text ORDER BY \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e               time\n-----------------------------------\n 2001-09-09T10:46:40.0000000+09:00\n（略）\nTime: 21323.976 ms (00:21.324)\nTime: 16482.135 ms (00:16.482)\nTime: 16023.891 ms (00:16.024)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eアンチパターンと言われそうな形。Locale=Cだからまだマシなものの、他のロケールだったらもっとパフォーマンス悪くなると思います。ロケールとソートの速度の関係については下記の記事がとても詳しいです。\u003c/p\u003e\n\n\u003cp\u003e参考：\u003ca href=\"https://qiita.com/fujii_masao/items/2a715fb5a3f718d22ab4\" class=\"autolink\" id=\"reference-2a5664bd8e632991039c\"\u003ehttps://qiita.com/fujii_masao/items/2a715fb5a3f718d22ab4\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"35-jsonb型\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#35-jsonb%E5%9E%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e3.5 JSONB型\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM json ORDER BY time-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e                        time\n----------------------------------------------------\n {\"timestamp\": \"2001-09-09T10:46:40.0000000+09:00\"}\n（略）\nTime: 21434.557 ms (00:21.435)\nTime: 19787.943 ms (00:19.788)\nTime: 19867.661 ms (00:19.868)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eJSONながら意外と健闘している！？　\u003cstrong\u003eテキストとして取得する-\u0026gt;\u0026gt;演算子ではなく、配列として取得する-\u0026gt;演算子だとソートはできるものの、この2倍ぐらい遅いので\u003c/strong\u003e注意してください（気付かずにやり直した）。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"単一カラムまとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8D%98%E4%B8%80%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e単一カラムまとめ\u003c/h3\u003e\n\n\u003cp\u003eちょっとキャッシュ関係が再現性が紛らわしいですが、（明示的にキャッシュをクリアする方法もわからなく、DROP TABLE, DROP DATABASEをして再格納しても1回目の遅い状況を再現できなかった）。各3回の処理時間のうちのTimeの中間値をまとめると次のようになります。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003e型\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e中間値(ms)\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eBIGINT\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e10748.002\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eTIMESTAMP\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e12429.354\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eTIMESTAMPTZ\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13439.432\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eTEXT\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e16482.135\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eJSONB\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e19867.661\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e※1000万件のランダムなタイムスタンプを昇順ソート\u003c/p\u003e\n\n\u003cp\u003e大方予想通りの結果になりました。JSONBを除けばTEXT型が最も遅く、日付や時間でフィルタリングする場合に再度パースするオーバーヘッドがつくので、普通は使う意味がないです。JSONBも結局TEXTとして取り出してソートなので、やっていることはそこまで変わらなそう。本格的にやるならタイムスタンプ用のカラムを定義したほうが良さそう（似たような悩みは\u003ca href=\"https://stackoverflow.com/questions/42968683/postgres-jsonb-timestamp-query-very-slow-compared-to-timestamp-column-query\" rel=\"nofollow noopener\" target=\"_blank\"\u003eStackOverFlowを見ていたらそこそこ\u003c/a\u003eありました）。\u003cbr\u003e\nBIGINTは確かに最速ですが、フィルタリングする場合やタイムゾーンがある場合にちょっと面倒になるので、ここでの速度を取るか可読性を取るかはよく検討する必要がありそうです。\u003c/p\u003e\n\n\u003cp\u003e各テーブルの容量を取ると次のようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT relname, pg_size_pretty\u003cspan class=\"o\"\u003e(\u003c/span\u003epg_relation_size\u003cspan class=\"o\"\u003e(\u003c/span\u003erelid\u003cspan class=\"o\"\u003e))\u003c/span\u003e FROM pg_stat_user_tables ORDER BY relid\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e relname | pg_size_pretty\n---------+----------------\n tstz    | 346 MB\n ts      | 346 MB\n int     | 346 MB\n text    | 651 MB\n json    | 805 MB\n(5 rows)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eJSONBがちょっと特殊ですが、サイズが多いほどソートが遅くなるようです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"4複数カラムのデータテーブルの場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#4%E8%A4%87%E6%95%B0%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.複数カラムのデータテーブルの場合\u003c/h2\u003e\n\n\u003cp\u003e3の単一カラムの5ケースを1つのデータテーブルに統合します。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eカラム名\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e制約\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e型\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003etstz\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e-\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eTIMESTAMPTZ\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003ets\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e-\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eTIMESTAMP\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eint\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e-\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eBIGINT\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003etext\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e-\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eTEXT\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003ejson\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e-\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eJSONB\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e挿入は以下の通り。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eC#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNpgsql\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003erandom\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnectionStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eHost\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"localhost\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePort\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5432\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eUsername\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"postgres\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePassword\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"postgres\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDatabase\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConnectionString\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConnection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommandText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"CREATE TABLE multi (\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                    \u003cspan class=\"s\"\u003e\"tstz TIMESTAMPTZ,\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                    \u003cspan class=\"s\"\u003e\"ts TIMESTAMP,\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                    \u003cspan class=\"s\"\u003e\"int BIGINT,\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                    \u003cspan class=\"s\"\u003e\"text TEXT,\"\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e\n                    \u003cspan class=\"s\"\u003e\"json JSONB)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBeginBinaryImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"COPY multi(tstz, ts, int, text, json) FROM STDIN (FORMAT BINARY)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003erandom\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartRow\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTimestampTZ\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDateTime\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTimestamp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUnixEpoch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBigint\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTimeStamp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eText\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToTimestampOnlyJson\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJsonb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"41-複数カラムの場合のソート\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#41-%E8%A4%87%E6%95%B0%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%BD%E3%83%BC%E3%83%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.1 複数カラムの場合のソート\u003c/h3\u003e\n\n\u003cp\u003e単一の場合最速だったBigIntと、中間だったTimstamptz、最も遅かったJsonbの比較を行います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e          tstz          |         ts          |    int     |               text\n               |                        json\n------------------------+---------------------+------------+--------------------\n---------------+----------------------------------------------------\n 2001-09-09 10:46:40+09 | 2001-09-09 01:46:40 | 1000000000 | 2001-09-09T10:46:40\n.0000000+09:00 | {\"timestamp\": \"2001-09-09T10:46:40.0000000+09:00\"}\n（略）\nTime: 67700.814 ms (01:07.701)\nTime: 33956.836 ms (00:33.957)\nTime: 35280.877 ms (00:35.281)\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY int\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eTime: 37101.919 ms (00:37.102)\nTime: 36413.210 ms (00:36.413)\nTime: 36367.728 ms (00:36.368)\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY json-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eTime: 40122.308 ms (00:40.122)\nTime: 41672.883 ms (00:41.673)\nTime: 41480.865 ms (00:41.481)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eレコードあたりのサイズが大きくなっている分ソートに時間がかかっていますが、遅い型でソートしたときに遅くなるのはやはり変わらない模様（BigIntとTimestamptzが逆転しているのが謎）。Timestamptzの初回だけ遅くなっているのはやはり何らかのキャッシュが関係してそうですね。\u003c/p\u003e\n\n\u003cp\u003eデータテーブルの容量を取ります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"go\"\u003e relname | pg_size_pretty\n---------+----------------\n tstz    | 346 MB\n ts      | 346 MB\n int     | 346 MB\n text    | 651 MB\n json    | 805 MB\n multi   | 1420 MB\n(6 rows)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003etstz～jsonの単純合計とはならなかったのが興味深いですが、容量に比例してソートは遅くなっています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"42-インデックスを張る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#42-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E5%BC%B5%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.2 インデックスを張る\u003c/h3\u003e\n\n\u003cp\u003e今までずっとインデックスを張ってきませんでしたが、multiテーブルのtstzカラム（Timestamptz）に対してインデックスを張ってみます。インデックスを張らない状態と張った状態で2005年のデータを抽出し、WHEREを比較します。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"インデックス張らない場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E5%BC%B5%E3%82%89%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eインデックス張らない場合\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi WHERE tstz \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e timestamptz \u003cspan class=\"s1\"\u003e'2005-01-01 00:00:00+09'\u003c/span\u003e AND\n\u003cspan class=\"gp\"\u003e tstz \u0026lt; timestamptz '2006-01-01 00:00:00';\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"go\"\u003e          tstz          |         ts          |    int     |               text\n               |                        json\n------------------------+---------------------+------------+--------------------\n---------------+----------------------------------------------------\n 2005-10-21 15:31:38+09 | 2005-10-21 15:31:38 | 1129876298 | 2005-10-21T15:31:38\n.0000000+09:00 | {\"timestamp\": \"2005-10-21T15:31:38.0000000+09:00\"}\n 2005-09-08 06:54:32+09 | 2005-09-08 06:54:32 | 1126130072 | 2005-09-08T06:54:32\n.0000000+09:00 | {\"timestamp\": \"2005-09-08T06:54:32.0000000+09:00\"}\n 2005-05-30 03:46:52+09 | 2005-05-30 03:46:52 | 1117392412 | 2005-05-30T03:46:52\n.0000000+09:00 | {\"timestamp\": \"2005-05-30T03:46:52.0000000+09:00\"}\n 2005-04-27 10:03:06+09 | 2005-04-27 10:03:06 | 1114563786 | 2005-04-27T10:03:06\n.0000000+09:00 | {\"timestamp\": \"2005-04-27T10:03:06.0000000+09:00\"}\n 2005-06-21 00:40:48+09 | 2005-06-21 00:40:48 | 1119282048 | 2005-06-21T00:40:48\n.0000000+09:00 | {\"timestamp\": \"2005-06-21T00:40:48.0000000+09:00\"}\n 2005-12-22 11:47:55+09 | 2005-12-22 11:47:55 | 1135219675 | 2005-12-22T11:47:55\n.0000000+09:00 | {\"timestamp\": \"2005-12-22T11:47:55.0000000+09:00\"}\n 2005-01-08 02:51:27+09 | 2005-01-08 02:51:27 | 1105120287 | 2005-01-08T02:51:27\n.0000000+09:00 | {\"timestamp\": \"2005-01-08T02:51:27.0000000+09:00\"}\n 2005-09-13 03:43:38+09 | 2005-09-13 03:43:38 | 1126550618 | 2005-09-13T03:43:38\n.0000000+09:00 | {\"timestamp\": \"2005-09-13T03:43:38.0000000+09:00\"}\n 2005-06-26 14:37:33+09 | 2005-06-26 14:37:33 | 1119764253 | 2005-06-26T14:37:33\n.0000000+09:00 | {\"timestamp\": \"2005-06-26T14:37:33.0000000+09:00\"}\n 2005-06-20 05:22:57+09 | 2005-06-20 05:22:57 | 1119212577 | 2005-06-20T05:22:57\n.0000000+09:00 | {\"timestamp\": \"2005-06-20T05:22:57.0000000+09:00\"}\nTime: 4883.846 ms (00:04.884)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"インデックスを張った場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E5%BC%B5%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eインデックスを張った場合\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX tstz_idx ON multi\u003cspan class=\"o\"\u003e(\u003c/span\u003etstz\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi WHERE tstz \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e timestamptz \u003cspan class=\"s1\"\u003e'2005-01-01 00:00:00+09'\u003c/span\u003e AND\n\u003cspan class=\"gp\"\u003e tstz \u0026lt; timestamptz '2006-01-01 00:00:00';\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"go\"\u003eTime: 5253.525 ms (00:05.254)\nTime: 5269.091 ms (00:05.269)\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eTime: 222606.614 ms (03:42.607)\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eDROP INDEX tstz_idx\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eDROP INDEX\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eTime: 34338.246 ms (00:34.338)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003eあれ、インデックスを張ると遅くなってる！？\u003c/strong\u003eWHEREが4.8秒→5.2秒と若干遅くなり、フルソートが最悪で34秒→3分42秒と大幅に悪化しました。ただEXPLAIN ANALYZEで分析してみると、インデックスを張ったほうが総コストは下がっています。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eEXPLAIN ANALYZE SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003e#\u003c/span\u003eインデックスなしの場合\n\u003cspan class=\"go\"\u003e                                                                QUERY PLAN\n\n--------------------------------------------------------------------------------\n----------------------------------------------------------\n Gather Merge  (cost=1195321.36..2167611.54 rows=8333334 width=113) (actual time\n=5736.849..9649.220 rows=10000000 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e   -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eSort  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1194321.34..1204738.00 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 \u003cspan class=\"nv\"\u003ewidth\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e113\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eactual \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e5\n\u003cspan class=\"go\"\u003e478.435..6237.954 rows=3333333 loops=3)\n         Sort Key: tstz\n         Sort Method: external merge  Disk: 462648kB\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e         -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eParallel Seq Scan on multi  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.00..223485.67 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 widt\n\u003cspan class=\"go\"\u003eh=113) (actual time=0.353..1055.199 rows=3333333 loops=3)\n Planning time: 0.096 ms\n Execution time: 10008.774 ms\n(9 rows)\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e#\u003c/span\u003eインデックスありの場合\n\u003cspan class=\"go\"\u003e                                                                QUERY PLAN\n\n--------------------------------------------------------------------------------\n----------------------------------------------------------\n Index Scan using tstz_idx on multi  (cost=0.44..986963.25 rows=10000000 width=1\n13) (actual time=0.168..184216.684 rows=10000000 loops=1)\n Planning time: 1.685 ms\n Execution time: 184658.639 ms\n(3 rows)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e処理時間は34秒→3分42秒と悪化しているのに、総コストは216万→98万と改善しています。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eインデックスが激遅になってしまうのは、シャッフルされたカラムに対してインデックスを張ったのが原因\u003c/strong\u003eだったようです（後述）。そもそも論でこんなランダムな日付のデータをデータベースに突っ込むべきではないし、突っ込むにしてもソートしてから突っ込むべきですよね。\u003c/p\u003e\n\n\u003cp\u003eインデックスなしの場合に「Workers Launched: 2」という並列化のようなもの（パラレルスキャンというそうです）が自動でなされているのも興味深いです。今のPostgreSQLはとてもお利口なので、インデックスなしの1000万件をソートするとかいうアホなクエリを書いても、自動でいろいろチューニングしてくれるのでしょう。なので、この例ではたまたまそうでしたが、インデックスないほうが処理が速く終わるというのは、かなり特殊な状況と認識しておいたほうがよさそうです。EXPLAIN ANALYZEでの総コスト値はインデックスがあったほうが少ないので。\u003c/p\u003e\n\n\u003cp\u003eインデックスの明確なデメリットはあります。以下、インデックスがある場合、ない場合での\u003ca href=\"https://www.postgresql.jp/document/8.1/html/functions-admin.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003epg_total_relation_size\u003c/a\u003e（インデックス込みのバイト数）です。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"text\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003efoo=# SELECT relname, pg_size_pretty(pg_total_relation_size(relid)) FROM pg_stat\n_user_tables WHERE relname = 'multi';\n relname | pg_size_pretty\n---------+----------------\n multi   | 1635 MB\n(1 row)\n\nfoo=# DROP INDEX tstz_idx;\nfoo=# SELECT relname, pg_size_pretty(pg_total_relation_size(relid)) FROM pg_stat\n_user_tables WHERE relname = 'multi';\n relname | pg_size_pretty\n---------+----------------\n multi   | 1421 MB\n(1 row)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eインデックスだけで200MB以上使用しています。乱用は厳禁です。INDEXをUNIQUE INDEXにしてみましたが、大して変わらなかったので省略します。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"42-プライマリーキーを張る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#42-%E3%83%97%E3%83%A9%E3%82%A4%E3%83%9E%E3%83%AA%E3%83%BC%E3%82%AD%E3%83%BC%E3%82%92%E5%BC%B5%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.2 プライマリーキーを張る\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eALTER TABLE multi ADD PRIMARY KEY\u003cspan class=\"o\"\u003e(\u003c/span\u003etstz\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e一旦インデックスを削除し、プライマリーキーを張ってみました。結果はインデックスの場合と変わらなかったので省略します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eALTER TABLE multi DROP CONSTRAINT multi_pkey\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"43-インデックスはシャッフルされたデータが苦手\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#43-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%AF%E3%82%B7%E3%83%A3%E3%83%83%E3%83%95%E3%83%AB%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E8%8B%A6%E6%89%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.3 インデックスはシャッフルされたデータが苦手？\u003c/h3\u003e\n\n\u003cp\u003e追加で実験してみたところ興味深いことがわかりました。先程の「SELECT * FROM multi ORDER BY tstz」というソートですが、一旦ソートしてから別のテーブルに格納し、同じようにソートしてみます（後半の場合のソートは事実上意味がない）。そしてその時間をインデックスあり・なしで比較します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE TABLE multi2 AS SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこのようにソート済みのテーブルmulti2を作ります。インデックスなしでソートすると次のようになります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi2 ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eTime: 39986.190 ms (00:39.986)\nTime: 34903.614 ms (00:34.904)\nTime: 33085.059 ms (00:33.085)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eインデックスなしの場合は、\u003cstrong\u003e未ソートのテーブルmultiの場合とほぼ変わりません。\u003c/strong\u003e未ソートの場合は、インデックスを作成すると大幅にパフォーマンスが悪化（34秒→3分42秒）しましたが、ソート済みテーブルの場合はどうでしょうか？\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX tstz_idx ON multi2\u003cspan class=\"o\"\u003e(\u003c/span\u003etstz\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi2 ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eTime: 30379.679 ms (00:30.380)\nTime: 30317.588 ms (00:30.318)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e格納時にソートすることでインデックススキャンが速くなりました！　\u003c/strong\u003eソート済みの場合は、インデックス未作成の場合よりフルソートでも3～4秒速くなりました。これがインデックスの本来のパフォーマンスでしょう。詳細は省略してしまいましたが、WHEREによる比較もインデックスがない場合より速くなりました（1年分を抽出するので時間が半分に）。\u003c/p\u003e\n\n\u003cp\u003ePostgreSQL（SQL全般）のデフォルトのインデックスに、\u003ca href=\"https://www.postgresql.jp/document/9.0/html/indexes-types.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eBtree\u003c/a\u003eとよばれるデータ構造を使用しています。これが2分探索木に近いデータ構造であるため、ソートされたデータに対してインデックスを張ったほうが明らかにパフォーマンスが良いです。なるほど、これはいい勉強になりました。\u003c/p\u003e\n\n\u003cp\u003eEXPLAIN ANALYZEでも確認してみます。multiが未ソート、multi2が事前にソート済みです。multi2はソート後にインデックスを張り、multiはソート前にインデックスを張ってソートのクエリをEXPLAIN ANALYZEをします。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX tstz_index ON multi\u003cspan class=\"o\"\u003e(\u003c/span\u003etstz\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eCREATE INDEX\nTime: 13162.883 ms (00:13.163)\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eEXPLAIN ANALYZE SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e                                                                 QUERY PLAN\n\n--------------------------------------------------------------------------------\n------------------------------------------------------------\n Index Scan using tstz_index on multi  (cost=0.44..986963.25 rows=10000000 width\n=113) (actual time=0.090..189174.966 rows=10000000 loops=1)\n Planning time: 1.310 ms\n Execution time: 189723.607 ms\n(3 rows)\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e#\u003c/span\u003e\u003cspan class=\"c\"\u003e###\u003c/span\u003e\n\u003cspan class=\"go\"\u003e\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eEXPLAIN ANALYZE SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi2 ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e                                                               QUERY PLAN\n\n--------------------------------------------------------------------------------\n---------------------------------------------------------\n Index Scan using tstz_idx on multi2  (cost=0.44..441510.44 rows=10000000 width=\n113) (actual time=0.101..2790.953 rows=10000000 loops=1)\n Planning time: 0.065 ms\n Execution time: 2949.663 ms\n(3 rows)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eどちらもIndex Scanが用いられています。総コストを見ると、multi2（ソート済み）が44万であるのに対して、multi（未ソート）は倍以上の98万です。ソート済みだから当たり前だろうと思うかもしれませんが、\u003cstrong\u003eSeq Scanの場合はソートの有無にかかわらず総コストは変わりませんでした\u003c/strong\u003e。どちらもインデックスを外してもう一度EXPLAIN ANALYZEしてみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eDROP INDEX tstz_idx\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eDROP INDEX tstz_index\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eEXPLAIN ANALYZE SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e                                                                 QUERY PLAN\n\n--------------------------------------------------------------------------------\n------------------------------------------------------------\n Gather Merge  (cost=1195321.36..2167611.54 rows=8333334 width=113) (actual time\n=22250.940..26635.054 rows=10000000 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e   -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eSort  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1194321.34..1204738.00 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 \u003cspan class=\"nv\"\u003ewidth\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e113\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eactual \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e2\n\u003cspan class=\"go\"\u003e1821.372..22626.747 rows=3333333 loops=3)\n         Sort Key: tstz\n         Sort Method: external merge  Disk: 439040kB\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e         -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eParallel Seq Scan on multi  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.00..223485.67 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 widt\n\u003cspan class=\"go\"\u003eh=113) (actual time=10.119..17335.576 rows=3333333 loops=3)\n Planning time: 0.049 ms\n Execution time: 26895.805 ms\n(9 rows)\nTime: 26897.545 ms (00:26.898)\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e#\u003c/span\u003e\u003cspan class=\"c\"\u003e###\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eEXPLAIN ANALYZE SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi2 ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e                                                                QUERY PLAN\n\n--------------------------------------------------------------------------------\n-----------------------------------------------------------\n Gather Merge  (cost=1195321.36..2167611.54 rows=8333334 width=113) (actual time\n=3775.550..7609.507 rows=10000000 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e   -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eSort  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1194321.34..1204738.00 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 \u003cspan class=\"nv\"\u003ewidth\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e113\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eactual \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e3\n\u003cspan class=\"go\"\u003e705.071..4224.302 rows=3333333 loops=3)\n         Sort Key: tstz\n         Sort Method: external sort  Disk: 502600kB\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e         -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eParallel Seq Scan on multi2  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.00..223485.67 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 wid\n\u003cspan class=\"go\"\u003eth=113) (actual time=0.234..1517.535 rows=3333333 loops=3)\n Planning time: 9.965 ms\n Execution time: 8770.950 ms\n(9 rows)\nTime: 8781.462 ms (00:08.781)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"44-レコードのソート状態とシーケンシャルソートの速度をcで比較\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#44-%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E3%82%BD%E3%83%BC%E3%83%88%E7%8A%B6%E6%85%8B%E3%81%A8%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B7%E3%83%A3%E3%83%AB%E3%82%BD%E3%83%BC%E3%83%88%E3%81%AE%E9%80%9F%E5%BA%A6%E3%82%92c%E3%81%A7%E6%AF%94%E8%BC%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.4 レコードのソート状態とシーケンシャルソートの速度をC#で比較\u003c/h3\u003e\n\n\u003cp\u003e4.3ではコンソールを用いて、レコードのソートの有無とシーケンシャルソートの実行時間がほとんど変わらないということを確認しましたが、さすがにそれは腑に落ちないのでC#（Npgsql）側でも確認してみます。\u003cbr\u003e\nなぜ腑に落ちないのかというと、ソート済みのテーブルで「SELECT * FROM テーブルORDER BY ソート済みカラム」をやったとしても、やっていることは実質的に「SELECT * FROM テーブル」と変わらないからです。つまり、ソート済みのテーブルと未ソートのテーブルで、結果的にORDER BYの処理時間が無視できる…さすがにそれはないだろう。となったわけです。\u003c/p\u003e\n\n\u003cp\u003eまず、multiから以下のような4つの派生テーブルを作ります。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eソート\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eインデックス\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eテーブル名\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eCREATE TABLE … AS\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_nosorted_noindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSELECT * FROM multi\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_nosorted_withindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSELECT * FROM multi\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_sorted_noindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSELECT * FROM multi ORDER BY tstz\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_sorted_withindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSELECT * FROM multi ORDER BY tstz\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eインデックスには各テーブルのtstz（Timestamptz）を使います。まず、スキャンの方式ですが、SELECT * FROM テーブル（全レコードスキャン）は、EXPLAIN ANALYZEで確認したところインデックスの有無にかかわらずSeq Scanが用いられました。ORDER BYを用いると、インデックスありの場合はIndex Scanになり、インデックスなしの場合はSeq Scanとなりました。スキャン方式をまとめると次のようになります。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eソート\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eインデックス\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eテーブル名\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eSELECT *\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eSELECT * … ORDER BY\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_nosorted_noindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_nosorted_withindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eIndex\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_sorted_noindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_sorted_withindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eIndex\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e4テーブルに対して、「SELECT *　FROM テーブル」と「SELECT *　FROM テーブル ORDER BY tstz」の2つのクエリをC#側から行い、実行時間を比較します。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"select--from-テーブル\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#select--from-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eSELECT * FROM テーブル\u003c/h4\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eソート\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eインデックス\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eテーブル名\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eスキャン方式\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e中間値[ms]\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e平均値[ms]\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e1回目\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e2回目\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e3回目\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_nosorted_noindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,306.42\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,211.07\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,306.42\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e12,816.77\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,510.03\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_nosorted_withindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,297.97\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,560.73\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,297.97\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e14,098.73\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,285.48\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_sorted_noindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e14,412.15\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e14,249.22\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e14,412.15\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,885.87\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e14,449.65\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_sorted_withindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,850.53\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e14,060.40\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,850.53\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e14,483.26\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e13,847.42\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eどれもほぼ変わりません。全部シーケンシャルスキャンだからそれはそう。\u003c/p\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"select-from-テーブル-order-by-tstz\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#select-from-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB-order-by-tstz\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eSELECT *　FROM テーブル ORDER BY tstz\u003c/h4\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eソート\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eインデックス\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eテーブル名\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eスキャン方式\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e中間値[ms]\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e平均値[ms]\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e1回目\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e2回目\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e3回目\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e4回目\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003e5回目\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_nosorted_noindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e21,643.11\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e21,527.77\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e21,875.27\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e21,276.25\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e21,643.11\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e20,707.07\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e22,137.14\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_nosorted_withindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eIndex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e225,930.34\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e229,355.78\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e213,420.65\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e217,755.75\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e225,930.34\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e246,658.27\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e243,013.88\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e×\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_sorted_noindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eSeq\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e25,633.70\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e27,572.08\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e37,830.12\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e28,122.39\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e25,633.70\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e21,681.04\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e24,593.16\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e○\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003emulti_sorted_withindex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003eIndex\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e16,489.44\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e16,572.41\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e18,633.70\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e16,489.44\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e15,672.30\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e16,515.13\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e15,551.51\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e\u003cstrong\u003eソート×、インデックス○な場合だけ桁が違います\u003c/strong\u003e。これはコンソールの場合と同じです。インデックス×、ソートの有無でソートの速度が違うかというと、見た目はソート○のほうが遅いという謎な結果ですが、初回は特に外れ値のように遅いので、ディスクアクセスやキャッシュの誤差の範囲内かと考えられます。ソート済みのほうが遅くなるというのはEXPLAIN ANALYZEからも説明できません。したがって、シーケンシャルなソートにおいて、事前ソートの有無はパフォーマンスに影響を与えるということを確認できなかったといえるでしょう。\u003c/p\u003e\n\n\u003cp\u003e4.4の冒頭の疑問は解決しませんでしたが、コンソールからやってもアプリケーションからやっても同じ結果になるのはまあそういうものであると受け止めるしかありません。\u003c/p\u003e\n\n\u003cp\u003eC#でのコードは以下の通りです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eC#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNpgsql\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eIndexBenchmark\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMultiTableBenchmarck\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnectionStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eHost\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"localhost\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePort\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5432\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eUsername\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"postgres\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePassword\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"postgres\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDatabase\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConnectionString\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etables\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"s\"\u003e\"multi_nosorted_noindex\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"multi_nosorted_withindex\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"multi_sorted_noindex\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"multi_sorted_withindex\"\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConnection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//SELECT *　FROM テーブル(各3回)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"--- SELECT *　FROM テーブル ---\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etable\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003etables\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRestart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommandText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"SELECT * FROM \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteReader\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsed\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTotalMilliseconds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendLine\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//SELECT * FROM テーブル ORDER BY tstz(各5回)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"--- SELECT *　FROM テーブル ORDER BY tstz---\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etable\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003etables\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRestart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommandText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"SELECT * FROM \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e ORDER BY tstz\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteReader\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAppendLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsed\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTotalMilliseconds\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e//結果の保存\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIO\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteAllText\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"indexbench.txt\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"45-インデックスの有無とデータ型\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#45-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%AE%E6%9C%89%E7%84%A1%E3%81%A8%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.5 インデックスの有無とデータ型\u003c/h3\u003e\n\n\u003cp\u003e単一カラムの場合はデータ型によってシーケンシャルスキャンの遅い速いがありましたが、これはインデックスがあった場合でも同様になるのでしょうか？\u003cbr\u003e\ntstz（TIMESTAMPTZ型）についてソート済みであるmulti_tstz、int（BIGINT型）についてソート済みのmulti_int、jsonカラム（JSONB型）のtimestampフィールドについてソート済みであるmulti_jsonの各3つのテーブルを作成します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE TABLE multi_tstz AS SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE TABLE multi_int AS SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY int\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE TABLE multi_json AS SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi ORDER BY json-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e4.3～4.4で事前にソート済みかどうかが、シーケンシャルなソートにおけるパフォーマンスに影響を及ぼさないであろうということがわかったので、この状態でソート操作を行い、インデックスの有無による処理時間を見ます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003e#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eこれを3回\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi_tstz ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003e#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eインデックスを作る\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX multi_tstz_index ON multi_tstz\u003cspan class=\"o\"\u003e(\u003c/span\u003etstz\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003e#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eインデックススキャンを3回\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi_tstz ORDER BY tstz\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e以下同様。JSONBのmulti_jsonのインデックス作成はちょっと特殊で、同じくBtreeインデックスを利用しますが、フィールドを()でくくります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX multi_json_index ON multi_json\u003cspan class=\"o\"\u003e((\u003c/span\u003ejson-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e結果は以下の通り。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eORDER / SeqScan [ms]\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003etstz\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eint\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003ejson\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e1回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e34,536.86\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e39,183.36\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e44,027.67\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e2回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e29,900.62\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e29,980.37\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e32,915.02\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e3回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e29,649.35\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e29,488.35\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e33,316.29\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中間値[ms]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e29,900.62\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e29,980.37\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e33,316.29\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eORDER / IndexScan [ms]\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003etstz\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eint\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003ejson\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e1回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e25,915.84\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e26,555.30\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e29,139.74\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e2回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e27,363.52\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e26,978.52\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e27,797.72\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e3回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e27,745.97\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e26,959.08\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e28,818.42\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中間値[ms]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e27,363.52\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e26,959.08\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e28,818.42\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eシーケンシャルな場合は若干JSONBが遅かったですが、インデックスの場合はどれもほぼ変わらないように見えます。ただ、これだけではなんとも言えないのでJSONBについては後ほどレコードのサイズを変えて実験してみます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"46-複数カラムまとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#46-%E8%A4%87%E6%95%B0%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e4.6 複数カラムまとめ\u003c/h3\u003e\n\n\u003cp\u003eインデックス絡みでだいぶ脱線してしまいましたがまとめます\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e複数カラムの場合でも、シーケンシャルなソートをする場合、単体カラムと同様TEXTやJSONBなどソートが遅い型は遅いままという性質は変わらない\u003c/li\u003e\n\u003cli\u003eシーケンシャルスキャンの場合、全般的なソート時間は行あたりのデータサイズが大きくなればなるほど遅くなる。いくらソートのキーに速い型を使ってもソート時間は容量に引っ張られる。\u003c/li\u003e\n\u003cli\u003eシーケンシャルスキャンの場合、レコードの状態（事前にソート済みかそうでないか）はソートのパフォーマンスに影響を与えないように見える（数回やっただけだから反例あるかもしれない）。ただし、Btreeインデックスによるスキャンの場合、レコードの状態がパフォーマンスに大きく影響を与える。\u003c/li\u003e\n\u003cli\u003eBtreeインデックスはソートされた状態で使うべき。完全にランダムな状態だとインデックスを張ったほうが明らかに遅くなることがある（ただしEXPLAIN ANALYZEでの総コストはランダムでも、インデックススキャンのほうがシーケンシャルスキャンより少ない）。\u003c/li\u003e\n\u003cli\u003ePostgreSQLのバージョンによっては、シーケンシャルスキャンにはパラレルスキャンなどの最適化が入るため、シャッフルされたカラムに対して下手にインデックスを張るよりも、シーケンシャルスキャンでソートしたほうが速くなることがある。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"5jsonbにおけるソートに無関係なデータのサイズとパフォーマンス\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#5jsonb%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%BD%E3%83%BC%E3%83%88%E3%81%AB%E7%84%A1%E9%96%A2%E4%BF%82%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%A8%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.JSONBにおけるソートに無関係なデータのサイズとパフォーマンス\u003c/h2\u003e\n\n\u003cp\u003e最後に、JSONBでKVSで格納する場合に、ソートに無関係なデータのサイズとソート時間をインデックス有り・無しで比較します。これまでの調査で、シーケンシャルなソート時間と全体のデータのサイズはほぼ比例することがわかったので、インデックスなしの場合のソート時間は無関係なデータが増えるほど遅くなるはずです。ただし、インデックスとは文字通り”索引”なので、インデックスありかつレコードの件数が同一な場合において、無関係なデータが増えても定数時間で検索できれば、これほど嬉しいことはありません。\u003c/p\u003e\n\n\u003cp\u003e今回はインデックスとしてGINインデックスではなく、フィールドに対してBtreeインデックスを使います。なぜならGINインデックスはORDER BYのような比較演算子に対応していないためです。\u003ca href=\"https://www.postgresql.jp/document/9.5/html/datatype-json.html#json-indexing\" rel=\"nofollow noopener\" target=\"_blank\"\u003e公式ドキュメント\u003c/a\u003eより、\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003ejsonb型の問い合わせでサポートしているデフォルトのGIN演算子クラスは、トップレベルのキーが存在するかの演算子として?、?\u0026amp;、?|があり、パス／値が存在するかの演算子として@\u0026gt;があります\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eBtreeインデックスを効率よく使うために、ランダムではなく事前にソート済みのデータを用います。ソート済みのデータをソートするというのも不思議な話ですが、事前にソートしようがしまいがシーケンシャル（インデックスを張らない場合）なソートにおいて処理時間が特に変わらなかったから仕方ありません。気持ち悪ければ、事前に昇順にソートしたデータを、ORDER BY…DESCで降順ソートすると置き換えて読んでも構いません。事実、4.5で登場したjson-\u0026gt;\u0026gt;'timestamp'について昇順ソート済みのmulti_jsonテーブルに対して、シーケンシャルなソートを行ってみると\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eDROP INDEX multi_json_index\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi_json ORDER BY json-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e DESC\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eTime: 39736.049 ms (00:39.736)\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM multi_json ORDER BY json-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eTime: 39991.808 ms (00:39.992)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e昇順でソートしようが、降順でソートしようが時間は変わりません。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"51-データの用意\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#51-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%94%A8%E6%84%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.1 データの用意\u003c/h3\u003e\n\n\u003cp\u003eここでは、\u003cstrong\u003e無関係なデータとして128文字のランダムな英数字を用いて、その文字列を配列として格納します。配列の要素数を1、3、5と変化させたテーブル、one, three, five\u003c/strong\u003eを作り、インデックスの有無でORDER BYの時間を比較します。JSON生成部分のC#プログラムを再掲します（全部のコードは2を参照）。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eC#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eRandomData\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"cm\"\u003e/*\n  * 略\n  */\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nf\"\u003eToRandomStringContainsJson\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etakeLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etakeLength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003etakeLength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eRandomString\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eServiceStack\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDynamicJson\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSerialize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003etimestamp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTimeStamp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erandom_str\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eRandomString\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etakeLength\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToArray\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこの引数のtakeLengthを1,3,5と変化させます。CreateDataのクラスに連続したデータを読み書きするクラスを作ります。例えば5の場合はこのようになります。全く意味のないゴミデータです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"go\"\u003e{\"timestamp\":\"2001-09-09T10:46:40.0000000+09:00\",\"random_str\":[\"o+}bxM4:Pr}8%WPG\n\u003c/span\u003e\u003cspan class=\"gp\"\u003eG^BG%l7OOWj;\u003c/span\u003e/t\u003cspan class=\"p\"\u003e;\u003c/span\u003e4R-eRlPxkTu\u003cspan class=\"k\"\u003e*\u003c/span\u003eOy\u003cspan class=\"o\"\u003e(\u003c/span\u003ev:wD:QIv0oe:q!1Z\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"c\"\u003e#ZMtz6iidng+ck}tnXNTmd(sFcXoxyET9\u003c/span\u003e\n\u003cspan class=\"gp\"\u003erzuJQ)\u0026gt;\u003c/span\u003enSGmc^pm[L\u003cspan class=\"o\"\u003e)\u003c/span\u003e.v4\u003cspan class=\"o\"\u003e=\u003c/span\u003ehrg\u0026amp;TBByBJ\u003cspan class=\"s2\"\u003e\",\"\u003c/span\u003eokZ6.-Ol\u0026amp;VELOD9u#V-]21fOb6oGc?LjMiZwOY59Q_[6a\n\u003cspan class=\"gp\"\u003ehrgKbk_eS^!{:xJ-bnK[6;\u003c/span\u003edk:jA\u003cspan class=\"nv\"\u003e$x\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003eG\u003cspan class=\"o\"\u003e}\u003c/span\u003eihQqZpL?]8H\u003cspan class=\"k\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eBQWVqmYc\u003cspan class=\"k\"\u003e*\u003c/span\u003eABBE-KMbub\u003cspan class=\"k\"\u003e*\u003c/span\u003ejio\u0026amp;yN-BRWk6/]\n\u003cspan class=\"gp\"\u003e8g+\",\"%D65r3T[FY#\u003c/span\u003eHeb\u003cspan class=\"p\"\u003e;\u003c/span\u003ea#Q0a4S\u0026amp;3oNrdeZ]-.CHD1DcoRd\u0026gt;l_:er\u003cspan class=\"o\"\u003e}\u003c/span\u003ec\u003cspan class=\"o\"\u003e(\u003c/span\u003eOkpbV@\u003cspan class=\"o\"\u003e(\u003c/span\u003eeljc?XyagOTe\u0026gt;K9I\n\u003cspan class=\"gp\"\u003eKs{D6MO=h^L)R8]7ylEdHJs2@mY#\u003c/span\u003eA7jp#t\u003cspan class=\"nv\"\u003e$=\u003c/span\u003e7^bJh\u003cspan class=\"o\"\u003e=\u003c/span\u003e6Vfi4Tabz3G/\u003cspan class=\"s2\"\u003e\",\"\u003c/span\u003e?Oap\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4Mfr9Roq9NSj!\u003cspan class=\"o\"\u003e(}\u003c/span\u003e_?\n\u003cspan class=\"gp\"\u003e-7G_):/+yO@O9\u0026amp;Cnv0T-4OpkM@ubHx)p\u0026gt;\u003c/span\u003eUtqk\u003cspan class=\"p\"\u003e;\u003c/span\u003eY\u003cspan class=\"o\"\u003e)\u003c/span\u003eWo+Vy-MjJ4U_3v\u0026gt;Y\u003cspan class=\"p\"\u003e;\u003c/span\u003eMF\u003cspan class=\"nv\"\u003e$42\u003c/span\u003e:vetmZ9RxyMd[e]u1s\n\u003cspan class=\"gp\"\u003eY9VN72q:c4:EV5R4=?xEt0)Uy\",\"[yh)CdH5.NUf-8\u0026gt;\u003c/span\u003e6:.@d@4p@%7mF+L6\u003cspan class=\"p\"\u003e;\u003c/span\u003eqbc\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"nv\"\u003ei3SqCJ\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003en-Uj\u003cspan class=\"o\"\u003e(\u003c/span\u003eNpp9\n\u003cspan class=\"gp\"\u003e5kO6@_nw;\u003c/span\u003e\u003cspan class=\"nv\"\u003eN\u003c/span\u003e\u003cspan class=\"o\"\u003e=}\u003c/span\u003eT9^v/F3u\u003cspan class=\"o\"\u003e(\u003c/span\u003eVIx\u003cspan class=\"nv\"\u003e$@\u003c/span\u003e\u003cspan class=\"k\"\u003e*\u003c/span\u003eg.jftRlpXh0G\u003cspan class=\"o\"\u003e}\u003c/span\u003ev\u003cspan class=\"p\"\u003e;\u003c/span\u003eR\u0026amp;-x+D^2\u003cspan class=\"p\"\u003e;\u003c/span\u003e02:|_1c2/YBKK8zI%5ac@:[k@\u003cspan class=\"s2\"\u003e\"]}\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eファイルへの読み書きは次の通り。これまでと同様に1000万レコード作ります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eC#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCreateData\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMakeSeqData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eseqEpoch\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e10000000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSelect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"n\"\u003ee9\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e31\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFileStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"seq\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAccess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStreamWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efs\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eseqEpoch\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ejson\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eJsonSerializer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeToString\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ejson\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eReadSeqData\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFileStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"seq\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAccess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStreamReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efs\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePeek\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadLine\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJsonSerializer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDeserializeFromString\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRandomData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e挿入は以下の通り。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eC#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eNpgsql\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eseq\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadSeqData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnectionStringBuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eHost\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"localhost\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePort\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5432\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eUsername\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"postgres\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePassword\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"postgres\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eDatabase\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlConnection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuilder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConnectionString\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etable\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"s\"\u003e\"one\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"three\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\"five\"\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNpgsqlCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConnection\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\n                \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommandText\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e$\"CREATE TABLE \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e (id INTEGER, json JSONB)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExecuteNonQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econ\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBeginBinaryImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"COPY \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]}\u003c/span\u003e\u003cspan class=\"s\"\u003e(id, json) FROM STDIN (FORMAT BINARY)\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecnt\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eseq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStartRow\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecnt\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInteger\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ewriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToRandomStringContainsJson\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eNpgsqlTypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNpgsqlDbType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJsonb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003ecnt\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eインデックスをつけない状態のテーブルサイズは次の通り。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT relname, pg_size_pretty\u003cspan class=\"o\"\u003e(\u003c/span\u003epg_relation_size\u003cspan class=\"o\"\u003e(\u003c/span\u003erelid\u003cspan class=\"o\"\u003e))\u003c/span\u003e FROM pg_stat_user_tables ORDER BY relid DESC LIMIT 3\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e relname | pg_size_pretty\n---------+----------------\n five    | 7813 MB\n three   | 4883 MB\n one     | 2367 MB\n(3 rows)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"52-jsonbのフィールドにインデックスをつけてもorder-byでインデックスが使われないことがある\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#52-jsonb%E3%81%AE%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%81%AB%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E3%81%A4%E3%81%91%E3%81%A6%E3%82%82order-by%E3%81%A7%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%8C%E4%BD%BF%E3%82%8F%E3%82%8C%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.2 JSONBのフィールドにインデックスをつけてもORDER BYでインデックスが使われないことがある\u003c/h3\u003e\n\n\u003cp\u003eこれまでのようにjson-\u0026gt;\u0026gt;'timestamp'にインデックスをつければインデックススキャンになるのかと思ったら、\u003cstrong\u003eインデックスを使われる場合と使われない場合がありました\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX one_idx ON one\u003cspan class=\"o\"\u003e((\u003c/span\u003ejson-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX three_idx ON three\u003cspan class=\"o\"\u003e((\u003c/span\u003ejson-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX five_idx ON five\u003cspan class=\"o\"\u003e((\u003c/span\u003ejson-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"o\"\u003e))\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eEXPLAIN ANALYZE SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM one ORDER BY json-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e                                                               QUERY PLAN\n--------------------------------------------------------------------------------\n--------------------------------------------------------\n Index Scan using one_idx on one  (cost=0.56..1675472.56 rows=10000000 width=248\n) (actual time=13.762..26074.756 rows=10000000 loops=1)\n Planning time: 37.796 ms\n Execution time: 26643.971 ms\n(3 rows)\n\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eEXPLAIN ANALYZE SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM three ORDER BY json-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e                                                                 QUERY PLAN\n--------------------------------------------------------------------------------\n------------------------------------------------------------\n Gather Merge  (cost=3998770.03..4971060.21 rows=8333334 width=512) (actual time\n=172476.795..201055.184 rows=10000000 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e   -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eSort  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e3997770.00..4008186.67 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 \u003cspan class=\"nv\"\u003ewidth\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e512\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eactual \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1\n\u003cspan class=\"go\"\u003e72172.880..182443.152 rows=3333333 loops=3)\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e         Sort Key: ((json -\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e::text\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003cspan class=\"go\"\u003e         Sort Method: external sort  Disk: 1741360kB\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e         -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eParallel Seq Scan on three  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.00..677083.33 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 widt\n\u003cspan class=\"go\"\u003eh=512) (actual time=4.656..162457.024 rows=3333333 loops=3)\n Planning time: 31.543 ms\n Execution time: 201925.840 ms\n(9 rows)\n\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eEXPLAIN ANALYZE SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM five ORDER BY json-\u0026gt;\u0026gt;\u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e                                                                 QUERY PLAN\n--------------------------------------------------------------------------------\n------------------------------------------------------------\n Gather Merge  (cost=5783689.03..6755979.21 rows=8333334 width=776) (actual time\n=236130.058..326493.436 rows=10000000 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e   -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eSort  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e5782689.00..5793105.67 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 \u003cspan class=\"nv\"\u003ewidth\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e776\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eactual \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e2\n\u003cspan class=\"go\"\u003e36071.833..274220.890 rows=3333333 loops=3)\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e         Sort Key: ((json -\u0026gt;\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"s1\"\u003e'timestamp'\u003c/span\u003e::text\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003cspan class=\"go\"\u003e         Sort Method: external sort  Disk: 2554256kB\n\u003c/span\u003e\u003cspan class=\"gp\"\u003e         -\u0026gt;\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003eParallel Seq Scan on five  \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003ecost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.00..1052083.33 \u003cspan class=\"nv\"\u003erows\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4166667 widt\n\u003cspan class=\"go\"\u003eh=776) (actual time=3.433..222802.313 rows=3333333 loops=3)\n Planning time: 0.191 ms\n Execution time: 327663.142 ms\n(9 rows)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003eoneはインデックススキャンになっているのに、threeとfiveはシーケンシャルスキャンです\u003c/strong\u003e。なんやそれ？？　仕方がないので、インデックスをjson-\u0026gt;\u0026gt;'timestamp'ではなくidカラムに対して付与してみます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX five_int_idx ON five\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003eCREATE INDEX\n\u003c/span\u003e\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eEXPLAIN ANALYZE SELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM five ORDER BY \u003cspan class=\"nb\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"go\"\u003e                                                                 QUERY PLAN\n\n--------------------------------------------------------------------------------\n-------------------------------------------------------------\n Index Scan using five_int_idx on five  (cost=0.44..1259691.44 rows=10000000 wid\nth=744) (actual time=0.531..10676.681 rows=10000000 loops=1)\n Planning time: 2.966 ms\n Execution time: 10848.587 ms\n(3 rows)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eint型のidカラムに対してだとさすがにインデックススキャンが用いられました。さすがにこれは予想外だったので、\u003cstrong\u003e計画を変更して、「SELECT * FROM テーブル ORDER BY id」で比較します\u003c/strong\u003e。idカラムに対してインデックスを不可した場合はインデックススキャンになることを確認しました。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"53-keyidカラムによるソートの結果\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#53-keyid%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AB%E3%82%88%E3%82%8B%E3%82%BD%E3%83%BC%E3%83%88%E3%81%AE%E7%B5%90%E6%9E%9C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e5.3 Key（idカラム）によるソートの結果\u003c/h3\u003e\n\n\u003cp\u003e以下のような流れで行います（事前にインデックスは全てはずしておきます）。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"gp\"\u003e#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eシーケンシャルスキャンを3回\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM one ORDER BY \u003cspan class=\"nb\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003e#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eインデックスを作る\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eCREATE INDEX one_id_idx ON one\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"gp\"\u003e#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eインデックススキャンを3回\n\u003cspan class=\"gp\"\u003efoo=#\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003eSELECT \u003cspan class=\"k\"\u003e*\u003c/span\u003e FROM one ORDER BY \u003cspan class=\"nb\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e時間比較はまたコンソールの\\timingで行いました。その前に、\u003cstrong\u003ejson-\u0026gt;\u0026gt;'timestamp'をインデックスなしでソートした場合\u003c/strong\u003eの時間を張っておきます。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003ejson-\u0026gt;\u0026gt;'timestamp' / SeqScan\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eone\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003ethree\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003efive\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e1回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e145,759\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e287,076\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e503,091\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e2回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e105,478\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e261,721\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e403,437\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e3回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e100,498\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e270,508\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e403,140\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中央値[ms]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e105,478\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e270,508\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e403,437\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中央値[mm:ss]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e1:45\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e4:30\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e6:43\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eテーブルサイズ（MB）\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e2,367\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e4,883\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e7,813\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中央値[ms/GB]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e44,562\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e55,398\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e51,637\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e概ねテーブルサイズに比例しています。中央値[ms/GB]は中央値[ms]をテーブルサイズで割って1000掛けて算出しています。次に、\u003cstrong\u003eidをインデックスなしでソート\u003c/strong\u003eします。jsonでのソート時間より若干速いぐらいが期待されます。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eid / SeqScan\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eone\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003ethree\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003efive\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e1回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e190,600\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e264,294\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e420,541\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e2回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e40,040\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e275,050\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e398,599\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e3回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e39,745\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e300,400\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e406,201\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中央値[ms]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e40,040\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e275,050\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e406,201\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中央値[mm:ss]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e0:40\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e4:35\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e6:46\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eテーブルサイズ（MB）\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e2,367\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e4,883\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e7,813\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中央値[ms/GB]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e16,916\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e56,328\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e51,990\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eoneのみキャッシュが効いたのか高速になっていますが、ほとんどjson-\u0026gt;\u0026gt;'timestamp'でソートしたときと変わりません。\u003cstrong\u003eidにインデックスを張って再びソート\u003c/strong\u003eします。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: center\"\u003eid / IndexScan\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003eone\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003ethree\u003c/th\u003e\n\u003cth style=\"text-align: center\"\u003efive\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e1回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e71,156\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e85,095\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e151,068\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e2回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e37,417\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e83,583\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e120,955\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e3回目\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e37,814\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e82,639\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e118,263\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中央値[ms]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e37,814\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e83,583\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e120,955\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中央値[mm:ss]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e0:37\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e1:23\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e2:00\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003eテーブル＋インデックス(MB)\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e2,582\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e5,098\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e8,028\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center\"\u003e中央値[ms/GB]\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e14,645\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e16,395\u003c/td\u003e\n\u003ctd style=\"text-align: center\"\u003e15,067\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eインデックスを張ると、レコード数に対して定数時間でソート可能というのはさすがになりませんでしたが、threeとfiveのテーブルにおいてインデックスを張らない場合の3～4倍の速度でソートできています。線形時間であるものの、インデックスを張らない場合より傾きが緩やかであったというべきでしょう。\u003cbr\u003e\nもちろんこれはソート済みの段階でインデックスを張ったので、ランダムに近いような状態だとこれまで見てきたようにシーケンシャルスキャンより遅くなることもあります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"6まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#6%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e6.まとめ\u003c/h2\u003e\n\n\u003cp\u003e非常に長い投稿になってしまいましたが、これまでの内容を振り返ります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e日付型は実用的には\u003cstrong\u003e利便性重視でtimestampかtimestamptzを用いるべき\u003c/strong\u003e。UNIX時間のようなbitintもありだが、ソートの速度面のメリットはあまりない。\u003cstrong\u003eUUIDも広義のタイムスタンプ（UUID v1）なので必要に応じてあり\u003c/strong\u003e。JSONの場合は型変換が入ってちょっと大変（感覚的には文字列とほとんど変わらない）。\u003c/li\u003e\n\u003cli\u003eレコードあたりの容量にしめるソートのデータの容量少ないほど、データ型ごとの”軽さ”が支配的になる。\u003cstrong\u003eレコードの容量が大きくなればなるほど、よほど変な型でソートしようとしない限り、全体の容量が支配的になるため大差がなくなる\u003c/strong\u003e（bigintとtimestampの差なんてすぐ消える）。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eソート時間はインデックスの有無にかかわらず、同一レコード数の場合、レコードあたりの容量におおよそ比例\u003c/strong\u003eする。\u003cstrong\u003e正しくインデックスを用いると、ソート時間の傾斜がシーケンシャルスキャンな場合より緩やかになる\u003c/strong\u003eため、カラム側に大型のテーブルほどインデックスが有効になる。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eBtreeインデックスはランダムなレコード配列に対して非常に弱い\u003c/strong\u003e。ランダムなレコードに対してインデックスを張ると、インデックスを張らない場合より明らかに遅くなることがある。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eインデックスを使わない（シーケンシャルスキャン）の場合、ソート時間はレコードの事前のソート状態と明確に関係あるとはいえない\u003c/strong\u003e。事前にソートしたからといってソートが速くなるわけではない。この例では無関係であるように見えるが、反例がありそうなので断定はできない。\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eインデックスを用いた（Btreeインデックスによるスキャン）の場合、ソート時間はレコードの状態と明確に関係があり\u003c/strong\u003e、事前にソートしておかない（あるいはインデックスを張るカラムに対して並び順的な意味でシーケンシャルになることを保証しないと）大変なことになる。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e以上です。データベース素人ですが、インデックスについてモヤモヤしたことが解決して勉強になりました。\u003c/p\u003e\n\n\u003cp\u003e以下、チラ裏ですが、処理している途中HDDがガリガリ言っていつ壊れるか不安で仕方なかったので、今度似たようなことをやるときは作業用のSSDを買おうと思いました。fiveのテーブル（8GB程度）をインデックスでソートしている途中のタスクマネージャーのスクショです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/46a14ff9b740cabf6f91e70f8bb1c741c6d0312c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f3233323038382f38616134636635392d633266352d353163312d343237372d3632663363653133623764382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F232088%2F8aa4cf59-c2f5-51c1-4277-62f3ce13b7d8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=6efbd6809f038a6dec3ce610eb3112c8\" alt=\"psqltime.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/232088/8aa4cf59-c2f5-51c1-4277-62f3ce13b7d8.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F232088%2F8aa4cf59-c2f5-51c1-4277-62f3ce13b7d8.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=9ac632ccea11585f6fd09cfec1e83b57 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nメモリの食べ過ぎに注意しましょう。\u003c/p\u003e\n","createdAt":"2018-02-22T12:52:35Z","elapsedYearsFromLastModifiedAt":3,"encryptedId":"GrOh4LiuwrWXR2uhvNDIxBL3NF3CILsC--7oAwr8QjdsnUDl7f--cu6bSLEmT3EDXy+YhDf0/w==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2018-02-22T12:52:35Z","likesCount":9,"linkUrl":"https://qiita.com/koshian2/items/867ed761c9e9d1608911","organization":null,"originalId":612402,"stockedCount":14,"title":"PostgreSQLの日付型のソートとインデックスのパフォーマンス比較","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1postgresql%E3%81%AE%E6%97%A5%E4%BB%98%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B\"\u003e1.PostgreSQLの日付のデータ型\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#2%E7%94%A8%E6%84%8F%E3%81%99%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF\"\u003e2.用意するデータ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#3%E5%8D%98%E4%B8%80%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e3.単一カラムのデータテーブルの場合\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#31-timestamptz%E5%9E%8B\"\u003e3.1 Timestamptz型\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#32-timestamp%E5%9E%8B\"\u003e3.2 Timestamp型\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#33-bigint%E5%9E%8B\"\u003e3.3 BigInt型\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#34-text%E5%9E%8B\"\u003e3.4 Text型\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#35-jsonb%E5%9E%8B\"\u003e3.5 JSONB型\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8D%98%E4%B8%80%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%BE%E3%81%A8%E3%82%81\"\u003e単一カラムまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#4%E8%A4%87%E6%95%B0%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AE%E5%A0%B4%E5%90%88\"\u003e4.複数カラムのデータテーブルの場合\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#41-%E8%A4%87%E6%95%B0%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AE%E3%82%BD%E3%83%BC%E3%83%88\"\u003e4.1 複数カラムの場合のソート\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#42-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E5%BC%B5%E3%82%8B\"\u003e4.2 インデックスを張る\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E5%BC%B5%E3%82%89%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88\"\u003eインデックス張らない場合\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E5%BC%B5%E3%81%A3%E3%81%9F%E5%A0%B4%E5%90%88\"\u003eインデックスを張った場合\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#42-%E3%83%97%E3%83%A9%E3%82%A4%E3%83%9E%E3%83%AA%E3%83%BC%E3%82%AD%E3%83%BC%E3%82%92%E5%BC%B5%E3%82%8B\"\u003e4.2 プライマリーキーを張る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#43-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%AF%E3%82%B7%E3%83%A3%E3%83%83%E3%83%95%E3%83%AB%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E8%8B%A6%E6%89%8B\"\u003e4.3 インデックスはシャッフルされたデータが苦手？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#44-%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E3%82%BD%E3%83%BC%E3%83%88%E7%8A%B6%E6%85%8B%E3%81%A8%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B7%E3%83%A3%E3%83%AB%E3%82%BD%E3%83%BC%E3%83%88%E3%81%AE%E9%80%9F%E5%BA%A6%E3%82%92c%E3%81%A7%E6%AF%94%E8%BC%83\"\u003e4.4 レコードのソート状態とシーケンシャルソートの速度をC#で比較\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#select--from-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB\"\u003eSELECT * FROM テーブル\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#select-from-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB-order-by-tstz\"\u003eSELECT *　FROM テーブル ORDER BY tstz\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#45-%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%AE%E6%9C%89%E7%84%A1%E3%81%A8%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B\"\u003e4.5 インデックスの有無とデータ型\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#46-%E8%A4%87%E6%95%B0%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%BE%E3%81%A8%E3%82%81\"\u003e4.6 複数カラムまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#5jsonb%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%BD%E3%83%BC%E3%83%88%E3%81%AB%E7%84%A1%E9%96%A2%E4%BF%82%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%A8%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9\"\u003e5.JSONBにおけるソートに無関係なデータのサイズとパフォーマンス\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#51-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%94%A8%E6%84%8F\"\u003e5.1 データの用意\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#52-jsonb%E3%81%AE%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%81%AB%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E3%81%A4%E3%81%91%E3%81%A6%E3%82%82order-by%E3%81%A7%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%81%8C%E4%BD%BF%E3%82%8F%E3%82%8C%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8%E3%81%8C%E3%81%82%E3%82%8B\"\u003e5.2 JSONBのフィールドにインデックスをつけてもORDER BYでインデックスが使われないことがある\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#53-keyid%E3%82%AB%E3%83%A9%E3%83%A0%E3%81%AB%E3%82%88%E3%82%8B%E3%82%BD%E3%83%BC%E3%83%88%E3%81%AE%E7%B5%90%E6%9E%9C\"\u003e5.3 Key（idカラム）によるソートの結果\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#6%E3%81%BE%E3%81%A8%E3%82%81\"\u003e6.まとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":11809,"uuid":"867ed761c9e9d1608911","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"jy3QUZSj8C6D4Rn9GwW4AeQEs64r--KI9CrdApZDiOAHqa--CG+XiNqYI12untpdevfEsA==","originalId":232088,"description":"C#使ってましたがPythonに浮気してます。IoTでビッグデータをディープラーニングする闇の魔術の趣味をはじめました。 \r\n新刊通販（NumPy本）　https://koshian2.booth.pm/items/2462894  \r\n通販（GAN本）　https://koshian2.booth.pm/items/1835219  \r\n","facebookUrl":null,"githubUrl":"https://github.com/koshian2","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"koshian2 ＠新刊通販中","profileImageUrl":"https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/232088/bfc82ef2b35f67a9938d0c0b8e47b7f8b31cfd0f/x_large.png?1601448873","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F232088%2Fbfc82ef2b35f67a9938d0c0b8e47b7f8b31cfd0f%2Fx_large.png%3F1601448873?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=c98698abdf0851b3c66f218d8e9427ba","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-image-store%2F0%2F232088%2Fbfc82ef2b35f67a9938d0c0b8e47b7f8b31cfd0f%2Fx_large.png%3F1601448873?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=1bb883886dc4d0acc43421d9cae720cb","urlName":"koshian2","websiteUrl":"https://blog.shikoan.com","twitterUrl":"https://twitter.com/koshian2","twitterUrlName":"koshian2","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"SQL","urlName":"sql"},{"name":"PostgreSQL","urlName":"postgresql"},{"name":"Npgsql","urlName":"npgsql"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
