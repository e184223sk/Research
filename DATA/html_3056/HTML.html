<!DOCTYPE html><html><head><meta charset="utf-8" /><title>.NET (C#)からpythonを呼び出す - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/hogegex/items/3743225a7af13e93df78" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="m0xV7Tt0TTQgxeycIp/GtgHza4Giw1tXZsN/AkA9kU1veZWPQ7YzHolxiztcj0HscGtrYB6+tY8LWQap3GOHeA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content=".NET (C#)からpythonを呼び出す - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1MazVGVkNBb1F5TXA0NEdMNDRLSmNIbDBhRzl1NDRLUzVaRzg0NEd6NVllNjQ0R1omdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9NzUzZjJhZDJjZGQ3OGEzYjY3MGJlNGMyZDgwYzJhYzI&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2h2WjJWblpYZyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWEyYmViYzYxZjQxYmQwYmY4MTExZjdjMmMxMmZkMDFl&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=90e4c09c7c0c1e9779371a0b28b7a883"><meta property="og:description" content="

.NET (C#)からpythonを呼び出す

pythonnetを使って、.NETからpython(cpython)コードを呼び出す方法。
例えば、「Chainerで作ったAI処理を、.NETでつくったGUIから叩きたい！」とか..."><meta content="https://qiita.com/hogegex/items/3743225a7af13e93df78" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="Python,C#,.NET" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-f878b61e-4308-4a57-83f7-e3862b031719"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fhogegex%2Fitems%2F3743225a7af13e93df78">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fhogegex%2Fitems%2F3743225a7af13e93df78">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-f878b61e-4308-4a57-83f7-e3862b031719">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/python","name":"Python"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-07-23T17:39:27.000+09:00","dateModified":"2019-11-16T12:57:31.000+09:00","headline":".NET (C#)からpythonを呼び出す","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1MazVGVkNBb1F5TXA0NEdMNDRLSmNIbDBhRzl1NDRLUzVaRzg0NEd6NVllNjQ0R1omdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9NzUzZjJhZDJjZGQ3OGEzYjY3MGJlNGMyZDgwYzJhYzI\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR2h2WjJWblpYZyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWEyYmViYzYxZjQxYmQwYmY4MTExZjdjMmMxMmZkMDFl\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=90e4c09c7c0c1e9779371a0b28b7a883","mainEntityOfPage":"https://qiita.com/hogegex/items/3743225a7af13e93df78","author":{"@type":"Person","address":"","email":null,"identifier":"hogegex","name":"hogegex","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F39821569%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=2d8cb363fa375210998c41db1a967144","url":"https://qiita.com/hogegex","description":"ニッチならニッチなほど有用\r\nそういうものでしょう？","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力</a><a target="_blank" id="header_text_message_2" href="https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita&amp;utm_medium=header-banner">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"hogegex","type":"items","id":"3743225a7af13e93df78"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"hogegex","type":"items","id":"3743225a7af13e93df78"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"hogegex","type":"items","id":"3743225a7af13e93df78"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"「作業者の負荷情報の見える化」に取り組む研究者が語る日立の魅力","url":"https://zine.qiita.com/interview/202107-hitachi-3/?utm_source=qiita\u0026utm_medium=header-banner","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/hogegex/items/3743225a7af13e93df78","location":"/hogegex/items/3743225a7af13e93df78","scheme":"https","host":"qiita.com","port":null,"pathname":"/hogegex/items/3743225a7af13e93df78","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"+GhDqxUGaSl4CZy0jQjaJkNTBbLeJ87AoOgCA7GQtMAMXYPJbcQXA9G9+xPzGF18MssFU2JaIBjNcnuoLc6i9Q==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-60eabe07-188b-43af-8ae8-9d38a4781ff2"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/hogegex/items/3743225a7af13e93df78/likers" class="css-1iupg5d">66</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">89</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/3743225a7af13e93df78/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/hogegex/items/3743225a7af13e93df78/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/hogegex/items/3743225a7af13e93df78/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/hogegex/items/3743225a7af13e93df78/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/hogegex/items/3743225a7af13e93df78.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/hogegex"><img class="css-100alwu eyfquo10" src="https://avatars2.githubusercontent.com/u/39821569?v=4" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/hogegex" class="css-10ougpm">@<!-- -->hogegex</a><div class="css-1ay9vb9"><span><meta content="2019-07-23T08:39:27Z"/><time dateTime="2019-11-16T03:57:31Z" class="css-m19uds">updated at 2019-11-16</time></span></div></div></div></div></div><h1 class="css-cgzq40">.NET (C#)からpythonを呼び出す</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/python" class="css-4czcte">Python</a><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/.net" class="css-4czcte">.NET</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="net-cからpythonを呼び出す" class="fragment"></span><a href="#net-c%E3%81%8B%E3%82%89python%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99"><i class="fa fa-link"></i></a>.NET (C#)からpythonを呼び出す</h1>

<p><a href="https://github.com/pythonnet/pythonnet" rel="nofollow noopener" target="_blank">pythonnet</a>を使って、.NETからpython(cpython)コードを呼び出す方法。<br>
例えば、「Chainerで作ったAI処理を、.NETでつくったGUIから叩きたい！」とかいうときに有用。</p>

<p>python -&gt; .NET(C#)の資料はたくさんあるのに、.NET -&gt; pythonの資料がほとんどない<sup id="fnref1"><a href="#fn1" title="※動かなかった…という記事はあったのでそっとリンク。">1</a></sup>ので作成。</p>

<h2>
<span id="前提" class="fragment"></span><a href="#%E5%89%8D%E6%8F%90"><i class="fa fa-link"></i></a>前提</h2>

<p>この記事は以下の知識があることを前提に作成した。</p>

<ul>
<li>  C#がある程度わかること。</li>
<li>  pythonがある程度(pip等の環境管理の仕組みも含め)わかること。</li>
</ul>

<h2>
<span id="手順" class="fragment"></span><a href="#%E6%89%8B%E9%A0%86"><i class="fa fa-link"></i></a>手順</h2>

<p>作業目標は、「Windows(x64)環境で、VS2017を使い、C#からpython3.7(x64)のコードを呼び出すサンプルを作る」とする。<br>
なお、pythonnetは、本記事執筆時点(2019/07)で、python 3.7まで対応している。</p>

<h3>
<span id="pythonnetの設定" class="fragment"></span><a href="#pythonnet%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>pythonnetの設定</h3>

<p>pythonnetをビルドするための設定を行う。<br>
※nugetにビルド済のパッケージがあるが、あまり更新されていないようなので使用しない。</p>

<p><a href="https://github.com/pythonnet/pythonnet" rel="nofollow noopener" target="_blank">pythonnetのgithubリポジトリ</a>から最新コードをcloneし、pythonnet.slnを開く。<br>
VS2015の場合はpythonnet.15.slnを使う。vs2019以降を使う場合は適当に変換してがんばる(未確認)。</p>

<p>ソリューションのビルド構成がいろいろあるので、適切なものを選ぶ。<br>
構成名は、<code>(Debug|Release)(Mono|Win)(|PY3)</code>という構造になっている。<br>
※ただし、<a href="https://github.com/pythonnet/pythonnet/issues/910" rel="nofollow noopener" target="_blank">この設定を廃止し、実行時に動的に選択可能にする改善</a>が検討されているようなので、このあたりの手順は、そのうち大きく変わるかも。</p>

<ol>
<li><p><code>Debug|Release</code><br>
おなじみの、Debug/Releaseビルドの選択。</p></li>
<li><p><code>Mono|Win</code><br>
Mono(Linux)用か通常のWindows用か。</p></li>
<li><p><code>|PY3</code><br>
なにも付かないほうはpython2系向け、PY3はpython3系向けにビルド。</p></li>
</ol>

<p>今回はWindows環境でpython3.7を呼び出すのが目的なので、<code>ReleaseWinPY3</code>を選ぶ。<br>
なお、プラットフォーム(x86/x64)はどちらでもよい(今回ビルドしたい<code>Python.Runtime</code>プロジェクトはAnyCPU設定になっているため)。</p>

<p><a href="https://camo.qiitausercontent.com/9efb489e35a239bdbced3c9efc9fd75c6be4aa18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f64373836333661662d633733632d316464392d353435372d6334323462626365653932622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fd78636af-c73c-1dd9-5457-c424bbcee92b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1e4704c875bd03cf1f9921e8c605fb51" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/d78636af-c73c-1dd9-5457-c424bbcee92b.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fd78636af-c73c-1dd9-5457-c424bbcee92b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ed98dd3222fba846a003b80e1f785920 1x" loading="lazy"></a></p>

<p>選んだら、プロジェクト<code>Python.Runtime</code>のプロジェクト プロパティを開き、コンパイルシンボルを確認する。<br>
<code>PYTHON3;PYTHON37;UCS2</code>のような文字列が定義されているので、狙ったpythonバージョンになっているか確認する。</p>

<p><a href="https://camo.qiitausercontent.com/d06dfb83db2c1e205ab6dc0db124f3b487e8e2c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f38346130643634372d663230322d303734372d373163392d6339623738326662313432372e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F84a0d647-f202-0747-71c9-c9b782fb1427.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e21e6089cab03849fd6facba0b2b6858" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/84a0d647-f202-0747-71c9-c9b782fb1427.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F84a0d647-f202-0747-71c9-c9b782fb1427.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=7fe66f3542a7f0e248e032e9d1e2f3ce 1x" loading="lazy"></a></p>

<p>今回はpython3.7を動かすのでPYTHON37でよいが、python3.5にしたい場合はPYTHON35のように書き換える。<br>
有効な設定値は、<code>src/runtime/runtime.cs</code>の#if節を参照するとわかる。</p>

<p><a href="https://camo.qiitausercontent.com/ed4e2cc458c08bc6b9d3dca2aa6aa1680362513f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f64386437363262302d356639382d336238372d303836322d3432626539626339316162352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fd8d762b0-5f98-3b87-0862-42be9bc91ab5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fecdecf8dc56637c7c4ddc15d12f0b91" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/d8d762b0-5f98-3b87-0862-42be9bc91ab5.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fd8d762b0-5f98-3b87-0862-42be9bc91ab5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f7f022793d8653fad1325cefbc010cdc 1x" loading="lazy"></a></p>

<h3>
<span id="pythonnetのビルド" class="fragment"></span><a href="#pythonnet%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89"><i class="fa fa-link"></i></a>pythonnetのビルド</h3>

<p>設定を済ませたプロジェクトをビルドする。</p>

<p><code>src/runtime/bin</code>以下に<code>Python.Runtime.dll</code>が出力されるので、回収しておく。</p>

<p>同時に、<code>Python.Runtime.pdb</code>(デバッグ情報)と<code>Python.Runtime.xml</code>(ドキュメントコメントの情報)も回収しておくと、あとで少し幸せになれるかも。</p>

<p><a href="https://camo.qiitausercontent.com/6c4addc41d672d5b61c609ac2116025bc8dc87c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f34386433373034362d613532662d363865382d323762392d3338346466663432303539382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F48d37046-a52f-68e8-27b9-384dff420598.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f2ddebfbcb3e330228640a1c16905693" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/48d37046-a52f-68e8-27b9-384dff420598.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F48d37046-a52f-68e8-27b9-384dff420598.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d60af3aee1974e3db3e155dd91d4de05 1x" loading="lazy"></a></p>

<h3>
<span id="呼び出し元プロジェクトの作成" class="fragment"></span><a href="#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E5%85%83%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fa fa-link"></i></a>呼び出し元プロジェクトの作成</h3>

<p>pythonコードの呼び出し元となるプロジェクト / ソリューションを作る。</p>

<p>サンプルでは、.NET Framework 4.6.1向けのC#コンソール アプリとした。</p>

<p>※pythonnetは.NET Framework 4をターゲットに作られているので、それを呼び出せる設定にすること。</p>

<p><a href="https://camo.qiitausercontent.com/9cee78e9d6aa7818be649e8b4cded55af601402b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f62303962316132642d633163342d653637302d663464322d3266333930633461346439612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fb09b1a2d-c1c4-e670-f4d2-2f390c4a4d9a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4a69c8772368573ae563cce5b5e6262f" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/b09b1a2d-c1c4-e670-f4d2-2f390c4a4d9a.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fb09b1a2d-c1c4-e670-f4d2-2f390c4a4d9a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=59e4b8fc39b327d14b3e89b500d1893c 1x" loading="lazy"></a></p>

<h3>
<span id="プラットフォームの変更" class="fragment"></span><a href="#%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E5%A4%89%E6%9B%B4"><i class="fa fa-link"></i></a>プラットフォームの変更</h3>

<p>64bit用のPythonのDLLを呼び出すには、呼び出し元のexeも64bit向けにビルドされている必要があるため、その設定を行う。</p>

<p>作成したソリューションの構成マネージャーを開く。</p>

<p>プロジェクトのプラットフォームがAnyCPUとなっているので、x64を新規作成する。<br>
※このとき、"新しいソリューション プラットフォームを作成する"にチェックを入れておくこと。</p>

<p><a href="https://camo.qiitausercontent.com/8916a873b7d574d825a0715d11df8fec7a8ccb0c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f66336564383663352d333432332d376130302d353935302d3236313036643061313065622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff3ed86c5-3423-7a00-5950-26106d0a10eb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2c7640ad96b8e05984158e7fe68dbe3d" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/f3ed86c5-3423-7a00-5950-26106d0a10eb.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff3ed86c5-3423-7a00-5950-26106d0a10eb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6cc73ab0b6930865de11d6ed85ea392b 1x" loading="lazy"></a></p>

<p><a href="https://camo.qiitausercontent.com/ccffb09cd086aa9c8d6825bb9a7297c438279eb9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f66306464383239362d366266652d663131392d616536612d3433346430633336303631352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff0dd8296-6bfe-f119-ae6a-434d0c360615.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d30326cf4c5a87f86a3a1f446c7c5bec" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/f0dd8296-6bfe-f119-ae6a-434d0c360615.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff0dd8296-6bfe-f119-ae6a-434d0c360615.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=543b4d8268f6e6b9e6a82ca5be516d03 1x" loading="lazy"></a></p>

<p>作成したら、プロジェクト プラットフォームとソリューション プラットフォームの両方から、AnyCPU設定を削除しておく。<br>
※残しておくと、うっかりAnyCPU設定を使ってしまってドハマリする場合があるため。</p>

<p><a href="https://camo.qiitausercontent.com/e0e6d63c8d33c7fbaf21166b0081e00e5283c7b5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f62316133633664632d643033622d396530652d666664312d6136313839666534306539382e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fb1a3c6dc-d03b-9e0e-ffd1-a6189fe40e98.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=55e235fd2350744fadb91b684529bc69" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/b1a3c6dc-d03b-9e0e-ffd1-a6189fe40e98.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fb1a3c6dc-d03b-9e0e-ffd1-a6189fe40e98.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=83876c22986238108081d1697d39ca95 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/6f7a07cfd3568d512dfaced4d9e4778bf1a6e876/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f39636333313438382d313064342d323665322d376363652d3462636233303931366530362e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F9cc31488-10d4-26e2-7cce-4bcb30916e06.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5e6fda75d0d20061690c5b5b4cd6bbc2" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/9cc31488-10d4-26e2-7cce-4bcb30916e06.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F9cc31488-10d4-26e2-7cce-4bcb30916e06.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6a3d4798ba52cf8b838aa86d3ebbc7bf 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/2754cdea556ae0961a7bdcbf28eaa22285774cba/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f38366333623161322d346565362d613665392d393435382d3162303238383834356462622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F86c3b1a2-4ee6-a6e9-9458-1b0288845dbb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=afd3760ed97784223ac9bb97027dd39f" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/86c3b1a2-4ee6-a6e9-9458-1b0288845dbb.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F86c3b1a2-4ee6-a6e9-9458-1b0288845dbb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6c7099afe00ae28f767afde7f0fbda4c 1x" loading="lazy"></a><br>
<a href="https://camo.qiitausercontent.com/ea49321a255eed30787a683c6192af75d4d7f1f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f37333966346536632d663264332d613134392d303832632d3031376561646630333164342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F739f4e6c-f2d3-a149-082c-017eadf031d4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2cf7df2ef681ef060ad07491971227f3" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/739f4e6c-f2d3-a149-082c-017eadf031d4.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F739f4e6c-f2d3-a149-082c-017eadf031d4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d154ff89898965778b21bd3c21ddea84 1x" loading="lazy"></a></p>

<h3>
<span id="参照設定" class="fragment"></span><a href="#%E5%8F%82%E7%85%A7%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>参照設定</h3>

<p>pythonnetのビルド時に回収しておいたDLLを、作成したプロジェクトのディレクトリにコピーする。</p>

<p>プロジェクトの参照設定から、コピーしたDLLに参照を設定する。<br>
<a href="https://camo.qiitausercontent.com/03555647aba1f86a95f0c89d391f7e4826931d9f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f65336261653862622d333437372d643530622d386239632d3063623464653261326365622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fe3bae8bb-3477-d50b-8b9c-0cb4de2a2ceb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0053afbdd2efda6d11a899ba1d86c083" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/e3bae8bb-3477-d50b-8b9c-0cb4de2a2ceb.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fe3bae8bb-3477-d50b-8b9c-0cb4de2a2ceb.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e380d2849c513a3d9d729cb39e988184 1x" loading="lazy"></a></p>

<p><a href="https://camo.qiitausercontent.com/bb006655d2e68985d143ae9ea6d50120bea286b6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f38623037303236382d636638662d386535612d653338312d6338346665383730623135392e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F8b070268-cf8f-8e5a-e381-c84fe870b159.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=88e6952de3a153d3d2adede7a3eecb87" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/8b070268-cf8f-8e5a-e381-c84fe870b159.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F8b070268-cf8f-8e5a-e381-c84fe870b159.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f3dfca311785201b9eb8c9ce9760e66f 1x" loading="lazy"></a><br>
※見逃しがちだが、右下に参照ボタンがある。</p>

<p><a href="https://camo.qiitausercontent.com/4c4d15c2872de3a8feaf39880d651d2890ea43ba/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f66363762346239342d316663652d353431642d633134302d3165343339346630396666352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff67b4b94-1fce-541d-c140-1e4394f09ff5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2e28e7a8f475723d049769318814c5d7" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/f67b4b94-1fce-541d-c140-1e4394f09ff5.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff67b4b94-1fce-541d-c140-1e4394f09ff5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b401b6eb15d8c61d5521acd9a52b1d48 1x" loading="lazy"></a><br>
追加されるとこうなる。</p>

<h3>
<span id="実装" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85"><i class="fa fa-link"></i></a>実装</h3>

<p>以下を実装する。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">Python.Runtime</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">PythonTest</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// プロセスの環境変数PATHに、指定されたディレクトリを追加する(パスを通す)。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="paths"&gt;PATHに追加するディレクトリ。&lt;/param&gt;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">AddEnvPath</span><span class="p">(</span><span class="k">params</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">paths</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">envPaths</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"PATH"</span><span class="p">).</span><span class="nf">Split</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">PathSeparator</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">path</span> <span class="k">in</span> <span class="n">paths</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">envPaths</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">envPaths</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">Environment</span><span class="p">.</span><span class="nf">SetEnvironmentVariable</span><span class="p">(</span><span class="s">"PATH"</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">PathSeparator</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(),</span> <span class="n">envPaths</span><span class="p">),</span> <span class="n">EnvironmentVariableTarget</span><span class="p">.</span><span class="n">Process</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// プログラムのエントリポイント。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="args"&gt;コマンドライン引数。&lt;/param&gt;</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// *-------------------------------------------------------*</span>
            <span class="c1">// * python環境の設定</span>
            <span class="c1">// *-------------------------------------------------------*</span>

            <span class="c1">// python環境にパスを通す</span>
            <span class="c1">// TODO: 環境に合わせてパスを直すこと</span>
            <span class="kt">var</span> <span class="n">PYTHON_HOME</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">ExpandEnvironmentVariables</span><span class="p">(</span><span class="s">@"%userprofile%\Anaconda3\envs\pythonnet_test"</span><span class="p">);</span>

            <span class="c1">// pythonnetが、python本体のDLLおよび依存DLLを見つけられるようにする</span>
            <span class="nf">AddEnvPath</span><span class="p">(</span>
              <span class="n">PYTHON_HOME</span><span class="p">,</span>
              <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">PYTHON_HOME</span><span class="p">,</span> <span class="s">@"Library\bin"</span><span class="p">)</span>
            <span class="p">);</span>

            <span class="c1">// python環境に、PYTHON_HOME(標準pythonライブラリの場所)を設定</span>
            <span class="n">PythonEngine</span><span class="p">.</span><span class="n">PythonHome</span> <span class="p">=</span> <span class="n">PYTHON_HOME</span><span class="p">;</span>

            <span class="c1">// python環境に、PYTHON_PATH(モジュールファイルのデフォルトの検索パス)を設定</span>
            <span class="n">PythonEngine</span><span class="p">.</span><span class="n">PythonPath</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span>
              <span class="n">Path</span><span class="p">.</span><span class="n">PathSeparator</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(),</span>
              <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span>
                  <span class="n">PythonEngine</span><span class="p">.</span><span class="n">PythonPath</span><span class="p">,</span><span class="c1">// 元の設定を残す</span>
                  <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">PYTHON_HOME</span><span class="p">,</span> <span class="s">@"Lib\site-packages"</span><span class="p">),</span> <span class="c1">//pipで入れたパッケージはここに入る</span>
                  <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="s">@"C:\foo\bar\my_packages"</span><span class="p">),</span> <span class="c1">//自分で作った(動かしたい)pythonプログラムの置き場所も追加</span>
              <span class="p">}</span>
            <span class="p">);</span>

            <span class="c1">// 初期化 (明示的に呼ばなくても内部で自動実行されるようだが、一応呼ぶ)</span>
            <span class="n">PythonEngine</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">();</span>

            <span class="c1">// *-------------------------------------------------------*</span>
            <span class="c1">// * pythonコードの実行</span>
            <span class="c1">// *-------------------------------------------------------*</span>
            <span class="c1">// Global Interpreter Lockを取得</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">Py</span><span class="p">.</span><span class="nf">GIL</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="c1">// モジュールの探索パスを表示 (pythonコードを直接指定して実行)</span>
                <span class="n">PythonEngine</span><span class="p">.</span><span class="nf">RunSimpleString</span><span class="p">(</span><span class="s">@"
import sys
import pprint
print('module path =')
pprint.pprint(sys.path)
"</span><span class="p">);</span>

                <span class="c1">// numpyのオブジェクトを取得し、呼び出してみる</span>
                <span class="kt">dynamic</span> <span class="n">np</span> <span class="p">=</span> <span class="n">Py</span><span class="p">.</span><span class="nf">Import</span><span class="p">(</span><span class="s">"numpy"</span><span class="p">);</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"np.cos(np.pi * 2) =  </span><span class="p">{</span><span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="p">*</span> <span class="m">2</span><span class="p">)}</span><span class="s">"</span><span class="p">);</span>

                <span class="c1">// 自作コードも叩ける</span>
                <span class="kt">dynamic</span> <span class="n">myMath</span> <span class="p">=</span> <span class="n">Py</span><span class="p">.</span><span class="nf">Import</span><span class="p">(</span><span class="s">"my_awesome_lib.my_math"</span><span class="p">);</span> <span class="c1">// "from my_awesome_lib import my_math"</span>
                <span class="kt">dynamic</span> <span class="n">calculator</span> <span class="p">=</span> <span class="n">myMath</span><span class="p">.</span><span class="nf">Calculator</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="m">7</span><span class="p">);</span> <span class="c1">// クラスのインスタンスを生成</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"5 + 7 = </span><span class="p">{</span><span class="n">calculator</span><span class="p">.</span><span class="k">add</span><span class="p">()}</span><span class="s">"</span><span class="p">);</span> <span class="c1">// クラスのメソッド呼び出し</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"sum(1,2,3,4,5) = </span><span class="p">{</span><span class="n">myMath</span><span class="p">.</span><span class="n">Calculator</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span> <span class="p">})}</span><span class="s">"</span><span class="p">);</span> <span class="c1">//staticメソッドも当然呼べる</span>
                <span class="kt">dynamic</span> <span class="n">dict</span> <span class="p">=</span> <span class="n">myMath</span><span class="p">.</span><span class="nf">GetDict</span><span class="p">();</span> <span class="c1">// 辞書型を返す関数呼び出し</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">dict</span><span class="p">[</span><span class="m">3</span><span class="p">]);</span> <span class="c1">// 辞書からキーを指定して読み取り</span>
            <span class="p">}</span>

            <span class="c1">// python環境を破棄</span>
            <span class="n">PythonEngine</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">();</span>

            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Press any key to continue..."</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ただし、<strong>このままではまだ動かない</strong>。</p>

<h2>
<span id="python環境を作る" class="fragment"></span><a href="#python%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>python環境を作る</h2>

<p>python環境を導入する。</p>

<p>今回は、<a href="https://www.anaconda.com/" rel="nofollow noopener" target="_blank">Anaconda</a>で、"pythonnet_test"という名前のpython3.7環境(64bit)を作り、利用する。<br>
よって、python環境のルートディレクトリは<code>%userprofile%\anaconda(最近はminicondaかも?)\envs\pythonnet_test</code>となる。</p>

<p>また、C#からpythonの追加パッケージが利用できることを確認するため、numpyを追加インストールした。</p>

<p>python環境を別の方法で導入する場合は、ルートディレクトリのパスを確認し、numpyもインストールしておくこと。</p>

<h2>
<span id="自前パッケージを配置" class="fragment"></span><a href="#%E8%87%AA%E5%89%8D%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E9%85%8D%E7%BD%AE"><i class="fa fa-link"></i></a>自前パッケージを配置</h2>

<p>自作pythonコードが呼び出せることを確認するため、呼び出し先となるpythonプログラムを準備する。</p>

<p>以下コードを、&lt;任意のディレクトリ&gt;\my_awesome_lib\my_math.pyに配置する。</p>

<p>※配置したディレクトリは後で使うので覚えておくこと。サンプルでは<code>C:\foo\bar\my_packages\my_awesome_lib\my_math.py</code>に置いた。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre class="with-code"><code><span class="c1"># よくありがちなしょうもないテストコード
</span><span class="k">class</span> <span class="nc">Calculator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">y</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">num_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">num_list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">GetDict</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="mi">0</span> <span class="p">:</span> <span class="s">"this"</span><span class="p">,</span>
        <span class="mi">1</span> <span class="p">:</span> <span class="s">"is"</span><span class="p">,</span>
        <span class="mi">2</span> <span class="p">:</span> <span class="s">"my"</span><span class="p">,</span>
        <span class="mi">3</span> <span class="p">:</span> <span class="s">"dictionary"</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="python環境にパスを通す" class="fragment"></span><a href="#python%E7%92%B0%E5%A2%83%E3%81%AB%E3%83%91%E3%82%B9%E3%82%92%E9%80%9A%E3%81%99"><i class="fa fa-link"></i></a>python環境にパスを通す</h2>

<p>作成したpython環境にパスを通す。これが一番難しい(というか情報がない)。</p>

<p>ソースコード中、"python環境の設定"というコメント以降がこの設定に相当するので、コードを修正する。</p>

<h3>
<span id="pythonnetがpython本体のdllを見つけられるようにする" class="fragment"></span><a href="#pythonnet%E3%81%8Cpython%E6%9C%AC%E4%BD%93%E3%81%AEdll%E3%82%92%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%89%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>pythonnetがpython本体のDLLを見つけられるようにする</h3>

<p>pythonnetがpython本体のDLLを見つけられるよう、環境変数(PATH)にディレクトリを追加する。</p>

<p>サンプルでは、ユーティリティ関数<code>AddEnvPath()</code>によって、以下を設定している：</p>

<ul>
<li>
<p>python環境のルート</p>

<p>pythonXX.dll(python3.7ならpython37.dll)のあるディレクトリ。</p>
</li>
<li>
<p>python環境のルート\Library\bin</p>

<p>このディレクトリに、pythonXX.dllが依存しているDLLの一部が格納されていた。<br>
python環境の作り方によっては必要ないか、別のディレクトリを指定する必要があるかも。</p>
</li>
</ul>

<p>パスの通し方には複数の方法があるが、この例と同様、プログラム中(コード)で設定することをお勧めする。</p>

<ul>
<li>
<p>プログラム中(コード)で設定</p>

<p>きちんと設定されていることを保証できる。おすすめ。<br>
ただし、サンプルではパスをハードコードしているが、普通は設定ファイルとかから読むようにすべき。</p>
</li>
<li>
<p>Windowsのシステム環境変数に設定</p>

<p>システム全体に効くため楽だが、複数のpython環境が運用できなくなる。</p>
</li>
<li>
<p>exe起動前に(bat等で)事前設定する</p>

<p>デバッグ実行などがやりにくい。</p>
</li>
</ul>

<h3>
<span id="python本体がpythonのモジュール標準モジュールを含むを見つけられるようにする" class="fragment"></span><a href="#python%E6%9C%AC%E4%BD%93%E3%81%8Cpython%E3%81%AE%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E6%A8%99%E6%BA%96%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E5%90%AB%E3%82%80%E3%82%92%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%89%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>python本体が、pythonのモジュール(標準モジュールを含む)を見つけられるようにする</h3>

<p>python本体に、pythonのモジュールを探索するパスを設定する。</p>

<p>これが正しく設定されていないと、pythonの標準ライブラリやpip等で入れたライブラリ、自作コードを見つけることができない。</p>

<p>設定すべき項目は2種類ある。</p>

<ul>
<li>
<p>PYTHON_HOME</p>

<p>python環境のルート。</p>
</li>
<li>
<p>PYTHON_PATH</p>

<p>pythonモジュールの探索場所。セミコロンで区切って指定する。</p>
</li>
</ul>

<p>PYTHON_PATHには、デフォルトで以下が設定されている：</p>

<ul>
<li>  %PYTHON_HOME%\pythonXX.zip</li>
<li>  %PYTHON_HOME%\DLLs</li>
<li>  %PYTHON_HOME%\lib</li>
<li>  カレントディレクトリ<br>
</li>
</ul>

<p>サンプルでは、これらに加え、以下を設定している。</p>

<ul>
<li>  pipのインストール先ディレクトリ (Lib\site-packages)</li>
<li>  自作コードの存在するディレクトリ (～\my_packages、実際に置いた場所に合わせて適宜修正すること)</li>
</ul>

<p>必要なら、さらに追加することもできる。</p>

<h2>
<span id="実行" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>実行</h2>

<p>ここまで設定すると、サンプルが動くようになる(はず)。</p>

<p>ビルドして実行してみて、以下のように出力されれば成功。</p>

<div class="code-frame" data-lang="console"><div class="highlight"><pre class="with-code"><code><span class="go">module path =
['C:\\～～～',
</span><span class="c"> ...
</span><span class="go"> 'C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\']
np.cos(np.pi * 2) =  1.0
5 + 7 = 12
sum(1,2,3,4,5) = 15
dictionary
Press any key to continue...
</span></code></pre></div></div>

<p>Pythonの関数やクラスが呼び出せ、値をやり取りできていることが分かる。</p>

<h2>
<span id="ハマりどころ基本編" class="fragment"></span><a href="#%E3%83%8F%E3%83%9E%E3%82%8A%E3%81%A9%E3%81%93%E3%82%8D%E5%9F%BA%E6%9C%AC%E7%B7%A8"><i class="fa fa-link"></i></a>ハマりどころ(基本編)</h2>

<p>よくあるトラブル。</p>

<h3>
<span id="pythonruntimepythonexception-modulenotfounderror--no-module-named-が起きる" class="fragment"></span><a href="#pythonruntimepythonexception-modulenotfounderror--no-module-named-%E3%81%8C%E8%B5%B7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a><code>Python.Runtime.PythonException: ModuleNotFoundError : No module named '～～'</code>が起きる</h3>

<p>pythonモジュールを見つけられていない。おそらく、PythonPathの設定をミスしている。</p>

<p>見つからないと怒られたモジュールの実体(ファイル)がどこにあるか調べ、PythonPathが適切に設定されているか確認する。</p>

<h3>
<span id="badimageformatexceptionが起きる" class="fragment"></span><a href="#badimageformatexception%E3%81%8C%E8%B5%B7%E3%81%8D%E3%82%8B"><i class="fa fa-link"></i></a><code>BadImageFormatException</code>が起きる</h3>

<p>DLL関連の問題は、だいたい何でもこの例外になる。</p>

<p>原因が多岐にわたるので調査が難しいが、以下のどれかが原因のことが多い。</p>

<ul>
<li><p>pythonのDLLがあるディレクトリにパスが通っていない</p></li>
<li><p>pythonnetのビルド時に、適切なpythonバージョンを指定しなかった<br>
python3.5の環境で動かしたいのにpython3.7向けにビルドしてしまった、など。<br>
pythonnetが探しに行くDLL名はビルド時に決まるので(python3.7向けにビルドした場合はpython37.dllを探しに行く)、ビルド時の環境と実環境が不一致だとDLLの読み込みに失敗する。</p></li>
<li><p>pythonのDLLが依存しているDLLにパスが通っていない(見つからない)<br>
DLLが見つかっても、そのDLLが依存しているDLLが見つからない場合は、やはり読み込みエラーとなる。</p></li>
<li><p>呼び出し元プロジェクト・python本体のプラットフォーム(x86/x64)が一致してない<br>
特に、 呼び出し元のプロジェクトをAnyCPU設定にするのは混乱の元になるので避けたほうがよい(もともとの挙動がややこしい上、.NET 4.5以前と以後での挙動が異なる)。<br>
※pythonnet本体は、AnyCPUでビルドされるため、呼び出し元プロジェクトの設定に従う。</p></li>
</ul>

<p>この手の問題が発生してしまった場合は、以下のような調査手段で何とかする。</p>

<ul>
<li><p><a href="https://github.com/lucasg/Dependencies" rel="nofollow noopener" target="_blank">Dependencies</a>でDLLの依存関係を追っかける</p></li>
<li><p>dumpbinコマンドで各DLLのプラットフォーム(x86/64)を確認する<br>
e.g. <code>dumpbin /headers hoge.dll</code></p></li>
<li>
<p><a href="https://docs.microsoft.com/ja-jp/sysinternals/downloads/procmon" rel="nofollow noopener" target="_blank">Process Monitor</a>でロードに失敗したDLLを特定する<br>
IRP_MJ_CREATEが何度も失敗しており(DLLの探索先パスを全て探すため)、最後までLoad Imageが実行されていない(= DLLが見つからなかった)DLLが犯人。<br>
また、Load Imageした結果がSUCCESSでないDLLも怪しい。<br>
フィルタ設定を以下にするとわかりやすい。</p>

<ul>
<li>  Process：python呼び出し元のexe</li>
<li>  Operation：<code>IRP_MJ_CREATE</code>(ファイルのオープン)と<code>Load Image</code>(DLLの読み込み)をInclude</li>
</ul>

<p>なお、<code>IRP_MJ_CREATE</code>はFiler -&gt; Enable advanced outputを有効にしていないと表示されない。</p>
</li>
</ul>

<h2>
<span id="ハマりどころ応用編" class="fragment"></span><a href="#%E3%83%8F%E3%83%9E%E3%82%8A%E3%81%A9%E3%81%93%E3%82%8D%E5%BF%9C%E7%94%A8%E7%B7%A8"><i class="fa fa-link"></i></a>ハマりどころ(応用編)</h2>

<p>ちょっと難しいことをやろうとするとハマること。</p>

<h3>
<span id="複数スレッドからの実行" class="fragment"></span><a href="#%E8%A4%87%E6%95%B0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%8B%E3%82%89%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>複数スレッドからの実行</h3>

<p>C#で、複数のスレッド(pythonnetを初期化した以外のスレッド)からPythonコードを呼び出す場合には、注意が必要。</p>

<p>Python(CPython)は、設計上、<a href="https://ja.wikipedia.org/wiki/%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%97%E3%83%AA%E3%82%BF%E3%83%AD%E3%83%83%E3%82%AF" rel="nofollow noopener" target="_blank">GIL</a>を採用している(GIL自体の説明は本題とずれるので割愛)。<br>
また、明示的に開放処理を行わない限り、pythonnetはメインスレッド(= pythonnetを初期化したスレッド)でGILを保持したままにする。<br>
よって、C#の別スレッドからPythonのコードを実行しようとした場合、GILの取得(using(Py.GIL())でデッドロックする。</p>

<p>これを回避するには、pythonnetの初期化後(PythonEngine.Initialize()の呼び出し後)に、PythonEngine.BeginAllowThreads()を呼び出し、明示的にGILを解放する。<br>
これにより、他スレッドからもGILが取得できるようになり、C#の複数スレッドからPythonのコードが呼び出せるようになる。<br>
ただし、GILで排他されることには変わりがないことには注意が必要。<br>
Python側コードの並列実行はされず、単に複数スレッドから呼び出せるようになるだけ。</p>

<p>なお、pythonnetのBeginAllowThreads()メソッドが何をやっているのかは、<a href="https://docs.python.org/ja/3/c-api/init.html#releasing-the-gil-from-extension-code" rel="nofollow noopener" target="_blank">PythonのC APIのドキュメント</a>を読むとイメージがつかめる。</p>

<h3>
<span id="巨大データの扱い" class="fragment"></span><a href="#%E5%B7%A8%E5%A4%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%89%B1%E3%81%84"><i class="fa fa-link"></i></a>巨大データの扱い</h3>

<p>C#からPythonに巨大な配列やリストを単純に渡すと、要素全てが個別にpythonのオブジェクトに変換されるため、とてつもなく遅くなる。<br>
※ためしに4k解像度の画像データ(uint8の画素値)が入った配列を渡したら、なにもしないpython関数を呼び出すだけでも、秒単位の時間がかかった…</p>

<p>こういう場合には、ポインタ経由での引き渡しが有効。<br>
たとえば8bit グレースケールの画像を受け渡す場合、以下のようにする。</p>

<div class="code-frame" data-lang="python"><div class="highlight"><pre class="with-code"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">ctypes.util</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">my_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_ptr</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
    <span class="c1"># ポインタからnumpyのarrayを作る
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ctypeslib</span><span class="p">.</span><span class="n">as_array</span><span class="p">((</span><span class="n">stride</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">ctypes</span><span class="p">.</span><span class="n">c_uint8</span><span class="p">).</span><span class="n">from_address</span><span class="p">(</span><span class="n">img_ptr</span><span class="p">)).</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>
    <span class="c1"># imgに対していろいろ処理する…
</span></code></pre></div></div>

<p>C#からは、以下のように呼び出す。</p>

<div class="code-frame" data-lang="cs"><div class="highlight"><pre class="with-code"><code><span class="c1">// この画像を引き渡したい</span>
<span class="kt">var</span> <span class="n">hugeImage</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bitmap</span><span class="p">(</span><span class="m">65536</span><span class="p">,</span> <span class="m">65536</span><span class="p">,</span> <span class="n">PixelFormat</span><span class="p">.</span><span class="n">Format8bppIndexed</span><span class="p">);</span>

<span class="n">BitmapData</span> <span class="n">bitmapData</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="k">try</span>
<span class="p">{</span>
    <span class="c1">// 画像をロック</span>
    <span class="n">bitmapData</span> <span class="p">=</span> <span class="n">hugeImage</span><span class="p">.</span><span class="nf">LockBits</span><span class="p">(</span>
       <span class="k">new</span> <span class="nf">Rectangle</span><span class="p">(</span><span class="k">new</span> <span class="nf">Point</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> <span class="n">image</span><span class="p">.</span><span class="n">Size</span><span class="p">),</span>
       <span class="n">ImageLockMode</span><span class="p">.</span><span class="n">ReadOnly</span><span class="p">,</span>
       <span class="n">PixelFormat</span><span class="p">.</span><span class="n">Format8bppIndexed</span>
       <span class="p">);</span>

    <span class="k">using</span> <span class="p">(</span><span class="n">Py</span><span class="p">.</span><span class="nf">GIL</span><span class="p">())</span>
    <span class="p">{</span>        
        <span class="c1">// pythonモジュールを読み込む。ファイル名等は適宜変更すること</span>
        <span class="kt">dynamic</span> <span class="n">myPython</span> <span class="p">=</span> <span class="n">Py</span><span class="p">.</span><span class="nf">Import</span><span class="p">(</span><span class="s">"myPython"</span><span class="p">);</span>
        <span class="n">myPython</span><span class="p">.</span><span class="nf">my_func</span><span class="p">(</span>
            <span class="n">bitmapData</span><span class="p">.</span><span class="n">Scan0</span><span class="p">.</span><span class="nf">ToInt64</span><span class="p">(),</span> <span class="c1">// 画像バッファの先頭ポインタを引き渡す</span>
            <span class="n">bitmapData</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="c1">//当然ながら画像サイズとストライドも必要</span>
            <span class="n">bitmapData</span><span class="p">.</span><span class="n">Stride</span><span class="p">,</span>
            <span class="n">bitmapData</span><span class="p">.</span><span class="n">Height</span>
            <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">finally</span>
<span class="p">{</span>
    <span class="c1">// ロックした画像を解放</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bitmapData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="n">hugeImage</span><span class="p">.</span><span class="nf">UnlockBits</span><span class="p">(</span><span class="n">bitmapData</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>画像ではなく配列やリストを渡したい場合は、<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.runtime.interopservices.marshal" rel="nofollow noopener" target="_blank">Marshalクラス</a>を使ってIntPtrにさえ変換してしまえば、同じように渡せる。<br>
unsafeコードを使えるなら、<a href="https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/keywords/fixed-statement" rel="nofollow noopener" target="_blank">fixed</a>を使っても、もちろんよい。</p>

<h2>
<span id="pythonnetを使わない方法" class="fragment"></span><a href="#pythonnet%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84%E6%96%B9%E6%B3%95"><i class="fa fa-link"></i></a>pythonnetを使わない方法</h2>

<p>pythonnetを使わない方法としては、以下のような方法での呼び出し方が考えられる。</p>

<h3>
<span id="python側をコマンドラインプログラムとして設計しc側から起動する" class="fragment"></span><a href="#python%E5%81%B4%E3%82%92%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%A8%E3%81%97%E3%81%A6%E8%A8%AD%E8%A8%88%E3%81%97c%E5%81%B4%E3%81%8B%E3%82%89%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>python側をコマンドラインプログラムとして設計し、C#側から起動する</h3>

<p>データのやりとりは、標準入出力やファイルを経由して行う。</p>

<p>pros:</p>

<ul>
<li>  シンプルでわかりやすい。</li>
<li>  pythonランタイム環境と疎結合にできる。</li>
</ul>

<p>cons:</p>

<ul>
<li>  起動終了などのオーバーヘッドが大きい。</li>
<li>  細かい制御がしにくい。</li>
</ul>

<h3>
<span id="python側をサーバとして設計しc側からサーバに対して要求を投げる" class="fragment"></span><a href="#python%E5%81%B4%E3%82%92%E3%82%B5%E3%83%BC%E3%83%90%E3%81%A8%E3%81%97%E3%81%A6%E8%A8%AD%E8%A8%88%E3%81%97c%E5%81%B4%E3%81%8B%E3%82%89%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E8%A6%81%E6%B1%82%E3%82%92%E6%8A%95%E3%81%92%E3%82%8B"><i class="fa fa-link"></i></a>python側をサーバとして設計し、C#側からサーバに対して要求を投げる</h3>

<p>python側をサービスにしてしまう。<br>
WebAPIサーバにしてもよいし、<a href="https://thrift.apache.org/" rel="nofollow noopener" target="_blank">Apache Thrift</a>や<a href="https://www.grpc.io/" rel="nofollow noopener" target="_blank">gRPC</a>のようなRPCフレームワークを使ってもよい。</p>

<p>pros:</p>

<ul>
<li>  設計自由度が高い。</li>
<li>  オーバーヘッドが比較的小さい(ただしプロセス間通信やシリアライゼーションは発生するので、同一プロセスで処理するよりはやや遅いはず)。</li>
<li>  pythonランタイム環境と疎結合にできる。</li>
</ul>

<p>cons:</p>

<ul>
<li>  プロセスが2個になり、起動終了管理などが必要になる。</li>
<li>  RPC部分を別途設計・実装・メンテしないといけない。</li>
</ul>

<h3>
<span id="ironpythonを使う" class="fragment"></span><a href="#ironpython%E3%82%92%E4%BD%BF%E3%81%86"><i class="fa fa-link"></i></a><a href="https://ironpython.net/" rel="nofollow noopener" target="_blank">Ironpython</a>を使う</h3>

<p>cpythonと決別する。<br>
「既存のpythonコードをC#から叩きたい」という用途には、おそらく茨の道。</p>

<p>pros:</p>

<ul>
<li>  Ironpython自体が.NET上で動くpython処理系なので、.NETとの相性がいい。</li>
</ul>

<p>cons:</p>

<ul>
<li>  cpythonとの互換性に難がある(例えば、*.pydを使うライブラリはほぼ使えないと思ったほうが良い)。</li>
<li>  python2.x系しかサポートしていない(一応、3.xをサポートするIronpython 3も開発中らしいが、コミットログを見る限りほとんど停滞している)。</li>
</ul>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>※<a href="https://qiita.com/y-tsutsu/items/0c4561d6478be32e6f8e" id="reference-d99bbb6267687cf75777">動かなかった…という記事</a>はあったのでそっとリンク。 <a href="#fnref1">↩</a></p>
</li>

</ol>
</div>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fhogegex%2Fitems%2F3743225a7af13e93df78&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fhogegex%2Fitems%2F3743225a7af13e93df78&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/hogegex/items/3743225a7af13e93df78/likers" class="css-1iupg5d">66</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">89</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/3743225a7af13e93df78/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/hogegex/items/3743225a7af13e93df78/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/hogegex/items/3743225a7af13e93df78/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/hogegex/items/3743225a7af13e93df78/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/hogegex/items/3743225a7af13e93df78.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-60eabe07-188b-43af-8ae8-9d38a4781ff2">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-eb1e5b02-25e0-44e0-b05d-706c86707e8d"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-eb1e5b02-25e0-44e0-b05d-706c86707e8d">{}</script>
      
<div id="LoginModal-react-component-a5298bf6-dbe6-4dcc-94b3-2cf025d5ec72"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-a5298bf6-dbe6-4dcc-94b3-2cf025d5ec72">{}</script>
      
<div id="StockModal-react-component-5ab614c8-16b2-4a9c-9a91-97b13cf87c74"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-5ab614c8-16b2-4a9c-9a91-97b13cf87c74">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;bB7RzZxIWAIxjRfWIgdhQ9Mhxr2c+jCONu1wqSH7TB+YKxGv5IomKJg5cHFcF+YZornGXCCH3lZbdwkCvaVaKg==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"net-cからpythonを呼び出す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#net-c%E3%81%8B%E3%82%89python%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e.NET (C#)からpythonを呼び出す\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/pythonnet/pythonnet\" rel=\"nofollow noopener\" target=\"_blank\"\u003epythonnet\u003c/a\u003eを使って、.NETからpython(cpython)コードを呼び出す方法。\u003cbr\u003e\n例えば、「Chainerで作ったAI処理を、.NETでつくったGUIから叩きたい！」とかいうときに有用。\u003c/p\u003e\n\n\u003cp\u003epython -\u0026gt; .NET(C#)の資料はたくさんあるのに、.NET -\u0026gt; pythonの資料がほとんどない\u003csup id=\"fnref1\"\u003e\u003ca href=\"#fn1\" title=\"※動かなかった…という記事はあったのでそっとリンク。\"\u003e1\u003c/a\u003e\u003c/sup\u003eので作成。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"前提\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%89%8D%E6%8F%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e前提\u003c/h2\u003e\n\n\u003cp\u003eこの記事は以下の知識があることを前提に作成した。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  C#がある程度わかること。\u003c/li\u003e\n\u003cli\u003e  pythonがある程度(pip等の環境管理の仕組みも含め)わかること。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"手順\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%89%8B%E9%A0%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e手順\u003c/h2\u003e\n\n\u003cp\u003e作業目標は、「Windows(x64)環境で、VS2017を使い、C#からpython3.7(x64)のコードを呼び出すサンプルを作る」とする。\u003cbr\u003e\nなお、pythonnetは、本記事執筆時点(2019/07)で、python 3.7まで対応している。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"pythonnetの設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#pythonnet%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epythonnetの設定\u003c/h3\u003e\n\n\u003cp\u003epythonnetをビルドするための設定を行う。\u003cbr\u003e\n※nugetにビルド済のパッケージがあるが、あまり更新されていないようなので使用しない。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/pythonnet/pythonnet\" rel=\"nofollow noopener\" target=\"_blank\"\u003epythonnetのgithubリポジトリ\u003c/a\u003eから最新コードをcloneし、pythonnet.slnを開く。\u003cbr\u003e\nVS2015の場合はpythonnet.15.slnを使う。vs2019以降を使う場合は適当に変換してがんばる(未確認)。\u003c/p\u003e\n\n\u003cp\u003eソリューションのビルド構成がいろいろあるので、適切なものを選ぶ。\u003cbr\u003e\n構成名は、\u003ccode\u003e(Debug|Release)(Mono|Win)(|PY3)\u003c/code\u003eという構造になっている。\u003cbr\u003e\n※ただし、\u003ca href=\"https://github.com/pythonnet/pythonnet/issues/910\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこの設定を廃止し、実行時に動的に選択可能にする改善\u003c/a\u003eが検討されているようなので、このあたりの手順は、そのうち大きく変わるかも。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003eDebug|Release\u003c/code\u003e\u003cbr\u003e\nおなじみの、Debug/Releaseビルドの選択。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003eMono|Win\u003c/code\u003e\u003cbr\u003e\nMono(Linux)用か通常のWindows用か。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003e|PY3\u003c/code\u003e\u003cbr\u003e\nなにも付かないほうはpython2系向け、PY3はpython3系向けにビルド。\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e今回はWindows環境でpython3.7を呼び出すのが目的なので、\u003ccode\u003eReleaseWinPY3\u003c/code\u003eを選ぶ。\u003cbr\u003e\nなお、プラットフォーム(x86/x64)はどちらでもよい(今回ビルドしたい\u003ccode\u003ePython.Runtime\u003c/code\u003eプロジェクトはAnyCPU設定になっているため)。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/9efb489e35a239bdbced3c9efc9fd75c6be4aa18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f64373836333661662d633733632d316464392d353435372d6334323462626365653932622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fd78636af-c73c-1dd9-5457-c424bbcee92b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=1e4704c875bd03cf1f9921e8c605fb51\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/d78636af-c73c-1dd9-5457-c424bbcee92b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fd78636af-c73c-1dd9-5457-c424bbcee92b.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=ed98dd3222fba846a003b80e1f785920 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e選んだら、プロジェクト\u003ccode\u003ePython.Runtime\u003c/code\u003eのプロジェクト プロパティを開き、コンパイルシンボルを確認する。\u003cbr\u003e\n\u003ccode\u003ePYTHON3;PYTHON37;UCS2\u003c/code\u003eのような文字列が定義されているので、狙ったpythonバージョンになっているか確認する。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/d06dfb83db2c1e205ab6dc0db124f3b487e8e2c7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f38346130643634372d663230322d303734372d373163392d6339623738326662313432372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F84a0d647-f202-0747-71c9-c9b782fb1427.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=e21e6089cab03849fd6facba0b2b6858\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/84a0d647-f202-0747-71c9-c9b782fb1427.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F84a0d647-f202-0747-71c9-c9b782fb1427.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=7fe66f3542a7f0e248e032e9d1e2f3ce 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e今回はpython3.7を動かすのでPYTHON37でよいが、python3.5にしたい場合はPYTHON35のように書き換える。\u003cbr\u003e\n有効な設定値は、\u003ccode\u003esrc/runtime/runtime.cs\u003c/code\u003eの#if節を参照するとわかる。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ed4e2cc458c08bc6b9d3dca2aa6aa1680362513f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f64386437363262302d356639382d336238372d303836322d3432626539626339316162352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fd8d762b0-5f98-3b87-0862-42be9bc91ab5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=fecdecf8dc56637c7c4ddc15d12f0b91\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/d8d762b0-5f98-3b87-0862-42be9bc91ab5.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fd8d762b0-5f98-3b87-0862-42be9bc91ab5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f7f022793d8653fad1325cefbc010cdc 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"pythonnetのビルド\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#pythonnet%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epythonnetのビルド\u003c/h3\u003e\n\n\u003cp\u003e設定を済ませたプロジェクトをビルドする。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003esrc/runtime/bin\u003c/code\u003e以下に\u003ccode\u003ePython.Runtime.dll\u003c/code\u003eが出力されるので、回収しておく。\u003c/p\u003e\n\n\u003cp\u003e同時に、\u003ccode\u003ePython.Runtime.pdb\u003c/code\u003e(デバッグ情報)と\u003ccode\u003ePython.Runtime.xml\u003c/code\u003e(ドキュメントコメントの情報)も回収しておくと、あとで少し幸せになれるかも。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/6c4addc41d672d5b61c609ac2116025bc8dc87c9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f34386433373034362d613532662d363865382d323762392d3338346466663432303539382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F48d37046-a52f-68e8-27b9-384dff420598.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f2ddebfbcb3e330228640a1c16905693\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/48d37046-a52f-68e8-27b9-384dff420598.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F48d37046-a52f-68e8-27b9-384dff420598.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d60af3aee1974e3db3e155dd91d4de05 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"呼び出し元プロジェクトの作成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E5%85%83%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e呼び出し元プロジェクトの作成\u003c/h3\u003e\n\n\u003cp\u003epythonコードの呼び出し元となるプロジェクト / ソリューションを作る。\u003c/p\u003e\n\n\u003cp\u003eサンプルでは、.NET Framework 4.6.1向けのC#コンソール アプリとした。\u003c/p\u003e\n\n\u003cp\u003e※pythonnetは.NET Framework 4をターゲットに作られているので、それを呼び出せる設定にすること。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/9cee78e9d6aa7818be649e8b4cded55af601402b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f62303962316132642d633163342d653637302d663464322d3266333930633461346439612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fb09b1a2d-c1c4-e670-f4d2-2f390c4a4d9a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=4a69c8772368573ae563cce5b5e6262f\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/b09b1a2d-c1c4-e670-f4d2-2f390c4a4d9a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fb09b1a2d-c1c4-e670-f4d2-2f390c4a4d9a.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=59e4b8fc39b327d14b3e89b500d1893c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"プラットフォームの変更\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E5%A4%89%E6%9B%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eプラットフォームの変更\u003c/h3\u003e\n\n\u003cp\u003e64bit用のPythonのDLLを呼び出すには、呼び出し元のexeも64bit向けにビルドされている必要があるため、その設定を行う。\u003c/p\u003e\n\n\u003cp\u003e作成したソリューションの構成マネージャーを開く。\u003c/p\u003e\n\n\u003cp\u003eプロジェクトのプラットフォームがAnyCPUとなっているので、x64を新規作成する。\u003cbr\u003e\n※このとき、\"新しいソリューション プラットフォームを作成する\"にチェックを入れておくこと。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/8916a873b7d574d825a0715d11df8fec7a8ccb0c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f66336564383663352d333432332d376130302d353935302d3236313036643061313065622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff3ed86c5-3423-7a00-5950-26106d0a10eb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2c7640ad96b8e05984158e7fe68dbe3d\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/f3ed86c5-3423-7a00-5950-26106d0a10eb.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff3ed86c5-3423-7a00-5950-26106d0a10eb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6cc73ab0b6930865de11d6ed85ea392b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/ccffb09cd086aa9c8d6825bb9a7297c438279eb9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f66306464383239362d366266652d663131392d616536612d3433346430633336303631352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff0dd8296-6bfe-f119-ae6a-434d0c360615.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d30326cf4c5a87f86a3a1f446c7c5bec\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/f0dd8296-6bfe-f119-ae6a-434d0c360615.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff0dd8296-6bfe-f119-ae6a-434d0c360615.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=543b4d8268f6e6b9e6a82ca5be516d03 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e作成したら、プロジェクト プラットフォームとソリューション プラットフォームの両方から、AnyCPU設定を削除しておく。\u003cbr\u003e\n※残しておくと、うっかりAnyCPU設定を使ってしまってドハマリする場合があるため。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/e0e6d63c8d33c7fbaf21166b0081e00e5283c7b5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f62316133633664632d643033622d396530652d666664312d6136313839666534306539382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fb1a3c6dc-d03b-9e0e-ffd1-a6189fe40e98.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=55e235fd2350744fadb91b684529bc69\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/b1a3c6dc-d03b-9e0e-ffd1-a6189fe40e98.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fb1a3c6dc-d03b-9e0e-ffd1-a6189fe40e98.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=83876c22986238108081d1697d39ca95 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/6f7a07cfd3568d512dfaced4d9e4778bf1a6e876/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f39636333313438382d313064342d323665322d376363652d3462636233303931366530362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F9cc31488-10d4-26e2-7cce-4bcb30916e06.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5e6fda75d0d20061690c5b5b4cd6bbc2\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/9cc31488-10d4-26e2-7cce-4bcb30916e06.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F9cc31488-10d4-26e2-7cce-4bcb30916e06.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6a3d4798ba52cf8b838aa86d3ebbc7bf 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/2754cdea556ae0961a7bdcbf28eaa22285774cba/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f38366333623161322d346565362d613665392d393435382d3162303238383834356462622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F86c3b1a2-4ee6-a6e9-9458-1b0288845dbb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=afd3760ed97784223ac9bb97027dd39f\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/86c3b1a2-4ee6-a6e9-9458-1b0288845dbb.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F86c3b1a2-4ee6-a6e9-9458-1b0288845dbb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6c7099afe00ae28f767afde7f0fbda4c 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/ea49321a255eed30787a683c6192af75d4d7f1f5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f37333966346536632d663264332d613134392d303832632d3031376561646630333164342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F739f4e6c-f2d3-a149-082c-017eadf031d4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2cf7df2ef681ef060ad07491971227f3\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/739f4e6c-f2d3-a149-082c-017eadf031d4.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F739f4e6c-f2d3-a149-082c-017eadf031d4.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=d154ff89898965778b21bd3c21ddea84 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"参照設定\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E7%85%A7%E8%A8%AD%E5%AE%9A\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参照設定\u003c/h3\u003e\n\n\u003cp\u003epythonnetのビルド時に回収しておいたDLLを、作成したプロジェクトのディレクトリにコピーする。\u003c/p\u003e\n\n\u003cp\u003eプロジェクトの参照設定から、コピーしたDLLに参照を設定する。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/03555647aba1f86a95f0c89d391f7e4826931d9f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f65336261653862622d333437372d643530622d386239632d3063623464653261326365622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fe3bae8bb-3477-d50b-8b9c-0cb4de2a2ceb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=0053afbdd2efda6d11a899ba1d86c083\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/e3bae8bb-3477-d50b-8b9c-0cb4de2a2ceb.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Fe3bae8bb-3477-d50b-8b9c-0cb4de2a2ceb.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e380d2849c513a3d9d729cb39e988184 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/bb006655d2e68985d143ae9ea6d50120bea286b6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f38623037303236382d636638662d386535612d653338312d6338346665383730623135392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F8b070268-cf8f-8e5a-e381-c84fe870b159.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=88e6952de3a153d3d2adede7a3eecb87\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/8b070268-cf8f-8e5a-e381-c84fe870b159.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2F8b070268-cf8f-8e5a-e381-c84fe870b159.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=f3dfca311785201b9eb8c9ce9760e66f 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n※見逃しがちだが、右下に参照ボタンがある。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/4c4d15c2872de3a8feaf39880d651d2890ea43ba/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3432363330382f66363762346239342d316663652d353431642d633134302d3165343339346630396666352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff67b4b94-1fce-541d-c140-1e4394f09ff5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=2e28e7a8f475723d049769318814c5d7\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426308/f67b4b94-1fce-541d-c140-1e4394f09ff5.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F426308%2Ff67b4b94-1fce-541d-c140-1e4394f09ff5.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=b401b6eb15d8c61d5521acd9a52b1d48 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n追加されるとこうなる。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"実装\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装\u003c/h3\u003e\n\n\u003cp\u003e以下を実装する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003ePython.Runtime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.IO\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Linq\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003ePythonTest\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e/// プロセスの環境変数PATHに、指定されたディレクトリを追加する(パスを通す)。\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"paths\"\u0026gt;PATHに追加するディレクトリ。\u0026lt;/param\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddEnvPath\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eparams\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003epaths\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenvPaths\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEnvironmentVariable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"PATH\"\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eSplit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePathSeparator\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eToList\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003epaths\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eenvPaths\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eenvPaths\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInsert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetEnvironmentVariable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"PATH\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eJoin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePathSeparator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eenvPaths\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironmentVariableTarget\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eProcess\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e/// プログラムのエントリポイント。\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e/// \u0026lt;param name=\"args\"\u0026gt;コマンドライン引数。\u0026lt;/param\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// *-------------------------------------------------------*\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// * python環境の設定\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// *-------------------------------------------------------*\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// python環境にパスを通す\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// TODO: 環境に合わせてパスを直すこと\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ePYTHON_HOME\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eExpandEnvironmentVariables\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e@\"%userprofile%\\Anaconda3\\envs\\pythonnet_test\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// pythonnetが、python本体のDLLおよび依存DLLを見つけられるようにする\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eAddEnvPath\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n              \u003cspan class=\"n\"\u003ePYTHON_HOME\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n              \u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCombine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePYTHON_HOME\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"Library\\bin\"\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// python環境に、PYTHON_HOME(標準pythonライブラリの場所)を設定\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePythonEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePythonHome\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePYTHON_HOME\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// python環境に、PYTHON_PATH(モジュールファイルのデフォルトの検索パス)を設定\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePythonEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePythonPath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eJoin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n              \u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePathSeparator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToString\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n              \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                  \u003cspan class=\"n\"\u003ePythonEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePythonPath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 元の設定を残す\u003c/span\u003e\n                  \u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCombine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePYTHON_HOME\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e@\"Lib\\site-packages\"\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"c1\"\u003e//pipで入れたパッケージはここに入る\u003c/span\u003e\n                  \u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCombine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e@\"C:\\foo\\bar\\my_packages\"\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"c1\"\u003e//自分で作った(動かしたい)pythonプログラムの置き場所も追加\u003c/span\u003e\n              \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// 初期化 (明示的に呼ばなくても内部で自動実行されるようだが、一応呼ぶ)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePythonEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInitialize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// *-------------------------------------------------------*\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// * pythonコードの実行\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// *-------------------------------------------------------*\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// Global Interpreter Lockを取得\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePy\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGIL\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// モジュールの探索パスを表示 (pythonコードを直接指定して実行)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ePythonEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRunSimpleString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e@\"\nimport sys\nimport pprint\nprint('module path =')\npprint.pprint(sys.path)\n\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e// numpyのオブジェクトを取得し、呼び出してみる\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003edynamic\u003c/span\u003e \u003cspan class=\"n\"\u003enp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePy\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"numpy\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"np.cos(np.pi * 2) =  \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003enp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ecos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epi\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e// 自作コードも叩ける\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003edynamic\u003c/span\u003e \u003cspan class=\"n\"\u003emyMath\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePy\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"my_awesome_lib.my_math\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \"from my_awesome_lib import my_math\"\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003edynamic\u003c/span\u003e \u003cspan class=\"n\"\u003ecalculator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emyMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCalculator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e7\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// クラスのインスタンスを生成\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"5 + 7 = \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ecalculator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e()}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// クラスのメソッド呼び出し\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"sum(1,2,3,4,5) = \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003emyMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCalculator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003esum\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e \u003cspan class=\"p\"\u003e})}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e//staticメソッドも当然呼べる\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003edynamic\u003c/span\u003e \u003cspan class=\"n\"\u003edict\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emyMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetDict\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 辞書型を返す関数呼び出し\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edict\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 辞書からキーを指定して読み取り\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// python環境を破棄\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePythonEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eShutdown\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Press any key to continue...\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadKey\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eただし、\u003cstrong\u003eこのままではまだ動かない\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"python環境を作る\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#python%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epython環境を作る\u003c/h2\u003e\n\n\u003cp\u003epython環境を導入する。\u003c/p\u003e\n\n\u003cp\u003e今回は、\u003ca href=\"https://www.anaconda.com/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eAnaconda\u003c/a\u003eで、\"pythonnet_test\"という名前のpython3.7環境(64bit)を作り、利用する。\u003cbr\u003e\nよって、python環境のルートディレクトリは\u003ccode\u003e%userprofile%\\anaconda(最近はminicondaかも?)\\envs\\pythonnet_test\u003c/code\u003eとなる。\u003c/p\u003e\n\n\u003cp\u003eまた、C#からpythonの追加パッケージが利用できることを確認するため、numpyを追加インストールした。\u003c/p\u003e\n\n\u003cp\u003epython環境を別の方法で導入する場合は、ルートディレクトリのパスを確認し、numpyもインストールしておくこと。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"自前パッケージを配置\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%87%AA%E5%89%8D%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E9%85%8D%E7%BD%AE\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e自前パッケージを配置\u003c/h2\u003e\n\n\u003cp\u003e自作pythonコードが呼び出せることを確認するため、呼び出し先となるpythonプログラムを準備する。\u003c/p\u003e\n\n\u003cp\u003e以下コードを、\u0026lt;任意のディレクトリ\u0026gt;\\my_awesome_lib\\my_math.pyに配置する。\u003c/p\u003e\n\n\u003cp\u003e※配置したディレクトリは後で使うので覚えておくこと。サンプルでは\u003ccode\u003eC:\\foo\\bar\\my_packages\\my_awesome_lib\\my_math.py\u003c/code\u003eに置いた。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"python\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e# よくありがちなしょうもないテストコード\n\u003c/span\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eCalculator\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003e__init__\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\n        \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e\n\n    \u003cspan class=\"o\"\u003e@\u003c/span\u003e\u003cspan class=\"nb\"\u003estaticmethod\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003esum\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enum_list\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nb\"\u003esum\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enum_list\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetDict\u003c/span\u003e\u003cspan class=\"p\"\u003e():\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\"this\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\"is\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\"my\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"mi\"\u003e3\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\"dictionary\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"python環境にパスを通す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#python%E7%92%B0%E5%A2%83%E3%81%AB%E3%83%91%E3%82%B9%E3%82%92%E9%80%9A%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epython環境にパスを通す\u003c/h2\u003e\n\n\u003cp\u003e作成したpython環境にパスを通す。これが一番難しい(というか情報がない)。\u003c/p\u003e\n\n\u003cp\u003eソースコード中、\"python環境の設定\"というコメント以降がこの設定に相当するので、コードを修正する。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"pythonnetがpython本体のdllを見つけられるようにする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#pythonnet%E3%81%8Cpython%E6%9C%AC%E4%BD%93%E3%81%AEdll%E3%82%92%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%89%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epythonnetがpython本体のDLLを見つけられるようにする\u003c/h3\u003e\n\n\u003cp\u003epythonnetがpython本体のDLLを見つけられるよう、環境変数(PATH)にディレクトリを追加する。\u003c/p\u003e\n\n\u003cp\u003eサンプルでは、ユーティリティ関数\u003ccode\u003eAddEnvPath()\u003c/code\u003eによって、以下を設定している：\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003epython環境のルート\u003c/p\u003e\n\n\u003cp\u003epythonXX.dll(python3.7ならpython37.dll)のあるディレクトリ。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003epython環境のルート\\Library\\bin\u003c/p\u003e\n\n\u003cp\u003eこのディレクトリに、pythonXX.dllが依存しているDLLの一部が格納されていた。\u003cbr\u003e\npython環境の作り方によっては必要ないか、別のディレクトリを指定する必要があるかも。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eパスの通し方には複数の方法があるが、この例と同様、プログラム中(コード)で設定することをお勧めする。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eプログラム中(コード)で設定\u003c/p\u003e\n\n\u003cp\u003eきちんと設定されていることを保証できる。おすすめ。\u003cbr\u003e\nただし、サンプルではパスをハードコードしているが、普通は設定ファイルとかから読むようにすべき。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWindowsのシステム環境変数に設定\u003c/p\u003e\n\n\u003cp\u003eシステム全体に効くため楽だが、複数のpython環境が運用できなくなる。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eexe起動前に(bat等で)事前設定する\u003c/p\u003e\n\n\u003cp\u003eデバッグ実行などがやりにくい。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"python本体がpythonのモジュール標準モジュールを含むを見つけられるようにする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#python%E6%9C%AC%E4%BD%93%E3%81%8Cpython%E3%81%AE%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E6%A8%99%E6%BA%96%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E5%90%AB%E3%82%80%E3%82%92%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%89%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epython本体が、pythonのモジュール(標準モジュールを含む)を見つけられるようにする\u003c/h3\u003e\n\n\u003cp\u003epython本体に、pythonのモジュールを探索するパスを設定する。\u003c/p\u003e\n\n\u003cp\u003eこれが正しく設定されていないと、pythonの標準ライブラリやpip等で入れたライブラリ、自作コードを見つけることができない。\u003c/p\u003e\n\n\u003cp\u003e設定すべき項目は2種類ある。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003ePYTHON_HOME\u003c/p\u003e\n\n\u003cp\u003epython環境のルート。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePYTHON_PATH\u003c/p\u003e\n\n\u003cp\u003epythonモジュールの探索場所。セミコロンで区切って指定する。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003ePYTHON_PATHには、デフォルトで以下が設定されている：\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  %PYTHON_HOME%\\pythonXX.zip\u003c/li\u003e\n\u003cli\u003e  %PYTHON_HOME%\\DLLs\u003c/li\u003e\n\u003cli\u003e  %PYTHON_HOME%\\lib\u003c/li\u003e\n\u003cli\u003e  カレントディレクトリ\u003cbr\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eサンプルでは、これらに加え、以下を設定している。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  pipのインストール先ディレクトリ (Lib\\site-packages)\u003c/li\u003e\n\u003cli\u003e  自作コードの存在するディレクトリ (～\\my_packages、実際に置いた場所に合わせて適宜修正すること)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e必要なら、さらに追加することもできる。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"実行\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実行\u003c/h2\u003e\n\n\u003cp\u003eここまで設定すると、サンプルが動くようになる(はず)。\u003c/p\u003e\n\n\u003cp\u003eビルドして実行してみて、以下のように出力されれば成功。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"console\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"go\"\u003emodule path =\n['C:\\\\～～～',\n\u003c/span\u003e\u003cspan class=\"c\"\u003e ...\n\u003c/span\u003e\u003cspan class=\"go\"\u003e 'C:\\\\Windows\\\\Microsoft.NET\\\\Framework64\\\\v4.0.30319\\\\']\nnp.cos(np.pi * 2) =  1.0\n5 + 7 = 12\nsum(1,2,3,4,5) = 15\ndictionary\nPress any key to continue...\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ePythonの関数やクラスが呼び出せ、値をやり取りできていることが分かる。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ハマりどころ基本編\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%8F%E3%83%9E%E3%82%8A%E3%81%A9%E3%81%93%E3%82%8D%E5%9F%BA%E6%9C%AC%E7%B7%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eハマりどころ(基本編)\u003c/h2\u003e\n\n\u003cp\u003eよくあるトラブル。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"pythonruntimepythonexception-modulenotfounderror--no-module-named-が起きる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#pythonruntimepythonexception-modulenotfounderror--no-module-named-%E3%81%8C%E8%B5%B7%E3%81%8D%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003ePython.Runtime.PythonException: ModuleNotFoundError : No module named '～～'\u003c/code\u003eが起きる\u003c/h3\u003e\n\n\u003cp\u003epythonモジュールを見つけられていない。おそらく、PythonPathの設定をミスしている。\u003c/p\u003e\n\n\u003cp\u003e見つからないと怒られたモジュールの実体(ファイル)がどこにあるか調べ、PythonPathが適切に設定されているか確認する。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"badimageformatexceptionが起きる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#badimageformatexception%E3%81%8C%E8%B5%B7%E3%81%8D%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eBadImageFormatException\u003c/code\u003eが起きる\u003c/h3\u003e\n\n\u003cp\u003eDLL関連の問題は、だいたい何でもこの例外になる。\u003c/p\u003e\n\n\u003cp\u003e原因が多岐にわたるので調査が難しいが、以下のどれかが原因のことが多い。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003epythonのDLLがあるディレクトリにパスが通っていない\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003epythonnetのビルド時に、適切なpythonバージョンを指定しなかった\u003cbr\u003e\npython3.5の環境で動かしたいのにpython3.7向けにビルドしてしまった、など。\u003cbr\u003e\npythonnetが探しに行くDLL名はビルド時に決まるので(python3.7向けにビルドした場合はpython37.dllを探しに行く)、ビルド時の環境と実環境が不一致だとDLLの読み込みに失敗する。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003epythonのDLLが依存しているDLLにパスが通っていない(見つからない)\u003cbr\u003e\nDLLが見つかっても、そのDLLが依存しているDLLが見つからない場合は、やはり読み込みエラーとなる。\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e呼び出し元プロジェクト・python本体のプラットフォーム(x86/x64)が一致してない\u003cbr\u003e\n特に、 呼び出し元のプロジェクトをAnyCPU設定にするのは混乱の元になるので避けたほうがよい(もともとの挙動がややこしい上、.NET 4.5以前と以後での挙動が異なる)。\u003cbr\u003e\n※pythonnet本体は、AnyCPUでビルドされるため、呼び出し元プロジェクトの設定に従う。\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこの手の問題が発生してしまった場合は、以下のような調査手段で何とかする。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"https://github.com/lucasg/Dependencies\" rel=\"nofollow noopener\" target=\"_blank\"\u003eDependencies\u003c/a\u003eでDLLの依存関係を追っかける\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003edumpbinコマンドで各DLLのプラットフォーム(x86/64)を確認する\u003cbr\u003e\ne.g. \u003ccode\u003edumpbin /headers hoge.dll\u003c/code\u003e\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/sysinternals/downloads/procmon\" rel=\"nofollow noopener\" target=\"_blank\"\u003eProcess Monitor\u003c/a\u003eでロードに失敗したDLLを特定する\u003cbr\u003e\nIRP_MJ_CREATEが何度も失敗しており(DLLの探索先パスを全て探すため)、最後までLoad Imageが実行されていない(= DLLが見つからなかった)DLLが犯人。\u003cbr\u003e\nまた、Load Imageした結果がSUCCESSでないDLLも怪しい。\u003cbr\u003e\nフィルタ設定を以下にするとわかりやすい。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  Process：python呼び出し元のexe\u003c/li\u003e\n\u003cli\u003e  Operation：\u003ccode\u003eIRP_MJ_CREATE\u003c/code\u003e(ファイルのオープン)と\u003ccode\u003eLoad Image\u003c/code\u003e(DLLの読み込み)をInclude\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eなお、\u003ccode\u003eIRP_MJ_CREATE\u003c/code\u003eはFiler -\u0026gt; Enable advanced outputを有効にしていないと表示されない。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ハマりどころ応用編\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%8F%E3%83%9E%E3%82%8A%E3%81%A9%E3%81%93%E3%82%8D%E5%BF%9C%E7%94%A8%E7%B7%A8\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eハマりどころ(応用編)\u003c/h2\u003e\n\n\u003cp\u003eちょっと難しいことをやろうとするとハマること。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"複数スレッドからの実行\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A4%87%E6%95%B0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%8B%E3%82%89%E3%81%AE%E5%AE%9F%E8%A1%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e複数スレッドからの実行\u003c/h3\u003e\n\n\u003cp\u003eC#で、複数のスレッド(pythonnetを初期化した以外のスレッド)からPythonコードを呼び出す場合には、注意が必要。\u003c/p\u003e\n\n\u003cp\u003ePython(CPython)は、設計上、\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%97%E3%83%AA%E3%82%BF%E3%83%AD%E3%83%83%E3%82%AF\" rel=\"nofollow noopener\" target=\"_blank\"\u003eGIL\u003c/a\u003eを採用している(GIL自体の説明は本題とずれるので割愛)。\u003cbr\u003e\nまた、明示的に開放処理を行わない限り、pythonnetはメインスレッド(= pythonnetを初期化したスレッド)でGILを保持したままにする。\u003cbr\u003e\nよって、C#の別スレッドからPythonのコードを実行しようとした場合、GILの取得(using(Py.GIL())でデッドロックする。\u003c/p\u003e\n\n\u003cp\u003eこれを回避するには、pythonnetの初期化後(PythonEngine.Initialize()の呼び出し後)に、PythonEngine.BeginAllowThreads()を呼び出し、明示的にGILを解放する。\u003cbr\u003e\nこれにより、他スレッドからもGILが取得できるようになり、C#の複数スレッドからPythonのコードが呼び出せるようになる。\u003cbr\u003e\nただし、GILで排他されることには変わりがないことには注意が必要。\u003cbr\u003e\nPython側コードの並列実行はされず、単に複数スレッドから呼び出せるようになるだけ。\u003c/p\u003e\n\n\u003cp\u003eなお、pythonnetのBeginAllowThreads()メソッドが何をやっているのかは、\u003ca href=\"https://docs.python.org/ja/3/c-api/init.html#releasing-the-gil-from-extension-code\" rel=\"nofollow noopener\" target=\"_blank\"\u003ePythonのC APIのドキュメント\u003c/a\u003eを読むとイメージがつかめる。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"巨大データの扱い\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%B7%A8%E5%A4%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%89%B1%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e巨大データの扱い\u003c/h3\u003e\n\n\u003cp\u003eC#からPythonに巨大な配列やリストを単純に渡すと、要素全てが個別にpythonのオブジェクトに変換されるため、とてつもなく遅くなる。\u003cbr\u003e\n※ためしに4k解像度の画像データ(uint8の画素値)が入った配列を渡したら、なにもしないpython関数を呼び出すだけでも、秒単位の時間がかかった…\u003c/p\u003e\n\n\u003cp\u003eこういう場合には、ポインタ経由での引き渡しが有効。\u003cbr\u003e\nたとえば8bit グレースケールの画像を受け渡す場合、以下のようにする。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"python\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003enumpy\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003enp\u003c/span\u003e\n\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003ectypes.util\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ectypes\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003emy_func\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"bp\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eimg_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estride\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eheight\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# ポインタからnumpyのarrayを作る\n\u003c/span\u003e    \u003cspan class=\"n\"\u003eimg\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ectypeslib\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eas_array\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003estride\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eheight\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ectypes\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ec_uint8\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"n\"\u003efrom_address\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimg_ptr\u003c/span\u003e\u003cspan class=\"p\"\u003e)).\u003c/span\u003e\u003cspan class=\"n\"\u003ereshape\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eheight\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estride\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# imgに対していろいろ処理する…\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eC#からは、以下のように呼び出す。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// この画像を引き渡したい\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ehugeImage\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eBitmap\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e65536\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e65536\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ePixelFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFormat8bppIndexed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eBitmapData\u003c/span\u003e \u003cspan class=\"n\"\u003ebitmapData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003etry\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 画像をロック\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ebitmapData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehugeImage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLockBits\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n       \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eRectangle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003ePoint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSize\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n       \u003cspan class=\"n\"\u003eImageLockMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReadOnly\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n       \u003cspan class=\"n\"\u003ePixelFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFormat8bppIndexed\u003c/span\u003e\n       \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePy\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGIL\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e        \n        \u003cspan class=\"c1\"\u003e// pythonモジュールを読み込む。ファイル名等は適宜変更すること\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003edynamic\u003c/span\u003e \u003cspan class=\"n\"\u003emyPython\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePy\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eImport\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"myPython\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003emyPython\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003emy_func\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebitmapData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eScan0\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt64\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 画像バッファの先頭ポインタを引き渡す\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebitmapData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWidth\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e//当然ながら画像サイズとストライドも必要\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebitmapData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStride\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebitmapData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHeight\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003efinally\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ロックした画像を解放\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebitmapData\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ehugeImage\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnlockBits\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebitmapData\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e画像ではなく配列やリストを渡したい場合は、\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/api/system.runtime.interopservices.marshal\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMarshalクラス\u003c/a\u003eを使ってIntPtrにさえ変換してしまえば、同じように渡せる。\u003cbr\u003e\nunsafeコードを使えるなら、\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/csharp/language-reference/keywords/fixed-statement\" rel=\"nofollow noopener\" target=\"_blank\"\u003efixed\u003c/a\u003eを使っても、もちろんよい。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"pythonnetを使わない方法\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#pythonnet%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84%E6%96%B9%E6%B3%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epythonnetを使わない方法\u003c/h2\u003e\n\n\u003cp\u003epythonnetを使わない方法としては、以下のような方法での呼び出し方が考えられる。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"python側をコマンドラインプログラムとして設計しc側から起動する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#python%E5%81%B4%E3%82%92%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%A8%E3%81%97%E3%81%A6%E8%A8%AD%E8%A8%88%E3%81%97c%E5%81%B4%E3%81%8B%E3%82%89%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epython側をコマンドラインプログラムとして設計し、C#側から起動する\u003c/h3\u003e\n\n\u003cp\u003eデータのやりとりは、標準入出力やファイルを経由して行う。\u003c/p\u003e\n\n\u003cp\u003epros:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  シンプルでわかりやすい。\u003c/li\u003e\n\u003cli\u003e  pythonランタイム環境と疎結合にできる。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003econs:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  起動終了などのオーバーヘッドが大きい。\u003c/li\u003e\n\u003cli\u003e  細かい制御がしにくい。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"python側をサーバとして設計しc側からサーバに対して要求を投げる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#python%E5%81%B4%E3%82%92%E3%82%B5%E3%83%BC%E3%83%90%E3%81%A8%E3%81%97%E3%81%A6%E8%A8%AD%E8%A8%88%E3%81%97c%E5%81%B4%E3%81%8B%E3%82%89%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E8%A6%81%E6%B1%82%E3%82%92%E6%8A%95%E3%81%92%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003epython側をサーバとして設計し、C#側からサーバに対して要求を投げる\u003c/h3\u003e\n\n\u003cp\u003epython側をサービスにしてしまう。\u003cbr\u003e\nWebAPIサーバにしてもよいし、\u003ca href=\"https://thrift.apache.org/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eApache Thrift\u003c/a\u003eや\u003ca href=\"https://www.grpc.io/\" rel=\"nofollow noopener\" target=\"_blank\"\u003egRPC\u003c/a\u003eのようなRPCフレームワークを使ってもよい。\u003c/p\u003e\n\n\u003cp\u003epros:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  設計自由度が高い。\u003c/li\u003e\n\u003cli\u003e  オーバーヘッドが比較的小さい(ただしプロセス間通信やシリアライゼーションは発生するので、同一プロセスで処理するよりはやや遅いはず)。\u003c/li\u003e\n\u003cli\u003e  pythonランタイム環境と疎結合にできる。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003econs:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  プロセスが2個になり、起動終了管理などが必要になる。\u003c/li\u003e\n\u003cli\u003e  RPC部分を別途設計・実装・メンテしないといけない。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ironpythonを使う\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ironpython%E3%82%92%E4%BD%BF%E3%81%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ca href=\"https://ironpython.net/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eIronpython\u003c/a\u003eを使う\u003c/h3\u003e\n\n\u003cp\u003ecpythonと決別する。\u003cbr\u003e\n「既存のpythonコードをC#から叩きたい」という用途には、おそらく茨の道。\u003c/p\u003e\n\n\u003cp\u003epros:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  Ironpython自体が.NET上で動くpython処理系なので、.NETとの相性がいい。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003econs:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e  cpythonとの互換性に難がある(例えば、*.pydを使うライブラリはほぼ使えないと思ったほうが良い)。\u003c/li\u003e\n\u003cli\u003e  python2.x系しかサポートしていない(一応、3.xをサポートするIronpython 3も開発中らしいが、コミットログを見る限りほとんど停滞している)。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\n\u003cli id=\"fn1\"\u003e\n\u003cp\u003e※\u003ca href=\"https://qiita.com/y-tsutsu/items/0c4561d6478be32e6f8e\" id=\"reference-d99bbb6267687cf75777\"\u003e動かなかった…という記事\u003c/a\u003eはあったのでそっとリンク。 \u003ca href=\"#fnref1\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003c/ol\u003e\n\u003c/div\u003e\n","createdAt":"2019-07-23T08:39:27Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"w+FKQXsOOCBbee5bP5FfO5SHiHgFi8Fe--j7Vno1SDpkcmot2b--6/0qHezNG/zCMWLnowjAHw==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-11-16T03:57:31Z","likesCount":66,"linkUrl":"https://qiita.com/hogegex/items/3743225a7af13e93df78","organization":null,"originalId":977366,"stockedCount":89,"title":".NET (C#)からpythonを呼び出す","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#net-c%E3%81%8B%E3%82%89python%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99\"\u003e.NET (C#)からpythonを呼び出す\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%89%8D%E6%8F%90\"\u003e前提\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%89%8B%E9%A0%86\"\u003e手順\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#pythonnet%E3%81%AE%E8%A8%AD%E5%AE%9A\"\u003epythonnetの設定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#pythonnet%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89\"\u003epythonnetのビルド\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E5%85%83%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90\"\u003e呼び出し元プロジェクトの作成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%97%E3%83%A9%E3%83%83%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E3%81%AE%E5%A4%89%E6%9B%B4\"\u003eプラットフォームの変更\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E7%85%A7%E8%A8%AD%E5%AE%9A\"\u003e参照設定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85\"\u003e実装\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#python%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B\"\u003epython環境を作る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%87%AA%E5%89%8D%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E9%85%8D%E7%BD%AE\"\u003e自前パッケージを配置\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#python%E7%92%B0%E5%A2%83%E3%81%AB%E3%83%91%E3%82%B9%E3%82%92%E9%80%9A%E3%81%99\"\u003epython環境にパスを通す\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#pythonnet%E3%81%8Cpython%E6%9C%AC%E4%BD%93%E3%81%AEdll%E3%82%92%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%89%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003epythonnetがpython本体のDLLを見つけられるようにする\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#python%E6%9C%AC%E4%BD%93%E3%81%8Cpython%E3%81%AE%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E6%A8%99%E6%BA%96%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E5%90%AB%E3%82%80%E3%82%92%E8%A6%8B%E3%81%A4%E3%81%91%E3%82%89%E3%82%8C%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%99%E3%82%8B\"\u003epython本体が、pythonのモジュール(標準モジュールを含む)を見つけられるようにする\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A1%8C\"\u003e実行\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%8F%E3%83%9E%E3%82%8A%E3%81%A9%E3%81%93%E3%82%8D%E5%9F%BA%E6%9C%AC%E7%B7%A8\"\u003eハマりどころ(基本編)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#pythonruntimepythonexception-modulenotfounderror--no-module-named-%E3%81%8C%E8%B5%B7%E3%81%8D%E3%82%8B\"\u003ePython.Runtime.PythonException: ModuleNotFoundError : No module named '～～'が起きる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#badimageformatexception%E3%81%8C%E8%B5%B7%E3%81%8D%E3%82%8B\"\u003eBadImageFormatExceptionが起きる\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%8F%E3%83%9E%E3%82%8A%E3%81%A9%E3%81%93%E3%82%8D%E5%BF%9C%E7%94%A8%E7%B7%A8\"\u003eハマりどころ(応用編)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A4%87%E6%95%B0%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%8B%E3%82%89%E3%81%AE%E5%AE%9F%E8%A1%8C\"\u003e複数スレッドからの実行\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%B7%A8%E5%A4%A7%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%89%B1%E3%81%84\"\u003e巨大データの扱い\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#pythonnet%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84%E6%96%B9%E6%B3%95\"\u003epythonnetを使わない方法\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#python%E5%81%B4%E3%82%92%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%A8%E3%81%97%E3%81%A6%E8%A8%AD%E8%A8%88%E3%81%97c%E5%81%B4%E3%81%8B%E3%82%89%E8%B5%B7%E5%8B%95%E3%81%99%E3%82%8B\"\u003epython側をコマンドラインプログラムとして設計し、C#側から起動する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#python%E5%81%B4%E3%82%92%E3%82%B5%E3%83%BC%E3%83%90%E3%81%A8%E3%81%97%E3%81%A6%E8%A8%AD%E8%A8%88%E3%81%97c%E5%81%B4%E3%81%8B%E3%82%89%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E8%A6%81%E6%B1%82%E3%82%92%E6%8A%95%E3%81%92%E3%82%8B\"\u003epython側をサーバとして設計し、C#側からサーバに対して要求を投げる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ironpython%E3%82%92%E4%BD%BF%E3%81%86\"\u003eIronpythonを使う\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":34435,"uuid":"3743225a7af13e93df78","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"QkiuLfE0CRF/T461lrmq9vPk3/ua--kHVe4nh+mB2Xwz27--WS2zGw7RhBj/8HOFR64ISQ==","originalId":426308,"description":"ニッチならニッチなほど有用\r\nそういうものでしょう？","facebookUrl":null,"githubUrl":"https://github.com/hogegex","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"ほげ山 ほげげ","profileImageUrl":"https://avatars2.githubusercontent.com/u/39821569?v=4","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F39821569%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=0016a055cde498412341268205411b53","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F39821569%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=2d8cb363fa375210998c41db1a967144","urlName":"hogegex","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"Python","urlName":"python"},{"name":"C#","urlName":"csharp"},{"name":".NET","urlName":".net"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
