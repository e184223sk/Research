<!DOCTYPE html><html><head><meta charset="utf-8" /><title>CQRS+ESで大事なのはコマンド部(イベント)とプロジェクタなのでは、という話 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/kwhrkzk/items/49318714e2cbd0f8ea9d" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="7I6iU7FwS/HH8occet6ryBxjmy4GQo7vqnM8ZzIYysG0wWXTvk6TDMDJaG1wUiFkE2XvIb08qCcpmjNQ70AfGA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="CQRS+ESで大事なのはコマンド部(イベント)とプロジェクタなのでは、という話 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RMUZTVXl0RlUtT0JwLVdrcC1TNmktT0JxdU9CcnVPQnItT0NzLU9EbnVPRHMtT0RpZW1EcUNqamdxVGpnNW5qZzdQamc0Z3A0NEdvNDRPWDQ0T3Q0NEs0NDRLbjQ0S3Y0NEtfNDRHcTQ0R3U0NEduNDRHdjQ0Q0I0NEdvNDRHRTQ0R0c2S214JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTk3NzljNmY5MzY5OWUzN2U2MDFjZTAzMjI3OTVhYmIy&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3QzYUhKcmVtcyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWFjMjM0OWQwMjg3ZTg0ZjE0NmE0NWZmYmRlY2UwNmUy&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=38805123ba061eb60036a58efe18c3ec"><meta property="og:description" content="

はじめに

EventStoreを用いたCQRS+イベントソーシングの実践と考察の続きで設計していたところ、CQRS+ESを真に体感できたためその内容について投稿します。(当たり前過ぎたらすいません。)


自分的CQRS+ESに..."><meta content="https://qiita.com/kwhrkzk/items/49318714e2cbd0f8ea9d" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,EventSourcing,EventStore,CQRS,.NETCore" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-a691d448-c4df-4376-ad9b-27b0979bb07e"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fkwhrkzk%2Fitems%2F49318714e2cbd0f8ea9d">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fkwhrkzk%2Fitems%2F49318714e2cbd0f8ea9d">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-a691d448-c4df-4376-ad9b-27b0979bb07e">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2019-05-17T18:00:10.000+09:00","dateModified":"2019-05-17T18:00:10.000+09:00","headline":"CQRS+ESで大事なのはコマンド部(イベント)とプロジェクタなのでは、という話","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1RMUZTVXl0RlUtT0JwLVdrcC1TNmktT0JxdU9CcnVPQnItT0NzLU9EbnVPRHMtT0RpZW1EcUNqamdxVGpnNW5qZzdQamc0Z3A0NEdvNDRPWDQ0T3Q0NEs0NDRLbjQ0S3Y0NEtfNDRHcTQ0R3U0NEduNDRHdjQ0Q0I0NEdvNDRHRTQ0R0c2S214JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTk3NzljNmY5MzY5OWUzN2U2MDFjZTAzMjI3OTVhYmIy\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR3QzYUhKcmVtcyZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPWFjMjM0OWQwMjg3ZTg0ZjE0NmE0NWZmYmRlY2UwNmUy\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=38805123ba061eb60036a58efe18c3ec","mainEntityOfPage":"https://qiita.com/kwhrkzk/items/49318714e2cbd0f8ea9d","author":{"@type":"Person","address":"","email":"kwhrkzk83@gmail.com","identifier":"kwhrkzk","name":"kwhrkzk","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F109302%2Fprofile-images%2F1473710836?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=bc1008a15372fd88012c75f398220c07","url":"https://qiita.com/kwhrkzk","description":"業務系に従事。WPF,PRISM,C#,F#,.NET Core,Laravel,Vue,TypeScript,DDD,CQRS,SOLIDらへんに興味有。","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"kwhrkzk","type":"items","id":"49318714e2cbd0f8ea9d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"kwhrkzk","type":"items","id":"49318714e2cbd0f8ea9d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"kwhrkzk","type":"items","id":"49318714e2cbd0f8ea9d"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/kwhrkzk/items/49318714e2cbd0f8ea9d","location":"/kwhrkzk/items/49318714e2cbd0f8ea9d","scheme":"https","host":"qiita.com","port":null,"pathname":"/kwhrkzk/items/49318714e2cbd0f8ea9d","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"wjmO+uiGrDYtuOIMM+C5CQtxOxme/+gzFad4YrmJWFuadkl657h0yyqDDX05bDOlBHdPFiWBzvuWTndVZNGNgg==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-aa1060d4-97e9-4229-a308-3a4b158e6fc6"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d/likers" class="css-1iupg5d">10</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">5</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/49318714e2cbd0f8ea9d/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/kwhrkzk"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/109302/profile-images/1473710836" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/kwhrkzk" class="css-10ougpm">@<!-- -->kwhrkzk</a><div class="css-1ay9vb9"><time dateTime="2019-05-17T09:00:10Z" class="css-m19uds">posted at 2019-05-17</time></div></div></div></div></div><h1 class="css-cgzq40">CQRS+ESで大事なのはコマンド部(イベント)とプロジェクタなのでは、という話</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/eventsourcing" class="css-4czcte">EventSourcing</a><a href="/tags/eventstore" class="css-4czcte">EventStore</a><a href="/tags/cqrs" class="css-4czcte">CQRS</a><a href="/tags/.netcore" class="css-4czcte">.NETCore</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p><a href="https://qiita.com/kwhrkzk/items/27c9f4100afdbd49eede" id="reference-84cbc16f3b3927d2b509">EventStoreを用いたCQRS+イベントソーシングの実践と考察</a>の続きで設計していたところ、CQRS+ESを真に体感できたためその内容について投稿します。(当たり前過ぎたらすいません。)</p>

<h1>
<span id="自分的cqrsesにたどり着くまでの流れ" class="fragment"></span><a href="#%E8%87%AA%E5%88%86%E7%9A%84cqrses%E3%81%AB%E3%81%9F%E3%81%A9%E3%82%8A%E7%9D%80%E3%81%8F%E3%81%BE%E3%81%A7%E3%81%AE%E6%B5%81%E3%82%8C"><i class="fa fa-link"></i></a>自分的CQRS+ESにたどり着くまでの流れ</h1>

<h2>
<span id="全部リポジトリ経由" class="fragment"></span><a href="#%E5%85%A8%E9%83%A8%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E7%B5%8C%E7%94%B1"><i class="fa fa-link"></i></a>全部リポジトリ経由</h2>

<p>はじめにDDDを学んだときは、集約はリポジトリ経由で保存と取得をすべきと考えていました。<br>
<a href="https://camo.qiitausercontent.com/54904e70a0e24a2a09287e66bccdc75fc3651c3a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f39623762306636302d363434662d376637632d393963302d6164623737343538323337342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F9b7b0f60-644f-7f7c-99c0-adb774582374.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6a87b6aacff5247f7221c620a6b8d424" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/9b7b0f60-644f-7f7c-99c0-adb774582374.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F9b7b0f60-644f-7f7c-99c0-adb774582374.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e586b0f34c4f84501956be7be51d52f0 1x" loading="lazy"></a></p>

<p>このときは各画面特有の情報の固まりをどうやって取得しようかと悩みました。</p>

<ul>
<li>必要な集約を全部取得して画面に必要な部分だけ使う(余計な情報も取得してる)</li>
<li>集約にGet専用なプロパティを追加しちゃう(SQLがjoinだらけでカオス)</li>
</ul>

<h2>
<span id="cqrs" class="fragment"></span><a href="#cqrs"><i class="fa fa-link"></i></a>CQRS</h2>

<p>コマンドとクエリを分離するべきと考えを改めました。<br>
<a href="https://camo.qiitausercontent.com/1eaab24ea5c36e72312746ad06916631c5a9684c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f36396562363561622d353539392d633235362d616666662d6362363839653061666335302e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F69eb65ab-5599-c256-afff-cb689e0afc50.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fbaeee588896f4de01af02367891b585" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/69eb65ab-5599-c256-afff-cb689e0afc50.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F69eb65ab-5599-c256-afff-cb689e0afc50.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4d1cf46aada0ff30d5c534896245f8cd 1x" loading="lazy"></a></p>

<p>これで取得部はかなり自由になり楽になりました。<br>
保存は前回のまま集約単位で保存していました。</p>

<h2>
<span id="cqrses" class="fragment"></span><a href="#cqrses"><i class="fa fa-link"></i></a>CQRS+ES</h2>

<p>格納先を物理的に分けてみようと思いEventStoreを導入してみました。<br>
<a href="https://qiita.com/kwhrkzk/items/27c9f4100afdbd49eede">EventStoreを用いたCQRS+イベントソーシングの実践と考察</a>の話です。<br>
<a href="https://camo.qiitausercontent.com/3f58803904b80a1e1d4e4117f691a70dcb18479e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f30326539666265322d393433332d386365632d386434382d3561653335386531663265612e706e67" target="_blank" rel="nofollow noopener"><img src="https://camo.qiitausercontent.com/3f58803904b80a1e1d4e4117f691a70dcb18479e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f30326539666265322d393433332d386365632d386434382d3561653335386531663265612e706e67" alt="image.png" loading="lazy"></a></p>

<p>ここでも保存は前回と同じ集約単位での保存で考えていました。<br>
なので橋渡し役は単純に集約のjsonを集約のDAOに変える程度と考えていました。</p>

<h1>
<span id="業務知識に発送システムを導入してみる" class="fragment"></span><a href="#%E6%A5%AD%E5%8B%99%E7%9F%A5%E8%AD%98%E3%81%AB%E7%99%BA%E9%80%81%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>業務知識に発送システムを導入してみる</h1>

<p><a href="https://qiita.com/kwhrkzk/items/27c9f4100afdbd49eede">EventStoreを用いたCQRS+イベントソーシングの実践と考察</a>の記事で以下のような業務知識を想定していたのですが</p>

<blockquote>
<p>ウェブ上から本を借りるシステム(のイメージ)<br>
集約は利用者と本。本のタイトルなどの情報は書籍として正規化しました。<br>
本を登録する、本を借りる、本を延長する、本を返す、本を破棄する、というユースケースを想定</p>
</blockquote>

<p>これに発送する仕組みを導入しようと考えました。DDDの例でよくある、"本"という集約でもシステムによって文脈(コンテキスト)が異なるときの話です。<br>
<a href="https://camo.qiitausercontent.com/3b23b474f77bb5dd58b6c081bb27c70e0d483fe9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f35636263336132642d613034652d346131662d353639392d6132306163636536333634312e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F5cbc3a2d-a04e-4a1f-5699-a20acce63641.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=be96e69418b81deef2d960e6b8525ed5" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/5cbc3a2d-a04e-4a1f-5699-a20acce63641.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F5cbc3a2d-a04e-4a1f-5699-a20acce63641.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=90bcf8e73fb5332ee8017980797bfd71 1x" loading="lazy"></a></p>

<p>コンテキストマップで表すと多分こんな感じ。点線は境界づけられたコンテキストです。</p>

<ul>
<li>貸借コンテキストの本はいつ借りられたかを気にしてていつ発送したかなんて気にしない</li>
<li>発送コンテキストの本はいつ発送したかを気にしていていつ返却されたかなんて気にしない</li>
</ul>

<p>なので<br>
貸借コンテキストの本の集約は<br>
<a href="https://camo.qiitausercontent.com/f0aad2467d5f4639c256779136ef3b23e4cec1f9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f30333162643631372d353535312d396664312d323966352d3461646362333737313962642e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F031bd617-5551-9fd1-29f5-4adcb37719bd.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b448f6be99e16965e026ec5164d3f133" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/031bd617-5551-9fd1-29f5-4adcb37719bd.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F031bd617-5551-9fd1-29f5-4adcb37719bd.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0b3aa936247b2fdaa05f64d9ebe4a8f6 1x" loading="lazy"></a><br>
で<br>
発送コンテキストの本の集約は<br>
<a href="https://camo.qiitausercontent.com/2c71955a28d3cfb9249ce3ba187aea8f5e7c36a6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f37316430636564382d643963372d323865662d393030312d3463393363616238353664622e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F71d0ced8-d9c7-28ef-9001-4c93cab856db.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=daef22aebf498a689d4c9d73e7b6965d" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/71d0ced8-d9c7-28ef-9001-4c93cab856db.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F71d0ced8-d9c7-28ef-9001-4c93cab856db.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=907c038b6511514454f29173045664b7 1x" loading="lazy"></a></p>

<p>と差異がでます。</p>

<h1>
<span id="cqrsに当てはめてみる" class="fragment"></span><a href="#cqrs%E3%81%AB%E5%BD%93%E3%81%A6%E3%81%AF%E3%82%81%E3%81%A6%E3%81%BF%E3%82%8B"><i class="fa fa-link"></i></a>CQRSに当てはめてみる</h1>

<p>ここにきてようやく疑問が発生しました。<br>
<a href="https://camo.qiitausercontent.com/756e34338cfc35c574ddd3303859222004e29d37/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f31303039633464632d663266332d323231302d613934382d3564636238346265356633352e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F1009c4dc-f2f3-2210-a948-5dcb84be5f35.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=276d85cc134f074cbea654d3c3668777" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/1009c4dc-f2f3-2210-a948-5dcb84be5f35.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F1009c4dc-f2f3-2210-a948-5dcb84be5f35.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=745ff518094ddf996b2c9697868e5c23 1x" loading="lazy"></a></p>

<p>保存する際に特定の集約単位だとその他のシステムに情報を渡せないのです。(渡せるとしてもきつい)</p>

<h1>
<span id="イベントソーシングの意味を体感する" class="fragment"></span><a href="#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%BD%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%AE%E6%84%8F%E5%91%B3%E3%82%92%E4%BD%93%E6%84%9F%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>イベントソーシングの意味を体感する</h1>

<p>イベントソーシングとはそのままの意味で、イベントをソース(情報源)とする手法なんですね。<br>
だからコマンド実行時にするべきは</p>

<p>"本を借りる"から本の集約全体を保存<br>
ではなく<br>
"本を借りる"結果として"本を借りた"イベントが発生したので本のIDと本の貸借期間を保存</p>

<p>なのだと。</p>

<h1>
<span id="ドメインイベントを定義する" class="fragment"></span><a href="#%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>ドメインイベントを定義する</h1>

<p>今回想定した業務知識で発生するドメインイベントを列挙してみます。</p>

<ul>
<li>Domain.RentalSubDomain.Events.User.AddedUserVer100(利用者を登録した)</li>
<li>Domain.RentalSubDomain.Events.User.LendedBookVer100(本を借りた)</li>
<li>Domain.RentalSubDomain.Events.User.ReturnedBookVer100(本を返した)</li>
<li>Domain.RentalSubDomain.Events.BookInfo.AddedBookInfoVer100(本を登録した)</li>
<li>Domain.RentalSubDomain.Events.Book.AddedBookVer100(本を登録した)</li>
<li>Domain.RentalSubDomain.Events.Book.LendedBookVer100(本を借りた)</li>
<li>Domain.RentalSubDomain.Events.Book.ExtendedBookVer100(本を延長した)</li>
<li>Domain.RentalSubDomain.Events.Book.ReturnedBookVer100(本を返した)</li>
<li>Domain.RentalSubDomain.Events.Book.DestroyedBookVer100(本を破棄した)</li>
<li>Domain.DeliverySubDomain.Events.Book.ShippedBookVer100(本を発送した)</li>
</ul>

<p>各ドメインイベントに1対1で対応するDTOも定義しています。<br>
例としてひとつあげると</p>

<div class="code-frame" data-lang="F#">
<div class="code-lang"><span class="bold">F#</span></div>
<div class="highlight"><pre class="with-code"><code>    module Book =
        [&lt;Literal&gt;]
        [&lt;CompiledName "LendedBookVer100"&gt;]
        let lendedBookVer100 = "book.lendedBookVer1.0.0"
        type LendedBookDTOVer100 = 
                {
                    id: string
                    user_id: string
                    lending_start_date: Nullable&lt;DateTime&gt;
                    lending_end_date: Nullable&lt;DateTime&gt;
                }
                static member Create(a,b,c,d) = { id = a; user_id = b; lending_start_date = c; lending_end_date = d }

</code></pre></div>
</div>

<p>"本を借りる"というコマンドを実行すると</p>

<ul>
<li>Domain.RentalSubDomain.Events.User.LendedBookVer100(本を借りた)</li>
<li>Domain.RentalSubDomain.Events.Book.LendedBookVer100(本を借りた)</li>
</ul>

<p>の二つのイベントがイベントストアに保存されるようにしました。<br>
これでコマンド部を状態ベースからイベントベースに変更できました。</p>

<h1>
<span id="橋渡し役はprojectorだった" class="fragment"></span><a href="#%E6%A9%8B%E6%B8%A1%E3%81%97%E5%BD%B9%E3%81%AFprojector%E3%81%A0%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>橋渡し役はProjectorだった</h1>

<p><a href="https://dev.to/barryosull/projection-building-blocks-what-youll-need-to-build-projections--5g1n" rel="nofollow noopener" target="_blank">Projection Building Blocks: What you'll need to build projections</a><br>
<a href="https://abdullin.com/post/event-sourcing-projections/" rel="nofollow noopener" target="_blank">Event Sourcing - Projections</a></p>

<p>で理解できたんですけど橋渡し役はProjector(投影機)と呼ぶらしいです。<br>
自分的な解釈ですけど、唯一の真実であるイベントストアから(必要なイベントのみ)投影するから。<br>
図にすると<br>
<a href="https://camo.qiitausercontent.com/ba0cea216fb85fb1f956ec14946b8387042ae00c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f36393463343334322d633061352d376537332d636364612d3334643262353430376566612e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F694c4342-c0a5-7e73-ccda-34d2b5407efa.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=74a25feafb9bfa93b65936e8e3d85772" alt="image.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/694c4342-c0a5-7e73-ccda-34d2b5407efa.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F694c4342-c0a5-7e73-ccda-34d2b5407efa.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=958922c2a119b62db139353c62067153 1x" loading="lazy"></a></p>

<p>こんな感じで、EventStoreから購読するんですけど購読する内容は自分のコンテキストで必要なイベントだけ。<br>
貸借プロジェクタでは</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>            <span class="kt">var</span> <span class="n">x</span> <span class="p">=</span> <span class="n">_event</span><span class="p">.</span><span class="n">EventType</span> <span class="k">switch</span> <span class="p">{</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">AddedUserVer100</span> <span class="p">=&gt;</span> <span class="nf">AddedUserVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">LendedBookVer100</span> <span class="p">=&gt;</span> <span class="nf">UserLendedBookVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">ReturnedBookVer100</span> <span class="p">=&gt;</span> <span class="nf">UserReturnedBookVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">BookInfo</span><span class="p">.</span><span class="n">AddedBookInfoVer100</span> <span class="p">=&gt;</span> <span class="nf">AddedBookInfoVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">Book</span><span class="p">.</span><span class="n">AddedBookVer100</span> <span class="p">=&gt;</span> <span class="nf">AddedBookVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">Book</span><span class="p">.</span><span class="n">LendedBookVer100</span> <span class="p">=&gt;</span> <span class="nf">BookLendedBookVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">Book</span><span class="p">.</span><span class="n">ExtendedBookVer100</span> <span class="p">=&gt;</span> <span class="nf">ExtendedBookVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">Book</span><span class="p">.</span><span class="n">ReturnedBookVer100</span> <span class="p">=&gt;</span> <span class="nf">BookReturnedBookVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">Book</span><span class="p">.</span><span class="n">DestroyedBookVer100</span> <span class="p">=&gt;</span> <span class="nf">DestroyedBookVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">_</span> <span class="p">=&gt;</span> <span class="m">0</span>
            <span class="p">};</span>
</code></pre></div></div>

<p>発送プロジェクタでは</p>

<div class="code-frame" data-lang="C#"><div class="highlight"><pre class="with-code"><code>            <span class="kt">var</span> <span class="n">x</span> <span class="p">=</span> <span class="n">_event</span><span class="p">.</span><span class="n">EventType</span> <span class="k">switch</span> <span class="p">{</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">Book</span><span class="p">.</span><span class="n">LendedBookVer100</span> <span class="p">=&gt;</span> <span class="k">await</span> <span class="nf">LendedBookVer100Async</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">RentalSubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">Book</span><span class="p">.</span><span class="n">ReturnedBookVer100</span> <span class="p">=&gt;</span> <span class="nf">ReturnedBookVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">Domain</span><span class="p">.</span><span class="n">DeliverySubDomain</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">Book</span><span class="p">.</span><span class="n">ShippedBookVer100</span> <span class="p">=&gt;</span> <span class="nf">ShippedBookVer100</span><span class="p">(</span><span class="n">_event</span><span class="p">),</span>
                <span class="n">_</span> <span class="p">=&gt;</span> <span class="m">0</span>
            <span class="p">};</span>
</code></pre></div></div>

<p>という感じ。<br>
コンテキストの違うドメインイベントであっても必要であったら読み込みます。<br>
例えば発送Appとしては"本を借りた"イベントを取得しないとなんの本を発送したらわからないので監視します。<br>
逆に貸借Appでは"本を発送した"というイベントは必要ないので無視します。(貸借App上で発送状況は表示しない想定)</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>やっとCQRS+ESの真の意味を理解できた気がします。(全然違ってたらすいません。。)</p>

<p>CQRSはひとつのDBでも有用なアーキテクチャですけど、マイクロサービス的な方向になるとひとつのDBでコマンドもクエリも行うのは厳しいかと思います。<br>
かといって単純にコマンドとクエリを物理的に分けても状態ベース(集約単位)の保存のままだとクエリ元の生成が上手くいきません。</p>

<p>そのためのイベントソーシングという考え方で、クエリ元は情報を保存しているというよりは必要な情報を投影しているだけ。<br>
こういう風に考えるとクエリ元のテーブルは集約単位である必要はなく、各画面に必要な情報を持ったテーブルにしちゃっても良い気がします。<br>
(先に必要なレコードを作ってしまえばRDBである必要もないかも)</p>

<p>また、ドメインイベントの抽出の重要性についても改めて理解できました。<br>
ユースケースから設計すると、～～するという文脈になってしまうのでコマンドとして設計してしまっていましたが<br>
～～する結果として、～～した、というところを強く意識するようにします。</p>

<p>全然違うこと書いていたらご指摘願います。</p>

<ul>
<li><a href="https://github.com/kwhrkzk/EventStoreSample" rel="nofollow noopener" target="_blank">自作ソース</a></li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fkwhrkzk%2Fitems%2F49318714e2cbd0f8ea9d&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fkwhrkzk%2Fitems%2F49318714e2cbd0f8ea9d&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d/likers" class="css-1iupg5d">10</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">5</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/49318714e2cbd0f8ea9d/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/kwhrkzk/items/49318714e2cbd0f8ea9d.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-aa1060d4-97e9-4229-a308-3a4b158e6fc6">{"authorAnalyticsTrackingId":"UA-136311435-1","organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-48b813a8-0715-4513-9eb0-1665f892b2d9"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-48b813a8-0715-4513-9eb0-1665f892b2d9">{}</script>
      
<div id="LoginModal-react-component-71ca66df-8e13-444f-9b8a-102601264d18"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-71ca66df-8e13-444f-9b8a-102601264d18">{}</script>
      
<div id="StockModal-react-component-a4266bea-c124-46e6-8334-cc2158e9b853"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-a4266bea-c124-46e6-8334-cc2158e9b853">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;6o6KFdvvT7BV9g8QjlYFEly8VmVv94+14sIvIPpc6FKywU2V1NGXTVLN4GGE2o++U7oiatSJqX1hKyAXJwQ9iw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/kwhrkzk/items/27c9f4100afdbd49eede\" id=\"reference-84cbc16f3b3927d2b509\"\u003eEventStoreを用いたCQRS+イベントソーシングの実践と考察\u003c/a\u003eの続きで設計していたところ、CQRS+ESを真に体感できたためその内容について投稿します。(当たり前過ぎたらすいません。)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"自分的cqrsesにたどり着くまでの流れ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%87%AA%E5%88%86%E7%9A%84cqrses%E3%81%AB%E3%81%9F%E3%81%A9%E3%82%8A%E7%9D%80%E3%81%8F%E3%81%BE%E3%81%A7%E3%81%AE%E6%B5%81%E3%82%8C\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e自分的CQRS+ESにたどり着くまでの流れ\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"全部リポジトリ経由\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%85%A8%E9%83%A8%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E7%B5%8C%E7%94%B1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e全部リポジトリ経由\u003c/h2\u003e\n\n\u003cp\u003eはじめにDDDを学んだときは、集約はリポジトリ経由で保存と取得をすべきと考えていました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/54904e70a0e24a2a09287e66bccdc75fc3651c3a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f39623762306636302d363434662d376637632d393963302d6164623737343538323337342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F9b7b0f60-644f-7f7c-99c0-adb774582374.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=6a87b6aacff5247f7221c620a6b8d424\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/9b7b0f60-644f-7f7c-99c0-adb774582374.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F9b7b0f60-644f-7f7c-99c0-adb774582374.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=e586b0f34c4f84501956be7be51d52f0 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこのときは各画面特有の情報の固まりをどうやって取得しようかと悩みました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e必要な集約を全部取得して画面に必要な部分だけ使う(余計な情報も取得してる)\u003c/li\u003e\n\u003cli\u003e集約にGet専用なプロパティを追加しちゃう(SQLがjoinだらけでカオス)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"cqrs\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#cqrs\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCQRS\u003c/h2\u003e\n\n\u003cp\u003eコマンドとクエリを分離するべきと考えを改めました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/1eaab24ea5c36e72312746ad06916631c5a9684c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f36396562363561622d353539392d633235362d616666662d6362363839653061666335302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F69eb65ab-5599-c256-afff-cb689e0afc50.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=fbaeee588896f4de01af02367891b585\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/69eb65ab-5599-c256-afff-cb689e0afc50.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F69eb65ab-5599-c256-afff-cb689e0afc50.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=4d1cf46aada0ff30d5c534896245f8cd 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこれで取得部はかなり自由になり楽になりました。\u003cbr\u003e\n保存は前回のまま集約単位で保存していました。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"cqrses\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#cqrses\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCQRS+ES\u003c/h2\u003e\n\n\u003cp\u003e格納先を物理的に分けてみようと思いEventStoreを導入してみました。\u003cbr\u003e\n\u003ca href=\"https://qiita.com/kwhrkzk/items/27c9f4100afdbd49eede\"\u003eEventStoreを用いたCQRS+イベントソーシングの実践と考察\u003c/a\u003eの話です。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/3f58803904b80a1e1d4e4117f691a70dcb18479e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f30326539666265322d393433332d386365632d386434382d3561653335386531663265612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://camo.qiitausercontent.com/3f58803904b80a1e1d4e4117f691a70dcb18479e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f30326539666265322d393433332d386365632d386434382d3561653335386531663265612e706e67\" alt=\"image.png\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eここでも保存は前回と同じ集約単位での保存で考えていました。\u003cbr\u003e\nなので橋渡し役は単純に集約のjsonを集約のDAOに変える程度と考えていました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"業務知識に発送システムを導入してみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A5%AD%E5%8B%99%E7%9F%A5%E8%AD%98%E3%81%AB%E7%99%BA%E9%80%81%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e業務知識に発送システムを導入してみる\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/kwhrkzk/items/27c9f4100afdbd49eede\"\u003eEventStoreを用いたCQRS+イベントソーシングの実践と考察\u003c/a\u003eの記事で以下のような業務知識を想定していたのですが\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eウェブ上から本を借りるシステム(のイメージ)\u003cbr\u003e\n集約は利用者と本。本のタイトルなどの情報は書籍として正規化しました。\u003cbr\u003e\n本を登録する、本を借りる、本を延長する、本を返す、本を破棄する、というユースケースを想定\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eこれに発送する仕組みを導入しようと考えました。DDDの例でよくある、\"本\"という集約でもシステムによって文脈(コンテキスト)が異なるときの話です。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/3b23b474f77bb5dd58b6c081bb27c70e0d483fe9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f35636263336132642d613034652d346131662d353639392d6132306163636536333634312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F5cbc3a2d-a04e-4a1f-5699-a20acce63641.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=be96e69418b81deef2d960e6b8525ed5\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/5cbc3a2d-a04e-4a1f-5699-a20acce63641.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F5cbc3a2d-a04e-4a1f-5699-a20acce63641.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=90bcf8e73fb5332ee8017980797bfd71 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eコンテキストマップで表すと多分こんな感じ。点線は境界づけられたコンテキストです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e貸借コンテキストの本はいつ借りられたかを気にしてていつ発送したかなんて気にしない\u003c/li\u003e\n\u003cli\u003e発送コンテキストの本はいつ発送したかを気にしていていつ返却されたかなんて気にしない\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eなので\u003cbr\u003e\n貸借コンテキストの本の集約は\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/f0aad2467d5f4639c256779136ef3b23e4cec1f9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f30333162643631372d353535312d396664312d323966352d3461646362333737313962642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F031bd617-5551-9fd1-29f5-4adcb37719bd.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=b448f6be99e16965e026ec5164d3f133\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/031bd617-5551-9fd1-29f5-4adcb37719bd.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F031bd617-5551-9fd1-29f5-4adcb37719bd.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0b3aa936247b2fdaa05f64d9ebe4a8f6 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nで\u003cbr\u003e\n発送コンテキストの本の集約は\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/2c71955a28d3cfb9249ce3ba187aea8f5e7c36a6/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f37316430636564382d643963372d323865662d393030312d3463393363616238353664622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F71d0ced8-d9c7-28ef-9001-4c93cab856db.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=daef22aebf498a689d4c9d73e7b6965d\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/71d0ced8-d9c7-28ef-9001-4c93cab856db.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F71d0ced8-d9c7-28ef-9001-4c93cab856db.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=907c038b6511514454f29173045664b7 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eと差異がでます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"cqrsに当てはめてみる\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#cqrs%E3%81%AB%E5%BD%93%E3%81%A6%E3%81%AF%E3%82%81%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eCQRSに当てはめてみる\u003c/h1\u003e\n\n\u003cp\u003eここにきてようやく疑問が発生しました。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/756e34338cfc35c574ddd3303859222004e29d37/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f31303039633464632d663266332d323231302d613934382d3564636238346265356633352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F1009c4dc-f2f3-2210-a948-5dcb84be5f35.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=276d85cc134f074cbea654d3c3668777\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/1009c4dc-f2f3-2210-a948-5dcb84be5f35.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F1009c4dc-f2f3-2210-a948-5dcb84be5f35.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=745ff518094ddf996b2c9697868e5c23 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e保存する際に特定の集約単位だとその他のシステムに情報を渡せないのです。(渡せるとしてもきつい)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"イベントソーシングの意味を体感する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%BD%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%AE%E6%84%8F%E5%91%B3%E3%82%92%E4%BD%93%E6%84%9F%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eイベントソーシングの意味を体感する\u003c/h1\u003e\n\n\u003cp\u003eイベントソーシングとはそのままの意味で、イベントをソース(情報源)とする手法なんですね。\u003cbr\u003e\nだからコマンド実行時にするべきは\u003c/p\u003e\n\n\u003cp\u003e\"本を借りる\"から本の集約全体を保存\u003cbr\u003e\nではなく\u003cbr\u003e\n\"本を借りる\"結果として\"本を借りた\"イベントが発生したので本のIDと本の貸借期間を保存\u003c/p\u003e\n\n\u003cp\u003eなのだと。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ドメインイベントを定義する\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eドメインイベントを定義する\u003c/h1\u003e\n\n\u003cp\u003e今回想定した業務知識で発生するドメインイベントを列挙してみます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.User.AddedUserVer100(利用者を登録した)\u003c/li\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.User.LendedBookVer100(本を借りた)\u003c/li\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.User.ReturnedBookVer100(本を返した)\u003c/li\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.BookInfo.AddedBookInfoVer100(本を登録した)\u003c/li\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.Book.AddedBookVer100(本を登録した)\u003c/li\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.Book.LendedBookVer100(本を借りた)\u003c/li\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.Book.ExtendedBookVer100(本を延長した)\u003c/li\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.Book.ReturnedBookVer100(本を返した)\u003c/li\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.Book.DestroyedBookVer100(本を破棄した)\u003c/li\u003e\n\u003cli\u003eDomain.DeliverySubDomain.Events.Book.ShippedBookVer100(本を発送した)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e各ドメインイベントに1対1で対応するDTOも定義しています。\u003cbr\u003e\n例としてひとつあげると\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"F#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eF#\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e    module Book =\n        [\u0026lt;Literal\u0026gt;]\n        [\u0026lt;CompiledName \"LendedBookVer100\"\u0026gt;]\n        let lendedBookVer100 = \"book.lendedBookVer1.0.0\"\n        type LendedBookDTOVer100 = \n                {\n                    id: string\n                    user_id: string\n                    lending_start_date: Nullable\u0026lt;DateTime\u0026gt;\n                    lending_end_date: Nullable\u0026lt;DateTime\u0026gt;\n                }\n                static member Create(a,b,c,d) = { id = a; user_id = b; lending_start_date = c; lending_end_date = d }\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\"本を借りる\"というコマンドを実行すると\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.User.LendedBookVer100(本を借りた)\u003c/li\u003e\n\u003cli\u003eDomain.RentalSubDomain.Events.Book.LendedBookVer100(本を借りた)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eの二つのイベントがイベントストアに保存されるようにしました。\u003cbr\u003e\nこれでコマンド部を状態ベースからイベントベースに変更できました。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"橋渡し役はprojectorだった\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%A9%8B%E6%B8%A1%E3%81%97%E5%BD%B9%E3%81%AFprojector%E3%81%A0%E3%81%A3%E3%81%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e橋渡し役はProjectorだった\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://dev.to/barryosull/projection-building-blocks-what-youll-need-to-build-projections--5g1n\" rel=\"nofollow noopener\" target=\"_blank\"\u003eProjection Building Blocks: What you'll need to build projections\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://abdullin.com/post/event-sourcing-projections/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eEvent Sourcing - Projections\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eで理解できたんですけど橋渡し役はProjector(投影機)と呼ぶらしいです。\u003cbr\u003e\n自分的な解釈ですけど、唯一の真実であるイベントストアから(必要なイベントのみ)投影するから。\u003cbr\u003e\n図にすると\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/ba0cea216fb85fb1f956ec14946b8387042ae00c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3130393330322f36393463343334322d633061352d376537332d636364612d3334643262353430376566612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F694c4342-c0a5-7e73-ccda-34d2b5407efa.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=74a25feafb9bfa93b65936e8e3d85772\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/109302/694c4342-c0a5-7e73-ccda-34d2b5407efa.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F109302%2F694c4342-c0a5-7e73-ccda-34d2b5407efa.png?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=958922c2a119b62db139353c62067153 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこんな感じで、EventStoreから購読するんですけど購読する内容は自分のコンテキストで必要なイベントだけ。\u003cbr\u003e\n貸借プロジェクタでは\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEventType\u003c/span\u003e \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddedUserVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddedUserVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLendedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eUserLendedBookVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUser\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReturnedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eUserReturnedBookVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBookInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddedBookInfoVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddedBookInfoVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAddedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eAddedBookVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLendedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eBookLendedBookVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eExtendedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eExtendedBookVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReturnedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eBookReturnedBookVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDestroyedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eDestroyedBookVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e発送プロジェクタでは\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEventType\u003c/span\u003e \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLendedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"nf\"\u003eLendedBookVer100Async\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRentalSubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReturnedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eReturnedBookVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDeliverySubDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEvents\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBook\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eShippedBookVer100\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eShippedBookVer100\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_event\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eという感じ。\u003cbr\u003e\nコンテキストの違うドメインイベントであっても必要であったら読み込みます。\u003cbr\u003e\n例えば発送Appとしては\"本を借りた\"イベントを取得しないとなんの本を発送したらわからないので監視します。\u003cbr\u003e\n逆に貸借Appでは\"本を発送した\"というイベントは必要ないので無視します。(貸借App上で発送状況は表示しない想定)\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003eやっとCQRS+ESの真の意味を理解できた気がします。(全然違ってたらすいません。。)\u003c/p\u003e\n\n\u003cp\u003eCQRSはひとつのDBでも有用なアーキテクチャですけど、マイクロサービス的な方向になるとひとつのDBでコマンドもクエリも行うのは厳しいかと思います。\u003cbr\u003e\nかといって単純にコマンドとクエリを物理的に分けても状態ベース(集約単位)の保存のままだとクエリ元の生成が上手くいきません。\u003c/p\u003e\n\n\u003cp\u003eそのためのイベントソーシングという考え方で、クエリ元は情報を保存しているというよりは必要な情報を投影しているだけ。\u003cbr\u003e\nこういう風に考えるとクエリ元のテーブルは集約単位である必要はなく、各画面に必要な情報を持ったテーブルにしちゃっても良い気がします。\u003cbr\u003e\n(先に必要なレコードを作ってしまえばRDBである必要もないかも)\u003c/p\u003e\n\n\u003cp\u003eまた、ドメインイベントの抽出の重要性についても改めて理解できました。\u003cbr\u003e\nユースケースから設計すると、～～するという文脈になってしまうのでコマンドとして設計してしまっていましたが\u003cbr\u003e\n～～する結果として、～～した、というところを強く意識するようにします。\u003c/p\u003e\n\n\u003cp\u003e全然違うこと書いていたらご指摘願います。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/kwhrkzk/EventStoreSample\" rel=\"nofollow noopener\" target=\"_blank\"\u003e自作ソース\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2019-05-17T09:00:10Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"16JT6zIQAnnG9sOoSSVdCq95PV6J/qxT--IagSo7udRQBfHsDf--iWEv8Gyo1s/fpBvLbbcgrg==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":false,"lastModifiedAt":"2019-05-17T09:00:10Z","likesCount":10,"linkUrl":"https://qiita.com/kwhrkzk/items/49318714e2cbd0f8ea9d","organization":null,"originalId":898850,"stockedCount":5,"title":"CQRS+ESで大事なのはコマンド部(イベント)とプロジェクタなのでは、という話","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%87%AA%E5%88%86%E7%9A%84cqrses%E3%81%AB%E3%81%9F%E3%81%A9%E3%82%8A%E7%9D%80%E3%81%8F%E3%81%BE%E3%81%A7%E3%81%AE%E6%B5%81%E3%82%8C\"\u003e自分的CQRS+ESにたどり着くまでの流れ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%85%A8%E9%83%A8%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E7%B5%8C%E7%94%B1\"\u003e全部リポジトリ経由\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#cqrs\"\u003eCQRS\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#cqrses\"\u003eCQRS+ES\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A5%AD%E5%8B%99%E7%9F%A5%E8%AD%98%E3%81%AB%E7%99%BA%E9%80%81%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%92%E5%B0%8E%E5%85%A5%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"\u003e業務知識に発送システムを導入してみる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#cqrs%E3%81%AB%E5%BD%93%E3%81%A6%E3%81%AF%E3%82%81%E3%81%A6%E3%81%BF%E3%82%8B\"\u003eCQRSに当てはめてみる\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%BD%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0%E3%81%AE%E6%84%8F%E5%91%B3%E3%82%92%E4%BD%93%E6%84%9F%E3%81%99%E3%82%8B\"\u003eイベントソーシングの意味を体感する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%99%E3%82%8B\"\u003eドメインイベントを定義する\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%A9%8B%E6%B8%A1%E3%81%97%E5%BD%B9%E3%81%AFprojector%E3%81%A0%E3%81%A3%E3%81%9F\"\u003e橋渡し役はProjectorだった\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":2577,"uuid":"49318714e2cbd0f8ea9d","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"PKnsFO7Xp2r4PHRkNmkp3Sz+3k8e--XYS7S8y8pGUjpMHk--bddumGW6lBb2yhIlGgAKjA==","originalId":109302,"description":"業務系に従事。WPF,PRISM,C#,F#,.NET Core,Laravel,Vue,TypeScript,DDD,CQRS,SOLIDらへんに興味有。","facebookUrl":null,"githubUrl":"https://github.com/kwhrkzk","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/109302/profile-images/1473710836","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F109302%2Fprofile-images%2F1473710836?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=420607916584f57e28dd80345a07855a","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F109302%2Fprofile-images%2F1473710836?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=bc1008a15372fd88012c75f398220c07","urlName":"kwhrkzk","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"EventSourcing","urlName":"eventsourcing"},{"name":"EventStore","urlName":"eventstore"},{"name":"CQRS","urlName":"cqrs"},{"name":".NETCore","urlName":".netcore"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
