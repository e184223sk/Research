More than 1 year has passed since last update.UniVRM v0.56.3わたしは人間牧場を経営したいのですが、残念ながら資金も権力もありません。
なのでかわいいアバターをいっぱい飼育することで心の慰めにしたいと思います。
というわけで、以下のようなスクリプトを書きました。
StreamingAssets/vrm/から.vrmを読み込んでぴょんぴょんさせます。これで好きなアバターを牧場に入れられます！人間牧場そのいち pic.twitter.com/r6An34C7wd適度に増えて適度に減って、永遠に眺めていられますね。
ところがだんだん動きがカクついてきて、遂にはエディタがクラッシュしてしまいます。誰の仕業でしょうか。
Profilerで調べたところ、どうやらメモリリークしているようです。心当たりがあるとすれば破棄処理とファイル読み込みの部分ですが、特におかしいところはありません。となると残っているのはロードするときに使っているVRMImporterContextです。
IDisposableを実装している。実にあやしい。というわけで使い終わったらDisposeします。そして後には誰もいない牧場が残りました。当然ですが、contextをDisposeしたタイミングで生成したアバターも破棄されてしまうみたいです。
そして困ったことに、生成済みのアバターはVRMImporterContextを取得できるクラスがくっついていません。2
なのでアバターをGameObjectではなくVRMImporterContext単位で管理することにします。人間牧場そのに pic.twitter.com/Y5IYO52zwCできました！
人間牧場の復活です！
いろんなアバターが増えたり減ったりしながら永遠にぴょんぴょんします！とはいえリソースの開放忘れはよくあるバグの原因の一つです。
なので管理して自分でDisposeするのではなく、
拡張メソッドでアバターがOnDestroyされたとき、自動的にDisposeされるようにします。自分がざっと見た限りではそれらしい情報が見当たらなかったのでこの記事を書きました。
本来ならば公式にissueでも立てて要望を出すかなにかしようかとも思ったんですが、もうすぐ1.0.0版とかが出るみたいだし、いいかなって。
個人的には拡張メソッドの方式が好きです。AssetBundleでもそうですが、リソース管理とかめんどくさすぎて自分でやりたくないんですよね。拡張Disposeと人間牧場のコードはgistにあげておいたので好きに使ってください。
あと、gistに置いてあるコードのライセンスをつけておきました3。CC0ですが、作者を表記してくれたらうれしいです。おしまい。ランタイムインポーターニコニ立体ちゃん (VRM)
ヴィータ
Bird Cage created by Poly by Google
Basic Motions FREE PackUniTask v2やってみたかったやつ。 ↩もしあったら教えて下さい。 ↩昔すぎて今更リプライするのもあれなのでこの場で謝ります。ごめんなさい。 ↩


