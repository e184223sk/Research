More than 3 years have passed since last update.Azureには様々なPaaSやらIaaSがあります。我が部署はみんなAzureが好きなもんですから、日々便利に組み合わせて使い倒しています。そんなたくさんあるサービスの中でもVM並みに古参なのが「CloudService」です。ロードバランサ―、スケールコントローラー付きで扱いやすくとっても便利なやつです。VMにも可用性セットが追加されてスケール制御ができるようになりましたが、まだまだCloudServiceの方が手軽で便利かなと感じます。今日はそんなCloudServiceを「必要な時にだけデプロイして、不要な時は削除してしまう（で、課金を発生させない）」というちょっとユニーク（ニッチ？）なことに取り組んだ時のお話です。うちの部署は「配信事業本部」という名前の通り、音楽や動画の配信に携わっています。構築済みのシステムは大体どれもCloudServiceにWorkerRoleをデプロイしてその中でパッケージングやトランスコードをしています。パッケージングもトランスコードもエンコードに比べると低負荷なので、CloudServiceのVMサイズは大抵そこまで大きいものにしません。（D1v2(ディスクは50GB)とか、そんなもん）が、たまーに「6時間の超大作」とか「4Kの動画」とか「ぶっ続け〇〇24時間」とかをパッケージングすることがあります。「ぶっ続け〇〇24時」なんて1ファイルしかないのに40GB(!) とか80GBとか(!!)になることもあり、とてもとてもD1v2じゃディスク足りない、だけどCloudServiceはVMみたいにディスクをアタッチできない。仕方ないから一時的にでかいサイズのCloudServiceをデプロイしようということに。でも、これ、いちいちやるのめんどくさい、いやだ…。というわけで作ってみる作ったのはこんな仕組み1.処理要求が入る
2.1.が来た時に対象のCloudServiceにインスタンスが1個もなかったら、ストレージに置いてあるcspkgとcscfgを使ってデプロイ一番大事なデプロイする部分のコードはこんな感じ※Compute Management Libraryが必要なのでNuGetしてきてくださいね。晴れて自動化…と思ったら、あれ？テーブルストレージにログが出なくなったぞ？ポータルで見てみるとどうもAzure Diagnostics の拡張機能がインストールされていない模様。でもまぁ、拡張診断機能をインストールすればいいだけだもんな。Visual Studio使って手動でデプロイするときはちゃんとインストールされているんだから、RESTAPIはあるはずだし、SDKやLibrary使えばインストールできるだろ！…そんな風に思っていた時期が私にもありました。そもそも、何のクラスを使ったらいいかわからない。私の上司がComputeManagementClient.HostedServices.AddExtensionが拡張機能をインストールするメソッドらしいことを突き止めてくださったが、肝心のパラメーターが全く謎。RESTAPIのリファレンス読んでもﾜｶﾝﾈOptionalなのに値を設定しないでリクエストするとバンバン400を突き返される。…どういうことなの。散々悪戦苦闘して、ようやく以下(やや長いっす)の通り拡張機能をインストールすることに成功。でも、やっぱりログが出ない。ポータル上で確認するとこんな感じなんだよ…「無効」って…もうだめだぁ…おしまいだぁ…。そういえば、Visual StudioはどんなRESTAPIをどんな順番呼び出しデプロイしているんだろうとふと思い、Fiddlerでキャプチャしてみることに。すると…1.登録済みのサービス証明書を取得もしくは新規登録ふんふん、ですよね。2.拡張診断機能のインストールふんふん、ですよね。3.cspkgのデプロイふんふん、ですy…なにこのExtensionConfigurationとかいうパラメーターどうやらデプロイ時に拡張機能とRoleの紐づけを行っている模様いや、確かに前にリファレンス読んだけどこれじゃ分かんねぇって…。まぁひとまずこうなるようにコード書けばいけるんじゃね？デプロイ時のコードを以下のような感じにしてみることに。ExtensionConfigurationで拡張機能とRoleの名前を明示的に紐づけます。ちゃんと拡張診断機能がインストールされてログも出るようになりました。必要な時だけデプロイすることで、コンピューティングコストを下げられます。特に大きなサイズのVMを利用している場合は、未使用時間帯はデプロイを削除することでかなりコストを下げられます。ぜひお試しあれ。


