More than 1 year has passed since last update.Prism にて、Region に 登録されている UserControl を削除する際に、ViewModel 及び View の Disposeメソッド をコールする方法についてまとめます。国産MVVMインフラのLivetであれば、DataContextDisposeAction が用意されており、xaml から手軽に ViewModel を Dispose できますが、Prism には対応する機能がなさそうです。MVVMパターンで、View が IDispose を継承する機会はめったにないと思いますがついでに紹介します。View/ViewModel の Dispose を紹介するため、下準備としてDisposeがない状態の Prismアプリ を作成していきます。App.xamlPrismの一般的な実装で、特に何もしていません。App.xaml.csPrismの一般的な実装で、特に何もしていません。MainWindow.xaml追加ボタンと UserControl を読み出すための Region を持っています。MainWindow.xaml.cs変更はないので割愛します。MainWindowViewModel.csボタンコマンドにより、ViewAを追加しています。ViewA.xaml2つの自爆ボタンを持っています。上ボタンは コードビハインド(View) で処理しており、下ボタンは DelegateCommand(ViewModel) で処理しています。ViewA.xaml.csボタンクリックイベントで自身を所属リージョンから削除しています。また、ViewModelからの削除に対応するため、自身の名前をプロパティで公開しています。ViewAViewModel.cs削除したいViewの型名から Region に登録されている View を探索し削除しています。下準備は以上です。下準備が済んだので、Dispose部分を実装していきます。Prism.Regions.IRegionBehavior を継承したクラスを作成し、Region.Views の変化を購読します。Views_CollectionChanged() では Remove が行われた時に、ViewとViewModelの Disposeメソッドを呼び出しています。以下は、参考にさせて戴いた Okazuki さんのコードそのものです。毎度お世話になっておりますm(_ _)mRegionBehaviorへの登録は App.xaml.cs にて行います。以下、App.xaml.cs の追加箇所のみUserControl の View/ViewModelが IDisposeを継承していなければ始まりませんので追加します。ViewA.xaml.csViewAViewModel.cs以上の対応により、UserControlの削除ボタンにより View/ViewModel の Disposeが行われます。実はここまでの説明だと、アプリ×ボタンによる終了時に Dispose が行われません。今回のサンプルでは動作に問題はありませんが、『UserControl が削除された際にログファイルを出力する』のような要件だった場合、×ボタンで Dispose が呼ばれないと不都合があるかと思います。以下で、×ボタン終了時の Dispose に対応していきます。MainWindow.xaml終了イベントを補足し、ViewModelのコマンドを実行します。MainWindow.xaml.cs終了時のコマンドで、当該リージョンのすべてのViewを削除します。UserControlのViewModelと違って、削除対象の指定が不要なのでスッキリ書けます。以上で、×ボタン押下時にも View/ViewModel の Dispose が呼ばれるようになりました。Prism にて、Region に 登録されている UserControl を削除する際に、ViewModel 及び View の Disposeメソッド をコールする方法についてまとめました。普段は何か調査をしても Qiita 投稿にまとめることはないのですが、今回はインフルによる外出禁止期間のおかげで投稿する時間が持てて、良い経験になりました。Visual Studio Community 2017 15.9.5
.NET Framework 4.6.1
Prism.Wpf v7.2.0.708-pre[stackoverflow] Is there any way to remove a view (by name) from a Prism region when the view was added using the RegionManager.RequestNavigate method?


